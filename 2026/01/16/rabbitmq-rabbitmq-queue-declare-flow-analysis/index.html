<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.svg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.svg">
  <link rel="mask-icon" href="/images/favicon.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Noto+Serif+SC:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Source+Code+Pro:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hzsunzixiang.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"default","show_result":true},"fold":{"enable":false,"height":500},"language":false,"highlight_theme":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":true,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="RabbitMQ 队列声明流程深度分析1. 概述本文档深入分析 RabbitMQ 队列声明（rabbit_amqqueue:declare&#x2F;6）的完整执行流程，基于以下示例命令： 1234567891011121314(rabbit@debian-1)1&gt; rabbit_amqqueue:declare(    rabbit_misc:r(&lt;&lt;&quot;&#x2F;&quot;&gt;&amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ 队列声明流程深度分析">
<meta property="og:url" content="https://hzsunzixiang.github.io/2026/01/16/rabbitmq-rabbitmq-queue-declare-flow-analysis/">
<meta property="og:site_name" content="Zixiang Sun&#39;s Blog">
<meta property="og:description" content="RabbitMQ 队列声明流程深度分析1. 概述本文档深入分析 RabbitMQ 队列声明（rabbit_amqqueue:declare&#x2F;6）的完整执行流程，基于以下示例命令： 1234567891011121314(rabbit@debian-1)1&gt; rabbit_amqqueue:declare(    rabbit_misc:r(&lt;&lt;&quot;&#x2F;&quot;&gt;&amp;">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2026-01-15T16:00:00.000Z">
<meta property="article:modified_time" content="2026-01-18T04:46:33.162Z">
<meta property="article:author" content="Zixiang Sun">
<meta property="article:tag" content="Erlang">
<meta property="article:tag" content="RabbitMQ">
<meta property="article:tag" content="源码分析">
<meta property="article:tag" content="队列管理">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://hzsunzixiang.github.io/2026/01/16/rabbitmq-rabbitmq-queue-declare-flow-analysis/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://hzsunzixiang.github.io/2026/01/16/rabbitmq-rabbitmq-queue-declare-flow-analysis/","path":"2026/01/16/rabbitmq-rabbitmq-queue-declare-flow-analysis/","title":"RabbitMQ 队列声明流程深度分析"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>RabbitMQ 队列声明流程深度分析 | Zixiang Sun's Blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Zixiang Sun's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Zixiang Sun's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Sharing thoughts on technology, programming, and life</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">17</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">9</span></a></li><li class="menu-item menu-item-erlang"><a href="/erlang/" rel="section"><i class="fa fa-code fa-fw"></i>Erlang</a></li><li class="menu-item menu-item-rabbitmq"><a href="/rabbitmq/" rel="section"><i class="fa fa-server fa-fw"></i>RabbitMQ</a></li><li class="menu-item menu-item-craq"><a href="/craq/" rel="section"><i class="fa fa-book fa-fw"></i>CRAQ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#RabbitMQ-%E9%98%9F%E5%88%97%E5%A3%B0%E6%98%8E%E6%B5%81%E7%A8%8B%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">RabbitMQ 队列声明流程深度分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="nav-number">1.1.</span> <span class="nav-text">1. 概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%B5%81%E7%A8%8B%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-number">1.2.</span> <span class="nav-text">2. 流程架构图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E8%AF%A6%E7%BB%86%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-number">1.3.</span> <span class="nav-text">3. 详细流程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E9%98%B6%E6%AE%B5%E4%B8%80%EF%BC%9A%E8%B5%84%E6%BA%90%E5%90%8D%E7%A7%B0%E6%9E%84%E5%BB%BA-rabbit-misc-r-3"><span class="nav-number">1.3.1.</span> <span class="nav-text">3.1 阶段一：资源名称构建 (rabbit_misc:r&#x2F;3)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E4%BD%8D%E7%BD%AE"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">源码位置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD%E8%AF%B4%E6%98%8E"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">功能说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">数据结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E9%98%B6%E6%AE%B5%E4%BA%8C%EF%BC%9A%E9%98%9F%E5%88%97%E5%A3%B0%E6%98%8E%E5%85%A5%E5%8F%A3-rabbit-amqqueue-declare-6"><span class="nav-number">1.3.2.</span> <span class="nav-text">3.2 阶段二：队列声明入口 (rabbit_amqqueue:declare&#x2F;6)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E4%BD%8D%E7%BD%AE-1"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">源码位置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E6%AD%A5%E9%AA%A4%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">关键步骤详解</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-1-%E8%8E%B7%E5%8F%96%E9%BB%98%E8%AE%A4%E9%98%9F%E5%88%97%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.3.2.2.1.</span> <span class="nav-text">3.2.1 获取默认队列类型</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-2-%E9%AA%8C%E8%AF%81%E5%A3%B0%E6%98%8E%E5%8F%82%E6%95%B0"><span class="nav-number">1.3.2.2.2.</span> <span class="nav-text">3.2.2 验证声明参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-3-%E7%A1%AE%E5%AE%9A%E9%98%9F%E5%88%97%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.3.2.2.3.</span> <span class="nav-text">3.2.3 确定队列类型</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E9%98%B6%E6%AE%B5%E4%B8%89%EF%BC%9A%E5%88%9B%E5%BB%BA-amqqueue-%E8%AE%B0%E5%BD%95-amqqueue-new-9"><span class="nav-number">1.3.3.</span> <span class="nav-text">3.3 阶段三：创建 amqqueue 记录 (amqqueue:new&#x2F;9)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E4%BD%8D%E7%BD%AE-2"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">源码位置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#amqqueue-%E8%AE%B0%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">amqqueue 记录结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-%E9%98%B6%E6%AE%B5%E5%9B%9B%EF%BC%9A%E9%98%9F%E5%88%97%E7%B1%BB%E5%9E%8B%E5%88%86%E5%8F%91-rabbit-queue-type-declare-2"><span class="nav-number">1.3.4.</span> <span class="nav-text">3.4 阶段四：队列类型分发 (rabbit_queue_type:declare&#x2F;2)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E4%BD%8D%E7%BD%AE-3"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">源码位置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AD%96%E7%95%A5%E8%AE%BE%E7%BD%AE-rabbit-policy-set-1"><span class="nav-number">1.3.4.2.</span> <span class="nav-text">策略设置 (rabbit_policy:set&#x2F;1)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A3%85%E9%A5%B0%E5%99%A8%E8%AE%BE%E7%BD%AE-rabbit-queue-decorator-set-1"><span class="nav-number">1.3.4.3.</span> <span class="nav-text">装饰器设置 (rabbit_queue_decorator:set&#x2F;1)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%9F%E5%88%97%E9%99%90%E5%88%B6%E6%A3%80%E6%9F%A5"><span class="nav-number">1.3.4.4.</span> <span class="nav-text">队列限制检查</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-%E9%98%B6%E6%AE%B5%E4%BA%94%EF%BC%9AClassic-%E9%98%9F%E5%88%97%E5%A3%B0%E6%98%8E-rabbit-classic-queue-declare-2"><span class="nav-number">1.3.5.</span> <span class="nav-text">3.5 阶段五：Classic 队列声明 (rabbit_classic_queue:declare&#x2F;2)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E4%BD%8D%E7%BD%AE-4"><span class="nav-number">1.3.5.1.</span> <span class="nav-text">源码位置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-%E9%98%B6%E6%AE%B5%E5%85%AD%EF%BC%9A%E5%90%AF%E5%8A%A8%E9%98%9F%E5%88%97%E8%BF%9B%E7%A8%8B"><span class="nav-number">1.3.6.</span> <span class="nav-text">3.6 阶段六：启动队列进程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-6-1-%E5%90%AF%E5%8A%A8%E9%98%9F%E5%88%97%E8%BF%9B%E7%A8%8B-rabbit-amqqueue-sup-sup-start-queue-process-2"><span class="nav-number">1.3.6.1.</span> <span class="nav-text">3.6.1 启动队列进程 (rabbit_amqqueue_sup_sup:start_queue_process&#x2F;2)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-6-2-%E9%98%9F%E5%88%97%E7%9B%91%E7%9D%A3%E8%80%85%E5%88%9D%E5%A7%8B%E5%8C%96-rabbit-amqqueue-sup-start-link-2"><span class="nav-number">1.3.6.2.</span> <span class="nav-text">3.6.2 队列监督者初始化 (rabbit_amqqueue_sup:start_link&#x2F;2)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-%E9%98%B6%E6%AE%B5%E4%B8%83%EF%BC%9A%E9%98%9F%E5%88%97%E8%BF%9B%E7%A8%8B%E5%88%9D%E5%A7%8B%E5%8C%96-rabbit-amqqueue-process"><span class="nav-number">1.3.7.</span> <span class="nav-text">3.7 阶段七：队列进程初始化 (rabbit_amqqueue_process)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E4%BD%8D%E7%BD%AE-5"><span class="nav-number">1.3.7.1.</span> <span class="nav-text">源码位置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-7-1-%E5%88%9D%E5%A7%8B%E5%8C%96%E7%8A%B6%E6%80%81"><span class="nav-number">1.3.7.2.</span> <span class="nav-text">3.7.1 初始化状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-7-2-%E5%A4%84%E7%90%86-init-new-%E8%B0%83%E7%94%A8"><span class="nav-number">1.3.7.3.</span> <span class="nav-text">3.7.2 处理 {init, new} 调用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-8-%E9%98%B6%E6%AE%B5%E5%85%AB%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8C%81%E4%B9%85%E5%8C%96-rabbit-amqqueue-internal-declare-2"><span class="nav-number">1.3.8.</span> <span class="nav-text">3.8 阶段八：数据库持久化 (rabbit_amqqueue:internal_declare&#x2F;2)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E4%BD%8D%E7%BD%AE-6"><span class="nav-number">1.3.8.1.</span> <span class="nav-text">源码位置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C-rabbit-db-queue-create-or-get-1"><span class="nav-number">1.3.8.2.</span> <span class="nav-text">数据库操作 (rabbit_db_queue:create_or_get&#x2F;1)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E8%BF%9B%E7%A8%8B%E7%9B%91%E7%9D%A3%E6%A0%91%E7%BB%93%E6%9E%84"><span class="nav-number">1.4.</span> <span class="nav-text">4. 进程监督树结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%E8%A7%A3%E6%9E%90"><span class="nav-number">1.5.</span> <span class="nav-text">5. 返回结果解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E5%85%B3%E9%94%AE%E6%95%B0%E6%8D%AE%E6%B5%81%E5%9B%BE"><span class="nav-number">1.6.</span> <span class="nav-text">6. 关键数据流图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E6%97%B6%E5%BA%8F%E5%9B%BE"><span class="nav-number">1.7.</span> <span class="nav-text">7. 时序图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E9%98%9F%E5%88%97%E7%B1%BB%E5%9E%8B%E5%AF%B9%E6%AF%94"><span class="nav-number">1.8.</span> <span class="nav-text">8. 队列类型对比</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-number">1.9.</span> <span class="nav-text">9. 错误处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.9.1.</span> <span class="nav-text">9.1 常见错误类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-%E9%98%9F%E5%88%97%E9%99%90%E5%88%B6%E6%A3%80%E6%9F%A5"><span class="nav-number">1.9.2.</span> <span class="nav-text">9.2 队列限制检查</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-%E6%80%BB%E7%BB%93"><span class="nav-number">1.10.</span> <span class="nav-text">10. 总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-1-%E5%AE%8C%E6%95%B4%E8%B0%83%E7%94%A8%E9%93%BE"><span class="nav-number">1.10.1.</span> <span class="nav-text">10.1 完整调用链</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-%E5%85%B3%E9%94%AE%E6%A8%A1%E5%9D%97%E8%81%8C%E8%B4%A3"><span class="nav-number">1.10.2.</span> <span class="nav-text">10.2 关键模块职责</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-%E5%8F%82%E8%80%83%E6%BA%90%E6%96%87%E4%BB%B6"><span class="nav-number">1.11.</span> <span class="nav-text">11. 参考源文件</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zixiang Sun"
      src="/images/avatar.svg">
  <p class="site-author-name" itemprop="name">Zixiang Sun</p>
  <div class="site-description" itemprop="description">Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hzsunzixiang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hzsunzixiang" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:17842379@qq.com" title="E-Mail → mailto:17842379@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/16/rabbitmq-rabbitmq-queue-declare-flow-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="RabbitMQ 队列声明流程深度分析 | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          RabbitMQ 队列声明流程深度分析
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-16 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-16T00:00:00+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-18 12:46:33" itemprop="dateModified" datetime="2026-01-18T12:46:33+08:00">2026-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="RabbitMQ-队列声明流程深度分析"><a href="#RabbitMQ-队列声明流程深度分析" class="headerlink" title="RabbitMQ 队列声明流程深度分析"></a>RabbitMQ 队列声明流程深度分析</h1><h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><p>本文档深入分析 RabbitMQ 队列声明（<code>rabbit_amqqueue:declare/6</code>）的完整执行流程，基于以下示例命令：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(rabbit@debian-<span class="number">1</span>)<span class="number">1</span>&gt; rabbit_amqqueue:declare(</span><br><span class="line">    rabbit_misc:r(&lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;, queue, &lt;&lt;<span class="string">&quot;testqueue2&quot;</span>&gt;&gt;),</span><br><span class="line">    <span class="literal">false</span>,      <span class="comment">% Durable</span></span><br><span class="line">    <span class="literal">false</span>,      <span class="comment">% AutoDelete</span></span><br><span class="line">    [],         <span class="comment">% Args</span></span><br><span class="line">    none,       <span class="comment">% Owner</span></span><br><span class="line">    &lt;&lt;<span class="string">&quot;acting-user&quot;</span>&gt;&gt;  <span class="comment">% ActingUser</span></span><br><span class="line">).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 返回结果</span></span><br><span class="line">&#123;new, &#123;amqqueue, &#123;resource,&lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;,queue,&lt;&lt;<span class="string">&quot;testqueue2&quot;</span>&gt;&gt;&#125;,</span><br><span class="line">                 false, false, none, [], &lt;<span class="number">0.862</span>.<span class="number">0</span>&gt;, [], [], [],</span><br><span class="line">                 undefined, undefined, [], [], live, <span class="number">0</span>, [], &lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;,</span><br><span class="line">                 #&#123;user =&gt; &lt;&lt;<span class="string">&quot;acting-user&quot;</span>&gt;&gt;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-流程架构图"><a href="#2-流程架构图" class="headerlink" title="2. 流程架构图"></a>2. 流程架构图</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        <span class="title class_">Queue</span> <span class="title class_">Declaration</span> <span class="title class_">Flow</span>                                │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                              │</span><br><span class="line">│  ┌──────────────┐    ┌─────────────────┐    ┌──────────────────────┐       │</span><br><span class="line">│  │ rabbit_misc  │───▶│ rabbit_amqqueue │───▶│ rabbit_queue_type    │       │</span><br><span class="line">│  │    <span class="symbol">:r/</span><span class="number">3</span>      │    │   <span class="symbol">:declare/</span><span class="number">6</span>    │    │     <span class="symbol">:declare/</span><span class="number">2</span>       │       │</span><br><span class="line">│  └──────────────┘    └─────────────────┘    └──────────────────────┘       │</span><br><span class="line">│         │                    │                        │                     │</span><br><span class="line">│         ▼                    ▼                        ▼                     │</span><br><span class="line">│  ┌──────────────┐    ┌─────────────────┐    ┌──────────────────────┐       │</span><br><span class="line">│  │   <span class="comment">#resource  │    │    amqqueue     │    │ rabbit_classic_queue │       │</span></span><br><span class="line">│  │    record    │    │     <span class="symbol">:new/</span><span class="number">9</span>      │    │     <span class="symbol">:declare/</span><span class="number">2</span>       │       │</span><br><span class="line">│  └──────────────┘    └─────────────────┘    └──────────────────────┘       │</span><br><span class="line">│                              │                        │                     │</span><br><span class="line">│                              ▼                        ▼                     │</span><br><span class="line">│                      ┌─────────────────┐    ┌──────────────────────┐       │</span><br><span class="line">│                      │ rabbit_policy   │    │rabbit_amqqueue_sup_sup│      │</span><br><span class="line">│                      │     <span class="symbol">:set/</span><span class="number">1</span>      │    │<span class="symbol">:start_queue_process/</span><span class="number">2</span>│       │</span><br><span class="line">│                      └─────────────────┘    └──────────────────────┘       │</span><br><span class="line">│                              │                        │                     │</span><br><span class="line">│                              ▼                        ▼                     │</span><br><span class="line">│                      ┌─────────────────┐    ┌──────────────────────┐       │</span><br><span class="line">│                      │rabbit_queue_    │    │ rabbit_amqqueue_sup  │       │</span><br><span class="line">│                      │  <span class="symbol">decorator:</span>set  │    │    <span class="symbol">:start_link/</span><span class="number">2</span>     │       │</span><br><span class="line">│                      └─────────────────┘    └──────────────────────┘       │</span><br><span class="line">│                                                       │                     │</span><br><span class="line">│                                                       ▼                     │</span><br><span class="line">│                                             ┌──────────────────────┐       │</span><br><span class="line">│                                             │rabbit_amqqueue_process│      │</span><br><span class="line">│                                             │    <span class="symbol">:start_link/</span><span class="number">2</span>      │       │</span><br><span class="line">│                                             └──────────────────────┘       │</span><br><span class="line">│                                                       │                     │</span><br><span class="line">│                                                       ▼                     │</span><br><span class="line">│                                             ┌──────────────────────┐       │</span><br><span class="line">│                                             │    <span class="symbol">gen_server2:</span>call  │       │</span><br><span class="line">│                                             │    &#123;init, new&#125;       │       │</span><br><span class="line">│                                             └──────────────────────┘       │</span><br><span class="line">│                                                       │                     │</span><br><span class="line">│                                                       ▼                     │</span><br><span class="line">│                                             ┌──────────────────────┐       │</span><br><span class="line">│                                             │ rabbit_db_queue      │       │</span><br><span class="line">│                                             │   <span class="symbol">:create_or_get/</span><span class="number">1</span>   │       │</span><br><span class="line">│                                             └──────────────────────┘       │</span><br><span class="line">│                                                       │                     │</span><br><span class="line">│                                                       ▼                     │</span><br><span class="line">│                                             ┌──────────────────────┐       │</span><br><span class="line">│                                             │   <span class="title class_">Mnesia</span> / <span class="title class_">Khepri</span>    │       │</span><br><span class="line">│                                             │     持久化存储        │       │</span><br><span class="line">│                                             └──────────────────────┘       │</span><br><span class="line">│                                                                              │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-详细流程分析"><a href="#3-详细流程分析" class="headerlink" title="3. 详细流程分析"></a>3. 详细流程分析</h2><h3 id="3-1-阶段一：资源名称构建-rabbit-misc-r-3"><a href="#3-1-阶段一：资源名称构建-rabbit-misc-r-3" class="headerlink" title="3.1 阶段一：资源名称构建 (rabbit_misc:r/3)"></a>3.1 阶段一：资源名称构建 (<code>rabbit_misc:r/3</code>)</h3><h4 id="源码位置"><a href="#源码位置" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit_common/src/rabbit_misc.erl:413-419</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">r</span><span class="params">(#resource&#123;virtual_host = VHostPath&#125;, Kind, Name)</span> -&gt;</span></span><br><span class="line">    #resource&#123;virtual_host = VHostPath, kind = Kind, name = Name&#125;;</span><br><span class="line"><span class="function"><span class="title">r</span><span class="params">(VHostPath, Kind, Name)</span> -&gt;</span></span><br><span class="line">    #resource&#123;virtual_host = VHostPath, kind = Kind, name = Name&#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">r</span><span class="params">(VHostPath, Kind)</span> -&gt;</span></span><br><span class="line">    #resource&#123;virtual_host = VHostPath, kind = Kind, name = &#x27;_&#x27;&#125;.</span><br></pre></td></tr></table></figure>

<h4 id="功能说明"><a href="#功能说明" class="headerlink" title="功能说明"></a>功能说明</h4><ul>
<li><strong>输入</strong>: <code>&lt;&lt;&quot;/&quot;&gt;&gt;</code>, <code>queue</code>, <code>&lt;&lt;&quot;testqueue2&quot;&gt;&gt;</code></li>
<li><strong>输出</strong>: <code>#resource{virtual_host = &lt;&lt;&quot;/&quot;&gt;&gt;, kind = queue, name = &lt;&lt;&quot;testqueue2&quot;&gt;&gt;}</code></li>
</ul>
<h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-record</span><span class="params">(resource, &#123;</span></span><br><span class="line"><span class="params">    virtual_host :: binary(),  <span class="comment">% VHost 名称</span></span></span><br><span class="line"><span class="params">    kind :: queue | exchange,  <span class="comment">% 资源类型</span></span></span><br><span class="line"><span class="params">    name :: binary()           <span class="comment">% 资源名称</span></span></span><br><span class="line"><span class="params">&#125;)</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-2-阶段二：队列声明入口-rabbit-amqqueue-declare-6"><a href="#3-2-阶段二：队列声明入口-rabbit-amqqueue-declare-6" class="headerlink" title="3.2 阶段二：队列声明入口 (rabbit_amqqueue:declare/6)"></a>3.2 阶段二：队列声明入口 (<code>rabbit_amqqueue:declare/6</code>)</h3><h4 id="源码位置-1"><a href="#源码位置-1" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/rabbit_amqqueue.erl:201-250</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">declare</span><span class="params">(QueueName, Durable, AutoDelete, Args, Owner, ActingUser)</span> -&gt;</span></span><br><span class="line">    declare(QueueName, Durable, AutoDelete, Args, Owner, ActingUser, node()).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">declare</span><span class="params">(QueueName = #resource&#123;virtual_host = VHost&#125;, Durable, AutoDelete, Args,</span></span></span><br><span class="line"><span class="params"><span class="function">        Owner, ActingUser, Node)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 1. 获取默认队列类型</span></span><br><span class="line">    DQT = rabbit_vhost:default_queue_type(VHost, rabbit_queue_type:fallback()),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 2. 验证声明参数</span></span><br><span class="line">    ok = check_declare_arguments(QueueName, Args, DQT),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 3. 确定队列类型</span></span><br><span class="line">    Type = get_queue_type(Args, DQT),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 4. 检查队列类型是否启用</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_queue_type:is_enabled(Type) <span class="keyword">of</span></span><br><span class="line">        <span class="literal">true</span> -&gt;</span><br><span class="line">            <span class="comment">%% 5. 创建 amqqueue 记录</span></span><br><span class="line">            Q = amqqueue:new(QueueName,</span><br><span class="line">                             none,           <span class="comment">% pid (初始为 none)</span></span><br><span class="line">                             Durable,</span><br><span class="line">                             AutoDelete,</span><br><span class="line">                             Owner,</span><br><span class="line">                             Args,</span><br><span class="line">                             VHost,</span><br><span class="line">                             #&#123;user =&gt; ActingUser&#125;,</span><br><span class="line">                             Type),</span><br><span class="line">            <span class="comment">%% 6. 检查参数组合是否允许</span></span><br><span class="line">            <span class="keyword">case</span> is_queue_args_combination_permitted(Q) <span class="keyword">of</span></span><br><span class="line">                <span class="literal">true</span> -&gt;</span><br><span class="line">                    <span class="comment">%% 7. 委托给队列类型模块处理</span></span><br><span class="line">                    rabbit_queue_type:declare(Q, Node);</span><br><span class="line">                <span class="literal">false</span> -&gt;</span><br><span class="line">                    &#123;protocol_error, internal_error, <span class="string">&quot;~ts&quot;</span>, [Warning]&#125;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        <span class="literal">false</span> -&gt;</span><br><span class="line">            &#123;protocol_error, internal_error, <span class="string">&quot;...&quot;</span>, [...]&#125;</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<h4 id="关键步骤详解"><a href="#关键步骤详解" class="headerlink" title="关键步骤详解"></a>关键步骤详解</h4><h5 id="3-2-1-获取默认队列类型"><a href="#3-2-1-获取默认队列类型" class="headerlink" title="3.2.1 获取默认队列类型"></a>3.2.1 获取默认队列类型</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_vhost.erl</span></span><br><span class="line"><span class="function"><span class="title">default_queue_type</span><span class="params">(VHost, DefaultQT)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> lookup(VHost) <span class="keyword">of</span></span><br><span class="line">        &#123;ok, VHostRec&#125; -&gt;</span><br><span class="line">            <span class="keyword">case</span> vhost:get_default_queue_type(VHostRec) <span class="keyword">of</span></span><br><span class="line">                undefined -&gt; DefaultQT;</span><br><span class="line">                DQT -&gt; rabbit_queue_type:discover(DQT)</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        &#123;error, _&#125; -&gt;</span><br><span class="line">            DefaultQT</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">%% rabbit_queue_type.erl</span></span><br><span class="line"><span class="function"><span class="title">fallback</span><span class="params">()</span> -&gt;</span> rabbit_classic_queue.</span><br></pre></td></tr></table></figure>

<h5 id="3-2-2-验证声明参数"><a href="#3-2-2-验证声明参数" class="headerlink" title="3.2.2 验证声明参数"></a>3.2.2 验证声明参数</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_amqqueue.erl:849-859</span></span><br><span class="line"><span class="function"><span class="title">check_declare_arguments</span><span class="params">(QueueName, Args0, DefaultQueueType)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 注入默认队列类型</span></span><br><span class="line">    Args = maybe_inject_default_queue_type_shortcut_into_args(Args0, DefaultQueueType),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 检查 x-queue-type 参数</span></span><br><span class="line">    check_arguments_type_and_value(QueueName, Args, </span><br><span class="line">        [&#123;&lt;&lt;<span class="string">&quot;x-queue-type&quot;</span>&gt;&gt;, fun check_queue_type/2&#125;]),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 获取队列类型</span></span><br><span class="line">    Type = get_queue_type(Args),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 获取该类型支持的参数</span></span><br><span class="line">    QueueTypeArgs = rabbit_queue_type:arguments(queue_arguments, Type),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 验证参数类型和值</span></span><br><span class="line">    Validators = lists:filter(</span><br><span class="line">        <span class="keyword">fun</span>(&#123;Arg, _&#125;) -&gt; lists:member(Arg, QueueTypeArgs) <span class="keyword">end</span>, </span><br><span class="line">        declare_args()),</span><br><span class="line">    check_arguments_type_and_value(QueueName, Args, Validators),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 检查无效参数</span></span><br><span class="line">    InvalidArgs = rabbit_queue_type:arguments(queue_arguments) -- QueueTypeArgs,</span><br><span class="line">    check_arguments_key(QueueName, Type, Args, InvalidArgs).</span><br></pre></td></tr></table></figure>

<h5 id="3-2-3-确定队列类型"><a href="#3-2-3-确定队列类型" class="headerlink" title="3.2.3 确定队列类型"></a>3.2.3 确定队列类型</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_amqqueue.erl:261-273</span></span><br><span class="line"><span class="function"><span class="title">get_queue_type</span><span class="params">([], DefaultQueueType)</span> -&gt;</span></span><br><span class="line">    rabbit_queue_type:discover(DefaultQueueType);</span><br><span class="line"><span class="function"><span class="title">get_queue_type</span><span class="params">(Args, DefaultQueueType)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_misc:table_lookup(Args, &lt;&lt;<span class="string">&quot;x-queue-type&quot;</span>&gt;&gt;) <span class="keyword">of</span></span><br><span class="line">        undefined -&gt;</span><br><span class="line">            rabbit_queue_type:discover(DefaultQueueType);</span><br><span class="line">        &#123;longstr, undefined&#125; -&gt;</span><br><span class="line">            rabbit_queue_type:discover(DefaultQueueType);</span><br><span class="line">        &#123;longstr, &lt;&lt;<span class="string">&quot;undefined&quot;</span>&gt;&gt;&#125; -&gt;</span><br><span class="line">            rabbit_queue_type:discover(DefaultQueueType);</span><br><span class="line">        &#123;_, V&#125; -&gt;</span><br><span class="line">            rabbit_queue_type:discover(V)</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<p><strong>队列类型映射关系</strong>：</p>
<table>
<thead>
<tr>
<th>参数值</th>
<th>模块</th>
</tr>
</thead>
<tbody><tr>
<td><code>classic</code></td>
<td><code>rabbit_classic_queue</code></td>
</tr>
<tr>
<td><code>quorum</code></td>
<td><code>rabbit_quorum_queue</code></td>
</tr>
<tr>
<td><code>stream</code></td>
<td><code>rabbit_stream_queue</code></td>
</tr>
</tbody></table>
<hr>
<h3 id="3-3-阶段三：创建-amqqueue-记录-amqqueue-new-9"><a href="#3-3-阶段三：创建-amqqueue-记录-amqqueue-new-9" class="headerlink" title="3.3 阶段三：创建 amqqueue 记录 (amqqueue:new/9)"></a>3.3 阶段三：创建 amqqueue 记录 (<code>amqqueue:new/9</code>)</h3><h4 id="源码位置-2"><a href="#源码位置-2" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/amqqueue.erl:215-319</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">new</span><span class="params">(#resource&#123;kind = queue&#125; = Name,</span></span></span><br><span class="line"><span class="params"><span class="function">    Pid,</span></span></span><br><span class="line"><span class="params"><span class="function">    Durable,</span></span></span><br><span class="line"><span class="params"><span class="function">    AutoDelete,</span></span></span><br><span class="line"><span class="params"><span class="function">    Owner,</span></span></span><br><span class="line"><span class="params"><span class="function">    Args,</span></span></span><br><span class="line"><span class="params"><span class="function">    VHost,</span></span></span><br><span class="line"><span class="params"><span class="function">    Options,</span></span></span><br><span class="line"><span class="params"><span class="function">    Type)</span></span></span><br><span class="line"><span class="function">  <span class="title">when</span> <span class="params">(is_pid(Pid) orelse is_tuple(Pid) orelse Pid =:= none)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="title">is_boolean</span><span class="params">(Durable)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="title">is_boolean</span><span class="params">(AutoDelete)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="params">(is_pid(Owner) orelse Owner =:= none)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="title">is_list</span><span class="params">(Args)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="params">(is_binary(VHost) orelse VHost =:= undefined)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="title">is_map</span><span class="params">(Options)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="title">is_atom</span><span class="params">(Type)</span> -&gt;</span></span><br><span class="line">    new_with_version(</span><br><span class="line">      ?record_version,  <span class="comment">% amqqueue_v2</span></span><br><span class="line">      Name,</span><br><span class="line">      Pid,</span><br><span class="line">      Durable,</span><br><span class="line">      AutoDelete,</span><br><span class="line">      Owner,</span><br><span class="line">      Args,</span><br><span class="line">      VHost,</span><br><span class="line">      Options,</span><br><span class="line">      Type).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">new_with_version</span><span class="params">(?record_version, Name, Pid, Durable, AutoDelete,</span></span></span><br><span class="line"><span class="params"><span class="function">                 Owner, Args, VHost, Options, Type)</span> -&gt;</span></span><br><span class="line">    #amqqueue&#123;name            = Name,</span><br><span class="line">              durable         = Durable,</span><br><span class="line">              auto_delete     = AutoDelete,</span><br><span class="line">              arguments       = Args,</span><br><span class="line">              exclusive_owner = Owner,</span><br><span class="line">              pid             = Pid,</span><br><span class="line">              vhost           = VHost,</span><br><span class="line">              options         = Options,</span><br><span class="line">              type            = Type&#125;.</span><br></pre></td></tr></table></figure>

<h4 id="amqqueue-记录结构"><a href="#amqqueue-记录结构" class="headerlink" title="amqqueue 记录结构"></a>amqqueue 记录结构</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-record</span><span class="params">(amqqueue, &#123;</span></span><br><span class="line"><span class="params">    <span class="comment">%% 不可变字段</span></span></span><br><span class="line"><span class="params">    name :: rabbit_amqqueue:name() | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    durable :: boolean() | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    auto_delete :: boolean() | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    exclusive_owner = none :: pid() | none | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    arguments = [] :: rabbit_framing:amqp_table() | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    </span></span><br><span class="line"><span class="params">    <span class="comment">%% 可变字段</span></span></span><br><span class="line"><span class="params">    pid :: pid() | ra_server_id() | none | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    slave_pids = [],           <span class="comment">% 保留字段</span></span></span><br><span class="line"><span class="params">    sync_slave_pids = [],      <span class="comment">% 保留字段</span></span></span><br><span class="line"><span class="params">    recoverable_slaves = [],   <span class="comment">% 保留字段</span></span></span><br><span class="line"><span class="params">    </span></span><br><span class="line"><span class="params">    <span class="comment">%% 策略相关</span></span></span><br><span class="line"><span class="params">    policy :: proplists:proplist() | none | undefined | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    operator_policy :: proplists:proplist() | none | undefined,</span></span><br><span class="line"><span class="params">    </span></span><br><span class="line"><span class="params">    <span class="comment">%% 运行时状态</span></span></span><br><span class="line"><span class="params">    gm_pids = [] :: [&#123;pid(), pid()&#125;] | none,</span></span><br><span class="line"><span class="params">    decorators :: [atom()] | none | undefined,</span></span><br><span class="line"><span class="params">    state = live :: atom(),</span></span><br><span class="line"><span class="params">    policy_version = <span class="number">0</span> :: non_neg_integer(),</span></span><br><span class="line"><span class="params">    type_state = #&#123;&#125; :: map(),</span></span><br><span class="line"><span class="params">    vhost :: binary() | undefined,</span></span><br><span class="line"><span class="params">    options = #&#123;&#125; :: map(),</span></span><br><span class="line"><span class="params">    type = rabbit_classic_queue :: module()</span></span><br><span class="line"><span class="params">&#125;)</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-4-阶段四：队列类型分发-rabbit-queue-type-declare-2"><a href="#3-4-阶段四：队列类型分发-rabbit-queue-type-declare-2" class="headerlink" title="3.4 阶段四：队列类型分发 (rabbit_queue_type:declare/2)"></a>3.4 阶段四：队列类型分发 (<code>rabbit_queue_type:declare/2</code>)</h3><h4 id="源码位置-3"><a href="#源码位置-3" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/rabbit_queue_type.erl:389-397</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-spec</span> declare<span class="params">(amqqueue:amqqueue(), node() | &#123;&#x27;ignore_location&#x27;, node()&#125;)</span> -&gt;</span><br><span class="line">    &#123;&#x27;new&#x27; | &#x27;existing&#x27; | &#x27;owner_died&#x27;, amqqueue:amqqueue<span class="params">()</span>&#125; |</span><br><span class="line">    &#123;&#x27;absent&#x27;, amqqueue:amqqueue<span class="params">()</span>, rabbit_amqqueue:absent_reason<span class="params">()</span>&#125; |</span><br><span class="line">    &#123;protocol_error, Type :: atom<span class="params">()</span>, Reason :: string<span class="params">()</span>, Args :: term<span class="params">()</span>&#125; |</span><br><span class="line">    &#123;&#x27;error&#x27;, Type :: atom<span class="params">()</span>, Reason :: string<span class="params">()</span>, Args :: term<span class="params">()</span>&#125; |</span><br><span class="line">    &#123;&#x27;error&#x27;, Err :: term<span class="params">()</span> &#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">declare</span><span class="params">(Q0, Node)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 1. 设置策略和装饰器</span></span><br><span class="line">    Q = rabbit_queue_decorator:set(rabbit_policy:set(Q0)),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 2. 获取队列类型模块</span></span><br><span class="line">    Mod = amqqueue:get_type(Q),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 3. 检查队列限制</span></span><br><span class="line">    <span class="keyword">case</span> check_queue_limits(Q) <span class="keyword">of</span></span><br><span class="line">        ok -&gt;</span><br><span class="line">            <span class="comment">%% 4. 调用具体类型的 declare</span></span><br><span class="line">            Mod:declare(Q, Node);</span><br><span class="line">        Error -&gt;</span><br><span class="line">            Error</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<h4 id="策略设置-rabbit-policy-set-1"><a href="#策略设置-rabbit-policy-set-1" class="headerlink" title="策略设置 (rabbit_policy:set/1)"></a>策略设置 (<code>rabbit_policy:set/1</code>)</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_policy.erl:94-105</span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(Q0)</span> <span class="title">when</span> ?<span class="title">is_amqqueue</span><span class="params">(Q0)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 匹配当前 VHost 的策略</span></span><br><span class="line">    Policy = match(Q0),</span><br><span class="line">    OpPolicy = match_op(Q0),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 设置策略到队列记录</span></span><br><span class="line">    Q1 = amqqueue:set_policy(Q0, Policy),</span><br><span class="line">    Q2 = amqqueue:set_operator_policy(Q1, OpPolicy),</span><br><span class="line">    Q2.</span><br></pre></td></tr></table></figure>

<h4 id="装饰器设置-rabbit-queue-decorator-set-1"><a href="#装饰器设置-rabbit-queue-decorator-set-1" class="headerlink" title="装饰器设置 (rabbit_queue_decorator:set/1)"></a>装饰器设置 (<code>rabbit_queue_decorator:set/1</code>)</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_queue_decorator.erl:42-44</span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(Q)</span> <span class="title">when</span> ?<span class="title">is_amqqueue</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 获取所有活跃的装饰器</span></span><br><span class="line">    Decorators = [D || D &lt;- list(), D:active_for(Q)],</span><br><span class="line">    amqqueue:set_decorators(Q, Decorators).</span><br></pre></td></tr></table></figure>

<h4 id="队列限制检查"><a href="#队列限制检查" class="headerlink" title="队列限制检查"></a>队列限制检查</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_queue_type.erl:876-895</span></span><br><span class="line"><span class="function"><span class="title">check_queue_limits</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">maybe</span></span><br><span class="line">        ok ?= check_vhost_queue_limit(Q),</span><br><span class="line">        ok ?= check_cluster_queue_limit(Q)</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_vhost_queue_limit</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    #resource&#123;name = QueueName&#125; = amqqueue:get_name(Q),</span><br><span class="line">    VHost = amqqueue:get_vhost(Q),</span><br><span class="line">    <span class="keyword">case</span> rabbit_vhost_limit:is_over_queue_limit(VHost) <span class="keyword">of</span></span><br><span class="line">        <span class="literal">false</span> -&gt; ok;</span><br><span class="line">        &#123;true, Limit&#125; -&gt;</span><br><span class="line">            queue_limit_error(<span class="string">&quot;cannot declare queue &#x27;~ts&#x27;: &quot;</span></span><br><span class="line">                <span class="string">&quot;queue limit in vhost &#x27;~ts&#x27; (~tp) is reached&quot;</span>,</span><br><span class="line">                [QueueName, VHost, Limit])</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-5-阶段五：Classic-队列声明-rabbit-classic-queue-declare-2"><a href="#3-5-阶段五：Classic-队列声明-rabbit-classic-queue-declare-2" class="headerlink" title="3.5 阶段五：Classic 队列声明 (rabbit_classic_queue:declare/2)"></a>3.5 阶段五：Classic 队列声明 (<code>rabbit_classic_queue:declare/2</code>)</h3><h4 id="源码位置-4"><a href="#源码位置-4" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/rabbit_classic_queue.erl:120-146</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">declare</span><span class="params">(Q, Node)</span> <span class="title">when</span> ?<span class="title">amqqueue_is_classic</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> validate_arguments(amqqueue:get_arguments(Q)) <span class="keyword">of</span></span><br><span class="line">        ok -&gt; do_declare(Q, Node);</span><br><span class="line">        Error -&gt; Error</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">do_declare</span><span class="params">(Q, Node)</span> <span class="title">when</span> ?<span class="title">amqqueue_is_classic</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    QName = amqqueue:get_name(Q),</span><br><span class="line">    VHost = amqqueue:get_vhost(Q),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 1. 确定队列所在节点</span></span><br><span class="line">    Node1 = <span class="keyword">case</span> &#123;Node, rabbit_amqqueue:is_exclusive(Q)&#125; <span class="keyword">of</span></span><br><span class="line">        &#123;&#123;ignore_location, Node0&#125;, _&#125; -&gt;</span><br><span class="line">            Node0;</span><br><span class="line">        &#123;_, true&#125; -&gt;</span><br><span class="line">            Node;  <span class="comment">% 独占队列在当前节点</span></span><br><span class="line">        _ -&gt;</span><br><span class="line">            <span class="comment">%% 使用位置选择策略</span></span><br><span class="line">            &#123;Node0, _&#125; = rabbit_queue_location:select_leader_and_followers(Q, <span class="number">1</span>),</span><br><span class="line">            Node0</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 2. 检查 VHost 是否存在</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_vhost_sup_sup:get_vhost_sup(VHost, Node1) <span class="keyword">of</span></span><br><span class="line">        &#123;ok, _&#125; -&gt;</span><br><span class="line">            <span class="comment">%% 3. 启动队列进程并等待初始化</span></span><br><span class="line">            gen_server2:call(</span><br><span class="line">                rabbit_amqqueue_sup_sup:start_queue_process(Node1, Q),</span><br><span class="line">                &#123;init, new&#125;, </span><br><span class="line">                infinity);</span><br><span class="line">        &#123;error, Error&#125; -&gt;</span><br><span class="line">            &#123;protocol_error, internal_error, </span><br><span class="line">             <span class="string">&quot;Cannot declare a queue &#x27;~ts&#x27; on node &#x27;~ts&#x27;: ~255p&quot;</span>,</span><br><span class="line">             [rabbit_misc:rs(QName), Node1, Error]&#125;</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-6-阶段六：启动队列进程"><a href="#3-6-阶段六：启动队列进程" class="headerlink" title="3.6 阶段六：启动队列进程"></a>3.6 阶段六：启动队列进程</h3><h4 id="3-6-1-启动队列进程-rabbit-amqqueue-sup-sup-start-queue-process-2"><a href="#3-6-1-启动队列进程-rabbit-amqqueue-sup-sup-start-queue-process-2" class="headerlink" title="3.6.1 启动队列进程 (rabbit_amqqueue_sup_sup:start_queue_process/2)"></a>3.6.1 启动队列进程 (<code>rabbit_amqqueue_sup_sup:start_queue_process/2</code>)</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_amqqueue_sup_sup.erl:32-36</span></span><br><span class="line"><span class="function"><span class="title">start_queue_process</span><span class="params">(Node, Q)</span> -&gt;</span></span><br><span class="line">    #resource&#123;virtual_host = VHost&#125; = amqqueue:get_name(Q),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 找到 VHost 的队列监督者</span></span><br><span class="line">    &#123;ok, Sup&#125; = find_for_vhost(VHost, Node),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 启动新的队列子进程</span></span><br><span class="line">    &#123;ok, _SupPid, QPid&#125; = supervisor:start_child(Sup, [Q, declare]),</span><br><span class="line">    QPid.</span><br></pre></td></tr></table></figure>

<h4 id="3-6-2-队列监督者初始化-rabbit-amqqueue-sup-start-link-2"><a href="#3-6-2-队列监督者初始化-rabbit-amqqueue-sup-start-link-2" class="headerlink" title="3.6.2 队列监督者初始化 (rabbit_amqqueue_sup:start_link/2)"></a>3.6.2 队列监督者初始化 (<code>rabbit_amqqueue_sup:start_link/2</code>)</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_amqqueue_sup.erl:23-37</span></span><br><span class="line"><span class="function"><span class="title">start_link</span><span class="params">(Q, _StartMode)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 创建 Marker 进程用于区分启动和重启</span></span><br><span class="line">    Marker = spawn_link(<span class="keyword">fun</span>() -&gt; <span class="keyword">receive</span> stop -&gt; ok <span class="keyword">end</span> <span class="keyword">end</span>),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 定义队列进程的启动规范</span></span><br><span class="line">    StartMFA = &#123;rabbit_amqqueue_process, start_link, [Q, Marker]&#125;,</span><br><span class="line">    ChildSpec = #&#123;id =&gt; rabbit_amqqueue,</span><br><span class="line">                  start =&gt; StartMFA,</span><br><span class="line">                  restart =&gt; transient,</span><br><span class="line">                  significant =&gt; true,</span><br><span class="line">                  shutdown =&gt; ?CLASSIC_QUEUE_WORKER_WAIT,</span><br><span class="line">                  type =&gt; worker,</span><br><span class="line">                  modules =&gt; [rabbit_amqqueue_process]&#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 启动监督者</span></span><br><span class="line">    &#123;ok, SupPid&#125; = supervisor:start_link(?MODULE, []),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 启动队列进程</span></span><br><span class="line">    &#123;ok, QPid&#125; = supervisor:start_child(SupPid, ChildSpec),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 清理 Marker</span></span><br><span class="line">    unlink(Marker),</span><br><span class="line">    Marker ! stop,</span><br><span class="line">    &#123;ok, SupPid, QPid&#125;.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-7-阶段七：队列进程初始化-rabbit-amqqueue-process"><a href="#3-7-阶段七：队列进程初始化-rabbit-amqqueue-process" class="headerlink" title="3.7 阶段七：队列进程初始化 (rabbit_amqqueue_process)"></a>3.7 阶段七：队列进程初始化 (<code>rabbit_amqqueue_process</code>)</h3><h4 id="源码位置-5"><a href="#源码位置-5" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/rabbit_amqqueue_process.erl:144-239</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 启动入口</span></span><br><span class="line"><span class="function"><span class="title">start_link</span><span class="params">(Q, Marker)</span> -&gt;</span></span><br><span class="line">    gen_server2:start_link(?MODULE, &#123;Q, Marker&#125;, []).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 初始化</span></span><br><span class="line"><span class="function"><span class="title">init</span><span class="params">(&#123;Q, Marker&#125;)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> is_process_alive(Marker) <span class="keyword">of</span></span><br><span class="line">        <span class="literal">true</span>  -&gt;</span><br><span class="line">            <span class="comment">%% 正常启动</span></span><br><span class="line">            init(Q);</span><br><span class="line">        <span class="literal">false</span> -&gt;</span><br><span class="line">            <span class="comment">%% 重启场景</span></span><br><span class="line">            QueueName = amqqueue:get_name(Q),</span><br><span class="line">            &#123;ok, Q1&#125; = rabbit_amqqueue:lookup(QueueName),</span><br><span class="line">            gen_server2:cast(self(), init),</span><br><span class="line">            init(Q1)</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">init</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    process_flag(trap_exit, true),</span><br><span class="line">    ?store_proc_name(amqqueue:get_name(Q)),</span><br><span class="line">    &#123;ok, init_state(amqqueue:set_pid(Q, self())), hibernate,</span><br><span class="line">     &#123;backoff, ?HIBERNATE_AFTER_MIN, ?HIBERNATE_AFTER_MIN, ?DESIRED_HIBERNATE&#125;,</span><br><span class="line">    ?MODULE&#125;.</span><br></pre></td></tr></table></figure>

<h4 id="3-7-1-初始化状态"><a href="#3-7-1-初始化状态" class="headerlink" title="3.7.1 初始化状态"></a>3.7.1 初始化状态</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_amqqueue_process.erl:165-180</span></span><br><span class="line"><span class="function"><span class="title">init_state</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    SingleActiveConsumerOn = <span class="keyword">case</span> rabbit_misc:table_lookup(</span><br><span class="line">            amqqueue:get_arguments(Q), &lt;&lt;<span class="string">&quot;x-single-active-consumer&quot;</span>&gt;&gt;) <span class="keyword">of</span></span><br><span class="line">        &#123;bool, true&#125; -&gt; <span class="literal">true</span>;</span><br><span class="line">        _            -&gt; <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    State = #q&#123;q                         = Q,</span><br><span class="line">               active_consumer           = none,</span><br><span class="line">               has_had_consumers         = false,</span><br><span class="line">               consumers                 = rabbit_queue_consumers:new(),</span><br><span class="line">               senders                   = pmon:new(delegate),</span><br><span class="line">               msg_id_to_channel         = #&#123;&#125;,</span><br><span class="line">               status                    = running,</span><br><span class="line">               args_policy_version       = <span class="number">0</span>,</span><br><span class="line">               overflow                  = &#x27;drop-head&#x27;,</span><br><span class="line">               single_active_consumer_on = SingleActiveConsumerOn&#125;,</span><br><span class="line">    rabbit_event:init_stats_timer(State, #q.stats_timer).</span><br></pre></td></tr></table></figure>

<h4 id="3-7-2-处理-init-new-调用"><a href="#3-7-2-处理-init-new-调用" class="headerlink" title="3.7.2 处理 {init, new} 调用"></a>3.7.2 处理 <code>{init, new}</code> 调用</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% handle_call 会路由到 init_it/3</span></span><br><span class="line"><span class="function"><span class="title">init_it</span><span class="params">(Recover, From, State = #q&#123;q = Q&#125;)</span></span></span><br><span class="line"><span class="function">  <span class="title">when</span> ?<span class="title">amqqueue_exclusive_owner_is</span><span class="params">(Q, none)</span> -&gt;</span></span><br><span class="line">    init_it2(Recover, From, State);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">init_it2</span><span class="params">(Recover, From, State = #q&#123;q = Q,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   backing_queue = undefined,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   backing_queue_state = undefined&#125;)</span> -&gt;</span></span><br><span class="line">    &#123;Barrier, TermsOrNew&#125; = recovery_status(Recover),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 关键：内部声明，写入数据库</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_amqqueue:internal_declare(Q, Recover /= new) <span class="keyword">of</span></span><br><span class="line">        &#123;Res, Q1&#125; <span class="keyword">when</span> ?is_amqqueue(Q1) <span class="keyword">andalso</span></span><br><span class="line">                       (Res == created <span class="keyword">orelse</span> Res == existing) -&gt;</span><br><span class="line">            <span class="keyword">case</span> matches(Recover, Q, Q1) <span class="keyword">of</span></span><br><span class="line">                <span class="literal">true</span> -&gt;</span><br><span class="line">                    <span class="comment">%% 初始化 backing queue</span></span><br><span class="line">                    BQ = backing_queue_module(),</span><br><span class="line">                    BQS = bq_init(BQ, Q, TermsOrNew),</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">%% 回复调用者</span></span><br><span class="line">                    send_reply(From, &#123;new, Q&#125;),</span><br><span class="line">                    </span><br><span class="line">                    recovery_barrier(Barrier),</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">%% 处理策略和参数</span></span><br><span class="line">                    State1 = process_args_policy(</span><br><span class="line">                        State#q&#123;backing_queue = BQ,</span><br><span class="line">                                backing_queue_state = BQS&#125;),</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">%% 通知装饰器</span></span><br><span class="line">                    notify_decorators(startup, State),</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">%% 发送事件通知</span></span><br><span class="line">                    rabbit_event:notify(queue_created,</span><br><span class="line">                        queue_created_infos(State1)),</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">%% 发送统计信息</span></span><br><span class="line">                    rabbit_event:if_enabled(State1, #q.stats_timer,</span><br><span class="line">                        <span class="keyword">fun</span>() -&gt; emit_stats(State1) <span class="keyword">end</span>),</span><br><span class="line">                    </span><br><span class="line">                    noreply(State1);</span><br><span class="line">                <span class="literal">false</span> -&gt;</span><br><span class="line">                    &#123;stop, normal, &#123;existing, Q1&#125;, State&#125;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        &#123;error, timeout&#125; -&gt;</span><br><span class="line">            <span class="comment">%% 超时处理</span></span><br><span class="line">            ...;</span><br><span class="line">        Err -&gt;</span><br><span class="line">            &#123;stop, normal, Err, State&#125;</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-8-阶段八：数据库持久化-rabbit-amqqueue-internal-declare-2"><a href="#3-8-阶段八：数据库持久化-rabbit-amqqueue-internal-declare-2" class="headerlink" title="3.8 阶段八：数据库持久化 (rabbit_amqqueue:internal_declare/2)"></a>3.8 阶段八：数据库持久化 (<code>rabbit_amqqueue:internal_declare/2</code>)</h3><h4 id="源码位置-6"><a href="#源码位置-6" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/rabbit_amqqueue.erl:275-302</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-spec</span> internal_declare<span class="params">(Queue, Recover)</span> -&gt; Ret when</span><br><span class="line">      Queue :: amqqueue:amqqueue<span class="params">()</span>,</span><br><span class="line">      Recover :: boolean<span class="params">()</span>,</span><br><span class="line">      Ret :: &#123;created | existing, amqqueue:amqqueue<span class="params">()</span>&#125; |</span><br><span class="line">             queue_absent<span class="params">()</span> |</span><br><span class="line">             rabbit_khepri:timeout_error<span class="params">()</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">internal_declare</span><span class="params">(Q, Recover)</span> -&gt;</span></span><br><span class="line">    do_internal_declare(Q, Recover).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 恢复模式</span></span><br><span class="line"><span class="function"><span class="title">do_internal_declare</span><span class="params">(Q0, true)</span> -&gt;</span></span><br><span class="line">    Q = amqqueue:set_state(Q0, live),</span><br><span class="line">    <span class="keyword">case</span> store_queue(Q) <span class="keyword">of</span></span><br><span class="line">        ok -&gt; &#123;created, Q0&#125;;</span><br><span class="line">        &#123;error, timeout&#125; = Err -&gt; Err</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 新建模式 (我们的示例走这条路径)</span></span><br><span class="line"><span class="function"><span class="title">do_internal_declare</span><span class="params">(Q0, false)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 1. 设置状态为 live</span></span><br><span class="line">    <span class="comment">%% 2. 应用策略</span></span><br><span class="line">    Q = rabbit_policy:set(amqqueue:set_state(Q0, live)),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 3. 设置装饰器</span></span><br><span class="line">    Queue = rabbit_queue_decorator:set(Q),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 4. 写入数据库</span></span><br><span class="line">    rabbit_db_queue:create_or_get(Queue).</span><br></pre></td></tr></table></figure>

<h4 id="数据库操作-rabbit-db-queue-create-or-get-1"><a href="#数据库操作-rabbit-db-queue-create-or-get-1" class="headerlink" title="数据库操作 (rabbit_db_queue:create_or_get/1)"></a>数据库操作 (<code>rabbit_db_queue:create_or_get/1</code>)</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_db_queue.erl:895-930</span></span><br><span class="line"><span class="function"><span class="title">create_or_get</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    rabbit_khepri:handle_fallback(</span><br><span class="line">      #&#123;mnesia =&gt; <span class="keyword">fun</span>() -&gt; create_or_get_in_mnesia(Q) <span class="keyword">end</span>,</span><br><span class="line">        khepri =&gt; <span class="keyword">fun</span>() -&gt; create_or_get_in_khepri(Q) <span class="keyword">end</span></span><br><span class="line">       &#125;).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% Mnesia 实现</span></span><br><span class="line"><span class="function"><span class="title">create_or_get_in_mnesia</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    DurableQ = amqqueue:reset_decorators(Q),</span><br><span class="line">    QueueName = amqqueue:get_name(Q),</span><br><span class="line">    rabbit_mnesia:execute_mnesia_transaction(</span><br><span class="line">      <span class="keyword">fun</span> () -&gt;</span><br><span class="line">              <span class="keyword">case</span> mnesia:wread(&#123;?MNESIA_TABLE, QueueName&#125;) <span class="keyword">of</span></span><br><span class="line">                  [] -&gt;</span><br><span class="line">                      <span class="comment">%% 队列不存在</span></span><br><span class="line">                      <span class="keyword">case</span> get_durable_in_mnesia_tx(QueueName) <span class="keyword">of</span></span><br><span class="line">                          &#123;error, not_found&#125; -&gt;</span><br><span class="line">                              <span class="comment">%% 创建新队列</span></span><br><span class="line">                              set_in_mnesia_tx(DurableQ, Q),</span><br><span class="line">                              &#123;created, Q&#125;;</span><br><span class="line">                          &#123;ok, QRecord&#125; -&gt;</span><br><span class="line">                              <span class="comment">%% 存在持久化记录但运行时不存在</span></span><br><span class="line">                              &#123;absent, QRecord, nodedown&#125;</span><br><span class="line">                      <span class="keyword">end</span>;</span><br><span class="line">                  [ExistingQ] -&gt;</span><br><span class="line">                      <span class="comment">%% 队列已存在</span></span><br><span class="line">                      &#123;existing, ExistingQ&#125;</span><br><span class="line">              <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span>).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% Khepri 实现</span></span><br><span class="line"><span class="function"><span class="title">create_or_get_in_khepri</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    QueueName = amqqueue:get_name(Q),</span><br><span class="line">    Path = khepri_queue_path(QueueName),</span><br><span class="line">    <span class="keyword">case</span> rabbit_khepri:adv_create(Path, Q) <span class="keyword">of</span></span><br><span class="line">        &#123;error, &#123;khepri, mismatching_node, #&#123;node_props := #&#123;data := ExistingQ&#125;&#125;&#125;&#125; -&gt;</span><br><span class="line">            &#123;existing, ExistingQ&#125;;</span><br><span class="line">        &#123;ok, _&#125; -&gt;</span><br><span class="line">            &#123;created, Q&#125;;</span><br><span class="line">        Error -&gt;</span><br><span class="line">            Error</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-进程监督树结构"><a href="#4-进程监督树结构" class="headerlink" title="4. 进程监督树结构"></a>4. 进程监督树结构</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rabbit_sup</span><br><span class="line">├── rabbit_vhost_sup_sup</span><br><span class="line">│   └── rabbit_vhost_sup (per VHost)</span><br><span class="line">│       └── rabbit_amqqueue_sup_sup</span><br><span class="line">│           └── rabbit_amqqueue_sup (per Queue)</span><br><span class="line">│               └── rabbit_amqqueue_process (队列工作进程)</span><br></pre></td></tr></table></figure>

<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">                    rabbit_sup</span><br><span class="line">                        │</span><br><span class="line">                        ▼</span><br><span class="line">              rabbit_vhost_sup_sup</span><br><span class="line">                        │</span><br><span class="line">                        ▼</span><br><span class="line">         ┌──────────────┼──────────────┐</span><br><span class="line">         ▼              ▼              ▼</span><br><span class="line">  rabbit_vhost_sup  rabbit_vhost_sup  ...</span><br><span class="line">   (vhost: /)       (vhost: test)</span><br><span class="line">         │</span><br><span class="line">         ▼</span><br><span class="line">rabbit_amqqueue_sup_sup</span><br><span class="line">         │</span><br><span class="line">         ├──────────────┬──────────────┐</span><br><span class="line">         ▼              ▼              ▼</span><br><span class="line">rabbit_amqqueue_sup  rabbit_amqqueue_sup  ...</span><br><span class="line">  (testqueue1)        (testqueue2)</span><br><span class="line">         │              │</span><br><span class="line">         ▼              ▼</span><br><span class="line">rabbit_amqqueue_     rabbit_amqqueue_</span><br><span class="line">    process              process</span><br><span class="line">   &lt;<span class="number">0.861</span><span class="selector-class">.0</span>&gt;           &lt;<span class="number">0.862</span><span class="selector-class">.0</span>&gt;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-返回结果解析"><a href="#5-返回结果解析" class="headerlink" title="5. 返回结果解析"></a>5. 返回结果解析</h2><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;new, &#123;amqqueue, &#123;resource,&lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;,queue,&lt;&lt;<span class="string">&quot;testqueue2&quot;</span>&gt;&gt;&#125;,</span><br><span class="line">                 false,        <span class="comment">% durable</span></span><br><span class="line">                 false,        <span class="comment">% auto_delete</span></span><br><span class="line">                 none,         <span class="comment">% exclusive_owner</span></span><br><span class="line">                 [],           <span class="comment">% arguments</span></span><br><span class="line">                 &lt;<span class="number">0.862</span>.<span class="number">0</span>&gt;,    <span class="comment">% pid (队列进程)</span></span><br><span class="line">                 [],           <span class="comment">% slave_pids (保留)</span></span><br><span class="line">                 [],           <span class="comment">% sync_slave_pids (保留)</span></span><br><span class="line">                 [],           <span class="comment">% recoverable_slaves (保留)</span></span><br><span class="line">                 undefined,    <span class="comment">% policy</span></span><br><span class="line">                 undefined,    <span class="comment">% operator_policy</span></span><br><span class="line">                 [],           <span class="comment">% gm_pids (保留)</span></span><br><span class="line">                 [],           <span class="comment">% decorators</span></span><br><span class="line">                 live,         <span class="comment">% state</span></span><br><span class="line">                 <span class="number">0</span>,            <span class="comment">% policy_version</span></span><br><span class="line">                 [],           <span class="comment">% type_state</span></span><br><span class="line">                 &lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;,      <span class="comment">% vhost</span></span><br><span class="line">                 #&#123;user =&gt; &lt;&lt;<span class="string">&quot;acting-user&quot;</span>&gt;&gt;&#125;&#125;&#125;  <span class="comment">% options</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>字段</th>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>结果类型</td>
<td><code>new</code></td>
<td>新创建的队列</td>
</tr>
<tr>
<td>name</td>
<td><code>{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;testqueue2&quot;&gt;&gt;}</code></td>
<td>队列资源标识</td>
</tr>
<tr>
<td>durable</td>
<td><code>false</code></td>
<td>非持久化队列</td>
</tr>
<tr>
<td>auto_delete</td>
<td><code>false</code></td>
<td>不自动删除</td>
</tr>
<tr>
<td>exclusive_owner</td>
<td><code>none</code></td>
<td>非独占队列</td>
</tr>
<tr>
<td>arguments</td>
<td><code>[]</code></td>
<td>无额外参数</td>
</tr>
<tr>
<td>pid</td>
<td><code>&lt;0.862.0&gt;</code></td>
<td>队列进程 PID</td>
</tr>
<tr>
<td>state</td>
<td><code>live</code></td>
<td>运行状态</td>
</tr>
<tr>
<td>vhost</td>
<td><code>&lt;&lt;&quot;/&quot;&gt;&gt;</code></td>
<td>所属 VHost</td>
</tr>
<tr>
<td>options</td>
<td><code>#{user =&gt; &lt;&lt;&quot;acting-user&quot;&gt;&gt;}</code></td>
<td>操作用户</td>
</tr>
</tbody></table>
<hr>
<h2 id="6-关键数据流图"><a href="#6-关键数据流图" class="headerlink" title="6. 关键数据流图"></a>6. 关键数据流图</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">输入参数</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_misc:r(<span class="operator">&lt;</span><span class="operator">&lt;</span><span class="string">&quot;/&quot;</span><span class="operator">&gt;</span><span class="operator">&gt;</span>, queue, <span class="operator">&lt;</span><span class="operator">&lt;</span><span class="string">&quot;testqueue2&quot;</span><span class="operator">&gt;</span><span class="operator">&gt;</span>)             │</span><br><span class="line">│     <span class="operator">=</span><span class="operator">&gt;</span> <span class="comment">#resource&#123;virtual_host = &lt;&lt;&quot;/&quot;&gt;&gt;,                    │</span></span><br><span class="line">│                  kind <span class="operator">=</span> queue,                              │</span><br><span class="line">│                  name <span class="operator">=</span> <span class="operator">&lt;</span><span class="operator">&lt;</span><span class="string">&quot;testqueue2&quot;</span><span class="operator">&gt;</span><span class="operator">&gt;</span>&#125;                   │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_amqqueue:declare<span class="symbol">/6</span>                                   │</span><br><span class="line">│   <span class="number">1</span>. check_declare_arguments<span class="symbol">/3</span>  ✓                           │</span><br><span class="line">│   <span class="number">2</span>. get_queue_type<span class="symbol">/2</span> <span class="operator">=</span><span class="operator">&gt;</span> rabbit_classic_queue               │</span><br><span class="line">│   <span class="number">3</span>. amqqueue:new<span class="symbol">/9</span> <span class="operator">=</span><span class="operator">&gt;</span> <span class="comment">#amqqueue&#123;...&#125;                       │</span></span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_queue_type:declare<span class="symbol">/2</span>                                 │</span><br><span class="line">│   <span class="number">1</span>. rabbit_policy:set<span class="symbol">/1</span> <span class="operator">=</span><span class="operator">&gt;</span> 应用策略                         │</span><br><span class="line">│   <span class="number">2</span>. rabbit_queue_decorator:set<span class="symbol">/1</span> <span class="operator">=</span><span class="operator">&gt;</span> 设置装饰器              │</span><br><span class="line">│   <span class="number">3</span>. check_queue_limits<span class="symbol">/1</span> ✓                                 │</span><br><span class="line">│   <span class="number">4</span>. Mod:declare<span class="symbol">/2</span> <span class="operator">=</span><span class="operator">&gt;</span> rabbit_classic_queue:declare<span class="symbol">/2</span>        │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_classic_queue:declare<span class="symbol">/2</span>                              │</span><br><span class="line">│   <span class="number">1</span>. validate_arguments<span class="symbol">/1</span> ✓                                 │</span><br><span class="line">│   <span class="number">2</span>. select_leader_and_followers<span class="symbol">/2</span> <span class="operator">=</span><span class="operator">&gt;</span> 选择节点               │</span><br><span class="line">│   <span class="number">3</span>. rabbit_amqqueue_sup_sup:start_queue_process<span class="symbol">/2</span>          │</span><br><span class="line">│   <span class="number">4</span>. gen_server2:call(&#123;init, new&#125;, infinity)                │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_amqqueue_process                                     │</span><br><span class="line">│   <span class="number">1</span>. init<span class="symbol">/1</span> <span class="operator">=</span><span class="operator">&gt;</span> 初始化进程状态                                │</span><br><span class="line">│   <span class="number">2</span>. handle_call(&#123;init, new&#125;, ...) <span class="operator">=</span><span class="operator">&gt;</span> init_it2<span class="symbol">/3</span>            │</span><br><span class="line">│   <span class="number">3</span>. rabbit_amqqueue:internal_declare<span class="symbol">/2</span>                     │</span><br><span class="line">│   <span class="number">4</span>. rabbit_db_queue:create_or_get<span class="symbol">/1</span>                        │</span><br><span class="line">│   <span class="number">5</span>. 初始化 backing_queue                                   │</span><br><span class="line">│   <span class="number">6</span>. 发送 queue_created 事件                                 │</span><br><span class="line">│   <span class="number">7</span>. 返回 &#123;new, Q&#125;                                          │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_db_queue:create_or_get<span class="symbol">/1</span>                             │</span><br><span class="line">│   <span class="params">Mnesia:</span> mnesia:wread <span class="operator">+</span> mnesia:write                       │</span><br><span class="line">│   <span class="params">Khepri:</span> rabbit_khepri:adv_create                          │</span><br><span class="line">│   <span class="operator">=</span><span class="operator">&gt;</span> &#123;created, Q&#125; | &#123;existing, Q&#125;                           │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">返回结果: &#123;new, <span class="comment">#amqqueue&#123;...&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-时序图"><a href="#7-时序图" class="headerlink" title="7. 时序图"></a>7. 时序图</h2><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Client          rabbit_amqqueue    rabbit_queue_type   rabbit_classic_queue</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line">   │  <span class="keyword">declare</span>/<span class="number">6</span>        │                   │                    │</span><br><span class="line">   │──────────────────▶│                   │                    │</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line">   │                   │ check_arguments   │                    │</span><br><span class="line">   │                   │◀─────────────────▶│                    │</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line">   │                   │ amqqueue:<span class="keyword">new</span>/<span class="number">9</span>    │                    │</span><br><span class="line">   │                   │──────────────────▶│                    │</span><br><span class="line">   │                   │◀──────────────────│                    │</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line">   │                   │ <span class="keyword">declare</span>/<span class="number">2</span>         │                    │</span><br><span class="line">   │                   │──────────────────▶│                    │</span><br><span class="line">   │                   │                   │ <span class="keyword">declare</span>/<span class="number">2</span>          │</span><br><span class="line">   │                   │                   │───────────────────▶│</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line"></span><br><span class="line">rabbit_classic_queue   rabbit_amqqueue_sup_sup   rabbit_amqqueue_process   rabbit_db_queue</span><br><span class="line">         │                      │                        │                      │</span><br><span class="line">         │ start_queue_process  │                        │                      │</span><br><span class="line">         │─────────────────────▶│                        │                      │</span><br><span class="line">         │                      │ supervisor:start_child │                      │</span><br><span class="line">         │                      │───────────────────────▶│                      │</span><br><span class="line">         │                      │◀───────────────────────│                      │</span><br><span class="line">         │◀─────────────────────│                        │                      │</span><br><span class="line">         │                      │                        │                      │</span><br><span class="line">         │ gen_server2:<span class="keyword">call</span>     │                        │                      │</span><br><span class="line">         │  &#123;init, <span class="keyword">new</span>&#125;         │                        │                      │</span><br><span class="line">         │───────────────────────────────────────────────▶│                      │</span><br><span class="line">         │                      │                        │ internal_declare     │</span><br><span class="line">         │                      │                        │─────────────────────▶│</span><br><span class="line">         │                      │                        │ create_or_get        │</span><br><span class="line">         │                      │                        │─────────────────────▶│</span><br><span class="line">         │                      │                        │◀─────────────────────│</span><br><span class="line">         │                      │                        │ &#123;created, Q&#125;         │</span><br><span class="line">         │◀───────────────────────────────────────────────│                      │</span><br><span class="line">         │ &#123;<span class="keyword">new</span>, Q&#125;             │                        │                      │</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-队列类型对比"><a href="#8-队列类型对比" class="headerlink" title="8. 队列类型对比"></a>8. 队列类型对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>Classic Queue</th>
<th>Quorum Queue</th>
<th>Stream Queue</th>
</tr>
</thead>
<tbody><tr>
<td>模块</td>
<td><code>rabbit_classic_queue</code></td>
<td><code>rabbit_quorum_queue</code></td>
<td><code>rabbit_stream_queue</code></td>
</tr>
<tr>
<td>存储</td>
<td><code>rabbit_variable_queue</code></td>
<td>Ra (Raft)</td>
<td>Osiris</td>
</tr>
<tr>
<td>持久化</td>
<td>可选</td>
<td>强制</td>
<td>强制</td>
</tr>
<tr>
<td>复制</td>
<td>不支持</td>
<td>支持 (Raft)</td>
<td>支持</td>
</tr>
<tr>
<td>声明流程</td>
<td><code>gen_server2:call</code></td>
<td><code>ra:start_cluster</code></td>
<td><code>rabbit_stream_coordinator</code></td>
</tr>
</tbody></table>
<hr>
<h2 id="9-错误处理"><a href="#9-错误处理" class="headerlink" title="9. 错误处理"></a>9. 错误处理</h2><h3 id="9-1-常见错误类型"><a href="#9-1-常见错误类型" class="headerlink" title="9.1 常见错误类型"></a>9.1 常见错误类型</h3><table>
<thead>
<tr>
<th>错误</th>
<th>原因</th>
<th>处理</th>
</tr>
</thead>
<tbody><tr>
<td><code>{existing, Q}</code></td>
<td>队列已存在</td>
<td>返回现有队列</td>
</tr>
<tr>
<td><code>{absent, Q, nodedown}</code></td>
<td>节点宕机</td>
<td>返回缺席状态</td>
</tr>
<tr>
<td><code>{error, timeout}</code></td>
<td>数据库超时</td>
<td>返回超时错误</td>
</tr>
<tr>
<td><code>{protocol_error, ...}</code></td>
<td>参数验证失败</td>
<td>返回协议错误</td>
</tr>
</tbody></table>
<h3 id="9-2-队列限制检查"><a href="#9-2-队列限制检查" class="headerlink" title="9.2 队列限制检查"></a>9.2 队列限制检查</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% VHost 队列数量限制</span></span><br><span class="line"><span class="function"><span class="title">check_vhost_queue_limit</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_vhost_limit:is_over_queue_limit(VHost) <span class="keyword">of</span></span><br><span class="line">        <span class="literal">false</span> -&gt; ok;</span><br><span class="line">        &#123;true, Limit&#125; -&gt; queue_limit_error(...)</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 集群队列数量限制</span></span><br><span class="line"><span class="function"><span class="title">check_cluster_queue_limit</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_misc:get_env(rabbit, cluster_queue_limit, infinity) <span class="keyword">of</span></span><br><span class="line">        infinity -&gt; ok;</span><br><span class="line">        Limit <span class="keyword">when</span> Count &gt;= Limit -&gt; queue_limit_error(...);</span><br><span class="line">        _ -&gt; ok</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="10-总结"><a href="#10-总结" class="headerlink" title="10. 总结"></a>10. 总结</h2><h3 id="10-1-完整调用链"><a href="#10-1-完整调用链" class="headerlink" title="10.1 完整调用链"></a>10.1 完整调用链</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">rabbit_misc:r<span class="symbol">/3</span></span><br><span class="line">    ↓</span><br><span class="line">rabbit_amqqueue:declare<span class="symbol">/6</span></span><br><span class="line">    ↓</span><br><span class="line">rabbit_amqqueue:declare<span class="symbol">/7</span></span><br><span class="line">    ↓</span><br><span class="line">    ├── check_declare_arguments<span class="symbol">/3</span></span><br><span class="line">    ├── get_queue_type<span class="symbol">/2</span></span><br><span class="line">    ├── amqqueue:new<span class="symbol">/9</span></span><br><span class="line">    └── rabbit_queue_type:declare<span class="symbol">/2</span></span><br><span class="line">            ↓</span><br><span class="line">            ├── rabbit_policy:set<span class="symbol">/1</span></span><br><span class="line">            ├── rabbit_queue_decorator:set<span class="symbol">/1</span></span><br><span class="line">            ├── check_queue_limits<span class="symbol">/1</span></span><br><span class="line">            └── rabbit_classic_queue:declare<span class="symbol">/2</span></span><br><span class="line">                    ↓</span><br><span class="line">                    ├── validate_arguments<span class="symbol">/1</span></span><br><span class="line">                    ├── rabbit_queue_location:select_leader_and_followers<span class="symbol">/2</span></span><br><span class="line">                    ├── rabbit_amqqueue_sup_sup:start_queue_process<span class="symbol">/2</span></span><br><span class="line">                    │       ↓</span><br><span class="line">                    │       └── supervisor:start_child<span class="symbol">/2</span></span><br><span class="line">                    │               ↓</span><br><span class="line">                    │               └── rabbit_amqqueue_sup:start_link<span class="symbol">/2</span></span><br><span class="line">                    │                       ↓</span><br><span class="line">                    │                       └── rabbit_amqqueue_process:start_link<span class="symbol">/2</span></span><br><span class="line">                    └── gen_server2:call(&#123;init, new&#125;, infinity)</span><br><span class="line">                            ↓</span><br><span class="line">                            └── rabbit_amqqueue_process:init_it2<span class="symbol">/3</span></span><br><span class="line">                                    ↓</span><br><span class="line">                                    ├── rabbit_amqqueue:internal_declare<span class="symbol">/2</span></span><br><span class="line">                                    │       ↓</span><br><span class="line">                                    │       └── rabbit_db_queue:create_or_get<span class="symbol">/1</span></span><br><span class="line">                                    │               ↓</span><br><span class="line">                                    │               └── Mnesia<span class="symbol">/Khepri</span> 写入</span><br><span class="line">                                    ├── bq_init<span class="symbol">/3</span> (backing queue)</span><br><span class="line">                                    ├── notify_decorators<span class="symbol">/2</span></span><br><span class="line">                                    └── rabbit_event:notify(queue_created, ...)</span><br></pre></td></tr></table></figure>

<h3 id="10-2-关键模块职责"><a href="#10-2-关键模块职责" class="headerlink" title="10.2 关键模块职责"></a>10.2 关键模块职责</h3><table>
<thead>
<tr>
<th>模块</th>
<th>职责</th>
</tr>
</thead>
<tbody><tr>
<td><code>rabbit_misc</code></td>
<td>通用工具函数，资源名称构建</td>
</tr>
<tr>
<td><code>rabbit_amqqueue</code></td>
<td>队列管理 API 入口</td>
</tr>
<tr>
<td><code>rabbit_queue_type</code></td>
<td>队列类型抽象层，分发到具体实现</td>
</tr>
<tr>
<td><code>rabbit_classic_queue</code></td>
<td>Classic 队列类型实现</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_sup_sup</code></td>
<td>队列监督者的监督者</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_sup</code></td>
<td>单个队列的监督者</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_process</code></td>
<td>队列工作进程 (gen_server2)</td>
</tr>
<tr>
<td><code>rabbit_db_queue</code></td>
<td>队列数据库操作 (Mnesia&#x2F;Khepri)</td>
</tr>
<tr>
<td><code>rabbit_policy</code></td>
<td>策略匹配和应用</td>
</tr>
<tr>
<td><code>rabbit_queue_decorator</code></td>
<td>队列装饰器管理</td>
</tr>
<tr>
<td><code>amqqueue</code></td>
<td>队列记录定义和操作</td>
</tr>
</tbody></table>
<hr>
<h2 id="11-参考源文件"><a href="#11-参考源文件" class="headerlink" title="11. 参考源文件"></a>11. 参考源文件</h2><table>
<thead>
<tr>
<th>文件</th>
<th>代码行数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>rabbit_amqqueue.erl</code></td>
<td>2142</td>
<td>队列管理主模块</td>
</tr>
<tr>
<td><code>rabbit_queue_type.erl</code></td>
<td>~900</td>
<td>队列类型抽象层</td>
</tr>
<tr>
<td><code>rabbit_classic_queue.erl</code></td>
<td>~600</td>
<td>Classic 队列实现</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_process.erl</code></td>
<td>~1500</td>
<td>队列工作进程</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_sup_sup.erl</code></td>
<td>94</td>
<td>队列监督者管理</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_sup.erl</code></td>
<td>49</td>
<td>单队列监督者</td>
</tr>
<tr>
<td><code>rabbit_db_queue.erl</code></td>
<td>~1000</td>
<td>数据库操作</td>
</tr>
<tr>
<td><code>amqqueue.erl</code></td>
<td>~500</td>
<td>队列记录定义</td>
</tr>
<tr>
<td><code>rabbit_policy.erl</code></td>
<td>~500</td>
<td>策略管理</td>
</tr>
<tr>
<td><code>rabbit_misc.erl</code></td>
<td>~1500</td>
<td>通用工具</td>
</tr>
</tbody></table>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Erlang/" rel="tag"># Erlang</a>
              <a href="/tags/RabbitMQ/" rel="tag"># RabbitMQ</a>
              <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag"># 源码分析</a>
              <a href="/tags/%E9%98%9F%E5%88%97%E7%AE%A1%E7%90%86/" rel="tag"># 队列管理</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2026/01/16/rabbitmq-rabbitmq-dependencies-analysis/" rel="prev" title="RabbitMQ 依赖模块全面分析">
                  <i class="fa fa-angle-left"></i> RabbitMQ 依赖模块全面分析
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2026/01/16/erlang-erlang-links-and-monitors/" rel="next" title="Erlang 进程链接与监视器">
                  Erlang 进程链接与监视器 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2024 – 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Zixiang Sun</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"hzsunzixiang/hzsunzixiang.github.io","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js" defer></script>

</body>
</html>
