<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAQ Add Node è°ƒç”¨é“¾åˆ†æ</title>
    <style>
        :root {
            --n1-color: #3498db;
            --n2-color: #e74c3c;
            --arrow-color: #2ecc71;
            --bg-dark: #1a1a2e;
            --bg-light: #16213e;
            --text-color: #eee;
            --code-bg: #0f0f23;
            --border-color: #4a4a6a;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-light) 100%);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--n1-color), var(--n2-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .command-box {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        
        .command-box .cmd {
            color: #f39c12;
            font-size: 1.1em;
        }
        
        .command-box .comment {
            color: #7f8c8d;
        }
        
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        
        .section h2 {
            color: var(--arrow-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--arrow-color);
        }
        
        .section h3 {
            color: #f39c12;
            margin: 20px 0 15px 0;
        }
        
        /* æ—¶åºå›¾æ ·å¼ */
        .sequence-diagram {
            display: flex;
            flex-direction: column;
            gap: 0;
            position: relative;
            padding: 20px 0;
        }
        
        .lifeline-header {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        
        .lifeline-box {
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2em;
            text-align: center;
            min-width: 200px;
        }
        
        .lifeline-n1 {
            background: var(--n1-color);
            color: white;
        }
        
        .lifeline-n2 {
            background: var(--n2-color);
            color: white;
        }
        
        .message-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            position: relative;
        }
        
        .message-row::before,
        .message-row::after {
            content: '';
            position: absolute;
            width: 2px;
            height: 100%;
            background: rgba(255,255,255,0.2);
        }
        
        .message-row::before {
            left: 25%;
        }
        
        .message-row::after {
            right: 25%;
        }
        
        .arrow-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .arrow-right, .arrow-left {
            display: flex;
            align-items: center;
            width: 50%;
            position: relative;
        }
        
        .arrow-right {
            justify-content: flex-start;
            margin-left: 25%;
        }
        
        .arrow-left {
            justify-content: flex-end;
            margin-right: 25%;
        }
        
        .arrow-line {
            height: 2px;
            flex: 1;
            position: relative;
        }
        
        .arrow-right .arrow-line {
            background: linear-gradient(90deg, var(--n1-color), var(--n2-color));
        }
        
        .arrow-left .arrow-line {
            background: linear-gradient(90deg, var(--n2-color), var(--n1-color));
        }
        
        .arrow-head-right::after {
            content: 'â–¶';
            color: var(--n2-color);
            font-size: 1.2em;
        }
        
        .arrow-head-left::before {
            content: 'â—€';
            color: var(--n1-color);
            font-size: 1.2em;
        }
        
        .message-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--code-bg);
            padding: 4px 12px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            white-space: nowrap;
            border: 1px solid var(--border-color);
        }
        
        .step-number {
            position: absolute;
            left: 10px;
            background: var(--arrow-color);
            color: var(--bg-dark);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        /* è°ƒç”¨é“¾æ ·å¼ */
        .call-chain {
            background: var(--code-bg);
            border-radius: 8px;
            padding: 20px;
            overflow-x: auto;
        }
        
        .call-item {
            display: flex;
            align-items: flex-start;
            margin: 10px 0;
            padding-left: calc(var(--depth) * 25px);
        }
        
        .call-item .timestamp {
            color: #7f8c8d;
            font-family: monospace;
            min-width: 120px;
            font-size: 0.85em;
        }
        
        .call-item .process {
            color: #9b59b6;
            font-family: monospace;
            min-width: 100px;
            font-size: 0.85em;
        }
        
        .call-item .function {
            color: #3498db;
            font-family: monospace;
        }
        
        .call-item .module {
            color: #e74c3c;
        }
        
        .call-item .args {
            color: #f39c12;
            font-size: 0.85em;
        }
        
        .call-item .return {
            color: #2ecc71;
        }
        
        .call-item .arrow {
            color: #7f8c8d;
            margin: 0 8px;
        }
        
        .indent-1 { --depth: 1; }
        .indent-2 { --depth: 2; }
        .indent-3 { --depth: 3; }
        .indent-4 { --depth: 4; }
        
        /* èŠ‚ç‚¹æ ‡ç­¾ */
        .node-tag {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .node-tag.n1 {
            background: var(--n1-color);
            color: white;
        }
        
        .node-tag.n2 {
            background: var(--n2-color);
            color: white;
        }
        
        /* çŠ¶æ€å˜åŒ– */
        .state-change {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(46, 204, 113, 0.1);
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--arrow-color);
        }
        
        .state-box {
            padding: 8px 16px;
            border-radius: 6px;
            font-family: monospace;
            font-weight: bold;
        }
        
        .state-not-ready {
            background: #e74c3c;
            color: white;
        }
        
        .state-transient {
            background: #f39c12;
            color: white;
        }
        
        .state-ready {
            background: #2ecc71;
            color: white;
        }
        
        .state-arrow {
            font-size: 1.5em;
            color: var(--arrow-color);
        }
        
        /* ä»£ç å— */
        pre {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        code {
            font-family: 'Consolas', 'Monaco', monospace;
            background: rgba(255,255,255,0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .highlight-func {
            color: #3498db;
        }
        
        .highlight-atom {
            color: #e74c3c;
        }
        
        .highlight-var {
            color: #f39c12;
        }
        
        .highlight-comment {
            color: #7f8c8d;
        }
        
        /* è¡¨æ ¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid var(--border-color);
        }
        
        th {
            background: rgba(52, 152, 219, 0.3);
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background: rgba(255,255,255,0.03);
        }
        
        /* æµç¨‹å›¾å®¹å™¨ */
        .flow-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .flow-step {
            display: flex;
            gap: 20px;
            align-items: stretch;
        }
        
        .flow-node {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
            border: 2px solid transparent;
        }
        
        .flow-node.active-n1 {
            border-color: var(--n1-color);
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.3);
        }
        
        .flow-node.active-n2 {
            border-color: var(--n2-color);
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.3);
        }
        
        .flow-node h4 {
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .flow-node.active-n1 h4 {
            color: var(--n1-color);
        }
        
        .flow-node.active-n2 h4 {
            color: var(--n2-color);
        }
        
        .data-box {
            background: var(--code-bg);
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.85em;
        }
        
        .data-label {
            color: #9b59b6;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        ul {
            margin-left: 20px;
        }
        
        li {
            margin: 8px 0;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .summary-card {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid;
        }
        
        .summary-card.n1 {
            border-left-color: var(--n1-color);
        }
        
        .summary-card.n2 {
            border-left-color: var(--n2-color);
        }
        
        .summary-card h4 {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— CRAQ Add Node è°ƒç”¨é“¾åˆ†æ</h1>
        <p class="subtitle">erlang_craq:add_node(N1, [N1, N2], [N1, N2, N3]) å®Œæ•´æ‰§è¡Œæµç¨‹</p>
        
        <!-- å‘½ä»¤è¯´æ˜ -->
        <div class="command-box">
            <div class="comment">%% å‰ç½®æ¡ä»¶ï¼šN2 å·²ç»é€šè¿‡ setup_repl åˆå§‹åŒ–</div>
            <div class="cmd">erlang_craq:setup_repl([N2]).</div>
            <br>
            <div class="comment">%% N1 è¯·æ±‚åŠ å…¥é›†ç¾¤ï¼Œä¼šåœ¨ N1 å’Œ N2 ä¹‹é—´äº§ç”Ÿäº¤äº’</div>
            <div class="cmd">erlang_craq:add_node(N1, [N1, N2], [N1, N2, N3]).</div>
            <br>
            <div class="comment">%% å‚æ•°è¯´æ˜ï¼š</div>
            <div class="comment">%% - N1 = 'ec_n1@rabbitmq4-1' (æ–°åŠ å…¥çš„èŠ‚ç‚¹)</div>
            <div class="comment">%% - [N1, N2] = å½“å‰å¤åˆ¶ç¯æˆå‘˜</div>
            <div class="comment">%% - [N1, N2, N3] = å®Œæ•´èŠ‚ç‚¹æ’åºåˆ—è¡¨</div>
        </div>
        
        <!-- æ•´ä½“æµç¨‹æ¦‚è§ˆ -->
        <div class="section">
            <h2>ğŸ“Š æ•´ä½“æµç¨‹æ—¶åºå›¾</h2>
            
            <div class="lifeline-header">
                <div class="lifeline-box lifeline-n1">
                    N1 (ec_n1@rabbitmq4-1)<br>
                    <small>æ–°èŠ‚ç‚¹ - è¯·æ±‚åŠ å…¥</small>
                </div>
                <div class="lifeline-box lifeline-n2">
                    N2 (ec_n2@rabbitmq4-2)<br>
                    <small>ç°æœ‰èŠ‚ç‚¹ - READYçŠ¶æ€</small>
                </div>
            </div>
            
            <div class="sequence-diagram">
                <!-- Step 1 -->
                <div class="message-row">
                    <span class="step-number">1</span>
                    <div class="arrow-container">
                        <div class="arrow-right">
                            <div class="arrow-line">
                                <span class="message-label">EH_ADD_NODE (å¹¿æ’­åˆ°æ‰€æœ‰èŠ‚ç‚¹)</span>
                            </div>
                            <span class="arrow-head-right"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2 -->
                <div class="message-row">
                    <span class="step-number">2</span>
                    <div class="arrow-container">
                        <div class="arrow-right">
                            <div class="arrow-line">
                                <span class="message-label">EH_SNAPSHOT {NodeId, NodeList, Ref, {Timestamp=0, Snapshot=[]}}</span>
                            </div>
                            <span class="arrow-head-right"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3 -->
                <div class="message-row">
                    <span class="step-number">3</span>
                    <div class="arrow-container">
                        <div class="arrow-left">
                            <span class="arrow-head-left"></span>
                            <div class="arrow-line">
                                <span class="message-label">EH_UPDATE_SNAPSHOT {Ref, Q0, PendingMap}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="state-change">
                <span class="node-tag n1">N1</span>
                <span class="state-box state-not-ready">NOT_READY</span>
                <span class="state-arrow">â†’</span>
                <span class="state-box state-transient">TRANSIENT</span>
                <span class="state-arrow">â†’</span>
                <span class="state-box state-ready">TRANSIENT_DU</span>
            </div>
            
            <div class="state-change">
                <span class="node-tag n2">N2</span>
                <span class="state-box state-ready">READY</span>
                <span class="state-arrow">â†’</span>
                <span class="state-box state-ready">READY (ä¿æŒ)</span>
            </div>
        </div>
        
        <!-- Phase 1: N1 å¤„ç† ADD_NODE -->
        <div class="section">
            <h2>ğŸ“ Phase 1: N1 å¤„ç† EH_ADD_NODE</h2>
            <p><span class="node-tag n1">N1</span> æ”¶åˆ°å¹¿æ’­æ¶ˆæ¯ï¼Œåˆ¤æ–­è‡ªå·±æ˜¯æ–°èŠ‚ç‚¹ï¼Œå‘èµ·å¿«ç…§è¯·æ±‚</p>
            
            <h3>è°ƒç”¨é“¾</h3>
            <div class="call-chain">
                <div class="call-item">
                    <span class="timestamp">1:23:58.643</span>
                    <span class="process">&lt;0.216.0&gt;</span>
                    <span class="function"><span class="module">erlang_craq</span>:add_node(N1, [N1,N2], [N1,N2,N3])</span>
                </div>
                <div class="call-item indent-1">
                    <span class="timestamp">1:23:58.645</span>
                    <span class="process">&lt;0.263.0&gt;</span>
                    <span class="function"><span class="module">eh_system_server</span>:handle_cast({eh_add_node, ...})</span>
                </div>
                <div class="call-item indent-2">
                    <span class="timestamp">1:23:58.646</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_system_config</span>:get_failure_detector/1</span>
                    <span class="arrow">â†’</span>
                    <span class="return">eh_failure_detector_api</span>
                </div>
                <div class="call-item indent-2">
                    <span class="timestamp">1:23:58.647</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_system_config</span>:get_node_order/1</span>
                    <span class="arrow">â†’</span>
                    <span class="return">sorted</span>
                </div>
                <div class="call-item indent-2">
                    <span class="timestamp">1:23:58.648</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_system_config</span>:get_node_id/1</span>
                    <span class="arrow">â†’</span>
                    <span class="return">'ec_n1@rabbitmq4-1'</span>
                </div>
                <div class="call-item indent-2">
                    <span class="timestamp">1:23:58.648</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_repl_ring</span>:get_ordered_list_pred_succ/4</span>
                    <span class="arrow">â†’</span>
                    <span class="return">{[N1,N2], [N1,N2,N3], Pred=N2, Succ=N2}</span>
                </div>
                <div class="call-item indent-2">
                    <span class="timestamp">1:23:58.653</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_node_timestamp</span>:valid_add_node_msg/2</span>
                    <span class="arrow">â†’</span>
                    <span class="return" style="color:#e74c3c;font-weight:bold;">eh_valid_for_new</span>
                </div>
                <div class="call-item indent-3">
                    <span class="timestamp">1:23:58.654</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_node_state</span>:msg_state/1</span>
                    <span class="arrow">â†’</span>
                    <span class="return">eh_not_ready</span>
                </div>
                <div class="call-item indent-2">
                    <span class="timestamp">1:23:58.654</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_system_server</span>:process_snapshot_request/4</span>
                </div>
                <div class="call-item indent-3">
                    <span class="timestamp">1:23:58.655</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_unique_id_generator_api</span>:unique_id/0</span>
                    <span class="arrow">â†’</span>
                    <span class="return">#Ref&lt;...135214&gt;</span>
                </div>
                <div class="call-item indent-3">
                    <span class="timestamp">1:23:58.655</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_repl_data_manager_api</span>:timestamp/0</span>
                    <span class="arrow">â†’</span>
                    <span class="return">{0, []}</span>
                </div>
                <div class="call-item indent-4">
                    <span class="timestamp">1:23:58.655</span>
                    <span class="process">&lt;0.262.0&gt;</span>
                    <span class="function"><span class="module">eh_data_server</span>:handle_call(eh_timestamp, ...)</span>
                    <span class="arrow">â†’</span>
                    <span class="return">{0, []}</span>
                </div>
                <div class="call-item indent-3">
                    <span class="timestamp">1:23:58.656</span>
                    <span class="process"></span>
                    <span class="function" style="color:#2ecc71;font-weight:bold;">gen_server:cast({eh_system_server, N2}, {eh_snapshot, ...})</span>
                </div>
                <div class="call-item indent-2">
                    <span class="timestamp">1:23:58.657</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_failure_detector_api</span>:set(N1, [N1, N2])</span>
                </div>
                <div class="call-item indent-2">
                    <span class="timestamp">1:23:58.658</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_node_state</span>:update_state_transient/1</span>
                </div>
                <div class="call-item indent-3">
                    <span class="timestamp">1:23:58.659</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_node_state</span>:update_state(eh_transient, State)</span>
                    <span class="arrow">â†’</span>
                    <span class="return">State#eh_system_state{node_status=eh_transient}</span>
                </div>
                <div class="call-item indent-2">
                    <span class="timestamp">1:23:58.660</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_system_server</span>:event_state("add_node.99", ...)</span>
                </div>
            </div>
            
            <h3>å…³é”®åˆ¤æ–­é€»è¾‘</h3>
            <pre><code><span class="highlight-comment">%% valid_add_node_msg åˆ¤æ–­é€»è¾‘</span>
<span class="highlight-func">valid_add_node_msg</span>(<span class="highlight-var">Node</span>, <span class="highlight-var">State</span>) ->
  <span class="highlight-var">MsgState</span> = <span class="highlight-func">eh_node_state:msg_state</span>(<span class="highlight-var">State</span>),  <span class="highlight-comment">%% è¿”å› eh_not_ready</span>
  <span class="highlight-var">NodeId</span> = <span class="highlight-func">eh_system_config:get_node_id</span>(...),  <span class="highlight-comment">%% è¿”å› ec_n1</span>
  
  <span class="highlight-comment">%% Node = ec_n1, NodeId = ec_n1, MsgState = eh_not_ready</span>
  <span class="highlight-comment">%% æ¡ä»¶åŒ¹é…: Node =:= NodeId andalso MsgState =:= ?EH_NOT_READY</span>
  <span class="highlight-comment">%% è¿”å›: eh_valid_for_new (æœ¬èŠ‚ç‚¹æ˜¯æ–°åŠ å…¥çš„èŠ‚ç‚¹)</span></code></pre>
        </div>
        
        <!-- Phase 2: N2 å¤„ç† ADD_NODE -->
        <div class="section">
            <h2>ğŸ“ Phase 2: N2 å¤„ç† EH_ADD_NODE</h2>
            <p><span class="node-tag n2">N2</span> æ”¶åˆ°å¹¿æ’­æ¶ˆæ¯ï¼Œåˆ¤æ–­æœ‰æ–°èŠ‚ç‚¹åŠ å…¥ï¼Œæ›´æ–°å¤åˆ¶ç¯</p>
            
            <h3>è°ƒç”¨é“¾</h3>
            <div class="call-chain">
                <div class="call-item">
                    <span class="timestamp">1:23:58.520</span>
                    <span class="process">&lt;0.264.0&gt;</span>
                    <span class="function"><span class="module">eh_system_server</span>:handle_cast({eh_add_node, ...})</span>
                </div>
                <div class="call-item indent-1">
                    <span class="timestamp">1:23:58.524</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_system_config</span>:get_failure_detector/1</span>
                </div>
                <div class="call-item indent-1">
                    <span class="timestamp">1:23:58.526</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_system_config</span>:get_node_id/1</span>
                    <span class="arrow">â†’</span>
                    <span class="return">'ec_n2@rabbitmq4-2'</span>
                </div>
                <div class="call-item indent-1">
                    <span class="timestamp">1:23:58.527</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_repl_ring</span>:get_ordered_list_pred_succ/4</span>
                    <span class="arrow">â†’</span>
                    <span class="return">{[N1,N2], [N1,N2,N3], Pred=N1, Succ=N1}</span>
                </div>
                <div class="call-item indent-1">
                    <span class="timestamp"></span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_node_timestamp</span>:valid_add_node_msg/2</span>
                    <span class="arrow">â†’</span>
                    <span class="return" style="color:#2ecc71;font-weight:bold;">eh_valid_for_existing</span>
                </div>
                <div class="call-item indent-1">
                    <span class="timestamp"></span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_failure_detector_api</span>:set(N1)</span>
                </div>
                <div class="call-item indent-1">
                    <span class="timestamp"></span>
                    <span class="process"></span>
                    <span class="function">æ›´æ–° State: repl_ring=[N1,N2], pred=N1, succ=N1</span>
                </div>
            </div>
            
            <h3>N2 çŠ¶æ€å˜åŒ–</h3>
            <table>
                <tr>
                    <th>å­—æ®µ</th>
                    <th>å˜æ›´å‰</th>
                    <th>å˜æ›´å</th>
                </tr>
                <tr>
                    <td>node_status</td>
                    <td>eh_ready</td>
                    <td>eh_ready (ä¸å˜)</td>
                </tr>
                <tr>
                    <td>repl_ring</td>
                    <td>[ec_n2]</td>
                    <td>[ec_n1, ec_n2]</td>
                </tr>
                <tr>
                    <td>predecessor</td>
                    <td>undefined</td>
                    <td>ec_n1</td>
                </tr>
                <tr>
                    <td>successor</td>
                    <td>undefined</td>
                    <td>ec_n1</td>
                </tr>
            </table>
        </div>
        
        <!-- Phase 3: N2 å¤„ç† SNAPSHOT è¯·æ±‚ -->
        <div class="section">
            <h2>ğŸ“ Phase 3: N2 å¤„ç† EH_SNAPSHOT è¯·æ±‚</h2>
            <p><span class="node-tag n2">N2</span> æ”¶åˆ° N1 çš„å¿«ç…§è¯·æ±‚ï¼Œç”Ÿæˆå¿«ç…§æ•°æ®å¹¶è¿”å›</p>
            
            <h3>è°ƒç”¨é“¾</h3>
            <div class="call-chain">
                <div class="call-item">
                    <span class="timestamp">1:23:58.560</span>
                    <span class="process">&lt;0.264.0&gt;</span>
                    <span class="function"><span class="module">eh_system_server</span>:handle_cast({eh_snapshot, {N1, [N1,N2], [N1,N2,N3], Ref, {0,[]}}})</span>
                </div>
                <div class="call-item indent-1">
                    <span class="timestamp">1:23:58.560</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_system_config</span>:get_node_id/1</span>
                    <span class="arrow">â†’</span>
                    <span class="return">'ec_n2@rabbitmq4-2'</span>
                </div>
                <div class="call-item indent-1">
                    <span class="timestamp">1:23:58.561</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_repl_ring</span>:get_ordered_list_pred_succ/4</span>
                </div>
                <div class="call-item indent-1">
                    <span class="timestamp">1:23:58.563</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_repl_data_manager_api</span>:snapshot(0, [])</span>
                </div>
                <div class="call-item indent-2">
                    <span class="timestamp">1:23:58.533</span>
                    <span class="process">&lt;0.262.0&gt;</span>
                    <span class="function"><span class="module">eh_data_server</span>:handle_call({eh_snapshot, {0, []}})</span>
                </div>
                <div class="call-item indent-3">
                    <span class="timestamp">1:23:58.535</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_data_util</span>:snapshot_data(0, [], DataMap)</span>
                </div>
                <div class="call-item indent-4">
                    <span class="timestamp">1:23:58.536</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_data_util</span>:process_data/5 (éå† candidate:10)</span>
                </div>
                <div class="call-item indent-4">
                    <span class="timestamp">1:23:58.541</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_data_util</span>:process_data/5 (éå† person:10)</span>
                </div>
                <div class="call-item indent-1">
                    <span class="timestamp">1:23:58.563</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_update_msg</span>:filter_effective_head_node_id(#{}, State)</span>
                    <span class="arrow">â†’</span>
                    <span class="return">#{}</span>
                </div>
                <div class="call-item indent-1">
                    <span class="timestamp">1:23:58.564</span>
                    <span class="process"></span>
                    <span class="function" style="color:#2ecc71;font-weight:bold;">gen_server:cast({eh_system_server, N1}, {eh_update_snapshot, {Ref, Q0, #{}}})</span>
                </div>
            </div>
            
            <h3>å¿«ç…§æ•°æ®ç”Ÿæˆè¿‡ç¨‹</h3>
            <div class="data-box">
                <div class="data-label">è¾“å…¥å‚æ•°:</div>
                <code>Timestamp = 0, Snapshot = []</code>
                <br><br>
                <div class="data-label">N2 å½“å‰æ•°æ® (DataMap):</div>
<pre>{eh_storage_key, candidate, 10} => 
    {[{eh_storage_value,6,1,0,undefined,undefined},
      {eh_storage_value,4,2,1,party,republican}],
     [{eh_storage_value,4,1,1,name,donald_trump}]}

{eh_storage_key, person, 10} => 
    {[{eh_storage_value,5,1,0,gender,undefined},
      {eh_storage_value,4,2,1,age,40},
      ...],
     [{eh_storage_value,1,1,1,name,john}]}</pre>
            </div>
            
            <div class="data-box">
                <div class="data-label">ç”Ÿæˆçš„å¿«ç…§ Q0 (queue):</div>
<pre>å‰ç«¯ (Rear):
  {eh_storage_data,candidate,10,6,1,0,undefined,undefined}
  {eh_storage_data,person,10,5,1,0,gender,undefined}
  {eh_storage_data,candidate,10,4,2,1,party,republican}
  {eh_storage_data,person,10,4,2,1,age,40}
  {eh_storage_data,candidate,10,4,1,1,name,donald_trump}
  {eh_storage_data,person,10,4,1,1,name,john_smith}

åç«¯ (Front):
  {eh_storage_data,person,10,1,1,1,name,john}
  {eh_storage_data,person,10,1,2,1,age,30}
  {eh_storage_data,person,10,1,3,1,gender,male}
  {eh_storage_data,person,10,2,1,1,age,40}
  {eh_storage_data,person,10,3,1,1,name,john_smith}
  {eh_storage_data,person,10,3,2,0,age,undefined}</pre>
            </div>
        </div>
        
        <!-- Phase 4: N1 å¤„ç† UPDATE_SNAPSHOT -->
        <div class="section">
            <h2>ğŸ“ Phase 4: N1 å¤„ç† EH_UPDATE_SNAPSHOT</h2>
            <p><span class="node-tag n1">N1</span> æ”¶åˆ°å¿«ç…§æ•°æ®ï¼Œåˆå¹¶åˆ°æœ¬åœ°å­˜å‚¨</p>
            
            <h3>è°ƒç”¨é“¾</h3>
            <div class="call-chain">
                <div class="call-item">
                    <span class="timestamp">1:23:58.671</span>
                    <span class="process">&lt;0.263.0&gt;</span>
                    <span class="function"><span class="module">eh_system_server</span>:handle_cast({eh_update_snapshot, {Ref, Q0, #{}}})</span>
                </div>
                <div class="call-item indent-1">
                    <span class="timestamp">1:23:58.671</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_system_config</span>:get_repl_data_manager/1</span>
                </div>
                <div class="call-item indent-1">
                    <span class="timestamp">1:23:58.672</span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_repl_data_manager_api</span>:update_snapshot(Q0)</span>
                </div>
                <div class="call-item indent-2">
                    <span class="timestamp">1:23:58.672</span>
                    <span class="process">&lt;0.262.0&gt;</span>
                    <span class="function"><span class="module">eh_data_server</span>:handle_call({eh_update_snapshot, Q0})</span>
                </div>
                <div class="call-item indent-3">
                    <span class="timestamp"></span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_data_util</span>:merge_data(Q0, DataMap)</span>
                </div>
                <div class="call-item indent-1">
                    <span class="timestamp"></span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_node_state</span>:update_state_snapshot/1</span>
                </div>
                <div class="call-item indent-2">
                    <span class="timestamp"></span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_node_state</span>:update_state(eh_transient_du, State)</span>
                </div>
                <div class="call-item indent-1">
                    <span class="timestamp"></span>
                    <span class="process"></span>
                    <span class="function"><span class="module">eh_system_server</span>:event_state("update_snapshot.99", ...)</span>
                </div>
            </div>
            
            <h3>çŠ¶æ€è½¬æ¢</h3>
            <div class="state-change">
                <span class="node-tag n1">N1</span>
                <span class="state-box state-transient">TRANSIENT</span>
                <span class="state-arrow">â†’</span>
                <span class="state-box" style="background:#9b59b6;">TRANSIENT_DU</span>
                <span style="margin-left:20px;color:#888;">(Data Updated - æ•°æ®å·²æ›´æ–°ï¼Œç­‰å¾…æ¶ˆæ¯ç¡®è®¤)</span>
            </div>
        </div>
        
        <!-- å®Œæ•´å‡½æ•°è°ƒç”¨å…³ç³»å›¾ -->
        <div class="section">
            <h2>ğŸ”€ å®Œæ•´å‡½æ•°è°ƒç”¨å…³ç³»</h2>
            
            <h3>å…¥å£å‡½æ•°</h3>
            <pre><code><span class="highlight-func">erlang_craq:add_node</span>(<span class="highlight-var">Node</span>, <span class="highlight-var">NodeList</span>, <span class="highlight-var">NodeOrderList</span>) ->
    <span class="highlight-func">gen_server:abcast</span>(<span class="highlight-var">NodeList</span>, ?EH_SYSTEM_SERVER, 
                      {?EH_ADD_NODE, {<span class="highlight-var">Node</span>, <span class="highlight-var">NodeList</span>, <span class="highlight-var">NodeOrderList</span>}}).</code></pre>
            
            <h3>eh_system_server æ¶ˆæ¯å¤„ç†</h3>
            <table>
                <tr>
                    <th>æ¶ˆæ¯ç±»å‹</th>
                    <th>å¤„ç†å‡½æ•°</th>
                    <th>è§¦å‘æ¡ä»¶</th>
                </tr>
                <tr>
                    <td><code>EH_ADD_NODE</code></td>
                    <td>handle_cast/2</td>
                    <td>å¹¿æ’­åˆ°æ‰€æœ‰èŠ‚ç‚¹</td>
                </tr>
                <tr>
                    <td><code>EH_SNAPSHOT</code></td>
                    <td>handle_cast/2</td>
                    <td>æ–°èŠ‚ç‚¹å‘åç»§å‘é€</td>
                </tr>
                <tr>
                    <td><code>EH_UPDATE_SNAPSHOT</code></td>
                    <td>handle_cast/2</td>
                    <td>åç»§å‘æ–°èŠ‚ç‚¹è¿”å›æ•°æ®</td>
                </tr>
            </table>
            
            <h3>æ ¸å¿ƒå‡½æ•°ä¾èµ–å›¾</h3>
            <pre style="font-size:0.8em;line-height:1.8;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           erlang_craq:add_node/3                                â”‚
â”‚                                    â”‚                                            â”‚
â”‚                    gen_server:abcast â†’ EH_ADD_NODE                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼                                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      N1: handle_cast        â”‚                 â”‚      N2: handle_cast        â”‚
â”‚      (EH_ADD_NODE)          â”‚                 â”‚      (EH_ADD_NODE)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”œâ”€ get_failure_detector     â”‚                 â”‚ â”œâ”€ get_failure_detector     â”‚
â”‚ â”œâ”€ get_node_order           â”‚                 â”‚ â”œâ”€ get_node_order           â”‚
â”‚ â”œâ”€ get_node_id              â”‚                 â”‚ â”œâ”€ get_node_id              â”‚
â”‚ â”œâ”€ get_ordered_list_pred_   â”‚                 â”‚ â”œâ”€ get_ordered_list_pred_   â”‚
â”‚ â”‚   succ                    â”‚                 â”‚ â”‚   succ                    â”‚
â”‚ â”œâ”€ valid_add_node_msg       â”‚                 â”‚ â”œâ”€ valid_add_node_msg       â”‚
â”‚ â”‚   â†’ eh_valid_for_new      â”‚                 â”‚ â”‚   â†’ eh_valid_for_existing â”‚
â”‚ â”œâ”€ process_snapshot_request â”‚                 â”‚ â””â”€ failure_detector:set     â”‚
â”‚ â”‚   â”œâ”€ unique_id            â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”‚   â”œâ”€ timestamp            â”‚
â”‚ â”‚   â””â”€ cast(N2, EH_SNAPSHOT)â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”œâ”€ failure_detector:set     â”‚                         â”‚
â”‚ â””â”€ update_state_transient   â”‚                         â–¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–²                                    â”‚      N2: handle_cast        â”‚
           â”‚                                    â”‚      (EH_SNAPSHOT)          â”‚
           â”‚                                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚                                    â”‚ â”œâ”€ get_node_id              â”‚
           â”‚                                    â”‚ â”œâ”€ get_ordered_list_pred_   â”‚
           â”‚                                    â”‚ â”‚   succ                    â”‚
           â”‚                                    â”‚ â”œâ”€ repl_data_manager:       â”‚
           â”‚                                    â”‚ â”‚   snapshot                â”‚
           â”‚                                    â”‚ â”‚   â”œâ”€ eh_data_server:      â”‚
           â”‚                                    â”‚ â”‚   â”‚   handle_call         â”‚
           â”‚                                    â”‚ â”‚   â””â”€ snapshot_data        â”‚
           â”‚                                    â”‚ â”œâ”€ filter_effective_head_   â”‚
           â”‚                                    â”‚ â”‚   node_id                 â”‚
           â”‚                                    â”‚ â””â”€ cast(N1, EH_UPDATE_      â”‚
           â”‚                                    â”‚       SNAPSHOT)             â”‚
           â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                                   â”‚
           â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      N1: handle_cast                        â”‚
â”‚      (EH_UPDATE_SNAPSHOT)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”œâ”€ get_repl_data_manager                    â”‚
â”‚ â”œâ”€ repl_data_manager:update_snapshot        â”‚
â”‚ â”‚   â””â”€ eh_data_server:handle_call           â”‚
â”‚ â”‚       â””â”€ merge_data                       â”‚
â”‚ â”œâ”€ update_state_snapshot                    â”‚
â”‚ â”‚   â””â”€ update_state(eh_transient_du)        â”‚
â”‚ â””â”€ event_state("update_snapshot.99")        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre>
        </div>
        
        <!-- æ•°æ®æµæ€»ç»“ -->
        <div class="section">
            <h2>ğŸ“‹ æ•°æ®æµæ€»ç»“</h2>
            
            <div class="summary-grid">
                <div class="summary-card n1">
                    <h4>ğŸ”µ N1 (æ–°èŠ‚ç‚¹) çŠ¶æ€å˜åŒ–</h4>
                    <ul>
                        <li><strong>åˆå§‹çŠ¶æ€:</strong> NOT_READY, timestamp=0</li>
                        <li><strong>æ”¶åˆ° ADD_NODE:</strong> â†’ TRANSIENT</li>
                        <li><strong>æ”¶åˆ° UPDATE_SNAPSHOT:</strong> â†’ TRANSIENT_DU</li>
                        <li><strong>æœ€ç»ˆ:</strong> ç­‰å¾… UPDATE_MSG å®Œæˆå â†’ READY</li>
                    </ul>
                </div>
                
                <div class="summary-card n2">
                    <h4>ğŸ”´ N2 (ç°æœ‰èŠ‚ç‚¹) çŠ¶æ€å˜åŒ–</h4>
                    <ul>
                        <li><strong>åˆå§‹çŠ¶æ€:</strong> READY, timestamp=6</li>
                        <li><strong>æ”¶åˆ° ADD_NODE:</strong> æ›´æ–° repl_ring</li>
                        <li><strong>æ”¶åˆ° SNAPSHOT:</strong> ç”Ÿæˆå¹¶å‘é€å¿«ç…§</li>
                        <li><strong>æœ€ç»ˆ:</strong> READY (ä¿æŒä¸å˜)</li>
                    </ul>
                </div>
            </div>
            
            <h3>æ—¶é—´çº¿</h3>
            <table>
                <tr>
                    <th>æ—¶é—´æˆ³</th>
                    <th>èŠ‚ç‚¹</th>
                    <th>äº‹ä»¶</th>
                </tr>
                <tr>
                    <td>1:23:58.520</td>
                    <td><span class="node-tag n2">N2</span></td>
                    <td>æ”¶åˆ° EH_ADD_NODEï¼Œæ›´æ–° repl_ring</td>
                </tr>
                <tr>
                    <td>1:23:58.533</td>
                    <td><span class="node-tag n2">N2</span></td>
                    <td>eh_data_server å¼€å§‹ç”Ÿæˆå¿«ç…§</td>
                </tr>
                <tr>
                    <td>1:23:58.560</td>
                    <td><span class="node-tag n2">N2</span></td>
                    <td>æ”¶åˆ° EH_SNAPSHOTï¼Œå¤„ç†å¿«ç…§è¯·æ±‚</td>
                </tr>
                <tr>
                    <td>1:23:58.564</td>
                    <td><span class="node-tag n2">N2</span></td>
                    <td>å‘é€ EH_UPDATE_SNAPSHOT ç»™ N1</td>
                </tr>
                <tr>
                    <td>1:23:58.643</td>
                    <td><span class="node-tag n1">N1</span></td>
                    <td>ç”¨æˆ·è°ƒç”¨ add_node</td>
                </tr>
                <tr>
                    <td>1:23:58.645</td>
                    <td><span class="node-tag n1">N1</span></td>
                    <td>æ”¶åˆ° EH_ADD_NODE (è‡ªå·±å¹¿æ’­çš„)</td>
                </tr>
                <tr>
                    <td>1:23:58.656</td>
                    <td><span class="node-tag n1">N1</span></td>
                    <td>å‘é€ EH_SNAPSHOT ç»™ N2</td>
                </tr>
                <tr>
                    <td>1:23:58.658</td>
                    <td><span class="node-tag n1">N1</span></td>
                    <td>çŠ¶æ€å˜ä¸º TRANSIENT</td>
                </tr>
                <tr>
                    <td>1:23:58.671</td>
                    <td><span class="node-tag n1">N1</span></td>
                    <td>æ”¶åˆ° EH_UPDATE_SNAPSHOTï¼Œåˆå¹¶æ•°æ®</td>
                </tr>
                <tr>
                    <td>1:23:58.672</td>
                    <td><span class="node-tag n1">N1</span></td>
                    <td>çŠ¶æ€å˜ä¸º TRANSIENT_DU</td>
                </tr>
            </table>
            
            <h3>å…³é”®æ•°æ®ç»“æ„</h3>
            <pre><code><span class="highlight-comment">%% EH_SNAPSHOT æ¶ˆæ¯æ ¼å¼</span>
{eh_snapshot, {
    <span class="highlight-var">Node</span>,           <span class="highlight-comment">%% è¯·æ±‚èŠ‚ç‚¹ ID: 'ec_n1@rabbitmq4-1'</span>
    <span class="highlight-var">NodeList</span>,       <span class="highlight-comment">%% å¤åˆ¶ç¯: ['ec_n1@...', 'ec_n2@...']</span>
    <span class="highlight-var">NodeOrderList</span>,  <span class="highlight-comment">%% æ’åºåˆ—è¡¨: ['ec_n1@...', 'ec_n2@...', 'ec_n3@...']</span>
    <span class="highlight-var">Ref</span>,            <span class="highlight-comment">%% å”¯ä¸€å¼•ç”¨: #Ref<...></span>
    {<span class="highlight-var">Timestamp</span>, <span class="highlight-var">Snapshot</span>}  <span class="highlight-comment">%% {0, []} - è¯·æ±‚èŠ‚ç‚¹çš„å½“å‰æ—¶é—´æˆ³å’Œæ•°æ®ç´¢å¼•</span>
}}

<span class="highlight-comment">%% EH_UPDATE_SNAPSHOT æ¶ˆæ¯æ ¼å¼</span>
{eh_update_snapshot, {
    <span class="highlight-var">Ref</span>,            <span class="highlight-comment">%% å¯¹åº”è¯·æ±‚çš„å¼•ç”¨</span>
    <span class="highlight-var">Q0</span>,             <span class="highlight-comment">%% å¿«ç…§æ•°æ®é˜Ÿåˆ— (queue)</span>
    <span class="highlight-var">PendingPreMsgMap</span> <span class="highlight-comment">%% å¾…å¤„ç†æ¶ˆæ¯ Map: #{}</span>
}}

<span class="highlight-comment">%% eh_storage_data è®°å½•æ ¼å¼</span>
{eh_storage_data, 
    <span class="highlight-var">ObjectType</span>,     <span class="highlight-comment">%% candidate | person</span>
    <span class="highlight-var">ObjectId</span>,       <span class="highlight-comment">%% 10</span>
    <span class="highlight-var">Timestamp</span>,      <span class="highlight-comment">%% æ—¶é—´æˆ³</span>
    <span class="highlight-var">DataIndex</span>,      <span class="highlight-comment">%% æ•°æ®ç´¢å¼•</span>
    <span class="highlight-var">Status</span>,         <span class="highlight-comment">%% 0=åˆ é™¤, 1=æœ‰æ•ˆ</span>
    <span class="highlight-var">Column</span>,         <span class="highlight-comment">%% name | age | party | gender</span>
    <span class="highlight-var">Value</span>           <span class="highlight-comment">%% å…·ä½“å€¼</span>
}</code></pre>
        </div>
        
        <!-- æ—¥å¿—è¾“å‡º -->
        <div class="section">
            <h2>ğŸ“ å…³é”®æ—¥å¿—è¾“å‡º</h2>
            
            <div class="data-box">
                <div class="data-label">N1 - add_node.99:</div>
                <code style="color:#f39c12;">[eh_system_server] "add_node.99" node_status="transient", node_id="ec_n1", repl_ring="ec_n1,ec_n2", pred="ec_n2", succ="ec_n2", timestamp=0</code>
            </div>
            
            <div class="data-box">
                <div class="data-label">N2 - snapshot.99:</div>
                <code style="color:#f39c12;">[eh_system_server] "snapshot.99" node_status="ready", node_id="ec_n2", repl_ring="ec_n1,ec_n2", pred="ec_n1", succ="ec_n1", timestamp=6</code>
            </div>
            
            <div class="data-box">
                <div class="data-label">N1 - update_snapshot.99:</div>
                <code style="color:#f39c12;">[eh_system_server] "update_snapshot.99" node_status="transient_data_updated", node_id="ec_n1", repl_ring="ec_n1,ec_n2", pred="ec_n2", succ="ec_n2", timestamp=0</code>
            </div>
        </div>
        
        <footer style="text-align:center;margin-top:40px;padding:20px;color:#666;border-top:1px solid var(--border-color);">
            <p>Generated from trace_log.add_node.node1.txt & trace_log.add_node.node2.txt</p>
            <p>CRAQ (Chain Replication with Apportioned Queries) - Erlang Implementation</p>
        </footer>
    </div>
</body>
</html>
