<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAQ add_node å¿«ç…§åŒæ­¥å®Œæ•´æµç¨‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e4e4e4;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #00d9ff;
            margin-bottom: 30px;
            font-size: 2.2em;
            text-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
        }
        
        h2 {
            color: #ffd700;
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffd700;
        }
        
        h3 {
            color: #00ff88;
            margin: 20px 0 10px 0;
        }
        
        /* æµç¨‹å›¾å®¹å™¨ */
        .flow-diagram {
            background: #0d1117;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            border: 1px solid #30363d;
            overflow-x: auto;
        }
        
        .flow-title {
            text-align: center;
            color: #58a6ff;
            font-size: 1.3em;
            margin-bottom: 20px;
        }
        
        /* ASCII æµç¨‹å›¾ */
        .ascii-flow {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre;
            color: #c9d1d9;
            background: #161b22;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
        }
        
        .ascii-flow .node-n1 { color: #58a6ff; }
        .ascii-flow .node-n2 { color: #f0883e; }
        .ascii-flow .server { color: #a371f7; }
        .ascii-flow .msg { color: #7ee787; }
        .ascii-flow .state { color: #ffd700; }
        .ascii-flow .data { color: #ff7b72; }
        .ascii-flow .comment { color: #8b949e; }
        
        /* æ­¥éª¤å¡ç‰‡ */
        .step-card {
            background: linear-gradient(145deg, #1e2a3a, #162030);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #00d9ff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .step-number {
            background: linear-gradient(135deg, #00d9ff, #0099cc);
            color: #000;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            font-size: 1.1em;
        }
        
        .step-title {
            font-size: 1.2em;
            color: #00d9ff;
        }
        
        .step-location {
            color: #8b949e;
            font-size: 0.9em;
            margin-left: auto;
        }
        
        /* ä»£ç å— */
        .code-block {
            background: #0d1117;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            overflow-x: auto;
            border: 1px solid #30363d;
        }
        
        .code-block .keyword { color: #ff7b72; }
        .code-block .function { color: #d2a8ff; }
        .code-block .variable { color: #ffa657; }
        .code-block .atom { color: #79c0ff; }
        .code-block .string { color: #a5d6ff; }
        .code-block .comment { color: #8b949e; }
        .code-block .macro { color: #7ee787; }
        
        /* æ¶ˆæ¯æµ */
        .message-flow {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: #21262d;
            border-radius: 8px;
        }
        
        .msg-from, .msg-to {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            min-width: 120px;
            text-align: center;
        }
        
        .msg-from { background: #1f6feb; }
        .msg-to { background: #f0883e; }
        
        .msg-arrow {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 20px;
        }
        
        .msg-name {
            color: #7ee787;
            font-family: monospace;
            font-size: 0.95em;
            margin-bottom: 5px;
        }
        
        .msg-line {
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #1f6feb, #7ee787, #f0883e);
            position: relative;
        }
        
        .msg-line::after {
            content: 'â–¶';
            position: absolute;
            right: -5px;
            top: -8px;
            color: #f0883e;
        }
        
        /* è¡¨æ ¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: #161b22;
            border-radius: 8px;
            overflow: hidden;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #30363d;
        }
        
        th {
            background: #21262d;
            color: #58a6ff;
            font-weight: 600;
        }
        
        tr:hover {
            background: #1c2128;
        }
        
        /* çŠ¶æ€è½¬æ¢ */
        .state-transition {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            padding: 20px;
            background: #21262d;
            border-radius: 10px;
        }
        
        .state-box {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
        }
        
        .state-not-ready { background: #da3633; }
        .state-transient { background: #9e6a03; }
        .state-transient-du { background: #1f6feb; }
        .state-ready { background: #238636; }
        
        .state-arrow {
            color: #7ee787;
            font-size: 1.5em;
        }
        
        /* è¿›ç¨‹æ¡† */
        .process-box {
            border: 2px solid #30363d;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .process-header {
            background: #21262d;
            padding: 10px 15px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .process-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .process-n1 .process-icon { background: #1f6feb; }
        .process-n2 .process-icon { background: #f0883e; }
        .process-data .process-icon { background: #a371f7; }
        
        .process-content {
            padding: 15px;
        }
        
        /* é«˜äº® */
        .highlight {
            background: rgba(255, 215, 0, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            color: #ffd700;
        }
        
        .highlight-blue {
            background: rgba(31, 111, 235, 0.2);
            color: #58a6ff;
        }
        
        .highlight-green {
            background: rgba(35, 134, 54, 0.2);
            color: #7ee787;
        }
        
        /* æ³¨æ„äº‹é¡¹ */
        .note {
            background: linear-gradient(145deg, #2d1f1f, #1f1515);
            border-left: 4px solid #f85149;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .note-title {
            color: #f85149;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        /* æ€»ç»“æ¡† */
        .summary-box {
            background: linear-gradient(145deg, #1a2f1a, #152015);
            border: 1px solid #238636;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .summary-title {
            color: #7ee787;
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ CRAQ add_node å¿«ç…§åŒæ­¥å®Œæ•´æµç¨‹</h1>
        
        <!-- åœºæ™¯è¯´æ˜ -->
        <div class="step-card">
            <h3>ğŸ“‹ åœºæ™¯è¯´æ˜</h3>
            <p>N1ï¼ˆæ–°èŠ‚ç‚¹ï¼Œæ— æ•°æ®ï¼‰åŠ å…¥é›†ç¾¤ï¼Œä» N2ï¼ˆåç»§èŠ‚ç‚¹ï¼Œæœ‰æ•°æ®ï¼‰åŒæ­¥æ•°æ®ã€‚</p>
            <table>
                <tr>
                    <th>èŠ‚ç‚¹</th>
                    <th>è§’è‰²</th>
                    <th>åˆå§‹çŠ¶æ€</th>
                    <th>æ•°æ®</th>
                </tr>
                <tr>
                    <td><span class="highlight-blue">N1</span></td>
                    <td>æ–°èŠ‚ç‚¹ï¼ˆè¯·æ±‚æ–¹ï¼‰</td>
                    <td>NOT_READY</td>
                    <td>Timestamp=0, æ— æ•°æ®</td>
                </tr>
                <tr>
                    <td><span class="highlight">N2</span></td>
                    <td>åç»§èŠ‚ç‚¹ï¼ˆæ•°æ®æºï¼‰</td>
                    <td>READY</td>
                    <td>Timestamp=6, æœ‰æ•°æ®</td>
                </tr>
            </table>
        </div>

        <!-- å®Œæ•´æµç¨‹å›¾ -->
        <h2>ğŸ“Š å®Œæ•´æ—¶åºæµç¨‹å›¾</h2>
        <div class="flow-diagram">
            <div class="ascii-flow">
<span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="comment">â”‚                              add_node å¿«ç…§åŒæ­¥å®Œæ•´æµç¨‹                                                            â”‚</span>
<span class="comment">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="comment">â”‚                                                                                                                 â”‚</span>
<span class="comment">â”‚</span>   <span class="node-n1">N1 (eh_system_server)</span>              <span class="server">N1 (eh_data_server)</span>              <span class="node-n2">N2 (eh_system_server)</span>              <span class="server">N2 (eh_data_server)</span>   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>   <span class="state">[NOT_READY]</span>                                                        <span class="state">[READY]</span>                                                 <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚</span>  <span class="msg">â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>  <span class="comment">â”‚</span>
<span class="comment">â”‚</span>  <span class="msg">æ­¥éª¤1</span>   â”‚ <span class="data">add_node(N1, [N1,N2], ...)</span>       â”‚                              â”‚                                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚</span>  <span class="msg">â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>  <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚</span> <span class="function">valid_add_node_msg(N1, State)</span>     â”‚                              â”‚                                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚</span> â†’ <span class="state">EH_VALID_FOR_NEW</span>                â”‚                              â”‚                                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚â”€â”€â”</span> <span class="function">process_snapshot_request()</span>     â”‚                              â”‚                                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚  â”‚                                 â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚  â”‚</span> <span class="variable">SnapshotRef</span> = unique_id()       â”‚                              â”‚                                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚  â”‚                                 â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚</span>â—„â”€â”˜                                â”‚                              â”‚                                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€</span><span class="msg">EH_SNAPSHOT</span><span class="comment">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚</span>  <span class="data">{N1, NodeList, Ref, {0, []}}</span>    â”‚                              â”‚                                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚</span>         <span class="state">[TRANSIENT]</span>                        â”‚                              â”‚                                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚</span>  <span class="msg">â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>  <span class="comment">â”‚</span>
<span class="comment">â”‚</span>  <span class="msg">æ­¥éª¤2</span>   â”‚                                    â”‚                              â”‚ <span class="data">N2 å¤„ç† EH_SNAPSHOT</span>                â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚</span>  <span class="msg">â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>  <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="msg">EH_SNAPSHOT</span><span class="comment">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚         â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚</span>  <span class="data">gen_server:call</span>                  â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚</span>  <span class="data">{EH_SNAPSHOT, {0, []}}</span>           â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                              â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”   â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                              â”‚</span><span class="function">snapshot_data</span><span class="comment">â”‚   â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                              â”‚</span><span class="data">(0, [], Data)</span><span class="comment">â”‚   â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                              â”‚           â”‚   â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                              â”‚</span><span class="comment">éå†æ‰€æœ‰æ•°æ®</span> <span class="comment">â”‚   â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                              â”‚</span><span class="comment">è¿‡æ»¤Ts>0çš„</span>  <span class="comment">â”‚   â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="data">Q0</span><span class="comment">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚</span>  <span class="data">(å¢é‡æ•°æ®é˜Ÿåˆ—)</span>                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚</span> <span class="function">filter_effective_head_node_id()</span>   â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚</span> â†’ <span class="variable">PendingPreMsgMap</span>                 â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚</span>  <span class="msg">â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>  <span class="comment">â”‚</span>
<span class="comment">â”‚</span>  <span class="msg">æ­¥éª¤3</span>   â”‚                                    â”‚                              â”‚ <span class="data">N2 å‘é€å“åº”ç»™ N1</span>                  â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚</span>  <span class="msg">â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>  <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€</span><span class="msg">EH_UPDATE_SNAPSHOT</span><span class="comment">â”€â”€â”€â”€â”€â”€â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚</span>                    <span class="data">{Ref, Q0, PendingPreMsgMap}</span>                   â”‚                                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚</span>  <span class="msg">â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>  <span class="comment">â”‚</span>
<span class="comment">â”‚</span>  <span class="msg">æ­¥éª¤4</span>   â”‚ <span class="data">N1 å¤„ç† EH_UPDATE_SNAPSHOT</span>        â”‚                              â”‚                                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚</span>  <span class="msg">â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>  <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚</span> <span class="function">éªŒè¯ Ref == snapshot_ref</span>           â”‚                              â”‚                                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="msg">EH_UPDATE_SNAPSHOT</span><span class="comment">â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚</span>  <span class="data">gen_server:call</span>                  â”‚                              â”‚                                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚</span>  <span class="data">{EH_UPDATE_SNAPSHOT, Q0}</span>         â”‚                              â”‚                                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚                              â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                        â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚                              â”‚</span><span class="function">merge_data</span> <span class="comment">â”‚                        â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚                              â”‚</span><span class="data">(Q0,TData,</span> <span class="comment">â”‚                        â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚                              â”‚</span><span class="data"> State,M0)</span><span class="comment">â”‚                        â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚                              â”‚           â”‚                        â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚                              â”‚</span><span class="comment">åˆå¹¶åˆ°æœ¬åœ°</span>  <span class="comment">â”‚                        â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚                              â”‚</span><span class="comment">å†™å…¥ç£ç›˜</span>    <span class="comment">â”‚                        â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚                              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                        â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚         â”‚</span> <span class="function">update_state_snapshot()</span>           â”‚                              â”‚                                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚</span> <span class="state">TRANSIENT â†’ TRANSIENT_DU</span>          â”‚                              â”‚                                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚</span>         <span class="state">[TRANSIENT_DU]</span>                     â”‚                              â”‚                                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â”‚</span>  <span class="msg">â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>  <span class="comment">â”‚</span>
<span class="comment">â”‚</span>  <span class="msg">å®Œæˆ</span>    â”‚ <span class="state">æ•°æ®åŒæ­¥å®Œæˆï¼Œç­‰å¾…çŠ¶æ€è½¬æ¢ä¸º READY</span> â”‚                              â”‚                                    â”‚         <span class="comment">â”‚</span>
<span class="comment">â”‚</span>  <span class="msg">â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>  <span class="comment">â”‚</span>
<span class="comment">â”‚         â”‚                                    â”‚                              â”‚                                    â”‚         â”‚</span>
<span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
            </div>
        </div>

        <!-- æ­¥éª¤è¯¦è§£ -->
        <h2>ğŸ“ æ­¥éª¤è¯¦è§£</h2>
        
        <!-- æ­¥éª¤1 -->
        <div class="step-card">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-title">N1 å‘èµ·å¿«ç…§è¯·æ±‚</div>
                <div class="step-location">eh_system_server.erl:91-109</div>
            </div>
            
            <div class="message-flow">
                <div class="msg-from">N1</div>
                <div class="msg-arrow">
                    <div class="msg-name">EH_SNAPSHOT</div>
                    <div class="msg-line"></div>
                </div>
                <div class="msg-to">N2</div>
            </div>
            
            <div class="code-block">
<span class="comment">%% N1 æ”¶åˆ° add_node æ¶ˆæ¯åçš„å¤„ç†</span>
<span class="keyword">handle_cast</span>({<span class="macro">?EH_ADD_NODE</span>, {Node, NodeList, NodeOrderList}}, State) ->
  <span class="keyword">case</span> <span class="function">eh_node_timestamp:valid_add_node_msg</span>(Node, State) <span class="keyword">of</span>
    <span class="macro">?EH_VALID_FOR_NEW</span> ->
      <span class="comment">%% â‘  ç”Ÿæˆå”¯ä¸€å¼•ç”¨</span>
      <span class="variable">SnapshotRef</span> = <span class="variable">UniqueIdGenerator</span>:<span class="function">unique_id</span>(),
      <span class="comment">%% â‘¡ è·å–æœ¬åœ°æ—¶é—´æˆ³ (N1 æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥ Timestamp=0, Snapshot=[])</span>
      {<span class="variable">Timestamp</span>, <span class="variable">Snapshot</span>} = <span class="variable">ReplDataManager</span>:<span class="function">timestamp</span>(),
      <span class="comment">%% â‘¢ å‘åç»§èŠ‚ç‚¹ N2 å‘é€ EH_SNAPSHOT è¯·æ±‚</span>
      <span class="function">gen_server:cast</span>({<span class="macro">?EH_SYSTEM_SERVER</span>, <span class="variable">Succ</span>}, 
                      {<span class="macro">?EH_SNAPSHOT</span>, {<span class="variable">NodeId</span>, <span class="variable">NodeList</span>, <span class="variable">NodeOrderList</span>, <span class="variable">SnapshotRef</span>, {<span class="variable">Timestamp</span>, <span class="variable">Snapshot</span>}}}),
      <span class="comment">%% â‘£ çŠ¶æ€è½¬æ¢: NOT_READY â†’ TRANSIENT</span>
      <span class="variable">NewState</span> = <span class="function">eh_node_state:update_state_transient</span>(<span class="variable">State</span>)
  <span class="keyword">end</span>.
            </div>
            
            <table>
                <tr>
                    <th>æ¶ˆæ¯å­—æ®µ</th>
                    <th>å€¼</th>
                    <th>è¯´æ˜</th>
                </tr>
                <tr>
                    <td>NodeId</td>
                    <td>N1</td>
                    <td>è¯·æ±‚æ–¹èŠ‚ç‚¹ID</td>
                </tr>
                <tr>
                    <td>SnapshotRef</td>
                    <td>unique_ref</td>
                    <td>å”¯ä¸€å¼•ç”¨ï¼Œç”¨äºåŒ¹é…å“åº”</td>
                </tr>
                <tr>
                    <td>Timestamp</td>
                    <td>0</td>
                    <td>N1 å½“å‰æœ€å¤§æ—¶é—´æˆ³</td>
                </tr>
                <tr>
                    <td>Snapshot</td>
                    <td>[]</td>
                    <td>N1 æ•°æ®ç´¢å¼•åˆ—è¡¨ï¼ˆç©ºï¼‰</td>
                </tr>
            </table>
        </div>
        
        <!-- æ­¥éª¤2 -->
        <div class="step-card">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-title">N2 å¤„ç† EH_SNAPSHOT è¯·æ±‚</div>
                <div class="step-location">eh_system_server.erl:112-123</div>
            </div>
            
            <div class="code-block">
<span class="comment">%% N2 (eh_system_server) æ”¶åˆ° EH_SNAPSHOT</span>
<span class="keyword">handle_cast</span>({<span class="macro">?EH_SNAPSHOT</span>, {Node, NodeList, NodeOrderList, Ref, {<span class="variable">Timestamp</span>, <span class="variable">Snapshot</span>}}}, State) ->
  <span class="comment">%% â‘  å‘æœ¬åœ° eh_data_server è¯·æ±‚å¢é‡æ•°æ®</span>
  <span class="variable">Q0</span> = <span class="variable">ReplDataManager</span>:<span class="function">snapshot</span>(<span class="variable">Timestamp</span>, <span class="variable">Snapshot</span>),
  
  <span class="comment">%% â‘¡ è¿‡æ»¤æ­£åœ¨å¤„ç†çš„å†™è¯·æ±‚</span>
  <span class="variable">PendingPreMsgMap</span> = <span class="function">eh_update_msg:filter_effective_head_node_id</span>(<span class="variable">PreMsgData</span>, State),
  
  <span class="comment">%% â‘¢ å‘é€å“åº”ç»™ N1</span>
  <span class="function">gen_server:cast</span>({<span class="macro">?EH_SYSTEM_SERVER</span>, Node}, 
                  {<span class="macro">?EH_UPDATE_SNAPSHOT</span>, {Ref, <span class="variable">Q0</span>, <span class="variable">PendingPreMsgMap</span>}}).
            </div>
            
            <h4 style="color: #a371f7; margin-top: 20px;">2.1 eh_data_server å¤„ç† EH_SNAPSHOT</h4>
            <div class="code-block">
<span class="comment">%% N2 (eh_data_server) å¤„ç†å¿«ç…§è¯·æ±‚</span>
<span class="keyword">handle_call</span>({<span class="macro">?EH_SNAPSHOT</span>, {<span class="variable">Timestamp</span>, <span class="variable">DataIndex</span>}}, _From, #<span class="atom">eh_data_state</span>{data=<span class="variable">Data</span>}=State) ->
  <span class="comment">%% è°ƒç”¨ snapshot_data è¿‡æ»¤å¢é‡æ•°æ®</span>
  <span class="variable">Reply</span> = <span class="function">eh_data_util:snapshot_data</span>(<span class="variable">Timestamp</span>, <span class="variable">DataIndex</span>, <span class="variable">Data</span>),
  {reply, <span class="variable">Reply</span>, State}.
            </div>
            
            <h4 style="color: #a371f7; margin-top: 20px;">2.2 snapshot_data è¿‡æ»¤é€»è¾‘</h4>
            <div class="code-block">
<span class="comment">%% éå†æ‰€æœ‰æ•°æ®ï¼Œè¿‡æ»¤å‡ºå¢é‡</span>
<span class="function">snapshot_data</span>(<span class="variable">Timestamp</span>, <span class="variable">DataIndexList</span>, <span class="variable">Mi0</span>) ->
  <span class="variable">Acc0</span> = <span class="function">maps:fold</span>(<span class="keyword">fun</span>(K, Qi0, Acc) -> 
    <span class="function">process_data</span>(<span class="keyword">fun</span> <span class="function">snapshot_fun</span>/3, <span class="keyword">fun</span> <span class="function">queue_fun</span>/2, 
                 {<span class="variable">Timestamp</span>, <span class="variable">DataIndexList</span>, K}, Qi0, Acc) 
  <span class="keyword">end</span>, [], <span class="variable">Mi0</span>),
  <span class="comment">%% æŒ‰æ—¶é—´æˆ³æ’åºåè½¬ä¸ºé˜Ÿåˆ—</span>
  <span class="function">queue:from_list</span>(<span class="function">lists:sort</span>(<span class="keyword">fun</span> <span class="function">sort_fun</span>/2, <span class="variable">Acc0</span>)).

<span class="comment">%% è¿‡æ»¤è§„åˆ™ï¼š</span>
<span class="comment">%% 1. æ•°æ® Timestamp > è¯·æ±‚æ–¹ Timestamp â†’ åŒæ­¥</span>
<span class="comment">%% 2. Timestamp ç›¸åŒï¼ŒDataIndex > è¯·æ±‚æ–¹ DataIndex â†’ åŒæ­¥</span>
<span class="comment">%% 3. å…¶ä»–æƒ…å†µ â†’ è·³è¿‡</span>
            </div>
            
            <div class="note">
                <div class="note-title">ğŸ’¡ å…³é”®ç‚¹</div>
                <p>å› ä¸º N1 çš„ Timestamp=0ï¼Œæ‰€ä»¥ N2 æ‰€æœ‰ Timestamp > 0 çš„æ•°æ®éƒ½ä¼šè¢«è¿‡æ»¤å‡ºæ¥åŒæ­¥ç»™ N1ã€‚</p>
            </div>
        </div>
        
        <!-- æ­¥éª¤3 -->
        <div class="step-card">
            <div class="step-header">
                <div class="step-number">3</div>
                <div class="step-title">N2 å‘é€ EH_UPDATE_SNAPSHOT å“åº”</div>
                <div class="step-location">eh_system_server.erl:120</div>
            </div>
            
            <div class="message-flow">
                <div class="msg-from" style="background: #f0883e;">N2</div>
                <div class="msg-arrow">
                    <div class="msg-name">EH_UPDATE_SNAPSHOT</div>
                    <div class="msg-line" style="background: linear-gradient(90deg, #f0883e, #7ee787, #1f6feb);"></div>
                </div>
                <div class="msg-to" style="background: #1f6feb;">N1</div>
            </div>
            
            <div class="code-block">
<span class="comment">%% N2 å‘é€å“åº”</span>
<span class="function">gen_server:cast</span>({<span class="macro">?EH_SYSTEM_SERVER</span>, Node}, 
                {<span class="macro">?EH_UPDATE_SNAPSHOT</span>, {<span class="variable">Ref</span>, <span class="variable">Q0</span>, <span class="variable">PendingPreMsgMap</span>}}).
            </div>
            
            <table>
                <tr>
                    <th>å“åº”å­—æ®µ</th>
                    <th>è¯´æ˜</th>
                </tr>
                <tr>
                    <td>Ref</td>
                    <td>åŸè¯·æ±‚çš„å”¯ä¸€å¼•ç”¨ï¼ˆç”¨äºåŒ¹é…ï¼‰</td>
                </tr>
                <tr>
                    <td>Q0</td>
                    <td>å¢é‡æ•°æ®é˜Ÿåˆ—ï¼ˆæŒ‰æ—¶é—´æˆ³æ’åºï¼‰</td>
                </tr>
                <tr>
                    <td>PendingPreMsgMap</td>
                    <td>N2 æ­£åœ¨å¤„ç†çš„å†™è¯·æ±‚ï¼ˆé˜²æ­¢ä¸¢å¤±ï¼‰</td>
                </tr>
            </table>
        </div>
        
        <!-- æ­¥éª¤4 -->
        <div class="step-card">
            <div class="step-header">
                <div class="step-number">4</div>
                <div class="step-title">N1 å¤„ç† EH_UPDATE_SNAPSHOT å“åº”</div>
                <div class="step-location">eh_system_server.erl:125-138</div>
            </div>
            
            <div class="code-block">
<span class="comment">%% N1 (eh_system_server) æ”¶åˆ° EH_UPDATE_SNAPSHOT</span>
<span class="keyword">handle_cast</span>({<span class="macro">?EH_UPDATE_SNAPSHOT</span>, {<span class="variable">Ref</span>, <span class="variable">Q0</span>, <span class="variable">PendingPreMsgData</span>}}, 
            #<span class="atom">eh_system_state</span>{snapshot_ref=<span class="variable">Ref</span>}=State) ->  <span class="comment">%% â‘  éªŒè¯ Ref åŒ¹é…</span>
  <span class="comment">%% â‘¡ è°ƒç”¨ eh_data_server åˆå¹¶æ•°æ®</span>
  <span class="variable">ReplDataManager</span>:<span class="function">update_snapshot</span>(<span class="variable">Q0</span>),
  
  <span class="comment">%% â‘¢ éªŒè¯å¹¶ä¿å­˜å¾…å¤„ç†å†™è¯·æ±‚</span>
  <span class="variable">PendingPreMsgData1</span> = <span class="keyword">case</span> <span class="function">eh_node_timestamp:valid_pending_pre_msg_data</span>(<span class="variable">PendingPreMsgData</span>, State) <span class="keyword">of</span>
    <span class="atom">true</span>  -> <span class="variable">PendingPreMsgData</span>;
    <span class="atom">false</span> -> <span class="function">eh_system_util:new_map</span>()
  <span class="keyword">end</span>,
  
  <span class="comment">%% â‘£ çŠ¶æ€è½¬æ¢: TRANSIENT â†’ TRANSIENT_DU</span>
  <span class="variable">NewState</span> = <span class="function">eh_node_state:update_state_snapshot</span>(State).
            </div>
            
            <h4 style="color: #a371f7; margin-top: 20px;">4.1 eh_data_server åˆå¹¶æ•°æ®</h4>
            <div class="code-block">
<span class="comment">%% N1 (eh_data_server) å¤„ç† EH_UPDATE_SNAPSHOT</span>
<span class="keyword">handle_call</span>({<span class="macro">?EH_UPDATE_SNAPSHOT</span>, <span class="variable">Qi0</span>}, _From, 
            #<span class="atom">eh_data_state</span>{data=<span class="variable">Data</span>, transient_data=<span class="variable">TData</span>, 
                           timestamp=<span class="variable">StateTimestamp</span>, data_index_list=<span class="variable">StateDataIndexList</span>}=State) ->
  <span class="comment">%% åˆå¹¶å¿«ç…§æ•°æ®å’Œä¸´æ—¶æ•°æ®åˆ°æœ¬åœ°</span>
  {<span class="variable">Timestamp</span>, <span class="variable">DIL0</span>, <span class="variable">Q0</span>, <span class="variable">D0</span>} = <span class="function">eh_data_util:merge_data</span>(<span class="variable">Qi0</span>, <span class="variable">TData</span>, 
                                                        {<span class="variable">StateTimestamp</span>, <span class="variable">StateDataIndexList</span>}, <span class="variable">Data</span>),
  <span class="comment">%% å†™å…¥ç£ç›˜</span>
  <span class="function">write_data</span>(<span class="variable">Timestamp</span>, <span class="variable">DIL0</span>, <span class="variable">D0</span>, <span class="variable">Q0</span>, State).
            </div>
            
            <h4 style="color: #a371f7; margin-top: 20px;">4.2 merge_data åˆå¹¶é€»è¾‘</h4>
            <div class="code-block">
<span class="comment">%% åˆå¹¶æ•°æ®</span>
<span class="function">merge_data</span>(<span class="variable">Q0</span>, <span class="variable">TQ0</span>, {<span class="variable">StateTimestamp</span>, <span class="variable">StateDataIndexList</span>}, <span class="variable">M0</span>) ->
  <span class="comment">%% â‘  å…ˆåˆå¹¶å¿«ç…§æ•°æ® Q0</span>
  {<span class="variable">TS1</span>, <span class="variable">DIL1</span>, <span class="variable">Q1</span>, <span class="variable">M1</span>} = <span class="function">merge_data_acc</span>(<span class="variable">Q0</span>, <span class="function">queue:new</span>(), <span class="variable">M0</span>, 
                                          <span class="variable">StateTimestamp</span>, <span class="variable">StateDataIndexList</span>, <span class="atom">true</span>),
  <span class="comment">%% â‘¡ å†åˆå¹¶ä¸´æ—¶æ•°æ® TQ0ï¼ˆåŒæ­¥æœŸé—´æ”¶åˆ°çš„å†™è¯·æ±‚ï¼‰</span>
  <span class="function">merge_data_acc</span>(<span class="variable">TQ0</span>, <span class="variable">Q1</span>, <span class="variable">M1</span>, <span class="variable">TS1</span>, <span class="variable">DIL1</span>, <span class="atom">true</span>).

<span class="function">merge_data_acc</span>(<span class="variable">Qi0</span>, <span class="variable">Qo0</span>, <span class="variable">Mi0</span>, <span class="variable">TS0</span>, <span class="variable">DIL0</span>, <span class="variable">CheckFlag</span>) ->
  <span class="keyword">case</span> <span class="function">queue:out</span>(<span class="variable">Qi0</span>) <span class="keyword">of</span>
    {empty, _} -> {<span class="variable">TS0</span>, <span class="variable">DIL0</span>, <span class="variable">Qo0</span>, <span class="variable">Mi0</span>};
    {{value, <span class="variable">StorageData</span>}, <span class="variable">Qi1</span>} ->
      <span class="keyword">case</span> (<span class="keyword">not</span> <span class="variable">CheckFlag</span>) <span class="keyword">orelse</span> (<span class="variable">StorageData</span>#<span class="atom">eh_storage_data</span>.timestamp > <span class="variable">TS0</span>) <span class="keyword">of</span>
        <span class="atom">true</span>  ->
          <span class="comment">%% æ•°æ®æ—¶é—´æˆ³æ›´å¤§ï¼Œæ·»åŠ åˆ°æœ¬åœ°å­˜å‚¨</span>
          {_, {_, <span class="variable">DIL1</span>}, <span class="variable">Qo1</span>, <span class="variable">Mi1</span>} = <span class="function">add_data</span>(<span class="variable">StorageData</span>, <span class="variable">Qo0</span>, {<span class="variable">TS0</span>, <span class="variable">DIL0</span>}, <span class="variable">Mi0</span>),
          <span class="function">merge_data_acc</span>(<span class="variable">Qi1</span>, <span class="variable">Qo1</span>, <span class="variable">Mi1</span>, <span class="variable">StorageData</span>#<span class="atom">eh_storage_data</span>.timestamp, <span class="variable">DIL1</span>, <span class="atom">false</span>);
        <span class="atom">false</span> ->
          <span class="comment">%% æ•°æ®æ—¶é—´æˆ³ä¸å¤Ÿæ–°ï¼Œè·³è¿‡</span>
          <span class="function">merge_data_acc</span>(<span class="variable">Qi1</span>, <span class="variable">Qo0</span>, <span class="variable">Mi0</span>, <span class="variable">TS0</span>, <span class="variable">DIL0</span>, <span class="variable">CheckFlag</span>)
      <span class="keyword">end</span>
  <span class="keyword">end</span>.
            </div>
        </div>

        <!-- çŠ¶æ€è½¬æ¢ -->
        <h2>ğŸ”„ N1 çŠ¶æ€è½¬æ¢</h2>
        <div class="state-transition">
            <div class="state-box state-not-ready">NOT_READY</div>
            <div class="state-arrow">â†’</div>
            <div class="state-box state-transient">TRANSIENT</div>
            <div class="state-arrow">â†’</div>
            <div class="state-box state-transient-du">TRANSIENT_DU</div>
            <div class="state-arrow">â†’</div>
            <div class="state-box state-ready">READY</div>
        </div>
        
        <table>
            <tr>
                <th>çŠ¶æ€</th>
                <th>è§¦å‘æ—¶æœº</th>
                <th>å«ä¹‰</th>
            </tr>
            <tr>
                <td><span class="highlight" style="background: rgba(218, 54, 51, 0.3);">NOT_READY</span></td>
                <td>èŠ‚ç‚¹å¯åŠ¨</td>
                <td>èŠ‚ç‚¹æœªå°±ç»ªï¼Œä¸èƒ½å¤„ç†è¯·æ±‚</td>
            </tr>
            <tr>
                <td><span class="highlight" style="background: rgba(158, 106, 3, 0.3);">TRANSIENT</span></td>
                <td>å‘é€ EH_SNAPSHOT å</td>
                <td>ç­‰å¾…å¿«ç…§æ•°æ®</td>
            </tr>
            <tr>
                <td><span class="highlight" style="background: rgba(31, 111, 235, 0.3);">TRANSIENT_DU</span></td>
                <td>æ”¶åˆ° EH_UPDATE_SNAPSHOT å</td>
                <td>æ•°æ®å·²æ›´æ–°ï¼Œç­‰å¾…æœ€ç»ˆå°±ç»ª</td>
            </tr>
            <tr>
                <td><span class="highlight" style="background: rgba(35, 134, 54, 0.3);">READY</span></td>
                <td>çŠ¶æ€è½¬æ¢å®Œæˆ</td>
                <td>èŠ‚ç‚¹å°±ç»ªï¼Œå¯ä»¥å¤„ç†è¯·æ±‚</td>
            </tr>
        </table>

        <!-- è¿›ç¨‹äº¤äº’ -->
        <h2>ğŸ”— è¿›ç¨‹äº¤äº’å…³ç³»</h2>
        <div class="flow-diagram">
            <div class="ascii-flow">
<span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="comment">â”‚                                 è¿›ç¨‹äº¤äº’å…³ç³»å›¾                                               â”‚</span>
<span class="comment">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="comment">â”‚                                                                                            â”‚</span>
<span class="comment">â”‚</span>                      <span class="node-n1">N1 èŠ‚ç‚¹</span>                                    <span class="node-n2">N2 èŠ‚ç‚¹</span>                      <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚     <span class="server">eh_system_server</span>            â”‚          â”‚     <span class="server">eh_system_server</span>            â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â”‚ â€¢ å¤„ç† add_node           â”‚  â”‚          â”‚  â”‚ â€¢ å¤„ç† EH_SNAPSHOT        â”‚  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â”‚ â€¢ å‘é€ EH_SNAPSHOT        â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–ºâ”‚ â€¢ è°ƒç”¨ data_server        â”‚  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â”‚ â€¢ å¤„ç† EH_UPDATE_SNAPSHOT â”‚â—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”‚ â€¢ å‘é€ EH_UPDATE_SNAPSHOT â”‚  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â”‚ â€¢ çŠ¶æ€ç®¡ç†                â”‚  â”‚          â”‚  â”‚ â€¢ æ›´æ–°æ‹“æ‰‘                â”‚  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚              â”‚                   â”‚          â”‚              â”‚                   â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚              â”‚ <span class="msg">gen_server:call</span>   â”‚          â”‚              â”‚ <span class="msg">gen_server:call</span>   â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚              â–¼                   â”‚          â”‚              â–¼                   â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â”‚     <span class="server">eh_data_server</span>        â”‚  â”‚          â”‚  â”‚     <span class="server">eh_data_server</span>        â”‚  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â”‚                           â”‚  â”‚          â”‚  â”‚                           â”‚  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â”‚ â€¢ timestamp()             â”‚  â”‚          â”‚  â”‚ â€¢ <span class="function">snapshot()</span>              â”‚  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â”‚ â€¢ <span class="function">update_snapshot()</span>       â”‚  â”‚          â”‚  â”‚   â†’ snapshot_data()      â”‚  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â”‚   â†’ merge_data()          â”‚  â”‚          â”‚  â”‚   â†’ snapshot_fun()       â”‚  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â”‚   â†’ write_data()          â”‚  â”‚          â”‚  â”‚                           â”‚  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚              â”‚                   â”‚          â”‚              â”‚                   â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚              â–¼                   â”‚          â”‚              â–¼                   â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â”‚       <span class="data">ç£ç›˜æ–‡ä»¶</span>             â”‚  â”‚          â”‚  â”‚       <span class="data">ç£ç›˜æ–‡ä»¶</span>             â”‚  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â”‚  ec_n1_repl.data.xxx      â”‚  â”‚          â”‚  â”‚  ec_n2_repl.data.xxx      â”‚  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   <span class="comment">â”‚</span>
<span class="comment">â”‚</span>        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   <span class="comment">â”‚</span>
<span class="comment">â”‚                                                                                            â”‚</span>
<span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
            </div>
        </div>

        <!-- å…³é”®ä»£ç ä½ç½® -->
        <h2>ğŸ“ å…³é”®ä»£ç ä½ç½®</h2>
        <table>
            <tr>
                <th>åŠŸèƒ½</th>
                <th>å‡½æ•°</th>
                <th>æ–‡ä»¶ä½ç½®</th>
            </tr>
            <tr>
                <td>å¤„ç† add_node</td>
                <td><code>handle_cast({EH_ADD_NODE, ...})</code></td>
                <td>eh_system_server.erl:91-109</td>
            </tr>
            <tr>
                <td>å‘èµ·å¿«ç…§è¯·æ±‚</td>
                <td><code>process_snapshot_request/4</code></td>
                <td>eh_system_server.erl:402-409</td>
            </tr>
            <tr>
                <td>å¤„ç†å¿«ç…§è¯·æ±‚</td>
                <td><code>handle_cast({EH_SNAPSHOT, ...})</code></td>
                <td>eh_system_server.erl:112-123</td>
            </tr>
            <tr>
                <td>ç”Ÿæˆå¢é‡æ•°æ®</td>
                <td><code>snapshot_data/3</code></td>
                <td>eh_data_util.erl:75-77</td>
            </tr>
            <tr>
                <td>è¿‡æ»¤å¢é‡æ•°æ®</td>
                <td><code>snapshot_fun/3</code></td>
                <td>eh_data_util.erl:57-73</td>
            </tr>
            <tr>
                <td>å¤„ç†å¿«ç…§å“åº”</td>
                <td><code>handle_cast({EH_UPDATE_SNAPSHOT, ...})</code></td>
                <td>eh_system_server.erl:125-138</td>
            </tr>
            <tr>
                <td>åˆå¹¶æ•°æ®</td>
                <td><code>merge_data/4</code></td>
                <td>eh_data_util.erl:163-179</td>
            </tr>
            <tr>
                <td>çŠ¶æ€è½¬æ¢</td>
                <td><code>update_state_snapshot/1</code></td>
                <td>eh_node_state.erl:43-48</td>
            </tr>
        </table>

        <!-- æ€»ç»“ -->
        <div class="summary-box">
            <div class="summary-title">âœ… æµç¨‹æ€»ç»“</div>
            <table>
                <tr>
                    <th>é˜¶æ®µ</th>
                    <th>å‘èµ·æ–¹</th>
                    <th>æ¥æ”¶æ–¹</th>
                    <th>æ¶ˆæ¯/æ“ä½œ</th>
                </tr>
                <tr>
                    <td>1</td>
                    <td>N1 (system_server)</td>
                    <td>N2 (system_server)</td>
                    <td>EH_SNAPSHOT {Ref, {0, []}}</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>N2 (system_server)</td>
                    <td>N2 (data_server)</td>
                    <td>gen_server:call snapshot(0, [])</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>N2 (system_server)</td>
                    <td>N1 (system_server)</td>
                    <td>EH_UPDATE_SNAPSHOT {Ref, Q0, PendingMap}</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>N1 (system_server)</td>
                    <td>N1 (data_server)</td>
                    <td>gen_server:call update_snapshot(Q0)</td>
                </tr>
            </table>
            
            <div style="margin-top: 15px;">
                <strong>æ ¸å¿ƒè¦ç‚¹ï¼š</strong>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li><code>EH_SNAPSHOT</code>: N1 â†’ N2ï¼Œè¯·æ±‚å¢é‡æ•°æ®</li>
                    <li><code>EH_UPDATE_SNAPSHOT</code>: N2 â†’ N1ï¼Œè¿”å›å¢é‡æ•°æ®</li>
                    <li>eh_system_server è´Ÿè´£èŠ‚ç‚¹é—´é€šä¿¡å’ŒçŠ¶æ€ç®¡ç†</li>
                    <li>eh_data_server è´Ÿè´£æ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢</li>
                    <li>æ•°æ®æŒ‰æ—¶é—´æˆ³æ’åºï¼Œç¡®ä¿åˆå¹¶é¡ºåºæ­£ç¡®</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>
