<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAQ æ•…éšœæ£€æµ‹æœºåˆ¶è¯¦ç»†åˆ†æ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            line-height: 1.8;
            padding: 40px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 20px;
            background: linear-gradient(90deg, #00d4ff, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        
        h2 {
            color: #00d4ff;
            font-size: 1.8em;
            margin: 40px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #00d4ff33;
        }
        
        h3 {
            color: #7c3aed;
            font-size: 1.4em;
            margin: 30px 0 15px 0;
        }
        
        h4 {
            color: #10b981;
            font-size: 1.2em;
            margin: 20px 0 10px 0;
        }
        
        .code-block {
            background: #0d1117;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            overflow-x: auto;
            border: 1px solid #30363d;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .code-header {
            background: linear-gradient(90deg, #238636, #1f6feb);
            color: white;
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9em;
            margin: 20px 0 0 0;
        }
        
        .code-block.with-header {
            border-radius: 0 0 12px 12px;
            margin-top: 0;
        }
        
        pre {
            margin: 0;
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        code {
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
        }
        
        .line {
            display: block;
            padding: 2px 0;
        }
        
        .line-number {
            display: inline-block;
            width: 45px;
            color: #6e7681;
            text-align: right;
            padding-right: 15px;
            user-select: none;
            border-right: 1px solid #30363d;
            margin-right: 15px;
        }
        
        .highlight-line {
            background: linear-gradient(90deg, #fbbf2433 0%, transparent 100%);
            border-left: 3px solid #fbbf24;
            margin-left: -25px;
            padding-left: 22px;
        }
        
        .keyword { color: #ff7b72; font-weight: bold; }
        .function { color: #d2a8ff; }
        .variable { color: #79c0ff; }
        .atom { color: #ffa657; }
        .string { color: #a5d6ff; }
        .comment { color: #8b949e; font-style: italic; }
        .macro { color: #ff7b72; }
        .number { color: #79c0ff; }
        .operator { color: #ff7b72; }
        .record { color: #7ee787; }
        .step-comment { color: #fbbf24; font-weight: bold; }
        
        .info-box {
            background: linear-gradient(135deg, #1e3a5f 0%, #1a2744 100%);
            border-left: 4px solid #00d4ff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .warning-box {
            background: linear-gradient(135deg, #5f3a1e 0%, #442a17 100%);
            border-left: 4px solid #fbbf24;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .success-box {
            background: linear-gradient(135deg, #1e5f3a 0%, #17442a 100%);
            border-left: 4px solid #10b981;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: #0d1117;
            border-radius: 8px;
            overflow: hidden;
        }
        
        th {
            background: linear-gradient(90deg, #238636, #1f6feb);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #30363d;
        }
        
        tr:hover {
            background: #161b22;
        }
        
        .flow-diagram {
            background: #0d1117;
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid #30363d;
        }
        
        .flow-step {
            display: inline-block;
            background: linear-gradient(135deg, #238636, #1f6feb);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            margin: 10px;
            font-weight: bold;
        }
        
        .flow-arrow {
            display: inline-block;
            color: #fbbf24;
            font-size: 1.5em;
            margin: 0 10px;
            vertical-align: middle;
        }
        
        .architecture-diagram {
            background: #0d1117;
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            border: 1px solid #30363d;
        }
        
        .arch-row {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .arch-box {
            background: linear-gradient(135deg, #1e3a5f, #16213e);
            border: 2px solid #00d4ff;
            border-radius: 10px;
            padding: 15px 25px;
            margin: 10px;
            text-align: center;
            min-width: 150px;
        }
        
        .arch-box.highlight {
            border-color: #fbbf24;
            background: linear-gradient(135deg, #5f3a1e, #442a17);
        }
        
        .arch-box.success {
            border-color: #10b981;
            background: linear-gradient(135deg, #1e5f3a, #17442a);
        }
        
        .arch-arrow {
            color: #fbbf24;
            font-size: 2em;
            margin: 0 15px;
        }
        
        .arch-arrow-down {
            color: #fbbf24;
            font-size: 2em;
            display: block;
            text-align: center;
        }
        
        .inline-code {
            background: #30363d;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9em;
            color: #79c0ff;
        }
        
        ul {
            margin: 15px 0 15px 30px;
        }
        
        li {
            margin: 8px 0;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #1e3a5f 0%, #16213e 100%);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #30363d;
        }
        
        .summary-card h4 {
            margin-top: 0;
            color: #00d4ff;
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
            margin: 20px 0;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #00d4ff, #7c3aed);
        }
        
        .timeline-item {
            position: relative;
            margin: 20px 0;
            padding: 15px 20px;
            background: #0d1117;
            border-radius: 8px;
            border: 1px solid #30363d;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 20px;
            width: 12px;
            height: 12px;
            background: #00d4ff;
            border-radius: 50%;
            border: 2px solid #1a1a2e;
        }
        
        .timeline-item.highlight::before {
            background: #fbbf24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” CRAQ æ•…éšœæ£€æµ‹æœºåˆ¶è¯¦ç»†åˆ†æ</h1>
        <p class="subtitle">åŸºäº Erlang è¿›ç¨‹ç›‘æ§çš„åˆ†å¸ƒå¼æ•…éšœæ£€æµ‹å®ç°</p>

        <!-- ========== æ¦‚è¿° ========== -->
        <h2>ğŸ“‹ ä¸€ã€æœºåˆ¶æ¦‚è¿°</h2>
        
        <div class="info-box">
            <strong>æ ¸å¿ƒåŸç†ï¼š</strong>CRAQ ç³»ç»Ÿä½¿ç”¨ Erlang çš„ <code class="inline-code">monitor/2</code> æœºåˆ¶æ¥ç›‘æ§é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹çš„ <code class="inline-code">eh_system_server</code> è¿›ç¨‹ã€‚å½“è¢«ç›‘æ§è¿›ç¨‹å´©æºƒæˆ–èŠ‚ç‚¹æ–­å¼€æ—¶ï¼Œç›‘æ§è¿›ç¨‹ä¼šæ”¶åˆ° <code class="inline-code">{'DOWN', ...}</code> æ¶ˆæ¯ï¼Œä»è€Œè§¦å‘æ•…éšœå¤„ç†æµç¨‹ã€‚
        </div>

        <div class="summary-grid">
            <div class="summary-card">
                <h4>ğŸ¯ ç›‘æ§ç›®æ ‡</h4>
                <p>ç›‘æ§é›†ç¾¤ä¸­æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹çš„ <code class="inline-code">eh_system_server</code> è¿›ç¨‹</p>
            </div>
            <div class="summary-card">
                <h4>âš¡ æ£€æµ‹æ–¹å¼</h4>
                <p>åŸºäº Erlang åŸç”Ÿçš„è¿›ç¨‹ç›‘æ§æœºåˆ¶ (<code class="inline-code">monitor/demonitor</code>)</p>
            </div>
            <div class="summary-card">
                <h4>ğŸ”„ å“åº”ç­–ç•¥</h4>
                <p>è‡ªåŠ¨é‡æ–°è®¡ç®—æ‹“æ‰‘å…³ç³»ï¼Œå¤„ç†æœªå®Œæˆçš„æ¶ˆæ¯</p>
            </div>
        </div>

        <!-- ========== æ¶æ„è®¾è®¡ ========== -->
        <h2>ğŸ—ï¸ äºŒã€æ¶æ„è®¾è®¡</h2>

        <h3>2.1 æ¨¡å—å±‚æ¬¡ç»“æ„</h3>
        
        <div class="architecture-diagram">
            <div class="arch-row">
                <div class="arch-box highlight">
                    <strong>eh_failure_detector</strong><br>
                    <small>è¡Œä¸ºå®šä¹‰ (Behaviour)</small>
                </div>
            </div>
            <div class="arch-arrow-down">â¬‡ï¸ å®ç°</div>
            <div class="arch-row">
                <div class="arch-box success">
                    <strong>eh_failure_detector_api</strong><br>
                    <small>é»˜è®¤å®ç°</small>
                </div>
            </div>
            <div class="arch-arrow-down">â¬‡ï¸ è°ƒç”¨</div>
            <div class="arch-row">
                <div class="arch-box">
                    <strong>eh_system_server</strong><br>
                    <small>handle_cast (è®¾ç½®ç›‘æ§)</small>
                </div>
                <div class="arch-arrow">â†’</div>
                <div class="arch-box">
                    <strong>eh_system_server</strong><br>
                    <small>handle_info (å¤„ç†æ•…éšœ)</small>
                </div>
            </div>
        </div>

        <h3>2.2 å¯æ’æ‹”è®¾è®¡</h3>
        
        <div class="success-box">
            <strong>è®¾è®¡ä¼˜åŠ¿ï¼š</strong>é€šè¿‡ Erlang Behaviour æœºåˆ¶ï¼Œæ•…éšœæ£€æµ‹å™¨å¯ä»¥è¢«æ›¿æ¢ä¸ºè‡ªå®šä¹‰å®ç°ï¼Œä¾‹å¦‚åŸºäºå¿ƒè·³çš„æ£€æµ‹å™¨æˆ–åŸºäº gossip åè®®çš„æ£€æµ‹å™¨ã€‚
        </div>

        <!-- ========== è¡Œä¸ºå®šä¹‰ ========== -->
        <h2>ğŸ“œ ä¸‰ã€è¡Œä¸ºå®šä¹‰ (Behaviour)</h2>

        <div class="code-header">ğŸ“„ src/eh_failure_detector.erl (è¡Œä¸ºå®šä¹‰)</div>
        <div class="code-block with-header">
<pre>
<span class="line"><span class="line-number">19</span><span class="keyword">-module</span>(<span class="atom">eh_failure_detector</span>).</span>
<span class="line"><span class="line-number">20</span></span>
<span class="line"><span class="line-number">21</span><span class="keyword">-include</span>(<span class="string">"erlang_craq.hrl"</span>).</span>
<span class="line"><span class="line-number">22</span></span>
<span class="line"><span class="line-number">23</span><span class="comment">%% å›è°ƒå‡½æ•°1: è®¾ç½®å¯¹å¤šä¸ªèŠ‚ç‚¹çš„ç›‘æ§</span></span>
<span class="line highlight-line"><span class="line-number">24</span><span class="keyword">-callback</span> <span class="function">set</span>(<span class="variable">Node</span> :: <span class="atom">atom</span>(), <span class="variable">ReplRing</span> :: <span class="atom">list</span>()) -> <span class="atom">ok</span>.</span>
<span class="line"><span class="line-number">25</span></span>
<span class="line"><span class="line-number">26</span><span class="comment">%% å›è°ƒå‡½æ•°2: è®¾ç½®å¯¹å•ä¸ªèŠ‚ç‚¹çš„ç›‘æ§</span></span>
<span class="line highlight-line"><span class="line-number">27</span><span class="keyword">-callback</span> <span class="function">set</span>(<span class="variable">Node</span> :: <span class="atom">atom</span>()) -> <span class="atom">ok</span>.</span>
<span class="line"><span class="line-number">28</span></span>
<span class="line"><span class="line-number">29</span><span class="comment">%% å›è°ƒå‡½æ•°3: æ£€æµ‹æ¶ˆæ¯æ˜¯å¦ä¸ºæ•…éšœé€šçŸ¥</span></span>
<span class="line highlight-line"><span class="line-number">30</span><span class="keyword">-callback</span> <span class="function">detect</span>(<span class="variable">Msg</span> :: <span class="atom">term</span>()) -> <span class="atom">ok</span> | {<span class="macro">?EH_NODEDOWN</span>, <span class="atom">atom</span>()}.</span>
</pre>
        </div>

        <div class="info-box">
            <strong>ä¸‰ä¸ªå›è°ƒå‡½æ•°ï¼š</strong>
            <ul>
                <li><code class="inline-code">set/2</code> - é›†ç¾¤åˆå§‹åŒ–æ—¶ï¼Œè®¾ç½®å¯¹æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹çš„ç›‘æ§</li>
                <li><code class="inline-code">set/1</code> - æ–°èŠ‚ç‚¹åŠ å…¥æ—¶ï¼Œè®¾ç½®å¯¹å•ä¸ªèŠ‚ç‚¹çš„ç›‘æ§</li>
                <li><code class="inline-code">detect/1</code> - æ£€æµ‹æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯å¦ä¸ºèŠ‚ç‚¹æ•…éšœé€šçŸ¥</li>
            </ul>
        </div>

        <!-- ========== é»˜è®¤å®ç° ========== -->
        <h2>âš™ï¸ å››ã€é»˜è®¤å®ç° (API)</h2>

        <div class="code-header">ğŸ“„ src/eh_failure_detector_api.erl (é»˜è®¤å®ç°)</div>
        <div class="code-block with-header">
<pre>
<span class="line"><span class="line-number">19</span><span class="keyword">-module</span>(<span class="atom">eh_failure_detector_api</span>).</span>
<span class="line"><span class="line-number">20</span></span>
<span class="line"><span class="line-number">21</span><span class="keyword">-behavior</span>(<span class="atom">eh_failure_detector</span>).</span>
<span class="line"><span class="line-number">22</span></span>
<span class="line"><span class="line-number">23</span><span class="keyword">-export</span>([<span class="function">set</span>/<span class="number">2</span>,</span>
<span class="line"><span class="line-number">24</span>         <span class="function">set</span>/<span class="number">1</span>,</span>
<span class="line"><span class="line-number">25</span>         <span class="function">detect</span>/<span class="number">1</span>]).</span>
<span class="line"><span class="line-number">26</span></span>
<span class="line"><span class="line-number">27</span><span class="keyword">-include</span>(<span class="string">"erlang_craq.hrl"</span>).</span>
<span class="line"><span class="line-number">28</span></span>
<span class="line"><span class="line-number">29</span><span class="comment">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span class="line"><span class="line-number">30</span><span class="comment">%% ğŸ”§ å‡½æ•°1: è®¾ç½®å¯¹å¤šä¸ªèŠ‚ç‚¹çš„ç›‘æ§ (é›†ç¾¤åˆå§‹åŒ–æ—¶è°ƒç”¨)</span></span>
<span class="line"><span class="line-number">31</span><span class="comment">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span class="line highlight-line"><span class="line-number">32</span><span class="function">set</span>(<span class="variable">Node</span>, <span class="variable">NodeList</span>) -></span>
<span class="line"><span class="line-number">33</span>    <span class="comment">%% Step 1: ä»èŠ‚ç‚¹åˆ—è¡¨ä¸­ç§»é™¤è‡ªå·±</span></span>
<span class="line"><span class="line-number">34</span>    <span class="variable">NewNodeList</span> = <span class="function">lists:delete</span>(<span class="variable">Node</span>, <span class="variable">NodeList</span>),</span>
<span class="line"><span class="line-number">35</span></span>
<span class="line"><span class="line-number">36</span>    <span class="comment">%% Step 2: å¯¹æ¯ä¸ªå…¶ä»–èŠ‚ç‚¹çš„ eh_system_server è¿›ç¨‹å»ºç«‹ç›‘æ§</span></span>
<span class="line highlight-line"><span class="line-number">37</span>    <span class="function">lists:foreach</span>(</span>
<span class="line highlight-line"><span class="line-number">38</span>        <span class="keyword">fun</span>(<span class="variable">N</span>) -></span>
<span class="line highlight-line"><span class="line-number">39</span>            <span class="function">monitor</span>(<span class="atom">process</span>, {<span class="macro">?EH_SYSTEM_SERVER</span>, <span class="variable">N</span>})</span>
<span class="line highlight-line"><span class="line-number">40</span>        <span class="keyword">end</span>,</span>
<span class="line highlight-line"><span class="line-number">41</span>        <span class="variable">NewNodeList</span></span>
<span class="line"><span class="line-number">42</span>    ),</span>
<span class="line"><span class="line-number">43</span>    <span class="atom">ok</span>.</span>
<span class="line"><span class="line-number">44</span></span>
<span class="line"><span class="line-number">45</span><span class="comment">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span class="line"><span class="line-number">46</span><span class="comment">%% ğŸ”§ å‡½æ•°2: è®¾ç½®å¯¹å•ä¸ªèŠ‚ç‚¹çš„ç›‘æ§ (æ–°èŠ‚ç‚¹åŠ å…¥æ—¶è°ƒç”¨)</span></span>
<span class="line"><span class="line-number">47</span><span class="comment">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span class="line highlight-line"><span class="line-number">48</span><span class="function">set</span>(<span class="variable">Node</span>) -></span>
<span class="line highlight-line"><span class="line-number">49</span>    <span class="function">monitor</span>(<span class="atom">process</span>, {<span class="macro">?EH_SYSTEM_SERVER</span>, <span class="variable">Node</span>}).</span>
<span class="line"><span class="line-number">50</span></span>
<span class="line"><span class="line-number">51</span><span class="comment">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span class="line"><span class="line-number">52</span><span class="comment">%% ğŸ”§ å‡½æ•°3: æ£€æµ‹æ•…éšœæ¶ˆæ¯</span></span>
<span class="line"><span class="line-number">53</span><span class="comment">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span class="line highlight-line"><span class="line-number">54</span><span class="function">detect</span>({<span class="atom">'DOWN'</span>, <span class="variable">MRef</span>, <span class="atom">process</span>, {<span class="macro">?EH_SYSTEM_SERVER</span>, <span class="variable">Node</span>}, <span class="variable">_Reason</span>}) -></span>
<span class="line"><span class="line-number">55</span>    <span class="comment">%% Step 1: å–æ¶ˆç›‘æ§å¼•ç”¨ï¼Œæ¸…ç†èµ„æº</span></span>
<span class="line"><span class="line-number">56</span>    <span class="function">demonitor</span>(<span class="variable">MRef</span>, [<span class="atom">flush</span>]),</span>
<span class="line"><span class="line-number">57</span></span>
<span class="line"><span class="line-number">58</span>    <span class="comment">%% Step 2: è¿”å›æ•…éšœèŠ‚ç‚¹ä¿¡æ¯</span></span>
<span class="line highlight-line"><span class="line-number">59</span>    {<span class="macro">?EH_NODEDOWN</span>, <span class="variable">Node</span>};</span>
<span class="line"><span class="line-number">60</span></span>
<span class="line"><span class="line-number">61</span><span class="comment">%% éæ•…éšœæ¶ˆæ¯ï¼Œè¿”å› ok</span></span>
<span class="line"><span class="line-number">62</span><span class="function">detect</span>(<span class="variable">_</span>) -></span>
<span class="line"><span class="line-number">63</span>    <span class="atom">ok</span>.</span>
</pre>
        </div>

        <h3>4.1 å…³é”®æŠ€æœ¯ç‚¹</h3>

        <table>
            <tr>
                <th>æŠ€æœ¯ç‚¹</th>
                <th>è¯´æ˜</th>
                <th>ä»£ç ä½ç½®</th>
            </tr>
            <tr>
                <td><code class="inline-code">monitor(process, {Name, Node})</code></td>
                <td>ç›‘æ§è¿œç¨‹èŠ‚ç‚¹ä¸Šçš„å‘½åè¿›ç¨‹</td>
                <td>ç¬¬ 39 è¡Œ, ç¬¬ 49 è¡Œ</td>
            </tr>
            <tr>
                <td><code class="inline-code">{'DOWN', MRef, process, Pid, Reason}</code></td>
                <td>è¿›ç¨‹å´©æºƒæˆ–èŠ‚ç‚¹æ–­å¼€æ—¶æ”¶åˆ°çš„æ¶ˆæ¯æ ¼å¼</td>
                <td>ç¬¬ 54 è¡Œ</td>
            </tr>
            <tr>
                <td><code class="inline-code">demonitor(MRef, [flush])</code></td>
                <td>å–æ¶ˆç›‘æ§å¹¶æ¸…ç†æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ç›¸å…³æ¶ˆæ¯</td>
                <td>ç¬¬ 56 è¡Œ</td>
            </tr>
            <tr>
                <td><code class="inline-code">?EH_SYSTEM_SERVER</code></td>
                <td>è¢«ç›‘æ§çš„è¿›ç¨‹åï¼Œå®šä¹‰ä¸º <code class="inline-code">eh_system_server</code></td>
                <td>erlang_craq.hrl:62</td>
            </tr>
        </table>

        <!-- ========== è°ƒç”¨ç‚¹åˆ†æ ========== -->
        <h2>ğŸ“ äº”ã€è°ƒç”¨ç‚¹åˆ†æ</h2>

        <h3>5.1 ç›‘æ§è®¾ç½®è°ƒç”¨ç‚¹ (é›†ç¾¤åˆå§‹åŒ–)</h3>

        <div class="code-header">ğŸ“„ src/eh_system_server.erl:77-89 (é›†ç¾¤è®¾ç½®æ—¶å»ºç«‹ç›‘æ§)</div>
        <div class="code-block with-header">
<pre>
<span class="line"><span class="line-number">77</span><span class="function">handle_cast</span>({<span class="macro">?EH_SETUP_REPL</span>, <span class="variable">ReplRing</span>},</span>
<span class="line"><span class="line-number">78</span>            <span class="record">#eh_system_state</span>{<span class="atom">app_config</span>=<span class="variable">AppConfig</span>}=<span class="variable">State</span>) -></span>
<span class="line"><span class="line-number">79</span></span>
<span class="line"><span class="line-number">80</span>    <span class="comment">%% ğŸ”§ Step 1: è·å–èŠ‚ç‚¹ä¿¡æ¯</span></span>
<span class="line"><span class="line-number">81</span>    <span class="variable">NodeId</span> = <span class="function">eh_system_config:get_node_id</span>(<span class="variable">AppConfig</span>),</span>
<span class="line"><span class="line-number">82</span>    <span class="variable">NodeOrder</span> = <span class="function">eh_system_config:get_node_order</span>(<span class="variable">AppConfig</span>),</span>
<span class="line"><span class="line-number">83</span></span>
<span class="line"><span class="line-number">84</span>    <span class="comment">%% ğŸ”§ Step 2: è®¡ç®—æ‹“æ‰‘å…³ç³»</span></span>
<span class="line"><span class="line-number">85</span>    {<span class="variable">ReplRing1</span>, <span class="variable">ReplRingOrder1</span>, <span class="variable">Pred</span>, <span class="variable">Succ</span>} =</span>
<span class="line"><span class="line-number">86</span>        <span class="function">eh_repl_ring:get_ordered_list_pred_succ</span>(</span>
<span class="line"><span class="line-number">87</span>            <span class="variable">NodeId</span>, <span class="variable">ReplRing</span>, <span class="variable">ReplRing</span>, <span class="variable">NodeOrder</span></span>
<span class="line"><span class="line-number">88</span>        ),</span>
<span class="line"><span class="line-number">89</span></span>
<span class="line"><span class="line-number">90</span>    <span class="comment">%% ğŸ”§ Step 3: è·å–æ•…éšœæ£€æµ‹å™¨æ¨¡å—</span></span>
<span class="line highlight-line"><span class="line-number">91</span>    <span class="variable">FailureDetector</span> = <span class="function">eh_system_config:get_failure_detector</span>(<span class="variable">AppConfig</span>),</span>
<span class="line"><span class="line-number">92</span></span>
<span class="line"><span class="line-number">93</span>    <span class="comment">%% ğŸ”¥ Step 4: å…³é”®è¡Œ - å»ºç«‹å¯¹æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹çš„ç›‘æ§</span></span>
<span class="line highlight-line"><span class="line-number">94</span>    <span class="variable">FailureDetector</span>:<span class="function">set</span>(<span class="variable">NodeId</span>, <span class="variable">ReplRing</span>),</span>
<span class="line"><span class="line-number">95</span></span>
<span class="line"><span class="line-number">96</span>    <span class="comment">%% ... åç»­çŠ¶æ€æ›´æ–° ...</span></span>
</pre>
        </div>

        <h3>5.2 æ•…éšœæ£€æµ‹è°ƒç”¨ç‚¹ (æ¶ˆæ¯å¤„ç†)</h3>

        <div class="code-header">ğŸ“„ src/eh_system_server.erl:238-285 (æ•…éšœæ£€æµ‹ä¸å¤„ç†)</div>
        <div class="code-block with-header">
<pre>
<span class="line"><span class="line-number">238</span><span class="function">handle_info</span>(<span class="variable">Msg</span>,</span>
<span class="line"><span class="line-number">239</span>            <span class="record">#eh_system_state</span>{</span>
<span class="line"><span class="line-number">240</span>                <span class="atom">repl_ring</span>=<span class="variable">ReplRing</span>,</span>
<span class="line"><span class="line-number">241</span>                <span class="atom">repl_ring_order</span>=<span class="variable">ReplRingOrder</span>,</span>
<span class="line"><span class="line-number">242</span>                <span class="atom">predecessor</span>=<span class="variable">Pred</span>,</span>
<span class="line"><span class="line-number">243</span>                <span class="atom">successor</span>=<span class="variable">Succ</span>,</span>
<span class="line"><span class="line-number">244</span>                <span class="atom">pre_msg_data</span>=<span class="variable">PreMsgData</span>,</span>
<span class="line"><span class="line-number">245</span>                <span class="atom">msg_data</span>=<span class="variable">MsgData</span>,</span>
<span class="line"><span class="line-number">246</span>                <span class="atom">app_config</span>=<span class="variable">AppConfig</span></span>
<span class="line"><span class="line-number">247</span>            }=<span class="variable">State</span>) -></span>
<span class="line"><span class="line-number">248</span></span>
<span class="line"><span class="line-number">249</span>    <span class="comment">%% ğŸ”§ Step 1: è·å–æ•…éšœæ£€æµ‹å™¨æ¨¡å—</span></span>
<span class="line highlight-line"><span class="line-number">250</span>    <span class="variable">FailureDetector</span> = <span class="function">eh_system_config:get_failure_detector</span>(<span class="variable">AppConfig</span>),</span>
<span class="line"><span class="line-number">251</span></span>
<span class="line"><span class="line-number">252</span>    <span class="comment">%% ğŸ”¥ Step 2: å…³é”®è¡Œ - æ£€æµ‹æ¶ˆæ¯æ˜¯å¦ä¸ºæ•…éšœé€šçŸ¥</span></span>
<span class="line highlight-line"><span class="line-number">253</span>    <span class="variable">NewState9</span> = <span class="keyword">case</span> <span class="variable">FailureDetector</span>:<span class="function">detect</span>(<span class="variable">Msg</span>) <span class="keyword">of</span></span>
<span class="line"><span class="line-number">254</span></span>
<span class="line"><span class="line-number">255</span>        <span class="comment">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span class="line"><span class="line-number">256</span>        <span class="comment">%% ğŸš¨ æ£€æµ‹åˆ°èŠ‚ç‚¹æ•…éšœ</span></span>
<span class="line"><span class="line-number">257</span>        <span class="comment">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span class="line highlight-line"><span class="line-number">258</span>        {<span class="macro">?EH_NODEDOWN</span>, <span class="variable">DownNode</span>} -></span>
<span class="line"><span class="line-number">259</span></span>
<span class="line"><span class="line-number">260</span>            <span class="comment">%% Step 2.1: è®°å½•æ•…éšœäº‹ä»¶</span></span>
<span class="line"><span class="line-number">261</span>            <span class="function">event_data</span>(</span>
<span class="line"><span class="line-number">262</span>                <span class="string">"failure"</span>,</span>
<span class="line"><span class="line-number">263</span>                <span class="atom">node_down</span>,</span>
<span class="line"><span class="line-number">264</span>                <span class="function">eh_system_util:get_node_name</span>(<span class="variable">DownNode</span>),</span>
<span class="line"><span class="line-number">265</span>                <span class="variable">AppConfig</span></span>
<span class="line"><span class="line-number">266</span>            ),</span>
<span class="line"><span class="line-number">267</span></span>
<span class="line"><span class="line-number">268</span>            <span class="comment">%% Step 2.2: è·å–å½“å‰èŠ‚ç‚¹ä¿¡æ¯</span></span>
<span class="line"><span class="line-number">269</span>            <span class="variable">NodeId</span> = <span class="function">eh_system_config:get_node_id</span>(<span class="variable">AppConfig</span>),</span>
<span class="line"><span class="line-number">270</span>            <span class="variable">NodeOrder</span> = <span class="function">eh_system_config:get_node_order</span>(<span class="variable">AppConfig</span>),</span>
<span class="line"><span class="line-number">271</span></span>
<span class="line"><span class="line-number">272</span>            <span class="comment">%% ğŸ”¥ Step 2.3: ä»å¤åˆ¶ç¯ä¸­ç§»é™¤æ•…éšœèŠ‚ç‚¹</span></span>
<span class="line highlight-line"><span class="line-number">273</span>            {<span class="variable">NewReplRing</span>, <span class="variable">_</span>} = <span class="function">eh_repl_ring:drop</span>(</span>
<span class="line highlight-line"><span class="line-number">274</span>                <span class="variable">DownNode</span>, <span class="variable">ReplRing</span>, <span class="variable">ReplRingOrder</span>, <span class="variable">NodeOrder</span></span>
<span class="line highlight-line"><span class="line-number">275</span>            ),</span>
<span class="line"><span class="line-number">276</span></span>
<span class="line"><span class="line-number">277</span>            <span class="comment">%% ğŸ”¥ Step 2.4: é‡æ–°è®¡ç®—å‰é©±å’Œåç»§èŠ‚ç‚¹</span></span>
<span class="line highlight-line"><span class="line-number">278</span>            <span class="variable">NewPred</span> = <span class="function">eh_repl_ring:predecessor</span>(</span>
<span class="line highlight-line"><span class="line-number">279</span>                <span class="variable">NodeId</span>, <span class="variable">NewReplRing</span>, <span class="variable">ReplRingOrder</span>, <span class="variable">NodeOrder</span></span>
<span class="line highlight-line"><span class="line-number">280</span>            ),</span>
<span class="line highlight-line"><span class="line-number">281</span>            <span class="variable">NewSucc</span> = <span class="function">eh_repl_ring:successor</span>(</span>
<span class="line highlight-line"><span class="line-number">282</span>                <span class="variable">NodeId</span>, <span class="variable">NewReplRing</span>, <span class="variable">ReplRingOrder</span>, <span class="variable">NodeOrder</span></span>
<span class="line highlight-line"><span class="line-number">283</span>            ),</span>
<span class="line"><span class="line-number">284</span></span>
<span class="line"><span class="line-number">285</span>            <span class="comment">%% Step 2.5: æ›´æ–°çŠ¶æ€</span></span>
<span class="line"><span class="line-number">286</span>            <span class="variable">NewState1</span> = <span class="variable">State</span><span class="record">#eh_system_state</span>{</span>
<span class="line"><span class="line-number">287</span>                <span class="atom">repl_ring</span>=<span class="variable">NewReplRing</span>,</span>
<span class="line"><span class="line-number">288</span>                <span class="atom">predecessor</span>=<span class="variable">NewPred</span>,</span>
<span class="line"><span class="line-number">289</span>                <span class="atom">successor</span>=<span class="variable">NewSucc</span></span>
<span class="line"><span class="line-number">290</span>            },</span>
<span class="line"><span class="line-number">291</span></span>
<span class="line"><span class="line-number">292</span>            <span class="comment">%% Step 2.6: æ ¹æ®æƒ…å†µå¤„ç†æœªå®Œæˆçš„æ¶ˆæ¯</span></span>
<span class="line"><span class="line-number">293</span>            <span class="comment">%% ... (è§ä¸‹ä¸€èŠ‚è¯¦ç»†åˆ†æ)</span></span>
<span class="line"><span class="line-number">294</span></span>
<span class="line"><span class="line-number">295</span>        <span class="comment">%% éæ•…éšœæ¶ˆæ¯ï¼Œä¿æŒåŸçŠ¶æ€</span></span>
<span class="line"><span class="line-number">296</span>        <span class="variable">_</span> -></span>
<span class="line"><span class="line-number">297</span>            <span class="variable">State</span></span>
<span class="line"><span class="line-number">298</span>    <span class="keyword">end</span>,</span>
<span class="line"><span class="line-number">299</span></span>
<span class="line"><span class="line-number">300</span>    {<span class="atom">noreply</span>, <span class="variable">NewState9</span>}.</span>
</pre>
        </div>

        <!-- ========== æ•…éšœå¤„ç†ç­–ç•¥ ========== -->
        <h2>ğŸ› ï¸ å…­ã€æ•…éšœå¤„ç†ç­–ç•¥</h2>

        <h3>6.1 å››ç§æ•…éšœåœºæ™¯</h3>

        <div class="code-header">ğŸ“„ src/eh_system_server.erl:256-279 (æ•…éšœåœºæ™¯å¤„ç†)</div>
        <div class="code-block with-header">
<pre>
<span class="line"><span class="line-number">256</span><span class="variable">NewState3</span> = <span class="keyword">case</span> {</span>
<span class="line"><span class="line-number">257</span>    <span class="variable">NewSucc</span>,                                     <span class="comment">%% æ–°çš„åç»§èŠ‚ç‚¹</span></span>
<span class="line"><span class="line-number">258</span>    <span class="function">eh_node_state:snapshot_state</span>(<span class="variable">NewState1</span>),    <span class="comment">%% å½“å‰å¿«ç…§çŠ¶æ€</span></span>
<span class="line"><span class="line-number">259</span>    <span class="variable">Succ</span> =:= <span class="variable">DownNode</span>,                           <span class="comment">%% åç»§èŠ‚ç‚¹æ˜¯å¦æ•…éšœ</span></span>
<span class="line"><span class="line-number">260</span>    <span class="variable">Pred</span> =:= <span class="variable">DownNode</span>                            <span class="comment">%% å‰é©±èŠ‚ç‚¹æ˜¯å¦æ•…éšœ</span></span>
<span class="line"><span class="line-number">261</span>} <span class="keyword">of</span></span>
<span class="line"><span class="line-number">262</span></span>
<span class="line"><span class="line-number">263</span>    <span class="comment">%% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span class="line"><span class="line-number">264</span>    <span class="comment">%% åœºæ™¯1: å½“å‰èŠ‚ç‚¹æˆä¸ºæ–°çš„å°¾èŠ‚ç‚¹ (æ— åç»§ + çŠ¶æ€å°±ç»ª)</span></span>
<span class="line"><span class="line-number">265</span>    <span class="comment">%% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span class="line highlight-line"><span class="line-number">266</span>    {<span class="atom">undefined</span>, <span class="macro">?EH_READY</span>, <span class="variable">_</span>, <span class="variable">_</span>} -></span>
<span class="line"><span class="line-number">267</span>        <span class="comment">%% å¤„ç†æ‰€æœ‰å¾…ç¡®è®¤çš„æ¶ˆæ¯</span></span>
<span class="line"><span class="line-number">268</span>        <span class="function">process_down_msg</span>(<span class="variable">NewState1</span>);</span>
<span class="line"><span class="line-number">269</span></span>
<span class="line"><span class="line-number">270</span>    <span class="comment">%% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span class="line"><span class="line-number">271</span>    <span class="comment">%% åœºæ™¯2: å¿«ç…§æœªå°±ç»ª + åç»§èŠ‚ç‚¹æ•…éšœ</span></span>
<span class="line"><span class="line-number">272</span>    <span class="comment">%% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span class="line highlight-line"><span class="line-number">273</span>    {<span class="variable">_</span>, <span class="macro">?EH_NOT_READY</span>, <span class="atom">true</span>, <span class="variable">_</span>} -></span>
<span class="line"><span class="line-number">274</span>        <span class="comment">%% å‘æ–°çš„åç»§èŠ‚ç‚¹è¯·æ±‚å¿«ç…§</span></span>
<span class="line"><span class="line-number">275</span>        <span class="function">process_snapshot_request</span>(</span>
<span class="line"><span class="line-number">276</span>            <span class="variable">NewReplRing</span>, <span class="variable">ReplRingOrder</span>, <span class="variable">NewSucc</span>, <span class="variable">NewState1</span></span>
<span class="line"><span class="line-number">277</span>        );</span>
<span class="line"><span class="line-number">278</span></span>
<span class="line"><span class="line-number">279</span>    <span class="comment">%% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span class="line"><span class="line-number">280</span>    <span class="comment">%% åœºæ™¯3: çŠ¶æ€å°±ç»ª + åç»§èŠ‚ç‚¹æ•…éšœ + å‰é©±èŠ‚ç‚¹æ­£å¸¸</span></span>
<span class="line"><span class="line-number">281</span>    <span class="comment">%% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span class="line highlight-line"><span class="line-number">282</span>    {<span class="variable">_</span>, <span class="macro">?EH_READY</span>, <span class="atom">true</span>, <span class="atom">false</span>} -></span>
<span class="line"><span class="line-number">283</span>        <span class="comment">%% é‡æ–°å‘é€é¢„æ›´æ–°æ¶ˆæ¯ç»™æ–°çš„åç»§èŠ‚ç‚¹</span></span>
<span class="line"><span class="line-number">284</span>        <span class="function">send_down_msg</span>(</span>
<span class="line"><span class="line-number">285</span>            <span class="macro">?EH_PRED_PRE_UPDATE</span>,</span>
<span class="line"><span class="line-number">286</span>            <span class="keyword">fun</span> <span class="function">eh_persist_data:no_persist_data</span>/<span class="number">2</span>,</span>
<span class="line"><span class="line-number">287</span>            <span class="keyword">fun</span> <span class="function">send_pre_update_msg</span>/<span class="number">4</span>,</span>
<span class="line"><span class="line-number">288</span>            <span class="keyword">fun</span> <span class="function">eh_persist_data:persist_data</span>/<span class="number">2</span>,</span>
<span class="line"><span class="line-number">289</span>            <span class="keyword">fun</span> <span class="function">send_update_msg</span>/<span class="number">4</span>,</span>
<span class="line"><span class="line-number">290</span>            <span class="variable">PreMsgData</span>,</span>
<span class="line"><span class="line-number">291</span>            <span class="variable">NewState1</span></span>
<span class="line"><span class="line-number">292</span>        );</span>
<span class="line"><span class="line-number">293</span></span>
<span class="line"><span class="line-number">294</span>    <span class="comment">%% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span class="line"><span class="line-number">295</span>    <span class="comment">%% åœºæ™¯4: çŠ¶æ€å°±ç»ª + å‰é©±èŠ‚ç‚¹æ•…éšœ + åç»§èŠ‚ç‚¹æ­£å¸¸</span></span>
<span class="line"><span class="line-number">296</span>    <span class="comment">%% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span class="line highlight-line"><span class="line-number">297</span>    {<span class="variable">_</span>, <span class="macro">?EH_READY</span>, <span class="atom">false</span>, <span class="atom">true</span>} -></span>
<span class="line"><span class="line-number">298</span>        <span class="comment">%% é‡æ–°å‘é€ç¡®è®¤æ¶ˆæ¯ç»™æ–°çš„å‰é©±èŠ‚ç‚¹</span></span>
<span class="line"><span class="line-number">299</span>        <span class="function">send_down_msg</span>(</span>
<span class="line"><span class="line-number">300</span>            <span class="macro">?EH_SUCC_UPDATE</span>,</span>
<span class="line"><span class="line-number">301</span>            <span class="keyword">fun</span> <span class="function">eh_persist_data:no_persist_data</span>/<span class="number">2</span>,</span>
<span class="line"><span class="line-number">302</span>            <span class="keyword">fun</span> <span class="function">send_update_msg</span>/<span class="number">4</span>,</span>
<span class="line"><span class="line-number">303</span>            <span class="keyword">fun</span> <span class="function">eh_persist_data:no_persist_data</span>/<span class="number">2</span>,</span>
<span class="line"><span class="line-number">304</span>            <span class="keyword">fun</span> <span class="function">reply_to_client</span>/<span class="number">4</span>,</span>
<span class="line"><span class="line-number">305</span>            <span class="variable">MsgData</span>,</span>
<span class="line"><span class="line-number">306</span>            <span class="variable">NewState1</span></span>
<span class="line"><span class="line-number">307</span>        );</span>
<span class="line"><span class="line-number">308</span></span>
<span class="line"><span class="line-number">309</span>    <span class="comment">%% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span class="line"><span class="line-number">310</span>    <span class="comment">%% åœºæ™¯5: å…¶ä»–æƒ…å†µï¼Œä»…æ›´æ–°æ‹“æ‰‘</span></span>
<span class="line"><span class="line-number">311</span>    <span class="comment">%% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span class="line"><span class="line-number">312</span>    {<span class="variable">_</span>, <span class="variable">_</span>, <span class="variable">_</span>, <span class="variable">_</span>} -></span>
<span class="line"><span class="line-number">313</span>        <span class="variable">NewState1</span></span>
<span class="line"><span class="line-number">314</span><span class="keyword">end</span>,</span>
</pre>
        </div>

        <h3>6.2 æ•…éšœåœºæ™¯æ€»ç»“</h3>

        <table>
            <tr>
                <th>åœºæ™¯</th>
                <th>æ¡ä»¶</th>
                <th>å¤„ç†ç­–ç•¥</th>
            </tr>
            <tr>
                <td><strong>æˆä¸ºæ–°å°¾èŠ‚ç‚¹</strong></td>
                <td>NewSucc = undefined, çŠ¶æ€å°±ç»ª</td>
                <td>å¤„ç†æ‰€æœ‰å¾…ç¡®è®¤æ¶ˆæ¯ï¼Œç›´æ¥å›å¤å®¢æˆ·ç«¯</td>
            </tr>
            <tr>
                <td><strong>å¿«ç…§æœªå°±ç»ª</strong></td>
                <td>çŠ¶æ€æœªå°±ç»ª, åç»§æ•…éšœ</td>
                <td>å‘æ–°åç»§è¯·æ±‚æ•°æ®å¿«ç…§</td>
            </tr>
            <tr>
                <td><strong>åç»§èŠ‚ç‚¹æ•…éšœ</strong></td>
                <td>çŠ¶æ€å°±ç»ª, åç»§æ•…éšœ, å‰é©±æ­£å¸¸</td>
                <td>é‡æ–°å‘é€é¢„æ›´æ–°æ¶ˆæ¯ç»™æ–°åç»§</td>
            </tr>
            <tr>
                <td><strong>å‰é©±èŠ‚ç‚¹æ•…éšœ</strong></td>
                <td>çŠ¶æ€å°±ç»ª, å‰é©±æ•…éšœ, åç»§æ­£å¸¸</td>
                <td>é‡æ–°å‘é€ç¡®è®¤æ¶ˆæ¯ç»™æ–°å‰é©±</td>
            </tr>
            <tr>
                <td><strong>å…¶ä»–æƒ…å†µ</strong></td>
                <td>ä¸å½±å“å½“å‰èŠ‚ç‚¹çš„ç›´æ¥é‚»å±…</td>
                <td>ä»…æ›´æ–°æ‹“æ‰‘ä¿¡æ¯</td>
            </tr>
        </table>

        <!-- ========== å®Œæ•´æµç¨‹å›¾ ========== -->
        <h2>ğŸ”„ ä¸ƒã€å®Œæ•´æµç¨‹å›¾</h2>

        <div class="flow-diagram">
            <div style="text-align: left; max-width: 800px; margin: 0 auto;">
                <h4 style="color: #00d4ff; margin-bottom: 20px;">7.1 ç›‘æ§å»ºç«‹æµç¨‹</h4>
                <div class="timeline">
                    <div class="timeline-item">
                        <strong>Step 1: é›†ç¾¤åˆå§‹åŒ–</strong><br>
                        <code class="inline-code">erlang_craq:setup_repl([Node1, Node2, Node3])</code>
                    </div>
                    <div class="timeline-item">
                        <strong>Step 2: å¹¿æ’­è®¾ç½®æ¶ˆæ¯</strong><br>
                        <code class="inline-code">gen_server:abcast(NodeList, eh_system_server, {eh_setup_repl, NodeList})</code>
                    </div>
                    <div class="timeline-item highlight">
                        <strong>Step 3: å»ºç«‹è¿›ç¨‹ç›‘æ§</strong><br>
                        <code class="inline-code">FailureDetector:set(NodeId, ReplRing)</code><br>
                        å¯¹æ¯ä¸ªå…¶ä»–èŠ‚ç‚¹è°ƒç”¨ <code class="inline-code">monitor(process, {eh_system_server, Node})</code>
                    </div>
                    <div class="timeline-item">
                        <strong>Step 4: å®Œæˆæ‹“æ‰‘è®¾ç½®</strong><br>
                        ä¿å­˜å‰é©±ã€åç»§èŠ‚ç‚¹ä¿¡æ¯ï¼ŒçŠ¶æ€å˜ä¸º <code class="inline-code">eh_ready</code>
                    </div>
                </div>

                <h4 style="color: #fbbf24; margin-top: 40px; margin-bottom: 20px;">7.2 æ•…éšœæ£€æµ‹æµç¨‹</h4>
                <div class="timeline">
                    <div class="timeline-item">
                        <strong>Step 1: èŠ‚ç‚¹å´©æºƒæˆ–ç½‘ç»œæ–­å¼€</strong><br>
                        è¢«ç›‘æ§çš„ <code class="inline-code">eh_system_server</code> è¿›ç¨‹ä¸å¯è¾¾
                    </div>
                    <div class="timeline-item highlight">
                        <strong>Step 2: æ”¶åˆ° DOWN æ¶ˆæ¯</strong><br>
                        <code class="inline-code">{'DOWN', MRef, process, {eh_system_server, DownNode}, Reason}</code>
                    </div>
                    <div class="timeline-item highlight">
                        <strong>Step 3: æ•…éšœæ£€æµ‹å™¨è¯†åˆ«</strong><br>
                        <code class="inline-code">FailureDetector:detect(Msg)</code> è¿”å› <code class="inline-code">{nodedown, DownNode}</code>
                    </div>
                    <div class="timeline-item">
                        <strong>Step 4: æ›´æ–°æ‹“æ‰‘</strong><br>
                        ä»å¤åˆ¶ç¯ç§»é™¤æ•…éšœèŠ‚ç‚¹ï¼Œé‡æ–°è®¡ç®—å‰é©±åç»§
                    </div>
                    <div class="timeline-item">
                        <strong>Step 5: å¤„ç†æœªå®Œæˆæ¶ˆæ¯</strong><br>
                        æ ¹æ®æ•…éšœåœºæ™¯é€‰æ‹©åˆé€‚çš„æ¢å¤ç­–ç•¥
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== å…³é”®ä»£ç ä½ç½®æ±‡æ€» ========== -->
        <h2>ğŸ“ å…«ã€å…³é”®ä»£ç ä½ç½®æ±‡æ€»</h2>

        <table>
            <tr>
                <th>æ–‡ä»¶</th>
                <th>è¡Œå·</th>
                <th>å‡½æ•°/å®šä¹‰</th>
                <th>ä½œç”¨</th>
            </tr>
            <tr>
                <td><code class="inline-code">eh_failure_detector.erl</code></td>
                <td>23-27</td>
                <td>callback å®šä¹‰</td>
                <td>å®šä¹‰æ•…éšœæ£€æµ‹å™¨è¡Œä¸ºæ¥å£</td>
            </tr>
            <tr>
                <td><code class="inline-code">eh_failure_detector_api.erl</code></td>
                <td>29-32</td>
                <td><code class="inline-code">set/2</code></td>
                <td>å»ºç«‹å¯¹å¤šä¸ªèŠ‚ç‚¹çš„ç›‘æ§</td>
            </tr>
            <tr>
                <td><code class="inline-code">eh_failure_detector_api.erl</code></td>
                <td>34-35</td>
                <td><code class="inline-code">set/1</code></td>
                <td>å»ºç«‹å¯¹å•ä¸ªèŠ‚ç‚¹çš„ç›‘æ§</td>
            </tr>
            <tr>
                <td><code class="inline-code">eh_failure_detector_api.erl</code></td>
                <td>37-41</td>
                <td><code class="inline-code">detect/1</code></td>
                <td>æ£€æµ‹ DOWN æ¶ˆæ¯å¹¶è¿”å›æ•…éšœèŠ‚ç‚¹</td>
            </tr>
            <tr>
                <td><code class="inline-code">eh_system_server.erl</code></td>
                <td>82-84</td>
                <td>handle_cast (setup_repl)</td>
                <td>é›†ç¾¤åˆå§‹åŒ–æ—¶è°ƒç”¨ set/2</td>
            </tr>
            <tr>
                <td><code class="inline-code">eh_system_server.erl</code></td>
                <td>238-285</td>
                <td>handle_info</td>
                <td>æ¥æ”¶ DOWN æ¶ˆæ¯å¹¶å¤„ç†æ•…éšœ</td>
            </tr>
            <tr>
                <td><code class="inline-code">eh_system_server.erl</code></td>
                <td>256-279</td>
                <td>case åˆ†æ”¯</td>
                <td>æ ¹æ®åœºæ™¯é€‰æ‹©æ¢å¤ç­–ç•¥</td>
            </tr>
            <tr>
                <td><code class="inline-code">erlang_craq.hrl</code></td>
                <td>27</td>
                <td><code class="inline-code">?EH_NODEDOWN</code></td>
                <td>æ•…éšœæ ‡è¯†å®å®šä¹‰ (nodedown)</td>
            </tr>
            <tr>
                <td><code class="inline-code">erlang_craq.hrl</code></td>
                <td>62</td>
                <td><code class="inline-code">?EH_SYSTEM_SERVER</code></td>
                <td>è¢«ç›‘æ§è¿›ç¨‹å (eh_system_server)</td>
            </tr>
        </table>

        <!-- ========== è®¾è®¡ç‰¹ç‚¹ ========== -->
        <h2>ğŸ’¡ ä¹ã€è®¾è®¡ç‰¹ç‚¹æ€»ç»“</h2>

        <div class="summary-grid">
            <div class="summary-card">
                <h4>ğŸ”Œ å¯æ’æ‹”æ¶æ„</h4>
                <p>é€šè¿‡ Behaviour æœºåˆ¶ï¼Œå¯ä»¥æ›¿æ¢ä¸ºè‡ªå®šä¹‰çš„æ•…éšœæ£€æµ‹å®ç°ï¼Œå¦‚å¿ƒè·³æ£€æµ‹ã€gossip åè®®ç­‰ã€‚</p>
            </div>
            <div class="summary-card">
                <h4>âš¡ å³æ—¶å“åº”</h4>
                <p>åˆ©ç”¨ Erlang åŸç”Ÿçš„è¿›ç¨‹ç›‘æ§æœºåˆ¶ï¼Œæ•…éšœå‘ç”Ÿæ—¶ç«‹å³æ”¶åˆ°é€šçŸ¥ï¼Œæ— éœ€è½®è¯¢ã€‚</p>
            </div>
            <div class="summary-card">
                <h4>ğŸ”„ è‡ªåŠ¨æ¢å¤</h4>
                <p>æ£€æµ‹åˆ°æ•…éšœåè‡ªåŠ¨é‡æ–°è®¡ç®—æ‹“æ‰‘ï¼Œå¤„ç†æœªå®Œæˆçš„æ¶ˆæ¯ï¼Œä¿è¯ç³»ç»Ÿä¸€è‡´æ€§ã€‚</p>
            </div>
            <div class="summary-card">
                <h4>ğŸ¯ ç²¾ç¡®ç›‘æ§</h4>
                <p>åªç›‘æ§ <code class="inline-code">eh_system_server</code> è¿›ç¨‹ï¼Œé¿å…ä¸å¿…è¦çš„ç›‘æ§å¼€é”€ã€‚</p>
            </div>
        </div>

        <div class="success-box">
            <strong>æ ¸å¿ƒä¼˜åŠ¿ï¼š</strong>
            <ul>
                <li><strong>é›¶å»¶è¿Ÿæ£€æµ‹</strong>: è¿›ç¨‹å´©æºƒæˆ–èŠ‚ç‚¹æ–­å¼€æ—¶ç«‹å³è§¦å‘</li>
                <li><strong>èµ„æºé«˜æ•ˆ</strong>: ä½¿ç”¨ Erlang å†…ç½®æœºåˆ¶ï¼Œæ— é¢å¤–ç½‘ç»œå¼€é”€</li>
                <li><strong>å®¹é”™è®¾è®¡</strong>: è‡ªåŠ¨å¤„ç†å„ç§æ•…éšœåœºæ™¯ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§</li>
                <li><strong>æ‰©å±•çµæ´»</strong>: å¯æ’æ‹”è®¾è®¡æ”¯æŒè‡ªå®šä¹‰æ£€æµ‹ç­–ç•¥</li>
            </ul>
        </div>

    </div>
</body>
</html>
