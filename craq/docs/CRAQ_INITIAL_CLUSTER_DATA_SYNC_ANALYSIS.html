<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAQ é¦–æ¬¡é›†ç¾¤å»ºç«‹æ•°æ®åŒæ­¥åˆ†æ</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #7c3aed;
            --success-color: #059669;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
            --code-bg: #1e293b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        
        .subtitle {
            text-align: center;
            color: #64748b;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            color: var(--primary-color);
            font-size: 1.5em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title .icon {
            font-size: 1.2em;
        }
        
        /* å…³é”®å‘ç°å¡ç‰‡ */
        .key-finding {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid var(--warning-color);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .key-finding h3 {
            color: var(--warning-color);
            margin-bottom: 10px;
        }
        
        .key-finding p {
            color: #92400e;
            font-size: 1.1em;
        }
        
        /* æµç¨‹å›¾å®¹å™¨ */
        .flow-diagram {
            background: #f1f5f9;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        .flow-diagram pre {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            color: var(--text-color);
            white-space: pre;
        }
        
        /* ä»£ç å— */
        .code-block {
            background: var(--code-bg);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            overflow-x: auto;
        }
        
        .code-block pre {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: #e2e8f0;
            margin: 0;
        }
        
        .code-block .comment { color: #6b7280; }
        .code-block .keyword { color: #f472b6; }
        .code-block .function { color: #60a5fa; }
        .code-block .variable { color: #fbbf24; }
        .code-block .atom { color: #34d399; }
        .code-block .string { color: #a78bfa; }
        .code-block .macro { color: #fb923c; }
        .code-block .highlight { background: rgba(251, 191, 36, 0.2); display: block; }
        
        .code-header {
            background: #334155;
            color: #94a3b8;
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            font-family: monospace;
            font-size: 0.9em;
            margin-top: 15px;
        }
        
        .code-header + .code-block {
            margin-top: 0;
            border-radius: 0 0 8px 8px;
        }
        
        /* å¯¹æ¯”è¡¨æ ¼ */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 15px;
            text-align: left;
            border: 1px solid var(--border-color);
        }
        
        .comparison-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        .comparison-table tr:nth-child(even) {
            background: #f8fafc;
        }
        
        .comparison-table tr:hover {
            background: #e0f2fe;
        }
        
        /* åœºæ™¯å¡ç‰‡ */
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .scenario-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            border-radius: 10px;
            padding: 20px;
        }
        
        .scenario-card.no-sync {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #86efac;
        }
        
        .scenario-card.need-sync {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #fcd34d;
        }
        
        .scenario-card h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .scenario-card.no-sync h4 { color: var(--success-color); }
        .scenario-card.need-sync h4 { color: var(--warning-color); }
        
        /* çŠ¶æ€æµç¨‹ */
        .state-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            padding: 20px;
            background: #f8fafc;
            border-radius: 10px;
        }
        
        .state-box {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            min-width: 140px;
        }
        
        .state-box.not-ready {
            background: #fee2e2;
            color: var(--danger-color);
            border: 2px solid var(--danger-color);
        }
        
        .state-box.transient {
            background: #fef3c7;
            color: var(--warning-color);
            border: 2px solid var(--warning-color);
        }
        
        .state-box.ready {
            background: #d1fae5;
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }
        
        .state-arrow {
            font-size: 1.5em;
            color: #64748b;
        }
        
        .state-label {
            font-size: 0.8em;
            color: #64748b;
            text-align: center;
            margin-top: 5px;
        }
        
        /* æ—¶åºå›¾ */
        .sequence-diagram {
            background: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        .sequence-diagram pre {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            color: var(--text-color);
        }
        
        /* æ­¥éª¤åˆ—è¡¨ */
        .step-list {
            counter-reset: step-counter;
            list-style: none;
            padding: 0;
        }
        
        .step-list li {
            counter-increment: step-counter;
            padding: 15px 15px 15px 60px;
            position: relative;
            margin-bottom: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
        }
        
        .step-list li::before {
            content: counter(step-counter);
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .step-list li strong {
            color: var(--primary-color);
        }
        
        /* ä¿¡æ¯æ¡† */
        .info-box {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .info-box.important {
            background: #fef2f2;
            border-left: 4px solid var(--danger-color);
        }
        
        .info-box.note {
            background: #eff6ff;
            border-left: 4px solid var(--primary-color);
        }
        
        .info-box.success {
            background: #f0fdf4;
            border-left: 4px solid var(--success-color);
        }
        
        /* æ¶ˆæ¯ç±»å‹æ ‡ç­¾ */
        .msg-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            font-family: monospace;
        }
        
        .msg-tag.setup { background: #dbeafe; color: #1d4ed8; }
        .msg-tag.snapshot { background: #fef3c7; color: #b45309; }
        .msg-tag.update { background: #d1fae5; color: #047857; }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .scenario-grid {
                grid-template-columns: 1fr;
            }
            
            .state-flow {
                flex-direction: column;
            }
            
            .state-arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ CRAQ é¦–æ¬¡é›†ç¾¤å»ºç«‹æ•°æ®åŒæ­¥åˆ†æ</h1>
        <p class="subtitle">æ·±å…¥åˆ†æ Erlang CRAQ å®ç°ä¸­é›†ç¾¤åˆå§‹åŒ–æ—¶çš„æ•°æ®ä¸€è‡´æ€§ä¿è¯æœºåˆ¶</p>

        <!-- å…³é”®å‘ç° -->
        <div class="key-finding">
            <h3>âš ï¸ å…³é”®å‘ç°</h3>
            <p><strong>é¦–æ¬¡é›†ç¾¤å»ºç«‹ï¼ˆsetup_replï¼‰æ—¶ä¸ä¼šè§¦å‘æ•°æ®åŒæ­¥ï¼</strong><br>
            æ•°æ®åŒæ­¥ä»…åœ¨ <code>add_node</code> åœºæ™¯ä¸‹è§¦å‘ï¼Œå³æ–°èŠ‚ç‚¹åŠ å…¥å·²å­˜åœ¨çš„é›†ç¾¤æ—¶ã€‚
            é¦–æ¬¡å»ºç«‹é›†ç¾¤æ—¶ï¼Œæ‰€æœ‰èŠ‚ç‚¹ç›´æ¥è¿›å…¥ <code>READY</code> çŠ¶æ€ï¼Œå‡è®¾å„èŠ‚ç‚¹æ•°æ®å·²ç»ä¸€è‡´æˆ–ä¸ºç©ºã€‚</p>
        </div>

        <!-- ä¸¤ç§åœºæ™¯å¯¹æ¯” -->
        <div class="section">
            <h2 class="section-title"><span class="icon">ğŸ“Š</span> é›†ç¾¤å»ºç«‹çš„ä¸¤ç§åœºæ™¯å¯¹æ¯”</h2>
            
            <div class="scenario-grid">
                <div class="scenario-card no-sync">
                    <h4>âœ… åœºæ™¯1: é¦–æ¬¡é›†ç¾¤å»ºç«‹ (setup_repl)</h4>
                    <p><strong>è§¦å‘æ–¹å¼:</strong></p>
                    <code>erlang_craq:setup_repl([N1, N2, N3])</code>
                    <br><br>
                    <p><strong>ç‰¹ç‚¹:</strong></p>
                    <ul>
                        <li>æ‰€æœ‰èŠ‚ç‚¹åŒæ—¶æ”¶åˆ°æ¶ˆæ¯</li>
                        <li>æ¯ä¸ªèŠ‚ç‚¹ç‹¬ç«‹è®¡ç®—æ‹“æ‰‘</li>
                        <li>ç›´æ¥è¿›å…¥ <code>READY</code> çŠ¶æ€</li>
                        <li><strong>ä¸è§¦å‘æ•°æ®åŒæ­¥</strong></li>
                    </ul>
                    <br>
                    <p><strong>é€‚ç”¨åœºæ™¯:</strong></p>
                    <ul>
                        <li>å…¨æ–°é›†ç¾¤ï¼Œæ‰€æœ‰èŠ‚ç‚¹æ•°æ®ä¸ºç©º</li>
                        <li>æ•°æ®å·²é€šè¿‡å…¶ä»–æ–¹å¼åŒæ­¥</li>
                    </ul>
                </div>
                
                <div class="scenario-card need-sync">
                    <h4>ğŸ”„ åœºæ™¯2: æ–°èŠ‚ç‚¹åŠ å…¥ (add_node)</h4>
                    <p><strong>è§¦å‘æ–¹å¼:</strong></p>
                    <code>erlang_craq:add_node(NewNode, NodeList, OrderList)</code>
                    <br><br>
                    <p><strong>ç‰¹ç‚¹:</strong></p>
                    <ul>
                        <li>æ–°èŠ‚ç‚¹çŠ¶æ€ä¸º <code>NOT_READY</code></li>
                        <li>éœ€è¦ä»åç»§èŠ‚ç‚¹è·å–æ•°æ®</li>
                        <li>ç»å† <code>TRANSIENT</code> è¿‡æ¸¡çŠ¶æ€</li>
                        <li><strong>è§¦å‘ Snapshot æ•°æ®åŒæ­¥</strong></li>
                    </ul>
                    <br>
                    <p><strong>é€‚ç”¨åœºæ™¯:</strong></p>
                    <ul>
                        <li>æ‰©å®¹ï¼šå‘å·²æœ‰é›†ç¾¤æ·»åŠ æ–°èŠ‚ç‚¹</li>
                        <li>æ¢å¤ï¼šæ•…éšœèŠ‚ç‚¹é‡æ–°åŠ å…¥</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- setup_repl è¯¦ç»†åˆ†æ -->
        <div class="section">
            <h2 class="section-title"><span class="icon">ğŸš€</span> é¦–æ¬¡é›†ç¾¤å»ºç«‹ (setup_repl) è¯¦ç»†æµç¨‹</h2>
            
            <h3>1. è°ƒç”¨å…¥å£</h3>
            <div class="code-header">ğŸ“„ src/erlang_craq.erl:44-45</div>
            <div class="code-block">
<pre><span class="function">setup_repl</span>(<span class="variable">NodeList</span>) ->
  <span class="comment">%% å‘æ‰€æœ‰èŠ‚ç‚¹å¹¿æ’­ EH_SETUP_REPL æ¶ˆæ¯</span>
  <span class="function">gen_server:abcast</span>(<span class="variable">NodeList</span>, <span class="macro">?EH_SYSTEM_SERVER</span>, {<span class="macro">?EH_SETUP_REPL</span>, <span class="variable">NodeList</span>}).</pre>
            </div>
            
            <div class="info-box note">
                <strong>ğŸ“ è¯´æ˜:</strong> <code>gen_server:abcast/3</code> æ˜¯å¼‚æ­¥å¹¿æ’­ï¼Œå‘ NodeList ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹åŒæ—¶å‘é€æ¶ˆæ¯ã€‚
            </div>

            <h3>2. æ¶ˆæ¯å¤„ç†</h3>
            <div class="code-header">ğŸ“„ src/eh_system_server.erl:77-89</div>
            <div class="code-block">
<pre><span class="function">handle_cast</span>({<span class="macro">?EH_SETUP_REPL</span>, <span class="variable">ReplRing</span>}, 
            #<span class="atom">eh_system_state</span>{<span class="atom">app_config</span>=<span class="variable">AppConfig</span>}=<span class="variable">State</span>) ->
  <span class="comment">%% Step 1: è·å–æœ¬èŠ‚ç‚¹é…ç½®</span>
  <span class="variable">NodeId</span> = <span class="function">eh_system_config:get_node_id</span>(<span class="variable">AppConfig</span>),
  <span class="variable">NodeOrder</span> = <span class="function">eh_system_config:get_node_order</span>(<span class="variable">AppConfig</span>),
  
  <span class="comment">%% Step 2: è®¡ç®—å¤åˆ¶ç¯æ‹“æ‰‘ï¼ˆå‰é©±ã€åç»§ï¼‰</span>
  {<span class="variable">ReplRing1</span>, <span class="variable">ReplRingOrder1</span>, <span class="variable">Pred</span>, <span class="variable">Succ</span>} = 
    <span class="function">eh_repl_ring:get_ordered_list_pred_succ</span>(<span class="variable">NodeId</span>, <span class="variable">ReplRing</span>, <span class="variable">ReplRing</span>, <span class="variable">NodeOrder</span>),
  
  <span class="comment">%% Step 3: è®¾ç½®æ•…éšœæ£€æµ‹å™¨</span>
  <span class="variable">FailureDetector</span> = <span class="function">eh_system_config:get_failure_detector</span>(<span class="variable">AppConfig</span>),
  <span class="variable">ReplDataManager</span> = <span class="function">eh_system_config:get_repl_data_manager</span>(<span class="variable">AppConfig</span>),
  <span class="function">FailureDetector:set</span>(<span class="variable">NodeId</span>, <span class="variable">ReplRing</span>),
  
  <span class="comment">%% Step 4: è·å–æœ¬åœ°æ—¶é—´æˆ³</span>
  {<span class="variable">Timestamp</span>, _} = <span class="function">ReplDataManager:timestamp</span>(),
  
  <span class="highlight"><span class="comment">%% Step 5: ç›´æ¥è®¾ç½®ä¸º READY çŠ¶æ€ï¼ˆæ— æ•°æ®åŒæ­¥ï¼ï¼‰</span></span>
  <span class="highlight"><span class="variable">NewState1</span> = <span class="function">eh_node_state:update_state_ready</span>(<span class="variable">State</span>),</span>
  
  <span class="comment">%% Step 6: æ›´æ–°çŠ¶æ€</span>
  <span class="variable">NewState2</span> = <span class="variable">NewState1</span>#<span class="atom">eh_system_state</span>{
    <span class="atom">repl_ring_order</span>=<span class="variable">ReplRingOrder1</span>, 
    <span class="atom">repl_ring</span>=<span class="variable">ReplRing1</span>, 
    <span class="atom">predecessor</span>=<span class="variable">Pred</span>, 
    <span class="atom">successor</span>=<span class="variable">Succ</span>, 
    <span class="atom">timestamp</span>=<span class="variable">Timestamp</span>},
  
  {<span class="atom">noreply</span>, <span class="variable">NewState2</span>}.</pre>
            </div>

            <h3>3. çŠ¶æ€è½¬æ¢</h3>
            <div class="state-flow">
                <div>
                    <div class="state-box not-ready">NOT_READY</div>
                    <div class="state-label">åˆå§‹çŠ¶æ€</div>
                </div>
                <div class="state-arrow">â†’</div>
                <div>
                    <div class="state-box ready">READY</div>
                    <div class="state-label">ç›´æ¥å°±ç»ª</div>
                </div>
            </div>
            
            <div class="info-box important">
                <strong>âš ï¸ é‡è¦:</strong> æ³¨æ„è¿™é‡Œè°ƒç”¨çš„æ˜¯ <code>update_state_ready()</code>ï¼Œç›´æ¥å°†çŠ¶æ€è®¾ä¸º READYï¼Œ
                <strong>æ²¡æœ‰ä»»ä½•æ•°æ®åŒæ­¥æ“ä½œ</strong>ï¼è¿™æ„å‘³ç€ setup_repl å‡è®¾æ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®å·²ç»ä¸€è‡´ã€‚
            </div>
        </div>

        <!-- add_node è¯¦ç»†åˆ†æ -->
        <div class="section">
            <h2 class="section-title"><span class="icon">â•</span> æ–°èŠ‚ç‚¹åŠ å…¥ (add_node) æ•°æ®åŒæ­¥æµç¨‹</h2>
            
            <h3>1. è§¦å‘æ¡ä»¶åˆ¤æ–­</h3>
            <div class="code-header">ğŸ“„ src/eh_node_timestamp.erl:96-105</div>
            <div class="code-block">
<pre><span class="function">valid_add_node_msg</span>(<span class="variable">Node</span>, 
                   #<span class="atom">eh_system_state</span>{<span class="atom">repl_ring</span>=<span class="variable">ReplRing</span>, <span class="atom">app_config</span>=<span class="variable">AppConfig</span>}=<span class="variable">State</span>) ->
  <span class="keyword">case</span> {<span class="function">eh_node_state:msg_state</span>(<span class="variable">State</span>), 
        <span class="variable">Node</span> =:= <span class="function">eh_system_config:get_node_id</span>(<span class="variable">AppConfig</span>), 
        <span class="function">lists:member</span>(<span class="variable">Node</span>, <span class="variable">ReplRing</span>)} <span class="keyword">of</span>
    
    <span class="highlight">{<span class="macro">?EH_NOT_READY</span>, <span class="atom">true</span>, <span class="atom">false</span>} -></span>
      <span class="highlight"><span class="comment">%% æ–°èŠ‚ç‚¹ï¼šè‡ªå·±æ˜¯æ–°åŠ å…¥çš„èŠ‚ç‚¹ï¼ŒçŠ¶æ€ä¸º NOT_READY</span></span>
      <span class="highlight"><span class="macro">?EH_VALID_FOR_NEW</span>;</span>
      
    {<span class="macro">?EH_READY</span>, <span class="atom">false</span>, <span class="atom">false</span>} ->
      <span class="comment">%% å·²å­˜åœ¨èŠ‚ç‚¹ï¼šæ”¶åˆ°æ–°èŠ‚ç‚¹åŠ å…¥é€šçŸ¥</span>
      <span class="macro">?EH_VALID_FOR_EXISTING</span>;
      
    {_, _, _} ->
      <span class="macro">?EH_INVALID_MSG</span>
  <span class="keyword">end</span>.</pre>
            </div>

            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>è¿”å›å€¼</th>
                        <th>æ¡ä»¶</th>
                        <th>å«ä¹‰</th>
                        <th>æ˜¯å¦è§¦å‘åŒæ­¥</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>EH_VALID_FOR_NEW</code></td>
                        <td>msg_state=NOT_READY, æ˜¯è‡ªå·±, ä¸åœ¨ç¯ä¸­</td>
                        <td>æˆ‘æ˜¯æ–°åŠ å…¥çš„èŠ‚ç‚¹</td>
                        <td><strong style="color: var(--success-color);">âœ“ æ˜¯</strong></td>
                    </tr>
                    <tr>
                        <td><code>EH_VALID_FOR_EXISTING</code></td>
                        <td>msg_state=READY, ä¸æ˜¯è‡ªå·±, ä¸åœ¨ç¯ä¸­</td>
                        <td>æœ‰æ–°èŠ‚ç‚¹è¦åŠ å…¥</td>
                        <td>å¦</td>
                    </tr>
                    <tr>
                        <td><code>EH_INVALID_MSG</code></td>
                        <td>å…¶ä»–æƒ…å†µ</td>
                        <td>æ— æ•ˆæ¶ˆæ¯</td>
                        <td>å¦</td>
                    </tr>
                </tbody>
            </table>

            <h3>2. æ–°èŠ‚ç‚¹å¤„ç†æµç¨‹</h3>
            <div class="code-header">ğŸ“„ src/eh_system_server.erl:91-110</div>
            <div class="code-block">
<pre><span class="function">handle_cast</span>({<span class="macro">?EH_ADD_NODE</span>, {<span class="variable">Node</span>, <span class="variable">NodeList</span>, <span class="variable">NodeOrderList</span>}}, 
            #<span class="atom">eh_system_state</span>{<span class="atom">app_config</span>=<span class="variable">AppConfig</span>}=<span class="variable">State</span>) ->
  ...
  <span class="variable">NewState9</span> = <span class="keyword">case</span> <span class="function">eh_node_timestamp:valid_add_node_msg</span>(<span class="variable">Node</span>, <span class="variable">State</span>) <span class="keyword">of</span>
    <span class="highlight"><span class="macro">?EH_VALID_FOR_NEW</span> -></span>
      <span class="highlight"><span class="comment">%% ğŸ”¥ æ–°èŠ‚ç‚¹ï¼šå‘èµ·å¿«ç…§è¯·æ±‚</span></span>
      <span class="highlight"><span class="variable">NewState1</span> = <span class="function">process_snapshot_request</span>(<span class="variable">NodeList1</span>, <span class="variable">NodeOrderList1</span>, <span class="variable">Succ1</span>, <span class="variable">State</span>),</span>
      <span class="function">FailureDetector:set</span>(<span class="variable">Node</span>, <span class="variable">NodeList1</span>),
      <span class="highlight"><span class="comment">%% çŠ¶æ€å˜ä¸º TRANSIENTï¼ˆè¿‡æ¸¡çŠ¶æ€ï¼‰</span></span>
      <span class="highlight"><span class="variable">NewState2</span> = <span class="function">eh_node_state:update_state_transient</span>(<span class="variable">NewState1</span>),</span>
      <span class="variable">NewState2</span>#<span class="atom">eh_system_state</span>{...};
      
    <span class="macro">?EH_VALID_FOR_EXISTING</span> ->
      <span class="comment">%% å·²å­˜åœ¨èŠ‚ç‚¹ï¼šåªæ›´æ–°æ‹“æ‰‘ï¼Œä¸åŒæ­¥æ•°æ®</span>
      <span class="function">FailureDetector:set</span>(<span class="variable">Node</span>),
      <span class="variable">State</span>#<span class="atom">eh_system_state</span>{...};
      
    _ ->
      <span class="variable">State</span>
  <span class="keyword">end</span>,
  {<span class="atom">noreply</span>, <span class="variable">NewState9</span>}.</pre>
            </div>

            <h3>3. çŠ¶æ€è½¬æ¢ï¼ˆæ–°èŠ‚ç‚¹ï¼‰</h3>
            <div class="state-flow">
                <div>
                    <div class="state-box not-ready">NOT_READY</div>
                    <div class="state-label">åˆå§‹çŠ¶æ€</div>
                </div>
                <div class="state-arrow">â†’</div>
                <div>
                    <div class="state-box transient">TRANSIENT</div>
                    <div class="state-label">å‘èµ·å¿«ç…§è¯·æ±‚</div>
                </div>
                <div class="state-arrow">â†’</div>
                <div>
                    <div class="state-box transient">TRANSIENT_DU</div>
                    <div class="state-label">æ”¶åˆ°å¿«ç…§æ•°æ®</div>
                </div>
                <div class="state-arrow">â†’</div>
                <div>
                    <div class="state-box ready">READY</div>
                    <div class="state-label">åŒæ­¥å®Œæˆ</div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®åŒæ­¥æ—¶åºå›¾ -->
        <div class="section">
            <h2 class="section-title"><span class="icon">ğŸ“ˆ</span> æ•°æ®åŒæ­¥å®Œæ•´æ—¶åº</h2>
            
            <div class="sequence-diagram">
<pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           add_node æ•°æ®åŒæ­¥æ—¶åºå›¾                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                             â”‚
â”‚   Client              N1 (æ–°èŠ‚ç‚¹)                    N2 (åç»§èŠ‚ç‚¹)                            â”‚
â”‚     â”‚                    â”‚                              â”‚                                   â”‚
â”‚     â”‚  add_node(N1,...)  â”‚                              â”‚                                   â”‚
â”‚     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                              â”‚                                   â”‚
â”‚     â”‚                    â”‚                              â”‚                                   â”‚
â”‚     â”‚                    â”‚ â‘  valid_add_node_msg        â”‚                                   â”‚
â”‚     â”‚                    â”‚   è¿”å› VALID_FOR_NEW        â”‚                                   â”‚
â”‚     â”‚                    â”‚                              â”‚                                   â”‚
â”‚     â”‚                    â”‚ â‘¡ process_snapshot_request  â”‚                                   â”‚
â”‚     â”‚                    â”‚   è·å–æœ¬åœ° {Timestamp, DIL}  â”‚                                   â”‚
â”‚     â”‚                    â”‚                              â”‚                                   â”‚
â”‚     â”‚                    â”‚ â‘¢ EH_SNAPSHOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                                   â”‚
â”‚     â”‚                    â”‚   {NodeId, Ref, {T, DIL}}    â”‚                                   â”‚
â”‚     â”‚                    â”‚                              â”‚                                   â”‚
â”‚     â”‚                    â”‚   çŠ¶æ€: TRANSIENT            â”‚ â‘£ snapshot(T, DIL)               â”‚
â”‚     â”‚                    â”‚                              â”‚   è¿‡æ»¤å‡ºå¢é‡æ•°æ®                   â”‚
â”‚     â”‚                    â”‚                              â”‚                                   â”‚
â”‚     â”‚                    â”‚ â‘¤ EH_UPDATE_SNAPSHOT â—„â”€â”€â”€â”€â”€â”€â”€â”‚                                   â”‚
â”‚     â”‚                    â”‚   {Ref, Q0, PendingMsgs}     â”‚                                   â”‚
â”‚     â”‚                    â”‚                              â”‚                                   â”‚
â”‚     â”‚                    â”‚ â‘¥ merge_data(Q0, ...)       â”‚                                   â”‚
â”‚     â”‚                    â”‚   åˆå¹¶å¢é‡æ•°æ®åˆ°æœ¬åœ°          â”‚                                   â”‚
â”‚     â”‚                    â”‚                              â”‚                                   â”‚
â”‚     â”‚                    â”‚   çŠ¶æ€: READY âœ“              â”‚                                   â”‚
â”‚     â”‚                    â”‚                              â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
            </div>

            <h3>å…³é”®æ¶ˆæ¯è¯´æ˜</h3>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>æ¶ˆæ¯</th>
                        <th>æ–¹å‘</th>
                        <th>å†…å®¹</th>
                        <th>ä½œç”¨</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="msg-tag snapshot">EH_SNAPSHOT</span></td>
                        <td>æ–°èŠ‚ç‚¹ â†’ åç»§</td>
                        <td>{NodeId, Ref, {Timestamp, DataIndexList}}</td>
                        <td>è¯·æ±‚å¢é‡æ•°æ®ï¼Œæºå¸¦æœ¬åœ°ç‰ˆæœ¬ä¿¡æ¯</td>
                    </tr>
                    <tr>
                        <td><span class="msg-tag update">EH_UPDATE_SNAPSHOT</span></td>
                        <td>åç»§ â†’ æ–°èŠ‚ç‚¹</td>
                        <td>{Ref, Q0, PendingPreMsgData}</td>
                        <td>è¿”å›å¢é‡æ•°æ®é˜Ÿåˆ—å’Œå¾…å¤„ç†æ¶ˆæ¯</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- å¢é‡æ•°æ®è¿‡æ»¤é€»è¾‘ -->
        <div class="section">
            <h2 class="section-title"><span class="icon">ğŸ”</span> å¢é‡æ•°æ®è¿‡æ»¤é€»è¾‘</h2>
            
            <p>åç»§èŠ‚ç‚¹æ”¶åˆ° <code>EH_SNAPSHOT</code> è¯·æ±‚åï¼Œæ ¹æ®è¯·æ±‚æ–¹çš„ <code>{Timestamp, DataIndexList}</code> è¿‡æ»¤å‡ºéœ€è¦åŒæ­¥çš„å¢é‡æ•°æ®ï¼š</p>
            
            <div class="code-header">ğŸ“„ src/eh_data_util.erl:57-73 (snapshot_fun)</div>
            <div class="code-block">
<pre><span class="comment">%% æƒ…å†µ1: æ•°æ®æ—¶é—´æˆ³ > è¯·æ±‚æ—¶é—´æˆ³ â†’ éœ€è¦åŒæ­¥</span>
<span class="function">snapshot_fun</span>({<span class="variable">CTimestamp</span>, _<span class="variable">CDataIndexList</span>, <span class="variable">StorageKey</span>}, 
             #<span class="atom">eh_storage_value</span>{<span class="atom">timestamp</span>=<span class="variable">Timestamp</span>}=<span class="variable">StorageValue</span>, <span class="variable">Qo0</span>) 
  <span class="keyword">when</span> <span class="variable">Timestamp</span> > <span class="variable">CTimestamp</span> ->
  [<span class="function">storage_data</span>(<span class="variable">StorageKey</span>, <span class="variable">StorageValue</span>) | <span class="variable">Qo0</span>];

<span class="comment">%% æƒ…å†µ2: æ—¶é—´æˆ³ç›¸åŒï¼Œæ¯”è¾ƒ data_index</span>
<span class="function">snapshot_fun</span>({<span class="variable">CTimestamp</span>, <span class="variable">CDataIndexList</span>, 
              #<span class="atom">eh_storage_key</span>{<span class="atom">object_type</span>=<span class="variable">ObjectType</span>, <span class="atom">object_id</span>=<span class="variable">ObjectId</span>}=<span class="variable">StorageKey</span>},
             #<span class="atom">eh_storage_value</span>{<span class="atom">timestamp</span>=<span class="variable">Timestamp</span>, <span class="atom">data_index</span>=<span class="variable">DataIndex</span>}=<span class="variable">StorageValue</span>, <span class="variable">Qo0</span>)
  <span class="keyword">when</span> <span class="variable">Timestamp</span> =:= <span class="variable">CTimestamp</span> ->
  <span class="keyword">case</span> <span class="function">lists:keyfind</span>({<span class="variable">ObjectType</span>, <span class="variable">ObjectId</span>}, 1, <span class="variable">CDataIndexList</span>) <span class="keyword">of</span>
    <span class="atom">false</span> ->
      <span class="comment">%% è¯·æ±‚æ–¹æ²¡æœ‰æ­¤å¯¹è±¡ â†’ éœ€è¦åŒæ­¥</span>
      [<span class="function">storage_data</span>(<span class="variable">StorageKey</span>, <span class="variable">StorageValue</span>) | <span class="variable">Qo0</span>];
    {_, <span class="variable">CDataIndex</span>} <span class="keyword">when</span> <span class="variable">DataIndex</span> > <span class="variable">CDataIndex</span> ->
      <span class="comment">%% data_index æ›´å¤§ â†’ éœ€è¦åŒæ­¥</span>
      [<span class="function">storage_data</span>(<span class="variable">StorageKey</span>, <span class="variable">StorageValue</span>) | <span class="variable">Qo0</span>];
    _ ->
      <span class="comment">%% è¯·æ±‚æ–¹å·²æœ‰æ­¤æ•°æ® â†’ è·³è¿‡</span>
      <span class="variable">Qo0</span>
  <span class="keyword">end</span>;

<span class="comment">%% æƒ…å†µ3: æ•°æ®æ—¶é—´æˆ³ < è¯·æ±‚æ—¶é—´æˆ³ â†’ ä¸éœ€è¦åŒæ­¥</span>
<span class="function">snapshot_fun</span>(_, _, <span class="variable">Qo0</span>) ->
  <span class="variable">Qo0</span>.</pre>
            </div>

            <div class="flow-diagram">
<pre>
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         å¢é‡æ•°æ®è¿‡æ»¤å†³ç­–æ ‘               â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  æ•°æ® Timestamp > è¯·æ±‚ Timestamp ?       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                    â”‚
                          YES                   NO
                           â”‚                    â”‚
                           â–¼                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  âœ“ éœ€è¦åŒæ­¥   â”‚   â”‚ æ•°æ® Timestamp = è¯·æ±‚ Timestamp? â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚              â”‚
                                             YES             NO
                                              â”‚              â”‚
                                              â–¼              â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ è¯·æ±‚æ–¹æœ‰æ­¤å¯¹è±¡çš„è®°å½•?    â”‚  â”‚  âœ— ä¸éœ€è¦åŒæ­¥ â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚           â”‚
                                   YES          NO
                                    â”‚           â”‚
                                    â–¼           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ DataIndex > è¯·æ±‚æ–¹?  â”‚  â”‚  âœ“ éœ€è¦åŒæ­¥   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚           â”‚
                          YES          NO
                           â”‚           â”‚
                           â–¼           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  âœ“ éœ€è¦åŒæ­¥   â”‚  â”‚  âœ— ä¸éœ€è¦åŒæ­¥ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
            </div>
        </div>

        <!-- æ•°æ®åˆå¹¶é€»è¾‘ -->
        <div class="section">
            <h2 class="section-title"><span class="icon">ğŸ”€</span> æ•°æ®åˆå¹¶é€»è¾‘ (merge_data)</h2>
            
            <div class="code-header">ğŸ“„ src/eh_data_util.erl:163-179</div>
            <div class="code-block">
<pre><span class="comment">%% åˆå¹¶å¢é‡æ•°æ®å’Œä¸´æ—¶æ•°æ®</span>
<span class="function">merge_data</span>(<span class="variable">Q0</span>, <span class="variable">TQ0</span>, {<span class="variable">StateTimestamp</span>, <span class="variable">StateDataIndexList</span>}, <span class="variable">M0</span>) ->
  <span class="comment">%% ç¬¬ä¸€æ­¥: åˆå¹¶å¿«ç…§æ•°æ® Q0</span>
  {<span class="variable">TS1</span>, <span class="variable">DIL1</span>, <span class="variable">Q1</span>, <span class="variable">M1</span>} = <span class="function">merge_data_acc</span>(<span class="variable">Q0</span>, <span class="function">queue:new</span>(), <span class="variable">M0</span>, <span class="variable">StateTimestamp</span>, <span class="variable">StateDataIndexList</span>, <span class="atom">true</span>),
  <span class="comment">%% ç¬¬äºŒæ­¥: åˆå¹¶ä¸´æ—¶æ•°æ® TQ0</span>
  <span class="function">merge_data_acc</span>(<span class="variable">TQ0</span>, <span class="variable">Q1</span>, <span class="variable">M1</span>, <span class="variable">TS1</span>, <span class="variable">DIL1</span>, <span class="atom">true</span>).

<span class="function">merge_data_acc</span>(<span class="variable">Qi0</span>, <span class="variable">Qo0</span>, <span class="variable">Mi0</span>, <span class="variable">TS0</span>, <span class="variable">DIL0</span>, <span class="variable">CheckFlag</span>) ->
  <span class="keyword">case</span> <span class="function">queue:out</span>(<span class="variable">Qi0</span>) <span class="keyword">of</span>
    {<span class="atom">empty</span>, _} ->
      {<span class="variable">TS0</span>, <span class="variable">DIL0</span>, <span class="variable">Qo0</span>, <span class="variable">Mi0</span>};
    {{<span class="atom">value</span>, <span class="variable">StorageData</span>}, <span class="variable">Qi1</span>} ->
      <span class="keyword">case</span> (<span class="keyword">not</span> <span class="variable">CheckFlag</span>) <span class="keyword">orelse</span> (<span class="variable">StorageData</span>#<span class="atom">eh_storage_data</span>.<span class="atom">timestamp</span> > <span class="variable">TS0</span>) <span class="keyword">of</span>
        <span class="atom">true</span> ->
          <span class="comment">%% æ•°æ®æ›´æ–° â†’ æ·»åŠ åˆ°æœ¬åœ°</span>
          {_, {_, <span class="variable">DIL1</span>}, <span class="variable">Qo1</span>, <span class="variable">Mi1</span>} = <span class="function">add_data</span>(<span class="variable">StorageData</span>, <span class="variable">Qo0</span>, {<span class="variable">TS0</span>, <span class="variable">DIL0</span>}, <span class="variable">Mi0</span>),
          <span class="function">merge_data_acc</span>(<span class="variable">Qi1</span>, <span class="variable">Qo1</span>, <span class="variable">Mi1</span>, <span class="variable">StorageData</span>#<span class="atom">eh_storage_data</span>.<span class="atom">timestamp</span>, <span class="variable">DIL1</span>, <span class="atom">false</span>);
        <span class="atom">false</span> ->
          <span class="comment">%% æ•°æ®å·²å­˜åœ¨ â†’ è·³è¿‡</span>
          <span class="function">merge_data_acc</span>(<span class="variable">Qi1</span>, <span class="variable">Qo0</span>, <span class="variable">Mi0</span>, <span class="variable">TS0</span>, <span class="variable">DIL0</span>, <span class="variable">CheckFlag</span>)
      <span class="keyword">end</span>
  <span class="keyword">end</span>.</pre>
            </div>
        </div>

        <!-- ä¸ºä»€ä¹ˆ setup_repl ä¸åŒæ­¥æ•°æ® -->
        <div class="section">
            <h2 class="section-title"><span class="icon">â“</span> ä¸ºä»€ä¹ˆ setup_repl ä¸è§¦å‘æ•°æ®åŒæ­¥ï¼Ÿ</h2>
            
            <div class="scenario-grid">
                <div class="scenario-card">
                    <h4>ğŸ“‹ è®¾è®¡å‡è®¾</h4>
                    <ul>
                        <li><strong>å…¨æ–°é›†ç¾¤:</strong> é¦–æ¬¡å»ºç«‹æ—¶æ‰€æœ‰èŠ‚ç‚¹æ•°æ®ä¸ºç©º</li>
                        <li><strong>é¢„åŒæ­¥:</strong> æ•°æ®å·²é€šè¿‡å…¶ä»–æ–¹å¼ï¼ˆå¦‚æ–‡ä»¶å¤åˆ¶ï¼‰åŒæ­¥</li>
                        <li><strong>ç®€åŒ–é€»è¾‘:</strong> é¿å… N ä¸ªèŠ‚ç‚¹åŒæ—¶äº’ç›¸åŒæ­¥çš„å¤æ‚æ€§</li>
                    </ul>
                </div>
                
                <div class="scenario-card">
                    <h4>ğŸ”„ å¯¹æ¯” add_node</h4>
                    <ul>
                        <li><strong>æ˜ç¡®çš„æ–°æ—§:</strong> æ–°èŠ‚ç‚¹ vs å·²æœ‰é›†ç¾¤</li>
                        <li><strong>å•å‘åŒæ­¥:</strong> åªéœ€æ–°èŠ‚ç‚¹ä»åç»§è·å–æ•°æ®</li>
                        <li><strong>å¢é‡ä¼ è¾“:</strong> åªä¼ è¾“å·®å¼‚æ•°æ®</li>
                    </ul>
                </div>
            </div>

            <div class="info-box important">
                <strong>âš ï¸ ç”Ÿäº§ç¯å¢ƒæ³¨æ„:</strong><br>
                å¦‚æœé¦–æ¬¡å»ºç«‹é›†ç¾¤æ—¶å„èŠ‚ç‚¹æ•°æ®ä¸ä¸€è‡´ï¼Œ<code>setup_repl</code> <strong>ä¸ä¼šè‡ªåŠ¨åŒæ­¥</strong>ï¼
                éœ€è¦åœ¨è°ƒç”¨ <code>setup_repl</code> ä¹‹å‰ç¡®ä¿æ•°æ®ä¸€è‡´ï¼Œæˆ–è€…ä½¿ç”¨ <code>add_node</code> é€ä¸ªæ·»åŠ èŠ‚ç‚¹ã€‚
            </div>
        </div>

        <!-- æ¨èåšæ³• -->
        <div class="section">
            <h2 class="section-title"><span class="icon">âœ…</span> æ¨èåšæ³•</h2>
            
            <h3>åœºæ™¯1: å…¨æ–°é›†ç¾¤ï¼ˆæ•°æ®ä¸ºç©ºï¼‰</h3>
            <div class="code-block">
<pre><span class="comment">%% ç›´æ¥ä½¿ç”¨ setup_replï¼Œæ‰€æœ‰èŠ‚ç‚¹åŒæ—¶å°±ç»ª</span>
<span class="function">erlang_craq:setup_repl</span>([<span class="atom">'n1@host1'</span>, <span class="atom">'n2@host2'</span>, <span class="atom">'n3@host3'</span>]).</pre>
            </div>

            <h3>åœºæ™¯2: æœ‰ä¸€ä¸ªèŠ‚ç‚¹æœ‰æ•°æ®ï¼Œéœ€è¦åŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹</h3>
            <div class="code-block">
<pre><span class="comment">%% æ–¹æ³•1: å…ˆåœ¨æœ‰æ•°æ®çš„èŠ‚ç‚¹å»ºç«‹å•èŠ‚ç‚¹é›†ç¾¤</span>
<span class="function">erlang_craq:setup_repl</span>([<span class="atom">'n1@host1'</span>]).

<span class="comment">%% ç„¶åé€ä¸ªæ·»åŠ æ–°èŠ‚ç‚¹ï¼ˆä¼šè§¦å‘æ•°æ®åŒæ­¥ï¼‰</span>
<span class="function">erlang_craq:add_node</span>(<span class="atom">'n2@host2'</span>, [<span class="atom">'n1@host1'</span>, <span class="atom">'n2@host2'</span>], []).
<span class="function">erlang_craq:add_node</span>(<span class="atom">'n3@host3'</span>, [<span class="atom">'n1@host1'</span>, <span class="atom">'n2@host2'</span>, <span class="atom">'n3@host3'</span>], []).</pre>
            </div>

            <h3>åœºæ™¯3: å¤šä¸ªèŠ‚ç‚¹éƒ½æœ‰æ•°æ®ï¼Œéœ€è¦åˆå¹¶</h3>
            <div class="code-block">
<pre><span class="comment">%% CRAQ ä¸ç›´æ¥æ”¯æŒå¤šæºæ•°æ®åˆå¹¶ï¼</span>
<span class="comment">%% éœ€è¦å…ˆæ‰‹åŠ¨åˆå¹¶æ•°æ®åˆ°ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç„¶åæŒ‰åœºæ™¯2å¤„ç†</span>

<span class="comment">%% æˆ–è€…ï¼šç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹æ•°æ®å®Œå…¨ä¸€è‡´åå† setup_repl</span></pre>
            </div>
        </div>

        <!-- æ€»ç»“ -->
        <div class="section">
            <h2 class="section-title"><span class="icon">ğŸ“</span> æ€»ç»“</h2>
            
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>æ“ä½œ</th>
                        <th>è§¦å‘æ•°æ®åŒæ­¥</th>
                        <th>çŠ¶æ€è½¬æ¢</th>
                        <th>é€‚ç”¨åœºæ™¯</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>setup_repl</code></td>
                        <td style="color: var(--danger-color);">âŒ å¦</td>
                        <td>NOT_READY â†’ READY</td>
                        <td>å…¨æ–°ç©ºé›†ç¾¤ / æ•°æ®å·²é¢„åŒæ­¥</td>
                    </tr>
                    <tr>
                        <td><code>add_node</code> (æ–°èŠ‚ç‚¹)</td>
                        <td style="color: var(--success-color);">âœ… æ˜¯</td>
                        <td>NOT_READY â†’ TRANSIENT â†’ READY</td>
                        <td>æ‰©å®¹ / èŠ‚ç‚¹æ¢å¤</td>
                    </tr>
                    <tr>
                        <td><code>add_node</code> (å·²æœ‰èŠ‚ç‚¹)</td>
                        <td style="color: var(--danger-color);">âŒ å¦</td>
                        <td>ä¿æŒ READY</td>
                        <td>æ‹“æ‰‘æ›´æ–°é€šçŸ¥</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="info-box success">
                <strong>ğŸ’¡ æ ¸å¿ƒè¦ç‚¹:</strong>
                <ul>
                    <li>CRAQ çš„æ•°æ®åŒæ­¥æ˜¯<strong>æŒ‰éœ€è§¦å‘</strong>çš„ï¼Œä»…åœ¨æ–°èŠ‚ç‚¹åŠ å…¥æ—¶å‘ç”Ÿ</li>
                    <li>åŒæ­¥æ–¹å‘æ˜¯<strong>æ–°èŠ‚ç‚¹ â† åç»§èŠ‚ç‚¹</strong>ï¼ˆå› ä¸ºåç»§èŠ‚ç‚¹æ•°æ®æ›´"æ–°"ï¼‰</li>
                    <li>åŒæ­¥é‡‡ç”¨<strong>å¢é‡ä¼ è¾“</strong>ï¼Œåªä¼ è¾“å·®å¼‚æ•°æ®</li>
                    <li>é¦–æ¬¡å»ºç«‹é›†ç¾¤éœ€è¦<strong>é¢„å…ˆç¡®ä¿æ•°æ®ä¸€è‡´</strong>æˆ–ä½¿ç”¨ add_node æ–¹å¼</li>
                </ul>
            </div>
        </div>

        <footer style="text-align: center; color: #64748b; margin-top: 30px; padding: 20px;">
            <p>ç”Ÿæˆæ—¶é—´: 2025-12-25 | åŸºäº erlang_craq é¡¹ç›®æºç åˆ†æ</p>
        </footer>
    </div>
</body>
</html>
