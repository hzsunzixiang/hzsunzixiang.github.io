<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAQ å¿«ç…§æ•°æ®åŒæ­¥æµç¨‹è¯¦è§£</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --success-color: #16a34a;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
            --code-bg: #1e293b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        
        .subtitle {
            text-align: center;
            color: #64748b;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            color: var(--secondary-color);
            font-size: 1.4em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--primary-color);
            border-radius: 2px;
        }
        
        /* æµç¨‹å›¾æ ·å¼ */
        .flow-diagram {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        .flow-content {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            color: #e2e8f0;
            white-space: pre;
            line-height: 1.5;
        }
        
        .flow-content .highlight-new {
            color: #4ade80;
            font-weight: bold;
        }
        
        .flow-content .highlight-existing {
            color: #60a5fa;
            font-weight: bold;
        }
        
        .flow-content .highlight-msg {
            color: #fbbf24;
        }
        
        .flow-content .highlight-state {
            color: #f472b6;
        }
        
        /* ä»£ç å—æ ·å¼ */
        .code-block {
            background: var(--code-bg);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            overflow-x: auto;
        }
        
        .code-block pre {
            margin: 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            color: #e2e8f0;
            line-height: 1.6;
        }
        
        .code-block .comment {
            color: #6b7280;
        }
        
        .code-block .keyword {
            color: #f472b6;
        }
        
        .code-block .function {
            color: #60a5fa;
        }
        
        .code-block .string {
            color: #4ade80;
        }
        
        .code-block .atom {
            color: #fbbf24;
        }
        
        .code-block .variable {
            color: #c4b5fd;
        }
        
        /* è¡¨æ ¼æ ·å¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid var(--border-color);
        }
        
        th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background: #f1f5f9;
        }
        
        tr:hover {
            background: #e2e8f0;
        }
        
        /* æ­¥éª¤å¡ç‰‡ */
        .step-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid var(--primary-color);
            border-radius: 0 8px 8px 0;
            padding: 20px;
            margin: 15px 0;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .step-number {
            width: 36px;
            height: 36px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .step-title {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        /* çŠ¶æ€æœºæ ·å¼ */
        .state-machine {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .state-box {
            padding: 15px 25px;
            border-radius: 8px;
            text-align: center;
            min-width: 150px;
            font-weight: 600;
        }
        
        .state-not-ready {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 2px solid var(--danger-color);
            color: var(--danger-color);
        }
        
        .state-transient {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border: 2px solid var(--warning-color);
            color: var(--warning-color);
        }
        
        .state-ready {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid var(--success-color);
            color: var(--success-color);
        }
        
        .state-arrow {
            display: flex;
            align-items: center;
            color: #64748b;
            font-size: 1.5em;
        }
        
        /* è­¦å‘Šæ¡† */
        .warning-box {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border: 1px solid var(--warning-color);
            border-radius: 8px;
            padding: 15px 20px;
            margin: 15px 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .warning-box::before {
            content: 'âš ï¸';
            font-size: 1.3em;
        }
        
        /* æˆåŠŸæ¡† */
        .success-box {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid var(--success-color);
            border-radius: 8px;
            padding: 15px 20px;
            margin: 15px 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .success-box::before {
            content: 'âœ…';
            font-size: 1.3em;
        }
        
        /* é”™è¯¯æ¡† */
        .error-box {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 1px solid var(--danger-color);
            border-radius: 8px;
            padding: 15px 20px;
            margin: 15px 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .error-box::before {
            content: 'âŒ';
            font-size: 1.3em;
        }
        
        /* ä¿¡æ¯æ¡† */
        .info-box {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            padding: 15px 20px;
            margin: 15px 0;
        }
        
        /* æ–‡ä»¶ä½ç½®æ ‡ç­¾ */
        .file-location {
            display: inline-block;
            background: #e2e8f0;
            color: #475569;
            padding: 4px 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
            margin: 5px 0;
        }
        
        /* åŒæ å¸ƒå±€ */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 900px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
        
        /* æ—¥å¿—æ ·å¼ */
        .log-block {
            background: #0f172a;
            border-radius: 8px;
            padding: 15px 20px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            color: #94a3b8;
            overflow-x: auto;
        }
        
        .log-block .log-time {
            color: #64748b;
        }
        
        .log-block .log-level {
            color: #4ade80;
        }
        
        .log-block .log-module {
            color: #60a5fa;
        }
        
        .log-block .log-key {
            color: #fbbf24;
        }
        
        .log-block .log-value {
            color: #f472b6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ CRAQ å¿«ç…§æ•°æ®åŒæ­¥æµç¨‹è¯¦è§£</h1>
        <p class="subtitle">åŸºäº erlang_craq é¡¹ç›®æºç åˆ†æ | add_node è§¦å‘çš„å¢é‡æ•°æ®åŒæ­¥æœºåˆ¶</p>
        
        <!-- æ¦‚è¿° -->
        <div class="section">
            <h2 class="section-title">æ¦‚è¿°</h2>
            <p>åœ¨ CRAQ åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå½“æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ—¶ï¼Œéœ€è¦ä»å·²æœ‰èŠ‚ç‚¹åŒæ­¥æ•°æ®ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æ <code>add_node</code> æ“ä½œè§¦å‘çš„å¿«ç…§æ•°æ®åŒæ­¥æµç¨‹ã€‚</p>
            
            <div class="info-box">
                <strong>æ ¸å¿ƒåŸåˆ™ï¼š</strong><code>add_node(Node, NodeList, NodeOrderList)</code> ä¸­çš„ <code>Node</code> å‚æ•°æŒ‡å®šçš„èŠ‚ç‚¹ä¼šä»å…¶<strong>åç»§èŠ‚ç‚¹</strong>åŒæ­¥æ•°æ®ã€‚
            </div>
            
            <table>
                <tr>
                    <th>å‚æ•°</th>
                    <th>è¯´æ˜</th>
                    <th>ç¤ºä¾‹</th>
                </tr>
                <tr>
                    <td><code>Node</code></td>
                    <td>è¢«æ·»åŠ çš„èŠ‚ç‚¹ï¼ˆä¼šè§¦å‘æ•°æ®åŒæ­¥ï¼‰</td>
                    <td><code>N1</code></td>
                </tr>
                <tr>
                    <td><code>NodeList</code></td>
                    <td>æ‰€æœ‰æ´»è·ƒèŠ‚ç‚¹åˆ—è¡¨ï¼ˆå«æ–°èŠ‚ç‚¹ï¼‰</td>
                    <td><code>[N1, N2]</code></td>
                </tr>
                <tr>
                    <td><code>NodeOrderList</code></td>
                    <td>å®Œæ•´èŠ‚ç‚¹é¡ºåºåˆ—è¡¨ï¼ˆå«å®•æœºèŠ‚ç‚¹ï¼‰</td>
                    <td><code>[N1, N2, N3]</code></td>
                </tr>
            </table>
        </div>
        
        <!-- æ­£ç¡®æ“ä½œç¤ºä¾‹ -->
        <div class="section">
            <h2 class="section-title">æ­£ç¡®æ“ä½œç¤ºä¾‹</h2>
            
            <div class="two-column">
                <div>
                    <h3 style="color: var(--success-color); margin-bottom: 15px;">âœ… æ­£ç¡®æ–¹å¼</h3>
                    <p><strong>åœºæ™¯ï¼š</strong>N1 æ— æ•°æ®ï¼ŒN2 æœ‰æ•°æ®ï¼Œéœ€è¦ N1 ä» N2 åŒæ­¥</p>
                    
                    <div class="code-block">
<pre><span class="comment">%% æ­¥éª¤1: åœ¨æœ‰æ•°æ®çš„èŠ‚ç‚¹(N2)ä¸Šå»ºç«‹å•èŠ‚ç‚¹é›†ç¾¤</span>
(N2) erlang_craq:<span class="function">setup_repl</span>([N2]).

<span class="comment">%% æ­¥éª¤2: æ·»åŠ æ— æ•°æ®çš„èŠ‚ç‚¹(N1)</span>
<span class="comment">%% å…³é”®: ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ N1ï¼ŒN1 ä¼šä»åç»§(N2)åŒæ­¥æ•°æ®</span>
(ä»»æ„èŠ‚ç‚¹) erlang_craq:<span class="function">add_node</span>(N1, [N1, N2], [N1, N2, N3]).</pre>
                    </div>
                    
                    <div class="success-box">
                        <div>N1 çš„åç»§æ˜¯ N2ï¼Œæ‰€ä»¥ N1 ä¼šä» N2 åŒæ­¥æ•°æ®</div>
                    </div>
                </div>
                
                <div>
                    <h3 style="color: var(--danger-color); margin-bottom: 15px;">âŒ é”™è¯¯æ–¹å¼</h3>
                    <p><strong>åœºæ™¯ï¼š</strong>åŒæ ·çš„æƒ…å†µï¼Œä½†æ“ä½œé¡ºåºé”™è¯¯</p>
                    
                    <div class="code-block">
<pre><span class="comment">%% é”™è¯¯: åœ¨æ— æ•°æ®çš„èŠ‚ç‚¹(N1)ä¸Šå»ºç«‹é›†ç¾¤</span>
(N1) erlang_craq:<span class="function">setup_repl</span>([N1]).

<span class="comment">%% é”™è¯¯: æ·»åŠ çš„æ˜¯ N2ï¼ŒN2 ä¼šä» N1 åŒæ­¥ç©ºæ•°æ®ï¼</span>
(N1) erlang_craq:<span class="function">add_node</span>(N2, [N1, N2], [N1, N2, N3]).</pre>
                    </div>
                    
                    <div class="error-box">
                        <div>N2 çš„åç»§æ˜¯ N1ï¼ŒN2 ä» N1 åŒæ­¥åˆ°ç©ºæ•°æ®ï¼ŒåŸæœ‰æ•°æ®ä¸¢å¤±ï¼</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å®é™…æ—¥å¿—ç¤ºä¾‹ -->
        <div class="section">
            <h2 class="section-title">å®é™…æ—¥å¿—ç¤ºä¾‹</h2>
            
            <h3 style="margin-bottom: 15px;">N2 èŠ‚ç‚¹æ—¥å¿—ï¼ˆæœ‰æ•°æ®ï¼Œå…ˆæ‰§è¡Œ setup_replï¼‰</h3>
            <div class="log-block">
<span class="log-time">01:12:00.519</span> [<span class="log-level">info</span>] [<span class="log-module">eh_system_server</span>] "<span class="log-key">setup_repl.99</span>" <span class="log-key">node_status</span>=<span class="log-value">"ready"</span>, <span class="log-key">node_id</span>=<span class="log-value">"ec_n2"</span>, <span class="log-key">repl_ring</span>=<span class="log-value">"ec_n2"</span>, <span class="log-key">timestamp</span>=<span class="log-value">6</span>
<span class="log-time">01:12:47.823</span> [<span class="log-level">info</span>] [<span class="log-module">eh_system_server</span>] "<span class="log-key">add_node.99</span>" <span class="log-key">node_status</span>=<span class="log-value">"ready"</span>, <span class="log-key">node_id</span>=<span class="log-value">"ec_n2"</span>, <span class="log-key">repl_ring</span>=<span class="log-value">"ec_n1,ec_n2"</span>
<span class="log-time">01:12:47.825</span> [<span class="log-level">info</span>] [<span class="log-module">eh_system_server</span>] "<span class="log-key">snapshot.99</span>" <span class="log-key">node_status</span>=<span class="log-value">"ready"</span>  â† N2 æ”¶åˆ° N1 çš„å¿«ç…§è¯·æ±‚ï¼Œè¿”å›å¢é‡æ•°æ®
            </div>
            
            <h3 style="margin: 20px 0 15px 0;">N1 èŠ‚ç‚¹æ—¥å¿—ï¼ˆæ— æ•°æ®ï¼Œæ‰§è¡Œ add_nodeï¼‰</h3>
            <div class="log-block">
<span class="log-time">01:12:47.801</span> [<span class="log-level">info</span>] [<span class="log-module">eh_system_server</span>] "<span class="log-key">add_node.99</span>" <span class="log-key">node_status</span>=<span class="log-value">"transient"</span>  â† çŠ¶æ€å˜ä¸º TRANSIENTï¼Œç­‰å¾…æ•°æ®åŒæ­¥
<span class="log-time">01:12:47.823</span> [<span class="log-level">info</span>] [<span class="log-module">eh_system_server</span>] "<span class="log-key">update_snapshot.99</span>" <span class="log-key">node_status</span>=<span class="log-value">"transient_data_updated"</span>  â† æ•°æ®åŒæ­¥å®Œæˆ
            </div>
            
            <h3 style="margin: 20px 0 15px 0;">æ•°æ®æ–‡ä»¶éªŒè¯</h3>
            <div class="code-block">
<pre><span class="comment"># åŒæ­¥å‰ N1 æ•°æ®æ–‡ä»¶ä¸ºç©º</span>
$ ls -lh ec_n1_repl.data.*
-rw-r--r--. 1 user user   0 Jan  3 22:16 ec_n1_repl.data.0000000001
-rw-r--r--. 1 user user   0 Jan  3 23:01 ec_n1_repl.data.0000000002

<span class="comment"># åŒæ­¥å N1 æ•°æ®æ–‡ä»¶æœ‰å†…å®¹</span>
$ ls -lh ec_n1_repl.data.*
-rw-r--r--. 1 user user   0 Jan  3 22:16 ec_n1_repl.data.0000000001
-rw-r--r--. 1 user user   0 Jan  3 23:01 ec_n1_repl.data.0000000002
-rw-r--r--. 1 user user <span class="string">908</span> Jan  4 01:12 ec_n1_repl.data.0000000003  â† åŒæ­¥çš„æ•°æ®</pre>
            </div>
        </div>
        
        <!-- å®Œæ•´æµç¨‹å›¾ -->
        <div class="section">
            <h2 class="section-title">å®Œæ•´æ•°æ®åŒæ­¥æµç¨‹</h2>
            
            <div class="flow-diagram">
                <div class="flow-content">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           add_node(N1, [N1,N2], [N1,N2,N3]) æ•°æ®åŒæ­¥æµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                 â”‚
â”‚   <span class="highlight-new">N1 (æ–°èŠ‚ç‚¹, æ— æ•°æ®)</span>                                    <span class="highlight-existing">N2 (å·²æœ‰èŠ‚ç‚¹, æœ‰æ•°æ®)</span>                â”‚
â”‚   çŠ¶æ€: NOT_READY                                      çŠ¶æ€: READY                              â”‚
â”‚                                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ <span class="highlight-state">æ­¥éª¤1: æ”¶åˆ° EH_ADD_NODE æ¶ˆæ¯</span>                                                          â”‚   â”‚
â”‚   â”‚                                                                                         â”‚   â”‚
â”‚   â”‚ N1: valid_add_node_msg(N1, State)                  N2: valid_add_node_msg(N1, State)    â”‚   â”‚
â”‚   â”‚     Node=N1, NodeId=N1 â†’ true                          Node=N1, NodeId=N2 â†’ false       â”‚   â”‚
â”‚   â”‚     msg_state=NOT_READY                                msg_state=READY                  â”‚   â”‚
â”‚   â”‚     N1 âˆ‰ ReplRing â†’ false                              N1 âˆ‰ ReplRing â†’ false            â”‚   â”‚
â”‚   â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”‚   â”‚
â”‚   â”‚     ç»“æœ: <span class="highlight-new">EH_VALID_FOR_NEW</span> âœ“                           ç»“æœ: <span class="highlight-existing">EH_VALID_FOR_EXISTING</span>      â”‚   â”‚
â”‚   â”‚     â†’ è§¦å‘æ•°æ®åŒæ­¥                                     â†’ ä¸è§¦å‘åŒæ­¥                       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                                         â”‚
â”‚       â–¼                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ <span class="highlight-state">æ­¥éª¤2: process_snapshot_request()</span>                                                       â”‚   â”‚
â”‚   â”‚                                                                                         â”‚   â”‚
â”‚   â”‚ â€¢ è·å–æœ¬åœ°æ—¶é—´æˆ³: {Timestamp=0, DataIndexList=[]} = ReplDataManager:timestamp()         â”‚   â”‚
â”‚   â”‚ â€¢ ç”Ÿæˆå”¯ä¸€å¼•ç”¨: SnapshotRef = UniqueIdGenerator:unique_id()                             â”‚   â”‚
â”‚   â”‚ â€¢ çŠ¶æ€è½¬æ¢: NOT_READY â†’ <span class="highlight-state">TRANSIENT</span>                                                    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                                         â”‚
â”‚       â”‚  <span class="highlight-msg">EH_SNAPSHOT {NodeId=N1, NodeList, NodeOrderList, SnapshotRef, {Timestamp=0, DIL=[]}}</span>    â”‚
â”‚       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
â”‚       â”‚                                                                                         â”‚
â”‚       â”‚                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚       â”‚                                â”‚ <span class="highlight-state">æ­¥éª¤3: N2 å¤„ç† EH_SNAPSHOT è¯·æ±‚</span>                   â”‚   â”‚
â”‚       â”‚                                â”‚                                                    â”‚   â”‚
â”‚       â”‚                                â”‚ Q0 = ReplDataManager:snapshot(0, [])              â”‚   â”‚
â”‚       â”‚                                â”‚                                                    â”‚   â”‚
â”‚       â”‚                                â”‚ éå†æœ¬åœ°æ‰€æœ‰æ•°æ®ï¼Œè¿‡æ»¤å‡ºå¢é‡æ•°æ®:                    â”‚   â”‚
â”‚       â”‚                                â”‚ â€¢ æ•°æ®æ—¶é—´æˆ³ > 0 â†’ éœ€è¦åŒæ­¥                        â”‚   â”‚
â”‚       â”‚                                â”‚ â€¢ æ•°æ®æ—¶é—´æˆ³ = 0 ä¸” DataIndex æ›´å¤§ â†’ éœ€è¦åŒæ­¥      â”‚   â”‚
â”‚       â”‚                                â”‚                                                    â”‚   â”‚
â”‚       â”‚                                â”‚ PendingPreMsgMap = è¿‡æ»¤æ­£åœ¨å¤„ç†çš„å†™è¯·æ±‚            â”‚   â”‚
â”‚       â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                        â”‚                                                â”‚
â”‚       â”‚  <span class="highlight-msg">EH_UPDATE_SNAPSHOT {SnapshotRef, Q0(å¢é‡æ•°æ®é˜Ÿåˆ—), PendingPreMsgMap}</span>                    â”‚
â”‚       â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚       â”‚                                                                                         â”‚
â”‚       â–¼                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ <span class="highlight-state">æ­¥éª¤4: N1 æ”¶åˆ° EH_UPDATE_SNAPSHOT</span>                                                       â”‚   â”‚
â”‚   â”‚                                                                                         â”‚   â”‚
â”‚   â”‚ â€¢ éªŒè¯ SnapshotRef åŒ¹é…                                                                 â”‚   â”‚
â”‚   â”‚ â€¢ ReplDataManager:update_snapshot(Q0)  â† åˆå¹¶å¢é‡æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨                         â”‚   â”‚
â”‚   â”‚ â€¢ éªŒè¯ PendingPreMsgData æœ‰æ•ˆæ€§                                                         â”‚   â”‚
â”‚   â”‚ â€¢ çŠ¶æ€è½¬æ¢: TRANSIENT â†’ <span class="highlight-state">TRANSIENT_DU</span> (Data Updated)                                â”‚   â”‚
â”‚   â”‚ â€¢ æ•°æ®å†™å…¥ç£ç›˜æ–‡ä»¶                                                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                                 â”‚
â”‚   <span class="highlight-new">N1 çŠ¶æ€: TRANSIENT_DU (æ•°æ®å·²åŒæ­¥ï¼Œç­‰å¾…æ¶ˆæ¯æ›´æ–°)</span>                                            â”‚
â”‚   åç»­æ”¶åˆ°å†™æ¶ˆæ¯åçŠ¶æ€ä¼šå˜ä¸º READY                                                               â”‚
â”‚                                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                </div>
            </div>
        </div>
        
        <!-- èŠ‚ç‚¹çŠ¶æ€è½¬æ¢ -->
        <div class="section">
            <h2 class="section-title">èŠ‚ç‚¹çŠ¶æ€è½¬æ¢</h2>
            
            <div class="state-machine">
                <div class="state-box state-not-ready">NOT_READY<br><small>åˆå§‹çŠ¶æ€</small></div>
                <div class="state-arrow">â†’<br><small>add_node</small></div>
                <div class="state-box state-transient">TRANSIENT<br><small>ç­‰å¾…æ•°æ®+æ¶ˆæ¯</small></div>
                <div class="state-arrow">â†’<br><small>æ”¶åˆ°snapshot</small></div>
                <div class="state-box state-transient">TRANSIENT_DU<br><small>æ•°æ®å·²æ›´æ–°</small></div>
                <div class="state-arrow">â†’<br><small>æ”¶åˆ°æ¶ˆæ¯</small></div>
                <div class="state-box state-ready">READY<br><small>å°±ç»ª</small></div>
            </div>
            
            <div class="code-block">
<pre><span class="comment">%% eh_node_state.erl - çŠ¶æ€è½¬æ¢é€»è¾‘</span>

<span class="comment">%% æ”¶åˆ°å¿«ç…§æ•°æ®åçš„çŠ¶æ€è½¬æ¢</span>
<span class="function">update_state_snapshot</span>(#eh_system_state{node_status=<span class="atom">?EH_TRANSIENT</span>}=State) ->
  update_state(<span class="atom">?EH_TRANSIENT_DU</span>, State);    <span class="comment">%% TRANSIENT â†’ TRANSIENT_DU</span>
<span class="function">update_state_snapshot</span>(#eh_system_state{node_status=<span class="atom">?EH_TRANSIENT_TU</span>}=State) ->
  update_state(<span class="atom">?EH_READY</span>, State);            <span class="comment">%% TRANSIENT_TU â†’ READY</span>

<span class="comment">%% æ”¶åˆ°æ¶ˆæ¯åçš„çŠ¶æ€è½¬æ¢</span>
<span class="function">update_state_msg</span>(#eh_system_state{node_status=<span class="atom">?EH_TRANSIENT</span>}=State) ->
  update_state(<span class="atom">?EH_TRANSIENT_TU</span>, State);    <span class="comment">%% TRANSIENT â†’ TRANSIENT_TU</span>
<span class="function">update_state_msg</span>(#eh_system_state{node_status=<span class="atom">?EH_TRANSIENT_DU</span>}=State) ->
  update_state(<span class="atom">?EH_READY</span>, State);            <span class="comment">%% TRANSIENT_DU â†’ READY</span></pre>
            </div>
            
            <table>
                <tr>
                    <th>çŠ¶æ€</th>
                    <th>å«ä¹‰</th>
                    <th>å¯æ¥æ”¶è¯»è¯·æ±‚</th>
                    <th>å¯æ¥æ”¶å†™è¯·æ±‚</th>
                </tr>
                <tr>
                    <td><code>NOT_READY</code></td>
                    <td>åˆå§‹çŠ¶æ€ï¼ŒæœªåŠ å…¥é›†ç¾¤</td>
                    <td>âŒ</td>
                    <td>âŒ</td>
                </tr>
                <tr>
                    <td><code>TRANSIENT</code></td>
                    <td>å·²åŠ å…¥é›†ç¾¤ï¼Œç­‰å¾…æ•°æ®å’Œæ¶ˆæ¯åŒæ­¥</td>
                    <td>âŒ</td>
                    <td>âœ… (ç¼“å­˜)</td>
                </tr>
                <tr>
                    <td><code>TRANSIENT_DU</code></td>
                    <td>æ•°æ®å·²åŒæ­¥ï¼Œç­‰å¾…æ¶ˆæ¯åŒæ­¥</td>
                    <td>âœ…</td>
                    <td>âœ…</td>
                </tr>
                <tr>
                    <td><code>TRANSIENT_TU</code></td>
                    <td>æ¶ˆæ¯å·²åŒæ­¥ï¼Œç­‰å¾…æ•°æ®åŒæ­¥</td>
                    <td>âŒ</td>
                    <td>âœ…</td>
                </tr>
                <tr>
                    <td><code>READY</code></td>
                    <td>å®Œå…¨å°±ç»ª</td>
                    <td>âœ…</td>
                    <td>âœ…</td>
                </tr>
            </table>
        </div>
        
        <!-- å¢é‡æ•°æ®è¿‡æ»¤é€»è¾‘ -->
        <div class="section">
            <h2 class="section-title">å¢é‡æ•°æ®è¿‡æ»¤é€»è¾‘</h2>
            
            <p>å½“åç»§èŠ‚ç‚¹æ”¶åˆ° <code>EH_SNAPSHOT</code> è¯·æ±‚æ—¶ï¼Œä¼šæ ¹æ®è¯·æ±‚æ–¹çš„æ—¶é—´æˆ³è¿‡æ»¤å‡ºéœ€è¦åŒæ­¥çš„å¢é‡æ•°æ®ã€‚</p>
            
            <div class="step-card">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">snapshot_data/3 - éå†æ‰€æœ‰æ•°æ®</div>
                </div>
                <span class="file-location">eh_data_util.erl:75-77</span>
                <div class="code-block">
<pre><span class="function">snapshot_data</span>(<span class="variable">Timestamp</span>, <span class="variable">DataIndexList</span>, <span class="variable">Mi0</span>) ->
  <span class="variable">Acc0</span> = maps:<span class="function">fold</span>(
    <span class="keyword">fun</span>(<span class="variable">K</span>, <span class="variable">Qi0</span>, <span class="variable">Acc</span>) -> 
      <span class="function">process_data</span>(<span class="keyword">fun</span> <span class="function">snapshot_fun</span>/3, <span class="keyword">fun</span> <span class="function">queue_fun</span>/2, 
                   {<span class="variable">Timestamp</span>, <span class="variable">DataIndexList</span>, <span class="variable">K</span>}, <span class="variable">Qi0</span>, <span class="variable">Acc</span>) 
    <span class="keyword">end</span>, [], <span class="variable">Mi0</span>),
  queue:<span class="function">from_list</span>(lists:<span class="function">sort</span>(<span class="keyword">fun</span> <span class="function">sort_fun</span>/2, <span class="variable">Acc0</span>)).</pre>
                </div>
            </div>
            
            <div class="step-card">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">snapshot_fun/3 - è¿‡æ»¤æ¡ä»¶åˆ¤æ–­</div>
                </div>
                <span class="file-location">eh_data_util.erl:57-73</span>
                <div class="code-block">
<pre><span class="comment">%% æƒ…å†µ1: æ•°æ®æ—¶é—´æˆ³ > è¯·æ±‚æ–¹æ—¶é—´æˆ³ â†’ éœ€è¦åŒæ­¥</span>
<span class="function">snapshot_fun</span>({<span class="variable">CTimestamp</span>, _<span class="variable">CDataIndexList</span>, <span class="variable">StorageKey</span>}, 
             #eh_storage_value{timestamp=<span class="variable">Timestamp</span>}=<span class="variable">StorageValue</span>, <span class="variable">Qo0</span>) 
  <span class="keyword">when</span> <span class="variable">Timestamp</span> > <span class="variable">CTimestamp</span> ->
  [<span class="function">storage_data</span>(<span class="variable">StorageKey</span>, <span class="variable">StorageValue</span>) | <span class="variable">Qo0</span>];

<span class="comment">%% æƒ…å†µ2: æ—¶é—´æˆ³ç›¸åŒï¼Œæ¯”è¾ƒ DataIndex</span>
<span class="function">snapshot_fun</span>({<span class="variable">CTimestamp</span>, <span class="variable">CDataIndexList</span>, <span class="variable">StorageKey</span>},
             #eh_storage_value{timestamp=<span class="variable">Timestamp</span>, data_index=<span class="variable">DataIndex</span>}=<span class="variable">StorageValue</span>, <span class="variable">Qo0</span>)
  <span class="keyword">when</span> <span class="variable">Timestamp</span> =:= <span class="variable">CTimestamp</span> ->
  <span class="keyword">case</span> lists:<span class="function">keyfind</span>({<span class="variable">ObjectType</span>, <span class="variable">ObjectId</span>}, 1, <span class="variable">CDataIndexList</span>) <span class="keyword">of</span>
    <span class="atom">false</span>                                       ->
      [<span class="function">storage_data</span>(...) | <span class="variable">Qo0</span>];  <span class="comment">%% è¯·æ±‚æ–¹æ²¡æœ‰æ­¤å¯¹è±¡ â†’ éœ€è¦åŒæ­¥</span>
    {_, <span class="variable">CDataIndex</span>} <span class="keyword">when</span> <span class="variable">DataIndex</span> > <span class="variable">CDataIndex</span> ->
      [<span class="function">storage_data</span>(...) | <span class="variable">Qo0</span>];  <span class="comment">%% ç´¢å¼•æ›´å¤§ â†’ éœ€è¦åŒæ­¥</span>
    _                                           ->
      <span class="variable">Qo0</span>                          <span class="comment">%% å·²æœ‰ â†’ è·³è¿‡</span>
  <span class="keyword">end</span>;

<span class="comment">%% æƒ…å†µ3: æ•°æ®æ—¶é—´æˆ³ < è¯·æ±‚æ–¹æ—¶é—´æˆ³ â†’ ä¸éœ€è¦åŒæ­¥</span>
<span class="function">snapshot_fun</span>(_, _, <span class="variable">Qo0</span>) ->
  <span class="variable">Qo0</span>.</pre>
                </div>
            </div>
            
            <div class="info-box">
                <strong>è¿‡æ»¤é€»è¾‘æ€»ç»“ï¼š</strong>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li>æ•°æ®æ—¶é—´æˆ³ > è¯·æ±‚æ–¹æ—¶é—´æˆ³ â†’ <strong>åŒæ­¥</strong></li>
                    <li>æ•°æ®æ—¶é—´æˆ³ = è¯·æ±‚æ–¹æ—¶é—´æˆ³ ä¸” DataIndex æ›´å¤§ â†’ <strong>åŒæ­¥</strong></li>
                    <li>æ•°æ®æ—¶é—´æˆ³ = è¯·æ±‚æ–¹æ—¶é—´æˆ³ ä½† DataIndex ç›¸åŒæˆ–æ›´å° â†’ <strong>è·³è¿‡</strong></li>
                    <li>æ•°æ®æ—¶é—´æˆ³ < è¯·æ±‚æ–¹æ—¶é—´æˆ³ â†’ <strong>è·³è¿‡</strong></li>
                </ul>
            </div>
        </div>
        
        <!-- æ•°æ®åˆå¹¶é€»è¾‘ -->
        <div class="section">
            <h2 class="section-title">æ•°æ®åˆå¹¶é€»è¾‘</h2>
            
            <p>æ–°èŠ‚ç‚¹æ”¶åˆ°å¢é‡æ•°æ®åï¼Œé€šè¿‡ <code>merge_data/4</code> å°†æ•°æ®åˆå¹¶åˆ°æœ¬åœ°å­˜å‚¨ã€‚</p>
            
            <span class="file-location">eh_data_util.erl:163-179</span>
            <div class="code-block">
<pre><span class="function">merge_data</span>(<span class="variable">Q0</span>, <span class="variable">TQ0</span>, {<span class="variable">StateTimestamp</span>, <span class="variable">StateDataIndexList</span>}, <span class="variable">M0</span>) ->
  <span class="comment">%% å…ˆåˆå¹¶å¿«ç…§æ•°æ® Q0</span>
  {<span class="variable">TS1</span>, <span class="variable">DIL1</span>, <span class="variable">Q1</span>, <span class="variable">M1</span>} = <span class="function">merge_data_acc</span>(<span class="variable">Q0</span>, queue:<span class="function">new</span>(), <span class="variable">M0</span>, <span class="variable">StateTimestamp</span>, <span class="variable">StateDataIndexList</span>, <span class="atom">true</span>),
  <span class="comment">%% å†åˆå¹¶ä¸´æ—¶æ•°æ® TQ0 (TRANSIENT æœŸé—´ç¼“å­˜çš„å†™è¯·æ±‚)</span>
  <span class="function">merge_data_acc</span>(<span class="variable">TQ0</span>, <span class="variable">Q1</span>, <span class="variable">M1</span>, <span class="variable">TS1</span>, <span class="variable">DIL1</span>, <span class="atom">true</span>).

<span class="function">merge_data_acc</span>(<span class="variable">Qi0</span>, <span class="variable">Qo0</span>, <span class="variable">Mi0</span>, <span class="variable">TS0</span>, <span class="variable">DIL0</span>, <span class="variable">CheckFlag</span>) ->
  <span class="keyword">case</span> queue:<span class="function">out</span>(<span class="variable">Qi0</span>) <span class="keyword">of</span>
    {<span class="atom">empty</span>, _} -> 
      {<span class="variable">TS0</span>, <span class="variable">DIL0</span>, <span class="variable">Qo0</span>, <span class="variable">Mi0</span>};
    {{<span class="atom">value</span>, <span class="variable">StorageData</span>}, <span class="variable">Qi1</span>} ->
      <span class="keyword">case</span> (<span class="keyword">not</span> <span class="variable">CheckFlag</span>) <span class="keyword">orelse</span> (<span class="variable">StorageData</span>#eh_storage_data.timestamp > <span class="variable">TS0</span>) <span class="keyword">of</span>
        <span class="atom">true</span>  ->
          <span class="comment">%% æ•°æ®æ—¶é—´æˆ³æ›´å¤§ï¼Œæ·»åŠ åˆ°æœ¬åœ°å­˜å‚¨</span>
          {_, {_, <span class="variable">DIL1</span>}, <span class="variable">Qo1</span>, <span class="variable">Mi1</span>} = <span class="function">add_data</span>(<span class="variable">StorageData</span>, <span class="variable">Qo0</span>, {<span class="variable">TS0</span>, <span class="variable">DIL0</span>}, <span class="variable">Mi0</span>),
          <span class="function">merge_data_acc</span>(<span class="variable">Qi1</span>, <span class="variable">Qo1</span>, <span class="variable">Mi1</span>, <span class="variable">StorageData</span>#eh_storage_data.timestamp, <span class="variable">DIL1</span>, <span class="atom">false</span>);
        <span class="atom">false</span> ->
          <span class="comment">%% æ•°æ®æ—¶é—´æˆ³ä¸å¤Ÿæ–°ï¼Œè·³è¿‡</span>
          <span class="function">merge_data_acc</span>(<span class="variable">Qi1</span>, <span class="variable">Qo0</span>, <span class="variable">Mi0</span>, <span class="variable">TS0</span>, <span class="variable">DIL0</span>, <span class="variable">CheckFlag</span>)
      <span class="keyword">end</span>
  <span class="keyword">end</span>.</pre>
            </div>
        </div>
        
        <!-- å…³é”®ä»£ç ä½ç½® -->
        <div class="section">
            <h2 class="section-title">å…³é”®ä»£ç ä½ç½®</h2>
            
            <table>
                <tr>
                    <th>åŠŸèƒ½</th>
                    <th>å‡½æ•°</th>
                    <th>æ–‡ä»¶:è¡Œå·</th>
                </tr>
                <tr>
                    <td>åˆ¤æ–­æ˜¯å¦è§¦å‘åŒæ­¥</td>
                    <td><code>valid_add_node_msg/2</code></td>
                    <td><code>eh_node_timestamp.erl:96-105</code></td>
                </tr>
                <tr>
                    <td>å‘èµ·å¿«ç…§è¯·æ±‚</td>
                    <td><code>process_snapshot_request/4</code></td>
                    <td><code>eh_system_server.erl:402-409</code></td>
                </tr>
                <tr>
                    <td>å¤„ç†å¿«ç…§è¯·æ±‚</td>
                    <td><code>handle_cast({EH_SNAPSHOT, ...})</code></td>
                    <td><code>eh_system_server.erl:112-123</code></td>
                </tr>
                <tr>
                    <td>è¿‡æ»¤å¢é‡æ•°æ®</td>
                    <td><code>snapshot_data/3</code>, <code>snapshot_fun/3</code></td>
                    <td><code>eh_data_util.erl:75-77, 57-73</code></td>
                </tr>
                <tr>
                    <td>æ¥æ”¶å¹¶åˆå¹¶æ•°æ®</td>
                    <td><code>handle_cast({EH_UPDATE_SNAPSHOT, ...})</code></td>
                    <td><code>eh_system_server.erl:125-138</code></td>
                </tr>
                <tr>
                    <td>åˆå¹¶æ•°æ®åˆ°æœ¬åœ°</td>
                    <td><code>merge_data/4</code></td>
                    <td><code>eh_data_util.erl:163-165</code></td>
                </tr>
                <tr>
                    <td>çŠ¶æ€è½¬æ¢</td>
                    <td><code>update_state_snapshot/1</code></td>
                    <td><code>eh_node_state.erl:43-48</code></td>
                </tr>
            </table>
        </div>
        
        <!-- å¸¸è§é—®é¢˜ -->
        <div class="section">
            <h2 class="section-title">å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h2>
            
            <div class="warning-box">
                <div>
                    <strong>é—®é¢˜1ï¼šadd_node åæ•°æ®æ²¡æœ‰åŒæ­¥</strong><br>
                    <strong>åŸå› ï¼š</strong><code>add_node(Node, ...)</code> çš„ç¬¬ä¸€ä¸ªå‚æ•° <code>Node</code> å†³å®šäº†è°æ˜¯æ–°èŠ‚ç‚¹ã€‚åªæœ‰æ–°èŠ‚ç‚¹ä¼šä»åç»§åŒæ­¥æ•°æ®ã€‚<br>
                    <strong>è§£å†³ï¼š</strong>ç¡®ä¿ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯éœ€è¦åŒæ­¥æ•°æ®çš„èŠ‚ç‚¹ã€‚
                </div>
            </div>
            
            <div class="warning-box">
                <div>
                    <strong>é—®é¢˜2ï¼šæ•°æ®åŒæ­¥æ–¹å‘é”™è¯¯</strong><br>
                    <strong>åŸå› ï¼š</strong>æ–°èŠ‚ç‚¹ä»å…¶<strong>åç»§èŠ‚ç‚¹</strong>åŒæ­¥æ•°æ®ã€‚å¦‚æœåç»§èŠ‚ç‚¹æ²¡æœ‰æ•°æ®ï¼ŒåŒæ­¥ç»“æœä¸ºç©ºã€‚<br>
                    <strong>è§£å†³ï¼š</strong>ç¡®ä¿æœ‰æ•°æ®çš„èŠ‚ç‚¹å…ˆ <code>setup_repl</code>ï¼Œç„¶åæ·»åŠ æ— æ•°æ®çš„èŠ‚ç‚¹ã€‚
                </div>
            </div>
            
            <div class="warning-box">
                <div>
                    <strong>é—®é¢˜3ï¼šèŠ‚ç‚¹çŠ¶æ€åœç•™åœ¨ NOT_READY</strong><br>
                    <strong>åŸå› ï¼š</strong><code>valid_add_node_msg</code> è¿”å› <code>EH_INVALID_MSG</code>ï¼Œå¯èƒ½æ˜¯èŠ‚ç‚¹å·²åœ¨ <code>repl_ring</code> ä¸­ã€‚<br>
                    <strong>è§£å†³ï¼š</strong>æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€ï¼Œç¡®ä¿èŠ‚ç‚¹æœªåŠ å…¥è¿‡é›†ç¾¤ï¼Œæˆ–é‡å¯èŠ‚ç‚¹åå†æ“ä½œã€‚
                </div>
            </div>
        </div>
        
        <!-- æ€»ç»“ -->
        <div class="section">
            <h2 class="section-title">æ€»ç»“</h2>
            
            <table>
                <tr>
                    <th>è¦ç‚¹</th>
                    <th>è¯´æ˜</th>
                </tr>
                <tr>
                    <td>è§¦å‘æ¡ä»¶</td>
                    <td><code>add_node(Node, ...)</code> ä¸­ <code>Node</code> æ˜¯å½“å‰èŠ‚ç‚¹ä¸”çŠ¶æ€ä¸º <code>NOT_READY</code></td>
                </tr>
                <tr>
                    <td>æ•°æ®æ¥æº</td>
                    <td>æ–°èŠ‚ç‚¹ä»å…¶<strong>åç»§èŠ‚ç‚¹</strong>è·å–å¢é‡æ•°æ®</td>
                </tr>
                <tr>
                    <td>åŒæ­¥å†…å®¹</td>
                    <td>æ—¶é—´æˆ³å¤§äºè¯·æ±‚æ–¹çš„æ‰€æœ‰æ•°æ® + æ­£åœ¨å¤„ç†çš„å†™è¯·æ±‚</td>
                </tr>
                <tr>
                    <td>çŠ¶æ€å˜åŒ–</td>
                    <td><code>NOT_READY â†’ TRANSIENT â†’ TRANSIENT_DU â†’ READY</code></td>
                </tr>
                <tr>
                    <td>æ­£ç¡®æ“ä½œ</td>
                    <td>æœ‰æ•°æ®çš„èŠ‚ç‚¹å…ˆ <code>setup_repl</code>ï¼Œç„¶å <code>add_node</code> æ·»åŠ æ— æ•°æ®èŠ‚ç‚¹</td>
                </tr>
            </table>
            
            <div class="success-box">
                <div>
                    <strong>æœ€ä½³å®è·µï¼š</strong>å§‹ç»ˆè®©æœ‰å®Œæ•´æ•°æ®çš„èŠ‚ç‚¹å…ˆå»ºç«‹é›†ç¾¤ï¼Œç„¶åé€ä¸ªæ·»åŠ å…¶ä»–èŠ‚ç‚¹ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿æ•°æ®æ­£ç¡®åœ°ä»æœ‰æ•°æ®çš„èŠ‚ç‚¹åŒæ­¥åˆ°æ— æ•°æ®çš„èŠ‚ç‚¹ã€‚
                </div>
            </div>
        </div>
        
        <div style="text-align: center; color: #64748b; margin-top: 30px; padding: 20px;">
            <p>æ–‡æ¡£ç”Ÿæˆæ—¶é—´: 2026-01-04 | åŸºäº erlang_craq é¡¹ç›®æºç åˆ†æ</p>
        </div>
    </div>
</body>
</html>
