<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAQ å¿«ç…§ (Snapshot) æœºåˆ¶è¯¦è§£</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            color: #e0e0e0;
            line-height: 1.8;
            padding: 40px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d4ff, #7c3aed, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        
        h2 {
            color: #00d4ff;
            font-size: 1.6em;
            margin: 40px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #00d4ff33;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        h3 {
            color: #7c3aed;
            font-size: 1.3em;
            margin: 30px 0 15px 0;
        }
        
        .concept-box {
            background: linear-gradient(135deg, #1e3a5f 0%, #16213e 100%);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .concept-box h3 {
            margin-top: 0;
            color: #fbbf24;
        }
        
        .highlight-text {
            background: linear-gradient(90deg, #fbbf2433, transparent);
            border-left: 4px solid #fbbf24;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .code-block {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .code-header {
            background: #161b22;
            padding: 10px 15px;
            border-bottom: 1px solid #30363d;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85em;
            color: #7ee787;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .code-header .file-path {
            color: #7ee787;
        }
        
        .code-header .line-info {
            color: #8b949e;
            font-size: 0.9em;
        }
        
        .code-content {
            padding: 15px;
            overflow-x: auto;
        }
        
        .code-content pre {
            margin: 0;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        .code-line {
            display: block;
            padding: 2px 0;
        }
        
        .code-line.highlight {
            background: #fbbf2420;
            border-left: 3px solid #fbbf24;
            margin-left: -15px;
            padding-left: 12px;
        }
        
        .code-line .line-num {
            display: inline-block;
            width: 35px;
            color: #6e7681;
            text-align: right;
            margin-right: 15px;
            user-select: none;
        }
        
        /* è¯­æ³•é«˜äº® */
        .kw { color: #ff7b72; }           /* å…³é”®å­— */
        .fn { color: #d2a8ff; }           /* å‡½æ•°å */
        .var { color: #79c0ff; }          /* å˜é‡ */
        .atom { color: #ffa657; }         /* åŸå­ */
        .str { color: #a5d6ff; }          /* å­—ç¬¦ä¸² */
        .cmt { color: #8b949e; font-style: italic; }  /* æ³¨é‡Š */
        .macro { color: #f778ba; }        /* å® */
        .record { color: #7ee787; }       /* è®°å½• */
        .num { color: #79c0ff; }          /* æ•°å­— */
        
        .flow-diagram {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 30px;
            margin: 25px 0;
        }
        
        .flow-title {
            text-align: center;
            color: #fbbf24;
            font-size: 1.2em;
            margin-bottom: 25px;
        }
        
        .flow-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .flow-step {
            display: flex;
            align-items: flex-start;
            gap: 20px;
        }
        
        .step-num {
            background: linear-gradient(135deg, #7c3aed, #00d4ff);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .step-content {
            flex: 1;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
        }
        
        .step-title {
            color: #00d4ff;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .step-desc {
            color: #8b949e;
            font-size: 0.95em;
        }
        
        .step-code {
            background: #161b22;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-family: 'Monaco', monospace;
            font-size: 0.85em;
            color: #d2a8ff;
        }
        
        .arrow-down {
            text-align: center;
            color: #fbbf24;
            font-size: 1.5em;
            margin: 5px 0 5px 18px;
        }
        
        .data-structure {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .data-structure h4 {
            color: #7ee787;
            margin-bottom: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid #30363d;
        }
        
        th {
            background: #161b22;
            color: #00d4ff;
            font-weight: 600;
        }
        
        td {
            background: #0d1117;
        }
        
        td code {
            background: #161b22;
            padding: 2px 6px;
            border-radius: 4px;
            color: #d2a8ff;
            font-size: 0.9em;
        }
        
        .state-diagram {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 30px;
            margin: 25px 0;
            text-align: center;
        }
        
        .state-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .state-box {
            background: #0d1117;
            border: 2px solid #30363d;
            border-radius: 8px;
            padding: 15px 25px;
            min-width: 150px;
        }
        
        .state-box.active {
            border-color: #7ee787;
            box-shadow: 0 0 15px #7ee78733;
        }
        
        .state-box.transient {
            border-color: #fbbf24;
            box-shadow: 0 0 15px #fbbf2433;
        }
        
        .state-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .state-desc {
            color: #8b949e;
            font-size: 0.85em;
        }
        
        .state-arrow {
            color: #00d4ff;
            font-size: 1.5em;
        }
        
        .summary-box {
            background: linear-gradient(135deg, #1a4a3a 0%, #16213e 100%);
            border: 1px solid #7ee787;
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
        }
        
        .summary-box h3 {
            color: #7ee787;
            margin-top: 0;
        }
        
        .summary-list {
            list-style: none;
            padding: 0;
        }
        
        .summary-list li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }
        
        .summary-list li::before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #7ee787;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¸ CRAQ å¿«ç…§ (Snapshot) æœºåˆ¶è¯¦è§£</h1>
        <p class="subtitle">æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ—¶çš„æ•°æ®åŒæ­¥æœºåˆ¶ | åŸºäºæºç æ·±åº¦åˆ†æ</p>

        <!-- ========== æ¦‚å¿µè§£é‡Š ========== -->
        <h2><span>ğŸ¯</span> ä¸€ã€ä»€ä¹ˆæ˜¯å¿«ç…§ (Snapshot)?</h2>
        
        <div class="concept-box">
            <h3>ğŸ“Œ æ ¸å¿ƒå®šä¹‰</h3>
            <p>åœ¨ CRAQ ç³»ç»Ÿä¸­ï¼Œ<strong>å¿«ç…§ (Snapshot)</strong> æ˜¯æŒ‡æŸä¸ªæ—¶é—´ç‚¹çš„<strong>å®Œæ•´æ•°æ®çŠ¶æ€å‰¯æœ¬</strong>ã€‚å½“æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ—¶ï¼Œéœ€è¦ä»ç°æœ‰èŠ‚ç‚¹è·å–å¿«ç…§æ¥åŒæ­¥æ•°æ®ï¼Œä»¥ç¡®ä¿æ–°èŠ‚ç‚¹æ‹¥æœ‰ä¸é›†ç¾¤ä¸€è‡´çš„æ•°æ®è§†å›¾ã€‚</p>
            
            <div class="highlight-text">
                <strong>ğŸ”¥ å¿«ç…§çš„æœ¬è´¨ï¼š</strong>å¿«ç…§ = æ—¶é—´æˆ³ (Timestamp) + æ•°æ®ç´¢å¼•åˆ—è¡¨ (DataIndexList)<br>
                å®ƒæ ‡è¯†äº†æ•°æ®çš„"ç‰ˆæœ¬è¾¹ç•Œ"ï¼Œç”¨äºç¡®å®šå“ªäº›æ•°æ®éœ€è¦åŒæ­¥ç»™æ–°èŠ‚ç‚¹ã€‚
            </div>
        </div>

        <div class="concept-box">
            <h3>ğŸ“Œ å¿«ç…§çš„ç»„æˆ</h3>
            <table>
                <tr>
                    <th>ç»„ä»¶</th>
                    <th>ç±»å‹</th>
                    <th>è¯´æ˜</th>
                </tr>
                <tr>
                    <td><code>Timestamp</code></td>
                    <td><code>non_neg_integer()</code></td>
                    <td>æ•°æ®ç‰ˆæœ¬æ—¶é—´æˆ³ï¼Œæ ‡è¯†æ•°æ®çš„é€»è¾‘æ—¶é—´ç‚¹</td>
                </tr>
                <tr>
                    <td><code>DataIndexList</code></td>
                    <td><code>[{{ObjectType, ObjectId}, DataIndex}]</code></td>
                    <td>æ¯ä¸ªå¯¹è±¡åœ¨è¯¥æ—¶é—´æˆ³ä¸‹çš„æ•°æ®ç´¢å¼•ï¼Œç”¨äºç²¾ç¡®å®šä½æ•°æ®ç‰ˆæœ¬</td>
                </tr>
            </table>
        </div>

        <!-- ========== ä½¿ç”¨åœºæ™¯ ========== -->
        <h2><span>ğŸ”„</span> äºŒã€å¿«ç…§çš„ä½¿ç”¨åœºæ™¯</h2>
        
        <h3>åœºæ™¯1ï¼šæ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</h3>
        <div class="flow-diagram">
            <div class="flow-title">ğŸ“ æ–°èŠ‚ç‚¹åŠ å…¥æ—¶çš„å¿«ç…§åŒæ­¥æµç¨‹</div>
            <div class="flow-steps">
                <div class="flow-step">
                    <div class="step-num">1</div>
                    <div class="step-content">
                        <div class="step-title">æ–°èŠ‚ç‚¹å‘èµ·åŠ å…¥è¯·æ±‚</div>
                        <div class="step-desc">æ–°èŠ‚ç‚¹ (å¦‚ Node4) å‘é›†ç¾¤å¹¿æ’­ <code>EH_ADD_NODE</code> æ¶ˆæ¯</div>
                        <div class="step-code">erlang_craq:add_node(Node4, [Node1, Node2, Node3])</div>
                    </div>
                </div>
                
                <div class="arrow-down">â¬‡ï¸</div>
                
                <div class="flow-step">
                    <div class="step-num">2</div>
                    <div class="step-content">
                        <div class="step-title">ç°æœ‰èŠ‚ç‚¹å¤„ç†åŠ å…¥è¯·æ±‚</div>
                        <div class="step-desc">æ–°èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ (Successor) æ”¶åˆ°è¯·æ±‚ï¼Œè°ƒç”¨ <code>process_snapshot_request</code></div>
                        <div class="step-code">process_snapshot_request(NodeList, NodeOrderList, Succ, State)</div>
                    </div>
                </div>
                
                <div class="arrow-down">â¬‡ï¸</div>
                
                <div class="flow-step">
                    <div class="step-num">3</div>
                    <div class="step-content">
                        <div class="step-title">è·å–å½“å‰å¿«ç…§</div>
                        <div class="step-desc">åç»§èŠ‚ç‚¹è·å–è‡ªå·±çš„å½“å‰æ—¶é—´æˆ³å’Œæ•°æ®ç´¢å¼•ä½œä¸ºå¿«ç…§</div>
                        <div class="step-code">{Timestamp, Snapshot} = ReplDataManager:timestamp()</div>
                    </div>
                </div>
                
                <div class="arrow-down">â¬‡ï¸</div>
                
                <div class="flow-step">
                    <div class="step-num">4</div>
                    <div class="step-content">
                        <div class="step-title">å‘é€å¿«ç…§ç»™æ–°èŠ‚ç‚¹</div>
                        <div class="step-desc">å°†å¿«ç…§æ•°æ®å‘é€ç»™æ–°èŠ‚ç‚¹</div>
                        <div class="step-code">gen_server:cast({eh_system_server, NewNode}, {eh_snapshot, {...}})</div>
                    </div>
                </div>
                
                <div class="arrow-down">â¬‡ï¸</div>
                
                <div class="flow-step">
                    <div class="step-num">5</div>
                    <div class="step-content">
                        <div class="step-title">æ–°èŠ‚ç‚¹æ¥æ”¶å¹¶å¤„ç†å¿«ç…§</div>
                        <div class="step-desc">æ–°èŠ‚ç‚¹å°†å¿«ç…§æ•°æ®åˆå¹¶åˆ°æœ¬åœ°å­˜å‚¨ï¼Œå®Œæˆæ•°æ®åŒæ­¥</div>
                        <div class="step-code">ReplDataManager:update_snapshot(Q0)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== æ ¸å¿ƒä»£ç  ========== -->
        <h2><span>ğŸ’»</span> ä¸‰ã€æ ¸å¿ƒä»£ç å®ç°</h2>

        <h3>3.1 å‘èµ·å¿«ç…§è¯·æ±‚</h3>
        <div class="code-block">
            <div class="code-header">
                <span class="file-path">ğŸ“„ src/eh_system_server.erl</span>
                <span class="line-info">Lines 402-409</span>
            </div>
            <div class="code-content">
<pre>
<span class="code-line"><span class="line-num">402</span><span class="fn">process_snapshot_request</span>(<span class="var">NodeList</span>, <span class="var">NodeOrderList</span>, <span class="var">Succ</span>,</span>
<span class="code-line"><span class="line-num">403</span>                         <span class="record">#eh_system_state</span>{<span class="atom">app_config</span>=<span class="var">AppConfig</span>}=<span class="var">State</span>) -></span>
<span class="code-line"><span class="line-num">404</span>    <span class="var">NodeId</span> = <span class="fn">eh_system_config:get_node_id</span>(<span class="var">AppConfig</span>),</span>
<span class="code-line"><span class="line-num">405</span>    <span class="var">UniqueIdGenerator</span> = <span class="fn">eh_system_config:get_unique_id_generator</span>(<span class="var">AppConfig</span>),</span>
<span class="code-line"><span class="line-num">406</span>    <span class="var">ReplDataManager</span> = <span class="fn">eh_system_config:get_repl_data_manager</span>(<span class="var">AppConfig</span>),</span>
<span class="code-line highlight"><span class="line-num">407</span>    <span class="cmt">%% ğŸ”¥ ç”Ÿæˆå”¯ä¸€çš„å¿«ç…§å¼•ç”¨ID</span></span>
<span class="code-line highlight"><span class="line-num">408</span>    <span class="var">SnapshotRef</span> = <span class="var">UniqueIdGenerator</span>:<span class="fn">unique_id</span>(),</span>
<span class="code-line highlight"><span class="line-num">409</span>    <span class="cmt">%% ğŸ”¥ è·å–å½“å‰æ—¶é—´æˆ³å’Œæ•°æ®ç´¢å¼• (è¿™å°±æ˜¯å¿«ç…§!)</span></span>
<span class="code-line highlight"><span class="line-num">410</span>    {<span class="var">Timestamp</span>, <span class="var">Snapshot</span>} = <span class="var">ReplDataManager</span>:<span class="fn">timestamp</span>(),</span>
<span class="code-line highlight"><span class="line-num">411</span>    <span class="cmt">%% ğŸ”¥ å‘é€å¿«ç…§ç»™æ–°èŠ‚ç‚¹çš„åç»§</span></span>
<span class="code-line highlight"><span class="line-num">412</span>    <span class="fn">gen_server:cast</span>({<span class="macro">?EH_SYSTEM_SERVER</span>, <span class="var">Succ</span>},</span>
<span class="code-line highlight"><span class="line-num">413</span>        {<span class="macro">?EH_SNAPSHOT</span>, {<span class="var">NodeId</span>, <span class="var">NodeList</span>, <span class="var">NodeOrderList</span>, <span class="var">SnapshotRef</span>, {<span class="var">Timestamp</span>, <span class="var">Snapshot</span>}}}),</span>
<span class="code-line"><span class="line-num">414</span>    <span class="var">State</span><span class="record">#eh_system_state</span>{<span class="atom">snapshot_ref</span>=<span class="var">SnapshotRef</span>}.</span>
</pre>
            </div>
        </div>

        <h3>3.2 å¤„ç†å¿«ç…§è¯·æ±‚ (ç”Ÿæˆå¿«ç…§æ•°æ®)</h3>
        <div class="code-block">
            <div class="code-header">
                <span class="file-path">ğŸ“„ src/eh_system_server.erl</span>
                <span class="line-info">Lines 112-123</span>
            </div>
            <div class="code-content">
<pre>
<span class="code-line"><span class="line-num">112</span><span class="fn">handle_cast</span>({<span class="macro">?EH_SNAPSHOT</span>, {<span class="var">Node</span>, <span class="var">NodeList</span>, <span class="var">NodeOrderList</span>, <span class="var">Ref</span>, {<span class="var">Timestamp</span>, <span class="var">Snapshot</span>}}},</span>
<span class="code-line"><span class="line-num">113</span>            <span class="record">#eh_system_state</span>{<span class="atom">pre_msg_data</span>=<span class="var">PreMsgData</span>, <span class="atom">app_config</span>=<span class="var">AppConfig</span>}=<span class="var">State</span>) -></span>
<span class="code-line"><span class="line-num">114</span>    <span class="var">NodeId</span> = <span class="fn">eh_system_config:get_node_id</span>(<span class="var">AppConfig</span>),</span>
<span class="code-line"><span class="line-num">115</span>    <span class="var">NodeOrder</span> = <span class="fn">eh_system_config:get_node_order</span>(<span class="var">AppConfig</span>),</span>
<span class="code-line"><span class="line-num">116</span>    {<span class="var">NodeList1</span>, <span class="var">NodeOrderList1</span>, <span class="var">Pred1</span>, <span class="var">Succ1</span>} =</span>
<span class="code-line"><span class="line-num">117</span>        <span class="fn">eh_repl_ring:get_ordered_list_pred_succ</span>(<span class="var">NodeId</span>, <span class="var">NodeList</span>, <span class="var">NodeOrderList</span>, <span class="var">NodeOrder</span>),</span>
<span class="code-line"><span class="line-num">118</span>    <span class="var">ReplDataManager</span> = <span class="fn">eh_system_config:get_repl_data_manager</span>(<span class="var">AppConfig</span>),</span>
<span class="code-line highlight"><span class="line-num">119</span>    <span class="cmt">%% ğŸ”¥ æ ¸å¿ƒ: æ ¹æ®å¿«ç…§æ—¶é—´æˆ³æå–éœ€è¦åŒæ­¥çš„æ•°æ®</span></span>
<span class="code-line highlight"><span class="line-num">120</span>    <span class="var">Q0</span> = <span class="var">ReplDataManager</span>:<span class="fn">snapshot</span>(<span class="var">Timestamp</span>, <span class="var">Snapshot</span>),</span>
<span class="code-line"><span class="line-num">121</span>    <span class="cmt">%% è·å–å¾…å¤„ç†çš„é¢„æ›´æ–°æ¶ˆæ¯</span></span>
<span class="code-line"><span class="line-num">122</span>    <span class="var">PendingPreMsgMap</span> = <span class="fn">eh_update_msg:filter_effective_head_node_id</span>(<span class="var">PreMsgData</span>, <span class="var">State</span>),</span>
<span class="code-line highlight"><span class="line-num">123</span>    <span class="cmt">%% ğŸ”¥ å°†å¿«ç…§æ•°æ®å‘é€å›è¯·æ±‚èŠ‚ç‚¹</span></span>
<span class="code-line highlight"><span class="line-num">124</span>    <span class="fn">gen_server:cast</span>({<span class="macro">?EH_SYSTEM_SERVER</span>, <span class="var">Node</span>},</span>
<span class="code-line highlight"><span class="line-num">125</span>        {<span class="macro">?EH_UPDATE_SNAPSHOT</span>, {<span class="var">Ref</span>, <span class="var">Q0</span>, <span class="var">PendingPreMsgMap</span>}}),</span>
<span class="code-line"><span class="line-num">126</span>    <span class="var">NewState2</span> = <span class="var">State</span><span class="record">#eh_system_state</span>{...},</span>
<span class="code-line"><span class="line-num">127</span>    {<span class="kw">noreply</span>, <span class="var">NewState2</span>};</span>
</pre>
            </div>
        </div>

        <h3>3.3 å¿«ç…§æ•°æ®æå–ç®—æ³•</h3>
        <div class="code-block">
            <div class="code-header">
                <span class="file-path">ğŸ“„ src/eh_data_util.erl</span>
                <span class="line-info">Lines 57-77</span>
            </div>
            <div class="code-content">
<pre>
<span class="code-line"><span class="line-num">57</span><span class="cmt">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span class="code-line"><span class="line-num">58</span><span class="cmt">%% å¿«ç…§è¿‡æ»¤å‡½æ•°: å†³å®šå“ªäº›æ•°æ®éœ€è¦åŒ…å«åœ¨å¿«ç…§ä¸­</span></span>
<span class="code-line"><span class="line-num">59</span><span class="cmt">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span class="code-line"><span class="line-num">60</span></span>
<span class="code-line highlight"><span class="line-num">61</span><span class="cmt">%% æƒ…å†µ1: æ•°æ®æ—¶é—´æˆ³ > å¿«ç…§æ—¶é—´æˆ³ â†’ éœ€è¦åŒæ­¥</span></span>
<span class="code-line highlight"><span class="line-num">62</span><span class="fn">snapshot_fun</span>({<span class="var">CTimestamp</span>, _<span class="var">CDataIndexList</span>, <span class="var">StorageKey</span>},</span>
<span class="code-line highlight"><span class="line-num">63</span>             <span class="record">#eh_storage_value</span>{<span class="atom">timestamp</span>=<span class="var">Timestamp</span>}=<span class="var">StorageValue</span>, <span class="var">Qo0</span>)</span>
<span class="code-line highlight"><span class="line-num">64</span>  <span class="kw">when</span> <span class="var">Timestamp</span> > <span class="var">CTimestamp</span> -></span>
<span class="code-line highlight"><span class="line-num">65</span>    [<span class="fn">storage_data</span>(<span class="var">StorageKey</span>, <span class="var">StorageValue</span>) | <span class="var">Qo0</span>];</span>
<span class="code-line"><span class="line-num">66</span></span>
<span class="code-line highlight"><span class="line-num">67</span><span class="cmt">%% æƒ…å†µ2: æ—¶é—´æˆ³ç›¸ç­‰ï¼Œæ¯”è¾ƒæ•°æ®ç´¢å¼•</span></span>
<span class="code-line highlight"><span class="line-num">68</span><span class="fn">snapshot_fun</span>({<span class="var">CTimestamp</span>, <span class="var">CDataIndexList</span>,</span>
<span class="code-line highlight"><span class="line-num">69</span>              <span class="record">#eh_storage_key</span>{<span class="atom">object_type</span>=<span class="var">ObjectType</span>, <span class="atom">object_id</span>=<span class="var">ObjectId</span>}=<span class="var">StorageKey</span>},</span>
<span class="code-line highlight"><span class="line-num">70</span>             <span class="record">#eh_storage_value</span>{<span class="atom">timestamp</span>=<span class="var">Timestamp</span>, <span class="atom">data_index</span>=<span class="var">DataIndex</span>}=<span class="var">StorageValue</span>, <span class="var">Qo0</span>)</span>
<span class="code-line highlight"><span class="line-num">71</span>  <span class="kw">when</span> <span class="var">Timestamp</span> =:= <span class="var">CTimestamp</span> -></span>
<span class="code-line"><span class="line-num">72</span>    <span class="kw">case</span> <span class="fn">lists:keyfind</span>({{<span class="var">ObjectType</span>, <span class="var">ObjectId</span>}, <span class="num">1</span>, <span class="var">CDataIndexList</span>) <span class="kw">of</span></span>
<span class="code-line"><span class="line-num">73</span>        <span class="atom">false</span> -></span>
<span class="code-line"><span class="line-num">74</span>            [<span class="fn">storage_data</span>(<span class="var">StorageKey</span>, <span class="var">StorageValue</span>) | <span class="var">Qo0</span>];</span>
<span class="code-line"><span class="line-num">75</span>        {_, <span class="var">CDataIndex</span>} <span class="kw">when</span> <span class="var">DataIndex</span> > <span class="var">CDataIndex</span> -></span>
<span class="code-line"><span class="line-num">76</span>            [<span class="fn">storage_data</span>(<span class="var">StorageKey</span>, <span class="var">StorageValue</span>) | <span class="var">Qo0</span>];</span>
<span class="code-line"><span class="line-num">77</span>        _ -></span>
<span class="code-line"><span class="line-num">78</span>            <span class="var">Qo0</span>  <span class="cmt">%% ä¸éœ€è¦åŒæ­¥</span></span>
<span class="code-line"><span class="line-num">79</span>    <span class="kw">end</span>;</span>
<span class="code-line"><span class="line-num">80</span></span>
<span class="code-line"><span class="line-num">81</span><span class="cmt">%% æƒ…å†µ3: æ•°æ®æ—¶é—´æˆ³ < å¿«ç…§æ—¶é—´æˆ³ â†’ ä¸éœ€è¦åŒæ­¥</span></span>
<span class="code-line"><span class="line-num">82</span><span class="fn">snapshot_fun</span>(_, _, <span class="var">Qo0</span>) -></span>
<span class="code-line"><span class="line-num">83</span>    <span class="var">Qo0</span>.</span>
<span class="code-line"><span class="line-num">84</span></span>
<span class="code-line"><span class="line-num">85</span><span class="cmt">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span class="code-line"><span class="line-num">86</span><span class="cmt">%% ä¸»å‡½æ•°: ç”Ÿæˆå¿«ç…§æ•°æ®é˜Ÿåˆ—</span></span>
<span class="code-line"><span class="line-num">87</span><span class="cmt">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span class="code-line highlight"><span class="line-num">88</span><span class="fn">snapshot_data</span>(<span class="var">Timestamp</span>, <span class="var">DataIndexList</span>, <span class="var">Mi0</span>) -></span>
<span class="code-line highlight"><span class="line-num">89</span>    <span class="cmt">%% éå†æ‰€æœ‰æ•°æ®ï¼Œè¿‡æ»¤å‡ºéœ€è¦åŒæ­¥çš„æ•°æ®</span></span>
<span class="code-line highlight"><span class="line-num">90</span>    <span class="var">Acc0</span> = <span class="fn">maps:fold</span>(</span>
<span class="code-line highlight"><span class="line-num">91</span>        <span class="kw">fun</span>(<span class="var">K</span>, <span class="var">Qi0</span>, <span class="var">Acc</span>) -></span>
<span class="code-line highlight"><span class="line-num">92</span>            <span class="fn">process_data</span>(<span class="kw">fun</span> <span class="fn">snapshot_fun</span>/<span class="num">3</span>,</span>
<span class="code-line highlight"><span class="line-num">93</span>                         <span class="kw">fun</span> <span class="fn">queue_fun</span>/<span class="num">2</span>,</span>
<span class="code-line highlight"><span class="line-num">94</span>                         {<span class="var">Timestamp</span>, <span class="var">DataIndexList</span>, <span class="var">K</span>},</span>
<span class="code-line highlight"><span class="line-num">95</span>                         <span class="var">Qi0</span>, <span class="var">Acc</span>)</span>
<span class="code-line highlight"><span class="line-num">96</span>        <span class="kw">end</span>, [], <span class="var">Mi0</span>),</span>
<span class="code-line highlight"><span class="line-num">97</span>    <span class="cmt">%% æŒ‰æ—¶é—´æˆ³å’Œç´¢å¼•æ’åºåè¿”å›é˜Ÿåˆ—</span></span>
<span class="code-line highlight"><span class="line-num">98</span>    <span class="fn">queue:from_list</span>(<span class="fn">lists:sort</span>(<span class="kw">fun</span> <span class="fn">sort_fun</span>/<span class="num">2</span>, <span class="var">Acc0</span>)).</span>
</pre>
            </div>
        </div>

        <h3>3.4 æ–°èŠ‚ç‚¹åº”ç”¨å¿«ç…§</h3>
        <div class="code-block">
            <div class="code-header">
                <span class="file-path">ğŸ“„ src/eh_system_server.erl</span>
                <span class="line-info">Lines 125-138</span>
            </div>
            <div class="code-content">
<pre>
<span class="code-line"><span class="line-num">125</span><span class="fn">handle_cast</span>({<span class="macro">?EH_UPDATE_SNAPSHOT</span>, {<span class="var">Ref</span>, <span class="var">Q0</span>, <span class="var">PendingPreMsgData</span>}},</span>
<span class="code-line"><span class="line-num">126</span>            <span class="record">#eh_system_state</span>{<span class="atom">snapshot_ref</span>=<span class="var">Ref</span>, <span class="atom">app_config</span>=<span class="var">AppConfig</span>}=<span class="var">State</span>) -></span>
<span class="code-line"><span class="line-num">127</span>    <span class="var">ReplDataManager</span> = <span class="fn">eh_system_config:get_repl_data_manager</span>(<span class="var">AppConfig</span>),</span>
<span class="code-line highlight"><span class="line-num">128</span>    <span class="cmt">%% ğŸ”¥ æ ¸å¿ƒ: å°†å¿«ç…§æ•°æ®åˆå¹¶åˆ°æœ¬åœ°å­˜å‚¨</span></span>
<span class="code-line highlight"><span class="line-num">129</span>    <span class="var">ReplDataManager</span>:<span class="fn">update_snapshot</span>(<span class="var">Q0</span>),</span>
<span class="code-line"><span class="line-num">130</span></span>
<span class="code-line"><span class="line-num">131</span>    <span class="cmt">%% éªŒè¯å¹¶å¤„ç†å¾…å¤„ç†çš„é¢„æ›´æ–°æ¶ˆæ¯</span></span>
<span class="code-line"><span class="line-num">132</span>    <span class="var">PendingPreMsgData1</span> = <span class="kw">case</span> <span class="fn">eh_node_timestamp:valid_pending_pre_msg_data</span>(...) <span class="kw">of</span></span>
<span class="code-line"><span class="line-num">133</span>        <span class="atom">true</span>  -> <span class="var">PendingPreMsgData</span>;</span>
<span class="code-line"><span class="line-num">134</span>        <span class="atom">false</span> -> <span class="fn">eh_system_util:new_map</span>()</span>
<span class="code-line"><span class="line-num">135</span>    <span class="kw">end</span>,</span>
<span class="code-line highlight"><span class="line-num">136</span>    <span class="cmt">%% ğŸ”¥ æ›´æ–°èŠ‚ç‚¹çŠ¶æ€: å¿«ç…§å·²æ¥æ”¶</span></span>
<span class="code-line highlight"><span class="line-num">137</span>    <span class="var">NewState2</span> = <span class="fn">eh_node_state:update_state_snapshot</span>(<span class="var">State</span>),</span>
<span class="code-line"><span class="line-num">138</span>    <span class="var">NewState3</span> = <span class="var">NewState2</span><span class="record">#eh_system_state</span>{<span class="atom">pending_pre_msg_data</span>=<span class="var">PendingPreMsgData1</span>},</span>
<span class="code-line"><span class="line-num">139</span>    {<span class="kw">noreply</span>, <span class="var">NewState3</span>};</span>
</pre>
            </div>
        </div>

        <!-- ========== èŠ‚ç‚¹çŠ¶æ€è½¬æ¢ ========== -->
        <h2><span>ğŸ”„</span> å››ã€èŠ‚ç‚¹çŠ¶æ€è½¬æ¢</h2>
        
        <p>æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ—¶ï¼Œä¼šç»å†å¤šä¸ªçŠ¶æ€è½¬æ¢ï¼Œå¿«ç…§åŒæ­¥æ˜¯å…¶ä¸­å…³é”®ä¸€ç¯ï¼š</p>
        
        <div class="state-diagram">
            <div class="state-row">
                <div class="state-box">
                    <div class="state-name" style="color: #ff7b72;">EH_NOT_READY</div>
                    <div class="state-desc">åˆå§‹çŠ¶æ€<br>èŠ‚ç‚¹åˆšå¯åŠ¨</div>
                </div>
                <div class="state-arrow">â†’</div>
                <div class="state-box transient">
                    <div class="state-name" style="color: #fbbf24;">EH_TRANSIENT</div>
                    <div class="state-desc">è¿‡æ¸¡çŠ¶æ€<br>ç­‰å¾…å¿«ç…§å’Œæ¶ˆæ¯</div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 100px; margin: 20px 0;">
                <div style="text-align: center;">
                    <div style="color: #8b949e; font-size: 0.9em;">æ”¶åˆ°æ¶ˆæ¯æ›´æ–°</div>
                    <div style="color: #00d4ff; font-size: 1.5em;">â†“</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: #8b949e; font-size: 0.9em;">æ”¶åˆ°å¿«ç…§æ•°æ®</div>
                    <div style="color: #00d4ff; font-size: 1.5em;">â†“</div>
                </div>
            </div>
            
            <div class="state-row">
                <div class="state-box transient">
                    <div class="state-name" style="color: #fbbf24;">EH_TRANSIENT_TU</div>
                    <div class="state-desc">æ—¶é—´æˆ³å·²æ›´æ–°<br>ç­‰å¾…å¿«ç…§</div>
                </div>
                <div class="state-arrow">â†’</div>
                <div class="state-box active">
                    <div class="state-name" style="color: #7ee787;">EH_READY</div>
                    <div class="state-desc">å°±ç»ªçŠ¶æ€<br>å¯æ­£å¸¸æœåŠ¡</div>
                </div>
                <div class="state-arrow">â†</div>
                <div class="state-box transient">
                    <div class="state-name" style="color: #fbbf24;">EH_TRANSIENT_DU</div>
                    <div class="state-desc">æ•°æ®å·²æ›´æ–°<br>ç­‰å¾…æ¶ˆæ¯</div>
                </div>
            </div>
        </div>

        <div class="code-block">
            <div class="code-header">
                <span class="file-path">ğŸ“„ src/eh_node_state.erl</span>
                <span class="line-info">Lines 43-48</span>
            </div>
            <div class="code-content">
<pre>
<span class="code-line"><span class="line-num">43</span><span class="cmt">%% æ”¶åˆ°å¿«ç…§åçš„çŠ¶æ€è½¬æ¢</span></span>
<span class="code-line highlight"><span class="line-num">44</span><span class="fn">update_state_snapshot</span>(<span class="record">#eh_system_state</span>{<span class="atom">node_status</span>=<span class="macro">?EH_TRANSIENT</span>}=<span class="var">State</span>) -></span>
<span class="code-line highlight"><span class="line-num">45</span>    <span class="fn">update_state</span>(<span class="macro">?EH_TRANSIENT_DU</span>, <span class="var">State</span>);  <span class="cmt">%% TRANSIENT â†’ TRANSIENT_DU</span></span>
<span class="code-line"><span class="line-num">46</span></span>
<span class="code-line highlight"><span class="line-num">47</span><span class="fn">update_state_snapshot</span>(<span class="record">#eh_system_state</span>{<span class="atom">node_status</span>=<span class="macro">?EH_TRANSIENT_TU</span>}=<span class="var">State</span>) -></span>
<span class="code-line highlight"><span class="line-num">48</span>    <span class="fn">update_state</span>(<span class="macro">?EH_READY</span>, <span class="var">State</span>);        <span class="cmt">%% TRANSIENT_TU â†’ READY (å®Œæˆ!)</span></span>
<span class="code-line"><span class="line-num">49</span></span>
<span class="code-line"><span class="line-num">50</span><span class="fn">update_state_snapshot</span>(<span class="var">State</span>) -></span>
<span class="code-line"><span class="line-num">51</span>    <span class="var">State</span>.  <span class="cmt">%% å…¶ä»–çŠ¶æ€ä¸å˜</span></span>
</pre>
            </div>
        </div>

        <!-- ========== å…³é”®æ–‡ä»¶æ±‡æ€» ========== -->
        <h2><span>ğŸ“</span> äº”ã€å…³é”®ä»£ç æ–‡ä»¶æ±‡æ€»</h2>
        
        <table>
            <tr>
                <th>æ–‡ä»¶</th>
                <th>å‡½æ•°/è¡Œå·</th>
                <th>ä½œç”¨</th>
            </tr>
            <tr>
                <td><code>eh_system_server.erl</code></td>
                <td><code>process_snapshot_request/4</code> (402-409)</td>
                <td>å‘èµ·å¿«ç…§è¯·æ±‚ï¼Œè·å–å½“å‰æ—¶é—´æˆ³å’Œæ•°æ®ç´¢å¼•</td>
            </tr>
            <tr>
                <td><code>eh_system_server.erl</code></td>
                <td><code>handle_cast({EH_SNAPSHOT, ...})</code> (112-123)</td>
                <td>å¤„ç†å¿«ç…§è¯·æ±‚ï¼Œç”Ÿæˆå¹¶å‘é€å¿«ç…§æ•°æ®</td>
            </tr>
            <tr>
                <td><code>eh_system_server.erl</code></td>
                <td><code>handle_cast({EH_UPDATE_SNAPSHOT, ...})</code> (125-138)</td>
                <td>æ¥æ”¶å¹¶åº”ç”¨å¿«ç…§æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨</td>
            </tr>
            <tr>
                <td><code>eh_data_util.erl</code></td>
                <td><code>snapshot_data/3</code> (75-77)</td>
                <td>æ ¸å¿ƒç®—æ³•ï¼šæ ¹æ®æ—¶é—´æˆ³è¿‡æ»¤éœ€è¦åŒæ­¥çš„æ•°æ®</td>
            </tr>
            <tr>
                <td><code>eh_data_util.erl</code></td>
                <td><code>snapshot_fun/3</code> (57-73)</td>
                <td>å¿«ç…§è¿‡æ»¤å‡½æ•°ï¼šå†³å®šæ•°æ®æ˜¯å¦éœ€è¦åŒæ­¥</td>
            </tr>
            <tr>
                <td><code>eh_data_util.erl</code></td>
                <td><code>merge_data/4</code> (163-179)</td>
                <td>åˆå¹¶å¿«ç…§æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨</td>
            </tr>
            <tr>
                <td><code>eh_node_state.erl</code></td>
                <td><code>update_state_snapshot/1</code> (43-48)</td>
                <td>æ›´æ–°èŠ‚ç‚¹çŠ¶æ€ï¼šæ ‡è®°å¿«ç…§å·²æ¥æ”¶</td>
            </tr>
            <tr>
                <td><code>eh_repl_data_manager_api.erl</code></td>
                <td><code>snapshot/2, update_snapshot/1</code> (46-52)</td>
                <td>å¿«ç…§æ“ä½œçš„ API æ¥å£</td>
            </tr>
        </table>

        <!-- ========== æ€»ç»“ ========== -->
        <div class="summary-box">
            <h3>ğŸ’¡ æ ¸å¿ƒè¦ç‚¹æ€»ç»“</h3>
            <ul class="summary-list">
                <li><strong>å¿«ç…§å®šä¹‰</strong>: å¿«ç…§ = {Timestamp, DataIndexList}ï¼Œæ ‡è¯†æ•°æ®çš„ç‰ˆæœ¬è¾¹ç•Œ</li>
                <li><strong>è§¦å‘æ—¶æœº</strong>: æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ—¶ï¼Œç”±å…¶åç»§èŠ‚ç‚¹å‘èµ·å¿«ç…§åŒæ­¥</li>
                <li><strong>æ•°æ®è¿‡æ»¤</strong>: åªåŒæ­¥æ—¶é—´æˆ³ > å¿«ç…§æ—¶é—´æˆ³çš„æ•°æ®ï¼Œé¿å…é‡å¤ä¼ è¾“</li>
                <li><strong>çŠ¶æ€è½¬æ¢</strong>: æ–°èŠ‚ç‚¹ç»å† NOT_READY â†’ TRANSIENT â†’ TRANSIENT_DU/TU â†’ READY</li>
                <li><strong>å¢é‡åŒæ­¥</strong>: å¿«ç…§åŒæ­¥çš„åŒæ—¶ï¼Œè¿˜ä¼šä¼ é€’å¾…å¤„ç†çš„é¢„æ›´æ–°æ¶ˆæ¯ (PendingPreMsgData)</li>
                <li><strong>ä¸€è‡´æ€§ä¿è¯</strong>: é€šè¿‡ SnapshotRef å”¯ä¸€æ ‡è¯†ç¡®ä¿å¿«ç…§å“åº”åŒ¹é…æ­£ç¡®çš„è¯·æ±‚</li>
            </ul>
        </div>

    </div>
</body>
</html>
