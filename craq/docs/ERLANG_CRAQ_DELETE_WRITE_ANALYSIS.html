<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAQåˆ é™¤æ“ä½œWriteå†™å…¥æœºåˆ¶æ·±åº¦åˆ†æ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            color: #34495e;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-top: 40px;
        }
        h3 {
            color: #2980b9;
            margin-top: 30px;
        }
        h4 {
            color: #8e44ad;
            margin-top: 25px;
        }
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 15px 0;
            border-left: 5px solid #3498db;
        }
        .highlight {
            background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #e74c3c;
        }
        .summary {
            background: linear-gradient(120deg, #d299c2 0%, #fef9d7 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #f39c12;
        }
        .flow-diagram {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid #dee2e6;
            text-align: center;
        }
        .binary-data {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
            border: 2px solid #00ff00;
        }
        .performance-metric {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
            font-weight: bold;
        }
        .node-info {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 5px solid #9b59b6;
        }
        .write-operation {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 5px solid #ffc107;
        }
        ul {
            padding-left: 20px;
        }
        li {
            margin: 8px 0;
        }
        .timestamp {
            color: #e74c3c;
            font-weight: bold;
        }
        .process-id {
            color: #27ae60;
            font-weight: bold;
        }
        .file-handle {
            color: #8e44ad;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” CRAQåˆ é™¤æ“ä½œWriteå†™å…¥æœºåˆ¶æ·±åº¦åˆ†æ</h1>
        
        <div class="summary">
            <h3>ğŸ“Š åˆ†ææ¦‚è¿°</h3>
            <p>é€šè¿‡æ·±å…¥åˆ†ætraceæ—¥å¿—ï¼Œæœ¬æ–‡æ¡£è¯¦ç»†è§£æäº†CRAQåˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿä¸­åˆ é™¤æ“ä½œçš„åº•å±‚writeå†™å…¥æœºåˆ¶ï¼Œæ­ç¤ºäº†ä»é€»è¾‘åˆ é™¤åˆ°ç‰©ç†å­˜å‚¨çš„å®Œæ•´æ•°æ®æµã€‚</p>
        </div>

        <h2>ğŸ”¬ Writeå†™å…¥æ“ä½œæ ¸å¿ƒæµç¨‹</h2>
        
        <div class="flow-diagram">
            <h4>åˆ é™¤æ“ä½œWriteå†™å…¥è°ƒç”¨é“¾</h4>
            <div class="code-block">
åˆ é™¤è¯·æ±‚ â†’ eh_persist_data:persist_data/2 â†’ eh_storage_data_operation_api:write/5
    â†“
eh_storage_data_operation_api:write_entries/3 â†’ eh_storage_data_operation_api:write_entry/3
    â†“
eh_storage_data_api:entry_to_binary/1 â†’ eh_persist_storage_data:write_data/2
    â†“
file:write(File, BinaryData) â†’ ç£ç›˜ç‰©ç†å†™å…¥
            </div>
        </div>

        <h3>âš¡ å…³é”®Writeæ“ä½œæ—¶åºåˆ†æ</h3>
        
        <div class="node-info">
            <h4>ğŸ–¥ï¸ Node 1 å†™å…¥æ“ä½œ</h4>
            <div class="write-operation">
                <strong>ç¬¬1æ¬¡åˆ é™¤ (timestamp=5):</strong>
                <ul>
                    <li><span class="timestamp">4:39:42.878314</span> - å¼€å§‹write_entriesæ“ä½œ</li>
                    <li><span class="timestamp">4:39:42.878457</span> - è°ƒç”¨write_entry</li>
                    <li><span class="timestamp">4:39:42.879006</span> - æ‰§è¡Œwrite_dataåˆ°ç£ç›˜</li>
                    <li><span class="timestamp">4:39:42.879167</span> - å†™å…¥å®Œæˆ (161Î¼s)</li>
                </ul>
                <strong>ç¬¬2æ¬¡åˆ é™¤ (timestamp=6):</strong>
                <ul>
                    <li><span class="timestamp">4:39:50.715219</span> - å¼€å§‹write_entriesæ“ä½œ</li>
                    <li><span class="timestamp">4:39:50.715275</span> - è°ƒç”¨write_entry</li>
                    <li><span class="timestamp">4:39:50.715528</span> - æ‰§è¡Œwrite_dataåˆ°ç£ç›˜</li>
                    <li><span class="timestamp">4:39:50.715607</span> - å†™å…¥å®Œæˆ (79Î¼s)</li>
                </ul>
            </div>
        </div>

        <div class="node-info">
            <h4>ğŸ–¥ï¸ Node 2 å†™å…¥æ“ä½œ</h4>
            <div class="write-operation">
                <strong>ç¬¬1æ¬¡åˆ é™¤:</strong>
                <ul>
                    <li><span class="timestamp">4:39:42.962707</span> - å¼€å§‹write_entries</li>
                    <li><span class="timestamp">4:39:42.963265</span> - æ‰§è¡Œwrite_data</li>
                    <li><span class="timestamp">4:39:42.963400</span> - å†™å…¥å®Œæˆ (135Î¼s)</li>
                </ul>
                <strong>ç¬¬2æ¬¡åˆ é™¤:</strong>
                <ul>
                    <li><span class="timestamp">4:39:50.763188</span> - å¼€å§‹write_entries</li>
                    <li><span class="timestamp">4:39:50.763498</span> - æ‰§è¡Œwrite_data</li>
                    <li><span class="timestamp">4:39:50.763583</span> - å†™å…¥å®Œæˆ (85Î¼s)</li>
                </ul>
            </div>
        </div>

        <div class="node-info">
            <h4>ğŸ–¥ï¸ Node 3 å†™å…¥æ“ä½œ</h4>
            <div class="write-operation">
                <strong>ç¬¬1æ¬¡åˆ é™¤:</strong>
                <ul>
                    <li><span class="timestamp">4:39:42.823624</span> - æ‰§è¡Œwrite_data</li>
                    <li><span class="timestamp">4:39:42.823811</span> - å†™å…¥å®Œæˆ (187Î¼s)</li>
                </ul>
                <strong>ç¬¬2æ¬¡åˆ é™¤:</strong>
                <ul>
                    <li><span class="timestamp">4:39:50.645463</span> - æ‰§è¡Œwrite_data</li>
                    <li><span class="timestamp">4:39:50.645806</span> - å†™å…¥å®Œæˆ (343Î¼s)</li>
                </ul>
            </div>
        </div>

        <h2>ğŸ’¾ äºŒè¿›åˆ¶æ•°æ®åºåˆ—åŒ–åˆ†æ</h2>

        <div class="highlight">
            <h4>ğŸ” åˆ é™¤è®°å½•çš„äºŒè¿›åˆ¶æ ¼å¼</h4>
            <p>CRAQä½¿ç”¨Erlangçš„term_to_binaryæ ¼å¼è¿›è¡Œæ•°æ®åºåˆ—åŒ–ï¼Œæ¯ä¸ªåˆ é™¤æ“ä½œéƒ½ä¼šç”ŸæˆåŒ…å«å®Œæ•´å…ƒæ•°æ®çš„äºŒè¿›åˆ¶è®°å½•ã€‚</p>
        </div>

        <h3>ğŸ“ ç¬¬1æ¬¡åˆ é™¤ - å­—æ®µåˆ é™¤ (genderå­—æ®µ)</h3>
        <div class="binary-data">
æ•°æ®ç»“æ„: {eh_storage_data,person,10,5,1,0,gender,undefined}
åŸå§‹äºŒè¿›åˆ¶: <<131,104,8,119,15,101,104,95,115,116,111,114,97,103,101,95,100,97,116,97,119,
              6,112,101,114,115,111,110,97,10,97,5,97,1,97,0,119,6,103,101,110,100,101,114,
              119,9,117,110,100,101,102,105,110,101,100>>
å¤§å°: 55å­—èŠ‚

æœ€ç»ˆå†™å…¥: <<63,10,100,26,184,253,155,192,116,106,198,1,127,69,207,240,163,77,177,251,0,0,
           0,55,[åŸå§‹æ•°æ®]>>
æ ¼å¼: [20å­—èŠ‚å“ˆå¸Œ] + [4å­—èŠ‚é•¿åº¦] + [55å­—èŠ‚æ•°æ®] = 79å­—èŠ‚
        </div>

        <h3>ğŸ“ ç¬¬2æ¬¡åˆ é™¤ - å¯¹è±¡åˆ é™¤</h3>
        <div class="binary-data">
æ•°æ®ç»“æ„: {eh_storage_data,person,10,6,1,0,undefined,undefined}
åŸå§‹äºŒè¿›åˆ¶: <<131,104,8,119,15,101,104,95,115,116,111,114,97,103,101,95,100,97,116,97,119,
              6,112,101,114,115,111,110,97,10,97,6,97,1,97,0,119,9,117,110,100,101,102,105,
              110,101,100,119,9,117,110,100,101,102,105,110,101,100>>
å¤§å°: 58å­—èŠ‚

æœ€ç»ˆå†™å…¥: <<4,33,143,99,193,177,192,148,157,249,219,203,113,91,67,193,138,219,220,240,0,
           0,0,58,[åŸå§‹æ•°æ®]>>
æ ¼å¼: [20å­—èŠ‚å“ˆå¸Œ] + [4å­—èŠ‚é•¿åº¦] + [58å­—èŠ‚æ•°æ®] = 82å­—èŠ‚
        </div>

        <h2>ğŸ—ï¸ æ–‡ä»¶ç³»ç»Ÿå†™å…¥æ¶æ„</h2>

        <div class="summary">
            <h4>ğŸ“ æ–‡ä»¶æè¿°ç¬¦ç®¡ç†</h4>
            <p>æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤ç‹¬ç«‹çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä½¿ç”¨Erlangçš„prim_fileæ¨¡å—è¿›è¡Œåº•å±‚æ–‡ä»¶æ“ä½œï¼š</p>
            
            <div class="node-info">
                <strong>Node 1:</strong> <span class="file-handle">#Ref&lt;0.468240768.1635909645.195572&gt;</span><br>
                <strong>Node 2:</strong> <span class="file-handle">#Ref&lt;0.2225596216.1104543756.216625&gt;</span><br>
                <strong>Node 3:</strong> <span class="file-handle">#Ref&lt;0.1052491606.301596686.208560&gt;</span>
            </div>
        </div>

        <h3>âš™ï¸ å†™å…¥æ“ä½œæŠ€æœ¯ç»†èŠ‚</h3>

        <div class="code-block">
<strong>æ–‡ä»¶æ‰“å¼€æ¨¡å¼:</strong>
file:open(FileName, [append, read, binary, raw])

<strong>å†™å…¥å‡½æ•°:</strong>
eh_persist_storage_data:write_data(File, BinaryData) ->
    file:write(File, BinaryData).

<strong>æ•°æ®æ ¼å¼:</strong>
[20å­—èŠ‚MD5å“ˆå¸Œ] + [4å­—èŠ‚æ•°æ®é•¿åº¦] + [ErlangäºŒè¿›åˆ¶term]
        </div>

        <h2>ğŸ“Š æ€§èƒ½æŒ‡æ ‡åˆ†æ</h2>

        <div class="highlight">
            <h4>â±ï¸ å†™å…¥å»¶è¿Ÿç»Ÿè®¡</h4>
            <div class="performance-metric">Node 1: 79-161Î¼s</div>
            <div class="performance-metric">Node 2: 85-135Î¼s</div>
            <div class="performance-metric">Node 3: 187-343Î¼s</div>
            
            <p><strong>è§‚å¯Ÿ:</strong> Node 3çš„å†™å…¥å»¶è¿Ÿæ˜æ˜¾é«˜äºå…¶ä»–èŠ‚ç‚¹ï¼Œå¯èƒ½ç”±äºç¡¬ä»¶å·®å¼‚æˆ–ç³»ç»Ÿè´Ÿè½½ã€‚</p>
        </div>

        <h3>ğŸ”„ å†™å…¥æ“ä½œä¸€è‡´æ€§ä¿è¯</h3>

        <div class="flow-diagram">
            <h4>CRAQé“¾å¼å†™å…¥ç¡®ä¿ä¸€è‡´æ€§</h4>
            <div class="code-block">
1. HEADèŠ‚ç‚¹ (Node 1) æ¥æ”¶åˆ é™¤è¯·æ±‚
2. å‰å‘ä¼ æ’­åˆ° MIDDLEèŠ‚ç‚¹ (Node 2)
3. æœ€ç»ˆä¼ æ’­åˆ° TAILèŠ‚ç‚¹ (Node 3)
4. æ¯ä¸ªèŠ‚ç‚¹ç‹¬ç«‹æ‰§è¡Œç£ç›˜å†™å…¥
5. åå‘ç¡®è®¤ä¿è¯æ‰€æœ‰èŠ‚ç‚¹å†™å…¥æˆåŠŸ
            </div>
        </div>

        <h2>ğŸ¯ å…³é”®æŠ€æœ¯ç‰¹å¾</h2>

        <div class="summary">
            <h3>ğŸ’¡ æ ¸å¿ƒå‘ç°</h3>
            <ul>
                <li><strong>åŸå­æ€§å†™å…¥:</strong> æ¯ä¸ªåˆ é™¤æ“ä½œä½œä¸ºå•ä¸ªäºŒè¿›åˆ¶å—å†™å…¥ï¼Œä¿è¯åŸå­æ€§</li>
                <li><strong>ç‰ˆæœ¬åŒ–åˆ é™¤:</strong> åˆ é™¤è®°å½•åŒ…å«æ—¶é—´æˆ³(5,6)ï¼Œæ”¯æŒç‰ˆæœ¬è¿½è¸ª</li>
                <li><strong>è½¯åˆ é™¤å®ç°:</strong> é€šè¿‡STATUS_INACTIVE(0)æ ‡è®°å®ç°é€»è¾‘åˆ é™¤</li>
                <li><strong>å“ˆå¸Œå®Œæ•´æ€§:</strong> æ¯æ¡è®°å½•åŒ…å«MD5å“ˆå¸Œï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§</li>
                <li><strong>è¿½åŠ å†™å…¥:</strong> ä½¿ç”¨appendæ¨¡å¼ï¼Œé¿å…è¦†ç›–ç°æœ‰æ•°æ®</li>
                <li><strong>è¿›ç¨‹éš”ç¦»:</strong> æ¯ä¸ªèŠ‚ç‚¹ä½¿ç”¨ç‹¬ç«‹è¿›ç¨‹å¤„ç†å†™å…¥æ“ä½œ</li>
            </ul>
        </div>

        <h3>ğŸ”§ åº•å±‚å®ç°ä¼˜åŠ¿</h3>

        <div class="highlight">
            <h4>ğŸš€ æ€§èƒ½ä¼˜åŒ–</h4>
            <ul>
                <li><strong>æ‰¹é‡å†™å…¥:</strong> write_entriesæ”¯æŒæ‰¹é‡æ“ä½œï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨</li>
                <li><strong>äºŒè¿›åˆ¶ä¼˜åŒ–:</strong> ç›´æ¥æ“ä½œäºŒè¿›åˆ¶æ•°æ®ï¼Œé¿å…å­—ç¬¦ä¸²è½¬æ¢å¼€é”€</li>
                <li><strong>åŸç”Ÿæ–‡ä»¶æ“ä½œ:</strong> ä½¿ç”¨prim_fileæ¨¡å—ï¼Œç»•è¿‡é«˜å±‚æŠ½è±¡</li>
                <li><strong>å†…å­˜æ˜ å°„:</strong> åˆ©ç”¨r_bufferè¿›è¡Œé«˜æ•ˆç¼“å†²</li>
            </ul>
        </div>

        <h2>ğŸ“ˆ æ€»ç»“</h2>

        <div class="summary">
            <p>CRAQåˆ é™¤æ“ä½œçš„writeå†™å…¥æœºåˆ¶å±•ç°äº†åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿçš„ç²¾å¦™è®¾è®¡ï¼š</p>
            <ul>
                <li>é€šè¿‡<strong>è½¯åˆ é™¤</strong>ç­–ç•¥ä¿è¯æ•°æ®å®‰å…¨å’Œå¯æ¢å¤æ€§</li>
                <li>ä½¿ç”¨<strong>é“¾å¼å¤åˆ¶</strong>ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹çš„å†™å…¥ä¸€è‡´æ€§</li>
                <li>é‡‡ç”¨<strong>äºŒè¿›åˆ¶åºåˆ—åŒ–</strong>å®ç°é«˜æ•ˆçš„å­˜å‚¨æ ¼å¼</li>
                <li>é€šè¿‡<strong>å“ˆå¸Œæ ¡éªŒ</strong>ä¿è¯æ•°æ®å®Œæ•´æ€§</li>
                <li>åˆ©ç”¨<strong>ç‰ˆæœ¬åŒ–æ—¶é—´æˆ³</strong>æ”¯æŒå®Œæ•´çš„å®¡è®¡è¿½è¸ª</li>
            </ul>
            
            <p>è¿™ç§è®¾è®¡åœ¨ä¿è¯<strong>å¼ºä¸€è‡´æ€§</strong>çš„åŒæ—¶ï¼Œå®ç°äº†<strong>é«˜æ€§èƒ½</strong>çš„åˆ é™¤æ“ä½œï¼Œä¸ºåˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿæä¾›äº†é‡è¦çš„æŠ€æœ¯å‚è€ƒã€‚</p>
        </div>
    </div>
</body>
</html>