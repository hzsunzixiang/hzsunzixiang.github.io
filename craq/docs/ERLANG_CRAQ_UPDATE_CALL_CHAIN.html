<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>erlang_craq:updateè°ƒç”¨é“¾è¯¦ç»†åˆ†æ</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background: #f5f7fa; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        h3 { color: #7f8c8d; }
        .code-block { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; margin: 10px 0; overflow-x: auto; }
        .highlight { background: #fff3cd; padding: 2px 4px; border-radius: 3px; }
        .warning { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 10px; border-radius: 5px; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #f8f9fa; font-weight: bold; }
        .field-name { font-family: 'Courier New', monospace; background: #f8f9fa; padding: 2px 4px; border-radius: 3px; }
        .flow-step { background: #e8f5e8; border-left: 4px solid #28a745; padding: 15px; margin: 15px 0; }
        .gen-server-box { background: #fff3cd; border: 2px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” erlang_craq:updateè°ƒç”¨é“¾è¯¦ç»†åˆ†æ</h1>
        
        <div class="success">
            <strong>åˆ†æç›®æ ‡</strong>: è¯¦ç»†è¿½è¸ªupdateå‡½æ•°çš„å®Œæ•´è°ƒç”¨é“¾ï¼Œç‰¹åˆ«å…³æ³¨gen_serveræ¶ˆæ¯ä¼ é€’æœºåˆ¶
        </div>

        <h2>ğŸ“Š è°ƒç”¨ç¤ºä¾‹åˆ†æ</h2>
        
        <div class="code-block">
erlang_craq:update(N1, [{candidate, 10, [{name,donald_trump},{party,republican}]}, 
                        {person, 10, [{name,john_smith},{age,40}]}]).
        </div>

        <h2>ğŸ”§ å®Œæ•´è°ƒç”¨é“¾æµç¨‹</h2>

        <div class="flow-step">
            <h3>ğŸ“ˆ Step-by-Stepè°ƒç”¨é“¾</h3>
            <div class="code-block">
1. å®¢æˆ·ç«¯è°ƒç”¨: erlang_craq:update/2
   â†“
2. å†…éƒ¨è½¬æ¢: send_update/2
   â†“
3. æ¶ˆæ¯å‘é€: send/4
   â†“
4. gen_serverå¹¿æ’­: gen_server:abcast/3
   â†“
5. ç³»ç»ŸæœåŠ¡å™¨æ¥æ”¶: eh_system_server:handle_cast/2
   â†“
6. æ¶ˆæ¯å¤„ç†: æ›´æ–°é€»è¾‘å¤„ç†
   â†“
7. å“åº”è¿”å›: é€šè¿‡RefåŒ¹é…è¿”å›ç»“æœ
            </div>
        </div>

        <h2>ğŸ’» è¯¦ç»†ä»£ç åˆ†æ</h2>

        <h3>ğŸ¯ 1. å®¢æˆ·ç«¯APIå…¥å£ (src/erlang_craq.erl:65-66)</h3>
        <div class="code-block">
update(Node, UpdateList) ->
  send_update(Node, get_update_list(UpdateList, [])).
        </div>

        <div class="info">
            <h4>å‚æ•°å¤„ç†</h4>
            <ul>
                <li><strong>Node</strong>: N1 (ç›®æ ‡èŠ‚ç‚¹)</li>
                <li><strong>UpdateList</strong>: åŒ…å«candidateå’Œpersonä¸¤ä¸ªæ›´æ–°é¡¹</li>
                <li><strong>get_update_list/2</strong>: å°†æ›´æ–°åˆ—è¡¨è½¬æ¢ä¸ºå†…éƒ¨æ ¼å¼</li>
            </ul>
        </div>

        <h3>ğŸ¯ 2. æ›´æ–°åˆ—è¡¨å¤„ç† (src/erlang_craq.erl:133-138)</h3>
        <div class="code-block">
get_update_list([{ObjectType, ObjectId, UpdateColumns} | Rest], Acc) ->
  get_update_list(Rest, [{ObjectType, ObjectId, combine_columns(UpdateColumns, [])} | Acc]);
get_update_list([{ObjectType, ObjectId, UpdateColumns, DeleteColumns} | Rest], Acc) ->
  get_update_list(Rest, [{ObjectType, ObjectId, combine_columns(UpdateColumns, DeleteColumns)} | Acc]);
get_update_list([], Acc) ->
  Acc.
        </div>

        <div class="info">
            <h4>æ•°æ®è½¬æ¢è¿‡ç¨‹</h4>
            <p>åŸå§‹æ•°æ®:</p>
            <div class="code-block">
[{candidate, 10, [{name,donald_trump},{party,republican}]}, 
 {person, 10, [{name,john_smith},{age,40}]}]
            </div>
            <p>è½¬æ¢å:</p>
            <div class="code-block">
[{candidate, 10, [{name, active, donald_trump}, {party, active, republican}]},
 {person, 10, [{name, active, john_smith}, {age, active, 40}]}]
            </div>
        </div>

        <h3>ğŸ¯ 3. å‘é€æ›´æ–°æ¶ˆæ¯ (src/erlang_craq.erl:75-76)</h3>
        <div class="code-block">
send_update(Node, UpdateList) ->
  send([Node], ?EH_UPDATE, [{Node, UpdateList}], ?UPDATE_TIMEOUT).
        </div>

        <h3>ğŸ¯ 4. æ ¸å¿ƒå‘é€å‡½æ•° (src/erlang_craq.erl:82-88)</h3>
        <div class="code-block">
send(NodeList, MsgTag, Msg, Timeout) ->
  flush_msg(),
  AppConfig = eh_system_config:get_env(),
  UniqueIdGenerator = eh_system_config:get_unique_id_generator(AppConfig),
  Ref = UniqueIdGenerator:unique_id(),                    %% ç”Ÿæˆå”¯ä¸€å¼•ç”¨
  gen_server:abcast(NodeList, ?EH_SYSTEM_SERVER, {MsgTag, {self(), Ref, Msg}}),
  receive_msg(Ref, Timeout, NodeList, []).
        </div>

        <div class="gen-server-box">
            <h4>ğŸ”¥ å…³é”®gen_serverè°ƒç”¨</h4>
            <div class="code-block">
gen_server:abcast([N1], eh_system_server, 
    {eh_update, {&lt;ClientPid&gt;, #Ref&lt;...&gt;, [{N1, UpdateList}]}})
            </div>
            <ul>
                <li><strong>abcast</strong>: å¼‚æ­¥å¹¿æ’­åˆ°å¤šä¸ªèŠ‚ç‚¹</li>
                <li><strong>eh_system_server</strong>: ç›®æ ‡gen_serverè¿›ç¨‹å</li>
                <li><strong>æ¶ˆæ¯æ ¼å¼</strong>: {eh_update, {From, Ref, Data}}</li>
            </ul>
        </div>

        <h2>ğŸ¯ gen_serveræ¥æ”¶ç«¯åˆ†æ</h2>

        <h3>ğŸ“¨ ç³»ç»ŸæœåŠ¡å™¨æ¥æ”¶ (src/eh_system_server.erl:178-204)</h3>
        <div class="code-block">
handle_cast({?EH_UPDATE, {From, Ref, ObjectList}},
            #eh_system_state{timestamp=Timestamp, 
                            successor=Succ, 
                            completed_set=CompletedSet, 
                            app_config=AppConfig}=State) ->
  NodeId = eh_system_config:get_node_id(AppConfig),
  NewState9 = case eh_node_state:client_state(State) of
                ?EH_NOT_READY ->
                  eh_query_handler:reply(From, Ref, eh_query_handler:error_node_unavailable(NodeId)),
                  State;
                _             ->
                  Timestamp1 = Timestamp+1,                    %% é€’å¢æ—¶é—´æˆ³
                  {NodeId, UpdateList} = lists:keyfind(NodeId, 1, ObjectList),
                  UMsgList = eh_update_msg:get_msg(UpdateList, 
                                                   Timestamp1,
                                                   From,
                                                   NodeId,
                                                   Ref),
                  NewState1 = eh_node_timestamp:update_state_timestamp(Timestamp1, State),
                case Succ of 
                    undefined ->                             %% å¦‚æœæ˜¯å°¾èŠ‚ç‚¹
                      reply_to_client(fun eh_persist_data:persist_data/2, UMsgList, CompletedSet, NewState1);
                    _         ->                             %% å¦‚æœæœ‰åç»§èŠ‚ç‚¹
                      send_pre_update_msg(fun eh_persist_data:no_persist_data/2, UMsgList, CompletedSet, NewState1)
                  end                            
              end,
  event_state("update.99", NewState9, AppConfig),
  {noreply, NewState9};
        </div>

        <h2>ğŸ“Š æ¶ˆæ¯æµè½¬å›¾</h2>

        <table>
            <thead>
                <tr>
                    <th>æ­¥éª¤</th>
                    <th>ä½ç½®</th>
                    <th>æ“ä½œ</th>
                    <th>æ¶ˆæ¯æ ¼å¼</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1</td>
                    <td>å®¢æˆ·ç«¯è¿›ç¨‹</td>
                    <td>è°ƒç”¨API</td>
                    <td>erlang_craq:update(N1, UpdateList)</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>erlang_craqæ¨¡å—</td>
                    <td>æ•°æ®è½¬æ¢</td>
                    <td>get_update_listå¤„ç†</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>erlang_craqæ¨¡å—</td>
                    <td>ç”Ÿæˆå”¯ä¸€ID</td>
                    <td>Ref = unique_id()</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>gen_serverå±‚</td>
                    <td>å¼‚æ­¥å¹¿æ’­</td>
                    <td>{eh_update, {From, Ref, Data}}</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>eh_system_server</td>
                    <td>handle_castå¤„ç†</td>
                    <td>çŠ¶æ€æ›´æ–°å’Œæ¶ˆæ¯è½¬å‘</td>
                </tr>
                <tr>
                    <td>6</td>
                    <td>å®¢æˆ·ç«¯è¿›ç¨‹</td>
                    <td>ç­‰å¾…å“åº”</td>
                    <td>receive {reply, Ref, Result}</td>
                </tr>
            </tbody>
        </table>

        <h2>ğŸ”„ å“åº”æœºåˆ¶</h2>

        <h3>ğŸ“¬ å®¢æˆ·ç«¯ç­‰å¾…å“åº” (src/erlang_craq.erl:90-99)</h3>
        <div class="code-block">
receive_msg(Ref, Timeout, [Node | RNodeList], Acc) ->
  Reply1 = receive
             {reply, Ref, Reply} ->               %% åŒ¹é…ç‰¹å®šRefçš„å“åº”
               Reply
           after Timeout ->                       %% è¶…æ—¶å¤„ç†
             eh_query_handler:error_node_down(Node)
           end,
  receive_msg(Ref, Timeout, RNodeList, [Reply1 | Acc]);
receive_msg(_Ref, _Timeout, [], Acc) ->
  Acc.
        </div>

        <div class="gen-server-box">
            <h4>ğŸ”¥ gen_serverå“åº”æœºåˆ¶</h4>
            <ul>
                <li><strong>å¼‚æ­¥è°ƒç”¨</strong>: ä½¿ç”¨gen_server:abcastå‘é€</li>
                <li><strong>å”¯ä¸€æ ‡è¯†</strong>: é€šè¿‡RefåŒ¹é…è¯·æ±‚å’Œå“åº”</li>
                <li><strong>è¶…æ—¶æ§åˆ¶</strong>: UPDATE_TIMEOUTé˜²æ­¢æ— é™ç­‰å¾…</li>
                <li><strong>å¤šèŠ‚ç‚¹æ”¯æŒ</strong>: å¯åŒæ—¶å‘å¤šä¸ªèŠ‚ç‚¹å‘é€æ›´æ–°</li>
            </ul>
        </div>

        <h2>ğŸ¯ CRAQç‰¹æœ‰çš„å¤„ç†é€»è¾‘</h2>

        <h3>ğŸ“‹ èŠ‚ç‚¹è§’è‰²åˆ¤æ–­</h3>
        <div class="info">
            <ul>
                <li><strong>å°¾èŠ‚ç‚¹</strong> (Succ=undefined): ç›´æ¥æŒä¹…åŒ–æ•°æ®å¹¶å›å¤å®¢æˆ·ç«¯</li>
                <li><strong>ä¸­é—´èŠ‚ç‚¹</strong> (Succâ‰ undefined): è½¬å‘ç»™åç»§èŠ‚ç‚¹ï¼Œä¸ç›´æ¥å›å¤</li>
                <li><strong>æ—¶é—´æˆ³ç®¡ç†</strong>: æ¯æ¬¡æ›´æ–°é€’å¢å…¨å±€æ—¶é—´æˆ³</li>
                <li><strong>çŠ¶æ€æ£€æŸ¥</strong>: ç¡®ä¿èŠ‚ç‚¹å¤„äºå¯æœåŠ¡çŠ¶æ€</li>
            </ul>
        </div>

        <h2>ğŸ¯ æ ¸å¿ƒç»“è®º</h2>

        <div class="success">
            <h4>âœ… è°ƒç”¨é“¾æ€»ç»“</h4>
            <ol>
                <li><strong>APIå±‚</strong>: erlang_craq:update/2 æä¾›ç”¨æˆ·æ¥å£</li>
                <li><strong>è½¬æ¢å±‚</strong>: get_update_list/2 å¤„ç†æ•°æ®æ ¼å¼</li>
                <li><strong>é€šä¿¡å±‚</strong>: gen_server:abcast/3 å®ç°åˆ†å¸ƒå¼æ¶ˆæ¯ä¼ é€’</li>
                <li><strong>å¤„ç†å±‚</strong>: eh_system_server:handle_cast/2 å¤„ç†ä¸šåŠ¡é€»è¾‘</li>
                <li><strong>å“åº”å±‚</strong>: é€šè¿‡RefåŒ¹é…å®ç°å¼‚æ­¥å“åº”</li>
            </ol>
        </div>

        <div class="warning">
            <h4>âš ï¸ gen_serveræ¨¡å¼ç‰¹ç‚¹</h4>
            <ul>
                <li><strong>å¼‚æ­¥å¹¿æ’­</strong>: ä½¿ç”¨abcastè€Œécallï¼Œæé«˜æ€§èƒ½</li>
                <li><strong>è‡ªå®šä¹‰å“åº”</strong>: ä¸ä¾èµ–gen_serverçš„åŒæ­¥æœºåˆ¶</li>
                <li><strong>å”¯ä¸€æ ‡è¯†</strong>: é€šè¿‡Refå®ç°è¯·æ±‚-å“åº”åŒ¹é…</li>
                <li><strong>è¶…æ—¶ä¿æŠ¤</strong>: é˜²æ­¢å®¢æˆ·ç«¯æ— é™ç­‰å¾…</li>
                <li><strong>åˆ†å¸ƒå¼æ”¯æŒ</strong>: å¤©ç„¶æ”¯æŒå¤šèŠ‚ç‚¹æ“ä½œ</li>
            </ul>
        </div>

        <p>è¿™ç§è®¾è®¡å……åˆ†åˆ©ç”¨äº†Erlang/OTPçš„gen_serveræ¡†æ¶ï¼ŒåŒæ—¶é’ˆå¯¹CRAQåè®®çš„ç‰¹æ®Šéœ€æ±‚è¿›è¡Œäº†å®šåˆ¶åŒ–çš„æ¶ˆæ¯å¤„ç†å’Œå“åº”æœºåˆ¶ã€‚</p>
    </div>
</body>
</html>