<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erlang file_descriptorç»“æ„ä½“å®šä¹‰åˆ†æ</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background: #f5f7fa; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        h3 { color: #7f8c8d; }
        .code-block { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; margin: 10px 0; overflow-x: auto; }
        .highlight { background: #fff3cd; padding: 2px 4px; border-radius: 3px; }
        .warning { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 10px; border-radius: 5px; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #f8f9fa; font-weight: bold; }
        .field-name { font-family: 'Courier New', monospace; background: #f8f9fa; padding: 2px 4px; border-radius: 3px; }
        .path-highlight { background: #e8f5e8; border-left: 4px solid #28a745; padding: 15px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Erlang file_descriptorç»“æ„ä½“å®šä¹‰åˆ†æ</h1>
        
        <div class="success">
            <strong>æ ¸å¿ƒå‘ç°</strong>: file_descriptorç¡®å®æ˜¯ä¸€ä¸ªErlang recordç»“æ„ä½“ï¼Œå®šä¹‰åœ¨OTPæ ‡å‡†åº“ä¸­
        </div>

        <h2>ğŸ“‹ ç»“æ„ä½“å®šä¹‰ä½ç½®</h2>
        
        <div class="path-highlight">
            <h3>ğŸ¯ å®˜æ–¹å®šä¹‰æ–‡ä»¶</h3>
            <p><strong>æ–‡ä»¶è·¯å¾„</strong>: <span class="field-name">/usr/local/lib/erlang/lib/kernel-9.2.4.1/include/file.hrl</span></p>
            <p><strong>é¡¹ç›®å¼•ç”¨</strong>: <span class="field-name">src/eh_persist_storage_data.erl:27</span></p>
        </div>

        <h2>ğŸ”§ å®˜æ–¹ç»“æ„ä½“å®šä¹‰</h2>
        
        <div class="code-block">
-record(file_descriptor,
    {module :: module(),     %% Module that handles this kind of file
     data   :: term()}).     %% Module dependent data
        </div>

        <h3>ğŸ“Š å­—æ®µè¯´æ˜</h3>
        <table>
            <thead>
                <tr>
                    <th>å­—æ®µå</th>
                    <th>ç±»å‹</th>
                    <th>ä½œç”¨</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="field-name">module</span></td>
                    <td>module()</td>
                    <td>å¤„ç†æ­¤ç±»æ–‡ä»¶çš„æ¨¡å—å(å¦‚prim_file)</td>
                </tr>
                <tr>
                    <td><span class="field-name">data</span></td>
                    <td>term()</td>
                    <td>æ¨¡å—ç›¸å…³çš„æ•°æ®(å¯ä»¥æ˜¯ä»»æ„Erlang term)</td>
                </tr>
            </tbody>
        </table>

        <h2>ğŸ¯ CRAQé¡¹ç›®ä¸­çš„å®é™…ç»“æ„</h2>

        <h3>ğŸ“¦ traceæ—¥å¿—ä¸­çš„å®Œæ•´ç»“æ„</h3>
        <div class="code-block">
{file_descriptor, prim_file,
    #{handle => #Ref&lt;0.468240768.1635909645.195572&gt;,
      owner => &lt;0.907.0&gt;,
      r_buffer => #Ref&lt;0.468240768.1635909634.216835&gt;,
      r_ahead_size => 0}}
        </div>

        <h3>ğŸ” ç»“æ„åˆ†è§£åˆ†æ</h3>
        <table>
            <thead>
                <tr>
                    <th>ä½ç½®</th>
                    <th>å€¼</th>
                    <th>å¯¹åº”å­—æ®µ</th>
                    <th>è¯´æ˜</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>ç¬¬1ä¸ªå…ƒç´ </td>
                    <td><span class="field-name">file_descriptor</span></td>
                    <td>recordæ ‡è¯†</td>
                    <td>è¡¨æ˜è¿™æ˜¯file_descriptorè®°å½•</td>
                </tr>
                <tr>
                    <td>ç¬¬2ä¸ªå…ƒç´ </td>
                    <td><span class="field-name">prim_file</span></td>
                    <td>moduleå­—æ®µ</td>
                    <td>ä½¿ç”¨prim_fileæ¨¡å—å¤„ç†æ–‡ä»¶æ“ä½œ</td>
                </tr>
                <tr>
                    <td>ç¬¬3ä¸ªå…ƒç´ </td>
                    <td><span class="field-name">#{...}</span></td>
                    <td>dataå­—æ®µ</td>
                    <td>åŒ…å«å…·ä½“çš„æ–‡ä»¶æ“ä½œæ•°æ®(Mapç»“æ„)</td>
                </tr>
            </tbody>
        </table>

        <h2>ğŸ’¾ dataå­—æ®µè¯¦ç»†ç»“æ„</h2>

        <h3>ğŸ—‚ï¸ Mapç»“æ„å†…å®¹</h3>
        <div class="code-block">
#{handle => #Ref&lt;0.468240768.1635909645.195572&gt;,      %% æ–‡ä»¶å¥æŸ„å¼•ç”¨
  owner => &lt;0.907.0&gt;,                                 %% æ‹¥æœ‰è¿›ç¨‹PID
  r_buffer => #Ref&lt;0.468240768.1635909634.216835&gt;,   %% è¯»ç¼“å†²åŒºå¼•ç”¨
  r_ahead_size => 0}                                 %% é¢„è¯»ç¼“å†²åŒºå¤§å°
        </div>

        <h3>ğŸ“‹ dataå­—æ®µå„é¡¹è¯´æ˜</h3>
        <table>
            <thead>
                <tr>
                    <th>é”®å</th>
                    <th>ç±»å‹</th>
                    <th>ä½œç”¨</th>
                    <th>ç¤ºä¾‹å€¼</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="field-name">handle</span></td>
                    <td>reference()</td>
                    <td>æ“ä½œç³»ç»Ÿçº§æ–‡ä»¶å¥æŸ„</td>
                    <td>#Ref&lt;0.468240768.1635909645.195572&gt;</td>
                </tr>
                <tr>
                    <td><span class="field-name">owner</span></td>
                    <td>pid()</td>
                    <td>æ–‡ä»¶æè¿°ç¬¦æ‹¥æœ‰è€…è¿›ç¨‹</td>
                    <td>&lt;0.907.0&gt;</td>
                </tr>
                <tr>
                    <td><span class="field-name">r_buffer</span></td>
                    <td>reference()</td>
                    <td>è¯»æ“ä½œç¼“å†²åŒºå¼•ç”¨</td>
                    <td>#Ref&lt;0.468240768.1635909634.216835&gt;</td>
                </tr>
                <tr>
                    <td><span class="field-name">r_ahead_size</span></td>
                    <td>integer()</td>
                    <td>é¢„è¯»ç¼“å†²åŒºå¤§å°(å­—èŠ‚)</td>
                    <td>0 (ç¦ç”¨é¢„è¯»)</td>
                </tr>
            </tbody>
        </table>

        <h2>ğŸ”§ é¡¹ç›®ä¸­çš„ä½¿ç”¨æ–¹å¼</h2>

        <h3>ğŸ“ å¼•ç”¨å£°æ˜</h3>
        <div class="code-block">
%% src/eh_persist_storage_data.erl:27
-include_lib("kernel/include/file.hrl").
        </div>

        <h3>ğŸ¯ ç±»å‹è§„èŒƒ</h3>
        <div class="code-block">
%% å‡½æ•°ç­¾åä¸­çš„ç±»å‹å£°æ˜
-spec write_data(file:io_device(), binary()) -> ok | {error, atom()}.
        </div>

        <div class="info">
            <strong>ç±»å‹è¯´æ˜</strong>: <span class="field-name">file:io_device()</span> æ˜¯ä¸€ä¸ªç±»å‹åˆ«åï¼Œå®é™…ä¸Šå°±æ˜¯ <span class="field-name">#file_descriptor{}</span> è®°å½•
        </div>

        <h3>âš™ï¸ å®é™…ä½¿ç”¨</h3>
        <div class="code-block">
write_data(File, Data) ->
  file:write(File, Data).
        </div>

        <div class="info">
            <ul>
                <li><strong>Fileå‚æ•°</strong>: æ¥æ”¶ #file_descriptor{} è®°å½•</li>
                <li><strong>å†…éƒ¨å¤„ç†</strong>: file:write/2 è‡ªåŠ¨è§£æè®°å½•ç»“æ„</li>
                <li><strong>æ¨¡å—åˆ†å‘</strong>: æ ¹æ®moduleå­—æ®µ(prim_file)è°ƒç”¨ç›¸åº”å¤„ç†å‡½æ•°</li>
            </ul>
        </div>

        <h2>ğŸ¯ æ ¸å¿ƒç»“è®º</h2>

        <div class="success">
            <h4>âœ… ç¡®è®¤ç»“æœ</h4>
            <ol>
                <li><strong>æ˜¯ç»“æ„ä½“</strong>: file_descriptorç¡®å®æ˜¯Erlang recordç»“æ„ä½“</li>
                <li><strong>å®˜æ–¹å®šä¹‰</strong>: å®šä¹‰åœ¨OTPæ ‡å‡†åº“ kernel/include/file.hrl ä¸­</li>
                <li><strong>ä¸¤å­—æ®µç»“æ„</strong>: åŒ…å«moduleå’Œdataä¸¤ä¸ªå­—æ®µ</li>
                <li><strong>æ¨¡å—åŒ–è®¾è®¡</strong>: é€šè¿‡moduleå­—æ®µå®ç°ä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„æŠ½è±¡</li>
                <li><strong>æ•°æ®å°è£…</strong>: dataå­—æ®µåŒ…å«å…·ä½“çš„æ–‡ä»¶æ“ä½œçŠ¶æ€ä¿¡æ¯</li>
            </ol>
        </div>

        <div class="warning">
            <h4>âš ï¸ é‡è¦ç†è§£</h4>
            <ul>
                <li><strong>æŠ½è±¡å±‚æ¬¡</strong>: file_descriptoræ˜¯Erlangæ–‡ä»¶I/Oçš„æŠ½è±¡æ¥å£</li>
                <li><strong>æ¨¡å—åˆ†å‘</strong>: æ ¹æ®moduleå­—æ®µåŠ¨æ€è°ƒç”¨ç›¸åº”çš„å¤„ç†æ¨¡å—</li>
                <li><strong>çŠ¶æ€ç®¡ç†</strong>: dataå­—æ®µä¿å­˜æ–‡ä»¶æ“ä½œçš„æ‰€æœ‰çŠ¶æ€ä¿¡æ¯</li>
                <li><strong>é€æ˜æ“ä½œ</strong>: åº”ç”¨å±‚é€šè¿‡fileæ¨¡å—APIé€æ˜ä½¿ç”¨ï¼Œæ— éœ€ç›´æ¥æ“ä½œç»“æ„ä½“</li>
            </ul>
        </div>

        <h2>ğŸ“š ç›¸å…³æ–‡ä»¶ä½ç½®</h2>

        <div class="path-highlight">
            <h4>ğŸ” å…³é”®æ–‡ä»¶è·¯å¾„</h4>
            <ul>
                <li><strong>ç»“æ„å®šä¹‰</strong>: <span class="field-name">/usr/local/lib/erlang/lib/kernel-9.2.4.1/include/file.hrl</span></li>
                <li><strong>å†…éƒ¨å·¥å…·</strong>: <span class="field-name">/usr/local/lib/erlang/lib/kernel-9.2.4.1/src/file_int.hrl</span></li>
                <li><strong>å®ç°æ¨¡å—</strong>: <span class="field-name">/usr/local/lib/erlang/lib/erts-14.2.5.1/src/prim_file.erl</span></li>
                <li><strong>é¡¹ç›®å¼•ç”¨</strong>: <span class="field-name">src/eh_persist_storage_data.erl</span></li>
            </ul>
        </div>

        <p>è¿™ç§è®¾è®¡ä½“ç°äº†Erlangä¼˜ç§€çš„æ¨¡å—åŒ–å’ŒæŠ½è±¡èƒ½åŠ›ï¼Œé€šè¿‡ç»Ÿä¸€çš„æ¥å£æ”¯æŒä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿå®ç°ï¼Œä¸ºCRAQç³»ç»Ÿæä¾›äº†å¯é çš„æ–‡ä»¶I/OåŸºç¡€ã€‚</p>
    </div>
</body>
</html>