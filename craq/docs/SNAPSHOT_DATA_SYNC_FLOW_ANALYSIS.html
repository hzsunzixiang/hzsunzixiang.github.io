<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAQ å¿«ç…§åœ¨æ•°æ®åŒæ­¥ä¸­çš„ä½œç”¨ä¸æµç¨‹è¯¦è§£</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --info: #0ea5e9;
            --warning: #eab308;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --code-bg: #1e293b;
            --node1: #3b82f6;
            --node2: #10b981;
            --node3: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.8;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Hero */
        .hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
        }

        .hero h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .hero .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Navigation */
        .nav-toc {
            background: var(--card);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            position: sticky;
            top: 1rem;
            z-index: 100;
        }

        .nav-toc h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .nav-toc ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .nav-toc a {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--bg);
            color: var(--text);
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .nav-toc a:hover {
            background: var(--primary);
            color: white;
        }

        /* Section */
        .section {
            background: var(--card);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
        }

        .section h2 {
            color: var(--primary-dark);
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid var(--primary);
        }

        .section h3 {
            color: var(--text);
            font-size: 1.25rem;
            margin: 1.5rem 0 1rem;
        }

        .section h4 {
            color: var(--secondary);
            font-size: 1.1rem;
            margin: 1.25rem 0 0.75rem;
        }

        /* Code */
        pre {
            background: var(--code-bg);
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 12px;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        code {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
        }

        :not(pre) > code {
            background: #e0e7ff;
            color: var(--primary-dark);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9em;
        }

        /* Syntax */
        .keyword { color: #c678dd; }
        .function { color: #61afef; }
        .string { color: #98c379; }
        .comment { color: #5c6370; font-style: italic; }
        .number { color: #d19a66; }
        .atom { color: #e5c07b; }
        .variable { color: #e06c75; }
        .operator { color: #56b6c2; }

        /* Node visualization */
        .node-diagram {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 16px;
            padding: 2rem;
            margin: 1.5rem 0;
            overflow-x: auto;
        }

        .node-chain {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .node-box {
            width: 150px;
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
        }

        .node-box.node1 { background: linear-gradient(135deg, var(--node1), #1d4ed8); }
        .node-box.node2 { background: linear-gradient(135deg, var(--node2), #047857); }
        .node-box.node3 { background: linear-gradient(135deg, var(--node3), #d97706); }
        .node-box.new-node { background: linear-gradient(135deg, #ec4899, #be185d); }

        .node-box .role {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        .node-box .data {
            font-size: 0.7rem;
            margin-top: 0.5rem;
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .arrow {
            font-size: 2rem;
            color: var(--text-muted);
        }

        .arrow.highlight {
            color: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Info boxes */
        .info-box {
            padding: 1.25rem;
            border-radius: 12px;
            margin: 1rem 0;
            border-left: 4px solid;
        }

        .info-box.scenario {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: var(--accent);
        }

        .info-box.problem {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: var(--danger);
        }

        .info-box.solution {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: var(--success);
        }

        .info-box.info {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            border-color: var(--info);
        }

        .info-box h4 {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Timeline */
        .sync-timeline {
            position: relative;
            padding-left: 3rem;
            margin: 2rem 0;
        }

        .sync-timeline::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, var(--node1), var(--node2), var(--node3));
            border-radius: 4px;
        }

        .timeline-step {
            position: relative;
            padding: 1rem 0 2rem 1.5rem;
        }

        .timeline-step::before {
            content: attr(data-step);
            position: absolute;
            left: -2.5rem;
            top: 0;
            width: 2rem;
            height: 2rem;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.4);
        }

        .timeline-step h4 {
            margin: 0 0 0.5rem;
            color: var(--primary-dark);
        }

        .timeline-step .code-snippet {
            background: var(--code-bg);
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        /* Data comparison table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        .data-table th {
            background: var(--primary);
            color: white;
            padding: 0.75rem 1rem;
            text-align: left;
        }

        .data-table th:first-child { border-radius: 8px 0 0 0; }
        .data-table th:last-child { border-radius: 0 8px 0 0; }

        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
        }

        .data-table tr:hover { background: var(--bg); }

        .data-table .synced { color: var(--success); font-weight: 600; }
        .data-table .missing { color: var(--danger); font-weight: 600; }
        .data-table .pending { color: var(--warning); font-weight: 600; }

        /* Message flow */
        .message-flow {
            background: var(--bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.85rem;
            overflow-x: auto;
        }

        .message-flow .msg {
            padding: 0.5rem 0;
            border-bottom: 1px dashed var(--border);
        }

        .message-flow .msg:last-child { border-bottom: none; }

        .message-flow .from { color: var(--node1); font-weight: 600; }
        .message-flow .to { color: var(--node2); font-weight: 600; }
        .message-flow .action { color: var(--secondary); }
        .message-flow .data { color: var(--text-muted); font-size: 0.8rem; }

        /* Scenario cards */
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .scenario-card {
            background: var(--bg);
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px solid var(--border);
            transition: all 0.3s;
        }

        .scenario-card:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15);
        }

        .scenario-card h4 {
            margin: 0 0 1rem;
            color: var(--primary-dark);
        }

        .scenario-card .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .hero { padding: 2rem; }
            .hero h1 { font-size: 1.75rem; }
            .node-chain { flex-direction: column; }
            .arrow { transform: rotate(90deg); }
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section { animation: fadeIn 0.5s ease-out; }

        /* Highlight */
        .highlight-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .highlight-box h4 {
            color: #b45309;
            margin-top: 0;
        }

        /* State badge */
        .state-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .state-badge.ready { background: #d1fae5; color: #047857; }
        .state-badge.transient { background: #fef3c7; color: #b45309; }
        .state-badge.not-ready { background: #fee2e2; color: #b91c1c; }
    </style>
</head>
<body>
<!-- CRAQ æ–‡æ¡£å¯¼èˆªæ  -->
<div id="craq-nav" style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(15, 15, 35, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 12px 20px;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
">
    <a href="/craq/" style="
        color: #00d4ff;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    " onmouseover="this.style.color='#7c3aed'" onmouseout="this.style.color='#00d4ff'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
        è¿”å› CRAQ æ–‡æ¡£é¦–é¡µ
    </a>
    
    <div style="flex: 1;"></div>
    
    <a href="/" style="
        color: #888;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.3s ease;
    " onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#888'">
        åšå®¢é¦–é¡µ
    </a>
</div>

<!-- ä¸ºå¯¼èˆªæ æ·»åŠ é¡¶éƒ¨é—´è· -->
<div style="height: 60px;"></div>

    <div class="container">
        <!-- Hero -->
        <header class="hero">
            <h1>ğŸ”„ CRAQ å¿«ç…§åœ¨æ•°æ®åŒæ­¥ä¸­çš„ä½œç”¨ä¸æµç¨‹è¯¦è§£</h1>
            <p class="subtitle">ä»¥ä¸‰èŠ‚ç‚¹é›†ç¾¤ä¸ºä¾‹ï¼Œæ·±å…¥åˆ†æèŠ‚ç‚¹æ•°æ®ä¸ä¸€è‡´æ—¶çš„å¿«ç…§åŒæ­¥æœºåˆ¶</p>
        </header>

        <!-- Navigation -->
        <nav class="nav-toc">
            <h3>ğŸ“‘ ç›®å½•</h3>
            <ul>
                <li><a href="#scenario">ä¸€ã€é—®é¢˜åœºæ™¯</a></li>
                <li><a href="#snapshot-role">äºŒã€å¿«ç…§çš„ä½œç”¨</a></li>
                <li><a href="#sync-flow">ä¸‰ã€åŒæ­¥æµç¨‹</a></li>
                <li><a href="#code-analysis">å››ã€æºç åˆ†æ</a></li>
                <li><a href="#detailed-example">äº”ã€è¯¦ç»†ç¤ºä¾‹</a></li>
                <li><a href="#edge-cases">å…­ã€è¾¹ç•Œæƒ…å†µ</a></li>
                <li><a href="#summary">ä¸ƒã€æ€»ç»“</a></li>
            </ul>
        </nav>

        <!-- Section 1: Problem Scenario -->
        <section id="scenario" class="section">
            <h2>ğŸ¯ ä¸€ã€é—®é¢˜åœºæ™¯ï¼šä¸‰èŠ‚ç‚¹æ•°æ®ä¸ä¸€è‡´</h2>

            <h3>1.1 CRAQ é“¾å¼å¤åˆ¶æ¶æ„</h3>

            <div class="node-diagram">
                <p style="text-align: center; margin-bottom: 1rem; color: var(--text-muted);">CRAQ ä¸‰èŠ‚ç‚¹é“¾å¼å¤åˆ¶æ‹“æ‰‘</p>
                <div class="node-chain">
                    <div class="node-box node1">
                        <div>Node1</div>
                        <div class="role">HEAD (å¤´èŠ‚ç‚¹)</div>
                        <div class="data">å†™å…¥å…¥å£</div>
                    </div>
                    <div class="arrow">â†’</div>
                    <div class="node-box node2">
                        <div>Node2</div>
                        <div class="role">MIDDLE (ä¸­é—´èŠ‚ç‚¹)</div>
                        <div class="data">æ•°æ®è½¬å‘</div>
                    </div>
                    <div class="arrow">â†’</div>
                    <div class="node-box node3">
                        <div>Node3</div>
                        <div class="role">TAIL (å°¾èŠ‚ç‚¹)</div>
                        <div class="data">ç¡®è®¤æäº¤</div>
                    </div>
                </div>
            </div>

            <h3>1.2 æ•°æ®ä¸ä¸€è‡´åœºæ™¯</h3>

            <div class="info-box problem">
                <h4>âŒ é—®é¢˜æè¿°</h4>
                <p>å‡è®¾ä¸‰ä¸ªèŠ‚ç‚¹çš„æ•°æ®çŠ¶æ€å¦‚ä¸‹ï¼ŒNode2 çš„æ•°æ®è½åäº Node1 å’Œ Node3ï¼š</p>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>èŠ‚ç‚¹</th>
                        <th>Timestamp</th>
                        <th>person:10</th>
                        <th>user:5</th>
                        <th>order:1</th>
                        <th>çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Node1 (HEAD)</strong></td>
                        <td>200</td>
                        <td class="synced">data_index=5 âœ“</td>
                        <td class="synced">data_index=3 âœ“</td>
                        <td class="synced">data_index=2 âœ“</td>
                        <td><span class="state-badge ready">READY</span></td>
                    </tr>
                    <tr>
                        <td><strong>Node2 (MIDDLE)</strong></td>
                        <td>150</td>
                        <td class="missing">data_index=3 âœ—</td>
                        <td class="missing">data_index=1 âœ—</td>
                        <td class="missing">ç¼ºå¤± âœ—</td>
                        <td><span class="state-badge not-ready">NOT_READY</span></td>
                    </tr>
                    <tr>
                        <td><strong>Node3 (TAIL)</strong></td>
                        <td>200</td>
                        <td class="synced">data_index=5 âœ“</td>
                        <td class="synced">data_index=3 âœ“</td>
                        <td class="synced">data_index=2 âœ“</td>
                        <td><span class="state-badge ready">READY</span></td>
                    </tr>
                </tbody>
            </table>

            <h3>1.3 ä¸ä¸€è‡´çš„åŸå› </h3>

            <div class="scenario-grid">
                <div class="scenario-card">
                    <div class="icon">ğŸ’¥</div>
                    <h4>åœºæ™¯ A: èŠ‚ç‚¹å´©æºƒé‡å¯</h4>
                    <p>Node2 å®•æœºæœŸé—´ï¼ŒNode1 å’Œ Node3 ç»§ç»­å¤„ç†å†™è¯·æ±‚ã€‚Node2 é‡å¯åæ•°æ®è½åã€‚</p>
                </div>
                <div class="scenario-card">
                    <div class="icon">ğŸŒ</div>
                    <h4>åœºæ™¯ B: ç½‘ç»œåˆ†åŒº</h4>
                    <p>Node2 ä¸å…¶ä»–èŠ‚ç‚¹ç½‘ç»œéš”ç¦»ï¼Œæ¢å¤åéœ€è¦åŒæ­¥ç¼ºå¤±çš„æ•°æ®ã€‚</p>
                </div>
                <div class="scenario-card">
                    <div class="icon">ğŸ†•</div>
                    <h4>åœºæ™¯ C: æ–°èŠ‚ç‚¹åŠ å…¥</h4>
                    <p>æ–°èŠ‚ç‚¹æ’å…¥åˆ°é“¾ä¸­ï¼Œéœ€è¦ä»ç°æœ‰èŠ‚ç‚¹è·å–å…¨éƒ¨æ•°æ®ã€‚</p>
                </div>
            </div>
        </section>

        <!-- Section 2: Snapshot Role -->
        <section id="snapshot-role" class="section">
            <h2>ğŸ“¸ äºŒã€å¿«ç…§åœ¨æ•°æ®åŒæ­¥ä¸­çš„ä½œç”¨</h2>

            <h3>2.1 å¿«ç…§çš„æ ¸å¿ƒä½œç”¨</h3>

            <div class="highlight-box">
                <h4>ğŸ’¡ å¿«ç…§ = åŒæ­¥è¾¹ç•Œæ ‡è¯†</h4>
                <p>å¿«ç…§ä¸æ˜¯å®Œæ•´çš„æ•°æ®å‰¯æœ¬ï¼Œè€Œæ˜¯ä¸€ä¸ª<strong>è½»é‡çº§çš„å…ƒæ•°æ®è¾¹ç•Œ</strong>ï¼Œç”¨äºæ ‡è¯†"æˆ‘å·²ç»åŒæ­¥åˆ°å“ªé‡Œäº†"ã€‚</p>
            </div>

            <pre>
<span class="comment">%% CRAQ å¿«ç…§ç»“æ„</span>
<span class="variable">Snapshot</span> = {<span class="variable">Timestamp</span>, <span class="variable">DataIndexList</span>}

<span class="comment">%% ç¤ºä¾‹ï¼šNode2 çš„å½“å‰å¿«ç…§</span>
{<span class="number">150</span>, [
    {{<span class="atom">person</span>, <span class="number">10</span>}, <span class="number">3</span>},   <span class="comment">%% person:10 å·²åŒæ­¥åˆ° data_index=3</span>
    {{<span class="atom">user</span>, <span class="number">5</span>}, <span class="number">1</span|}      <span class="comment">%% user:5 å·²åŒæ­¥åˆ° data_index=1</span>
    <span class="comment">%% order:1 ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œè¡¨ç¤ºå®Œå…¨æ²¡æœ‰</span>
]}

<span class="comment">%% å«ä¹‰ï¼š</span>
<span class="comment">%% - æ—¶é—´æˆ³ â‰¤ 150 çš„æ•°æ®å·²åŒæ­¥</span>
<span class="comment">%% - person:10 åœ¨ timestamp=150 æ—¶ï¼Œdata_index â‰¤ 3 å·²åŒæ­¥</span>
<span class="comment">%% - éœ€è¦åŒæ­¥ï¼štimestamp > 150 çš„æ‰€æœ‰æ•°æ®</span>
<span class="comment">%%            æˆ– timestamp = 150 ä¸” data_index > å·²è®°å½•å€¼çš„æ•°æ®</span>
            </pre>

            <h3>2.2 å¿«ç…§çš„ä¸‰å¤§ä½œç”¨</h3>

            <div class="scenario-grid">
                <div class="scenario-card">
                    <div class="icon">ğŸ¯</div>
                    <h4>1. ç¡®å®šåŒæ­¥èµ·ç‚¹</h4>
                    <p>å¿«ç…§æ ‡è¯†äº†è½åèŠ‚ç‚¹çš„å½“å‰è¿›åº¦ï¼Œæ•°æ®æä¾›æ–¹åªéœ€å‘é€å¿«ç…§ä¹‹åçš„å¢é‡æ•°æ®ã€‚</p>
                    <pre style="font-size: 0.75rem; margin-top: 0.5rem;">
éœ€è¦åŒæ­¥çš„æ•°æ® = 
  å…¨éƒ¨æ•°æ® - å¿«ç…§å·²åŒ…å«çš„æ•°æ®</pre>
                </div>
                <div class="scenario-card">
                    <div class="icon">âš¡</div>
                    <h4>2. å‡å°‘æ•°æ®ä¼ è¾“</h4>
                    <p>é¿å…å…¨é‡å¤åˆ¶ï¼Œåªä¼ è¾“å¢é‡æ•°æ®ï¼Œå¤§å¹…å‡å°‘ç½‘ç»œå¼€é”€ã€‚</p>
                    <pre style="font-size: 0.75rem; margin-top: 0.5rem;">
ä¼ ç»Ÿæ–¹å¼: ä¼ è¾“ 100% æ•°æ®
å¿«ç…§æ–¹å¼: ä¼ è¾“ ~10% å¢é‡æ•°æ®</pre>
                </div>
                <div class="scenario-card">
                    <div class="icon">ğŸ”’</div>
                    <h4>3. ä¿è¯ä¸€è‡´æ€§</h4>
                    <p>å¿«ç…§æä¾›äº†ä¸€ä¸ªä¸€è‡´æ€§è¾¹ç•Œï¼Œç¡®ä¿åŒæ­¥è¿‡ç¨‹ä¸­ä¸ä¼šé—æ¼æˆ–é‡å¤æ•°æ®ã€‚</p>
                    <pre style="font-size: 0.75rem; margin-top: 0.5rem;">
ä¸€è‡´æ€§ä¿è¯:
  å¿«ç…§å‰: å·²ç¡®è®¤åŒæ­¥
  å¿«ç…§å: å¢é‡ä¼ è¾“</pre>
                </div>
            </div>

            <h3>2.3 ä¸ºä»€ä¹ˆéœ€è¦ data_indexï¼Ÿ</h3>

            <div class="info-box info">
                <h4>ğŸ”¢ data_index çš„å¿…è¦æ€§</h4>
                <p>åŒä¸€æ—¶é—´æˆ³ï¼ˆäº‹åŠ¡ï¼‰å†…å¯èƒ½æœ‰å¤šä¸ªæ“ä½œä½œç”¨äºåŒä¸€å¯¹è±¡ï¼š</p>
            </div>

            <pre>
<span class="comment">%% äº‹åŠ¡ timestamp=150 å†…å¯¹ person:10 çš„å¤šä¸ªæ“ä½œ</span>
[
    {<span class="atom">person</span>, <span class="number">10</span>, <span class="number">150</span>, <span class="number">1</span>, <span class="atom">name</span>, <span class="string">"alice"</span>},   <span class="comment">%% data_index=1</span>
    {<span class="atom">person</span>, <span class="number">10</span>, <span class="number">150</span>, <span class="number">2</span>, <span class="atom">age</span>, <span class="number">25</span>},        <span class="comment">%% data_index=2</span>
    {<span class="atom">person</span>, <span class="number">10</span>, <span class="number">150</span>, <span class="number">3</span>, <span class="atom">city</span>, <span class="string">"beijing"</span|}  <span class="comment">%% data_index=3</span>
]

<span class="comment">%% å¦‚æœ Node2 çš„å¿«ç…§æ˜¯ {150, [{{person, 10}, 2}]}</span>
<span class="comment">%% è¡¨ç¤º person:10 åœ¨ timestamp=150 æ—¶åªåŒæ­¥åˆ° data_index=2</span>
<span class="comment">%% éœ€è¦è¡¥å……åŒæ­¥ï¼šdata_index=3 çš„æ•°æ®</span>
            </pre>
        </section>

        <!-- Section 3: Sync Flow -->
        <section id="sync-flow" class="section">
            <h2>ğŸ”„ ä¸‰ã€æ•°æ®åŒæ­¥å®Œæ•´æµç¨‹</h2>

            <h3>3.1 åŒæ­¥æµç¨‹æ¦‚è§ˆ</h3>

            <div class="node-diagram">
                <pre style="background: transparent; color: var(--text); padding: 0;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Node2 æ•°æ®åŒæ­¥å®Œæ•´æµç¨‹                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Node2 (è½åèŠ‚ç‚¹)              Node3 (åç»§èŠ‚ç‚¹)              ç³»ç»ŸçŠ¶æ€
       â”‚                            â”‚                           â”‚
       â”‚  1. æ£€æµ‹åˆ°æ•°æ®ä¸ä¸€è‡´         â”‚                           â”‚
       â”‚     çŠ¶æ€: NOT_READY         â”‚                           â”‚
       â”‚                            â”‚                           â”‚
       â”‚  2. ç”Ÿæˆæœ¬åœ°å¿«ç…§            â”‚                           â”‚
       â”‚     {150, [{{person,10},3}]}â”‚                           â”‚
       â”‚                            â”‚                           â”‚
       â”‚  3. å‘é€å¿«ç…§è¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚                           â”‚
       â”‚     ?EH_SNAPSHOT            â”‚                           â”‚
       â”‚                            â”‚                           â”‚
       â”‚                            â”‚  4. æ ¹æ®å¿«ç…§è¿‡æ»¤æ•°æ®        â”‚
       â”‚                            â”‚     snapshot_fun()         â”‚
       â”‚                            â”‚                           â”‚
       â”‚  5. æ¥æ”¶å¢é‡æ•°æ® â†â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                           â”‚
       â”‚     ?EH_UPDATE_SNAPSHOT     â”‚                           â”‚
       â”‚                            â”‚                           â”‚
       â”‚  6. åˆå¹¶æ•°æ®åˆ°æœ¬åœ°          â”‚                           â”‚
       â”‚     merge_data()           â”‚                           â”‚
       â”‚                            â”‚                           â”‚
       â”‚  7. çŠ¶æ€è½¬æ¢               â”‚                           â”‚
       â”‚     TRANSIENT â†’ READY      â”‚                           â”‚
       â”‚                            â”‚                           â”‚
       â–¼                            â–¼                           â–¼
                </pre>
            </div>

            <h3>3.2 è¯¦ç»†åŒæ­¥æ­¥éª¤</h3>

            <div class="sync-timeline">
                <div class="timeline-step" data-step="1">
                    <h4>Step 1: Node2 æ£€æµ‹åˆ°éœ€è¦åŒæ­¥</h4>
                    <p>Node2 é‡å¯æˆ–é‡æ–°åŠ å…¥é›†ç¾¤æ—¶ï¼Œå‘ç°è‡ªå·±çš„æ•°æ®è½åã€‚è§¦å‘æ¡ä»¶å¯èƒ½æ˜¯ï¼š</p>
                    <ul>
                        <li>èŠ‚ç‚¹é‡å¯åé‡æ–°åŠ å…¥</li>
                        <li>åç»§èŠ‚ç‚¹æ•…éšœï¼Œéœ€è¦å‘æ–°åç»§è¯·æ±‚æ•°æ®</li>
                        <li>æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</li>
                    </ul>
                    <div class="code-snippet">
<span class="comment">%% eh_system_server.erl:97-102</span>
<span class="keyword">case</span> eh_node_timestamp:valid_add_node_msg(Node, State) <span class="keyword">of</span>
    ?EH_VALID_FOR_NEW ->
        <span class="comment">%% æ–°èŠ‚ç‚¹ï¼Œéœ€è¦è¯·æ±‚å¿«ç…§</span>
        NewState1 = process_snapshot_request(NodeList1, NodeOrderList1, Succ1, State),
        ...
                    </div>
                </div>

                <div class="timeline-step" data-step="2">
                    <h4>Step 2: Node2 ç”Ÿæˆæœ¬åœ°å¿«ç…§å¹¶å‘é€è¯·æ±‚</h4>
                    <p>Node2 è·å–è‡ªå·±çš„å½“å‰å¿«ç…§ï¼ˆæ—¶é—´æˆ³ + æ•°æ®ç´¢å¼•åˆ—è¡¨ï¼‰ï¼Œå‘é€ç»™åç»§èŠ‚ç‚¹ Node3ã€‚</p>
                    <div class="code-snippet">
<span class="comment">%% eh_system_server.erl:402-409</span>
process_snapshot_request(NodeList, NodeOrderList, Succ, State) ->
    <span class="comment">%% è·å–æœ¬åœ°å¿«ç…§</span>
    {Timestamp, Snapshot} = ReplDataManager:timestamp(),
    <span class="comment">%% å‘é€ç»™åç»§èŠ‚ç‚¹</span>
    gen_server:cast({?EH_SYSTEM_SERVER, Succ}, 
        {?EH_SNAPSHOT, {NodeId, NodeList, NodeOrderList, SnapshotRef, {Timestamp, Snapshot}}}).
                    </div>
                </div>

                <div class="timeline-step" data-step="3">
                    <h4>Step 3: Node3 æ”¶åˆ°è¯·æ±‚ï¼Œè¿‡æ»¤å¢é‡æ•°æ®</h4>
                    <p>Node3 æ ¹æ® Node2 çš„å¿«ç…§ï¼Œè¿‡æ»¤å‡º Node2 ç¼ºå¤±çš„æ•°æ®ã€‚</p>
                    <div class="code-snippet">
<span class="comment">%% eh_system_server.erl:112-123</span>
handle_cast({?EH_SNAPSHOT, {Node, NodeList, NodeOrderList, Ref, {Timestamp, Snapshot}}}, State) ->
    <span class="comment">%% æ ¹æ®å¿«ç…§è¿‡æ»¤æ•°æ®</span>
    Q0 = ReplDataManager:snapshot(Timestamp, Snapshot),
    <span class="comment">%% å‘é€å¢é‡æ•°æ®ç»™è¯·æ±‚èŠ‚ç‚¹</span>
    gen_server:cast({?EH_SYSTEM_SERVER, Node}, {?EH_UPDATE_SNAPSHOT, {Ref, Q0, PendingPreMsgMap}}).
                    </div>
                </div>

                <div class="timeline-step" data-step="4">
                    <h4>Step 4: æ•°æ®è¿‡æ»¤ç®—æ³•æ‰§è¡Œ</h4>
                    <p>æ ¸å¿ƒçš„ <code>snapshot_fun/3</code> å‡½æ•°å†³å®šå“ªäº›æ•°æ®éœ€è¦å‘é€ï¼š</p>
                    <div class="code-snippet">
<span class="comment">%% eh_data_util.erl:57-73</span>
<span class="comment">%% æƒ…å†µ1: æ•°æ®æ—¶é—´æˆ³ > å¿«ç…§æ—¶é—´æˆ³ â†’ åŒ…å«</span>
snapshot_fun({CTimestamp, _, StorageKey}, 
             #eh_storage_value{timestamp=Timestamp}=StorageValue, Qo0) 
  <span class="keyword">when</span> Timestamp > CTimestamp ->
    [storage_data(StorageKey, StorageValue) | Qo0];

<span class="comment">%% æƒ…å†µ2: æ—¶é—´æˆ³ç›¸åŒï¼Œæ¯”è¾ƒ data_index</span>
snapshot_fun({CTimestamp, CDataIndexList, StorageKey}, StorageValue, Qo0)
  <span class="keyword">when</span> Timestamp =:= CTimestamp ->
    <span class="keyword">case</span> lists:keyfind({ObjectType, ObjectId}, 1, CDataIndexList) <span class="keyword">of</span>
        {_, CDataIndex} <span class="keyword">when</span> DataIndex > CDataIndex ->
            [storage_data(...) | Qo0];  <span class="comment">%% åŒ…å«</span>
        _ ->
            Qo0  <span class="comment">%% è·³è¿‡</span>
    <span class="keyword">end</span>;

<span class="comment">%% æƒ…å†µ3: æ•°æ®æ—¶é—´æˆ³ < å¿«ç…§æ—¶é—´æˆ³ â†’ è·³è¿‡</span>
snapshot_fun(_, _, Qo0) -> Qo0.
                    </div>
                </div>

                <div class="timeline-step" data-step="5">
                    <h4>Step 5: Node2 æ¥æ”¶å¹¶åˆå¹¶æ•°æ®</h4>
                    <p>Node2 æ”¶åˆ°å¢é‡æ•°æ®åï¼Œåˆå¹¶åˆ°æœ¬åœ°å­˜å‚¨ã€‚</p>
                    <div class="code-snippet">
<span class="comment">%% eh_system_server.erl:125-138</span>
handle_cast({?EH_UPDATE_SNAPSHOT, {Ref, Q0, PendingPreMsgData}}, State) ->
    <span class="comment">%% åˆå¹¶å¢é‡æ•°æ®</span>
    ReplDataManager:update_snapshot(Q0),
    <span class="comment">%% æ›´æ–°çŠ¶æ€</span>
    NewState2 = eh_node_state:update_state_snapshot(State).
                    </div>
                </div>

                <div class="timeline-step" data-step="6">
                    <h4>Step 6: çŠ¶æ€è½¬æ¢ï¼ŒNode2 å°±ç»ª</h4>
                    <p>æ•°æ®åŒæ­¥å®Œæˆåï¼ŒNode2 çŠ¶æ€è½¬æ¢ä¸º READYï¼Œå¯ä»¥æ­£å¸¸å‚ä¸é“¾å¤åˆ¶ã€‚</p>
                    <div class="code-snippet">
<span class="comment">%% çŠ¶æ€è½¬æ¢è·¯å¾„</span>
NOT_READY â†’ TRANSIENT â†’ TRANSIENT_DU â†’ TRANSIENT_TU â†’ READY

<span class="comment">%% eh_node_state.erl:43-48</span>
update_state_snapshot(#eh_system_state{node_status=?EH_TRANSIENT}=State) ->
    update_state(?EH_TRANSIENT_DU, State);
update_state_snapshot(#eh_system_state{node_status=?EH_TRANSIENT_TU}=State) ->
    update_state(?EH_READY, State).
                    </div>
                </div>
            </div>

            <h3>3.3 æ¶ˆæ¯æµè¯¦è§£</h3>

            <div class="message-flow">
                <div class="msg">
                    <span class="from">Node2</span> â†’ <span class="to">Node3</span>: 
                    <span class="action">?EH_SNAPSHOT</span>
                    <div class="data">{NodeId, NodeList, NodeOrderList, Ref, {150, [{{person,10},3}, {{user,5},1}]}}</div>
                </div>
                <div class="msg">
                    <span class="from">Node3</span>: 
                    <span class="action">snapshot_fun() è¿‡æ»¤æ•°æ®</span>
                    <div class="data">è¿‡æ»¤å‡º timestamp > 150 æˆ– (timestamp=150 ä¸” data_index > å·²åŒæ­¥å€¼) çš„æ•°æ®</div>
                </div>
                <div class="msg">
                    <span class="from">Node3</span> â†’ <span class="to">Node2</span>: 
                    <span class="action">?EH_UPDATE_SNAPSHOT</span>
                    <div class="data">{Ref, Queue([{person,10,200,4,...}, {person,10,200,5,...}, {user,5,180,2,...}, ...]), PendingMsgs}</div>
                </div>
                <div class="msg">
                    <span class="from">Node2</span>: 
                    <span class="action">merge_data() åˆå¹¶æ•°æ®</span>
                    <div class="data">å°†å¢é‡æ•°æ®åˆå¹¶åˆ°æœ¬åœ°å­˜å‚¨ï¼Œæ›´æ–° timestamp å’Œ data_index_list</div>
                </div>
                <div class="msg">
                    <span class="from">Node2</span>: 
                    <span class="action">çŠ¶æ€è½¬æ¢</span>
                    <div class="data">NOT_READY â†’ TRANSIENT â†’ TRANSIENT_DU â†’ READY</div>
                </div>
            </div>
        </section>

        <!-- Section 4: Code Analysis -->
        <section id="code-analysis" class="section">
            <h2>ğŸ’» å››ã€æ ¸å¿ƒæºç åˆ†æ</h2>

            <h3>4.1 å¿«ç…§è¯·æ±‚å¤„ç† (eh_system_server.erl)</h3>

            <pre>
<span class="comment">%% æ–‡ä»¶: src/eh_system_server.erl</span>
<span class="comment">%% åŠŸèƒ½: å¤„ç†å¿«ç…§è¯·æ±‚ï¼Œç”Ÿæˆå¹¶å‘é€å¢é‡æ•°æ®</span>

<span class="comment">%% è¡Œ 112-123: æ”¶åˆ°å¿«ç…§è¯·æ±‚</span>
<span class="function">handle_cast</span>({<span class="atom">?EH_SNAPSHOT</span>, {<span class="variable">Node</span>, <span class="variable">NodeList</span>, <span class="variable">NodeOrderList</span>, <span class="variable">Ref</span>, {<span class="variable">Timestamp</span>, <span class="variable">Snapshot</span>}}}, 
            #<span class="atom">eh_system_state</span>{<span class="atom">pre_msg_data</span>=<span class="variable">PreMsgData</span>, <span class="atom">app_config</span>=<span class="variable">AppConfig</span>}=<span class="variable">State</span>) <span class="operator">-></span>
    
    <span class="comment">%% è·å–æ•°æ®ç®¡ç†å™¨</span>
    <span class="variable">ReplDataManager</span> = <span class="function">eh_system_config:get_repl_data_manager</span>(<span class="variable">AppConfig</span>),
    
    <span class="comment">%% ğŸ”¥ æ ¸å¿ƒï¼šæ ¹æ®è¯·æ±‚æ–¹çš„å¿«ç…§è¿‡æ»¤å‡ºå¢é‡æ•°æ®</span>
    <span class="variable">Q0</span> = <span class="variable">ReplDataManager</span>:<span class="function">snapshot</span>(<span class="variable">Timestamp</span>, <span class="variable">Snapshot</span>),
    <span class="comment">%% Q0 æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼ŒåŒ…å«æ‰€æœ‰éœ€è¦å‘é€çš„æ•°æ®</span>
    
    <span class="comment">%% è·å–å¾…å¤„ç†çš„æ¶ˆæ¯ï¼ˆæ­£åœ¨è¿›è¡Œä¸­çš„å†™æ“ä½œï¼‰</span>
    <span class="variable">PendingPreMsgMap</span> = <span class="function">eh_update_msg:filter_effective_head_node_id</span>(<span class="variable">PreMsgData</span>, <span class="variable">State</span>),
    
    <span class="comment">%% å‘é€å¢é‡æ•°æ®ç»™è¯·æ±‚èŠ‚ç‚¹</span>
    <span class="function">gen_server:cast</span>({<span class="atom">?EH_SYSTEM_SERVER</span>, <span class="variable">Node</span>}, 
                   {<span class="atom">?EH_UPDATE_SNAPSHOT</span>, {<span class="variable">Ref</span>, <span class="variable">Q0</span>, <span class="variable">PendingPreMsgMap</span>}}),
    
    {<span class="atom">noreply</span>, <span class="variable">NewState2</span>};
            </pre>

            <h3>4.2 æ•°æ®è¿‡æ»¤ç®—æ³• (eh_data_util.erl)</h3>

            <pre>
<span class="comment">%% æ–‡ä»¶: src/eh_data_util.erl</span>
<span class="comment">%% åŠŸèƒ½: æ ¹æ®å¿«ç…§è¿‡æ»¤å‡ºéœ€è¦åŒæ­¥çš„æ•°æ®</span>

<span class="comment">%% è¡Œ 57-73: å¿«ç…§è¿‡æ»¤å‡½æ•°</span>

<span class="comment">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="comment">%% æƒ…å†µ 1: æ•°æ®æ—¶é—´æˆ³ > å¿«ç…§æ—¶é—´æˆ³</span>
<span class="comment">%% è¯´æ˜: è¿™æ˜¯å¿«ç…§ä¹‹åçš„æ–°æ•°æ®ï¼Œå¿…é¡»åŒ…å«</span>
<span class="comment">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="function">snapshot_fun</span>({<span class="variable">CTimestamp</span>, <span class="variable">_CDataIndexList</span>, <span class="variable">StorageKey</span>}, 
             #<span class="atom">eh_storage_value</span>{<span class="atom">timestamp</span>=<span class="variable">Timestamp</span|}=<span class="variable">StorageValue</span>, <span class="variable">Qo0</span>) 
  <span class="keyword">when</span> <span class="variable">Timestamp</span> <span class="operator">></span> <span class="variable">CTimestamp</span> <span class="operator">-></span>
    <span class="comment">%% ç›´æ¥æ·»åŠ åˆ°ç»“æœé˜Ÿåˆ—</span>
    [<span class="function">storage_data</span>(<span class="variable">StorageKey</span>, <span class="variable">StorageValue</span>) | <span class="variable">Qo0</span>];

<span class="comment">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="comment">%% æƒ…å†µ 2: æ•°æ®æ—¶é—´æˆ³ = å¿«ç…§æ—¶é—´æˆ³</span>
<span class="comment">%% è¯´æ˜: åŒä¸€äº‹åŠ¡å†…ï¼Œéœ€è¦æ¯”è¾ƒ data_index</span>
<span class="comment">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="function">snapshot_fun</span>({<span class="variable">CTimestamp</span>, <span class="variable">CDataIndexList</span>, 
              #<span class="atom">eh_storage_key</span>{<span class="atom">object_type</span>=<span class="variable">ObjectType</span>, <span class="atom">object_id</span>=<span class="variable">ObjectId</span>}=<span class="variable">StorageKey</span>},
             #<span class="atom">eh_storage_value</span>{<span class="atom">timestamp</span>=<span class="variable">Timestamp</span>, <span class="atom">data_index</span>=<span class="variable">DataIndex</span>}=<span class="variable">StorageValue</span>, <span class="variable">Qo0</span>)
  <span class="keyword">when</span> <span class="variable">Timestamp</span> <span class="operator">=:=</span> <span class="variable">CTimestamp</span> <span class="operator">-></span>
    <span class="keyword">case</span> <span class="function">lists:keyfind</span>({<span class="variable">ObjectType</span>, <span class="variable">ObjectId</span>}, <span class="number">1</span>, <span class="variable">CDataIndexList</span>) <span class="keyword">of</span>
        <span class="atom">false</span> <span class="operator">-></span>
            <span class="comment">%% å¯¹è±¡ä¸åœ¨å¿«ç…§ä¸­ï¼Œè¯´æ˜æ˜¯æ–°å¯¹è±¡ï¼ŒåŒ…å«</span>
            [<span class="function">storage_data</span>(<span class="variable">StorageKey</span>, <span class="variable">StorageValue</span>) | <span class="variable">Qo0</span>];
        {<span class="variable">_</span>, <span class="variable">CDataIndex</span>} <span class="keyword">when</span> <span class="variable">DataIndex</span> <span class="operator">></span> <span class="variable">CDataIndex</span> <span class="operator">-></span>
            <span class="comment">%% data_index > å¿«ç…§è®°å½•çš„å€¼ï¼Œè¯´æ˜æ˜¯æ–°æ“ä½œï¼ŒåŒ…å«</span>
            [<span class="function">storage_data</span>(<span class="variable">StorageKey</span>, <span class="variable">StorageValue</span>) | <span class="variable">Qo0</span>];
        <span class="variable">_</span> <span class="operator">-></span>
            <span class="comment">%% data_index â‰¤ å¿«ç…§è®°å½•çš„å€¼ï¼Œå·²åŒæ­¥ï¼Œè·³è¿‡</span>
            <span class="variable">Qo0</span>
    <span class="keyword">end</span>;

<span class="comment">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="comment">%% æƒ…å†µ 3: æ•°æ®æ—¶é—´æˆ³ < å¿«ç…§æ—¶é—´æˆ³</span>
<span class="comment">%% è¯´æ˜: è¿™æ˜¯å¿«ç…§ä¹‹å‰çš„æ—§æ•°æ®ï¼Œå·²ç»åŒæ­¥ï¼Œè·³è¿‡</span>
<span class="comment">%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="function">snapshot_fun</span>(<span class="variable">_</span>, <span class="variable">_</span>, <span class="variable">Qo0</span>) <span class="operator">-></span>
    <span class="variable">Qo0</span>.
            </pre>

            <h3>4.3 æ•°æ®åˆå¹¶ (eh_data_util.erl)</h3>

            <pre>
<span class="comment">%% æ–‡ä»¶: src/eh_data_util.erl</span>
<span class="comment">%% åŠŸèƒ½: å°†å¢é‡æ•°æ®åˆå¹¶åˆ°æœ¬åœ°å­˜å‚¨</span>

<span class="comment">%% è¡Œ 163-179: æ•°æ®åˆå¹¶å‡½æ•°</span>
<span class="function">merge_data</span>(<span class="variable">Q0</span>, <span class="variable">TQ0</span>, {<span class="variable">StateTimestamp</span>, <span class="variable">StateDataIndexList</span>}, <span class="variable">M0</span>) <span class="operator">-></span>
    <span class="comment">%% Q0: å¿«ç…§å¢é‡æ•°æ®é˜Ÿåˆ—</span>
    <span class="comment">%% TQ0: ä¸´æ—¶æ•°æ®é˜Ÿåˆ—ï¼ˆåŒæ­¥æœŸé—´æ”¶åˆ°çš„æ–°æ•°æ®ï¼‰</span>
    <span class="comment">%% M0: æœ¬åœ°æ•°æ®å­˜å‚¨</span>
    
    <span class="comment">%% å…ˆåˆå¹¶å¿«ç…§æ•°æ®</span>
    {<span class="variable">TS1</span>, <span class="variable">DIL1</span>, <span class="variable">Q1</span>, <span class="variable">M1</span>} = <span class="function">merge_data_acc</span>(<span class="variable">Q0</span>, <span class="function">queue:new</span>(), <span class="variable">M0</span>, <span class="variable">StateTimestamp</span>, <span class="variable">StateDataIndexList</span>, <span class="atom">true</span>),
    
    <span class="comment">%% å†åˆå¹¶ä¸´æ—¶æ•°æ®</span>
    <span class="function">merge_data_acc</span>(<span class="variable">TQ0</span>, <span class="variable">Q1</span>, <span class="variable">M1</span>, <span class="variable">TS1</span>, <span class="variable">DIL1</span>, <span class="atom">true</span>).

<span class="function">merge_data_acc</span>(<span class="variable">Qi0</span>, <span class="variable">Qo0</span>, <span class="variable">Mi0</span>, <span class="variable">TS0</span>, <span class="variable">DIL0</span>, <span class="variable">CheckFlag</span>) <span class="operator">-></span>
    <span class="keyword">case</span> <span class="function">queue:out</span>(<span class="variable">Qi0</span>) <span class="keyword">of</span>
        {<span class="atom">empty</span>, <span class="variable">_</span>} <span class="operator">-></span>
            {<span class="variable">TS0</span>, <span class="variable">DIL0</span>, <span class="variable">Qo0</span>, <span class="variable">Mi0</span>};
        {{<span class="atom">value</span>, <span class="variable">StorageData</span>}, <span class="variable">Qi1</span>} <span class="operator">-></span>
            <span class="comment">%% æ£€æŸ¥æ•°æ®æ˜¯å¦æ¯”å½“å‰æ—¶é—´æˆ³æ–°</span>
            <span class="keyword">case</span> (<span class="keyword">not</span> <span class="variable">CheckFlag</span>) <span class="keyword">orelse</span> (<span class="variable">StorageData</span>#<span class="atom">eh_storage_data</span>.<span class="atom">timestamp</span> <span class="operator">></span> <span class="variable">TS0</span>) <span class="keyword">of</span>
                <span class="atom">true</span> <span class="operator">-></span>
                    <span class="comment">%% æ·»åŠ æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨</span>
                    {<span class="variable">_</span>, {<span class="variable">_</span>, <span class="variable">DIL1</span>}, <span class="variable">Qo1</span>, <span class="variable">Mi1</span>} = <span class="function">add_data</span>(<span class="variable">StorageData</span>, <span class="variable">Qo0</span>, {<span class="variable">TS0</span>, <span class="variable">DIL0</span>}, <span class="variable">Mi0</span>),
                    <span class="function">merge_data_acc</span>(<span class="variable">Qi1</span>, <span class="variable">Qo1</span>, <span class="variable">Mi1</span>, <span class="variable">StorageData</span>#<span class="atom">eh_storage_data</span>.<span class="atom">timestamp</span>, <span class="variable">DIL1</span>, <span class="atom">false</span>);
                <span class="atom">false</span> <span class="operator">-></span>
                    <span class="comment">%% æ•°æ®å·²å­˜åœ¨æˆ–è¿‡æ—¶ï¼Œè·³è¿‡</span>
                    <span class="function">merge_data_acc</span>(<span class="variable">Qi1</span>, <span class="variable">Qo0</span>, <span class="variable">Mi0</span>, <span class="variable">TS0</span>, <span class="variable">DIL0</span>, <span class="variable">CheckFlag</span>)
            <span class="keyword">end</span>
    <span class="keyword">end</span>.
            </pre>

            <h3>4.4 å¿«ç…§æ—¶é—´æˆ³æ›´æ–° (eh_data_util.erl)</h3>

            <pre>
<span class="comment">%% æ–‡ä»¶: src/eh_data_util.erl</span>
<span class="comment">%% åŠŸèƒ½: æ›´æ–°å¿«ç…§çš„æ—¶é—´æˆ³å’Œæ•°æ®ç´¢å¼•åˆ—è¡¨</span>

<span class="comment">%% è¡Œ 233-243: æ—¶é—´æˆ³æ›´æ–°å‡½æ•°</span>

<span class="comment">%% æƒ…å†µ 1: æ–°æ•°æ®æ—¶é—´æˆ³ > å½“å‰æ—¶é—´æˆ³ï¼ˆæ–°äº‹åŠ¡ï¼‰</span>
<span class="function">update_timestamp</span>(#<span class="atom">eh_storage_data</span>{<span class="atom">object_type</span>=<span class="variable">ObjectType</span>, <span class="atom">object_id</span>=<span class="variable">ObjectId</span>, 
                                    <span class="atom">timestamp</span>=<span class="variable">EntryTimestamp</span>, <span class="atom">data_index</span>=<span class="variable">EntryDataIndex</span>},
                 {<span class="variable">Timestamp</span>, <span class="variable">_List</span>}) <span class="keyword">when</span> <span class="variable">EntryTimestamp</span> <span class="operator">></span> <span class="variable">Timestamp</span> <span class="operator">-></span>
    <span class="comment">%% è¿›å…¥æ–°æ—¶é—´çºªå…ƒï¼Œæ¸…ç©ºæ—§åˆ—è¡¨</span>
    {<span class="variable">EntryTimestamp</span>, [{{<span class="variable">ObjectType</span>, <span class="variable">ObjectId</span>}, <span class="variable">EntryDataIndex</span>}]};

<span class="comment">%% æƒ…å†µ 2: æ–°æ•°æ®æ—¶é—´æˆ³ = å½“å‰æ—¶é—´æˆ³ï¼ˆåŒäº‹åŠ¡ï¼‰</span>
<span class="function">update_timestamp</span>(#<span class="atom">eh_storage_data</span>{<span class="atom">object_type</span>=<span class="variable">ObjectType</span>, <span class="atom">object_id</span>=<span class="variable">ObjectId</span>, 
                                    <span class="atom">timestamp</span>=<span class="variable">EntryTimestamp</span>, <span class="atom">data_index</span>=<span class="variable">EntryDataIndex</span>},
                 {<span class="variable">Timestamp</span>, <span class="variable">List</span>}) <span class="keyword">when</span> <span class="variable">EntryTimestamp</span> <span class="operator">=:=</span> <span class="variable">Timestamp</span> <span class="operator">-></span>
    <span class="variable">Object</span> = {<span class="variable">ObjectType</span>, <span class="variable">ObjectId</span>},
    <span class="comment">%% å…ˆåˆ é™¤æ—§è®°å½•ï¼Œå†æ·»åŠ æ–°è®°å½•ï¼ˆä¿è¯æœ€æ–°ï¼‰</span>
    <span class="variable">List1</span> = [{<span class="variable">Object</span>, <span class="variable">EntryDataIndex</span>} | <span class="function">lists:keydelete</span>(<span class="variable">Object</span>, <span class="number">1</span>, <span class="variable">List</span>)],
    {<span class="variable">Timestamp</span>, <span class="variable">List1</span>};

<span class="comment">%% æƒ…å†µ 3: æ–°æ•°æ®æ—¶é—´æˆ³ < å½“å‰æ—¶é—´æˆ³ï¼ˆè¿‡æ—¶æ•°æ®ï¼‰</span>
<span class="function">update_timestamp</span>(<span class="variable">_Entry</span>, {<span class="variable">Timestamp</span>, <span class="variable">List</span>}) <span class="operator">-></span>
    <span class="comment">%% å¿½ç•¥è¿‡æ—¶æ•°æ®ï¼Œä¿æŒä¸å˜</span>
    {<span class="variable">Timestamp</span>, <span class="variable">List</span>}.
            </pre>
        </section>

        <!-- Section 5: Detailed Example -->
        <section id="detailed-example" class="section">
            <h2>ğŸ“Š äº”ã€è¯¦ç»†ç¤ºä¾‹ï¼šNode2 åŒæ­¥è¿‡ç¨‹</h2>

            <h3>5.1 åˆå§‹çŠ¶æ€</h3>

            <div class="node-diagram">
                <p style="text-align: center; color: var(--text-muted); margin-bottom: 1rem;">åŒæ­¥å‰å„èŠ‚ç‚¹æ•°æ®çŠ¶æ€</p>
                <div class="node-chain">
                    <div class="node-box node1">
                        <div>Node1</div>
                        <div class="role">Timestamp: 200</div>
                        <div class="data">person:10 â†’ idx=5<br>user:5 â†’ idx=3<br>order:1 â†’ idx=2</div>
                    </div>
                    <div class="arrow highlight">â†’</div>
                    <div class="node-box node2" style="opacity: 0.6;">
                        <div>Node2 âš ï¸</div>
                        <div class="role">Timestamp: 150</div>
                        <div class="data">person:10 â†’ idx=3<br>user:5 â†’ idx=1<br>order:1 â†’ âŒ</div>
                    </div>
                    <div class="arrow">â†’</div>
                    <div class="node-box node3">
                        <div>Node3</div>
                        <div class="role">Timestamp: 200</div>
                        <div class="data">person:10 â†’ idx=5<br>user:5 â†’ idx=3<br>order:1 â†’ idx=2</div>
                    </div>
                </div>
            </div>

            <h3>5.2 Step-by-Step åŒæ­¥è¿‡ç¨‹</h3>

            <div class="info-box scenario">
                <h4>ğŸ“ Step 1: Node2 ç”Ÿæˆæœ¬åœ°å¿«ç…§</h4>
                <pre style="background: rgba(0,0,0,0.1); padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
Node2 çš„å¿«ç…§:
{150, [{{person, 10}, 3}, {{user, 5}, 1}]}

å«ä¹‰:
- æ—¶é—´æˆ³ 150 ä¹‹å‰çš„æ•°æ®å·²åŒæ­¥
- person:10 åœ¨ ts=150 æ—¶åŒæ­¥åˆ° data_index=3
- user:5 åœ¨ ts=150 æ—¶åŒæ­¥åˆ° data_index=1
- order:1 å®Œå…¨æ²¡æœ‰ï¼ˆä¸åœ¨åˆ—è¡¨ä¸­ï¼‰
                </pre>
            </div>

            <div class="info-box info">
                <h4>ğŸ“ Step 2: Node2 å‘é€å¿«ç…§è¯·æ±‚ç»™ Node3</h4>
                <pre style="background: rgba(0,0,0,0.1); padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
æ¶ˆæ¯: {?EH_SNAPSHOT, {
    Node = 'node2@host',
    NodeList = ['node1@host', 'node2@host', 'node3@host'],
    NodeOrderList = [...],
    Ref = #Ref<0.0.1.234>,
    Snapshot = {150, [{{person, 10}, 3}, {{user, 5}, 1}]}
}}
                </pre>
            </div>

            <div class="info-box solution">
                <h4>ğŸ“ Step 3: Node3 è¿‡æ»¤å¢é‡æ•°æ®</h4>
                <p>Node3 éå†è‡ªå·±çš„æ•°æ®ï¼Œæ ¹æ® Node2 çš„å¿«ç…§è¿‡æ»¤ï¼š</p>
                <pre style="background: rgba(0,0,0,0.1); padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
Node3 çš„æ•°æ®:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Object     â”‚ Timestamp â”‚ DataIndex  â”‚ æ˜¯å¦å‘é€  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ person:10  â”‚ 100       â”‚ 1          â”‚ âŒ è·³è¿‡ (ts < 150) â”‚
â”‚ person:10  â”‚ 100       â”‚ 2          â”‚ âŒ è·³è¿‡ (ts < 150) â”‚
â”‚ person:10  â”‚ 150       â”‚ 1          â”‚ âŒ è·³è¿‡ (idx â‰¤ 3)  â”‚
â”‚ person:10  â”‚ 150       â”‚ 2          â”‚ âŒ è·³è¿‡ (idx â‰¤ 3)  â”‚
â”‚ person:10  â”‚ 150       â”‚ 3          â”‚ âŒ è·³è¿‡ (idx â‰¤ 3)  â”‚
â”‚ person:10  â”‚ 180       â”‚ 4          â”‚ âœ… å‘é€ (ts > 150) â”‚
â”‚ person:10  â”‚ 200       â”‚ 5          â”‚ âœ… å‘é€ (ts > 150) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ user:5     â”‚ 120       â”‚ 1          â”‚ âŒ è·³è¿‡ (ts < 150) â”‚
â”‚ user:5     â”‚ 150       â”‚ 1          â”‚ âŒ è·³è¿‡ (idx â‰¤ 1)  â”‚
â”‚ user:5     â”‚ 160       â”‚ 2          â”‚ âœ… å‘é€ (ts > 150) â”‚
â”‚ user:5     â”‚ 200       â”‚ 3          â”‚ âœ… å‘é€ (ts > 150) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ order:1    â”‚ 180       â”‚ 1          â”‚ âœ… å‘é€ (æ–°å¯¹è±¡)   â”‚
â”‚ order:1    â”‚ 200       â”‚ 2          â”‚ âœ… å‘é€ (ts > 150) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¿‡æ»¤ç»“æœé˜Ÿåˆ— Q0:
[
  {person, 10, 180, 4, active, email, "alice@example.com"},
  {person, 10, 200, 5, active, phone, "123456789"},
  {user, 5, 160, 2, active, role, "admin"},
  {user, 5, 200, 3, active, status, "online"},
  {order, 1, 180, 1, active, product, "laptop"},
  {order, 1, 200, 2, active, quantity, 2}
]
                </pre>
            </div>

            <div class="info-box info">
                <h4>ğŸ“ Step 4: Node3 å‘é€å¢é‡æ•°æ®ç»™ Node2</h4>
                <pre style="background: rgba(0,0,0,0.1); padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
æ¶ˆæ¯: {?EH_UPDATE_SNAPSHOT, {
    Ref = #Ref<0.0.1.234>,
    Q0 = Queue([6æ¡å¢é‡æ•°æ®]),
    PendingPreMsgMap = #{...}  %% æ­£åœ¨è¿›è¡Œä¸­çš„å†™æ“ä½œ
}}
                </pre>
            </div>

            <div class="info-box solution">
                <h4>ğŸ“ Step 5: Node2 åˆå¹¶æ•°æ®å¹¶æ›´æ–°çŠ¶æ€</h4>
                <pre style="background: rgba(0,0,0,0.1); padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
åˆå¹¶å‰ Node2:
  Timestamp: 150
  DataIndexList: [{{person, 10}, 3}, {{user, 5}, 1}]
  Data: {person:10 â†’ 3æ¡, user:5 â†’ 1æ¡}

åˆå¹¶å Node2:
  Timestamp: 200
  DataIndexList: [{{person, 10}, 5}, {{user, 5}, 3}, {{order, 1}, 2}]
  Data: {person:10 â†’ 5æ¡, user:5 â†’ 3æ¡, order:1 â†’ 2æ¡}

çŠ¶æ€è½¬æ¢: NOT_READY â†’ TRANSIENT â†’ TRANSIENT_DU â†’ READY
                </pre>
            </div>

            <h3>5.3 åŒæ­¥åçŠ¶æ€</h3>

            <div class="node-diagram">
                <p style="text-align: center; color: var(--success); margin-bottom: 1rem; font-weight: 600;">âœ… åŒæ­¥å®Œæˆï¼Œæ‰€æœ‰èŠ‚ç‚¹æ•°æ®ä¸€è‡´</p>
                <div class="node-chain">
                    <div class="node-box node1">
                        <div>Node1</div>
                        <div class="role">Timestamp: 200</div>
                        <div class="data">person:10 â†’ idx=5 âœ“<br>user:5 â†’ idx=3 âœ“<br>order:1 â†’ idx=2 âœ“</div>
                    </div>
                    <div class="arrow">â†’</div>
                    <div class="node-box node2">
                        <div>Node2 âœ…</div>
                        <div class="role">Timestamp: 200</div>
                        <div class="data">person:10 â†’ idx=5 âœ“<br>user:5 â†’ idx=3 âœ“<br>order:1 â†’ idx=2 âœ“</div>
                    </div>
                    <div class="arrow">â†’</div>
                    <div class="node-box node3">
                        <div>Node3</div>
                        <div class="role">Timestamp: 200</div>
                        <div class="data">person:10 â†’ idx=5 âœ“<br>user:5 â†’ idx=3 âœ“<br>order:1 â†’ idx=2 âœ“</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 6: Edge Cases -->
        <section id="edge-cases" class="section">
            <h2>âš ï¸ å…­ã€è¾¹ç•Œæƒ…å†µå¤„ç†</h2>

            <h3>6.1 åŒæ­¥æœŸé—´æ”¶åˆ°æ–°å†™è¯·æ±‚</h3>

            <div class="info-box warning">
                <h4>ğŸ”„ é—®é¢˜</h4>
                <p>Node2 åœ¨åŒæ­¥è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½æ”¶åˆ°æ¥è‡ª Node1 çš„æ–°å†™è¯·æ±‚ã€‚</p>
            </div>

            <pre>
<span class="comment">%% è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ transient_data é˜Ÿåˆ—æš‚å­˜</span>

<span class="comment">%% eh_data_state è®°å½•ä¸­çš„ transient_data å­—æ®µ</span>
<span class="keyword">-record</span>(<span class="atom">eh_data_state</span>, {
    ...
    <span class="atom">transient_data</span>=<span class="function">queue:new</span>()  :: <span class="type">queue:queue</span>(),  <span class="comment">%% ä¸´æ—¶æ•°æ®é˜Ÿåˆ—</span>
    ...
}).

<span class="comment">%% åŒæ­¥æœŸé—´æ”¶åˆ°çš„æ–°æ•°æ®å…ˆæ”¾å…¥ transient_data</span>
<span class="comment">%% åŒæ­¥å®Œæˆåï¼Œmerge_data ä¼šåˆå¹¶ transient_data</span>
<span class="function">merge_data</span>(<span class="variable">Q0</span>, <span class="variable">TQ0</span>, {<span class="variable">StateTimestamp</span>, <span class="variable">StateDataIndexList</span>}, <span class="variable">M0</span>) <span class="operator">-></span>
    <span class="comment">%% Q0: å¿«ç…§å¢é‡æ•°æ®</span>
    <span class="comment">%% TQ0: åŒæ­¥æœŸé—´æ”¶åˆ°çš„ä¸´æ—¶æ•°æ®</span>
    {<span class="variable">TS1</span>, <span class="variable">DIL1</span>, <span class="variable">Q1</span>, <span class="variable">M1</span>} = <span class="function">merge_data_acc</span>(<span class="variable">Q0</span>, ..., <span class="variable">M0</span>, ...),
    <span class="function">merge_data_acc</span>(<span class="variable">TQ0</span>, <span class="variable">Q1</span>, <span class="variable">M1</span>, <span class="variable">TS1</span>, <span class="variable">DIL1</span>, <span class="atom">true</span>).  <span class="comment">%% å†åˆå¹¶ä¸´æ—¶æ•°æ®</span>
            </pre>

            <h3>6.2 åç»§èŠ‚ç‚¹æ•…éšœ</h3>

            <div class="info-box problem">
                <h4>ğŸ’¥ é—®é¢˜</h4>
                <p>Node2 æ­£åœ¨å‘ Node3 è¯·æ±‚å¿«ç…§æ—¶ï¼ŒNode3 å®•æœºäº†ã€‚</p>
            </div>

            <pre>
<span class="comment">%% eh_system_server.erl:256-260</span>
<span class="comment">%% æ£€æµ‹åˆ°åç»§èŠ‚ç‚¹æ•…éšœï¼Œé‡æ–°å‘æ–°åç»§è¯·æ±‚å¿«ç…§</span>

<span class="variable">NewState3</span> = <span class="keyword">case</span> {<span class="variable">NewSucc</span>, <span class="function">eh_node_state:snapshot_state</span>(<span class="variable">NewState1</span>), <span class="variable">Succ</span> <span class="operator">=:=</span> <span class="variable">DownNode</span>, <span class="variable">Pred</span> <span class="operator">=:=</span> <span class="variable">DownNode</span>} <span class="keyword">of</span>
    {<span class="variable">_</span>, <span class="atom">?EH_NOT_READY</span>, <span class="atom">true</span>, <span class="variable">_</span>} <span class="operator">-></span>
        <span class="comment">%% åç»§èŠ‚ç‚¹æ•…éšœï¼Œä¸”å½“å‰èŠ‚ç‚¹æœªå°±ç»ª</span>
        <span class="comment">%% å‘æ–°åç»§èŠ‚ç‚¹é‡æ–°è¯·æ±‚å¿«ç…§</span>
        <span class="function">process_snapshot_request</span>(<span class="variable">NewReplRing</span>, <span class="variable">ReplRingOrder</span>, <span class="variable">NewSucc</span>, <span class="variable">NewState1</span>);
    ...
<span class="keyword">end</span>
            </pre>

            <h3>6.3 å¿«ç…§å¼•ç”¨éªŒè¯</h3>

            <div class="info-box info">
                <h4>ğŸ” å®‰å…¨æœºåˆ¶</h4>
                <p>ä½¿ç”¨ <code>snapshot_ref</code> ç¡®ä¿æ”¶åˆ°çš„å¿«ç…§å“åº”æ˜¯å¯¹åº”çš„è¯·æ±‚ã€‚</p>
            </div>

            <pre>
<span class="comment">%% å‘é€è¯·æ±‚æ—¶ç”Ÿæˆå”¯ä¸€å¼•ç”¨</span>
<span class="variable">SnapshotRef</span> = <span class="variable">UniqueIdGenerator</span>:<span class="function">unique_id</span>(),
<span class="variable">State</span>#<span class="atom">eh_system_state</span>{<span class="atom">snapshot_ref</span>=<span class="variable">SnapshotRef</span>}.

<span class="comment">%% æ”¶åˆ°å“åº”æ—¶éªŒè¯å¼•ç”¨</span>
<span class="function">handle_cast</span>({<span class="atom">?EH_UPDATE_SNAPSHOT</span>, {<span class="variable">Ref</span>, <span class="variable">Q0</span>, <span class="variable">PendingPreMsgData</span>}}, 
            #<span class="atom">eh_system_state</span>{<span class="atom">snapshot_ref</span>=<span class="variable">Ref</span|}=<span class="variable">State</span>) <span class="operator">-></span>
    <span class="comment">%% Ref åŒ¹é…ï¼Œå¤„ç†å¿«ç…§</span>
    ...

<span class="comment">%% å¼•ç”¨ä¸åŒ¹é…ï¼Œå¿½ç•¥</span>
<span class="function">handle_cast</span>({<span class="atom">?EH_UPDATE_SNAPSHOT</span>, <span class="variable">_</span>}, <span class="variable">State</span>) <span class="operator">-></span>
    {<span class="atom">noreply</span>, <span class="variable">State</span>}.
            </pre>
        </section>

        <!-- Section 7: Summary -->
        <section id="summary" class="section">
            <h2>ğŸ“‹ ä¸ƒã€æ€»ç»“</h2>

            <h3>7.1 å¿«ç…§åŒæ­¥çš„æ ¸å¿ƒæµç¨‹</h3>

            <div class="highlight-box">
                <pre style="background: transparent; margin: 0;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CRAQ å¿«ç…§åŒæ­¥æ ¸å¿ƒæµç¨‹                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  1. è½åèŠ‚ç‚¹ç”Ÿæˆæœ¬åœ°å¿«ç…§ {Timestamp, DataIndexList}                       â”‚
â”‚                    â†“                                                     â”‚
â”‚  2. å‘é€å¿«ç…§è¯·æ±‚ç»™åç»§èŠ‚ç‚¹ (?EH_SNAPSHOT)                                 â”‚
â”‚                    â†“                                                     â”‚
â”‚  3. åç»§èŠ‚ç‚¹æ ¹æ®å¿«ç…§è¿‡æ»¤å¢é‡æ•°æ® (snapshot_fun)                           â”‚
â”‚     - timestamp > å¿«ç…§æ—¶é—´æˆ³ â†’ åŒ…å«                                      â”‚
â”‚     - timestamp = å¿«ç…§æ—¶é—´æˆ³ ä¸” data_index > å·²åŒæ­¥å€¼ â†’ åŒ…å«              â”‚
â”‚     - å…¶ä»– â†’ è·³è¿‡                                                        â”‚
â”‚                    â†“                                                     â”‚
â”‚  4. å‘é€å¢é‡æ•°æ®ç»™è¯·æ±‚èŠ‚ç‚¹ (?EH_UPDATE_SNAPSHOT)                         â”‚
â”‚                    â†“                                                     â”‚
â”‚  5. è¯·æ±‚èŠ‚ç‚¹åˆå¹¶æ•°æ® (merge_data)                                        â”‚
â”‚                    â†“                                                     â”‚
â”‚  6. çŠ¶æ€è½¬æ¢: NOT_READY â†’ TRANSIENT â†’ ... â†’ READY                       â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                </pre>
            </div>

            <h3>7.2 å…³é”®ä»£ç æ–‡ä»¶</h3>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>æ–‡ä»¶</th>
                        <th>åŠŸèƒ½</th>
                        <th>å…³é”®å‡½æ•°</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>eh_system_server.erl</code></td>
                        <td>å¿«ç…§è¯·æ±‚/å“åº”å¤„ç†</td>
                        <td><code>process_snapshot_request/4</code>, <code>handle_cast(?EH_SNAPSHOT, ...)</code></td>
                    </tr>
                    <tr>
                        <td><code>eh_data_util.erl</code></td>
                        <td>æ•°æ®è¿‡æ»¤ä¸åˆå¹¶</td>
                        <td><code>snapshot_fun/3</code>, <code>merge_data/4</code>, <code>update_timestamp/2</code></td>
                    </tr>
                    <tr>
                        <td><code>eh_node_state.erl</code></td>
                        <td>èŠ‚ç‚¹çŠ¶æ€è½¬æ¢</td>
                        <td><code>update_state_snapshot/1</code></td>
                    </tr>
                    <tr>
                        <td><code>eh_data_server.erl</code></td>
                        <td>æ•°æ®å­˜å‚¨ç®¡ç†</td>
                        <td><code>handle_call(?EH_SNAPSHOT, ...)</code>, <code>handle_call(?EH_UPDATE_SNAPSHOT, ...)</code></td>
                    </tr>
                </tbody>
            </table>

            <h3>7.3 å¿«ç…§æœºåˆ¶çš„ä¼˜åŠ¿</h3>

            <div class="scenario-grid">
                <div class="scenario-card">
                    <div class="icon">âš¡</div>
                    <h4>é«˜æ•ˆå¢é‡åŒæ­¥</h4>
                    <p>åªä¼ è¾“ç¼ºå¤±çš„æ•°æ®ï¼Œè€Œéå…¨é‡å¤åˆ¶ï¼Œå¤§å¹…å‡å°‘ç½‘ç»œå¼€é”€ã€‚</p>
                </div>
                <div class="scenario-card">
                    <div class="icon">ğŸ¯</div>
                    <h4>ç²¾ç¡®çš„åŒæ­¥è¾¹ç•Œ</h4>
                    <p>é€šè¿‡ timestamp + data_index äºŒç»´åæ ‡ï¼Œç²¾ç¡®å®šä½åŒæ­¥èµ·ç‚¹ã€‚</p>
                </div>
                <div class="scenario-card">
                    <div class="icon">ğŸ”„</div>
                    <h4>æ”¯æŒå¹¶å‘æ“ä½œ</h4>
                    <p>åŒæ­¥æœŸé—´å¯ä»¥ç»§ç»­å¤„ç†æ–°è¯·æ±‚ï¼Œé€šè¿‡ transient_data æš‚å­˜ã€‚</p>
                </div>
                <div class="scenario-card">
                    <div class="icon">ğŸ›¡ï¸</div>
                    <h4>å®¹é”™æœºåˆ¶</h4>
                    <p>åç»§èŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æ–°åç»§ï¼Œä¿è¯åŒæ­¥å®Œæˆã€‚</p>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer style="text-align: center; padding: 2rem; color: var(--text-muted);">
            <p>CRAQ å¿«ç…§åœ¨æ•°æ®åŒæ­¥ä¸­çš„ä½œç”¨ä¸æµç¨‹è¯¦è§£</p>
            <p>åŸºäº erlang_craq é¡¹ç›®æºç åˆ†æ</p>
            <p style="margin-top: 1rem; font-size: 0.9rem;">ç”Ÿæˆæ—¶é—´: 2025-12-19</p>
        </footer>
    </div>

    <script>
        // Smooth scrolling
        document.querySelectorAll('.nav-toc a').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });
    </script>

<!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="back-to-top" style="
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #00d4ff, #7c3aed);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
    transition: all 0.3s ease;
    z-index: 999;
    opacity: 0;
    transform: translateY(20px);
" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" 
   onmouseover="this.style.transform='translateY(-5px) scale(1.1)'" 
   onmouseout="this.style.transform='translateY(0) scale(1)'">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
        <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
    </svg>
</div>

<script>
// å›åˆ°é¡¶éƒ¨æŒ‰é’®æ˜¾ç¤º/éšè—é€»è¾‘
window.addEventListener('scroll', function() {
    const backToTop = document.getElementById('back-to-top');
    if (window.scrollY > 300) {
        backToTop.style.opacity = '1';
        backToTop.style.transform = 'translateY(0)';
    } else {
        backToTop.style.opacity = '0';
        backToTop.style.transform = 'translateY(20px)';
    }
});
</script>

</body>
</html>
