<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAQ å¿«ç…§ (Snapshot) æœºåˆ¶è¯¦è§£</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #3b82f6;
            --accent-color: #f59e0b;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --code-bg: #1e293b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.7;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 3rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(37, 99, 235, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* Navigation */
        .nav-toc {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 1rem;
            z-index: 100;
        }

        .nav-toc h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .nav-toc ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .nav-toc a {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--bg-color);
            color: var(--text-color);
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .nav-toc a:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        /* Sections */
        .section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .section h2 {
            color: var(--primary-color);
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section h3 {
            color: var(--text-color);
            font-size: 1.25rem;
            margin: 1.5rem 0 1rem;
        }

        .section h4 {
            color: var(--secondary-color);
            font-size: 1.1rem;
            margin: 1.25rem 0 0.75rem;
        }

        /* Code blocks */
        pre {
            background: var(--code-bg);
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 12px;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        code {
            font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
        }

        :not(pre) > code {
            background: #e0e7ff;
            color: var(--primary-color);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9em;
        }

        /* Syntax highlighting */
        .keyword { color: #c678dd; }
        .function { color: #61afef; }
        .string { color: #98c379; }
        .comment { color: #5c6370; font-style: italic; }
        .number { color: #d19a66; }
        .atom { color: #e5c07b; }
        .variable { color: #e06c75; }
        .operator { color: #56b6c2; }

        /* Info boxes */
        .info-box {
            padding: 1.25rem;
            border-radius: 12px;
            margin: 1rem 0;
            border-left: 4px solid;
        }

        .info-box.definition {
            background: #eff6ff;
            border-color: var(--primary-color);
        }

        .info-box.important {
            background: #fef3c7;
            border-color: var(--accent-color);
        }

        .info-box.success {
            background: #d1fae5;
            border-color: var(--success-color);
        }

        .info-box.danger {
            background: #fee2e2;
            border-color: var(--danger-color);
        }

        .info-box h4 {
            margin-top: 0;
            margin-bottom: 0.5rem;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.95rem;
        }

        th, td {
            padding: 0.875rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-color);
            font-weight: 600;
            color: var(--primary-color);
        }

        tr:hover {
            background: var(--bg-color);
        }

        /* Flow diagrams */
        .flow-diagram {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 2rem;
            border-radius: 12px;
            margin: 1.5rem 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
        }

        .flow-diagram pre {
            background: transparent;
            color: var(--text-color);
            padding: 0;
            margin: 0;
        }

        /* Scenario cards */
        .scenario-card {
            background: var(--bg-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            border: 2px solid var(--border-color);
        }

        .scenario-card.active {
            border-color: var(--success-color);
        }

        .scenario-card h4 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0;
        }

        .scenario-card .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge.new { background: #dbeafe; color: #1d4ed8; }
        .badge.same { background: #fef3c7; color: #b45309; }
        .badge.old { background: #fee2e2; color: #b91c1c; }

        /* Lists */
        ul, ol {
            margin: 0.75rem 0;
            padding-left: 1.5rem;
        }

        li {
            margin: 0.5rem 0;
        }

        /* Comparison */
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }

        .comparison > div {
            padding: 1rem;
            border-radius: 8px;
        }

        .comparison .wrong {
            background: #fee2e2;
            border: 1px solid #fecaca;
        }

        .comparison .correct {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
        }

        .comparison h5 {
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* State diagram */
        .state-diagram {
            background: linear-gradient(135deg, #fdf4ff, #f3e8ff);
            padding: 2rem;
            border-radius: 12px;
            margin: 1.5rem 0;
        }

        .state-box {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            margin: 0.25rem;
            font-weight: 600;
        }

        .state-box.ready {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        /* Summary cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .summary-card {
            background: linear-gradient(135deg, var(--bg-color), white);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .summary-card h4 {
            color: var(--primary-color);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .header {
                padding: 2rem;
            }

            .header h1 {
                font-size: 1.75rem;
            }

            .comparison {
                grid-template-columns: 1fr;
            }

            .nav-toc ul {
                flex-direction: column;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            animation: fadeIn 0.5s ease-out;
        }

        /* Arrow indicators */
        .arrow {
            color: var(--primary-color);
            font-weight: bold;
        }

        /* Highlight */
        .highlight {
            background: linear-gradient(120deg, #fef08a 0%, #fef08a 100%);
            background-size: 100% 40%;
            background-repeat: no-repeat;
            background-position: 0 90%;
        }

        /* Icon styles */
        .icon {
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
<!-- CRAQ æ–‡æ¡£å¯¼èˆªæ  -->
<div id="craq-nav" style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(15, 15, 35, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 12px 20px;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
">
    <a href="/craq/" style="
        color: #00d4ff;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    " onmouseover="this.style.color='#7c3aed'" onmouseout="this.style.color='#00d4ff'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
        è¿”å› CRAQ æ–‡æ¡£é¦–é¡µ
    </a>
    
    <div style="flex: 1;"></div>
    
    <a href="/" style="
        color: #888;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.3s ease;
    " onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#888'">
        åšå®¢é¦–é¡µ
    </a>
</div>

<!-- ä¸ºå¯¼èˆªæ æ·»åŠ é¡¶éƒ¨é—´è· -->
<div style="height: 60px;"></div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>ğŸ“š CRAQ å¿«ç…§ (Snapshot) æœºåˆ¶è¯¦è§£</h1>
            <p>æ·±å…¥ç†è§£ Erlang CRAQ åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿä¸­çš„å¿«ç…§åŒæ­¥æœºåˆ¶</p>
        </header>

        <!-- Navigation -->
        <nav class="nav-toc">
            <h3>ğŸ“‘ ç›®å½•å¯¼èˆª</h3>
            <ul>
                <li><a href="#section1">ä¸€ã€æ ¸å¿ƒæ¦‚å¿µ</a></li>
                <li><a href="#section2">äºŒã€update_timestamp</a></li>
                <li><a href="#section3">ä¸‰ã€æ•°æ®åŒæ­¥åº”ç”¨</a></li>
                <li><a href="#section4">å››ã€èŠ‚ç‚¹çŠ¶æ€è½¬æ¢</a></li>
                <li><a href="#section5">äº”ã€å®Œæ•´ç¤ºä¾‹</a></li>
                <li><a href="#section6">å…­ã€data_index ä½œç”¨</a></li>
                <li><a href="#section7">ä¸ƒã€é“¾å¼å¤åˆ¶å…³ç³»</a></li>
                <li><a href="#section8">å…«ã€æ€§èƒ½è€ƒè™‘</a></li>
                <li><a href="#section9">ä¹ã€æ€»ç»“</a></li>
                <li><a href="#section10">åã€ä»£ç å¼•ç”¨</a></li>
            </ul>
        </nav>

        <!-- Section 1: Core Concepts -->
        <section id="section1" class="section">
            <h2><span class="icon">ğŸ“Œ</span> ä¸€ã€å¿«ç…§çš„æ ¸å¿ƒæ¦‚å¿µ</h2>

            <h3>1.1 å®šä¹‰</h3>
            <div class="info-box definition">
                <h4>ğŸ”¹ å¿«ç…§ (Snapshot)</h4>
                <p><strong>å¿«ç…§</strong>æ˜¯ CRAQ ç³»ç»Ÿä¸­ç”¨äº<strong>æ•°æ®åŒæ­¥çš„å…³é”®æœºåˆ¶</strong>ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ—¶é—´æˆ³å’Œæ•°æ®ç´¢å¼•çš„ç»„åˆã€‚</p>
            </div>

            <pre><span class="variable">Snapshot</span> = {<span class="variable">Timestamp</span>, <span class="variable">DataIndexList</span>}
           {    â†“          â†“        }
           { <span class="comment">æ—¶é—´æˆ³</span>   <span class="comment">ç´¢å¼•åˆ—è¡¨</span>      }</pre>

            <h3>1.2 å¿«ç…§çš„ä¸¤ä¸ªæ ¸å¿ƒç»„æˆ</h3>

            <div class="summary-grid">
                <div class="summary-card">
                    <h4>â° Timestampï¼ˆæ—¶é—´æˆ³ï¼‰</h4>
                    <ul>
                        <li>ä»£è¡¨ç³»ç»Ÿä¸­æœ€æ–°å¤„ç†çš„<strong>äº‹åŠ¡ID</strong></li>
                        <li>æ‰€æœ‰æ›´æ–°æ“ä½œéƒ½è¢«èµ‹äºˆä¸€ä¸ªå•è°ƒé€’å¢çš„æ—¶é—´æˆ³</li>
                        <li>æ–°èŠ‚ç‚¹å°†åªæ¥æ”¶ &gt; æ­¤æ—¶é—´æˆ³çš„æ•°æ®</li>
                    </ul>
                </div>
                <div class="summary-card">
                    <h4>ğŸ“‹ DataIndexListï¼ˆæ•°æ®ç´¢å¼•åˆ—è¡¨ï¼‰</h4>
                    <ul>
                        <li>ç»“æ„: <code>[{{ObjectType, ObjectId}, DataIndex}, ...]</code></li>
                        <li>è®°å½•<strong>æ¯ä¸ªå¯¹è±¡</strong>åœ¨å½“å‰æ—¶é—´æˆ³ä¸‹çš„<strong>æœ€æ–°data_index</strong></li>
                        <li>ç”¨äºè·³è¿‡å·²åŒæ­¥çš„æ•°æ®</li>
                    </ul>
                </div>
            </div>

            <div class="info-box important">
                <h4>ğŸ’¡ ç¤ºä¾‹</h4>
                <pre>{<span class="number">100</span>, [{{<span class="atom">person</span>, <span class="number">10</span>}, <span class="number">3</span>}, {{<span class="atom">person</span>, <span class="number">11</span>}, <span class="number">2</span>}, {{<span class="atom">user</span>, <span class="number">5</span>}, <span class="number">1</span>}]}
<span class="comment">%% å«ä¹‰ï¼š</span>
<span class="comment">%% - æ—¶é—´æˆ³ 100 å·²åŒæ­¥</span>
<span class="comment">%% - person:10 çš„æœ€æ–°ç´¢å¼•æ˜¯ 3 (timestamp=100, data_indexâ‰¤3 å·²åŒæ­¥)</span>
<span class="comment">%% - person:11 çš„æœ€æ–°ç´¢å¼•æ˜¯ 2</span>
<span class="comment">%% - user:5 çš„æœ€æ–°ç´¢å¼•æ˜¯ 1</span></pre>
            </div>
        </section>

        <!-- Section 2: update_timestamp -->
        <section id="section2" class="section">
            <h2><span class="icon">ğŸ”„</span> äºŒã€update_timestamp/2 çš„ä½œç”¨</h2>

            <h3>2.1 å‡½æ•°èŒè´£</h3>
            <p>ç»´æŠ¤å¿«ç…§çš„ <code>DataIndexList</code> éƒ¨åˆ†ï¼Œç¡®ä¿åœ¨åŒä¸€æ—¶é—´æˆ³å†…<strong>æ­£ç¡®è¿½è¸ªæ¯ä¸ªå¯¹è±¡çš„æœ€æ–°ç´¢å¼•</strong>ã€‚</p>

            <h3>2.2 ä¸‰ç§å¤„ç†åœºæ™¯</h3>

            <!-- Scenario 1 -->
            <div class="scenario-card">
                <h4><span class="badge new">åœºæ™¯ 1</span> æ—¶é—´æˆ³é€’å¢ï¼ˆæ–°äº‹åŠ¡å¼€å§‹ï¼‰</h4>
                <pre><span class="keyword">when</span> <span class="variable">EntryTimestamp</span> <span class="operator">></span> <span class="variable">Timestamp</span> <span class="operator">-></span>
    {<span class="variable">EntryTimestamp</span>, [{{<span class="variable">ObjectType</span>, <span class="variable">ObjectId</span>}, <span class="variable">EntryDataIndex</span>}]}</pre>
                
                <div class="info-box definition">
                    <h4>é€»è¾‘</h4>
                    <ul>
                        <li>è¿›å…¥<strong>æ–°çš„æ—¶é—´çºªå…ƒ</strong></li>
                        <li>æ—§æ—¶é—´æˆ³ä¸‹çš„ç´¢å¼•è®°å½•<strong>å…¨éƒ¨ä¸¢å¼ƒ</strong></li>
                        <li>åªä¿ç•™<strong>æ–°æ•°æ®</strong>çš„ä¿¡æ¯</li>
                    </ul>
                </div>

                <pre><span class="comment">%% æ—§å¿«ç…§</span>
{<span class="number">100</span>, [{{<span class="atom">person</span>, <span class="number">10</span>}, <span class="number">3</span>}, {{<span class="atom">person</span>, <span class="number">11</span>}, <span class="number">2</span>}]}

<span class="comment">%% æ–°æ•°æ®ï¼štimestamp=200, object={person, 12}, data_index=1</span>
<span class="function">update_timestamp</span>(<span class="variable">new_data</span>, {<span class="number">100</span>, [...]})

<span class="comment">%% è¿”å›</span>
{<span class="number">200</span>, [{{<span class="atom">person</span>, <span class="number">12</span>}, <span class="number">1</span>}]}
<span class="comment">%% â†‘ æ—¶é—´æˆ³æå‡åˆ° 200ï¼Œåˆ—è¡¨å®Œå…¨æ›´æ–°</span></pre>
            </div>

            <!-- Scenario 2 -->
            <div class="scenario-card active">
                <h4><span class="badge same">åœºæ™¯ 2</span> æ—¶é—´æˆ³ç›¸åŒï¼ˆåŒäº‹åŠ¡ç»§ç»­ï¼‰â­ é‡ç‚¹</h4>
                <pre><span class="keyword">when</span> <span class="variable">EntryTimestamp</span> <span class="operator">=:=</span> <span class="variable">Timestamp</span> <span class="operator">-></span>
    <span class="variable">Object</span> = {<span class="variable">ObjectType</span>, <span class="variable">ObjectId</span>},
    <span class="variable">List1</span> = [{<span class="variable">Object</span>, <span class="variable">EntryDataIndex</span>} | <span class="function">lists:keydelete</span>(<span class="variable">Object</span>, <span class="number">1</span>, <span class="variable">List</span>)],
    {<span class="variable">Timestamp</span>, <span class="variable">List1</span>}</pre>

                <div class="info-box important">
                    <h4>é€»è¾‘ï¼ˆåˆ†æ­¥éª¤ï¼‰</h4>
                    <pre><span class="comment">%% Step 1: æ ‡è¯†å½“å‰å¯¹è±¡</span>
<span class="variable">Object</span> = {<span class="variable">ObjectType</span>, <span class="variable">ObjectId</span|}

<span class="comment">%% Step 2: ä»æ—§åˆ—è¡¨åˆ é™¤è¯¥å¯¹è±¡çš„æ—§è®°å½•</span>
<span class="function">lists:keydelete</span>(<span class="variable">Object</span>, <span class="number">1</span>, <span class="variable">List</span>)
<span class="comment">%% ä½œç”¨ï¼šåˆ é™¤åˆ—è¡¨ä¸­ç¬¬1ä½å…ƒç´ ä¸º Object çš„æ‰€æœ‰é¡¹</span>

<span class="comment">%% Step 3: åœ¨åˆ—è¡¨å¤´æ·»åŠ æ–°çš„ {Object, NewDataIndex}</span>
<span class="variable">List1</span> = [{<span class="variable">Object</span>, <span class="variable">EntryDataIndex</span>} | <span class="variable">OldListWithoutObject</span>]

<span class="comment">%% Step 4: ä¿æŒæ—¶é—´æˆ³ä¸å˜ï¼Œè¿”å›æ›´æ–°åçš„åˆ—è¡¨</span>
{<span class="variable">Timestamp</span>, <span class="variable">List1</span>}</pre>
                </div>

                <h4>è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹</h4>
                <pre><span class="comment">%% æ—¶é—´æˆ³ 100ï¼Œå¤„ç† person:10 çš„ä¸‰ä¸ªå­—æ®µæ›´æ–°</span>
<span class="comment">%% åˆå§‹ï¼šTimestamp=100, List=[]</span>

<span class="comment">%% å¤„ç†ç¬¬1æ¡ï¼šname å­—æ®µï¼Œdata_index=1</span>
<span class="function">lists:keydelete</span>({<span class="atom">person</span>,<span class="number">10</span>}, <span class="number">1</span>, [])  â†’ []
<span class="variable">List1</span> = [{<span class="atom">person</span>,<span class="number">10</span>}, <span class="number">1</span>] ++ []  = [{{<span class="atom">person</span>,<span class="number">10</span>}, <span class="number">1</span>}]
<span class="comment">ç»“æœï¼š{100, [{{person,10}, 1}]}</span>

<span class="comment">%% å¤„ç†ç¬¬2æ¡ï¼šage å­—æ®µï¼Œdata_index=2 (åŒå¯¹è±¡ï¼Œç´¢å¼•é€’å¢)</span>
<span class="function">lists:keydelete</span>({<span class="atom">person</span>,<span class="number">10</span>}, <span class="number">1</span>, [{{<span class="atom">person</span>,<span class="number">10</span>}, <span class="number">1</span>}])  â†’ []
<span class="variable">List1</span> = [{<span class="atom">person</span>,<span class="number">10</span>}, <span class="number">2</span>] ++ []  = [{{<span class="atom">person</span>,<span class="number">10</span>}, <span class="number">2</span>}]
<span class="comment">ç»“æœï¼š{100, [{{person,10}, 2}]}</span>

<span class="comment">%% å¤„ç†ç¬¬3æ¡ï¼šcity å­—æ®µï¼Œdata_index=3</span>
<span class="function">lists:keydelete</span>({<span class="atom">person</span>,<span class="number">10</span>}, <span class="number">1</span>, [{{<span class="atom">person</span>,<span class="number">10</span>}, <span class="number">2</span>}])  â†’ []
<span class="variable">List1</span> = [{<span class="atom">person</span>,<span class="number">10</span>}, <span class="number">3</span>] ++ []  = [{{<span class="atom">person</span>,<span class="number">10</span>}, <span class="number">3</span>}]
<span class="comment">ç»“æœï¼š{100, [{{person,10}, 3}]}</span>

<span class="comment">%% æœ€ç»ˆå¿«ç…§ï¼š{100, [{{person,10}, 3}]}</span></pre>

                <h4>å…³é”®ç‚¹ï¼šä¸ºä»€ä¹ˆéœ€è¦å…ˆåˆ é™¤å†æ·»åŠ ï¼Ÿ</h4>
                <div class="comparison">
                    <div class="wrong">
                        <h5>âŒ é”™è¯¯</h5>
                        <p>ç›´æ¥æ·»åŠ </p>
                        <code>[{{person,10}, 3}, {{person,10}, 2}, {{person,10}, 1}]</code>
                    </div>
                    <div class="correct">
                        <h5>âœ… æ­£ç¡®</h5>
                        <p>å…ˆåˆ ååŠ </p>
                        <code>[{{person,10}, 3}]</code>
                        <p>åªä¿ç•™æœ€æ–°</p>
                    </div>
                </div>

                <h4>å¤šå¯¹è±¡åŒæ—¶å¤„ç†</h4>
                <pre><span class="comment">%% æ—¶é—´æˆ³ 100ï¼ŒåŒæ—¶å¤„ç†å¤šä¸ªå¯¹è±¡</span>
<span class="comment">%% åˆå§‹ï¼šTimestamp=100, List=[]</span>

<span class="comment">%% å¤„ç†å¯¹è±¡ Aï¼šdata_index=1</span>
<span class="variable">List1</span> = [{<span class="variable">A</span>, <span class="number">1</span>}]  â†’  {<span class="number">100</span>, [{<span class="variable">A</span>, <span class="number">1</span>}]}

<span class="comment">%% å¤„ç†å¯¹è±¡ Bï¼šdata_index=1</span>
<span class="function">lists:keydelete</span>({<span class="variable">B</span>}, <span class="number">1</span>, [{<span class="variable">A</span>, <span class="number">1</span>}])  â†’ [{<span class="variable">A</span>, <span class="number">1</span>}]  <span class="comment">(æœªæ‰¾åˆ°B)</span>
<span class="variable">List1</span> = [{<span class="variable">B</span>, <span class="number">1</span>}] ++ [{<span class="variable">A</span>, <span class="number">1</span>}]  =  [{<span class="variable">B</span>, <span class="number">1</span>}, {<span class="variable">A</span>, <span class="number">1</span>}]
<span class="comment">ç»“æœï¼š{100, [{B, 1}, {A, 1}]}</span>

<span class="comment">%% å†æ¬¡å¤„ç†å¯¹è±¡ Aï¼šdata_index=2 (åŒå¯¹è±¡æ›´æ–°)</span>
<span class="function">lists:keydelete</span>({<span class="variable">A</span>}, <span class="number">1</span>, [{<span class="variable">B</span>, <span class="number">1</span>}, {<span class="variable">A</span>, <span class="number">1</span>}])  â†’ [{<span class="variable">B</span>, <span class="number">1</span>}]  <span class="comment">(åˆ é™¤A)</span>
<span class="variable">List1</span> = [{<span class="variable">A</span>, <span class="number">2</span>}] ++ [{<span class="variable">B</span>, <span class="number">1</span>}]  =  [{<span class="variable">A</span>, <span class="number">2</span>}, {<span class="variable">B</span>, <span class="number">1</span>}]
<span class="comment">ç»“æœï¼š{100, [{A, 2}, {B, 1}]}  âœ“ Açš„ç´¢å¼•å·²æ›´æ–°</span></pre>
            </div>

            <!-- Scenario 3 -->
            <div class="scenario-card">
                <h4><span class="badge old">åœºæ™¯ 3</span> æ—¶é—´æˆ³è½åï¼ˆè¿‡æ—¶æ•°æ®ä¸¢å¼ƒï¼‰</h4>
                <pre><span class="function">update_timestamp</span>(<span class="variable">_Entry</span>, {<span class="variable">Timestamp</span>, <span class="variable">List</span>}) <span class="operator">-></span>
    {<span class="variable">Timestamp</span>, <span class="variable">List</span>}</pre>

                <div class="info-box danger">
                    <h4>é€»è¾‘</h4>
                    <ul>
                        <li>æ–°æ•°æ®çš„æ—¶é—´æˆ³ &lt; å½“å‰æ—¶é—´æˆ³</li>
                        <li><strong>å¿½ç•¥è¯¥æ•°æ®</strong>ï¼Œä¿æŒå¿«ç…§ä¸å˜</li>
                    </ul>
                </div>

                <pre><span class="comment">%% å½“å‰å¿«ç…§</span>
{<span class="number">100</span>, [{{<span class="atom">person</span>, <span class="number">10</span>}, <span class="number">3</span>}]}

<span class="comment">%% æ”¶åˆ°è¿‡æ—¶æ•°æ®ï¼štimestamp=50</span>
<span class="function">update_timestamp</span>(<span class="variable">old_data_with_ts_50</span>, {<span class="number">100</span>, [...]})

<span class="comment">%% è¿”å› (ä¸å˜)</span>
{<span class="number">100</span>, [{{<span class="atom">person</span>, <span class="number">10</span>}, <span class="number">3</span>}]}</pre>
            </div>
        </section>

        <!-- Section 3: Data Sync Application -->
        <section id="section3" class="section">
            <h2><span class="icon">ğŸ”—</span> ä¸‰ã€å¿«ç…§åœ¨æ•°æ®åŒæ­¥ä¸­çš„åº”ç”¨</h2>

            <h3>3.1 æ–°èŠ‚ç‚¹åŠ å…¥çš„å®Œæ•´æµç¨‹</h3>
            <div class="flow-diagram">
                <pre>
æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤
    â†“
[STEP 1] æ–°èŠ‚ç‚¹å‘ç°æœ‰èŠ‚ç‚¹è¯·æ±‚å¿«ç…§
    â†“
[STEP 2] ç°æœ‰èŠ‚ç‚¹è¿”å›å¿«ç…§ {Timestamp, DataIndexList}
    â†“
[STEP 3] æ–°èŠ‚ç‚¹æ ¹æ®å¿«ç…§è¿‡æ»¤å¢é‡æ•°æ®
    â†“
[STEP 4] æ–°èŠ‚ç‚¹åº”ç”¨å¿«ç…§æ•°æ®
    â†“
[STEP 5] æ–°èŠ‚ç‚¹è¿›å…¥å°±ç»ªçŠ¶æ€ (READY)
                </pre>
            </div>

            <h3>3.2 è¯·æ±‚å¿«ç…§çš„ä»£ç ä½ç½®</h3>
            <p><strong>æ–‡ä»¶ï¼š</strong> <code>src/eh_system_server.erl:399-409</code></p>
            <pre><span class="function">process_snapshot_request</span>(<span class="variable">NodeList</span>, <span class="variable">NodeOrderList</span>, <span class="variable">Succ</span>, <span class="variable">State</span>) <span class="operator">-></span>
    <span class="comment">%% å‘åç»§èŠ‚ç‚¹è¯·æ±‚å¿«ç…§</span>
    <span class="keyword">case</span> <span class="variable">Succ</span> <span class="keyword">of</span>
        <span class="atom">undefined</span> <span class="operator">-></span>
            <span class="comment">%% å½“å‰èŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹ï¼Œæ— åç»§</span>
            <span class="variable">State</span>;
        <span class="variable">_</span> <span class="operator">-></span>
            <span class="comment">%% å‘é€å¿«ç…§è¯·æ±‚åˆ°åç»§èŠ‚ç‚¹</span>
            <span class="variable">ReplDataManager</span> = <span class="function">eh_system_config:get_repl_data_manager</span>(<span class="variable">AppConfig</span>),
            {<span class="variable">Timestamp</span>, <span class="variable">DataIndexList</span>} = <span class="variable">ReplDataManager</span>:<span class="function">timestamp</span>(),
            <span class="comment">%% ğŸ”¥ å…³é”®ï¼šåŒ…å«å½“å‰æ—¶é—´æˆ³å’Œæ•°æ®ç´¢å¼•åˆ—è¡¨</span>
            <span class="variable">Ref</span> = <span class="function">make_ref</span>(),
            <span class="function">gen_server:cast</span>(
                {<span class="atom">?EH_SYSTEM_SERVER</span>, <span class="variable">Succ</span>},
                {<span class="atom">?EH_SNAPSHOT</span>, {<span class="variable">Node</span>, <span class="variable">NodeList</span>, <span class="variable">NodeOrderList</span>, <span class="variable">Ref</span>, {<span class="variable">Timestamp</span>, <span class="variable">DataIndexList</span>}}}
            ),
            <span class="variable">State</span>#<span class="atom">eh_system_state</span>{<span class="atom">snapshot_ref</span> = <span class="variable">Ref</span>}
    <span class="keyword">end</span>.</pre>

            <h3>3.3 ç”Ÿæˆå¿«ç…§æ•°æ®çš„è¿‡ç¨‹</h3>
            <p><strong>æ–‡ä»¶ï¼š</strong> <code>src/eh_system_server.erl:112-123</code></p>
            <pre><span class="function">handle_cast</span>({<span class="atom">?EH_SNAPSHOT</span>, {<span class="variable">Node</span>, <span class="variable">NodeList</span>, <span class="variable">NodeOrderList</span>, <span class="variable">Ref</span>, {<span class="variable">Timestamp</span>, <span class="variable">Snapshot</span>}}}, <span class="variable">State</span>) <span class="operator">-></span>
    <span class="comment">%% æ–°èŠ‚ç‚¹è¯·æ±‚å¿«ç…§</span>
    <span class="variable">ReplDataManager</span> = <span class="function">eh_system_config:get_repl_data_manager</span>(<span class="variable">AppConfig</span>),
    
    <span class="comment">%% ğŸ”¥ æ ¸å¿ƒï¼šæ ¹æ®å¿«ç…§è¾¹ç•Œè¿‡æ»¤æ•°æ®</span>
    <span class="variable">Q0</span> = <span class="variable">ReplDataManager</span>:<span class="function">snapshot</span>(<span class="variable">Timestamp</span>, <span class="variable">Snapshot</span>),
    <span class="comment">%% è¿”å›çš„ Q0 æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼ŒåŒ…å«ï¼š</span>
    <span class="comment">%%   - timestamp > Timestamp çš„æ‰€æœ‰æ•°æ®ï¼Œæˆ–</span>
    <span class="comment">%%   - timestamp = Timestamp ä¸” data_index > Snapshot ä¸­å¯¹åº”å€¼çš„æ•°æ®</span>
    
    <span class="comment">%% å‘é€è¿‡æ»¤åçš„æ•°æ®ç»™æ–°èŠ‚ç‚¹</span>
    <span class="function">gen_server:cast</span>(
        {<span class="atom">?EH_SYSTEM_SERVER</span>, <span class="variable">Node</span>},
        {<span class="atom">?EH_UPDATE_SNAPSHOT</span>, {<span class="variable">Ref</span>, <span class="variable">Q0</span>, <span class="variable">PendingPreMsgData</span>}}
    ),
    {<span class="atom">noreply</span>, <span class="variable">NewState</span>}.</pre>

            <h3>3.4 å¿«ç…§æ•°æ®è¿‡æ»¤ç®—æ³•</h3>
            <p><strong>æ–‡ä»¶ï¼š</strong> <code>src/eh_data_util.erl:57-77</code></p>
            <pre><span class="function">snapshot_fun</span>({<span class="variable">CTimestamp</span>, <span class="variable">_CDataIndexList</span>, <span class="variable">StorageKey</span>}, 
             #<span class="atom">eh_storage_value</span>{<span class="atom">timestamp</span>=<span class="variable">Timestamp</span>}=<span class="variable">StorageValue</span>, <span class="variable">Qo0</span>) 
  <span class="keyword">when</span> <span class="variable">Timestamp</span> <span class="operator">></span> <span class="variable">CTimestamp</span> <span class="operator">-></span>
    <span class="comment">%% æƒ…å†µ1ï¼šæ•°æ®æ—¶é—´æˆ³ > å¿«ç…§æ—¶é—´æˆ³</span>
    <span class="comment">%% ç›´æ¥åŒ…å«è¯¥æ•°æ®</span>
    [<span class="function">storage_data</span>(<span class="variable">StorageKey</span>, <span class="variable">StorageValue</span>) | <span class="variable">Qo0</span>];

<span class="function">snapshot_fun</span>({<span class="variable">CTimestamp</span>, <span class="variable">CDataIndexList</span>, #<span class="atom">eh_storage_key</span>{<span class="atom">object_type</span>=<span class="variable">ObjectType</span>, <span class="atom">object_id</span>=<span class="variable">ObjectId</span>}=<span class="variable">StorageKey</span>},
             #<span class="atom">eh_storage_value</span>{<span class="atom">timestamp</span>=<span class="variable">Timestamp</span>, <span class="atom">data_index</span>=<span class="variable">DataIndex</span>}=<span class="variable">StorageValue</span>, <span class="variable">Qo0</span>)
  <span class="keyword">when</span> <span class="variable">Timestamp</span> <span class="operator">=:=</span> <span class="variable">CTimestamp</span> <span class="operator">-></span>
    <span class="comment">%% æƒ…å†µ2ï¼šæ•°æ®æ—¶é—´æˆ³ = å¿«ç…§æ—¶é—´æˆ³</span>
    <span class="comment">%% éœ€è¦æ¯”è¾ƒ data_index</span>
    <span class="keyword">case</span> <span class="function">lists:keyfind</span>({<span class="variable">ObjectType</span>, <span class="variable">ObjectId</span>}, <span class="number">1</span>, <span class="variable">CDataIndexList</span>) <span class="keyword">of</span>
        <span class="atom">false</span> <span class="operator">-></span>
            <span class="comment">%% å¯¹è±¡æœªåœ¨å¿«ç…§ä¸­ï¼Œè¯´æ˜æ˜¯æ–°å¯¹è±¡</span>
            [<span class="function">storage_data</span>(<span class="variable">StorageKey</span>, <span class="variable">StorageValue</span>) | <span class="variable">Qo0</span>];
        {<span class="variable">_</span>, <span class="variable">CDataIndex</span>} <span class="keyword">when</span> <span class="variable">DataIndex</span> <span class="operator">></span> <span class="variable">CDataIndex</span> <span class="operator">-></span>
            <span class="comment">%% æ•°æ®ç´¢å¼• > å¿«ç…§ä¸­çš„ç´¢å¼•ï¼Œè¯´æ˜æ˜¯æ–°æ•°æ®</span>
            [<span class="function">storage_data</span>(<span class="variable">StorageKey</span>, <span class="variable">StorageValue</span>) | <span class="variable">Qo0</span>];
        <span class="variable">_</span> <span class="operator">-></span>
            <span class="comment">%% æ•°æ®å·²åœ¨å¿«ç…§ä¸­ï¼Œè·³è¿‡</span>
            <span class="variable">Qo0</span>
    <span class="keyword">end</span>;

<span class="function">snapshot_fun</span>(<span class="variable">_</span>, <span class="variable">_</span>, <span class="variable">Qo0</span>) <span class="operator">-></span>
    <span class="comment">%% æƒ…å†µ3ï¼šæ•°æ®æ—¶é—´æˆ³ < å¿«ç…§æ—¶é—´æˆ³</span>
    <span class="comment">%% å®Œå…¨å¿½ç•¥ï¼ˆè¿‡æ—¶æ•°æ®ï¼‰</span>
    <span class="variable">Qo0</span>.</pre>
        </section>

        <!-- Section 4: Node State Transitions -->
        <section id="section4" class="section">
            <h2><span class="icon">ğŸ”€</span> å››ã€èŠ‚ç‚¹çŠ¶æ€è½¬æ¢ä¸å¿«ç…§</h2>

            <h3>4.1 èŠ‚ç‚¹çš„äº”ç§çŠ¶æ€</h3>
            <pre><span class="keyword">-define</span>(<span class="atom">EH_NOT_READY</span>,      <span class="atom">eh_not_ready</span>).           <span class="comment">%% åˆå§‹çŠ¶æ€</span>
<span class="keyword">-define</span>(<span class="atom">EH_TRANSIENT</span>,      <span class="atom">eh_transient</span>).           <span class="comment">%% å·²æ”¶åˆ°æ¶ˆæ¯ï¼Œæœªæ”¶å¿«ç…§</span>
<span class="keyword">-define</span>(<span class="atom">EH_TRANSIENT_DU</span>,   <span class="atom">eh_transient_data_updated</span>).  <span class="comment">%% æ”¶å¿«ç…§æ—¶å·²æœ‰æ¶ˆæ¯</span>
<span class="keyword">-define</span>(<span class="atom">EH_TRANSIENT_TU</span>,   <span class="atom">eh_transient_timestamp_updated</span>).  <span class="comment">%% å¿«ç…§å®Œæˆ</span>
<span class="keyword">-define</span>(<span class="atom">EH_READY</span>,          <span class="atom">eh_ready</span>).               <span class="comment">%% å°±ç»ª</span></pre>

            <h3>4.2 çŠ¶æ€è½¬æ¢æµç¨‹</h3>
            <div class="state-diagram">
                <div style="text-align: center; line-height: 2.5;">
                    <span class="state-box">NOT_READY</span> (åˆå§‹åŒ–)<br>
                    â†“<br>
                    [æ–°èŠ‚ç‚¹è¯·æ±‚åŠ å…¥]<br>
                    â†“<br>
                    <span class="state-box">TRANSIENT</span> (æ¥æ”¶æ¶ˆæ¯å’Œå¿«ç…§)<br>
                    â†“ (æ”¶åˆ°æ¶ˆæ¯)<br>
                    <span class="state-box">TRANSIENT_DU</span> (å·²åˆå¹¶ä¸´æ—¶æ¶ˆæ¯)<br>
                    â†“<br>
                    [æ”¶åˆ°å¿«ç…§æ•°æ®]<br>
                    â†“<br>
                    <span class="state-box">TRANSIENT_TU</span> (å¿«ç…§å¤„ç†å®Œæˆ)<br>
                    â†“<br>
                    <span class="state-box ready">READY</span> (å°±ç»ªï¼Œå¯å¤„ç†è¯»å†™)
                </div>
            </div>

            <h3>4.3 å¿«ç…§æ›´æ–°çŠ¶æ€è½¬æ¢</h3>
            <p><strong>æ–‡ä»¶ï¼š</strong> <code>src/eh_node_state.erl:43-48</code></p>
            <pre><span class="function">update_state_snapshot</span>(#<span class="atom">eh_system_state</span>{<span class="atom">node_status</span>=<span class="atom">?EH_TRANSIENT</span>}=<span class="variable">State</span>) <span class="operator">-></span>
    <span class="comment">%% å¦‚æœæœªæ”¶åˆ°æ¶ˆæ¯ï¼Œç›´æ¥å°±ç»ª</span>
    <span class="function">update_state</span>(<span class="atom">?EH_TRANSIENT_DU</span>, <span class="variable">State</span>);

<span class="function">update_state_snapshot</span>(#<span class="atom">eh_system_state</span>{<span class="atom">node_status</span>=<span class="atom">?EH_TRANSIENT_TU</span>}=<span class="variable">State</span>) <span class="operator">-></span>
    <span class="comment">%% å¦‚æœå·²å¤„ç†å®Œæ‰€æœ‰æ¶ˆæ¯å’Œå¿«ç…§ï¼Œå˜ä¸ºå°±ç»ª</span>
    <span class="function">update_state</span>(<span class="atom">?EH_READY</span>, <span class="variable">State</span>);

<span class="function">update_state_snapshot</span>(<span class="variable">State</span>) <span class="operator">-></span>
    <span class="comment">%% å…¶ä»–çŠ¶æ€ä¸å˜</span>
    <span class="variable">State</span>.</pre>
        </section>

        <!-- Section 5: Complete Example -->
        <section id="section5" class="section">
            <h2><span class="icon">ğŸ“</span> äº”ã€å¿«ç…§åŒæ­¥çš„å…·ä½“ä¾‹å­</h2>

            <h3>5.1 å®Œæ•´åœºæ™¯æ¼”ç¤º</h3>

            <div class="info-box definition">
                <h4>èƒŒæ™¯</h4>
                <ul>
                    <li>é›†ç¾¤æœ‰ 3 ä¸ªèŠ‚ç‚¹ï¼šNode1 (å¤´), Node2 (ä¸­), Node3 (å°¾)</li>
                    <li>æ–°èŠ‚ç‚¹ Node4 è¦åŠ å…¥</li>
                    <li>é›†ç¾¤å·²å¤„ç†äº† 200 ä¸ªäº‹åŠ¡</li>
                </ul>
            </div>

            <h4>å½“å‰çŠ¶æ€</h4>
            <pre><span class="variable">Node2</span> çš„å¿«ç…§ï¼š{<span class="number">200</span>, [{{<span class="atom">person</span>, <span class="number">10</span>}, <span class="number">5</span>}, {{<span class="atom">user</span>, <span class="number">3</span>}, <span class="number">2</span>}, {{<span class="atom">order</span>, <span class="number">1</span>}, <span class="number">3</span>}]}

<span class="comment">å«ä¹‰ï¼š</span>
<span class="comment">- å·²åŒæ­¥åˆ°äº‹åŠ¡ 200</span>
<span class="comment">- person:10 æœ€æ–°åˆ° data_index=5</span>
<span class="comment">- user:3 æœ€æ–°åˆ° data_index=2</span>
<span class="comment">- order:1 æœ€æ–°åˆ° data_index=3</span></pre>

            <h4>Node4 åŠ å…¥çš„è¿‡ç¨‹</h4>
            <pre><span class="comment">%% [1] Node4 è¯·æ±‚å¿«ç…§</span>
{<span class="variable">Node4</span>} â†’ {<span class="variable">Node2</span>}:
    <span class="string">"è¯·æ±‚å¿«ç…§"</span>

<span class="comment">%% [2] Node2 è¿”å›å¿«ç…§å’Œè¿‡æ»¤æ•°æ®</span>
{<span class="variable">Node2</span>} â†’ {<span class="variable">Node4</span>}:
    <span class="variable">Snapshot</span> = {<span class="number">200</span>, [{{<span class="atom">person</span>, <span class="number">10</span>}, <span class="number">5</span>}, {{<span class="atom">user</span>, <span class="number">3</span>}, <span class="number">2</span>}, {{<span class="atom">order</span>, <span class="number">1</span>}, <span class="number">3</span>}]}
    <span class="variable">FilteredData</span> = [
        <span class="comment">% timestamp > 200 çš„æ‰€æœ‰æ•°æ®</span>
        {<span class="atom">person</span>, <span class="number">12</span>, <span class="number">201</span>, <span class="number">1</span>, <span class="atom">active</span>, <span class="atom">name</span>, <span class="string">"alice"</span>},    <span class="comment">% æ–°äº‹åŠ¡</span>
        {<span class="atom">person</span>, <span class="number">12</span>, <span class="number">201</span>, <span class="number">2</span>, <span class="atom">active</span>, <span class="atom">age</span>, <span class="number">28</span>},
        {<span class="atom">order</span>, <span class="number">2</span>, <span class="number">202</span>, <span class="number">1</span>, <span class="atom">active</span>, <span class="atom">amount</span>, <span class="number">1000</span>},
        
        <span class="comment">% timestamp = 200 ä¸” data_index > 5 (ä½† person:10 åªåˆ° 5ï¼Œæ‰€ä»¥æ— æ­¤ç±»æ•°æ®)</span>
        
        <span class="comment">% ä¸åŒ…å«ï¼šperson:10 çš„æ‰€æœ‰æ•°æ® (å·²åœ¨å¿«ç…§ä¸­)</span>
        <span class="comment">// person:10, 200, 1..5  â† è¿™äº›å·²åœ¨å¿«ç…§ä¸­</span>
    ]

<span class="comment">%% [3] Node4 åº”ç”¨å¿«ç…§</span>
<span class="variable">Node4</span> æ”¶åˆ° <span class="variable">Snapshot</span>
<span class="variable">Node4</span> å†…å­˜æ•°æ® = {
    {<span class="atom">person</span>, <span class="number">10</span>}: [{<span class="atom">timestamp</span>=<span class="number">200</span>, <span class="atom">data_index</span>=<span class="number">5</span>}],  <span class="comment">% æ¥è‡ªå¿«ç…§</span>
    {<span class="atom">person</span>, <span class="number">12</span>}: [{<span class="atom">timestamp</span>=<span class="number">201</span>, <span class="atom">data_index</span>=<span class="number">1</span>}, {<span class="atom">timestamp</span>=<span class="number">201</span>, <span class="atom">data_index</span>=<span class="number">2</span>}],  <span class="comment">% æ¥è‡ªå¢é‡</span>
    {<span class="atom">user</span>, <span class="number">3</span>}:    [{<span class="atom">timestamp</span>=<span class="number">200</span>, <span class="atom">data_index</span>=<span class="number">2</span>}],
    {<span class="atom">order</span>, <span class="number">1</span>}:   [{<span class="atom">timestamp</span>=<span class="number">200</span>, <span class="atom">data_index</span>=<span class="number">3</span>}],
    {<span class="atom">order</span>, <span class="number">2</span>}:   [{<span class="atom">timestamp</span>=<span class="number">202</span>, <span class="atom">data_index</span>=<span class="number">1</span>}]
}

<span class="comment">%% [4] Node4 å°±ç»ª</span>
<span class="variable">Node4</span>.<span class="atom">status</span> = <span class="atom">READY</span></pre>

            <h3>5.2 æ•°æ®ä¸€è‡´æ€§ä¿è¯</h3>
            <div class="info-box success">
                <h4>å…³é”®ï¼šæ–°èŠ‚ç‚¹é€šè¿‡å¿«ç…§åŒæ­¥å¯ä»¥ç¡®ä¿<strong>ä»å¿«ç…§ç‚¹å¼€å§‹çš„æ‰€æœ‰æ•°æ®éƒ½è¢«æ”¶åˆ°</strong></h4>
            </div>
            <pre><span class="comment">%% å¦‚æœ Node4 å®•æœºé‡å¯ï¼Œé‡æ–°åŠ å…¥</span>
<span class="comment">%% ä¸‹ä¸€æ¬¡å¿«ç…§å¯èƒ½æ˜¯ï¼š{202, [{{person, 12}, 2}, {{order, 2}, 1}]}</span>

<span class="comment">%% ä»ä¸šåŠ¡è§†è§’ï¼š</span>
<span class="comment">%% - 200 ä»¥å‰çš„æ•°æ®é€šè¿‡"å¿«ç…§"ä¸€æ¬¡æ€§åŠ è½½</span>
<span class="comment">%% - 200-202 çš„æ•°æ®é€šè¿‡æ¶ˆæ¯é€æ¡åŒæ­¥</span>
<span class="comment">%% - ä¿è¯äº†é›¶æ•°æ®ä¸¢å¤±</span></pre>
        </section>

        <!-- Section 6: data_index Role -->
        <section id="section6" class="section">
            <h2><span class="icon">ğŸ”¢</span> å…­ã€data_index åœ¨å¿«ç…§ä¸­çš„å…³é”®ä½œç”¨</h2>

            <h3>6.1 ä¸ºä»€ä¹ˆéœ€è¦ data_indexï¼Ÿ</h3>
            <p>åŒä¸€æ—¶é—´æˆ³å†…å¯èƒ½æœ‰<strong>å¤šæ¬¡æ“ä½œ</strong>ä½œç”¨äº<strong>åŒä¸€å¯¹è±¡</strong>ï¼š</p>
            <pre><span class="comment">%% äº‹åŠ¡ 100 å†…å¯¹ person:10 çš„ä¸‰ä¸ªæ“ä½œ</span>
<span class="variable">UpdateList</span> = [
    {<span class="atom">person</span>, <span class="number">10</span>, [{<span class="atom">name</span>, <span class="atom">active</span>, <span class="string">"john"</span>}]},   <span class="comment">% data_index=1</span>
    {<span class="atom">person</span>, <span class="number">10</span>, [{<span class="atom">age</span>, <span class="atom">active</span>, <span class="number">25</span>}]},        <span class="comment">% data_index=2</span>
    {<span class="atom">person</span>, <span class="number">10</span>, [{<span class="atom">city</span>, <span class="atom">active</span>, <span class="string">"beijing"</span>}]} <span class="comment">% data_index=3</span>
]

<span class="comment">%% æœ€ç»ˆå¿«ç…§è®°å½•ï¼š</span>
{<span class="number">100</span>, [{{<span class="atom">person</span>, <span class="number">10</span>}, <span class="number">3</span>}]}  â† <span class="comment">æœ€æ–°åˆ°ç¬¬ 3 ä¸ªæ“ä½œ</span></pre>

            <h3>6.2 å¿«ç…§è¿‡æ»¤çš„ç²¾ç¡®æ€§</h3>
            <pre><span class="comment">%% å‡è®¾å¿«ç…§ï¼š{100, [{{person, 10}, 2}]}</span>

<span class="comment">%% å¾…åŒæ­¥çš„æ•°æ®ï¼š</span>
[
    {<span class="atom">person</span>, <span class="number">10</span>, <span class="number">100</span>, <span class="number">1</span>, ...},  â† <span class="comment">å·²æœ‰ï¼Œè·³è¿‡</span>
    {<span class="atom">person</span>, <span class="number">10</span>, <span class="number">100</span>, <span class="number">2</span>, ...},  â† <span class="comment">å·²æœ‰ï¼Œè·³è¿‡</span>
    {<span class="atom">person</span>, <span class="number">10</span>, <span class="number">100</span>, <span class="number">3</span>, ...},  â† <span class="comment">æ–°ï¼åŒ…å« âœ“</span>
    {<span class="atom">person</span>, <span class="number">10</span>, <span class="number">101</span>, <span class="number">1</span>, ...},  â† <span class="comment">æ–°äº‹åŠ¡ï¼ŒåŒ…å« âœ“</span>
]</pre>
        </section>

        <!-- Section 7: Chain Replication -->
        <section id="section7" class="section">
            <h2><span class="icon">â›“ï¸</span> ä¸ƒã€å¿«ç…§ä¸é“¾å¼å¤åˆ¶çš„å…³ç³»</h2>

            <h3>7.1 CRAQ é“¾å¼å¤åˆ¶çš„ä¸‰ä¸ªé˜¶æ®µ</h3>
            <div class="flow-diagram">
                <pre>
[HEAD] â†’ [MIDDLE] â†’ [TAIL]
  â†“         â†“         â†“
1.pre    2.receive  3.succ_confirm
  â†“         â†“         â†“
 æ¶ˆæ¯     è½¬å‘æ¶ˆæ¯   æ”¶åˆ°ç¡®è®¤
å‘å‡º      åˆ°TAIL     åæäº¤
                </pre>
            </div>

            <h3>7.2 å¿«ç…§åœ¨é“¾å¤åˆ¶ä¸­çš„ä½œç”¨</h3>
            <div class="info-box success">
                <pre>
æ–°èŠ‚ç‚¹åŠ å…¥åœ¨ MIDDLE ä½ç½®
    â†“
éœ€è¦å¿«ç…§æ¥è·å¾—"ä¹‹å‰"çš„å…¨éƒ¨æ•°æ®
    â†“
ä¿è¯ä»å¿«ç…§æ—¶åˆ»èµ·ï¼Œæ‰€æœ‰"åç»­"æ¶ˆæ¯éƒ½èƒ½çœ‹åˆ°

å¥½å¤„ï¼š
- é¿å…ä» HEAD é‡æ–°å¤åˆ¶æ‰€æœ‰å†å²æ•°æ®
- åªéœ€ä¼ è¾“å…³é”®æ£€æŸ¥ç‚¹æ•°æ®
- å¤§å¹…å‡å°‘ç½‘ç»œæµé‡
                </pre>
            </div>
        </section>

        <!-- Section 8: Performance -->
        <section id="section8" class="section">
            <h2><span class="icon">âš¡</span> å…«ã€æ€§èƒ½è€ƒè™‘</h2>

            <h3>8.1 å¿«ç…§çš„å¼€é”€</h3>
            <table>
                <thead>
                    <tr>
                        <th>æ–¹é¢</th>
                        <th>è¯´æ˜</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>å†…å­˜</strong></td>
                        <td>å¿«ç…§æœ¬èº«å¾ˆå°ï¼ˆæ—¶é—´æˆ³+åˆ—è¡¨ï¼‰ï¼Œå¯å¿«é€Ÿç”Ÿæˆ</td>
                    </tr>
                    <tr>
                        <td><strong>ç½‘ç»œ</strong></td>
                        <td>å¢é‡æ•°æ®æ¯”å…¨é‡æ•°æ®å°å¾—å¤š</td>
                    </tr>
                    <tr>
                        <td><strong>ç£ç›˜</strong></td>
                        <td>æ— é¢å¤–ç£ç›˜å¼€é”€ï¼ˆå¿«ç…§ä¸æŒä¹…åŒ–ï¼‰</td>
                    </tr>
                </tbody>
            </table>

            <h3>8.2 ä¼˜åŒ–å»ºè®®</h3>
            <pre><span class="comment">%% å®šæœŸç”Ÿæˆå¿«ç…§æ£€æŸ¥ç‚¹ï¼ˆç±»ä¼¼æ•°æ®åº“çš„ checkpointï¼‰</span>
<span class="comment">%% é˜²æ­¢ DataIndexList æ— é™å¢é•¿</span>

<span class="comment">%% å®ç°å‘¨æœŸæ€§å¿«ç…§æ¸…ç†ï¼š</span>
<span class="keyword">every</span> <span class="variable">N</span> <span class="atom">transactions</span>:
    <span class="variable">old_snapshot</span> = <span class="variable">current_snapshot</span>
    <span class="function">GC</span>(<span class="variable">old_snapshot</span>)</pre>
        </section>

        <!-- Section 9: Summary -->
        <section id="section9" class="section">
            <h2><span class="icon">ğŸ“Š</span> ä¹ã€æ€»ç»“</h2>

            <h3>9.1 å¿«ç…§çš„æ ¸å¿ƒä»·å€¼</h3>
            <table>
                <thead>
                    <tr>
                        <th>ä»·å€¼</th>
                        <th>è¯´æ˜</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>å¢é‡åŒæ­¥</strong></td>
                        <td>æ–°èŠ‚ç‚¹åªéœ€æ¥æ”¶å¿«ç…§åçš„æ•°æ®ï¼Œè€Œä¸æ˜¯å…¨é‡æ•°æ®</td>
                    </tr>
                    <tr>
                        <td><strong>ä¸€è‡´æ€§</strong></td>
                        <td>å¿«ç…§ä½œä¸º"åŸºå‡†ç‚¹"ï¼Œä¿è¯åç»­æ‰€æœ‰æ•°æ®éƒ½è¢«æ­£ç¡®å¤„ç†</td>
                    </tr>
                    <tr>
                        <td><strong>å®¹é”™</strong></td>
                        <td>å¿«ç…§ç‚¹å‰çš„æ•°æ®å·²ç¡®è®¤ï¼Œå®•æœºåå¯ä»æ­¤ç‚¹æ¢å¤</td>
                    </tr>
                    <tr>
                        <td><strong>æ€§èƒ½</strong></td>
                        <td>å‡å°‘æ•°æ®ä¼ è¾“é‡ï¼ŒåŠ é€Ÿæ–°èŠ‚ç‚¹åŠ å…¥</td>
                    </tr>
                </tbody>
            </table>

            <h3>9.2 update_timestamp/2 çš„æ ¸å¿ƒä½œç”¨</h3>
            <pre><span class="comment">%% ç»´æŠ¤å¿«ç…§ä¸­çš„ DataIndexList éƒ¨åˆ†</span>

<span class="keyword">å½“æ—¶é—´æˆ³é€’å¢æ—¶</span>ï¼š
  {<span class="variable">OldTS</span>, <span class="variable">OldList</span>} â†’ {<span class="variable">NewTS</span>, [<span class="variable">NewData</span>]}
  <span class="comment">æ¸…ç©ºå†å²ï¼Œè®°å½•æ–°äº‹åŠ¡çš„èµ·ç‚¹</span>

<span class="keyword">å½“æ—¶é—´æˆ³ç›¸åŒæ—¶</span>ï¼š
  <span class="comment">åŒä¸€äº‹åŠ¡å†…å¤šä¸ªæ“ä½œ</span>
  <span class="comment">æŒç»­æ›´æ–°åŒå¯¹è±¡çš„æœ€æ–° data_index</span>
  <span class="comment">é€šè¿‡ keydelete + prepend ç¡®ä¿å»é‡</span>

<span class="keyword">å½“æ—¶é—´æˆ³è½åæ—¶</span>ï¼š
  <span class="comment">å¿½ç•¥è¿‡æ—¶æ•°æ®</span>
  <span class="comment">ä¿æŒå¿«ç…§ä¸å˜</span></pre>

            <h3>9.3 å¿«ç…§åŒæ­¥çš„å®Œæ•´é“¾æ¡</h3>
            <div class="flow-diagram">
                <pre>
è¯·æ±‚å¿«ç…§ â†’ ç”Ÿæˆå¿«ç…§ â†’ è¿‡æ»¤å¢é‡æ•°æ® â†’ ä¼ è¾“åˆ°æ–°èŠ‚ç‚¹ â†’ åº”ç”¨æ•°æ® â†’ çŠ¶æ€è½¬æ¢ â†’ å°±ç»ª
   â†‘        â†‘            â†‘             â†‘            â†‘        â†‘      â†‘
  Node4   Node2    snapshot_fun    RPCæ¶ˆæ¯   merge_data  çŠ¶æ€æœº  READY
                </pre>
            </div>
        </section>

        <!-- Section 10: Code References -->
        <section id="section10" class="section">
            <h2><span class="icon">ğŸ“</span> åã€ä»£ç äº¤å‰å¼•ç”¨</h2>

            <table>
                <thead>
                    <tr>
                        <th>åŠŸèƒ½</th>
                        <th>æ–‡ä»¶</th>
                        <th>è¡Œå·</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>å¿«ç…§æ•°æ®ç»“æ„</td>
                        <td><code>erlang_craq.hrl</code></td>
                        <td>131-139</td>
                    </tr>
                    <tr>
                        <td>å¿«ç…§è¯·æ±‚</td>
                        <td><code>eh_system_server.erl</code></td>
                        <td>99</td>
                    </tr>
                    <tr>
                        <td>å¿«ç…§ç”Ÿæˆ</td>
                        <td><code>eh_system_server.erl</code></td>
                        <td>112-123</td>
                    </tr>
                    <tr>
                        <td>å¿«ç…§åº”ç”¨</td>
                        <td><code>eh_system_server.erl</code></td>
                        <td>125-138</td>
                    </tr>
                    <tr>
                        <td>æ•°æ®è¿‡æ»¤</td>
                        <td><code>eh_data_util.erl</code></td>
                        <td>57-77</td>
                    </tr>
                    <tr>
                        <td>ç´¢å¼•æ›´æ–°</td>
                        <td><code>eh_data_util.erl</code></td>
                        <td>233-243</td>
                    </tr>
                    <tr>
                        <td>çŠ¶æ€è½¬æ¢</td>
                        <td><code>eh_node_state.erl</code></td>
                        <td>43-48</td>
                    </tr>
                    <tr>
                        <td>æ•°æ®åŒæ­¥</td>
                        <td><code>eh_data_server.erl</code></td>
                        <td>99-106</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Footer -->
        <footer style="text-align: center; padding: 2rem; color: var(--text-muted); font-size: 0.9rem;">
            <p>CRAQ å¿«ç…§æœºåˆ¶è¯¦è§£ | Erlang CRAQ é¡¹ç›®æºç åˆ†æ</p>
            <p>ç”Ÿæˆæ—¶é—´: 2025-12-17</p>
        </footer>
    </div>

    <script>
        // Smooth scrolling for navigation
        document.querySelectorAll('.nav-toc a').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        });
    </script>

<!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="back-to-top" style="
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #00d4ff, #7c3aed);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
    transition: all 0.3s ease;
    z-index: 999;
    opacity: 0;
    transform: translateY(20px);
" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" 
   onmouseover="this.style.transform='translateY(-5px) scale(1.1)'" 
   onmouseout="this.style.transform='translateY(0) scale(1)'">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
        <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
    </svg>
</div>

<script>
// å›åˆ°é¡¶éƒ¨æŒ‰é’®æ˜¾ç¤º/éšè—é€»è¾‘
window.addEventListener('scroll', function() {
    const backToTop = document.getElementById('back-to-top');
    if (window.scrollY > 300) {
        backToTop.style.opacity = '1';
        backToTop.style.transform = 'translateY(0)';
    } else {
        backToTop.style.opacity = '0';
        backToTop.style.transform = 'translateY(20px)';
    }
});
</script>

</body>
</html>
