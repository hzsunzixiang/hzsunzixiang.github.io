<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.svg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.svg">
  <link rel="mask-icon" href="/images/favicon.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Noto+Serif+SC:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Source+Code+Pro:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hzsunzixiang.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"default","show_result":true},"fold":{"enable":false,"height":500},"language":false,"highlight_theme":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":true,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
<meta property="og:type" content="website">
<meta property="og:title" content="Zixiang Sun&#39;s Blog">
<meta property="og:url" content="https://hzsunzixiang.github.io/">
<meta property="og:site_name" content="Zixiang Sun&#39;s Blog">
<meta property="og:description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Zixiang Sun">
<meta property="article:tag" content="CRAQ">
<meta property="article:tag" content="blog">
<meta property="article:tag" content="development">
<meta property="article:tag" content="distributed systems">
<meta property="article:tag" content="programming">
<meta property="article:tag" content="technology">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://hzsunzixiang.github.io/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Zixiang Sun's Blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Zixiang Sun's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Zixiang Sun's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Sharing thoughts on technology, programming, and life</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">17</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">9</span></a></li><li class="menu-item menu-item-erlang"><a href="/erlang/" rel="section"><i class="fa fa-code fa-fw"></i>Erlang</a></li><li class="menu-item menu-item-rabbitmq"><a href="/rabbitmq/" rel="section"><i class="fa fa-server fa-fw"></i>RabbitMQ</a></li><li class="menu-item menu-item-craq"><a href="/craq/" rel="section"><i class="fa fa-book fa-fw"></i>CRAQ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zixiang Sun"
      src="/images/avatar.svg">
  <p class="site-author-name" itemprop="name">Zixiang Sun</p>
  <div class="site-description" itemprop="description">Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hzsunzixiang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hzsunzixiang" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:17842379@qq.com" title="E-Mail → mailto:17842379@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/18/rabbitmq-rabbitmq-deps-systemd-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/18/rabbitmq-rabbitmq-deps-systemd-guide/" class="post-title-link" itemprop="url">RabbitMQ 依赖分析：Systemd 完整指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-18 00:00:00 / 修改时间：12:26:54" itemprop="dateCreated datePublished" datetime="2026-01-18T00:00:00+08:00">2026-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/RabbitMQ-Deps/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ Deps</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Systemd-完整指南：从原理到-RabbitMQ-实践"><a href="#Systemd-完整指南：从原理到-RabbitMQ-实践" class="headerlink" title="Systemd 完整指南：从原理到 RabbitMQ 实践"></a>Systemd 完整指南：从原理到 RabbitMQ 实践</h1><h2 id="1-Systemd-概述"><a href="#1-Systemd-概述" class="headerlink" title="1. Systemd 概述"></a>1. Systemd 概述</h2><h3 id="1-1-什么是-Systemd？"><a href="#1-1-什么是-Systemd？" class="headerlink" title="1.1 什么是 Systemd？"></a>1.1 什么是 Systemd？</h3><p>Systemd 是 Linux 系统的系统和服务管理器，负责：</p>
<ul>
<li>启动和管理系统服务</li>
<li>管理服务依赖关系</li>
<li>并行启动服务以加快启动速度</li>
<li>监控服务状态并自动重启</li>
</ul>
<h3 id="1-2-核心组件"><a href="#1-2-核心组件" class="headerlink" title="1.2 核心组件"></a>1.2 核心组件</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                         systemd                                  │</span><br><span class="line">│                    (服务管理器 PID <span class="number">1</span>)                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  systemctl      │  journalctl    │  systemd-notify              │</span><br><span class="line">│  (管理命令)      │  (日志查看)     │  (状态通知)                  │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Service Units (.service)                      │</span><br><span class="line">│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐ │</span><br><span class="line">│  │ nginx    │  │ sshd     │  │ mysql    │  │ rabbitmq-server  │ │</span><br><span class="line">│  └──────────┘  └──────────┘  └──────────┘  └──────────────────┘ │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-核心术语"><a href="#2-核心术语" class="headerlink" title="2. 核心术语"></a>2. 核心术语</h2><table>
<thead>
<tr>
<th>术语</th>
<th>英文</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>应用程序</strong></td>
<td>Service Script (App)</td>
<td>实际运行的程序，如 <code>helloworld.sh</code></td>
</tr>
<tr>
<td><strong>服务单元</strong></td>
<td>Service Unit</td>
<td>描述服务的配置文件，如 <code>helloworld.service</code></td>
</tr>
<tr>
<td><strong>服务管理器</strong></td>
<td>systemd</td>
<td>系统和服务管理守护进程 (PID 1)</td>
</tr>
<tr>
<td><strong>管理命令</strong></td>
<td>systemctl</td>
<td>与 systemd 交互的命令行工具</td>
</tr>
<tr>
<td><strong>通知机制</strong></td>
<td>sd_notify &#x2F; systemd-notify</td>
<td>服务向 systemd 报告状态的机制</td>
</tr>
</tbody></table>
<hr>
<h2 id="3-服务通知机制"><a href="#3-服务通知机制" class="headerlink" title="3. 服务通知机制"></a>3. 服务通知机制</h2><h3 id="3-1-为什么需要通知机制？"><a href="#3-1-为什么需要通知机制？" class="headerlink" title="3.1 为什么需要通知机制？"></a>3.1 为什么需要通知机制？</h3><p>应用程序启动需要一定时间才能完成初始化。systemd 需要知道服务何时真正就绪：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────┐    启动命令     ┌─────────────────┐</span><br><span class="line">│   systemd   │ ─────────────► │   应用程序       │</span><br><span class="line">│             │                │                  │</span><br><span class="line">│  等待通知<span class="string">...</span> │ ◄───READY=1─── │ 初始化完成后通知  │</span><br><span class="line">│             │                │                  │</span><br><span class="line">│  服务已就绪  │                │  继续运行<span class="string">...</span>     │</span><br><span class="line">└─────────────┘                └─────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="3-2-服务类型-Type"><a href="#3-2-服务类型-Type" class="headerlink" title="3.2 服务类型 (Type)"></a>3.2 服务类型 (Type)</h3><table>
<thead>
<tr>
<th>Type</th>
<th>描述</th>
<th>就绪判断</th>
</tr>
</thead>
<tbody><tr>
<td><code>simple</code></td>
<td>默认类型</td>
<td><code>ExecStart</code> 进程启动即就绪</td>
</tr>
<tr>
<td><code>forking</code></td>
<td>传统守护进程</td>
<td>主进程 fork 后退出即就绪</td>
</tr>
<tr>
<td><strong><code>notify</code></strong></td>
<td>通知类型</td>
<td>收到 <code>READY=1</code> 通知即就绪</td>
</tr>
<tr>
<td><code>oneshot</code></td>
<td>一次性任务</td>
<td>进程退出即完成</td>
</tr>
</tbody></table>
<h3 id="3-3-通知协议"><a href="#3-3-通知协议" class="headerlink" title="3.3 通知协议"></a>3.3 通知协议</h3><p>通过 Unix Socket (<code>NOTIFY_SOCKET</code>) 发送状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 环境变量</span></span><br><span class="line">NOTIFY_SOCKET=/run/systemd/notify</span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用通知消息</span></span><br><span class="line">READY=1                    <span class="comment"># 服务就绪</span></span><br><span class="line">STATUS=Processing data     <span class="comment"># 状态描述（显示在 systemctl status）</span></span><br><span class="line">MAINPID=12345             <span class="comment"># 主进程 PID</span></span><br><span class="line">STOPPING=1                <span class="comment"># 正在停止</span></span><br><span class="line">RELOADING=1               <span class="comment"># 正在重载配置</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-systemd-notify-命令"><a href="#3-4-systemd-notify-命令" class="headerlink" title="3.4 systemd-notify 命令"></a>3.4 systemd-notify 命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通知就绪</span></span><br><span class="line">systemd-notify --ready</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新状态</span></span><br><span class="line">systemd-notify --status=<span class="string">&quot;Processing request...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 组合使用</span></span><br><span class="line">systemd-notify --ready --status=<span class="string">&quot;Waiting for connections&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>手册摘要</strong>：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">    systemd-notify - 通知服务管理器启动完成及其他状态变化</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">    systemd-notify [OPTIONS.<span class="string">..</span>] [VARIABLE=VALUE.<span class="string">..</span>]</span><br><span class="line"></span><br><span class="line">OPTIONS</span><br><span class="line">    <span class="params">--ready</span>       通知服务启动完成 <span class="params">(等价于 <span class="attr">READY</span>=1)</span></span><br><span class="line">    <span class="params">--status=</span>     发送人类可读的状态字符串</span><br><span class="line">    <span class="params">--pid=</span>        通知主进程 PID</span><br><span class="line">    <span class="params">--stopping</span>    通知正在停止</span><br><span class="line">    <span class="params">--reloading</span>   通知正在重载</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-四种语言实现示例"><a href="#4-四种语言实现示例" class="headerlink" title="4. 四种语言实现示例"></a>4. 四种语言实现示例</h2><h3 id="4-1-Shell-实现"><a href="#4-1-Shell-实现" class="headerlink" title="4.1 Shell 实现"></a>4.1 Shell 实现</h3><p><strong>服务脚本</strong> <code>helloworld.sh</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通知 systemd 服务已就绪</span></span><br><span class="line">systemd-notify --ready --status=<span class="string">&quot;Waiting for data ….....&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> 10</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> : ; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;...NOTIFY_SOCKET:[ <span class="variable">$NOTIFY_SOCKET</span> ]...&quot;</span> &gt; /tmp/notify.txt</span><br><span class="line">    systemd-notify --status=<span class="string">&quot;do something hello.....&quot;</span>   </span><br><span class="line">    <span class="built_in">sleep</span> 5 </span><br><span class="line">    systemd-notify --status=<span class="string">&quot;do something world.....&quot;</span>   </span><br><span class="line">    <span class="built_in">sleep</span> 5 </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><strong>服务单元</strong> <code>helloworld.service</code>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=HelloWorld Service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/helloworld.sh</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<p><strong>运行效果</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl status helloworld.service</span><br><span class="line">● helloworld.service - HelloWorld Service</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/helloworld.service; disabled)</span><br><span class="line">   Active: active (running) since Wed 2023-10-04 06:22:52 EDT</span><br><span class="line"> Main PID: 7039 (helloworld.sh)</span><br><span class="line">   Status: <span class="string">&quot;do something hello.....&quot;</span></span><br><span class="line">    Tasks: 1</span><br><span class="line">   CGroup: /system.slice/helloworld.service</span><br><span class="line">           └─7039 /bin/bash /usr/local/bin/helloworld.sh</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="4-2-C-语言实现"><a href="#4-2-C-语言实现" class="headerlink" title="4.2 C 语言实现"></a>4.2 C 语言实现</h3><p><strong>服务程序</strong> <code>helloworld_c.c</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="comment">// yum install systemd-devel</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;systemd/sd-daemon.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Starting up ...&quot;</span>);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Startup complete before notify&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通知 systemd 服务就绪</span></span><br><span class="line">    sd_notify(<span class="number">0</span>, <span class="string">&quot;READY=1&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    sd_notify(<span class="number">0</span>, <span class="string">&quot;STATUS=status message&quot;</span>);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(;;) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Hello from the Demo Service&quot;</span>);</span><br><span class="line">        sd_notify(<span class="number">0</span>, <span class="string">&quot;STATUS=Processing  data&quot;</span>);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        sd_notify(<span class="number">0</span>, <span class="string">&quot;STATUS=Waiting for data&quot;</span>);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>编译</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装开发库</span></span><br><span class="line"><span class="built_in">sudo</span> yum install systemd-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">gcc -o helloworld_c helloworld_c.c -lsystemd</span><br></pre></td></tr></table></figure>

<p><strong>服务单元</strong> <code>helloworld_c.service</code>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=HelloWorld Service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/helloworld_c</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<p><strong>核心 API</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sd_notify 函数原型</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sd_notify</span><span class="params">(<span class="type">int</span> unset_environment, <span class="type">const</span> <span class="type">char</span> *state)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 常用调用</span></span><br><span class="line">sd_notify(<span class="number">0</span>, <span class="string">&quot;READY=1&quot;</span>);                  <span class="comment">// 就绪通知</span></span><br><span class="line">sd_notify(<span class="number">0</span>, <span class="string">&quot;STATUS=Processing...&quot;</span>);     <span class="comment">// 状态更新</span></span><br><span class="line">sd_notify(<span class="number">0</span>, <span class="string">&quot;MAINPID=%d&quot;</span>, getpid());     <span class="comment">// PID 通知</span></span><br><span class="line">sd_notify(<span class="number">0</span>, <span class="string">&quot;STOPPING=1&quot;</span>);               <span class="comment">// 停止通知</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="4-3-Python-实现"><a href="#4-3-Python-实现" class="headerlink" title="4.3 Python 实现"></a>4.3 Python 实现</h3><p><strong>服务程序</strong> <code>helloworld.py</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line">    <span class="keyword">import</span> systemd.daemon</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Starting up ...&#x27;</span>)</span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Startup complete before notify&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 通知 systemd 服务就绪</span></span><br><span class="line">    systemd.daemon.notify(<span class="string">&#x27;READY=1&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Startup complete after notify&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Hello from the Python Demo Service&#x27;</span>)</span><br><span class="line">        systemd.daemon.notify(<span class="string">&quot;STATUS=Processing  data&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">5</span>)</span><br><span class="line">        systemd.daemon.notify(<span class="string">&quot;STATUS=Waiting for data&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<p><strong>依赖安装</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install systemd-python</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">yum install python-systemd</span><br></pre></td></tr></table></figure>

<p><strong>服务单元</strong> <code>helloworld.service</code>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=HelloWorld Service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/python /usr/local/bin/helloworld.py</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="4-4-Erlang-实现"><a href="#4-4-Erlang-实现" class="headerlink" title="4.4 Erlang 实现"></a>4.4 Erlang 实现</h3><p>Erlang 使用 <a target="_blank" rel="noopener" href="https://github.com/hauleth/systemd">systemd</a> 库与 systemd 集成。</p>
<p><strong>应用入口</strong> <code>erlang_systemd_app.erl</code>:</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-module</span><span class="params">(erlang_systemd_app)</span>.</span><br><span class="line"></span><br><span class="line"><span class="keyword">-export</span><span class="params">([boot/<span class="number">0</span>])</span>.</span><br><span class="line"><span class="keyword">-export</span><span class="params">([start/<span class="number">2</span>])</span>.</span><br><span class="line"><span class="keyword">-export</span><span class="params">([stop/<span class="number">1</span>])</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start</span><span class="params">(_Type, _Args)</span> -&gt;</span></span><br><span class="line">    boot().</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">boot</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    erlang_systemd_sup:start_link().</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stop</span><span class="params">(_State)</span> -&gt;</span></span><br><span class="line">    ok.</span><br></pre></td></tr></table></figure>

<p><strong>监督树</strong> <code>erlang_systemd_sup.erl</code>:</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-module</span><span class="params">(erlang_systemd_sup)</span>.</span><br><span class="line"><span class="keyword">-behaviour</span><span class="params">(supervisor)</span>.</span><br><span class="line"></span><br><span class="line"><span class="keyword">-export</span><span class="params">([start_link/<span class="number">0</span>])</span>.</span><br><span class="line"><span class="keyword">-export</span><span class="params">([init/<span class="number">1</span>])</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start_link</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    supervisor:start_link(&#123;local, ?MODULE&#125;, ?MODULE, []).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">init</span><span class="params">([])</span> -&gt;</span></span><br><span class="line">    SupFlags = #&#123;strategy =&gt; one_for_one,</span><br><span class="line">                 intensity =&gt; <span class="number">5</span>,</span><br><span class="line">                 period =&gt; <span class="number">3600</span>&#125;,</span><br><span class="line">    ChildSpecs = [child_static(frequency)],</span><br><span class="line">    &#123;ok, &#123;SupFlags, ChildSpecs&#125;&#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">child_static</span><span class="params">(Module)</span> -&gt;</span></span><br><span class="line">    &#123;Module, &#123;Module, start_link, []&#125;,</span><br><span class="line">     permanent, <span class="number">5000</span>, worker, [Module]&#125;.</span><br></pre></td></tr></table></figure>

<p><strong>核心工作进程</strong> <code>frequency.erl</code>:</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-module</span><span class="params">(frequency)</span>.</span><br><span class="line"><span class="keyword">-behaviour</span><span class="params">(gen_server)</span>.</span><br><span class="line"><span class="keyword">-compile</span><span class="params">(export_all)</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start_link</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    io:format(&#x27;Starting up ...\n&#x27;),</span><br><span class="line">    io:format(&#x27;Startup complete before notify\n&#x27;),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 启动 systemd 应用</span></span><br><span class="line">    &#123;ok, _&#125; = application:ensure_all_started(systemd),</span><br><span class="line">    timer:sleep(<span class="number">5000</span>),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 通知就绪</span></span><br><span class="line">    systemd:notify([ready, &#123;status, <span class="string">&quot;booting&quot;</span>&#125;]),</span><br><span class="line">    io:format(&#x27;after ready: Startup complete after notify\n&#x27;),</span><br><span class="line">    </span><br><span class="line">    timer:sleep(<span class="number">5000</span>),</span><br><span class="line">    systemd:notify([&#123;status, <span class="string">&quot;Processing  data&quot;</span>&#125;]),</span><br><span class="line">    io:format(&#x27;after:Processing  data: Startup complete after notify\n&#x27;),</span><br><span class="line">    </span><br><span class="line">    timer:sleep(<span class="number">5000</span>),</span><br><span class="line">    systemd:notify([&#123;status, <span class="string">&quot;After Processing  data&quot;</span>&#125;]),</span><br><span class="line">    io:format(&#x27;after:After Processing  data : Startup complete after notify\n&#x27;),</span><br><span class="line">    </span><br><span class="line">    timer:sleep(<span class="number">5000</span>),</span><br><span class="line">    systemd:notify([ready, &#123;status, <span class="string">&quot;booted&quot;</span>&#125;]),</span><br><span class="line">    io:format(&#x27;after:ready booted \n&#x27;),</span><br><span class="line">    </span><br><span class="line">    gen_server:start_link(&#123;local, frequency&#125;, frequency, [], []).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% ... gen_server 回调函数 ...</span></span><br></pre></td></tr></table></figure>

<p><strong>服务单元</strong> <code>helloworld.service</code>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=HelloWorld Service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">NotifyAccess</span>=all</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/helloworld.sh</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<p><strong>关键配置</strong>: <code>NotifyAccess=all</code> - 允许服务的任何子进程发送通知（Erlang VM 的通知来自子进程）</p>
<p><strong>Erlang systemd API</strong>:</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 通知就绪</span></span><br><span class="line">systemd:notify([ready]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 带状态的就绪通知</span></span><br><span class="line">systemd:notify([ready, &#123;status, <span class="string">&quot;Initialized&quot;</span>&#125;]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 状态更新</span></span><br><span class="line">systemd:notify([&#123;status, <span class="string">&quot;Processing data...&quot;</span>&#125;]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 停止通知</span></span><br><span class="line">systemd:notify([stopping]).</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-RabbitMQ-与-Systemd-集成"><a href="#5-RabbitMQ-与-Systemd-集成" class="headerlink" title="5. RabbitMQ 与 Systemd 集成"></a>5. RabbitMQ 与 Systemd 集成</h2><h3 id="5-1-RabbitMQ-服务单元"><a href="#5-1-RabbitMQ-服务单元" class="headerlink" title="5.1 RabbitMQ 服务单元"></a>5.1 RabbitMQ 服务单元</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/lib/systemd/system/rabbitmq-server.service</span></span><br><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=RabbitMQ broker</span><br><span class="line"><span class="attr">After</span>=network.target epmd@<span class="number">0.0</span>.<span class="number">0.0</span>.socket</span><br><span class="line"><span class="attr">Wants</span>=network.target epmd@<span class="number">0.0</span>.<span class="number">0.0</span>.socket</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">NotifyAccess</span>=all</span><br><span class="line"><span class="attr">User</span>=rabbitmq</span><br><span class="line"><span class="attr">Group</span>=rabbitmq</span><br><span class="line"><span class="attr">UMask</span>=<span class="number">0027</span></span><br><span class="line"><span class="attr">NotifyAccess</span>=all</span><br><span class="line"><span class="attr">TimeoutStartSec</span>=<span class="number">3600</span></span><br><span class="line"><span class="attr">LimitNOFILE</span>=<span class="number">32768</span></span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"><span class="attr">RestartSec</span>=<span class="number">10</span></span><br><span class="line"><span class="attr">WorkingDirectory</span>=/var/lib/rabbitmq</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/lib/rabbitmq/bin/rabbitmq-server</span><br><span class="line"><span class="attr">ExecStop</span>=/usr/lib/rabbitmq/bin/rabbitmqctl shutdown</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<h3 id="5-2-启动环境变量"><a href="#5-2-启动环境变量" class="headerlink" title="5.2 启动环境变量"></a>5.2 启动环境变量</h3><p>RabbitMQ 在 systemd 环境下设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NOTIFY_SOCKET=/run/systemd/notify</span><br><span class="line">RUNNING_UNDER_SYSTEMD=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-启动流程"><a href="#5-3-启动流程" class="headerlink" title="5.3 启动流程"></a>5.3 启动流程</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ systemctl start rabbitmq-server                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ <span class="number">1</span>. systemd 执行 ExecStart=/usr/lib/rabbitmq/bin/rabbitmq-server │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ <span class="number">2</span>. 启动 Erlang VM (beam.smp)                                    │</span><br><span class="line">│    NOTIFY_SOCKET 环境变量传递给 VM                               │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ <span class="number">3</span>. rabbit:boot/<span class="number">0</span> - RabbitMQ 核心启动                            │</span><br><span class="line">│    - 启动 Mnesia/Khepri 数据库                                  │</span><br><span class="line">│    - 加载插件                                                   │</span><br><span class="line">│    - 启动监听器                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ <span class="number">4</span>. Change boot <span class="keyword">state</span> <span class="keyword">to</span> `core_started`                          │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ <span class="number">5</span>. Change boot <span class="keyword">state</span> <span class="keyword">to</span> `ready`                                 │</span><br><span class="line">│    systemd:notify([ready, &#123;status, <span class="string">&quot;Initialized&quot;</span>&#125;])             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ systemd 收到 READY=<span class="number">1</span>，标记服务为 active (running)               │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="5-4-查看启动日志"><a href="#5-4-查看启动日志" class="headerlink" title="5.4 查看启动日志"></a>5.4 查看启动日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看启动状态变化</span></span><br><span class="line">$ grep <span class="string">&quot;Change boot state to&quot;</span> /var/log/rabbitmq/rabbit@rabbitmq.log</span><br><span class="line">2025-01-04 07:59:46.747822 [debug] &lt;0.237.0&gt; Change boot state to `core_started`</span><br><span class="line">2025-01-04 07:59:46.898118 [debug] &lt;0.477.0&gt; Change boot state to `ready`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 systemd 状态</span></span><br><span class="line">$ systemctl status rabbitmq-server.service</span><br><span class="line">● rabbitmq-server.service - RabbitMQ broker</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/rabbitmq-server.service; disabled)</span><br><span class="line">   Active: active (running) since Sat 2025-01-04 01:41:22 EST; 12min ago</span><br><span class="line"> Main PID: 69505 (beam.smp)</span><br><span class="line">   Status: <span class="string">&quot;Initialized&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-5-手动启动（非-systemd）"><a href="#5-5-手动启动（非-systemd）" class="headerlink" title="5.5 手动启动（非 systemd）"></a>5.5 手动启动（非 systemd）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置插件路径</span></span><br><span class="line"><span class="built_in">export</span> ERL_LIBS=/usr/lib/rabbitmq/lib/rabbitmq_server-3.9.21/plugins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Erlang VM 运行 RabbitMQ</span></span><br><span class="line">ERL_LIBS=/usr/lib/rabbitmq/lib/rabbitmq_server-3.9.21/plugins erl \</span><br><span class="line">    -noinput -s rabbit boot -boot start_sasl</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-实践操作指南"><a href="#6-实践操作指南" class="headerlink" title="6. 实践操作指南"></a>6. 实践操作指南</h2><h3 id="6-1-安装服务"><a href="#6-1-安装服务" class="headerlink" title="6.1 安装服务"></a>6.1 安装服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 复制程序到系统目录</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> helloworld.sh /usr/local/bin/</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> +x /usr/local/bin/helloworld.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 复制服务单元文件</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> helloworld.service /etc/systemd/system/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 重新加载 systemd 配置</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br></pre></td></tr></table></figure>

<h3 id="6-2-管理服务"><a href="#6-2-管理服务" class="headerlink" title="6.2 管理服务"></a>6.2 管理服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl start helloworld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl status helloworld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止服务</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl stop helloworld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl restart helloworld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> helloworld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用开机自启</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">disable</span> helloworld</span><br></pre></td></tr></table></figure>

<h3 id="6-3-查看日志"><a href="#6-3-查看日志" class="headerlink" title="6.3 查看日志"></a>6.3 查看日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看服务日志</span></span><br><span class="line">journalctl -u helloworld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实时跟踪日志</span></span><br><span class="line">journalctl -u helloworld -f</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看最近 100 行</span></span><br><span class="line">journalctl -u helloworld -n 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看启动以来的日志</span></span><br><span class="line">journalctl -u helloworld -b</span><br></pre></td></tr></table></figure>

<h3 id="6-4-调试通知"><a href="#6-4-调试通知" class="headerlink" title="6.4 调试通知"></a>6.4 调试通知</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 手动测试通知（需要在服务环境中）</span></span><br><span class="line">NOTIFY_SOCKET=/run/systemd/notify systemd-notify --ready</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 NOTIFY_SOCKET 环境变量</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$NOTIFY_SOCKET</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-对比总结"><a href="#7-对比总结" class="headerlink" title="7. 对比总结"></a>7. 对比总结</h2><table>
<thead>
<tr>
<th>语言</th>
<th>通知函数</th>
<th>依赖</th>
<th>复杂度</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Shell</strong></td>
<td><code>systemd-notify</code></td>
<td>无</td>
<td>最简单</td>
</tr>
<tr>
<td><strong>C</strong></td>
<td><code>sd_notify()</code></td>
<td>systemd-devel</td>
<td>简单</td>
</tr>
<tr>
<td><strong>Python</strong></td>
<td><code>systemd.daemon.notify()</code></td>
<td>python-systemd</td>
<td>简单</td>
</tr>
<tr>
<td><strong>Erlang</strong></td>
<td><code>systemd:notify/1</code></td>
<td>systemd (Hex)</td>
<td>中等</td>
</tr>
</tbody></table>
<h3 id="服务单元配置要点"><a href="#服务单元配置要点" class="headerlink" title="服务单元配置要点"></a>服务单元配置要点</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify          <span class="comment"># 必须设置为 notify</span></span><br><span class="line"><span class="attr">NotifyAccess</span>=all     <span class="comment"># Erlang/多进程应用需要设置</span></span><br><span class="line"><span class="attr">TimeoutStartSec</span>=<span class="number">90</span>   <span class="comment"># 给足启动超时时间</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-参考资源"><a href="#8-参考资源" class="headerlink" title="8. 参考资源"></a>8. 参考资源</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.freedesktop.org/software/systemd/man/">systemd 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freedesktop.org/software/systemd/man/sd_notify.html">sd_notify(3) 手册</a></li>
<li><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/install-rpm.html">RabbitMQ 安装指南</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/hauleth/systemd">Erlang systemd 库</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/hzsunzixiang/rabbitmq-server-debug/tree/main/book/systemd">示例代码仓库</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/18/rabbitmq-rabbitmq-startup-systemd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/18/rabbitmq-rabbitmq-startup-systemd/" class="post-title-link" itemprop="url">RabbitMQ 启动方式与 Systemd 集成详解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-18 00:00:00 / 修改时间：12:33:43" itemprop="dateCreated datePublished" datetime="2026-01-18T00:00:00+08:00">2026-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RabbitMQ-启动方式与-Systemd-集成详解"><a href="#RabbitMQ-启动方式与-Systemd-集成详解" class="headerlink" title="RabbitMQ 启动方式与 Systemd 集成详解"></a>RabbitMQ 启动方式与 Systemd 集成详解</h1><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p><strong>以 RabbitMQ version: 3.9.21 版本为例</strong></p>
<ul>
<li><strong>systemd 的使用方式(shell、c、python、erlang)</strong></li>
<li><strong>RabbitMQ 的启动方式</strong></li>
<li><strong>systemd 库的源码分析</strong></li>
<li><strong>RabbitMQ 的启动脚本</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ERL_LIBS=/usr/lib/rabbitmq/lib/rabbitmq_server-3.9.21/plugins</span><br><span class="line"></span><br><span class="line">ERL_LIBS=/usr/lib/rabbitmq/lib/rabbitmq_server-3.9.21/plugins erl -noinput -s rabbit boot -boot start_sasl</span><br></pre></td></tr></table></figure>

<p><img src="/rabbitmq-startup-systemd/image2.svg" alt="RabbitMQ 启动架构图"></p>
<p><img src="/rabbitmq-startup-systemd/image3.png" alt="启动流程"></p>
<p><img src="/rabbitmq-startup-systemd/image4.png" alt="详细启动过程"></p>
<p><img src="/rabbitmq-startup-systemd/image5.png" alt="启动状态"></p>
<hr>
<h2 id="systemd-相关术语"><a href="#systemd-相关术语" class="headerlink" title="systemd 相关术语"></a>systemd 相关术语</h2><h3 id="术语解释"><a href="#术语解释" class="headerlink" title="术语解释"></a>术语解释</h3><table>
<thead>
<tr>
<th><strong>术语</strong></th>
<th><strong>英文对照</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>应用程序</strong></td>
<td>service script(App)</td>
<td></td>
</tr>
<tr>
<td><strong>服务名</strong></td>
<td>service</td>
<td></td>
</tr>
<tr>
<td><strong>服务管理器</strong></td>
<td>systemd</td>
<td>系统和服务管理器</td>
</tr>
<tr>
<td><strong>服务管理命令</strong></td>
<td>systemctl</td>
<td>与 systemd 进行交互的接口</td>
</tr>
</tbody></table>
<p>应用程序启动一般需要一定的启动时间才能初始化完毕，初始化完毕的时候可以通过某种方式通知服务管理器。</p>
<p><code>systemd-notify</code> 就是用来向服务管理器(systemd)<strong>通知启动完成</strong>及其他守护进程状态变化。</p>
<p><code>systemd-notify</code> 是 <code>sd_notify()</code> 函数的一个包装，使得 shell 脚本也能使用此功能。</p>
<p><img src="/rabbitmq-startup-systemd/image6.png" alt="systemd-notify 工作流程"></p>
<h3 id="实例演示"><a href="#实例演示" class="headerlink" title="实例演示"></a>实例演示</h3><table>
<thead>
<tr>
<th><strong>术语</strong></th>
<th><strong>英文对照</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>应用程序</strong></td>
<td>service script(App)</td>
<td>helloworld.sh</td>
</tr>
<tr>
<td><strong>服务名</strong></td>
<td>service name</td>
<td>helloworld.service</td>
</tr>
<tr>
<td><strong>服务管理器</strong></td>
<td>systemd</td>
<td>系统和服务管理器</td>
</tr>
<tr>
<td><strong>服务管理命令</strong></td>
<td>systemctl</td>
<td>与 systemd 进行交互的接口</td>
</tr>
</tbody></table>
<p><img src="/rabbitmq-startup-systemd/image7.png" alt="实例演示架构"></p>
<p><strong>示例代码：</strong> <a target="_blank" rel="noopener" href="https://github.com/hzsunzixiang/rabbitmq-server-debug/tree/main/book/systemd">https://github.com/hzsunzixiang/rabbitmq-server-debug/tree/main/book/systemd</a></p>
<h4 id="应用程序-helloworld-sh"><a href="#应用程序-helloworld-sh" class="headerlink" title="应用程序 (helloworld.sh)"></a>应用程序 (helloworld.sh)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">systemd-notify --ready --status=<span class="string">&quot;Waiting for data ...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> : ; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;...NOTIFY_SOCKET:[ <span class="variable">$NOTIFY_SOCKET</span> ]...&quot;</span> &gt; /tmp/notify.txt</span><br><span class="line">    systemd-notify --status=<span class="string">&quot;do something hello...&quot;</span></span><br><span class="line">    <span class="comment"># Do something with</span></span><br><span class="line">    <span class="built_in">sleep</span> 10</span><br><span class="line">    systemd-notify --status=<span class="string">&quot;do something world...&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h4 id="Service-配置-helloworld-service"><a href="#Service-配置-helloworld-service" class="headerlink" title="Service 配置 (helloworld.service)"></a>Service 配置 (helloworld.service)</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=HelloWorld Service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/helloworld.sh</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<h4 id="流程演示"><a href="#流程演示" class="headerlink" title="流程演示"></a>流程演示</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start helloworld</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;helloworld&quot;</span> &gt; /tmp/helloworld</span><br><span class="line">systemctl status helloworld</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="C-语言中的-systemd"><a href="#C-语言中的-systemd" class="headerlink" title="C 语言中的 systemd"></a>C 语言中的 systemd</h2><p>示例代码：<a target="_blank" rel="noopener" href="https://github.com/hzsunzixiang/rabbitmq-server-debug/tree/main/book/systemd/clang_systemd">https://github.com/hzsunzixiang/rabbitmq-server-debug/tree/main/book/systemd/clang_systemd</a></p>
<hr>
<h2 id="Python-中的-systemd"><a href="#Python-中的-systemd" class="headerlink" title="Python 中的 systemd"></a>Python 中的 systemd</h2><p>示例代码：<a target="_blank" rel="noopener" href="https://github.com/hzsunzixiang/rabbitmq-server-debug/tree/main/book/systemd/python_systemd">https://github.com/hzsunzixiang/rabbitmq-server-debug/tree/main/book/systemd/python_systemd</a></p>
<hr>
<h2 id="Erlang-中的-systemd"><a href="#Erlang-中的-systemd" class="headerlink" title="Erlang 中的 systemd"></a>Erlang 中的 systemd</h2><p><strong>注意：</strong> 需要设置 <code>NotifyAccess=all</code></p>
<h3 id="启动示例"><a href="#启动示例" class="headerlink" title="启动示例"></a>启动示例</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">application:ensure_all_started(systemd).</span><br><span class="line">&#123;ok,[enough,systemd]&#125;</span><br></pre></td></tr></table></figure>

<p>或者从 <code>rebar.config</code> 中配置依赖：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;deps, [enough]&#125;.</span><br></pre></td></tr></table></figure>

<h3 id="erlang-systemd-库特点"><a href="#erlang-systemd-库特点" class="headerlink" title="erlang-systemd 库特点"></a>erlang-systemd 库特点</h3><p>erlang-systemd 是一个 Erlang 库，用于在 Erlang 应用程序中集成 systemd。主要特点包括：</p>
<ol>
<li>支持 systemd 的所有通知类型，包括 READY、STATUS、WATCHDOG 等</li>
<li>支持 systemd 的所有进程管理功能，包括启动、停止、重启、暂停、恢复等</li>
<li>支持 systemd 的所有 unit 管理功能，包括注册、卸载、状态查询等</li>
<li>支持 systemd 的所有进程间通信功能，包括 socket 激活、文件描述符传递等</li>
<li>提供了一组方便的宏和函数，简化与 systemd 的交互过程</li>
</ol>
<h3 id="Socket-处理代码"><a href="#Socket-处理代码" class="headerlink" title="Socket 处理代码"></a>Socket 处理代码</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">os:putenv(<span class="string">&quot;NOTIFY_SOCKET&quot;</span>, <span class="string">&quot;/run/systemd/notify&quot;</span>).</span><br><span class="line">os:getenv(<span class="string">&quot;NOTIFY_SOCKET&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">notify_socket</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    State =</span><br><span class="line">        <span class="keyword">case</span> os:getenv(?NOTIFY_SOCKET) <span class="keyword">of</span></span><br><span class="line">            <span class="literal">false</span> -&gt;</span><br><span class="line">                [];</span><br><span class="line">            [<span class="string">$@</span> | AbstractPath] -&gt;</span><br><span class="line">                [<span class="number">0</span> | AbstractPath];</span><br><span class="line">            Path -&gt;</span><br><span class="line">                <span class="keyword">case</span> file:read_file_info(Path) <span class="keyword">of</span></span><br><span class="line">                    &#123;error, _Error&#125; -&gt;</span><br><span class="line">                        [];</span><br><span class="line">                    &#123;ok, #file_info&#123;access = Access&#125;&#125; <span class="keyword">when</span></span><br><span class="line">                        Access =:= write; Access =:= read_write</span><br><span class="line">                    -&gt;</span><br><span class="line">                        Path</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span>,</span><br><span class="line">    unset(notify),</span><br><span class="line">    State.</span><br></pre></td></tr></table></figure>

<p><img src="/rabbitmq-startup-systemd/image8.png" alt="Erlang systemd 集成"></p>
<h3 id="关于-READY-通知的重要说明"><a href="#关于-READY-通知的重要说明" class="headerlink" title="关于 READY 通知的重要说明"></a>关于 READY 通知的重要说明</h3><p><strong>如果不发送 READY 通知会怎样？</strong></p>
<p>如果应用程序没有向 systemd 发送 READY 通知，systemd 会默认认为应用程序已经准备就绪，并开始接收请求。这种情况下，systemd 不会等待应用程序发送 READY 通知，而是直接将该进程标记为已就绪状态。</p>
<p><strong>使用 Type&#x3D;notify 的情况：</strong></p>
<p>如果应用程序没有 READY 通知机制，可以使用 systemd 的 <code>Type=notify</code> 选项，以便 systemd 等待应用程序发送 READY 通知。在这种情况下，systemd 会在启动应用程序时，将一条文件描述符（socket）传递给应用程序，应用程序可以使用该文件描述符向 systemd 发送 READY 通知。如果应用程序不发送 READY 通知，systemd 会超时并将该进程标记为启动失败。</p>
<hr>
<h2 id="systemd-在-RabbitMQ-启动中的具体作用"><a href="#systemd-在-RabbitMQ-启动中的具体作用" class="headerlink" title="systemd 在 RabbitMQ 启动中的具体作用"></a>systemd 在 RabbitMQ 启动中的具体作用</h2><p><img src="/rabbitmq-startup-systemd/image7.png" alt="RabbitMQ systemd 集成架构"></p>
<h3 id="安装-RabbitMQ"><a href="#安装-RabbitMQ" class="headerlink" title="安装 RabbitMQ"></a>安装 RabbitMQ</h3><h4 id="配置-yum-源"><a href="#配置-yum-源" class="headerlink" title="配置 yum 源"></a>配置 yum 源</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/yum.repos.d/CentOS-Messaging-rabbitmq.repo</span><br></pre></td></tr></table></figure>

<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[centos-rabbitmq-38]</span></span><br><span class="line"><span class="attr">name</span>=CentOS-<span class="number">9</span> - RabbitMQ <span class="number">38</span></span><br><span class="line"><span class="attr">metalink</span>=https://mirrors.centos.org/metalink?repo=centos-messaging-sig-rabbitmq-<span class="number">38</span>-<span class="variable">$releasever</span>-stream&amp;arch=<span class="variable">$basearch</span>&amp;protocol=https,http</span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-Messaging</span><br></pre></td></tr></table></figure>

<h4 id="安装命令"><a href="#安装命令" class="headerlink" title="安装命令"></a>安装命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 yum 源</span></span><br><span class="line">yum install centos-release-rabbitmq-38.noarch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 rabbitmq</span></span><br><span class="line">yum install rabbitmq-server.aarch64</span><br></pre></td></tr></table></figure>

<h4 id="设置日志级别"><a href="#设置日志级别" class="headerlink" title="设置日志级别"></a>设置日志级别</h4><p>在 <code>/etc/rabbitmq/rabbitmq.conf</code> 中添加：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">log.file.level</span> = debug</span><br></pre></td></tr></table></figure>

<p><img src="/rabbitmq-startup-systemd/image9.png" alt="日志配置"></p>
<p><img src="/rabbitmq-startup-systemd/image10.png" alt="启动日志"></p>
<p><img src="/rabbitmq-startup-systemd/image11.png" alt="详细日志"></p>
<h3 id="特别注意：域名配置"><a href="#特别注意：域名配置" class="headerlink" title="特别注意：域名配置"></a>特别注意：域名配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/hosts</span><br></pre></td></tr></table></figure>

<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::<span class="number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"><span class="number">127.0.0.1</span>   rabbitmq</span><br><span class="line"><span class="number">172.16.117.156</span>  rabbitmq</span><br></pre></td></tr></table></figure>

<p><strong>如果域名配置不正确，会出现以下错误：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</span><br><span class="line"><span class="comment"># &#123;:query, :rabbit@rabbitmq, &#123;:badrpc, :timeout&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">rabbitmqctl status</span><br><span class="line"><span class="comment"># Error: unable to perform an operation on node &#x27;rabbit@rabbitmq&#x27;.</span></span><br></pre></td></tr></table></figure>

<h3 id="RabbitMQ-Service-配置文件"><a href="#RabbitMQ-Service-配置文件" class="headerlink" title="RabbitMQ Service 配置文件"></a>RabbitMQ Service 配置文件</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemd unit example</span></span><br><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=RabbitMQ broker</span><br><span class="line"><span class="attr">After</span>=network.target epmd@<span class="number">0.0</span>.<span class="number">0.0</span>.socket</span><br><span class="line"><span class="attr">Wants</span>=network.target epmd@<span class="number">0.0</span>.<span class="number">0.0</span>.socket</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="comment"># 安全加固选项（可选）</span></span><br><span class="line"><span class="comment"># ProtectSystem=full</span></span><br><span class="line"><span class="comment"># ProtectHome=true</span></span><br><span class="line"><span class="comment"># PrivateDevices=true</span></span><br><span class="line"><span class="comment"># ProtectHostname=true</span></span><br><span class="line"><span class="comment"># ProtectClock=true</span></span><br><span class="line"><span class="comment"># ProtectKernelTunables=true</span></span><br><span class="line"><span class="comment"># ProtectKernelModules=true</span></span><br><span class="line"><span class="comment"># ProtectKernelLogs=true</span></span><br><span class="line"><span class="comment"># ProtectControlGroups=true</span></span><br><span class="line"><span class="comment"># RestrictRealtime=true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">User</span>=rabbitmq</span><br><span class="line"><span class="attr">Group</span>=rabbitmq</span><br><span class="line"><span class="attr">NotifyAccess</span>=all</span><br><span class="line"><span class="attr">TimeoutStartSec</span>=<span class="number">3600</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动重启配置（可选）</span></span><br><span class="line"><span class="comment"># Restart=on-failure</span></span><br><span class="line"><span class="comment"># RestartSec=10</span></span><br><span class="line"></span><br><span class="line"><span class="attr">WorkingDirectory</span>=/var/lib/rabbitmq</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/lib/rabbitmq/bin/rabbitmq-server</span><br><span class="line"><span class="attr">ExecStop</span>=/usr/lib/rabbitmq/bin/rabbitmqctl stop</span><br><span class="line"><span class="attr">ExecStop</span>=/bin/sh -c <span class="string">&quot;while ps -p $MAINPID &gt;/dev/null 2&gt;&amp;1; do sleep 1; done&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<h3 id="启动状态示例"><a href="#启动状态示例" class="headerlink" title="启动状态示例"></a>启动状态示例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status rabbitmq-server</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">● rabbitmq-server.service - RabbitMQ broker</span><br><span class="line"><span class="symbol">   Loaded:</span> loaded (<span class="keyword">/etc/</span>systemd<span class="keyword">/system/</span>rabbitmq-server.<span class="attr">service</span><span class="punctuation">;</span> <span class="attr">disabled</span><span class="punctuation">;</span> preset: disabled)</span><br><span class="line"><span class="symbol">   Active:</span> active (running) since Sat <span class="number">2025</span><span class="number">-01</span><span class="number">-04</span> <span class="number">01</span>:<span class="number">10</span>:<span class="number">28</span> EST<span class="punctuation">;</span> <span class="number">39</span>s ago</span><br><span class="line"> Main PID: <span class="number">164224</span> (beam.smp)</span><br><span class="line"><span class="symbol">    Tasks:</span> <span class="number">27</span> (limit: <span class="number">22563</span>)</span><br><span class="line"><span class="symbol">   Memory:</span> <span class="number">124.8</span>M</span><br><span class="line"><span class="symbol">      CPU:</span> <span class="number">5.890</span>s</span><br><span class="line"><span class="symbol">   CGroup:</span> /system.slice/rabbitmq-server.service</span><br><span class="line">           ├─<span class="number">164224</span> <span class="keyword">/usr/</span>local<span class="keyword">/lib/</span>erlang/erts<span class="number">-14.2</span><span class="number">.5</span><span class="number">.1</span><span class="keyword">/bin/</span>beam.smp ...</span><br><span class="line">           ├─<span class="number">164235</span> erl_child_setup <span class="number">1024</span></span><br><span class="line">           ├─<span class="number">164294</span> <span class="keyword">/usr/</span>local<span class="keyword">/lib/</span>erlang/erts<span class="number">-14.2</span><span class="number">.5</span><span class="number">.1</span><span class="keyword">/bin/</span>inet_gethost <span class="number">4</span></span><br><span class="line">           └─<span class="number">164295</span> <span class="keyword">/usr/</span>local<span class="keyword">/lib/</span>erlang/erts<span class="number">-14.2</span><span class="number">.5</span><span class="number">.1</span><span class="keyword">/bin/</span>inet_gethost <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p><img src="/rabbitmq-startup-systemd/image12.png" alt="服务状态"></p>
<p><img src="/rabbitmq-startup-systemd/image13.png" alt="详细状态"></p>
<h3 id="环境变量说明"><a href="#环境变量说明" class="headerlink" title="环境变量说明"></a>环境变量说明</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">NOTIFY_SOCKET</span><span class="symbol">:/run/systemd/notify</span></span><br><span class="line"><span class="variable constant_">RABBITMQ_ALLOW_INPUT</span><span class="symbol">:</span>, <span class="variable constant_">RUNNING_UNDER_SYSTEMD</span><span class="symbol">:true</span> <span class="symbol">detached:</span></span><br></pre></td></tr></table></figure>

<p><img src="/rabbitmq-startup-systemd/image14.png" alt="环境变量"></p>
<h3 id="启动状态日志"><a href="#启动状态日志" class="headerlink" title="启动状态日志"></a>启动状态日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;Change boot state to&quot;</span> /var/log/rabbitmq/*</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/<span class="keyword">log</span>/rabbitmq/rabbit@rabbitmq.<span class="keyword">log</span>:<span class="number">2025</span>-<span class="number">01</span>-<span class="number">04</span> <span class="number">07</span>:<span class="number">59</span>:<span class="number">46.747822</span>-<span class="number">05</span>:<span class="number">00</span> [<span class="keyword">debug</span>] <span class="variable">&lt;0.237.0&gt;</span> Change boot <span class="keyword">state</span> <span class="keyword">to</span> `core_started`</span><br><span class="line">/var/<span class="keyword">log</span>/rabbitmq/rabbit@rabbitmq.<span class="keyword">log</span>:<span class="number">2025</span>-<span class="number">01</span>-<span class="number">04</span> <span class="number">07</span>:<span class="number">59</span>:<span class="number">46.898118</span>-<span class="number">05</span>:<span class="number">00</span> [<span class="keyword">debug</span>] <span class="variable">&lt;0.477.0&gt;</span> Change boot <span class="keyword">state</span> <span class="keyword">to</span> `ready`</span><br></pre></td></tr></table></figure>

<h3 id="systemd-状态通知日志"><a href="#systemd-状态通知日志" class="headerlink" title="systemd 状态通知日志"></a>systemd 状态通知日志</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2025</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">14</span>:<span class="number">20</span>:<span class="number">19.415916</span>+<span class="number">08</span>:<span class="number">00</span> [<span class="keyword">debug</span>] <span class="variable">&lt;0.132.0&gt;</span> Boot <span class="keyword">state</span>/systemd: sending non-systemd <span class="keyword">state</span> (stopped) as status description: <span class="string">&quot;Standing by&quot;</span></span><br><span class="line"><span class="number">2025</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">14</span>:<span class="number">59</span>:<span class="number">40.525333</span>+<span class="number">08</span>:<span class="number">00</span> [<span class="keyword">debug</span>] <span class="variable">&lt;0.132.0&gt;</span> Boot <span class="keyword">state</span>/systemd: sending non-systemd <span class="keyword">state</span> (core_started) as status description: <span class="string">&quot;Startup in progress (core ready, starting plugins)&quot;</span></span><br><span class="line"><span class="number">2025</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">50.174236</span>+<span class="number">08</span>:<span class="number">00</span> [<span class="keyword">debug</span>] <span class="variable">&lt;0.132.0&gt;</span> Boot <span class="keyword">state</span>/systemd: sending non-systemd <span class="keyword">state</span> (stopping) as status description: <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="number">2025</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">55.186351</span>+<span class="number">08</span>:<span class="number">00</span> [<span class="keyword">debug</span>] <span class="variable">&lt;0.132.0&gt;</span> Boot <span class="keyword">state</span>/systemd: sending non-systemd <span class="keyword">state</span> (stopped) as status description: <span class="string">&quot;Standing by&quot;</span></span><br><span class="line"><span class="number">2025</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">59.650639</span>+<span class="number">08</span>:<span class="number">00</span> [<span class="keyword">debug</span>] <span class="variable">&lt;0.132.0&gt;</span> Boot <span class="keyword">state</span>/systemd: sending non-systemd <span class="keyword">state</span> (core_started) as status description: <span class="string">&quot;Startup in progress (core ready, starting plugins)&quot;</span></span><br><span class="line"><span class="number">2025</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">59.720193</span>+<span class="number">08</span>:<span class="number">00</span> [<span class="keyword">debug</span>] <span class="variable">&lt;0.132.0&gt;</span> Boot <span class="keyword">state</span>/systemd: notifying of <span class="keyword">state</span> `ready`</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> ready 之后，状态就不显示了。</p>
<p><img src="/rabbitmq-startup-systemd/image15.png" alt="启动状态图"></p>
<hr>
<h2 id="Shell-的一些用法补充"><a href="#Shell-的一些用法补充" class="headerlink" title="Shell 的一些用法补充"></a>Shell 的一些用法补充</h2><h3 id="set-e"><a href="#set-e" class="headerlink" title="set -e"></a>set -e</h3><p>在 shell 脚本中，<code>set -e</code> 是一个非常有用的指令，它的作用是让脚本在遇到任何一个命令返回非零退出状态（即命令执行失败）时，立即停止执行。</p>
<p>具体来说，在没有设置 <code>set -e</code> 时，即使脚本中的某个命令执行失败（退出状态码不为 0），脚本也会继续执行后续的命令。而当设置了 <code>set -e</code> 后，一旦某个命令返回非零退出状态，脚本会立即终止，不再执行后续的命令。</p>
<h3 id="检测-systemd-环境"><a href="#检测-systemd-环境" class="headerlink" title="检测 systemd 环境"></a>检测 systemd 环境</h3><p>如果环境变量 <code>NOTIFY_SOCKET</code> 被设置了，那么就将 <code>RUNNING_UNDER_SYSTEMD</code> 变量赋值为 <code>true</code>，表示当前脚本正在 systemd 环境下运行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ <span class="string">&quot;<span class="variable">$NOTIFY_SOCKET</span>&quot;</span> ] &amp;&amp; RUNNING_UNDER_SYSTEMD=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="systemd-notify-命令帮助"><a href="#systemd-notify-命令帮助" class="headerlink" title="systemd-notify 命令帮助"></a>systemd-notify 命令帮助</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">systemd-notify [OPTIONS...] [VARIABLE=VALUE...]</span><br><span class="line"></span><br><span class="line">Notify the init system about service status updates.</span><br><span class="line"></span><br><span class="line">  -h --<span class="built_in">help</span>       Show this <span class="built_in">help</span></span><br><span class="line">     --version    Show package version</span><br><span class="line">     --ready      Inform the init system about service start-up completion</span><br><span class="line">     --pid[=PID]  Set main PID of daemon</span><br><span class="line">     --uid=USER   Set user to send from</span><br><span class="line">     --status=TEXT Set status text</span><br><span class="line">     --booted     Check <span class="keyword">if</span> the system was booted up with systemd</span><br><span class="line">     --readahead=ACTION Controls read-ahead operations</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文详细介绍了 RabbitMQ 与 systemd 的集成方式，包括：</p>
<ol>
<li><strong>systemd 基本概念</strong>：术语解释和工作原理</li>
<li><strong>多语言实现</strong>：Shell、C、Python、Erlang 中使用 systemd-notify</li>
<li><strong>RabbitMQ 启动流程</strong>：从 systemd 启动到 READY 通知的完整过程</li>
<li><strong>配置与调试</strong>：service 文件配置、日志级别设置、常见问题排查</li>
</ol>
<p>通过 systemd 管理 RabbitMQ 服务，可以获得更好的进程监控、自动重启、日志管理等功能，是生产环境部署的推荐方式。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/17/rabbitmq-rabbitmq-deps-base64url-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/17/rabbitmq-rabbitmq-deps-base64url-analysis/" class="post-title-link" itemprop="url">RabbitMQ 依赖分析：base64url 模块深度解析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-17 00:00:00 / 修改时间：23:18:14" itemprop="dateCreated datePublished" datetime="2026-01-17T00:00:00+08:00">2026-01-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/RabbitMQ-Deps/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ Deps</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Base64url-模块深度解析"><a href="#Base64url-模块深度解析" class="headerlink" title="Base64url 模块深度解析"></a>Base64url 模块深度解析</h1><h2 id="1-模块概述"><a href="#1-模块概述" class="headerlink" title="1. 模块概述"></a>1. 模块概述</h2><p><code>base64url</code> 是 RabbitMQ 依赖的一个 URL 安全的 Base64 编解码器，遵循 <a target="_blank" rel="noopener" href="http://tools.ietf.org/html/rfc4648">RFC 4648</a> 标准。</p>
<h3 id="1-1-为什么需要-URL-安全的-Base64？"><a href="#1-1-为什么需要-URL-安全的-Base64？" class="headerlink" title="1.1 为什么需要 URL 安全的 Base64？"></a>1.1 为什么需要 URL 安全的 Base64？</h3><p>标准 Base64 编码会产生以下在 URL 中有特殊含义的字符：</p>
<table>
<thead>
<tr>
<th>字符</th>
<th>标准 Base64 含义</th>
<th>URL 中的含义</th>
<th>URL 安全替代</th>
</tr>
</thead>
<tbody><tr>
<td><code>+</code></td>
<td>第62个字符</td>
<td>空格 (form encoding)</td>
<td><code>-</code></td>
</tr>
<tr>
<td><code>/</code></td>
<td>第63个字符</td>
<td>路径分隔符</td>
<td><code>_</code></td>
</tr>
<tr>
<td><code>=</code></td>
<td>填充字符</td>
<td>参数分隔符</td>
<td>省略</td>
</tr>
</tbody></table>
<h3 id="1-2-对比示例"><a href="#1-2-对比示例" class="headerlink" title="1.2 对比示例"></a>1.2 对比示例</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 标准 Base64 (URL 不安全)</span></span><br><span class="line">base64:encode(&lt;&lt;<span class="number">255</span>,<span class="number">127</span>,<span class="number">254</span>,<span class="number">252</span>&gt;&gt;).</span><br><span class="line"><span class="comment">%% 结果: &lt;&lt;&quot;/3/+/A==&quot;&gt;&gt;</span></span><br><span class="line"><span class="comment">%%       包含 / + = 三种 URL 危险字符</span></span><br><span class="line"></span><br><span class="line"><span class="comment">%% URL 安全 Base64</span></span><br><span class="line">base64url:encode(&lt;&lt;<span class="number">255</span>,<span class="number">127</span>,<span class="number">254</span>,<span class="number">252</span>&gt;&gt;).</span><br><span class="line"><span class="comment">%% 结果: &lt;&lt;&quot;_3_-_A&quot;&gt;&gt;</span></span><br><span class="line"><span class="comment">%%       / → _,  + → -,  = 被移除</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-源码逐行解析"><a href="#2-源码逐行解析" class="headerlink" title="2. 源码逐行解析"></a>2. 源码逐行解析</h2><h3 id="2-1-模块声明部分"><a href="#2-1-模块声明部分" class="headerlink" title="2.1 模块声明部分"></a>2.1 模块声明部分</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%%</span></span><br><span class="line"><span class="comment">%% @doc URL safe base64-compatible codec.</span></span><br><span class="line"><span class="comment">%%</span></span><br><span class="line"><span class="comment">%% Based heavily on the code extracted from:</span></span><br><span class="line"><span class="comment">%%   https://github.com/basho/riak_control/blob/master/src/base64url.erl and</span></span><br><span class="line"><span class="comment">%%   https://github.com/mochi/mochiweb/blob/master/src/mochiweb_base64url.erl.</span></span><br><span class="line"><span class="comment">%%</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">-module</span><span class="params">(base64url)</span>.</span><br><span class="line"><span class="keyword">-author</span><span class="params">(&#x27;Vladimir Dronnikov &lt;dronnikov@gmail.com&gt;&#x27;)</span>.</span><br><span class="line"></span><br><span class="line"><span class="keyword">-export</span><span class="params">([</span></span><br><span class="line"><span class="params">    decode/<span class="number">1</span>,</span></span><br><span class="line"><span class="params">    encode/<span class="number">1</span>,</span></span><br><span class="line"><span class="params">    encode_mime/<span class="number">1</span></span></span><br><span class="line"><span class="params">  ])</span>.</span><br></pre></td></tr></table></figure>

<p><strong>解析</strong>：</p>
<ul>
<li><code>@doc</code> - EDoc 文档注释</li>
<li><code>-module(base64url)</code> - 模块名定义</li>
<li><code>-author(...)</code> - 作者声明</li>
<li><code>-export([...])</code> - 导出 3 个公共函数</li>
</ul>
<hr>
<h3 id="2-2-encode-1-函数"><a href="#2-2-encode-1-函数" class="headerlink" title="2.2 encode&#x2F;1 函数"></a>2.2 encode&#x2F;1 函数</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-spec</span> encode<span class="params">(</span></span><br><span class="line"><span class="params">    binary() | iolist()</span></span><br><span class="line"><span class="params">  )</span> -&gt; binary<span class="params">()</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">encode</span><span class="params">(Bin)</span> <span class="title">when</span> <span class="title">is_binary</span><span class="params">(Bin)</span> -&gt;</span></span><br><span class="line">  &lt;&lt; &lt;&lt; (urlencode_digit(D)) &gt;&gt; || &lt;&lt;D&gt;&gt; &lt;= base64:encode(Bin), D =/= <span class="string">$=</span> &gt;&gt;;</span><br><span class="line"><span class="function"><span class="title">encode</span><span class="params">(L)</span> <span class="title">when</span> <span class="title">is_list</span><span class="params">(L)</span> -&gt;</span></span><br><span class="line">  encode(iolist_to_binary(L)).</span><br></pre></td></tr></table></figure>

<p><strong>逐行解析</strong>：</p>
<h4 id="类型规范"><a href="#类型规范" class="headerlink" title="类型规范"></a>类型规范</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-spec</span> encode<span class="params">(binary() | iolist())</span> -&gt; binary<span class="params">()</span>.</span><br></pre></td></tr></table></figure>
<ul>
<li>输入：二进制或 iolist（嵌套列表&#x2F;二进制）</li>
<li>输出：二进制</li>
</ul>
<h4 id="二进制处理分支"><a href="#二进制处理分支" class="headerlink" title="二进制处理分支"></a>二进制处理分支</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">encode</span><span class="params">(Bin)</span> <span class="title">when</span> <span class="title">is_binary</span><span class="params">(Bin)</span> -&gt;</span></span><br><span class="line">  &lt;&lt; &lt;&lt; (urlencode_digit(D)) &gt;&gt; || &lt;&lt;D&gt;&gt; &lt;= base64:encode(Bin), D =/= <span class="string">$=</span> &gt;&gt;;</span><br></pre></td></tr></table></figure>

<p>这是一个<strong>二进制推导式 (Binary Comprehension)</strong>，等价于：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">encode</span><span class="params">(Bin)</span> -&gt;</span></span><br><span class="line">    Encoded = base64:encode(Bin),        <span class="comment">%% 步骤1: 标准 Base64 编码</span></span><br><span class="line">    FilteredAndMapped = lists:filtermap(</span><br><span class="line">        <span class="keyword">fun</span>(D) -&gt;</span><br><span class="line">            <span class="keyword">if</span> D =/= <span class="string">$=</span> -&gt;               <span class="comment">%% 步骤2: 过滤掉填充字符 &#x27;=&#x27;</span></span><br><span class="line">                &#123;true, urlencode_digit(D)&#125;;  <span class="comment">%% 步骤3: 字符替换</span></span><br><span class="line">               <span class="literal">true</span> -&gt; <span class="literal">false</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span>,</span><br><span class="line">        binary_to_list(Encoded)</span><br><span class="line">    ),</span><br><span class="line">    list_to_binary(FilteredAndMapped).</span><br></pre></td></tr></table></figure>

<p><strong>语法拆解</strong>：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt; &lt;&lt; (urlencode_digit(D)) &gt;&gt; || <span class="symbol">&lt;&lt;D&gt;&gt;</span> &lt;= base64:encode(Bin), D =/= $= &gt;&gt;</span><br><span class="line">   ├─────────────────────┤    ├─────┤   ├────────────────┤  ├────────┤</span><br><span class="line">         输出表达式        生成器      生成源               过滤条件</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;&lt;D&gt;&gt; &lt;= base64:encode(Bin)</code> - 从 base64 编码结果逐字节取出</li>
<li><code>D =/= $=</code> - 过滤条件：不等于 <code>=</code> 字符</li>
<li><code>&lt;&lt; (urlencode_digit(D)) &gt;&gt;</code> - 对每个字节调用转换函数</li>
</ul>
<h4 id="列表处理分支"><a href="#列表处理分支" class="headerlink" title="列表处理分支"></a>列表处理分支</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">encode</span><span class="params">(L)</span> <span class="title">when</span> <span class="title">is_list</span><span class="params">(L)</span> -&gt;</span></span><br><span class="line">  encode(iolist_to_binary(L)).</span><br></pre></td></tr></table></figure>
<ul>
<li>将 iolist 转为二进制后递归调用</li>
</ul>
<hr>
<h3 id="2-3-encode-mime-1-函数"><a href="#2-3-encode-mime-1-函数" class="headerlink" title="2.3 encode_mime&#x2F;1 函数"></a>2.3 encode_mime&#x2F;1 函数</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-spec</span> encode_mime<span class="params">(</span></span><br><span class="line"><span class="params">    binary() | iolist()</span></span><br><span class="line"><span class="params">  )</span> -&gt; binary<span class="params">()</span>.</span><br><span class="line"><span class="function"><span class="title">encode_mime</span><span class="params">(Bin)</span> <span class="title">when</span> <span class="title">is_binary</span><span class="params">(Bin)</span> -&gt;</span></span><br><span class="line">    &lt;&lt; &lt;&lt; (urlencode_digit(D)) &gt;&gt; || &lt;&lt;D&gt;&gt; &lt;= base64:encode(Bin) &gt;&gt;;</span><br><span class="line"><span class="function"><span class="title">encode_mime</span><span class="params">(L)</span> <span class="title">when</span> <span class="title">is_list</span><span class="params">(L)</span> -&gt;</span></span><br><span class="line">    encode_mime(iolist_to_binary(L)).</span><br></pre></td></tr></table></figure>

<p><strong>与 encode&#x2F;1 的区别</strong>：</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>填充字符 <code>=</code></th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td><code>encode/1</code></td>
<td>移除</td>
<td>纯 URL 安全</td>
</tr>
<tr>
<td><code>encode_mime/1</code></td>
<td>保留</td>
<td>MIME 兼容</td>
</tr>
</tbody></table>
<p><strong>注意</strong>：没有 <code>D =/= $=</code> 过滤条件，所以保留了填充字符。</p>
<hr>
<h3 id="2-4-decode-1-函数"><a href="#2-4-decode-1-函数" class="headerlink" title="2.4 decode&#x2F;1 函数"></a>2.4 decode&#x2F;1 函数</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-spec</span> decode<span class="params">(</span></span><br><span class="line"><span class="params">    binary() | iolist()</span></span><br><span class="line"><span class="params">  )</span> -&gt; binary<span class="params">()</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">decode</span><span class="params">(Bin)</span> <span class="title">when</span> <span class="title">is_binary</span><span class="params">(Bin)</span> -&gt;</span></span><br><span class="line">  Bin2 = <span class="keyword">case</span> byte_size(Bin) <span class="keyword">rem</span> <span class="number">4</span> <span class="keyword">of</span></span><br><span class="line">    <span class="comment">% 1 -&gt; &lt;&lt; Bin/binary, &quot;===&quot; &gt;&gt;;</span></span><br><span class="line">    <span class="number">2</span> -&gt; &lt;&lt; Bin/binary, <span class="string">&quot;==&quot;</span> &gt;&gt;;</span><br><span class="line">    <span class="number">3</span> -&gt; &lt;&lt; Bin/binary, <span class="string">&quot;=&quot;</span> &gt;&gt;;</span><br><span class="line">    _ -&gt; Bin</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">  base64:decode(&lt;&lt; &lt;&lt; (urldecode_digit(D)) &gt;&gt; || &lt;&lt;D&gt;&gt; &lt;= Bin2 &gt;&gt;);</span><br><span class="line"><span class="function"><span class="title">decode</span><span class="params">(L)</span> <span class="title">when</span> <span class="title">is_list</span><span class="params">(L)</span> -&gt;</span></span><br><span class="line">  decode(iolist_to_binary(L)).</span><br></pre></td></tr></table></figure>

<p><strong>逐步解析</strong>：</p>
<h4 id="步骤1-恢复填充字符"><a href="#步骤1-恢复填充字符" class="headerlink" title="步骤1: 恢复填充字符"></a>步骤1: 恢复填充字符</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Bin2 = <span class="keyword">case</span> byte_size(Bin) <span class="keyword">rem</span> <span class="number">4</span> <span class="keyword">of</span></span><br><span class="line">    <span class="number">2</span> -&gt; &lt;&lt; Bin/binary, <span class="string">&quot;==&quot;</span> &gt;&gt;;  <span class="comment">%% 长度余2，补2个=</span></span><br><span class="line">    <span class="number">3</span> -&gt; &lt;&lt; Bin/binary, <span class="string">&quot;=&quot;</span> &gt;&gt;;   <span class="comment">%% 长度余3，补1个=</span></span><br><span class="line">    _ -&gt; Bin                       <span class="comment">%% 余0或已有填充</span></span><br><span class="line"><span class="keyword">end</span>,</span><br></pre></td></tr></table></figure>

<p><strong>Base64 填充规则</strong>：</p>
<ul>
<li>Base64 输出长度必须是 4 的倍数</li>
<li>余数为 1 是无效输入（被注释掉）</li>
<li>余数为 2 需要补 <code>==</code></li>
<li>余数为 3 需要补 <code>=</code></li>
</ul>
<h4 id="步骤2-字符反向替换-解码"><a href="#步骤2-字符反向替换-解码" class="headerlink" title="步骤2: 字符反向替换 + 解码"></a>步骤2: 字符反向替换 + 解码</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base64:decode(&lt;&lt; &lt;&lt; (urldecode_digit(D)) &gt;&gt; || &lt;&lt;D&gt;&gt; &lt;= Bin2 &gt;&gt;)</span><br></pre></td></tr></table></figure>
<ul>
<li>将 URL 安全字符转回标准 Base64 字符</li>
<li>调用标准库 <code>base64:decode/1</code> 解码</li>
</ul>
<hr>
<h3 id="2-5-字符转换函数"><a href="#2-5-字符转换函数" class="headerlink" title="2.5 字符转换函数"></a>2.5 字符转换函数</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">urlencode_digit</span><span class="params">(<span class="string">$/</span>)</span> -&gt;</span> <span class="string">$_</span>;</span><br><span class="line"><span class="function"><span class="title">urlencode_digit</span><span class="params">(<span class="string">$+</span>)</span> -&gt;</span> <span class="string">$-</span>;</span><br><span class="line"><span class="function"><span class="title">urlencode_digit</span><span class="params">(D)</span>  -&gt;</span> D.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">urldecode_digit</span><span class="params">(<span class="string">$_</span>)</span> -&gt;</span> <span class="string">$/</span>;</span><br><span class="line"><span class="function"><span class="title">urldecode_digit</span><span class="params">(<span class="string">$-</span>)</span> -&gt;</span> <span class="string">$+</span>;</span><br><span class="line"><span class="function"><span class="title">urldecode_digit</span><span class="params">(D)</span>  -&gt;</span> D.</span><br></pre></td></tr></table></figure>

<p><strong>字符映射表</strong>：</p>
<table>
<thead>
<tr>
<th>方向</th>
<th><code>/</code></th>
<th><code>+</code></th>
<th>其他</th>
</tr>
</thead>
<tbody><tr>
<td>编码</td>
<td><code>_</code></td>
<td><code>-</code></td>
<td>不变</td>
</tr>
<tr>
<td>解码</td>
<td><code>/</code></td>
<td><code>+</code></td>
<td>不变</td>
</tr>
</tbody></table>
<p><strong>Erlang 字符语法</strong>：</p>
<ul>
<li><code>$_</code> 表示字符 <code>_</code> 的 ASCII 值 (95)</li>
<li><code>$/</code> 表示字符 <code>/</code> 的 ASCII 值 (47)</li>
<li><code>$+</code> 表示字符 <code>+</code> 的 ASCII 值 (43)</li>
<li><code>$-</code> 表示字符 <code>-</code> 的 ASCII 值 (45)</li>
</ul>
<hr>
<h3 id="2-6-单元测试"><a href="#2-6-单元测试" class="headerlink" title="2.6 单元测试"></a>2.6 单元测试</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-ifdef</span><span class="params">(TEST)</span>.</span><br><span class="line"><span class="keyword">-include_lib</span><span class="params">(<span class="string">&quot;eunit/include/eunit.hrl&quot;</span>)</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">aim_test</span><span class="params">()</span> -&gt;</span></span><br><span class="line">  <span class="comment">%% 验证标准 base64 产生 URL 不安全字符</span></span><br><span class="line">  ?assertNotEqual(</span><br><span class="line">      binary:match(base64:encode([<span class="number">255</span>,<span class="number">127</span>,<span class="number">254</span>,<span class="number">252</span>]), [&lt;&lt;<span class="string">&quot;=&quot;</span>&gt;&gt;, &lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;, &lt;&lt;<span class="string">&quot;+&quot;</span>&gt;&gt;]),</span><br><span class="line">      nomatch),</span><br><span class="line">  <span class="comment">%% 验证 encode/1 产生 URL 安全输出</span></span><br><span class="line">  ?assertEqual(</span><br><span class="line">      binary:match(encode([<span class="number">255</span>,<span class="number">127</span>,<span class="number">254</span>,<span class="number">252</span>]), [&lt;&lt;<span class="string">&quot;=&quot;</span>&gt;&gt;, &lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;, &lt;&lt;<span class="string">&quot;+&quot;</span>&gt;&gt;]),</span><br><span class="line">      nomatch),</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p><strong>测试覆盖</strong>：</p>
<ol>
<li><code>aim_test/0</code> - 验证 URL 安全性</li>
<li><code>codec_test/0</code> - 验证编解码无损</li>
<li><code>iolist_test/0</code> - 验证 iolist 支持</li>
</ol>
<hr>
<h2 id="3-核心技术点"><a href="#3-核心技术点" class="headerlink" title="3. 核心技术点"></a>3. 核心技术点</h2><h3 id="3-1-二进制推导式语法"><a href="#3-1-二进制推导式语法" class="headerlink" title="3.1 二进制推导式语法"></a>3.1 二进制推导式语法</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt; &lt;&lt;Expr&gt;&gt; || &lt;&lt;Pattern&gt;&gt; &lt;= Generator, Filter &gt;&gt;</span><br></pre></td></tr></table></figure>

<p>等价的列表推导式：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Expr || Pattern &lt;- Generator, Filter]</span><br></pre></td></tr></table></figure>

<p><strong>关键区别</strong>：</p>
<ul>
<li><code>&lt;=</code> 用于二进制生成器（vs <code>&lt;-</code> 用于列表）</li>
<li>输出需要双层 <code>&lt;&lt; &lt;&lt;...&gt;&gt; &gt;&gt;</code></li>
</ul>
<h3 id="3-2-Guard-子句"><a href="#3-2-Guard-子句" class="headerlink" title="3.2 Guard 子句"></a>3.2 Guard 子句</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">encode</span><span class="params">(Bin)</span> <span class="title">when</span> <span class="title">is_binary</span><span class="params">(Bin)</span> -&gt;</span> ...;</span><br><span class="line"><span class="function"><span class="title">encode</span><span class="params">(L)</span> <span class="title">when</span> <span class="title">is_list</span><span class="params">(L)</span> -&gt;</span> ...</span><br></pre></td></tr></table></figure>

<ul>
<li><code>when is_binary(Bin)</code> - 模式匹配后的额外条件</li>
<li>实现函数重载&#x2F;多态</li>
</ul>
<h3 id="3-3-iolist-类型"><a href="#3-3-iolist-类型" class="headerlink" title="3.3 iolist 类型"></a>3.3 iolist 类型</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-type iolist<span class="params">()</span> :: maybe_improper_list<span class="params">(</span></span><br><span class="line"><span class="params">    byte() | binary() | iolist(),</span></span><br><span class="line"><span class="params">    binary() | []</span></span><br><span class="line"><span class="params">)</span>.</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&quot;Hello&quot;</span>, &lt;&lt;<span class="string">&quot; &quot;</span>&gt;&gt;, [<span class="string">&quot;World&quot;</span>, &lt;&lt;<span class="string">&quot;!&quot;</span>&gt;&gt;]]  <span class="comment">%% 有效 iolist</span></span><br><span class="line"><span class="function"><span class="title">iolist_to_binary</span><span class="params">([<span class="string">&quot;Hello&quot;</span>, &lt;&lt;<span class="string">&quot; &quot;</span>&gt;&gt;, <span class="string">&quot;World&quot;</span>])</span>.</span></span><br><span class="line"><span class="function">%% 结果: &lt;&lt;&quot;H<span class="title">ello</span> W<span class="title">orld</span>&quot;&gt;&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-使用场景"><a href="#4-使用场景" class="headerlink" title="4. 使用场景"></a>4. 使用场景</h2><h3 id="4-1-JWT-Token-编码"><a href="#4-1-JWT-Token-编码" class="headerlink" title="4.1 JWT Token 编码"></a>4.1 JWT Token 编码</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% JWT 的三个部分都使用 base64url 编码</span></span><br><span class="line">Header = base64url:encode(jsx:encode(#&#123;alg =&gt; &lt;&lt;<span class="string">&quot;HS256&quot;</span>&gt;&gt;, typ =&gt; &lt;&lt;<span class="string">&quot;JWT&quot;</span>&gt;&gt;&#125;)),</span><br><span class="line">Payload = base64url:encode(jsx:encode(#&#123;sub =&gt; &lt;&lt;<span class="string">&quot;1234567890&quot;</span>&gt;&gt;&#125;)),</span><br><span class="line">Signature = base64url:encode(crypto:mac(hmac, sha256, Secret, Data)).</span><br></pre></td></tr></table></figure>

<h3 id="4-2-URL-参数传递"><a href="#4-2-URL-参数传递" class="headerlink" title="4.2 URL 参数传递"></a>4.2 URL 参数传递</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 安全地在 URL 中传递二进制数据</span></span><br><span class="line">BinaryData = &lt;&lt;<span class="number">255</span>, <span class="number">0</span>, <span class="number">128</span>, <span class="number">64</span>&gt;&gt;,</span><br><span class="line">SafeParam = base64url:encode(BinaryData),</span><br><span class="line">URL = &lt;&lt;<span class="string">&quot;https://example.com/api?data=&quot;</span>, SafeParam/binary&gt;&gt;.</span><br></pre></td></tr></table></figure>

<h3 id="4-3-文件名安全编码"><a href="#4-3-文件名安全编码" class="headerlink" title="4.3 文件名安全编码"></a>4.3 文件名安全编码</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 将任意数据编码为安全的文件名</span></span><br><span class="line">FileName = base64url:encode(term_to_binary(&#123;user, <span class="number">123</span>, <span class="string">&quot;data&quot;</span>&#125;)).</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-实战示例"><a href="#5-实战示例" class="headerlink" title="5. 实战示例"></a>5. 实战示例</h2><h3 id="5-1-基本编解码"><a href="#5-1-基本编解码" class="headerlink" title="5.1 基本编解码"></a>5.1 基本编解码</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 简单字符串编码</span></span><br><span class="line">Original = &lt;&lt;<span class="string">&quot;Hello, World!&quot;</span>&gt;&gt;,</span><br><span class="line">Encoded = base64url:encode(Original),</span><br><span class="line">Decoded = base64url:decode(Encoded),</span><br><span class="line"><span class="comment">%% Original =:= Decoded -&gt; true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">%% 二进制数据编码</span></span><br><span class="line">BinData = &lt;&lt;<span class="number">255</span>, <span class="number">0</span>, <span class="number">128</span>, <span class="number">64</span>, <span class="number">32</span>, <span class="number">16</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>&gt;&gt;,</span><br><span class="line">base64url:encode(BinData).</span><br><span class="line"><span class="comment">%% 结果: &lt;&lt;&quot;_wCAQCAQBAIB&quot;&gt;&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-URL-安全性验证"><a href="#5-2-URL-安全性验证" class="headerlink" title="5.2 URL 安全性验证"></a>5.2 URL 安全性验证</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 这组数据会产生 URL 危险字符</span></span><br><span class="line">TestData = &lt;&lt;<span class="number">255</span>, <span class="number">127</span>, <span class="number">254</span>, <span class="number">252</span>&gt;&gt;,</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 标准 Base64</span></span><br><span class="line">base64:encode(TestData).</span><br><span class="line"><span class="comment">%% 结果: &lt;&lt;&quot;/3/+/A==&quot;&gt;&gt;  (包含 / + =)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">%% URL 安全 Base64</span></span><br><span class="line">base64url:encode(TestData).</span><br><span class="line"><span class="comment">%% 结果: &lt;&lt;&quot;_3_-_A&quot;&gt;&gt;  (安全)</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-MIME-模式-vs-标准模式"><a href="#5-3-MIME-模式-vs-标准模式" class="headerlink" title="5.3 MIME 模式 vs 标准模式"></a>5.3 MIME 模式 vs 标准模式</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 测试不同长度的数据</span></span><br><span class="line">Data = &lt;&lt;<span class="string">&quot;a&quot;</span>&gt;&gt;,  <span class="comment">%% 1字节 -&gt; 需要2个填充</span></span><br><span class="line"></span><br><span class="line">base64url:encode(Data).</span><br><span class="line"><span class="comment">%% 结果: &lt;&lt;&quot;YQ&quot;&gt;&gt;  (无填充)</span></span><br><span class="line"></span><br><span class="line">base64url:encode_mime(Data).</span><br><span class="line"><span class="comment">%% 结果: &lt;&lt;&quot;YQ==&quot;&gt;&gt;  (有填充)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">%% 两者都能正确解码</span></span><br><span class="line">base64url:decode(&lt;&lt;<span class="string">&quot;YQ&quot;</span>&gt;&gt;) =:= base64url:decode(&lt;&lt;<span class="string">&quot;YQ==&quot;</span>&gt;&gt;).</span><br><span class="line"><span class="comment">%% 结果: true</span></span><br></pre></td></tr></table></figure>

<h3 id="5-4-JWT-like-场景"><a href="#5-4-JWT-like-场景" class="headerlink" title="5.4 JWT-like 场景"></a>5.4 JWT-like 场景</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 模拟 JWT 的三个部分</span></span><br><span class="line">HeaderJson = &lt;&lt;<span class="string">&quot;&#123;\&quot;alg\&quot;:\&quot;HS256\&quot;,\&quot;typ\&quot;:\&quot;JWT\&quot;&#125;&quot;</span>&gt;&gt;,</span><br><span class="line">HeaderEnc = base64url:encode(HeaderJson),</span><br><span class="line"><span class="comment">%% 结果: &lt;&lt;&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9&quot;&gt;&gt;</span></span><br><span class="line"></span><br><span class="line">PayloadJson = &lt;&lt;<span class="string">&quot;&#123;\&quot;sub\&quot;:\&quot;1234567890\&quot;,\&quot;name\&quot;:\&quot;John\&quot;&#125;&quot;</span>&gt;&gt;,</span><br><span class="line">PayloadEnc = base64url:encode(PayloadJson),</span><br><span class="line"></span><br><span class="line">SignatureBytes = crypto:strong_rand_bytes(<span class="number">32</span>),</span><br><span class="line">SignatureEnc = base64url:encode(SignatureBytes),</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 组合成 JWT 格式</span></span><br><span class="line">Token = &lt;&lt;HeaderEnc/binary, <span class="string">&quot;.&quot;</span>, PayloadEnc/binary, <span class="string">&quot;.&quot;</span>, SignatureEnc/binary&gt;&gt;.</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-性能特点"><a href="#6-性能特点" class="headerlink" title="6. 性能特点"></a>6. 性能特点</h2><table>
<thead>
<tr>
<th>特性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>零拷贝</strong></td>
<td>二进制推导直接生成结果，无中间列表</td>
</tr>
<tr>
<td><strong>流式处理</strong></td>
<td>逐字节处理，内存占用低</td>
</tr>
<tr>
<td><strong>依赖标准库</strong></td>
<td>核心编解码使用 OTP <code>base64</code> 模块</td>
</tr>
</tbody></table>
<hr>
<h2 id="7-与其他实现对比"><a href="#7-与其他实现对比" class="headerlink" title="7. 与其他实现对比"></a>7. 与其他实现对比</h2><table>
<thead>
<tr>
<th>实现</th>
<th>语言</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td><code>base64url</code></td>
<td>Erlang</td>
<td>纯函数式，依赖 OTP</td>
</tr>
<tr>
<td><code>base64.urlsafe_b64encode</code></td>
<td>Python</td>
<td>标准库内置</td>
</tr>
<tr>
<td><code>Base64.getUrlEncoder()</code></td>
<td>Java</td>
<td>JDK 8+ 内置</td>
</tr>
<tr>
<td><code>btoa</code> + 替换</td>
<td>JavaScript</td>
<td>需手动处理</td>
</tr>
</tbody></table>
<hr>
<h2 id="8-在-RabbitMQ-中的应用"><a href="#8-在-RabbitMQ-中的应用" class="headerlink" title="8. 在 RabbitMQ 中的应用"></a>8. 在 RabbitMQ 中的应用</h2><p><code>base64url</code> 模块在 RabbitMQ 中主要用于：</p>
<ol>
<li><strong>OAuth 2.0 &#x2F; JWT 认证</strong>：编解码 JWT Token</li>
<li><strong>管理 API</strong>：URL 参数中传递二进制数据</li>
<li><strong>消息属性编码</strong>：某些需要 URL 安全的场景</li>
</ol>
<hr>
<h2 id="9-参考资料"><a href="#9-参考资料" class="headerlink" title="9. 参考资料"></a>9. 参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc4648">RFC 4648 - Base Encodings</a></li>
<li><a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/base64.html">Erlang base64 模块</a></li>
<li><a target="_blank" rel="noopener" href="https://www.erlang.org/doc/reference_manual/expressions.html#binary-comprehensions">Binary Comprehensions</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dvv/base64url">base64url GitHub</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/17/rabbitmq-rabbitmq-dependencies-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/17/rabbitmq-rabbitmq-dependencies-analysis/" class="post-title-link" itemprop="url">RabbitMQ 依赖模块全面分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-17 00:00:00 / 修改时间：22:46:59" itemprop="dateCreated datePublished" datetime="2026-01-17T00:00:00+08:00">2026-01-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RabbitMQ-依赖模块全面分析"><a href="#RabbitMQ-依赖模块全面分析" class="headerlink" title="RabbitMQ 依赖模块全面分析"></a>RabbitMQ 依赖模块全面分析</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本文档对 RabbitMQ 4.0.5 版本 <code>deps/</code> 目录下的 86 个依赖模块进行全面分析，涵盖每个模块的功能、与 RabbitMQ 核心的交互方式以及在整体架构中的作用。</p>
<h2 id="架构层次概览"><a href="#架构层次概览" class="headerlink" title="架构层次概览"></a>架构层次概览</h2><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                         应用层                               │</span><br><span class="line">│   ┌───────────┐  ┌───────────────┐  ┌─────────┐            │</span><br><span class="line">│   │ 命令行工具 │  │  Web管理界面   │  │ HTTP API│            │</span><br><span class="line">│   └───────────┘  └───────────────┘  └─────────┘            │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                         协议层                               │</span><br><span class="line">│   ┌──────────┐  ┌──────┐  ┌───────┐  ┌────────────────┐   │</span><br><span class="line">│   │AMQP 0<span class="string">-9</span><span class="string">-1</span>│  │ MQTT │  │ STOMP │  │ Stream Protocol│   │</span><br><span class="line">│   │  /1.0    │  │      │  │       │  │                │   │</span><br><span class="line">│   └──────────┘  └──────┘  └───────┘  └────────────────┘   │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                         核心层                               │</span><br><span class="line">│   ┌────────────────┐  ┌───────────────┐  ┌────────────┐   │</span><br><span class="line">│   │ rabbit-核心服务器│  │rabbit_common  │  │amqp_client │   │</span><br><span class="line">│   │                │  │   共享库      │  │   客户端   │   │</span><br><span class="line">│   └────────────────┘  └───────────────┘  └────────────┘   │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                         存储层                               │</span><br><span class="line">│   ┌────────────────┐  ┌───────────────┐  ┌────────────┐   │</span><br><span class="line">│   │ ra-Raft一致性  │  │osiris-日志存储 │  │khepri-树形 │   │</span><br><span class="line">│   │                │  │               │  │  数据库    │   │</span><br><span class="line">│   └────────────────┘  └───────────────┘  └────────────┘   │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                         网络层                               │</span><br><span class="line">│   ┌────────────────┐  ┌───────────────┐  ┌────────────┐   │</span><br><span class="line">│   │cowboy-HTTP服务器│  │ ranch-连接池  │  │gun-HTTP客户端│  │</span><br><span class="line">│   └────────────────┘  └───────────────┘  └────────────┘   │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                       基础设施层                             │</span><br><span class="line">│   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │</span><br><span class="line">│   │ 认证授权 │  │ 监控指标 │  │ 集群发现 │  │  工具库  │ │</span><br><span class="line">│   └──────────┘  └──────────┘  └──────────┘  └──────────┘ │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="核心架构模块"><a href="#核心架构模块" class="headerlink" title="核心架构模块"></a>核心架构模块</h2><h3 id="1-rabbit-RabbitMQ-核心服务器"><a href="#1-rabbit-RabbitMQ-核心服务器" class="headerlink" title="1. rabbit - RabbitMQ 核心服务器"></a>1. rabbit - RabbitMQ 核心服务器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbit/</code></li>
<li><strong>主要功能</strong>: <ul>
<li>AMQP 0-9-1, AMQP 1.0, MQTT, STOMP 协议支持</li>
<li>队列管理、交换器路由、权限控制</li>
<li>集群管理、持久化存储、系统监控</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit.erl                    <span class="comment">% 主应用模块</span></span><br><span class="line">src/rabbit_amqqueue.erl          <span class="comment">% 队列管理 (82KB)</span></span><br><span class="line">src/rabbit_exchange.erl          <span class="comment">% 交换器管理</span></span><br><span class="line">src/rabbit_channel.erl           <span class="comment">% 通道管理 (119KB)</span></span><br><span class="line">src/rabbit_reader.erl            <span class="comment">% 协议读取器</span></span><br><span class="line">src/rabbit_networking.erl        <span class="comment">% 网络管理</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 作为整个系统的核心，协调所有其他模块</li>
<li><strong>依赖关系</strong>: 依赖 <code>rabbit_common</code>、<code>ra</code>、<code>osiris</code>、<code>khepri</code> 等核心库</li>
</ul>
<h3 id="2-rabbit-common-共享通用库"><a href="#2-rabbit-common-共享通用库" class="headerlink" title="2. rabbit_common - 共享通用库"></a>2. rabbit_common - 共享通用库</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbit_common/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>AMQP 协议解析和生成</li>
<li>通用数据结构和工具函数</li>
<li>认证和授权基础设施</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit_framing.erl           <span class="comment">% AMQP 帧处理</span></span><br><span class="line">src/rabbit_binary_parser.erl    <span class="comment">% 二进制协议解析</span></span><br><span class="line">src/rabbit_misc.erl              <span class="comment">% 通用工具函数</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 被 <code>rabbit</code> 和 <code>amqp_client</code> 共同使用</li>
<li><strong>依赖关系</strong>: 基础库，被多个模块依赖</li>
</ul>
<h3 id="3-amqp-client-AMQP-客户端库"><a href="#3-amqp-client-AMQP-客户端库" class="headerlink" title="3. amqp_client - AMQP 客户端库"></a>3. amqp_client - AMQP 客户端库</h3><ul>
<li><strong>模块路径</strong>: <code>deps/amqp_client/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>提供连接和通道管理</li>
<li>支持直连和网络连接</li>
<li>RPC 客户端和服务器实现</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">src/amqp_connection.erl          <span class="comment">% 连接管理</span></span><br><span class="line">src/amqp_channel.erl             <span class="comment">% 通道管理</span></span><br><span class="line">src/amqp_direct_connection.erl   <span class="comment">% 直连实现</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 用于内部组件间通信和外部客户端连接</li>
<li><strong>依赖关系</strong>: 依赖 <code>rabbit_common</code></li>
</ul>
<hr>
<h2 id="分布式存储和一致性模块"><a href="#分布式存储和一致性模块" class="headerlink" title="分布式存储和一致性模块"></a>分布式存储和一致性模块</h2><h3 id="4-ra-Raft-一致性算法实现"><a href="#4-ra-Raft-一致性算法实现" class="headerlink" title="4. ra - Raft 一致性算法实现"></a>4. ra - Raft 一致性算法实现</h3><ul>
<li><strong>模块路径</strong>: <code>deps/ra/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>领导者选举、日志复制</li>
<li>集群成员变更、日志压缩</li>
<li>快照安装和恢复</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">src/ra.erl                       <span class="comment">% 主 API 模块</span></span><br><span class="line">src/ra_server.erl                <span class="comment">% Raft 服务器 (3,348 行)</span></span><br><span class="line">src/ra_machine.erl               <span class="comment">% 状态机行为定义</span></span><br><span class="line">src/ra_log.erl                   <span class="comment">% 日志管理</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 为仲裁队列和流提供一致性保证</li>
<li><strong>依赖关系</strong>: 依赖 <code>aten</code>、<code>gen_batch_server</code>、<code>seshat</code></li>
<li><strong>性能特点</strong>: 高吞吐量、低延迟的一致性保证</li>
</ul>
<h3 id="5-osiris-日志流存储基础"><a href="#5-osiris-日志流存储基础" class="headerlink" title="5. osiris - 日志流存储基础"></a>5. osiris - 日志流存储基础</h3><ul>
<li><strong>模块路径</strong>: <code>deps/osiris/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>高性能日志存储</li>
<li>支持流式数据处理</li>
<li>为 RabbitMQ 流功能提供底层支持</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">src/osiris_log.erl               <span class="comment">% 日志管理 (3,243 行)</span></span><br><span class="line">src/osiris_writer.erl            <span class="comment">% 日志写入器</span></span><br><span class="line">src/osiris_reader.erl            <span class="comment">% 日志读取器</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 被 <code>rabbitmq_stream</code> 使用</li>
<li><strong>依赖关系</strong>: 依赖 <code>gen_batch_server</code>、<code>seshat</code></li>
</ul>
<h3 id="6-khepri-树形复制数据库"><a href="#6-khepri-树形复制数据库" class="headerlink" title="6. khepri - 树形复制数据库"></a>6. khepri - 树形复制数据库</h3><ul>
<li><strong>模块路径</strong>: <code>deps/khepri/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>树形数据结构存储</li>
<li>基于 Ra 的一致性保证</li>
<li>事务支持和触发器</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">src/khepri.erl                   <span class="comment">% 主 API (3,839 行)</span></span><br><span class="line">src/khepri_machine.erl           <span class="comment">% Ra 状态机实现</span></span><br><span class="line">src/khepri_tx.erl                <span class="comment">% 事务处理</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 作为 RabbitMQ 元数据存储的现代化替代方案</li>
<li><strong>依赖关系</strong>: 依赖 <code>ra</code>、<code>horus</code></li>
</ul>
<h3 id="7-khepri-mnesia-migration-数据库迁移工具"><a href="#7-khepri-mnesia-migration-数据库迁移工具" class="headerlink" title="7. khepri_mnesia_migration - 数据库迁移工具"></a>7. khepri_mnesia_migration - 数据库迁移工具</h3><ul>
<li><strong>模块路径</strong>: <code>deps/khepri_mnesia_migration/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>集群成员同步</li>
<li>Mnesia 表到 Khepri 的数据迁移</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 帮助 RabbitMQ 从传统存储迁移到现代存储</li>
</ul>
<hr>
<h2 id="协议支持模块"><a href="#协议支持模块" class="headerlink" title="协议支持模块"></a>协议支持模块</h2><h3 id="8-rabbitmq-mqtt-MQTT-协议支持"><a href="#8-rabbitmq-mqtt-MQTT-协议支持" class="headerlink" title="8. rabbitmq_mqtt - MQTT 协议支持"></a>8. rabbitmq_mqtt - MQTT 协议支持</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_mqtt/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>MQTT 3.1.1 协议支持</li>
<li>消息发布&#x2F;订阅、会话管理</li>
<li>保留消息、QoS 级别支持</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit_mqtt_reader.erl       <span class="comment">% MQTT 协议读取器</span></span><br><span class="line">src/rabbit_mqtt_processor.erl    <span class="comment">% 消息处理器</span></span><br><span class="line">src/rabbit_mqtt_retained_msg_store.erl <span class="comment">% 保留消息存储</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 作为协议适配器，将 MQTT 消息转换为 AMQP</li>
<li><strong>默认端口</strong>: 1883 (TCP), 8883 (TLS)</li>
</ul>
<h3 id="9-rabbitmq-stomp-STOMP-协议支持"><a href="#9-rabbitmq-stomp-STOMP-协议支持" class="headerlink" title="9. rabbitmq_stomp - STOMP 协议支持"></a>9. rabbitmq_stomp - STOMP 协议支持</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_stomp/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>STOMP 1.0-1.2 协议支持</li>
<li>简单文本消息协议</li>
<li>支持多种客户端语言</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit_stomp_reader.erl      <span class="comment">% STOMP 协议读取器</span></span><br><span class="line">src/rabbit_stomp_processor.erl   <span class="comment">% 消息处理器</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 协议适配器，转换 STOMP 到 AMQP</li>
<li><strong>默认端口</strong>: 61613 (TCP), 61614 (TLS)</li>
</ul>
<h3 id="10-rabbitmq-stream-流协议支持"><a href="#10-rabbitmq-stream-流协议支持" class="headerlink" title="10. rabbitmq_stream - 流协议支持"></a>10. rabbitmq_stream - 流协议支持</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_stream/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>RabbitMQ 流的自定义二进制协议</li>
<li>高性能流式数据处理</li>
<li>追加式 FIFO 结构</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit_stream_reader.erl     <span class="comment">% 流协议读取器 (3,992 行)</span></span><br><span class="line">src/rabbit_stream_coordinator.erl <span class="comment">% 流协调器</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 基于 <code>osiris</code> 提供流功能</li>
<li><strong>依赖关系</strong>: 依赖 <code>rabbitmq_stream_common</code>、<code>osiris</code></li>
<li><strong>默认端口</strong>: 5552</li>
</ul>
<h3 id="11-amqp10-client-和-amqp10-common-AMQP-1-0-支持"><a href="#11-amqp10-client-和-amqp10-common-AMQP-1-0-支持" class="headerlink" title="11. amqp10_client 和 amqp10_common - AMQP 1.0 支持"></a>11. amqp10_client 和 amqp10_common - AMQP 1.0 支持</h3><ul>
<li><strong>模块路径</strong>: <code>deps/amqp10_client/</code>, <code>deps/amqp10_common/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>AMQP 1.0 协议实现</li>
<li>与 AMQP 0-9-1 的互操作性</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展 RabbitMQ 的协议支持范围</li>
</ul>
<hr>
<h2 id="管理和监控模块"><a href="#管理和监控模块" class="headerlink" title="管理和监控模块"></a>管理和监控模块</h2><h3 id="12-rabbitmq-management-管理控制台"><a href="#12-rabbitmq-management-管理控制台" class="headerlink" title="12. rabbitmq_management - 管理控制台"></a>12. rabbitmq_management - 管理控制台</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_management/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Web UI 管理界面</li>
<li>REST API 接口</li>
<li>统计信息展示、用户管理</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit_mgmt_wm_*.erl         <span class="comment">% Web 管理端点</span></span><br><span class="line">priv/www/                        <span class="comment">% Web 静态文件</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 通过 <code>rabbitmq_management_agent</code> 获取数据</li>
<li><strong>依赖关系</strong>: 依赖 <code>cowboy</code>、<code>rabbitmq_web_dispatch</code></li>
<li><strong>默认端口</strong>: 15672</li>
</ul>
<h3 id="13-rabbitmq-management-agent-管理代理"><a href="#13-rabbitmq-management-agent-管理代理" class="headerlink" title="13. rabbitmq_management_agent - 管理代理"></a>13. rabbitmq_management_agent - 管理代理</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_management_agent/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>统计数据收集</li>
<li>性能指标聚合</li>
<li>为管理界面提供数据源</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 从 <code>rabbit</code> 核心收集数据，提供给管理界面</li>
</ul>
<h3 id="14-rabbitmq-prometheus-Prometheus-监控"><a href="#14-rabbitmq-prometheus-Prometheus-监控" class="headerlink" title="14. rabbitmq_prometheus - Prometheus 监控"></a>14. rabbitmq_prometheus - Prometheus 监控</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_prometheus/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>导出 RabbitMQ 指标到 Prometheus</li>
<li>支持聚合和详细指标</li>
<li>可配置的指标端点</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/prometheus_rabbitmq_core_metrics_collector.erl <span class="comment">% 核心指标收集器</span></span><br></pre></td></tr></table></figure></li>
<li><strong>默认端口</strong>: 15692</li>
<li><strong>端点</strong>: <code>/metrics</code>, <code>/metrics/per-object</code>, <code>/metrics/detailed</code></li>
</ul>
<h3 id="15-rabbitmq-cli-命令行工具"><a href="#15-rabbitmq-cli-命令行工具" class="headerlink" title="15. rabbitmq_cli - 命令行工具"></a>15. rabbitmq_cli - 命令行工具</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_cli/</code></li>
<li><strong>主要功能</strong>:<ul>
<li><code>rabbitmqctl</code> - 主要管理工具</li>
<li><code>rabbitmq-plugins</code> - 插件管理</li>
<li><code>rabbitmq-diagnostics</code> - 诊断工具</li>
<li><code>rabbitmq-queues</code> - 队列管理</li>
<li><code>rabbitmq-streams</code> - 流管理</li>
</ul>
</li>
<li><strong>实现语言</strong>: Elixir</li>
<li><strong>与核心交互</strong>: 通过管理 API 与 RabbitMQ 通信</li>
</ul>
<h3 id="16-rabbitmq-top-进程监控"><a href="#16-rabbitmq-top-进程监控" class="headerlink" title="16. rabbitmq_top - 进程监控"></a>16. rabbitmq_top - 进程监控</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_top/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>类似 Unix top 的进程监控工具</li>
<li>实时进程监控、资源使用统计</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 监控 RabbitMQ 内部进程</li>
</ul>
<hr>
<h2 id="认证和授权模块"><a href="#认证和授权模块" class="headerlink" title="认证和授权模块"></a>认证和授权模块</h2><h3 id="17-rabbitmq-auth-backend-oauth2-OAuth2-认证"><a href="#17-rabbitmq-auth-backend-oauth2-OAuth2-认证" class="headerlink" title="17. rabbitmq_auth_backend_oauth2 - OAuth2 认证"></a>17. rabbitmq_auth_backend_oauth2 - OAuth2 认证</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_auth_backend_oauth2/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>基于 JWT 令牌的 OAuth2 认证后端</li>
<li>支持多种身份提供商 (UAA、Keycloak、Azure AD、Auth0)</li>
<li>细粒度权限控制</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit_auth_backend_oauth2.erl <span class="comment">% 主认证后端</span></span><br><span class="line">src/uaa_jwt.erl                   <span class="comment">% JWT 处理</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 作为认证后端插件</li>
<li><strong>依赖关系</strong>: 依赖 <code>jose</code>、<code>oauth2_client</code></li>
</ul>
<h3 id="18-rabbitmq-auth-backend-http-HTTP-认证"><a href="#18-rabbitmq-auth-backend-http-HTTP-认证" class="headerlink" title="18. rabbitmq_auth_backend_http - HTTP 认证"></a>18. rabbitmq_auth_backend_http - HTTP 认证</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_auth_backend_http/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>通过 HTTP API 进行认证和授权</li>
<li>外部 HTTP 服务认证、动态权限查询</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 认证后端插件</li>
</ul>
<h3 id="19-rabbitmq-auth-backend-ldap-LDAP-认证"><a href="#19-rabbitmq-auth-backend-ldap-LDAP-认证" class="headerlink" title="19. rabbitmq_auth_backend_ldap - LDAP 认证"></a>19. rabbitmq_auth_backend_ldap - LDAP 认证</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_auth_backend_ldap/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>LDAP 目录服务认证</li>
<li>LDAP 用户认证、组权限映射</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 认证后端插件</li>
</ul>
<h3 id="20-rabbitmq-auth-backend-cache-认证缓存"><a href="#20-rabbitmq-auth-backend-cache-认证缓存" class="headerlink" title="20. rabbitmq_auth_backend_cache - 认证缓存"></a>20. rabbitmq_auth_backend_cache - 认证缓存</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_auth_backend_cache/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>缓存认证结果以提高性能</li>
<li>可配置的缓存策略</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 包装其他认证后端</li>
</ul>
<h3 id="21-rabbitmq-auth-mechanism-ssl-SSL-证书认证"><a href="#21-rabbitmq-auth-mechanism-ssl-SSL-证书认证" class="headerlink" title="21. rabbitmq_auth_mechanism_ssl - SSL 证书认证"></a>21. rabbitmq_auth_mechanism_ssl - SSL 证书认证</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_auth_mechanism_ssl/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>基于 SSL 客户端证书的认证</li>
<li>X.509 证书认证、证书字段映射</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 认证机制插件</li>
</ul>
<hr>
<h2 id="集群发现模块"><a href="#集群发现模块" class="headerlink" title="集群发现模块"></a>集群发现模块</h2><h3 id="22-rabbitmq-peer-discovery-aws-AWS-集群发现"><a href="#22-rabbitmq-peer-discovery-aws-AWS-集群发现" class="headerlink" title="22. rabbitmq_peer_discovery_aws - AWS 集群发现"></a>22. rabbitmq_peer_discovery_aws - AWS 集群发现</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_peer_discovery_aws/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>在 AWS 环境中自动发现集群节点</li>
<li>EC2 实例发现、基于标签的节点识别</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 集群发现插件</li>
<li><strong>依赖关系</strong>: 依赖 <code>rabbitmq_aws</code>、<code>rabbitmq_peer_discovery_common</code></li>
</ul>
<h3 id="23-rabbitmq-peer-discovery-k8s-Kubernetes-集群发现"><a href="#23-rabbitmq-peer-discovery-k8s-Kubernetes-集群发现" class="headerlink" title="23. rabbitmq_peer_discovery_k8s - Kubernetes 集群发现"></a>23. rabbitmq_peer_discovery_k8s - Kubernetes 集群发现</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_peer_discovery_k8s/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>在 Kubernetes 环境中发现集群节点</li>
<li>K8s API 集成、服务发现</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 集群发现插件</li>
</ul>
<h3 id="24-rabbitmq-peer-discovery-consul-Consul-集群发现"><a href="#24-rabbitmq-peer-discovery-consul-Consul-集群发现" class="headerlink" title="24. rabbitmq_peer_discovery_consul - Consul 集群发现"></a>24. rabbitmq_peer_discovery_consul - Consul 集群发现</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_peer_discovery_consul/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>使用 Consul 进行服务发现</li>
<li>Consul API 集成、健康检查</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 集群发现插件</li>
</ul>
<h3 id="25-rabbitmq-peer-discovery-etcd-etcd-集群发现"><a href="#25-rabbitmq-peer-discovery-etcd-etcd-集群发现" class="headerlink" title="25. rabbitmq_peer_discovery_etcd - etcd 集群发现"></a>25. rabbitmq_peer_discovery_etcd - etcd 集群发现</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_peer_discovery_etcd/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>使用 etcd 进行集群发现</li>
<li>etcd 键值存储集成、分布式配置</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 集群发现插件</li>
<li><strong>依赖关系</strong>: 依赖 <code>eetcd</code></li>
</ul>
<h3 id="26-rabbitmq-peer-discovery-common-集群发现通用库"><a href="#26-rabbitmq-peer-discovery-common-集群发现通用库" class="headerlink" title="26. rabbitmq_peer_discovery_common - 集群发现通用库"></a>26. rabbitmq_peer_discovery_common - 集群发现通用库</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_peer_discovery_common/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>为各种集群发现机制提供通用功能</li>
<li>通用发现逻辑、配置管理</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 被其他发现插件使用</li>
</ul>
<hr>
<h2 id="交换器插件"><a href="#交换器插件" class="headerlink" title="交换器插件"></a>交换器插件</h2><h3 id="27-rabbitmq-consistent-hash-exchange-一致性哈希交换器"><a href="#27-rabbitmq-consistent-hash-exchange-一致性哈希交换器" class="headerlink" title="27. rabbitmq_consistent_hash_exchange - 一致性哈希交换器"></a>27. rabbitmq_consistent_hash_exchange - 一致性哈希交换器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_consistent_hash_exchange/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>基于一致性哈希的消息路由</li>
<li>一致性哈希算法、负载均衡、节点故障容错</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 自定义交换器类型</li>
</ul>
<h3 id="28-rabbitmq-random-exchange-随机交换器"><a href="#28-rabbitmq-random-exchange-随机交换器" class="headerlink" title="28. rabbitmq_random_exchange - 随机交换器"></a>28. rabbitmq_random_exchange - 随机交换器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_random_exchange/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>随机选择队列进行消息路由</li>
<li>随机负载均衡、简单路由策略</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 自定义交换器类型</li>
</ul>
<h3 id="29-rabbitmq-recent-history-exchange-历史消息交换器"><a href="#29-rabbitmq-recent-history-exchange-历史消息交换器" class="headerlink" title="29. rabbitmq_recent_history_exchange - 历史消息交换器"></a>29. rabbitmq_recent_history_exchange - 历史消息交换器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_recent_history_exchange/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>保留最近消息历史的交换器</li>
<li>消息历史缓存、新订阅者可获取历史消息</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 自定义交换器类型</li>
</ul>
<h3 id="30-rabbitmq-event-exchange-事件交换器"><a href="#30-rabbitmq-event-exchange-事件交换器" class="headerlink" title="30. rabbitmq_event_exchange - 事件交换器"></a>30. rabbitmq_event_exchange - 事件交换器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_event_exchange/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>发布 RabbitMQ 内部事件</li>
<li>系统事件发布、监控和审计支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 发布内部事件到 AMQP</li>
</ul>
<h3 id="31-rabbitmq-jms-topic-exchange-JMS-主题交换器"><a href="#31-rabbitmq-jms-topic-exchange-JMS-主题交换器" class="headerlink" title="31. rabbitmq_jms_topic_exchange - JMS 主题交换器"></a>31. rabbitmq_jms_topic_exchange - JMS 主题交换器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_jms_topic_exchange/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>支持 JMS 风格的主题路由</li>
<li>JMS 主题语义、层次化主题结构</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 自定义交换器类型</li>
</ul>
<hr>
<h2 id="联邦和复制模块"><a href="#联邦和复制模块" class="headerlink" title="联邦和复制模块"></a>联邦和复制模块</h2><h3 id="32-rabbitmq-federation-联邦"><a href="#32-rabbitmq-federation-联邦" class="headerlink" title="32. rabbitmq_federation - 联邦"></a>32. rabbitmq_federation - 联邦</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_federation/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>跨 WAN 的松耦合分布式 RabbitMQ 设置</li>
<li>交换器和队列联邦、跨集群消息复制</li>
<li>WAN 友好的设计</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit_federation_link.erl   <span class="comment">% 联邦链接</span></span><br><span class="line">src/rabbit_federation_exchange.erl <span class="comment">% 联邦交换器</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 创建联邦链接和复制策略</li>
<li><strong>依赖关系</strong>: 依赖 <code>amqp_client</code></li>
</ul>
<h3 id="33-rabbitmq-federation-management-联邦管理"><a href="#33-rabbitmq-federation-management-联邦管理" class="headerlink" title="33. rabbitmq_federation_management - 联邦管理"></a>33. rabbitmq_federation_management - 联邦管理</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_federation_management/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>联邦功能的管理界面扩展</li>
<li>联邦状态监控、联邦配置管理</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展管理界面</li>
</ul>
<h3 id="34-rabbitmq-federation-prometheus-联邦监控"><a href="#34-rabbitmq-federation-prometheus-联邦监控" class="headerlink" title="34. rabbitmq_federation_prometheus - 联邦监控"></a>34. rabbitmq_federation_prometheus - 联邦监控</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_federation_prometheus/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>联邦相关的 Prometheus 指标</li>
<li>联邦链接状态指标、复制性能指标</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展 Prometheus 导出器</li>
</ul>
<h3 id="35-rabbitmq-shovel-铲子"><a href="#35-rabbitmq-shovel-铲子" class="headerlink" title="35. rabbitmq_shovel - 铲子"></a>35. rabbitmq_shovel - 铲子</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_shovel/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>WAN 友好的消息移动工具</li>
<li>队列到交换器的消息传输</li>
<li>支持不同 RabbitMQ 节点间传输</li>
<li>动态和静态铲子配置</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit_shovel_worker.erl     <span class="comment">% 铲子工作进程</span></span><br><span class="line">src/rabbit_shovel_dyn_worker_sup.erl <span class="comment">% 动态工作进程监督器</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 作为消息传输工具</li>
<li><strong>依赖关系</strong>: 依赖 <code>amqp_client</code></li>
</ul>
<h3 id="36-rabbitmq-shovel-management-铲子管理"><a href="#36-rabbitmq-shovel-management-铲子管理" class="headerlink" title="36. rabbitmq_shovel_management - 铲子管理"></a>36. rabbitmq_shovel_management - 铲子管理</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_shovel_management/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>铲子功能的管理界面</li>
<li>铲子状态监控、动态铲子管理</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展管理界面</li>
</ul>
<h3 id="37-rabbitmq-shovel-prometheus-铲子监控"><a href="#37-rabbitmq-shovel-prometheus-铲子监控" class="headerlink" title="37. rabbitmq_shovel_prometheus - 铲子监控"></a>37. rabbitmq_shovel_prometheus - 铲子监控</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_shovel_prometheus/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>铲子相关的 Prometheus 指标</li>
<li>铲子传输指标、性能监控</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展 Prometheus 导出器</li>
</ul>
<hr>
<h2 id="Web-和网络模块"><a href="#Web-和网络模块" class="headerlink" title="Web 和网络模块"></a>Web 和网络模块</h2><h3 id="38-rabbitmq-web-dispatch-Web-分发器"><a href="#38-rabbitmq-web-dispatch-Web-分发器" class="headerlink" title="38. rabbitmq_web_dispatch - Web 分发器"></a>38. rabbitmq_web_dispatch - Web 分发器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_web_dispatch/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>HTTP 请求路由和分发</li>
<li>插件 Web 接口注册</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 为管理界面和其他 Web 插件提供基础</li>
<li><strong>依赖关系</strong>: 依赖 <code>cowboy</code>、<code>ranch</code></li>
</ul>
<h3 id="39-rabbitmq-web-mqtt-Web-MQTT"><a href="#39-rabbitmq-web-mqtt-Web-MQTT" class="headerlink" title="39. rabbitmq_web_mqtt - Web MQTT"></a>39. rabbitmq_web_mqtt - Web MQTT</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_web_mqtt/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>通过 WebSocket 提供 MQTT 支持</li>
<li>WebSocket 到 MQTT 桥接、浏览器 MQTT 客户端支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展 MQTT 协议到 Web</li>
<li><strong>依赖关系</strong>: 依赖 <code>rabbitmq_mqtt</code></li>
<li><strong>默认端口</strong>: 15675</li>
</ul>
<h3 id="40-rabbitmq-web-mqtt-examples-Web-MQTT-示例"><a href="#40-rabbitmq-web-mqtt-examples-Web-MQTT-示例" class="headerlink" title="40. rabbitmq_web_mqtt_examples - Web MQTT 示例"></a>40. rabbitmq_web_mqtt_examples - Web MQTT 示例</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_web_mqtt_examples/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Web MQTT 功能的示例代码</li>
<li>示例 HTML 页面、JavaScript 客户端示例</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供使用示例</li>
</ul>
<h3 id="41-rabbitmq-web-stomp-Web-STOMP"><a href="#41-rabbitmq-web-stomp-Web-STOMP" class="headerlink" title="41. rabbitmq_web_stomp - Web STOMP"></a>41. rabbitmq_web_stomp - Web STOMP</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_web_stomp/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>通过 WebSocket 提供 STOMP 支持</li>
<li>WebSocket 到 STOMP 桥接、浏览器 STOMP 客户端支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展 STOMP 协议到 Web</li>
<li><strong>依赖关系</strong>: 依赖 <code>rabbitmq_stomp</code></li>
<li><strong>默认端口</strong>: 15674</li>
</ul>
<h3 id="42-rabbitmq-web-stomp-examples-Web-STOMP-示例"><a href="#42-rabbitmq-web-stomp-examples-Web-STOMP-示例" class="headerlink" title="42. rabbitmq_web_stomp_examples - Web STOMP 示例"></a>42. rabbitmq_web_stomp_examples - Web STOMP 示例</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_web_stomp_examples/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Web STOMP 功能的示例代码</li>
<li>示例 HTML 页面、JavaScript 客户端示例</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供使用示例</li>
</ul>
<hr>
<h2 id="HTTP-和网络基础库"><a href="#HTTP-和网络基础库" class="headerlink" title="HTTP 和网络基础库"></a>HTTP 和网络基础库</h2><h3 id="43-cowboy-HTTP-服务器"><a href="#43-cowboy-HTTP-服务器" class="headerlink" title="43. cowboy - HTTP 服务器"></a>43. cowboy - HTTP 服务器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/cowboy/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>小型、快速、现代的 HTTP 服务器</li>
<li>HTTP&#x2F;1.1 和 HTTP&#x2F;2 支持</li>
<li>WebSocket 支持、路由和处理器</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src/cowboy_http.erl              <span class="comment">% HTTP 协议处理</span></span><br><span class="line">src/cowboy_websocket.erl         <span class="comment">% WebSocket 处理</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 为管理界面和 Web 插件提供 HTTP 服务</li>
<li><strong>依赖关系</strong>: 依赖 <code>cowlib</code>、<code>ranch</code></li>
</ul>
<h3 id="44-cowlib-Cowboy-支持库"><a href="#44-cowlib-Cowboy-支持库" class="headerlink" title="44. cowlib - Cowboy 支持库"></a>44. cowlib - Cowboy 支持库</h3><ul>
<li><strong>模块路径</strong>: <code>deps/cowlib/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Cowboy HTTP 服务器的支持库</li>
<li>HTTP 协议解析、通用 HTTP 工具</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/cow_http_hd.erl              <span class="comment">% HTTP 头处理 (3,642 行)</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 被 <code>cowboy</code> 使用</li>
</ul>
<h3 id="45-ranch-Socket-接受器池"><a href="#45-ranch-Socket-接受器池" class="headerlink" title="45. ranch - Socket 接受器池"></a>45. ranch - Socket 接受器池</h3><ul>
<li><strong>模块路径</strong>: <code>deps/ranch/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>TCP 协议的 socket 接受器池</li>
<li>连接池管理、并发连接限制、传输层抽象</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 为所有网络连接提供基础设施</li>
<li><strong>依赖关系</strong>: 被 <code>cowboy</code>、<code>rabbit</code> 等使用</li>
</ul>
<h3 id="46-gun-HTTP-客户端"><a href="#46-gun-HTTP-客户端" class="headerlink" title="46. gun - HTTP 客户端"></a>46. gun - HTTP 客户端</h3><ul>
<li><strong>模块路径</strong>: <code>deps/gun/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>HTTP&#x2F;1.1、HTTP&#x2F;2 和 WebSocket 客户端</li>
<li>持久连接、多协议支持、自动重连</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 用于外部 HTTP 通信</li>
</ul>
<hr>
<h2 id="安全和加密模块"><a href="#安全和加密模块" class="headerlink" title="安全和加密模块"></a>安全和加密模块</h2><h3 id="47-rabbitmq-trust-store-信任存储"><a href="#47-rabbitmq-trust-store-信任存储" class="headerlink" title="47. rabbitmq_trust_store - 信任存储"></a>47. rabbitmq_trust_store - 信任存储</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_trust_store/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>动态 SSL 证书信任存储管理</li>
<li>证书验证、动态证书更新、证书撤销列表支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 增强 SSL 安全性</li>
</ul>
<h3 id="48-credentials-obfuscation-凭据混淆"><a href="#48-credentials-obfuscation-凭据混淆" class="headerlink" title="48. credentials_obfuscation - 凭据混淆"></a>48. credentials_obfuscation - 凭据混淆</h3><ul>
<li><strong>模块路径</strong>: <code>deps/credentials_obfuscation/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>敏感信息加密和混淆</li>
<li>密码加密存储、配置文件敏感信息保护</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 保护配置中的敏感信息</li>
</ul>
<h3 id="49-jose-JSON-Web-签名-加密"><a href="#49-jose-JSON-Web-签名-加密" class="headerlink" title="49. jose - JSON Web 签名&#x2F;加密"></a>49. jose - JSON Web 签名&#x2F;加密</h3><ul>
<li><strong>模块路径</strong>: <code>deps/jose/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>JWT、JWS、JWE、JWK、JWA 实现</li>
<li>JWT 令牌处理、数字签名验证、加密解密</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">src/jose_jwt.erl                 <span class="comment">% JWT 处理</span></span><br><span class="line">src/jose_jws.erl                 <span class="comment">% JWS 签名</span></span><br><span class="line">src/jose_jwe.erl                 <span class="comment">% JWE 加密</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 被 OAuth2 认证后端使用</li>
<li><strong>依赖关系</strong>: 被 <code>rabbitmq_auth_backend_oauth2</code> 使用</li>
</ul>
<h3 id="50-base64url-Base64URL-编码"><a href="#50-base64url-Base64URL-编码" class="headerlink" title="50. base64url - Base64URL 编码"></a>50. base64url - Base64URL 编码</h3><ul>
<li><strong>模块路径</strong>: <code>deps/base64url/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Base64URL 编码&#x2F;解码</li>
<li>URL 安全的 Base64 编码、JWT 令牌编码支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 支持 JWT 处理</li>
</ul>
<hr>
<h2 id="工具和实用程序模块"><a href="#工具和实用程序模块" class="headerlink" title="工具和实用程序模块"></a>工具和实用程序模块</h2><h3 id="51-cuttlefish-配置管理"><a href="#51-cuttlefish-配置管理" class="headerlink" title="51. cuttlefish - 配置管理"></a>51. cuttlefish - 配置管理</h3><ul>
<li><strong>模块路径</strong>: <code>deps/cuttlefish/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>配置文件格式转换和管理</li>
<li><code>.conf</code> 到 <code>app.config</code> 转换</li>
<li>配置验证和模式定义、用户友好的配置语法</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src/cuttlefish.erl               <span class="comment">% 主配置处理</span></span><br><span class="line">src/cuttlefish_schema.erl        <span class="comment">% 配置模式</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 处理 RabbitMQ 配置文件</li>
</ul>
<h3 id="52-rabbitmq-codegen-代码生成器"><a href="#52-rabbitmq-codegen-代码生成器" class="headerlink" title="52. rabbitmq_codegen - 代码生成器"></a>52. rabbitmq_codegen - 代码生成器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_codegen/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>从 AMQP 规范生成协议处理代码</li>
<li>AMQP 协议代码生成、支持协议扩展</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 构建时生成协议处理代码</li>
</ul>
<h3 id="53-recon-生产诊断工具"><a href="#53-recon-生产诊断工具" class="headerlink" title="53. recon - 生产诊断工具"></a>53. recon - 生产诊断工具</h3><ul>
<li><strong>模块路径</strong>: <code>deps/recon/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>生产环境安全的 Erlang 诊断工具</li>
<li>进程监控、内存分析、性能诊断</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供运行时诊断能力</li>
</ul>
<h3 id="54-redbug-调试工具"><a href="#54-redbug-调试工具" class="headerlink" title="54. redbug - 调试工具"></a>54. redbug - 调试工具</h3><ul>
<li><strong>模块路径</strong>: <code>deps/redbug/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>生产环境安全的调试和跟踪工具</li>
<li>函数调用跟踪、性能分析、调试信息收集</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/redbug_parser.erl            <span class="comment">% 跟踪解析器 (3,184 行)</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 提供调试能力</li>
</ul>
<h3 id="55-observer-cli-命令行观察器"><a href="#55-observer-cli-命令行观察器" class="headerlink" title="55. observer_cli - 命令行观察器"></a>55. observer_cli - 命令行观察器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/observer_cli/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>命令行版本的 Observer 工具</li>
<li>实时系统监控、进程和内存统计、网络和磁盘监控</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 监控 RabbitMQ 运行状态</li>
</ul>
<hr>
<h2 id="流处理相关模块"><a href="#流处理相关模块" class="headerlink" title="流处理相关模块"></a>流处理相关模块</h2><h3 id="56-rabbitmq-stream-common-流通用库"><a href="#56-rabbitmq-stream-common-流通用库" class="headerlink" title="56. rabbitmq_stream_common - 流通用库"></a>56. rabbitmq_stream_common - 流通用库</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_stream_common/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>流功能的通用组件</li>
<li>流协议通用定义、共享数据结构</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 被流相关模块使用</li>
</ul>
<h3 id="57-rabbitmq-stream-management-流管理"><a href="#57-rabbitmq-stream-management-流管理" class="headerlink" title="57. rabbitmq_stream_management - 流管理"></a>57. rabbitmq_stream_management - 流管理</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_stream_management/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>流功能的管理界面扩展</li>
<li>流状态监控、流配置管理</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展管理界面</li>
</ul>
<h3 id="58-seshat-日志管理"><a href="#58-seshat-日志管理" class="headerlink" title="58. seshat - 日志管理"></a>58. seshat - 日志管理</h3><ul>
<li><strong>模块路径</strong>: <code>deps/seshat/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>高性能日志管理库</li>
<li>日志索引和查询、高效日志存储</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 被 <code>ra</code> 和 <code>osiris</code> 使用</li>
</ul>
<hr>
<h2 id="系统集成模块"><a href="#系统集成模块" class="headerlink" title="系统集成模块"></a>系统集成模块</h2><h3 id="59-rabbitmq-prelaunch-预启动处理"><a href="#59-rabbitmq-prelaunch-预启动处理" class="headerlink" title="59. rabbitmq_prelaunch - 预启动处理"></a>59. rabbitmq_prelaunch - 预启动处理</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_prelaunch/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>RabbitMQ 启动前的准备工作</li>
<li>环境检查、配置预处理、依赖验证</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 启动流程的一部分</li>
</ul>
<h3 id="60-systemd-Systemd-集成"><a href="#60-systemd-Systemd-集成" class="headerlink" title="60. systemd - Systemd 集成"></a>60. systemd - Systemd 集成</h3><ul>
<li><strong>模块路径</strong>: <code>deps/systemd/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>与 systemd 系统服务管理器集成</li>
<li>服务状态通知、系统集成支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供系统服务集成</li>
</ul>
<h3 id="61-syslog-系统日志"><a href="#61-syslog-系统日志" class="headerlink" title="61. syslog - 系统日志"></a>61. syslog - 系统日志</h3><ul>
<li><strong>模块路径</strong>: <code>deps/syslog/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>系统日志集成</li>
<li>syslog 协议支持、日志转发</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供日志输出选项</li>
</ul>
<h3 id="62-sysmon-handler-系统监控处理器"><a href="#62-sysmon-handler-系统监控处理器" class="headerlink" title="62. sysmon_handler - 系统监控处理器"></a>62. sysmon_handler - 系统监控处理器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/sysmon_handler/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>系统监控事件处理</li>
<li>系统事件监控、性能警报</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 监控系统健康状态</li>
</ul>
<hr>
<h2 id="数据处理和序列化模块"><a href="#数据处理和序列化模块" class="headerlink" title="数据处理和序列化模块"></a>数据处理和序列化模块</h2><h3 id="63-thoas-JSON-处理"><a href="#63-thoas-JSON-处理" class="headerlink" title="63. thoas - JSON 处理"></a>63. thoas - JSON 处理</h3><ul>
<li><strong>模块路径</strong>: <code>deps/thoas/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>高性能 JSON 编码&#x2F;解码</li>
<li>快速 JSON 处理、内存高效</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 处理 JSON 格式数据</li>
</ul>
<h3 id="64-json-JSON-库-Elixir"><a href="#64-json-JSON-库-Elixir" class="headerlink" title="64. json - JSON 库 (Elixir)"></a>64. json - JSON 库 (Elixir)</h3><ul>
<li><strong>模块路径</strong>: <code>deps/json/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Elixir JSON 处理库</li>
<li>JSON 编码解码、Elixir 数据结构支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 被 <code>rabbitmq_cli</code> 使用</li>
</ul>
<h3 id="65-csv-CSV-处理-Elixir"><a href="#65-csv-CSV-处理-Elixir" class="headerlink" title="65. csv - CSV 处理 (Elixir)"></a>65. csv - CSV 处理 (Elixir)</h3><ul>
<li><strong>模块路径</strong>: <code>deps/csv/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>CSV 文件处理</li>
<li>CSV 解析和生成、流式处理</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 数据导入导出支持</li>
</ul>
<hr>
<h2 id="监控和指标模块"><a href="#监控和指标模块" class="headerlink" title="监控和指标模块"></a>监控和指标模块</h2><h3 id="66-prometheus-Prometheus-客户端库"><a href="#66-prometheus-Prometheus-客户端库" class="headerlink" title="66. prometheus - Prometheus 客户端库"></a>66. prometheus - Prometheus 客户端库</h3><ul>
<li><strong>模块路径</strong>: <code>deps/prometheus/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Prometheus 指标收集库</li>
<li>指标定义和收集、多种指标类型支持</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/prometheus_model.erl         <span class="comment">% Prometheus 模型 (2,983 行)</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 被 <code>rabbitmq_prometheus</code> 使用</li>
</ul>
<h3 id="67-quantile-estimator-分位数估算"><a href="#67-quantile-estimator-分位数估算" class="headerlink" title="67. quantile_estimator - 分位数估算"></a>67. quantile_estimator - 分位数估算</h3><ul>
<li><strong>模块路径</strong>: <code>deps/quantile_estimator/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>高效的分位数计算</li>
<li>流式分位数估算、内存高效算法</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供性能指标计算</li>
</ul>
<h3 id="68-rabbitmq-tracing-消息跟踪"><a href="#68-rabbitmq-tracing-消息跟踪" class="headerlink" title="68. rabbitmq_tracing - 消息跟踪"></a>68. rabbitmq_tracing - 消息跟踪</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_tracing/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>消息流跟踪和调试</li>
<li>消息路径跟踪、调试信息收集</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供消息流可视化</li>
</ul>
<hr>
<h2 id="分片和负载均衡模块"><a href="#分片和负载均衡模块" class="headerlink" title="分片和负载均衡模块"></a>分片和负载均衡模块</h2><h3 id="69-rabbitmq-sharding-分片"><a href="#69-rabbitmq-sharding-分片" class="headerlink" title="69. rabbitmq_sharding - 分片"></a>69. rabbitmq_sharding - 分片</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_sharding/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>队列分片和负载分布</li>
<li>自动队列分片、负载均衡、水平扩展支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供队列分片策略</li>
</ul>
<hr>
<h2 id="辅助和支持模块"><a href="#辅助和支持模块" class="headerlink" title="辅助和支持模块"></a>辅助和支持模块</h2><h3 id="70-rabbitmq-aws-AWS-集成"><a href="#70-rabbitmq-aws-AWS-集成" class="headerlink" title="70. rabbitmq_aws - AWS 集成"></a>70. rabbitmq_aws - AWS 集成</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_aws/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>AWS 服务集成支持</li>
<li>AWS API 客户端、云服务集成</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 支持 AWS 环境部署</li>
</ul>
<h3 id="71-oauth2-client-OAuth2-客户端"><a href="#71-oauth2-client-OAuth2-客户端" class="headerlink" title="71. oauth2_client - OAuth2 客户端"></a>71. oauth2_client - OAuth2 客户端</h3><ul>
<li><strong>模块路径</strong>: <code>deps/oauth2_client/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>OAuth2 客户端实现</li>
<li>OAuth2 流程处理、令牌管理</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 支持 OAuth2 认证</li>
</ul>
<h3 id="72-accept-内容协商"><a href="#72-accept-内容协商" class="headerlink" title="72. accept - 内容协商"></a>72. accept - 内容协商</h3><ul>
<li><strong>模块路径</strong>: <code>deps/accept/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>HTTP 内容协商处理</li>
<li>Accept 头解析、内容类型协商</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 支持 HTTP API 内容协商</li>
</ul>
<h3 id="73-aten-故障检测"><a href="#73-aten-故障检测" class="headerlink" title="73. aten - 故障检测"></a>73. aten - 故障检测</h3><ul>
<li><strong>模块路径</strong>: <code>deps/aten/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>分布式故障检测</li>
<li>节点故障检测、网络分区检测</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 被 <code>ra</code> 使用进行故障检测</li>
</ul>
<h3 id="74-gen-batch-server-批处理服务器"><a href="#74-gen-batch-server-批处理服务器" class="headerlink" title="74. gen_batch_server - 批处理服务器"></a>74. gen_batch_server - 批处理服务器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/gen_batch_server/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>批量操作的通用服务器行为</li>
<li>批量请求处理、性能优化</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 被 <code>ra</code>、<code>osiris</code> 等使用</li>
</ul>
<h3 id="75-enough-资源限制"><a href="#75-enough-资源限制" class="headerlink" title="75. enough - 资源限制"></a>75. enough - 资源限制</h3><ul>
<li><strong>模块路径</strong>: <code>deps/enough/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>资源使用限制和监控</li>
<li>内存使用监控、资源限制执行</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供资源保护</li>
</ul>
<h3 id="76-getopt-命令行选项解析"><a href="#76-getopt-命令行选项解析" class="headerlink" title="76. getopt - 命令行选项解析"></a>76. getopt - 命令行选项解析</h3><ul>
<li><strong>模块路径</strong>: <code>deps/getopt/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>命令行参数解析</li>
<li>选项解析、帮助信息生成</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 被命令行工具使用</li>
</ul>
<h3 id="77-horus-函数序列化"><a href="#77-horus-函数序列化" class="headerlink" title="77. horus - 函数序列化"></a>77. horus - 函数序列化</h3><ul>
<li><strong>模块路径</strong>: <code>deps/horus/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Erlang 函数序列化和反序列化</li>
<li>函数持久化、跨节点函数传输</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/horus.erl                    <span class="comment">% 主模块 (3,043 行)</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 被 <code>khepri</code> 使用存储函数</li>
</ul>
<h3 id="78-stdout-formatter-标准输出格式化"><a href="#78-stdout-formatter-标准输出格式化" class="headerlink" title="78. stdout_formatter - 标准输出格式化"></a>78. stdout_formatter - 标准输出格式化</h3><ul>
<li><strong>模块路径</strong>: <code>deps/stdout_formatter/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>日志输出格式化</li>
<li>彩色输出、格式化日志</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供日志格式化</li>
</ul>
<hr>
<h2 id="测试和开发支持模块"><a href="#测试和开发支持模块" class="headerlink" title="测试和开发支持模块"></a>测试和开发支持模块</h2><h3 id="79-rabbitmq-ct-helpers-测试辅助工具"><a href="#79-rabbitmq-ct-helpers-测试辅助工具" class="headerlink" title="79. rabbitmq_ct_helpers - 测试辅助工具"></a>79. rabbitmq_ct_helpers - 测试辅助工具</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_ct_helpers/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Common Test 测试框架辅助</li>
<li>测试环境设置、测试工具函数</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 支持测试开发</li>
</ul>
<h3 id="80-rabbitmq-ct-client-helpers-客户端测试辅助"><a href="#80-rabbitmq-ct-client-helpers-客户端测试辅助" class="headerlink" title="80. rabbitmq_ct_client_helpers - 客户端测试辅助"></a>80. rabbitmq_ct_client_helpers - 客户端测试辅助</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_ct_client_helpers/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>客户端测试辅助工具</li>
<li>客户端测试支持、连接管理</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 支持客户端测试</li>
</ul>
<h3 id="81-elvis-mk-代码风格检查"><a href="#81-elvis-mk-代码风格检查" class="headerlink" title="81. elvis_mk - 代码风格检查"></a>81. elvis_mk - 代码风格检查</h3><ul>
<li><strong>模块路径</strong>: <code>deps/elvis_mk/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Erlang 代码风格检查工具</li>
<li>代码风格验证、质量检查</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 开发时代码质量保证</li>
</ul>
<hr>
<h2 id="特殊用途模块"><a href="#特殊用途模块" class="headerlink" title="特殊用途模块"></a>特殊用途模块</h2><h3 id="82-rabbitmq-amqp1-0-AMQP-1-0-桥接"><a href="#82-rabbitmq-amqp1-0-AMQP-1-0-桥接" class="headerlink" title="82. rabbitmq_amqp1_0 - AMQP 1.0 桥接"></a>82. rabbitmq_amqp1_0 - AMQP 1.0 桥接</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_amqp1_0/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>AMQP 1.0 协议桥接</li>
<li>协议转换、兼容性支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供 AMQP 1.0 支持</li>
</ul>
<h3 id="83-rabbitmq-amqp-client-AMQP-客户端适配器"><a href="#83-rabbitmq-amqp-client-AMQP-客户端适配器" class="headerlink" title="83. rabbitmq_amqp_client - AMQP 客户端适配器"></a>83. rabbitmq_amqp_client - AMQP 客户端适配器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_amqp_client/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>AMQP 客户端功能适配</li>
<li>客户端接口适配、协议转换</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供客户端支持</li>
</ul>
<h3 id="84-trust-store-http-HTTP-信任存储"><a href="#84-trust-store-http-HTTP-信任存储" class="headerlink" title="84. trust_store_http - HTTP 信任存储"></a>84. trust_store_http - HTTP 信任存储</h3><ul>
<li><strong>模块路径</strong>: <code>deps/trust_store_http/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>通过 HTTP 管理信任存储</li>
<li>HTTP API 信任存储、远程证书管理</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展信任存储功能</li>
</ul>
<h3 id="85-eetcd-etcd-客户端"><a href="#85-eetcd-etcd-客户端" class="headerlink" title="85. eetcd - etcd 客户端"></a>85. eetcd - etcd 客户端</h3><ul>
<li><strong>模块路径</strong>: <code>deps/eetcd/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>etcd 键值存储客户端</li>
<li>etcd API 客户端、分布式配置</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">src/protos/router_pb.erl         <span class="comment">% 路由协议 (64,412 行)</span></span><br><span class="line">src/protos/auth_pb.erl           <span class="comment">% 认证协议 (29,983 行)</span></span><br><span class="line">src/protos/kv_pb.erl             <span class="comment">% 键值协议 (29,658 行)</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 支持 etcd 集群发现</li>
</ul>
<h3 id="86-rabbitmq-consistent-hash-exchange-一致性哈希交换器"><a href="#86-rabbitmq-consistent-hash-exchange-一致性哈希交换器" class="headerlink" title="86. rabbitmq_consistent_hash_exchange - 一致性哈希交换器"></a>86. rabbitmq_consistent_hash_exchange - 一致性哈希交换器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_consistent_hash_exchange/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>一致性哈希路由交换器</li>
<li>一致性哈希算法、负载均衡路由</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 自定义交换器类型</li>
</ul>
<hr>
<h2 id="依赖关系图"><a href="#依赖关系图" class="headerlink" title="依赖关系图"></a>依赖关系图</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">                    ┌─────────────────────────────────┐</span><br><span class="line">                    │            rabbit               │</span><br><span class="line">                    │        (核心服务器)              │</span><br><span class="line">                    └──────────────┬──────────────────┘</span><br><span class="line">                                   │</span><br><span class="line">         ┌─────────────────────────┼─────────────────────────┐</span><br><span class="line">         │                         │                         │</span><br><span class="line">         ▼                         ▼                         ▼</span><br><span class="line">┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐</span><br><span class="line">│  rabbit_common  │    │       ra        │    │     osiris      │</span><br><span class="line">│    (共享库)      │    │   (Raft一致性)   │    │   (日志存储)     │</span><br><span class="line">└────────┬────────┘    └────────┬────────┘    └────────┬────────┘</span><br><span class="line">         │                      │                      │</span><br><span class="line">         │              ┌───────┼───────┐              │</span><br><span class="line">         │              │       │       │              │</span><br><span class="line">         │              ▼       │       ▼              │</span><br><span class="line">         │     ┌────────────┐   │   ┌────────┐        │</span><br><span class="line">         │     │   aten     │   │   │ seshat │◄───────┘</span><br><span class="line">         │     │ (故障检测)  │   │   │(日志管理)│</span><br><span class="line">         │     └────────────┘   │   └────────┘</span><br><span class="line">         │                      │</span><br><span class="line">         │                      ▼</span><br><span class="line">         │             ┌─────────────────┐</span><br><span class="line">         │             │gen_batch_server │◄────────────┘</span><br><span class="line">         │             │   (批处理服务器)  │</span><br><span class="line">         │             └─────────────────┘</span><br><span class="line">         │</span><br><span class="line">         ▼</span><br><span class="line">┌─────────────────┐            ┌─────────────────┐</span><br><span class="line">│   amqp_client   │            │     khepri      │</span><br><span class="line">│   (AMQP客户端)   │            │  (树形数据库)    │</span><br><span class="line">└─────────────────┘            └────────┬────────┘</span><br><span class="line">                                        │</span><br><span class="line">                                        ▼</span><br><span class="line">                               ┌─────────────────┐</span><br><span class="line">                               │     horus       │</span><br><span class="line">                               │   (函数序列化)   │</span><br><span class="line">                               └─────────────────┘</span><br><span class="line"></span><br><span class="line">         ┌─────────────────────────────────────────────────┐</span><br><span class="line">         │                    网络层                        │</span><br><span class="line">         │  ┌──────────┐  ┌──────────┐  ┌──────────┐      │</span><br><span class="line">         │  │  cowboy  │─▶│  cowlib  │  │   ranch  │◄─────│</span><br><span class="line">         │  │(HTTP服务)│  │(HTTP库)  │  │ (连接池) │      │</span><br><span class="line">         │  └──────────┘  └──────────┘  └──────────┘      │</span><br><span class="line">         └─────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">         ┌─────────────────────────────────────────────────┐</span><br><span class="line">         │                    协议层                        │</span><br><span class="line">         │  ┌──────────────┐  ┌────────────────────────┐  │</span><br><span class="line">         │  │rabbitmq_mqtt │  │   rabbitmq_stream      │  │</span><br><span class="line">         │  │  (MQTT协议)  │  │     (流协议)           │  │</span><br><span class="line">         │  └──────────────┘  └────────────────────────┘  │</span><br><span class="line">         │  ┌──────────────┐                              │</span><br><span class="line">         │  │rabbitmq_stomp│                              │</span><br><span class="line">         │  │ (STOMP协议)  │                              │</span><br><span class="line">         │  └──────────────┘                              │</span><br><span class="line">         └─────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">         ┌─────────────────────────────────────────────────┐</span><br><span class="line">         │                    管理层                        │</span><br><span class="line">         │  ┌──────────────────┐  ┌────────────────────┐  │</span><br><span class="line">         │  │rabbitmq_management│  │rabbitmq_prometheus │  │</span><br><span class="line">         │  │    (Web管理)      │  │  (Prometheus监控)  │  │</span><br><span class="line">         │  └────────┬─────────┘  └────────────────────┘  │</span><br><span class="line">         │           │                                     │</span><br><span class="line">         │           ▼                                     │</span><br><span class="line">         │  ┌──────────────────────┐                      │</span><br><span class="line">         │  │rabbitmq_web_dispatch │                      │</span><br><span class="line">         │  │    (Web分发器)       │                      │</span><br><span class="line">         │  └──────────────────────┘                      │</span><br><span class="line">         └─────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="总体架构特点"><a href="#总体架构特点" class="headerlink" title="总体架构特点"></a>总体架构特点</h2><h3 id="1-模块化设计"><a href="#1-模块化设计" class="headerlink" title="1. 模块化设计"></a>1. 模块化设计</h3><ul>
<li><strong>清晰分层</strong>: 核心、存储、协议、管理、工具等层次分明</li>
<li><strong>职责单一</strong>: 每个模块都有明确的功能边界</li>
<li><strong>接口标准</strong>: 统一的插件接口和扩展机制</li>
</ul>
<h3 id="2-可扩展性"><a href="#2-可扩展性" class="headerlink" title="2. 可扩展性"></a>2. 可扩展性</h3><ul>
<li><strong>插件架构</strong>: 支持第三方插件和自定义扩展</li>
<li><strong>协议扩展</strong>: 支持多种消息协议</li>
<li><strong>认证扩展</strong>: 支持多种认证后端</li>
</ul>
<h3 id="3-企业级特性"><a href="#3-企业级特性" class="headerlink" title="3. 企业级特性"></a>3. 企业级特性</h3><ul>
<li><strong>高可用</strong>: 集群、联邦、分片支持</li>
<li><strong>安全性</strong>: 多种认证、授权、加密机制</li>
<li><strong>监控</strong>: 全面的监控和诊断工具</li>
<li><strong>管理</strong>: 完善的管理界面和 CLI 工具</li>
</ul>
<h3 id="4-现代化技术栈"><a href="#4-现代化技术栈" class="headerlink" title="4. 现代化技术栈"></a>4. 现代化技术栈</h3><ul>
<li><strong>一致性</strong>: 基于 Raft 算法的强一致性</li>
<li><strong>性能</strong>: 高性能日志存储和批处理</li>
<li><strong>云原生</strong>: 支持容器化和云环境部署</li>
<li><strong>标准化</strong>: 遵循行业标准和最佳实践</li>
</ul>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>RabbitMQ 4.0.5 的 86 个依赖模块共同构成了一个功能完整、性能优异、高度可扩展的企业级消息代理系统。这些模块按功能可分为：</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>模块数量</th>
<th>代表模块</th>
</tr>
</thead>
<tbody><tr>
<td>核心架构</td>
<td>3</td>
<td>rabbit, rabbit_common, amqp_client</td>
</tr>
<tr>
<td>分布式存储</td>
<td>4</td>
<td>ra, osiris, khepri, khepri_mnesia_migration</td>
</tr>
<tr>
<td>协议支持</td>
<td>5</td>
<td>rabbitmq_mqtt, rabbitmq_stomp, rabbitmq_stream</td>
</tr>
<tr>
<td>管理监控</td>
<td>5</td>
<td>rabbitmq_management, rabbitmq_prometheus, rabbitmq_cli</td>
</tr>
<tr>
<td>认证授权</td>
<td>5</td>
<td>rabbitmq_auth_backend_oauth2, rabbitmq_auth_backend_ldap</td>
</tr>
<tr>
<td>集群发现</td>
<td>5</td>
<td>rabbitmq_peer_discovery_k8s, rabbitmq_peer_discovery_consul</td>
</tr>
<tr>
<td>交换器插件</td>
<td>5</td>
<td>rabbitmq_consistent_hash_exchange, rabbitmq_random_exchange</td>
</tr>
<tr>
<td>联邦复制</td>
<td>6</td>
<td>rabbitmq_federation, rabbitmq_shovel</td>
</tr>
<tr>
<td>Web网络</td>
<td>10</td>
<td>cowboy, ranch, rabbitmq_web_dispatch</td>
</tr>
<tr>
<td>安全加密</td>
<td>4</td>
<td>jose, credentials_obfuscation</td>
</tr>
<tr>
<td>工具实用</td>
<td>10</td>
<td>cuttlefish, recon, observer_cli</td>
</tr>
<tr>
<td>其他辅助</td>
<td>24</td>
<td>aten, gen_batch_server, horus</td>
</tr>
</tbody></table>
<p>这种精心设计的模块化架构体现了 RabbitMQ 在消息中间件领域的技术领先地位，为企业级应用提供了可靠、高效的消息传递解决方案。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/17/rabbitmq-rabbitmq-queue-declare-flow-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/17/rabbitmq-rabbitmq-queue-declare-flow-analysis/" class="post-title-link" itemprop="url">RabbitMQ 队列声明流程深度分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-17 00:00:00 / 修改时间：22:46:59" itemprop="dateCreated datePublished" datetime="2026-01-17T00:00:00+08:00">2026-01-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RabbitMQ-队列声明流程深度分析"><a href="#RabbitMQ-队列声明流程深度分析" class="headerlink" title="RabbitMQ 队列声明流程深度分析"></a>RabbitMQ 队列声明流程深度分析</h1><h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><p>本文档深入分析 RabbitMQ 队列声明（<code>rabbit_amqqueue:declare/6</code>）的完整执行流程，基于以下示例命令：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(rabbit@debian-<span class="number">1</span>)<span class="number">1</span>&gt; rabbit_amqqueue:declare(</span><br><span class="line">    rabbit_misc:r(&lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;, queue, &lt;&lt;<span class="string">&quot;testqueue2&quot;</span>&gt;&gt;),</span><br><span class="line">    <span class="literal">false</span>,      <span class="comment">% Durable</span></span><br><span class="line">    <span class="literal">false</span>,      <span class="comment">% AutoDelete</span></span><br><span class="line">    [],         <span class="comment">% Args</span></span><br><span class="line">    none,       <span class="comment">% Owner</span></span><br><span class="line">    &lt;&lt;<span class="string">&quot;acting-user&quot;</span>&gt;&gt;  <span class="comment">% ActingUser</span></span><br><span class="line">).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 返回结果</span></span><br><span class="line">&#123;new, &#123;amqqueue, &#123;resource,&lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;,queue,&lt;&lt;<span class="string">&quot;testqueue2&quot;</span>&gt;&gt;&#125;,</span><br><span class="line">                 false, false, none, [], &lt;<span class="number">0.862</span>.<span class="number">0</span>&gt;, [], [], [],</span><br><span class="line">                 undefined, undefined, [], [], live, <span class="number">0</span>, [], &lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;,</span><br><span class="line">                 #&#123;user =&gt; &lt;&lt;<span class="string">&quot;acting-user&quot;</span>&gt;&gt;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-流程架构图"><a href="#2-流程架构图" class="headerlink" title="2. 流程架构图"></a>2. 流程架构图</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        <span class="title class_">Queue</span> <span class="title class_">Declaration</span> <span class="title class_">Flow</span>                                │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                              │</span><br><span class="line">│  ┌──────────────┐    ┌─────────────────┐    ┌──────────────────────┐       │</span><br><span class="line">│  │ rabbit_misc  │───▶│ rabbit_amqqueue │───▶│ rabbit_queue_type    │       │</span><br><span class="line">│  │    <span class="symbol">:r/</span><span class="number">3</span>      │    │   <span class="symbol">:declare/</span><span class="number">6</span>    │    │     <span class="symbol">:declare/</span><span class="number">2</span>       │       │</span><br><span class="line">│  └──────────────┘    └─────────────────┘    └──────────────────────┘       │</span><br><span class="line">│         │                    │                        │                     │</span><br><span class="line">│         ▼                    ▼                        ▼                     │</span><br><span class="line">│  ┌──────────────┐    ┌─────────────────┐    ┌──────────────────────┐       │</span><br><span class="line">│  │   <span class="comment">#resource  │    │    amqqueue     │    │ rabbit_classic_queue │       │</span></span><br><span class="line">│  │    record    │    │     <span class="symbol">:new/</span><span class="number">9</span>      │    │     <span class="symbol">:declare/</span><span class="number">2</span>       │       │</span><br><span class="line">│  └──────────────┘    └─────────────────┘    └──────────────────────┘       │</span><br><span class="line">│                              │                        │                     │</span><br><span class="line">│                              ▼                        ▼                     │</span><br><span class="line">│                      ┌─────────────────┐    ┌──────────────────────┐       │</span><br><span class="line">│                      │ rabbit_policy   │    │rabbit_amqqueue_sup_sup│      │</span><br><span class="line">│                      │     <span class="symbol">:set/</span><span class="number">1</span>      │    │<span class="symbol">:start_queue_process/</span><span class="number">2</span>│       │</span><br><span class="line">│                      └─────────────────┘    └──────────────────────┘       │</span><br><span class="line">│                              │                        │                     │</span><br><span class="line">│                              ▼                        ▼                     │</span><br><span class="line">│                      ┌─────────────────┐    ┌──────────────────────┐       │</span><br><span class="line">│                      │rabbit_queue_    │    │ rabbit_amqqueue_sup  │       │</span><br><span class="line">│                      │  <span class="symbol">decorator:</span>set  │    │    <span class="symbol">:start_link/</span><span class="number">2</span>     │       │</span><br><span class="line">│                      └─────────────────┘    └──────────────────────┘       │</span><br><span class="line">│                                                       │                     │</span><br><span class="line">│                                                       ▼                     │</span><br><span class="line">│                                             ┌──────────────────────┐       │</span><br><span class="line">│                                             │rabbit_amqqueue_process│      │</span><br><span class="line">│                                             │    <span class="symbol">:start_link/</span><span class="number">2</span>      │       │</span><br><span class="line">│                                             └──────────────────────┘       │</span><br><span class="line">│                                                       │                     │</span><br><span class="line">│                                                       ▼                     │</span><br><span class="line">│                                             ┌──────────────────────┐       │</span><br><span class="line">│                                             │    <span class="symbol">gen_server2:</span>call  │       │</span><br><span class="line">│                                             │    &#123;init, new&#125;       │       │</span><br><span class="line">│                                             └──────────────────────┘       │</span><br><span class="line">│                                                       │                     │</span><br><span class="line">│                                                       ▼                     │</span><br><span class="line">│                                             ┌──────────────────────┐       │</span><br><span class="line">│                                             │ rabbit_db_queue      │       │</span><br><span class="line">│                                             │   <span class="symbol">:create_or_get/</span><span class="number">1</span>   │       │</span><br><span class="line">│                                             └──────────────────────┘       │</span><br><span class="line">│                                                       │                     │</span><br><span class="line">│                                                       ▼                     │</span><br><span class="line">│                                             ┌──────────────────────┐       │</span><br><span class="line">│                                             │   <span class="title class_">Mnesia</span> / <span class="title class_">Khepri</span>    │       │</span><br><span class="line">│                                             │     持久化存储        │       │</span><br><span class="line">│                                             └──────────────────────┘       │</span><br><span class="line">│                                                                              │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-详细流程分析"><a href="#3-详细流程分析" class="headerlink" title="3. 详细流程分析"></a>3. 详细流程分析</h2><h3 id="3-1-阶段一：资源名称构建-rabbit-misc-r-3"><a href="#3-1-阶段一：资源名称构建-rabbit-misc-r-3" class="headerlink" title="3.1 阶段一：资源名称构建 (rabbit_misc:r/3)"></a>3.1 阶段一：资源名称构建 (<code>rabbit_misc:r/3</code>)</h3><h4 id="源码位置"><a href="#源码位置" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit_common/src/rabbit_misc.erl:413-419</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">r</span><span class="params">(#resource&#123;virtual_host = VHostPath&#125;, Kind, Name)</span> -&gt;</span></span><br><span class="line">    #resource&#123;virtual_host = VHostPath, kind = Kind, name = Name&#125;;</span><br><span class="line"><span class="function"><span class="title">r</span><span class="params">(VHostPath, Kind, Name)</span> -&gt;</span></span><br><span class="line">    #resource&#123;virtual_host = VHostPath, kind = Kind, name = Name&#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">r</span><span class="params">(VHostPath, Kind)</span> -&gt;</span></span><br><span class="line">    #resource&#123;virtual_host = VHostPath, kind = Kind, name = &#x27;_&#x27;&#125;.</span><br></pre></td></tr></table></figure>

<h4 id="功能说明"><a href="#功能说明" class="headerlink" title="功能说明"></a>功能说明</h4><ul>
<li><strong>输入</strong>: <code>&lt;&lt;&quot;/&quot;&gt;&gt;</code>, <code>queue</code>, <code>&lt;&lt;&quot;testqueue2&quot;&gt;&gt;</code></li>
<li><strong>输出</strong>: <code>#resource{virtual_host = &lt;&lt;&quot;/&quot;&gt;&gt;, kind = queue, name = &lt;&lt;&quot;testqueue2&quot;&gt;&gt;}</code></li>
</ul>
<h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-record</span><span class="params">(resource, &#123;</span></span><br><span class="line"><span class="params">    virtual_host :: binary(),  <span class="comment">% VHost 名称</span></span></span><br><span class="line"><span class="params">    kind :: queue | exchange,  <span class="comment">% 资源类型</span></span></span><br><span class="line"><span class="params">    name :: binary()           <span class="comment">% 资源名称</span></span></span><br><span class="line"><span class="params">&#125;)</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-2-阶段二：队列声明入口-rabbit-amqqueue-declare-6"><a href="#3-2-阶段二：队列声明入口-rabbit-amqqueue-declare-6" class="headerlink" title="3.2 阶段二：队列声明入口 (rabbit_amqqueue:declare/6)"></a>3.2 阶段二：队列声明入口 (<code>rabbit_amqqueue:declare/6</code>)</h3><h4 id="源码位置-1"><a href="#源码位置-1" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/rabbit_amqqueue.erl:201-250</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">declare</span><span class="params">(QueueName, Durable, AutoDelete, Args, Owner, ActingUser)</span> -&gt;</span></span><br><span class="line">    declare(QueueName, Durable, AutoDelete, Args, Owner, ActingUser, node()).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">declare</span><span class="params">(QueueName = #resource&#123;virtual_host = VHost&#125;, Durable, AutoDelete, Args,</span></span></span><br><span class="line"><span class="params"><span class="function">        Owner, ActingUser, Node)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 1. 获取默认队列类型</span></span><br><span class="line">    DQT = rabbit_vhost:default_queue_type(VHost, rabbit_queue_type:fallback()),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 2. 验证声明参数</span></span><br><span class="line">    ok = check_declare_arguments(QueueName, Args, DQT),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 3. 确定队列类型</span></span><br><span class="line">    Type = get_queue_type(Args, DQT),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 4. 检查队列类型是否启用</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_queue_type:is_enabled(Type) <span class="keyword">of</span></span><br><span class="line">        <span class="literal">true</span> -&gt;</span><br><span class="line">            <span class="comment">%% 5. 创建 amqqueue 记录</span></span><br><span class="line">            Q = amqqueue:new(QueueName,</span><br><span class="line">                             none,           <span class="comment">% pid (初始为 none)</span></span><br><span class="line">                             Durable,</span><br><span class="line">                             AutoDelete,</span><br><span class="line">                             Owner,</span><br><span class="line">                             Args,</span><br><span class="line">                             VHost,</span><br><span class="line">                             #&#123;user =&gt; ActingUser&#125;,</span><br><span class="line">                             Type),</span><br><span class="line">            <span class="comment">%% 6. 检查参数组合是否允许</span></span><br><span class="line">            <span class="keyword">case</span> is_queue_args_combination_permitted(Q) <span class="keyword">of</span></span><br><span class="line">                <span class="literal">true</span> -&gt;</span><br><span class="line">                    <span class="comment">%% 7. 委托给队列类型模块处理</span></span><br><span class="line">                    rabbit_queue_type:declare(Q, Node);</span><br><span class="line">                <span class="literal">false</span> -&gt;</span><br><span class="line">                    &#123;protocol_error, internal_error, <span class="string">&quot;~ts&quot;</span>, [Warning]&#125;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        <span class="literal">false</span> -&gt;</span><br><span class="line">            &#123;protocol_error, internal_error, <span class="string">&quot;...&quot;</span>, [...]&#125;</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<h4 id="关键步骤详解"><a href="#关键步骤详解" class="headerlink" title="关键步骤详解"></a>关键步骤详解</h4><h5 id="3-2-1-获取默认队列类型"><a href="#3-2-1-获取默认队列类型" class="headerlink" title="3.2.1 获取默认队列类型"></a>3.2.1 获取默认队列类型</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_vhost.erl</span></span><br><span class="line"><span class="function"><span class="title">default_queue_type</span><span class="params">(VHost, DefaultQT)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> lookup(VHost) <span class="keyword">of</span></span><br><span class="line">        &#123;ok, VHostRec&#125; -&gt;</span><br><span class="line">            <span class="keyword">case</span> vhost:get_default_queue_type(VHostRec) <span class="keyword">of</span></span><br><span class="line">                undefined -&gt; DefaultQT;</span><br><span class="line">                DQT -&gt; rabbit_queue_type:discover(DQT)</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        &#123;error, _&#125; -&gt;</span><br><span class="line">            DefaultQT</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">%% rabbit_queue_type.erl</span></span><br><span class="line"><span class="function"><span class="title">fallback</span><span class="params">()</span> -&gt;</span> rabbit_classic_queue.</span><br></pre></td></tr></table></figure>

<h5 id="3-2-2-验证声明参数"><a href="#3-2-2-验证声明参数" class="headerlink" title="3.2.2 验证声明参数"></a>3.2.2 验证声明参数</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_amqqueue.erl:849-859</span></span><br><span class="line"><span class="function"><span class="title">check_declare_arguments</span><span class="params">(QueueName, Args0, DefaultQueueType)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 注入默认队列类型</span></span><br><span class="line">    Args = maybe_inject_default_queue_type_shortcut_into_args(Args0, DefaultQueueType),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 检查 x-queue-type 参数</span></span><br><span class="line">    check_arguments_type_and_value(QueueName, Args, </span><br><span class="line">        [&#123;&lt;&lt;<span class="string">&quot;x-queue-type&quot;</span>&gt;&gt;, fun check_queue_type/2&#125;]),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 获取队列类型</span></span><br><span class="line">    Type = get_queue_type(Args),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 获取该类型支持的参数</span></span><br><span class="line">    QueueTypeArgs = rabbit_queue_type:arguments(queue_arguments, Type),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 验证参数类型和值</span></span><br><span class="line">    Validators = lists:filter(</span><br><span class="line">        <span class="keyword">fun</span>(&#123;Arg, _&#125;) -&gt; lists:member(Arg, QueueTypeArgs) <span class="keyword">end</span>, </span><br><span class="line">        declare_args()),</span><br><span class="line">    check_arguments_type_and_value(QueueName, Args, Validators),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 检查无效参数</span></span><br><span class="line">    InvalidArgs = rabbit_queue_type:arguments(queue_arguments) -- QueueTypeArgs,</span><br><span class="line">    check_arguments_key(QueueName, Type, Args, InvalidArgs).</span><br></pre></td></tr></table></figure>

<h5 id="3-2-3-确定队列类型"><a href="#3-2-3-确定队列类型" class="headerlink" title="3.2.3 确定队列类型"></a>3.2.3 确定队列类型</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_amqqueue.erl:261-273</span></span><br><span class="line"><span class="function"><span class="title">get_queue_type</span><span class="params">([], DefaultQueueType)</span> -&gt;</span></span><br><span class="line">    rabbit_queue_type:discover(DefaultQueueType);</span><br><span class="line"><span class="function"><span class="title">get_queue_type</span><span class="params">(Args, DefaultQueueType)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_misc:table_lookup(Args, &lt;&lt;<span class="string">&quot;x-queue-type&quot;</span>&gt;&gt;) <span class="keyword">of</span></span><br><span class="line">        undefined -&gt;</span><br><span class="line">            rabbit_queue_type:discover(DefaultQueueType);</span><br><span class="line">        &#123;longstr, undefined&#125; -&gt;</span><br><span class="line">            rabbit_queue_type:discover(DefaultQueueType);</span><br><span class="line">        &#123;longstr, &lt;&lt;<span class="string">&quot;undefined&quot;</span>&gt;&gt;&#125; -&gt;</span><br><span class="line">            rabbit_queue_type:discover(DefaultQueueType);</span><br><span class="line">        &#123;_, V&#125; -&gt;</span><br><span class="line">            rabbit_queue_type:discover(V)</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<p><strong>队列类型映射关系</strong>：</p>
<table>
<thead>
<tr>
<th>参数值</th>
<th>模块</th>
</tr>
</thead>
<tbody><tr>
<td><code>classic</code></td>
<td><code>rabbit_classic_queue</code></td>
</tr>
<tr>
<td><code>quorum</code></td>
<td><code>rabbit_quorum_queue</code></td>
</tr>
<tr>
<td><code>stream</code></td>
<td><code>rabbit_stream_queue</code></td>
</tr>
</tbody></table>
<hr>
<h3 id="3-3-阶段三：创建-amqqueue-记录-amqqueue-new-9"><a href="#3-3-阶段三：创建-amqqueue-记录-amqqueue-new-9" class="headerlink" title="3.3 阶段三：创建 amqqueue 记录 (amqqueue:new/9)"></a>3.3 阶段三：创建 amqqueue 记录 (<code>amqqueue:new/9</code>)</h3><h4 id="源码位置-2"><a href="#源码位置-2" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/amqqueue.erl:215-319</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">new</span><span class="params">(#resource&#123;kind = queue&#125; = Name,</span></span></span><br><span class="line"><span class="params"><span class="function">    Pid,</span></span></span><br><span class="line"><span class="params"><span class="function">    Durable,</span></span></span><br><span class="line"><span class="params"><span class="function">    AutoDelete,</span></span></span><br><span class="line"><span class="params"><span class="function">    Owner,</span></span></span><br><span class="line"><span class="params"><span class="function">    Args,</span></span></span><br><span class="line"><span class="params"><span class="function">    VHost,</span></span></span><br><span class="line"><span class="params"><span class="function">    Options,</span></span></span><br><span class="line"><span class="params"><span class="function">    Type)</span></span></span><br><span class="line"><span class="function">  <span class="title">when</span> <span class="params">(is_pid(Pid) orelse is_tuple(Pid) orelse Pid =:= none)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="title">is_boolean</span><span class="params">(Durable)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="title">is_boolean</span><span class="params">(AutoDelete)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="params">(is_pid(Owner) orelse Owner =:= none)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="title">is_list</span><span class="params">(Args)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="params">(is_binary(VHost) orelse VHost =:= undefined)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="title">is_map</span><span class="params">(Options)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="title">is_atom</span><span class="params">(Type)</span> -&gt;</span></span><br><span class="line">    new_with_version(</span><br><span class="line">      ?record_version,  <span class="comment">% amqqueue_v2</span></span><br><span class="line">      Name,</span><br><span class="line">      Pid,</span><br><span class="line">      Durable,</span><br><span class="line">      AutoDelete,</span><br><span class="line">      Owner,</span><br><span class="line">      Args,</span><br><span class="line">      VHost,</span><br><span class="line">      Options,</span><br><span class="line">      Type).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">new_with_version</span><span class="params">(?record_version, Name, Pid, Durable, AutoDelete,</span></span></span><br><span class="line"><span class="params"><span class="function">                 Owner, Args, VHost, Options, Type)</span> -&gt;</span></span><br><span class="line">    #amqqueue&#123;name            = Name,</span><br><span class="line">              durable         = Durable,</span><br><span class="line">              auto_delete     = AutoDelete,</span><br><span class="line">              arguments       = Args,</span><br><span class="line">              exclusive_owner = Owner,</span><br><span class="line">              pid             = Pid,</span><br><span class="line">              vhost           = VHost,</span><br><span class="line">              options         = Options,</span><br><span class="line">              type            = Type&#125;.</span><br></pre></td></tr></table></figure>

<h4 id="amqqueue-记录结构"><a href="#amqqueue-记录结构" class="headerlink" title="amqqueue 记录结构"></a>amqqueue 记录结构</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-record</span><span class="params">(amqqueue, &#123;</span></span><br><span class="line"><span class="params">    <span class="comment">%% 不可变字段</span></span></span><br><span class="line"><span class="params">    name :: rabbit_amqqueue:name() | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    durable :: boolean() | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    auto_delete :: boolean() | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    exclusive_owner = none :: pid() | none | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    arguments = [] :: rabbit_framing:amqp_table() | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    </span></span><br><span class="line"><span class="params">    <span class="comment">%% 可变字段</span></span></span><br><span class="line"><span class="params">    pid :: pid() | ra_server_id() | none | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    slave_pids = [],           <span class="comment">% 保留字段</span></span></span><br><span class="line"><span class="params">    sync_slave_pids = [],      <span class="comment">% 保留字段</span></span></span><br><span class="line"><span class="params">    recoverable_slaves = [],   <span class="comment">% 保留字段</span></span></span><br><span class="line"><span class="params">    </span></span><br><span class="line"><span class="params">    <span class="comment">%% 策略相关</span></span></span><br><span class="line"><span class="params">    policy :: proplists:proplist() | none | undefined | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    operator_policy :: proplists:proplist() | none | undefined,</span></span><br><span class="line"><span class="params">    </span></span><br><span class="line"><span class="params">    <span class="comment">%% 运行时状态</span></span></span><br><span class="line"><span class="params">    gm_pids = [] :: [&#123;pid(), pid()&#125;] | none,</span></span><br><span class="line"><span class="params">    decorators :: [atom()] | none | undefined,</span></span><br><span class="line"><span class="params">    state = live :: atom(),</span></span><br><span class="line"><span class="params">    policy_version = <span class="number">0</span> :: non_neg_integer(),</span></span><br><span class="line"><span class="params">    type_state = #&#123;&#125; :: map(),</span></span><br><span class="line"><span class="params">    vhost :: binary() | undefined,</span></span><br><span class="line"><span class="params">    options = #&#123;&#125; :: map(),</span></span><br><span class="line"><span class="params">    type = rabbit_classic_queue :: module()</span></span><br><span class="line"><span class="params">&#125;)</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-4-阶段四：队列类型分发-rabbit-queue-type-declare-2"><a href="#3-4-阶段四：队列类型分发-rabbit-queue-type-declare-2" class="headerlink" title="3.4 阶段四：队列类型分发 (rabbit_queue_type:declare/2)"></a>3.4 阶段四：队列类型分发 (<code>rabbit_queue_type:declare/2</code>)</h3><h4 id="源码位置-3"><a href="#源码位置-3" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/rabbit_queue_type.erl:389-397</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-spec</span> declare<span class="params">(amqqueue:amqqueue(), node() | &#123;&#x27;ignore_location&#x27;, node()&#125;)</span> -&gt;</span><br><span class="line">    &#123;&#x27;new&#x27; | &#x27;existing&#x27; | &#x27;owner_died&#x27;, amqqueue:amqqueue<span class="params">()</span>&#125; |</span><br><span class="line">    &#123;&#x27;absent&#x27;, amqqueue:amqqueue<span class="params">()</span>, rabbit_amqqueue:absent_reason<span class="params">()</span>&#125; |</span><br><span class="line">    &#123;protocol_error, Type :: atom<span class="params">()</span>, Reason :: string<span class="params">()</span>, Args :: term<span class="params">()</span>&#125; |</span><br><span class="line">    &#123;&#x27;error&#x27;, Type :: atom<span class="params">()</span>, Reason :: string<span class="params">()</span>, Args :: term<span class="params">()</span>&#125; |</span><br><span class="line">    &#123;&#x27;error&#x27;, Err :: term<span class="params">()</span> &#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">declare</span><span class="params">(Q0, Node)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 1. 设置策略和装饰器</span></span><br><span class="line">    Q = rabbit_queue_decorator:set(rabbit_policy:set(Q0)),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 2. 获取队列类型模块</span></span><br><span class="line">    Mod = amqqueue:get_type(Q),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 3. 检查队列限制</span></span><br><span class="line">    <span class="keyword">case</span> check_queue_limits(Q) <span class="keyword">of</span></span><br><span class="line">        ok -&gt;</span><br><span class="line">            <span class="comment">%% 4. 调用具体类型的 declare</span></span><br><span class="line">            Mod:declare(Q, Node);</span><br><span class="line">        Error -&gt;</span><br><span class="line">            Error</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<h4 id="策略设置-rabbit-policy-set-1"><a href="#策略设置-rabbit-policy-set-1" class="headerlink" title="策略设置 (rabbit_policy:set/1)"></a>策略设置 (<code>rabbit_policy:set/1</code>)</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_policy.erl:94-105</span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(Q0)</span> <span class="title">when</span> ?<span class="title">is_amqqueue</span><span class="params">(Q0)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 匹配当前 VHost 的策略</span></span><br><span class="line">    Policy = match(Q0),</span><br><span class="line">    OpPolicy = match_op(Q0),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 设置策略到队列记录</span></span><br><span class="line">    Q1 = amqqueue:set_policy(Q0, Policy),</span><br><span class="line">    Q2 = amqqueue:set_operator_policy(Q1, OpPolicy),</span><br><span class="line">    Q2.</span><br></pre></td></tr></table></figure>

<h4 id="装饰器设置-rabbit-queue-decorator-set-1"><a href="#装饰器设置-rabbit-queue-decorator-set-1" class="headerlink" title="装饰器设置 (rabbit_queue_decorator:set/1)"></a>装饰器设置 (<code>rabbit_queue_decorator:set/1</code>)</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_queue_decorator.erl:42-44</span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(Q)</span> <span class="title">when</span> ?<span class="title">is_amqqueue</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 获取所有活跃的装饰器</span></span><br><span class="line">    Decorators = [D || D &lt;- list(), D:active_for(Q)],</span><br><span class="line">    amqqueue:set_decorators(Q, Decorators).</span><br></pre></td></tr></table></figure>

<h4 id="队列限制检查"><a href="#队列限制检查" class="headerlink" title="队列限制检查"></a>队列限制检查</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_queue_type.erl:876-895</span></span><br><span class="line"><span class="function"><span class="title">check_queue_limits</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">maybe</span></span><br><span class="line">        ok ?= check_vhost_queue_limit(Q),</span><br><span class="line">        ok ?= check_cluster_queue_limit(Q)</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_vhost_queue_limit</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    #resource&#123;name = QueueName&#125; = amqqueue:get_name(Q),</span><br><span class="line">    VHost = amqqueue:get_vhost(Q),</span><br><span class="line">    <span class="keyword">case</span> rabbit_vhost_limit:is_over_queue_limit(VHost) <span class="keyword">of</span></span><br><span class="line">        <span class="literal">false</span> -&gt; ok;</span><br><span class="line">        &#123;true, Limit&#125; -&gt;</span><br><span class="line">            queue_limit_error(<span class="string">&quot;cannot declare queue &#x27;~ts&#x27;: &quot;</span></span><br><span class="line">                <span class="string">&quot;queue limit in vhost &#x27;~ts&#x27; (~tp) is reached&quot;</span>,</span><br><span class="line">                [QueueName, VHost, Limit])</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-5-阶段五：Classic-队列声明-rabbit-classic-queue-declare-2"><a href="#3-5-阶段五：Classic-队列声明-rabbit-classic-queue-declare-2" class="headerlink" title="3.5 阶段五：Classic 队列声明 (rabbit_classic_queue:declare/2)"></a>3.5 阶段五：Classic 队列声明 (<code>rabbit_classic_queue:declare/2</code>)</h3><h4 id="源码位置-4"><a href="#源码位置-4" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/rabbit_classic_queue.erl:120-146</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">declare</span><span class="params">(Q, Node)</span> <span class="title">when</span> ?<span class="title">amqqueue_is_classic</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> validate_arguments(amqqueue:get_arguments(Q)) <span class="keyword">of</span></span><br><span class="line">        ok -&gt; do_declare(Q, Node);</span><br><span class="line">        Error -&gt; Error</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">do_declare</span><span class="params">(Q, Node)</span> <span class="title">when</span> ?<span class="title">amqqueue_is_classic</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    QName = amqqueue:get_name(Q),</span><br><span class="line">    VHost = amqqueue:get_vhost(Q),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 1. 确定队列所在节点</span></span><br><span class="line">    Node1 = <span class="keyword">case</span> &#123;Node, rabbit_amqqueue:is_exclusive(Q)&#125; <span class="keyword">of</span></span><br><span class="line">        &#123;&#123;ignore_location, Node0&#125;, _&#125; -&gt;</span><br><span class="line">            Node0;</span><br><span class="line">        &#123;_, true&#125; -&gt;</span><br><span class="line">            Node;  <span class="comment">% 独占队列在当前节点</span></span><br><span class="line">        _ -&gt;</span><br><span class="line">            <span class="comment">%% 使用位置选择策略</span></span><br><span class="line">            &#123;Node0, _&#125; = rabbit_queue_location:select_leader_and_followers(Q, <span class="number">1</span>),</span><br><span class="line">            Node0</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 2. 检查 VHost 是否存在</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_vhost_sup_sup:get_vhost_sup(VHost, Node1) <span class="keyword">of</span></span><br><span class="line">        &#123;ok, _&#125; -&gt;</span><br><span class="line">            <span class="comment">%% 3. 启动队列进程并等待初始化</span></span><br><span class="line">            gen_server2:call(</span><br><span class="line">                rabbit_amqqueue_sup_sup:start_queue_process(Node1, Q),</span><br><span class="line">                &#123;init, new&#125;, </span><br><span class="line">                infinity);</span><br><span class="line">        &#123;error, Error&#125; -&gt;</span><br><span class="line">            &#123;protocol_error, internal_error, </span><br><span class="line">             <span class="string">&quot;Cannot declare a queue &#x27;~ts&#x27; on node &#x27;~ts&#x27;: ~255p&quot;</span>,</span><br><span class="line">             [rabbit_misc:rs(QName), Node1, Error]&#125;</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-6-阶段六：启动队列进程"><a href="#3-6-阶段六：启动队列进程" class="headerlink" title="3.6 阶段六：启动队列进程"></a>3.6 阶段六：启动队列进程</h3><h4 id="3-6-1-启动队列进程-rabbit-amqqueue-sup-sup-start-queue-process-2"><a href="#3-6-1-启动队列进程-rabbit-amqqueue-sup-sup-start-queue-process-2" class="headerlink" title="3.6.1 启动队列进程 (rabbit_amqqueue_sup_sup:start_queue_process/2)"></a>3.6.1 启动队列进程 (<code>rabbit_amqqueue_sup_sup:start_queue_process/2</code>)</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_amqqueue_sup_sup.erl:32-36</span></span><br><span class="line"><span class="function"><span class="title">start_queue_process</span><span class="params">(Node, Q)</span> -&gt;</span></span><br><span class="line">    #resource&#123;virtual_host = VHost&#125; = amqqueue:get_name(Q),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 找到 VHost 的队列监督者</span></span><br><span class="line">    &#123;ok, Sup&#125; = find_for_vhost(VHost, Node),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 启动新的队列子进程</span></span><br><span class="line">    &#123;ok, _SupPid, QPid&#125; = supervisor:start_child(Sup, [Q, declare]),</span><br><span class="line">    QPid.</span><br></pre></td></tr></table></figure>

<h4 id="3-6-2-队列监督者初始化-rabbit-amqqueue-sup-start-link-2"><a href="#3-6-2-队列监督者初始化-rabbit-amqqueue-sup-start-link-2" class="headerlink" title="3.6.2 队列监督者初始化 (rabbit_amqqueue_sup:start_link/2)"></a>3.6.2 队列监督者初始化 (<code>rabbit_amqqueue_sup:start_link/2</code>)</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_amqqueue_sup.erl:23-37</span></span><br><span class="line"><span class="function"><span class="title">start_link</span><span class="params">(Q, _StartMode)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 创建 Marker 进程用于区分启动和重启</span></span><br><span class="line">    Marker = spawn_link(<span class="keyword">fun</span>() -&gt; <span class="keyword">receive</span> stop -&gt; ok <span class="keyword">end</span> <span class="keyword">end</span>),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 定义队列进程的启动规范</span></span><br><span class="line">    StartMFA = &#123;rabbit_amqqueue_process, start_link, [Q, Marker]&#125;,</span><br><span class="line">    ChildSpec = #&#123;id =&gt; rabbit_amqqueue,</span><br><span class="line">                  start =&gt; StartMFA,</span><br><span class="line">                  restart =&gt; transient,</span><br><span class="line">                  significant =&gt; true,</span><br><span class="line">                  shutdown =&gt; ?CLASSIC_QUEUE_WORKER_WAIT,</span><br><span class="line">                  type =&gt; worker,</span><br><span class="line">                  modules =&gt; [rabbit_amqqueue_process]&#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 启动监督者</span></span><br><span class="line">    &#123;ok, SupPid&#125; = supervisor:start_link(?MODULE, []),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 启动队列进程</span></span><br><span class="line">    &#123;ok, QPid&#125; = supervisor:start_child(SupPid, ChildSpec),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 清理 Marker</span></span><br><span class="line">    unlink(Marker),</span><br><span class="line">    Marker ! stop,</span><br><span class="line">    &#123;ok, SupPid, QPid&#125;.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-7-阶段七：队列进程初始化-rabbit-amqqueue-process"><a href="#3-7-阶段七：队列进程初始化-rabbit-amqqueue-process" class="headerlink" title="3.7 阶段七：队列进程初始化 (rabbit_amqqueue_process)"></a>3.7 阶段七：队列进程初始化 (<code>rabbit_amqqueue_process</code>)</h3><h4 id="源码位置-5"><a href="#源码位置-5" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/rabbit_amqqueue_process.erl:144-239</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 启动入口</span></span><br><span class="line"><span class="function"><span class="title">start_link</span><span class="params">(Q, Marker)</span> -&gt;</span></span><br><span class="line">    gen_server2:start_link(?MODULE, &#123;Q, Marker&#125;, []).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 初始化</span></span><br><span class="line"><span class="function"><span class="title">init</span><span class="params">(&#123;Q, Marker&#125;)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> is_process_alive(Marker) <span class="keyword">of</span></span><br><span class="line">        <span class="literal">true</span>  -&gt;</span><br><span class="line">            <span class="comment">%% 正常启动</span></span><br><span class="line">            init(Q);</span><br><span class="line">        <span class="literal">false</span> -&gt;</span><br><span class="line">            <span class="comment">%% 重启场景</span></span><br><span class="line">            QueueName = amqqueue:get_name(Q),</span><br><span class="line">            &#123;ok, Q1&#125; = rabbit_amqqueue:lookup(QueueName),</span><br><span class="line">            gen_server2:cast(self(), init),</span><br><span class="line">            init(Q1)</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">init</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    process_flag(trap_exit, true),</span><br><span class="line">    ?store_proc_name(amqqueue:get_name(Q)),</span><br><span class="line">    &#123;ok, init_state(amqqueue:set_pid(Q, self())), hibernate,</span><br><span class="line">     &#123;backoff, ?HIBERNATE_AFTER_MIN, ?HIBERNATE_AFTER_MIN, ?DESIRED_HIBERNATE&#125;,</span><br><span class="line">    ?MODULE&#125;.</span><br></pre></td></tr></table></figure>

<h4 id="3-7-1-初始化状态"><a href="#3-7-1-初始化状态" class="headerlink" title="3.7.1 初始化状态"></a>3.7.1 初始化状态</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_amqqueue_process.erl:165-180</span></span><br><span class="line"><span class="function"><span class="title">init_state</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    SingleActiveConsumerOn = <span class="keyword">case</span> rabbit_misc:table_lookup(</span><br><span class="line">            amqqueue:get_arguments(Q), &lt;&lt;<span class="string">&quot;x-single-active-consumer&quot;</span>&gt;&gt;) <span class="keyword">of</span></span><br><span class="line">        &#123;bool, true&#125; -&gt; <span class="literal">true</span>;</span><br><span class="line">        _            -&gt; <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    State = #q&#123;q                         = Q,</span><br><span class="line">               active_consumer           = none,</span><br><span class="line">               has_had_consumers         = false,</span><br><span class="line">               consumers                 = rabbit_queue_consumers:new(),</span><br><span class="line">               senders                   = pmon:new(delegate),</span><br><span class="line">               msg_id_to_channel         = #&#123;&#125;,</span><br><span class="line">               status                    = running,</span><br><span class="line">               args_policy_version       = <span class="number">0</span>,</span><br><span class="line">               overflow                  = &#x27;drop-head&#x27;,</span><br><span class="line">               single_active_consumer_on = SingleActiveConsumerOn&#125;,</span><br><span class="line">    rabbit_event:init_stats_timer(State, #q.stats_timer).</span><br></pre></td></tr></table></figure>

<h4 id="3-7-2-处理-init-new-调用"><a href="#3-7-2-处理-init-new-调用" class="headerlink" title="3.7.2 处理 {init, new} 调用"></a>3.7.2 处理 <code>{init, new}</code> 调用</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% handle_call 会路由到 init_it/3</span></span><br><span class="line"><span class="function"><span class="title">init_it</span><span class="params">(Recover, From, State = #q&#123;q = Q&#125;)</span></span></span><br><span class="line"><span class="function">  <span class="title">when</span> ?<span class="title">amqqueue_exclusive_owner_is</span><span class="params">(Q, none)</span> -&gt;</span></span><br><span class="line">    init_it2(Recover, From, State);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">init_it2</span><span class="params">(Recover, From, State = #q&#123;q = Q,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   backing_queue = undefined,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   backing_queue_state = undefined&#125;)</span> -&gt;</span></span><br><span class="line">    &#123;Barrier, TermsOrNew&#125; = recovery_status(Recover),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 关键：内部声明，写入数据库</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_amqqueue:internal_declare(Q, Recover /= new) <span class="keyword">of</span></span><br><span class="line">        &#123;Res, Q1&#125; <span class="keyword">when</span> ?is_amqqueue(Q1) <span class="keyword">andalso</span></span><br><span class="line">                       (Res == created <span class="keyword">orelse</span> Res == existing) -&gt;</span><br><span class="line">            <span class="keyword">case</span> matches(Recover, Q, Q1) <span class="keyword">of</span></span><br><span class="line">                <span class="literal">true</span> -&gt;</span><br><span class="line">                    <span class="comment">%% 初始化 backing queue</span></span><br><span class="line">                    BQ = backing_queue_module(),</span><br><span class="line">                    BQS = bq_init(BQ, Q, TermsOrNew),</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">%% 回复调用者</span></span><br><span class="line">                    send_reply(From, &#123;new, Q&#125;),</span><br><span class="line">                    </span><br><span class="line">                    recovery_barrier(Barrier),</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">%% 处理策略和参数</span></span><br><span class="line">                    State1 = process_args_policy(</span><br><span class="line">                        State#q&#123;backing_queue = BQ,</span><br><span class="line">                                backing_queue_state = BQS&#125;),</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">%% 通知装饰器</span></span><br><span class="line">                    notify_decorators(startup, State),</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">%% 发送事件通知</span></span><br><span class="line">                    rabbit_event:notify(queue_created,</span><br><span class="line">                        queue_created_infos(State1)),</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">%% 发送统计信息</span></span><br><span class="line">                    rabbit_event:if_enabled(State1, #q.stats_timer,</span><br><span class="line">                        <span class="keyword">fun</span>() -&gt; emit_stats(State1) <span class="keyword">end</span>),</span><br><span class="line">                    </span><br><span class="line">                    noreply(State1);</span><br><span class="line">                <span class="literal">false</span> -&gt;</span><br><span class="line">                    &#123;stop, normal, &#123;existing, Q1&#125;, State&#125;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        &#123;error, timeout&#125; -&gt;</span><br><span class="line">            <span class="comment">%% 超时处理</span></span><br><span class="line">            ...;</span><br><span class="line">        Err -&gt;</span><br><span class="line">            &#123;stop, normal, Err, State&#125;</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-8-阶段八：数据库持久化-rabbit-amqqueue-internal-declare-2"><a href="#3-8-阶段八：数据库持久化-rabbit-amqqueue-internal-declare-2" class="headerlink" title="3.8 阶段八：数据库持久化 (rabbit_amqqueue:internal_declare/2)"></a>3.8 阶段八：数据库持久化 (<code>rabbit_amqqueue:internal_declare/2</code>)</h3><h4 id="源码位置-6"><a href="#源码位置-6" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/rabbit_amqqueue.erl:275-302</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-spec</span> internal_declare<span class="params">(Queue, Recover)</span> -&gt; Ret when</span><br><span class="line">      Queue :: amqqueue:amqqueue<span class="params">()</span>,</span><br><span class="line">      Recover :: boolean<span class="params">()</span>,</span><br><span class="line">      Ret :: &#123;created | existing, amqqueue:amqqueue<span class="params">()</span>&#125; |</span><br><span class="line">             queue_absent<span class="params">()</span> |</span><br><span class="line">             rabbit_khepri:timeout_error<span class="params">()</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">internal_declare</span><span class="params">(Q, Recover)</span> -&gt;</span></span><br><span class="line">    do_internal_declare(Q, Recover).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 恢复模式</span></span><br><span class="line"><span class="function"><span class="title">do_internal_declare</span><span class="params">(Q0, true)</span> -&gt;</span></span><br><span class="line">    Q = amqqueue:set_state(Q0, live),</span><br><span class="line">    <span class="keyword">case</span> store_queue(Q) <span class="keyword">of</span></span><br><span class="line">        ok -&gt; &#123;created, Q0&#125;;</span><br><span class="line">        &#123;error, timeout&#125; = Err -&gt; Err</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 新建模式 (我们的示例走这条路径)</span></span><br><span class="line"><span class="function"><span class="title">do_internal_declare</span><span class="params">(Q0, false)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 1. 设置状态为 live</span></span><br><span class="line">    <span class="comment">%% 2. 应用策略</span></span><br><span class="line">    Q = rabbit_policy:set(amqqueue:set_state(Q0, live)),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 3. 设置装饰器</span></span><br><span class="line">    Queue = rabbit_queue_decorator:set(Q),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 4. 写入数据库</span></span><br><span class="line">    rabbit_db_queue:create_or_get(Queue).</span><br></pre></td></tr></table></figure>

<h4 id="数据库操作-rabbit-db-queue-create-or-get-1"><a href="#数据库操作-rabbit-db-queue-create-or-get-1" class="headerlink" title="数据库操作 (rabbit_db_queue:create_or_get/1)"></a>数据库操作 (<code>rabbit_db_queue:create_or_get/1</code>)</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_db_queue.erl:895-930</span></span><br><span class="line"><span class="function"><span class="title">create_or_get</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    rabbit_khepri:handle_fallback(</span><br><span class="line">      #&#123;mnesia =&gt; <span class="keyword">fun</span>() -&gt; create_or_get_in_mnesia(Q) <span class="keyword">end</span>,</span><br><span class="line">        khepri =&gt; <span class="keyword">fun</span>() -&gt; create_or_get_in_khepri(Q) <span class="keyword">end</span></span><br><span class="line">       &#125;).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% Mnesia 实现</span></span><br><span class="line"><span class="function"><span class="title">create_or_get_in_mnesia</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    DurableQ = amqqueue:reset_decorators(Q),</span><br><span class="line">    QueueName = amqqueue:get_name(Q),</span><br><span class="line">    rabbit_mnesia:execute_mnesia_transaction(</span><br><span class="line">      <span class="keyword">fun</span> () -&gt;</span><br><span class="line">              <span class="keyword">case</span> mnesia:wread(&#123;?MNESIA_TABLE, QueueName&#125;) <span class="keyword">of</span></span><br><span class="line">                  [] -&gt;</span><br><span class="line">                      <span class="comment">%% 队列不存在</span></span><br><span class="line">                      <span class="keyword">case</span> get_durable_in_mnesia_tx(QueueName) <span class="keyword">of</span></span><br><span class="line">                          &#123;error, not_found&#125; -&gt;</span><br><span class="line">                              <span class="comment">%% 创建新队列</span></span><br><span class="line">                              set_in_mnesia_tx(DurableQ, Q),</span><br><span class="line">                              &#123;created, Q&#125;;</span><br><span class="line">                          &#123;ok, QRecord&#125; -&gt;</span><br><span class="line">                              <span class="comment">%% 存在持久化记录但运行时不存在</span></span><br><span class="line">                              &#123;absent, QRecord, nodedown&#125;</span><br><span class="line">                      <span class="keyword">end</span>;</span><br><span class="line">                  [ExistingQ] -&gt;</span><br><span class="line">                      <span class="comment">%% 队列已存在</span></span><br><span class="line">                      &#123;existing, ExistingQ&#125;</span><br><span class="line">              <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span>).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% Khepri 实现</span></span><br><span class="line"><span class="function"><span class="title">create_or_get_in_khepri</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    QueueName = amqqueue:get_name(Q),</span><br><span class="line">    Path = khepri_queue_path(QueueName),</span><br><span class="line">    <span class="keyword">case</span> rabbit_khepri:adv_create(Path, Q) <span class="keyword">of</span></span><br><span class="line">        &#123;error, &#123;khepri, mismatching_node, #&#123;node_props := #&#123;data := ExistingQ&#125;&#125;&#125;&#125; -&gt;</span><br><span class="line">            &#123;existing, ExistingQ&#125;;</span><br><span class="line">        &#123;ok, _&#125; -&gt;</span><br><span class="line">            &#123;created, Q&#125;;</span><br><span class="line">        Error -&gt;</span><br><span class="line">            Error</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-进程监督树结构"><a href="#4-进程监督树结构" class="headerlink" title="4. 进程监督树结构"></a>4. 进程监督树结构</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rabbit_sup</span><br><span class="line">├── rabbit_vhost_sup_sup</span><br><span class="line">│   └── rabbit_vhost_sup (per VHost)</span><br><span class="line">│       └── rabbit_amqqueue_sup_sup</span><br><span class="line">│           └── rabbit_amqqueue_sup (per Queue)</span><br><span class="line">│               └── rabbit_amqqueue_process (队列工作进程)</span><br></pre></td></tr></table></figure>

<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">                    rabbit_sup</span><br><span class="line">                        │</span><br><span class="line">                        ▼</span><br><span class="line">              rabbit_vhost_sup_sup</span><br><span class="line">                        │</span><br><span class="line">                        ▼</span><br><span class="line">         ┌──────────────┼──────────────┐</span><br><span class="line">         ▼              ▼              ▼</span><br><span class="line">  rabbit_vhost_sup  rabbit_vhost_sup  ...</span><br><span class="line">   (vhost: /)       (vhost: test)</span><br><span class="line">         │</span><br><span class="line">         ▼</span><br><span class="line">rabbit_amqqueue_sup_sup</span><br><span class="line">         │</span><br><span class="line">         ├──────────────┬──────────────┐</span><br><span class="line">         ▼              ▼              ▼</span><br><span class="line">rabbit_amqqueue_sup  rabbit_amqqueue_sup  ...</span><br><span class="line">  (testqueue1)        (testqueue2)</span><br><span class="line">         │              │</span><br><span class="line">         ▼              ▼</span><br><span class="line">rabbit_amqqueue_     rabbit_amqqueue_</span><br><span class="line">    process              process</span><br><span class="line">   &lt;<span class="number">0.861</span><span class="selector-class">.0</span>&gt;           &lt;<span class="number">0.862</span><span class="selector-class">.0</span>&gt;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-返回结果解析"><a href="#5-返回结果解析" class="headerlink" title="5. 返回结果解析"></a>5. 返回结果解析</h2><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;new, &#123;amqqueue, &#123;resource,&lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;,queue,&lt;&lt;<span class="string">&quot;testqueue2&quot;</span>&gt;&gt;&#125;,</span><br><span class="line">                 false,        <span class="comment">% durable</span></span><br><span class="line">                 false,        <span class="comment">% auto_delete</span></span><br><span class="line">                 none,         <span class="comment">% exclusive_owner</span></span><br><span class="line">                 [],           <span class="comment">% arguments</span></span><br><span class="line">                 &lt;<span class="number">0.862</span>.<span class="number">0</span>&gt;,    <span class="comment">% pid (队列进程)</span></span><br><span class="line">                 [],           <span class="comment">% slave_pids (保留)</span></span><br><span class="line">                 [],           <span class="comment">% sync_slave_pids (保留)</span></span><br><span class="line">                 [],           <span class="comment">% recoverable_slaves (保留)</span></span><br><span class="line">                 undefined,    <span class="comment">% policy</span></span><br><span class="line">                 undefined,    <span class="comment">% operator_policy</span></span><br><span class="line">                 [],           <span class="comment">% gm_pids (保留)</span></span><br><span class="line">                 [],           <span class="comment">% decorators</span></span><br><span class="line">                 live,         <span class="comment">% state</span></span><br><span class="line">                 <span class="number">0</span>,            <span class="comment">% policy_version</span></span><br><span class="line">                 [],           <span class="comment">% type_state</span></span><br><span class="line">                 &lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;,      <span class="comment">% vhost</span></span><br><span class="line">                 #&#123;user =&gt; &lt;&lt;<span class="string">&quot;acting-user&quot;</span>&gt;&gt;&#125;&#125;&#125;  <span class="comment">% options</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>字段</th>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>结果类型</td>
<td><code>new</code></td>
<td>新创建的队列</td>
</tr>
<tr>
<td>name</td>
<td><code>{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;testqueue2&quot;&gt;&gt;}</code></td>
<td>队列资源标识</td>
</tr>
<tr>
<td>durable</td>
<td><code>false</code></td>
<td>非持久化队列</td>
</tr>
<tr>
<td>auto_delete</td>
<td><code>false</code></td>
<td>不自动删除</td>
</tr>
<tr>
<td>exclusive_owner</td>
<td><code>none</code></td>
<td>非独占队列</td>
</tr>
<tr>
<td>arguments</td>
<td><code>[]</code></td>
<td>无额外参数</td>
</tr>
<tr>
<td>pid</td>
<td><code>&lt;0.862.0&gt;</code></td>
<td>队列进程 PID</td>
</tr>
<tr>
<td>state</td>
<td><code>live</code></td>
<td>运行状态</td>
</tr>
<tr>
<td>vhost</td>
<td><code>&lt;&lt;&quot;/&quot;&gt;&gt;</code></td>
<td>所属 VHost</td>
</tr>
<tr>
<td>options</td>
<td><code>#{user =&gt; &lt;&lt;&quot;acting-user&quot;&gt;&gt;}</code></td>
<td>操作用户</td>
</tr>
</tbody></table>
<hr>
<h2 id="6-关键数据流图"><a href="#6-关键数据流图" class="headerlink" title="6. 关键数据流图"></a>6. 关键数据流图</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">输入参数</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_misc:r(<span class="operator">&lt;</span><span class="operator">&lt;</span><span class="string">&quot;/&quot;</span><span class="operator">&gt;</span><span class="operator">&gt;</span>, queue, <span class="operator">&lt;</span><span class="operator">&lt;</span><span class="string">&quot;testqueue2&quot;</span><span class="operator">&gt;</span><span class="operator">&gt;</span>)             │</span><br><span class="line">│     <span class="operator">=</span><span class="operator">&gt;</span> <span class="comment">#resource&#123;virtual_host = &lt;&lt;&quot;/&quot;&gt;&gt;,                    │</span></span><br><span class="line">│                  kind <span class="operator">=</span> queue,                              │</span><br><span class="line">│                  name <span class="operator">=</span> <span class="operator">&lt;</span><span class="operator">&lt;</span><span class="string">&quot;testqueue2&quot;</span><span class="operator">&gt;</span><span class="operator">&gt;</span>&#125;                   │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_amqqueue:declare<span class="symbol">/6</span>                                   │</span><br><span class="line">│   <span class="number">1</span>. check_declare_arguments<span class="symbol">/3</span>  ✓                           │</span><br><span class="line">│   <span class="number">2</span>. get_queue_type<span class="symbol">/2</span> <span class="operator">=</span><span class="operator">&gt;</span> rabbit_classic_queue               │</span><br><span class="line">│   <span class="number">3</span>. amqqueue:new<span class="symbol">/9</span> <span class="operator">=</span><span class="operator">&gt;</span> <span class="comment">#amqqueue&#123;...&#125;                       │</span></span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_queue_type:declare<span class="symbol">/2</span>                                 │</span><br><span class="line">│   <span class="number">1</span>. rabbit_policy:set<span class="symbol">/1</span> <span class="operator">=</span><span class="operator">&gt;</span> 应用策略                         │</span><br><span class="line">│   <span class="number">2</span>. rabbit_queue_decorator:set<span class="symbol">/1</span> <span class="operator">=</span><span class="operator">&gt;</span> 设置装饰器              │</span><br><span class="line">│   <span class="number">3</span>. check_queue_limits<span class="symbol">/1</span> ✓                                 │</span><br><span class="line">│   <span class="number">4</span>. Mod:declare<span class="symbol">/2</span> <span class="operator">=</span><span class="operator">&gt;</span> rabbit_classic_queue:declare<span class="symbol">/2</span>        │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_classic_queue:declare<span class="symbol">/2</span>                              │</span><br><span class="line">│   <span class="number">1</span>. validate_arguments<span class="symbol">/1</span> ✓                                 │</span><br><span class="line">│   <span class="number">2</span>. select_leader_and_followers<span class="symbol">/2</span> <span class="operator">=</span><span class="operator">&gt;</span> 选择节点               │</span><br><span class="line">│   <span class="number">3</span>. rabbit_amqqueue_sup_sup:start_queue_process<span class="symbol">/2</span>          │</span><br><span class="line">│   <span class="number">4</span>. gen_server2:call(&#123;init, new&#125;, infinity)                │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_amqqueue_process                                     │</span><br><span class="line">│   <span class="number">1</span>. init<span class="symbol">/1</span> <span class="operator">=</span><span class="operator">&gt;</span> 初始化进程状态                                │</span><br><span class="line">│   <span class="number">2</span>. handle_call(&#123;init, new&#125;, ...) <span class="operator">=</span><span class="operator">&gt;</span> init_it2<span class="symbol">/3</span>            │</span><br><span class="line">│   <span class="number">3</span>. rabbit_amqqueue:internal_declare<span class="symbol">/2</span>                     │</span><br><span class="line">│   <span class="number">4</span>. rabbit_db_queue:create_or_get<span class="symbol">/1</span>                        │</span><br><span class="line">│   <span class="number">5</span>. 初始化 backing_queue                                   │</span><br><span class="line">│   <span class="number">6</span>. 发送 queue_created 事件                                 │</span><br><span class="line">│   <span class="number">7</span>. 返回 &#123;new, Q&#125;                                          │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_db_queue:create_or_get<span class="symbol">/1</span>                             │</span><br><span class="line">│   <span class="params">Mnesia:</span> mnesia:wread <span class="operator">+</span> mnesia:write                       │</span><br><span class="line">│   <span class="params">Khepri:</span> rabbit_khepri:adv_create                          │</span><br><span class="line">│   <span class="operator">=</span><span class="operator">&gt;</span> &#123;created, Q&#125; | &#123;existing, Q&#125;                           │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">返回结果: &#123;new, <span class="comment">#amqqueue&#123;...&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-时序图"><a href="#7-时序图" class="headerlink" title="7. 时序图"></a>7. 时序图</h2><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Client          rabbit_amqqueue    rabbit_queue_type   rabbit_classic_queue</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line">   │  <span class="keyword">declare</span>/<span class="number">6</span>        │                   │                    │</span><br><span class="line">   │──────────────────▶│                   │                    │</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line">   │                   │ check_arguments   │                    │</span><br><span class="line">   │                   │◀─────────────────▶│                    │</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line">   │                   │ amqqueue:<span class="keyword">new</span>/<span class="number">9</span>    │                    │</span><br><span class="line">   │                   │──────────────────▶│                    │</span><br><span class="line">   │                   │◀──────────────────│                    │</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line">   │                   │ <span class="keyword">declare</span>/<span class="number">2</span>         │                    │</span><br><span class="line">   │                   │──────────────────▶│                    │</span><br><span class="line">   │                   │                   │ <span class="keyword">declare</span>/<span class="number">2</span>          │</span><br><span class="line">   │                   │                   │───────────────────▶│</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line"></span><br><span class="line">rabbit_classic_queue   rabbit_amqqueue_sup_sup   rabbit_amqqueue_process   rabbit_db_queue</span><br><span class="line">         │                      │                        │                      │</span><br><span class="line">         │ start_queue_process  │                        │                      │</span><br><span class="line">         │─────────────────────▶│                        │                      │</span><br><span class="line">         │                      │ supervisor:start_child │                      │</span><br><span class="line">         │                      │───────────────────────▶│                      │</span><br><span class="line">         │                      │◀───────────────────────│                      │</span><br><span class="line">         │◀─────────────────────│                        │                      │</span><br><span class="line">         │                      │                        │                      │</span><br><span class="line">         │ gen_server2:<span class="keyword">call</span>     │                        │                      │</span><br><span class="line">         │  &#123;init, <span class="keyword">new</span>&#125;         │                        │                      │</span><br><span class="line">         │───────────────────────────────────────────────▶│                      │</span><br><span class="line">         │                      │                        │ internal_declare     │</span><br><span class="line">         │                      │                        │─────────────────────▶│</span><br><span class="line">         │                      │                        │ create_or_get        │</span><br><span class="line">         │                      │                        │─────────────────────▶│</span><br><span class="line">         │                      │                        │◀─────────────────────│</span><br><span class="line">         │                      │                        │ &#123;created, Q&#125;         │</span><br><span class="line">         │◀───────────────────────────────────────────────│                      │</span><br><span class="line">         │ &#123;<span class="keyword">new</span>, Q&#125;             │                        │                      │</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-队列类型对比"><a href="#8-队列类型对比" class="headerlink" title="8. 队列类型对比"></a>8. 队列类型对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>Classic Queue</th>
<th>Quorum Queue</th>
<th>Stream Queue</th>
</tr>
</thead>
<tbody><tr>
<td>模块</td>
<td><code>rabbit_classic_queue</code></td>
<td><code>rabbit_quorum_queue</code></td>
<td><code>rabbit_stream_queue</code></td>
</tr>
<tr>
<td>存储</td>
<td><code>rabbit_variable_queue</code></td>
<td>Ra (Raft)</td>
<td>Osiris</td>
</tr>
<tr>
<td>持久化</td>
<td>可选</td>
<td>强制</td>
<td>强制</td>
</tr>
<tr>
<td>复制</td>
<td>不支持</td>
<td>支持 (Raft)</td>
<td>支持</td>
</tr>
<tr>
<td>声明流程</td>
<td><code>gen_server2:call</code></td>
<td><code>ra:start_cluster</code></td>
<td><code>rabbit_stream_coordinator</code></td>
</tr>
</tbody></table>
<hr>
<h2 id="9-错误处理"><a href="#9-错误处理" class="headerlink" title="9. 错误处理"></a>9. 错误处理</h2><h3 id="9-1-常见错误类型"><a href="#9-1-常见错误类型" class="headerlink" title="9.1 常见错误类型"></a>9.1 常见错误类型</h3><table>
<thead>
<tr>
<th>错误</th>
<th>原因</th>
<th>处理</th>
</tr>
</thead>
<tbody><tr>
<td><code>{existing, Q}</code></td>
<td>队列已存在</td>
<td>返回现有队列</td>
</tr>
<tr>
<td><code>{absent, Q, nodedown}</code></td>
<td>节点宕机</td>
<td>返回缺席状态</td>
</tr>
<tr>
<td><code>{error, timeout}</code></td>
<td>数据库超时</td>
<td>返回超时错误</td>
</tr>
<tr>
<td><code>{protocol_error, ...}</code></td>
<td>参数验证失败</td>
<td>返回协议错误</td>
</tr>
</tbody></table>
<h3 id="9-2-队列限制检查"><a href="#9-2-队列限制检查" class="headerlink" title="9.2 队列限制检查"></a>9.2 队列限制检查</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% VHost 队列数量限制</span></span><br><span class="line"><span class="function"><span class="title">check_vhost_queue_limit</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_vhost_limit:is_over_queue_limit(VHost) <span class="keyword">of</span></span><br><span class="line">        <span class="literal">false</span> -&gt; ok;</span><br><span class="line">        &#123;true, Limit&#125; -&gt; queue_limit_error(...)</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 集群队列数量限制</span></span><br><span class="line"><span class="function"><span class="title">check_cluster_queue_limit</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_misc:get_env(rabbit, cluster_queue_limit, infinity) <span class="keyword">of</span></span><br><span class="line">        infinity -&gt; ok;</span><br><span class="line">        Limit <span class="keyword">when</span> Count &gt;= Limit -&gt; queue_limit_error(...);</span><br><span class="line">        _ -&gt; ok</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="10-总结"><a href="#10-总结" class="headerlink" title="10. 总结"></a>10. 总结</h2><h3 id="10-1-完整调用链"><a href="#10-1-完整调用链" class="headerlink" title="10.1 完整调用链"></a>10.1 完整调用链</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">rabbit_misc:r<span class="symbol">/3</span></span><br><span class="line">    ↓</span><br><span class="line">rabbit_amqqueue:declare<span class="symbol">/6</span></span><br><span class="line">    ↓</span><br><span class="line">rabbit_amqqueue:declare<span class="symbol">/7</span></span><br><span class="line">    ↓</span><br><span class="line">    ├── check_declare_arguments<span class="symbol">/3</span></span><br><span class="line">    ├── get_queue_type<span class="symbol">/2</span></span><br><span class="line">    ├── amqqueue:new<span class="symbol">/9</span></span><br><span class="line">    └── rabbit_queue_type:declare<span class="symbol">/2</span></span><br><span class="line">            ↓</span><br><span class="line">            ├── rabbit_policy:set<span class="symbol">/1</span></span><br><span class="line">            ├── rabbit_queue_decorator:set<span class="symbol">/1</span></span><br><span class="line">            ├── check_queue_limits<span class="symbol">/1</span></span><br><span class="line">            └── rabbit_classic_queue:declare<span class="symbol">/2</span></span><br><span class="line">                    ↓</span><br><span class="line">                    ├── validate_arguments<span class="symbol">/1</span></span><br><span class="line">                    ├── rabbit_queue_location:select_leader_and_followers<span class="symbol">/2</span></span><br><span class="line">                    ├── rabbit_amqqueue_sup_sup:start_queue_process<span class="symbol">/2</span></span><br><span class="line">                    │       ↓</span><br><span class="line">                    │       └── supervisor:start_child<span class="symbol">/2</span></span><br><span class="line">                    │               ↓</span><br><span class="line">                    │               └── rabbit_amqqueue_sup:start_link<span class="symbol">/2</span></span><br><span class="line">                    │                       ↓</span><br><span class="line">                    │                       └── rabbit_amqqueue_process:start_link<span class="symbol">/2</span></span><br><span class="line">                    └── gen_server2:call(&#123;init, new&#125;, infinity)</span><br><span class="line">                            ↓</span><br><span class="line">                            └── rabbit_amqqueue_process:init_it2<span class="symbol">/3</span></span><br><span class="line">                                    ↓</span><br><span class="line">                                    ├── rabbit_amqqueue:internal_declare<span class="symbol">/2</span></span><br><span class="line">                                    │       ↓</span><br><span class="line">                                    │       └── rabbit_db_queue:create_or_get<span class="symbol">/1</span></span><br><span class="line">                                    │               ↓</span><br><span class="line">                                    │               └── Mnesia<span class="symbol">/Khepri</span> 写入</span><br><span class="line">                                    ├── bq_init<span class="symbol">/3</span> (backing queue)</span><br><span class="line">                                    ├── notify_decorators<span class="symbol">/2</span></span><br><span class="line">                                    └── rabbit_event:notify(queue_created, ...)</span><br></pre></td></tr></table></figure>

<h3 id="10-2-关键模块职责"><a href="#10-2-关键模块职责" class="headerlink" title="10.2 关键模块职责"></a>10.2 关键模块职责</h3><table>
<thead>
<tr>
<th>模块</th>
<th>职责</th>
</tr>
</thead>
<tbody><tr>
<td><code>rabbit_misc</code></td>
<td>通用工具函数，资源名称构建</td>
</tr>
<tr>
<td><code>rabbit_amqqueue</code></td>
<td>队列管理 API 入口</td>
</tr>
<tr>
<td><code>rabbit_queue_type</code></td>
<td>队列类型抽象层，分发到具体实现</td>
</tr>
<tr>
<td><code>rabbit_classic_queue</code></td>
<td>Classic 队列类型实现</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_sup_sup</code></td>
<td>队列监督者的监督者</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_sup</code></td>
<td>单个队列的监督者</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_process</code></td>
<td>队列工作进程 (gen_server2)</td>
</tr>
<tr>
<td><code>rabbit_db_queue</code></td>
<td>队列数据库操作 (Mnesia&#x2F;Khepri)</td>
</tr>
<tr>
<td><code>rabbit_policy</code></td>
<td>策略匹配和应用</td>
</tr>
<tr>
<td><code>rabbit_queue_decorator</code></td>
<td>队列装饰器管理</td>
</tr>
<tr>
<td><code>amqqueue</code></td>
<td>队列记录定义和操作</td>
</tr>
</tbody></table>
<hr>
<h2 id="11-参考源文件"><a href="#11-参考源文件" class="headerlink" title="11. 参考源文件"></a>11. 参考源文件</h2><table>
<thead>
<tr>
<th>文件</th>
<th>代码行数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>rabbit_amqqueue.erl</code></td>
<td>2142</td>
<td>队列管理主模块</td>
</tr>
<tr>
<td><code>rabbit_queue_type.erl</code></td>
<td>~900</td>
<td>队列类型抽象层</td>
</tr>
<tr>
<td><code>rabbit_classic_queue.erl</code></td>
<td>~600</td>
<td>Classic 队列实现</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_process.erl</code></td>
<td>~1500</td>
<td>队列工作进程</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_sup_sup.erl</code></td>
<td>94</td>
<td>队列监督者管理</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_sup.erl</code></td>
<td>49</td>
<td>单队列监督者</td>
</tr>
<tr>
<td><code>rabbit_db_queue.erl</code></td>
<td>~1000</td>
<td>数据库操作</td>
</tr>
<tr>
<td><code>amqqueue.erl</code></td>
<td>~500</td>
<td>队列记录定义</td>
</tr>
<tr>
<td><code>rabbit_policy.erl</code></td>
<td>~500</td>
<td>策略管理</td>
</tr>
<tr>
<td><code>rabbit_misc.erl</code></td>
<td>~1500</td>
<td>通用工具</td>
</tr>
</tbody></table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/16/erlang-erlang-trace-debugging-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/16/erlang-erlang-trace-debugging-guide/" class="post-title-link" itemprop="url">Erlang Trace 调试技术详解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-16 23:00:00" itemprop="dateCreated datePublished" datetime="2026-01-16T23:00:00+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-17 18:59:55" itemprop="dateModified" datetime="2026-01-17T18:59:55+08:00">2026-01-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/" itemprop="url" rel="index"><span itemprop="name">technology</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/Erlang/" itemprop="url" rel="index"><span itemprop="name">Erlang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Erlang-Trace-调试技术详解"><a href="#Erlang-Trace-调试技术详解" class="headerlink" title="Erlang Trace 调试技术详解"></a>Erlang Trace 调试技术详解</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>与 C&#x2F;C++ 的 GDB 单步调试和 Java IDE（Eclipse&#x2F;IntelliJ IDEA）的断点调试不同，Erlang 采用基于进程的 trace 机制进行调试。本文深入介绍 Erlang 的 trace 调试技术，这是 RabbitMQ 源码分析的重要工具。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><h3 id="推荐书籍"><a href="#推荐书籍" class="headerlink" title="推荐书籍"></a>推荐书籍</h3><ul>
<li><strong><a target="_blank" rel="noopener" href="https://www.erlang-in-anger.com/">Erlang in Anger</a></strong> - 生产环境 Erlang 调试实战指南</li>
<li><strong><a target="_blank" rel="noopener" href="https://www.amazon.com/Erlang-Programming-Concurrent-Approach-Development/dp/0596518188">Erlang Programming</a></strong> - Francesco Cesarini, Simon Thompson</li>
</ul>
<h3 id="技术文档"><a href="#技术文档" class="headerlink" title="技术文档"></a>技术文档</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.erlang-factory.com/upload/presentations/316/dbg[1].pdf">dbg.pdf</a> - Erlang Factory 演讲</li>
<li><a target="_blank" rel="noopener" href="https://www.academia.edu/113957930/Declarative_debugging_of_concurrent_Erlang_programs">Declarative debugging of concurrent Erlang programs</a></li>
<li><a target="_blank" rel="noopener" href="https://www.researchgate.net/publication/220178306_Trace_Analysis_of_Erlang_Programs">Trace Analysis of Erlang Programs</a></li>
<li><a target="_blank" rel="noopener" href="https://esl-conf-static.s3.eu-central-1.amazonaws.com/media/files/000/000/725/original/Peter_Gomori_-_Profiling_and_Tracing_for_all_with_Xprof.pdf">Profiling and Tracing for all with Xprof</a></li>
</ul>
<hr>
<h2 id="Erlang-调试工具总览"><a href="#Erlang-调试工具总览" class="headerlink" title="Erlang 调试工具总览"></a>Erlang 调试工具总览</h2><p>Erlang 提供了多层次的调试工具：</p>
<table>
<thead>
<tr>
<th>工具</th>
<th>层级</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td><code>erlang:trace/3</code></td>
<td>底层 BIF</td>
<td>最基础，所有工具的基础</td>
</tr>
<tr>
<td><code>erlang:trace_pattern/3</code></td>
<td>底层 BIF</td>
<td>函数调用追踪</td>
</tr>
<tr>
<td><code>dbg</code></td>
<td>标准库</td>
<td>基于 trace 的封装，更易用</td>
</tr>
<tr>
<td><code>redbug</code></td>
<td>第三方</td>
<td>生产环境安全的追踪工具</td>
</tr>
<tr>
<td><code>recon_trace</code></td>
<td>第三方</td>
<td>专注函数调用追踪</td>
</tr>
</tbody></table>
<hr>
<h2 id="Trace-基础概念"><a href="#Trace-基础概念" class="headerlink" title="Trace 基础概念"></a>Trace 基础概念</h2><h3 id="可追踪的事件类型"><a href="#可追踪的事件类型" class="headerlink" title="可追踪的事件类型"></a>可追踪的事件类型</h3><p>Trace 可以追踪三大类事件：</p>
<table>
<thead>
<tr>
<th>事件类型</th>
<th>工具</th>
<th>Trace Flag</th>
</tr>
</thead>
<tbody><tr>
<td>进程相关活动和消息传递</td>
<td>trace, dbg, redbug</td>
<td><code>all</code>, <code>send</code>, <code>&#39;receive&#39;</code>, <code>procs</code>, <code>running</code></td>
</tr>
<tr>
<td>垃圾回收和内存使用</td>
<td>trace, dbg, redbug</td>
<td><code>garbage_collection</code>, <code>timestamp</code></td>
</tr>
<tr>
<td>全局和本地函数调用</td>
<td>trace + trace_pattern, dbg, recon_trace</td>
<td><code>call</code>, <code>arity</code>, <code>return_to</code></td>
</tr>
</tbody></table>
<h3 id="Trace-消息格式"><a href="#Trace-消息格式" class="headerlink" title="Trace 消息格式"></a>Trace 消息格式</h3><p>跟踪事件以消息形式发送：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;trace, Pid, Tag, Data1 [,Data2]&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>[,Data2]</code> 是可选字段，依赖于跟踪消息类型。</p>
<hr>
<h2 id="erlang-trace-3-API-详解"><a href="#erlang-trace-3-API-详解" class="headerlink" title="erlang:trace&#x2F;3 API 详解"></a>erlang:trace&#x2F;3 API 详解</h2><h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">erlang:trace(PidSpec, Bool, TraceFlags) -&gt; integer()</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>PidSpec</strong>: 要追踪的进程（<code>all</code>, <code>new</code>, <code>existing</code>, <code>Pid</code>）</li>
<li><strong>Bool</strong>: <code>true</code> 启用追踪，<code>false</code> 禁用</li>
<li><strong>TraceFlags</strong>: 追踪标志列表</li>
<li><strong>返回值</strong>: 被追踪的进程数量</li>
</ul>
<h3 id="重要注意事项"><a href="#重要注意事项" class="headerlink" title="重要注意事项"></a>重要注意事项</h3><ol>
<li><p><strong>Tracer 进程不能被追踪</strong></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 错误：tracer 不能追踪自己</span></span><br><span class="line">erlang:trace(self(), <span class="literal">true</span>, [send]).  <span class="comment">%% badarg error</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>指定其他进程接收追踪消息</strong></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 将追踪消息发送到指定进程</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [send, &#123;tracer, TracerPid&#125;]).</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>终端需要 flush() 查看消息</strong></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪消息在 mailbox 中，需要 flush 显示</span></span><br><span class="line"><span class="number">1</span>&gt; erlang:trace(Pid, <span class="literal">true</span>, [send]).</span><br><span class="line"><span class="number">2</span>&gt; flush().</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="进程和消息追踪"><a href="#进程和消息追踪" class="headerlink" title="进程和消息追踪"></a>进程和消息追踪</h2><h3 id="send-和-‘receive’-追踪"><a href="#send-和-‘receive’-追踪" class="headerlink" title="send 和 ‘receive’ 追踪"></a>send 和 ‘receive’ 追踪</h3><h4 id="send-追踪"><a href="#send-追踪" class="headerlink" title="send 追踪"></a>send 追踪</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 启用发送追踪</span></span><br><span class="line">erlang:trace(Pid, <span class="literal">true</span>, [send]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 追踪消息格式</span></span><br><span class="line">&#123;trace, PidPort, send, Msg, To&#125;</span><br><span class="line">&#123;trace, PidPort, send_to_non_existing_process, Msg, To&#125;</span><br></pre></td></tr></table></figure>

<h4 id="‘receive’-追踪"><a href="#‘receive’-追踪" class="headerlink" title="‘receive’ 追踪"></a>‘receive’ 追踪</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 启用接收追踪（注意：&#x27;receive&#x27; 需要引号，因为是保留字）</span></span><br><span class="line">erlang:trace(Pid, <span class="literal">true</span>, [&#x27;<span class="keyword">receive</span>&#x27;]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 追踪消息格式</span></span><br><span class="line">&#123;trace, PidPort, &#x27;<span class="keyword">receive</span>&#x27;, Msg&#125;</span><br></pre></td></tr></table></figure>

<h3 id="进程生命周期追踪-procs"><a href="#进程生命周期追踪-procs" class="headerlink" title="进程生命周期追踪 (procs)"></a>进程生命周期追踪 (procs)</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪进程创建、退出等事件</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [procs]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 配合 set_on_spawn 追踪新创建的进程</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [set_on_spawn, procs]).</span><br></pre></td></tr></table></figure>

<h3 id="running-追踪"><a href="#running-追踪" class="headerlink" title="running 追踪"></a>running 追踪</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪进程调度（运行/挂起）</span></span><br><span class="line">erlang:trace(Pid, <span class="literal">true</span>, [running, procs]).</span><br></pre></td></tr></table></figure>

<h3 id="垃圾回收追踪"><a href="#垃圾回收追踪" class="headerlink" title="垃圾回收追踪"></a>垃圾回收追踪</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪 GC 事件，带时间戳</span></span><br><span class="line">erlang:trace(Pid, <span class="literal">true</span>, [garbage_collection, timestamp]).</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>: 占用内存太小可能触发不到垃圾回收。</p>
<hr>
<h2 id="函数调用追踪"><a href="#函数调用追踪" class="headerlink" title="函数调用追踪"></a>函数调用追踪</h2><p>函数追踪需要 <code>erlang:trace/3</code> 和 <code>erlang:trace_pattern/3</code> 配合使用。</p>
<h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3><table>
<thead>
<tr>
<th>函数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>erlang:trace/3</code></td>
<td>定义追踪哪些<strong>进程</strong></td>
</tr>
<tr>
<td><code>erlang:trace_pattern/3</code></td>
<td>定义追踪哪些<strong>函数</strong></td>
</tr>
</tbody></table>
<p>只有当<strong>被追踪的进程</strong>调用<strong>被追踪的函数</strong>时，才会产生追踪事件。</p>
<h3 id="trace-pattern-基本语法"><a href="#trace-pattern-基本语法" class="headerlink" title="trace_pattern 基本语法"></a>trace_pattern 基本语法</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">erlang:trace_pattern(MFA, MatchSpec, FlagList) -&gt; integer()</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>MFA</strong>: <code>{Module, Function, Arity}</code> 或 <code>{Module, &#39;_&#39;, &#39;_&#39;}</code></li>
<li><strong>MatchSpec</strong>: 匹配规则（<code>true</code>, <code>[]</code>, 或详细规则）</li>
<li><strong>FlagList</strong>: <code>[global]</code>, <code>[local]</code>, <code>[meta]</code> 等</li>
</ul>
<h3 id="基本示例"><a href="#基本示例" class="headerlink" title="基本示例"></a>基本示例</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 1. 启用进程的函数调用追踪</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [call]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 2. 指定追踪的函数（必须先 load module）</span></span><br><span class="line">erlang:trace_pattern(&#123;mymodule, myfunction, <span class="number">2</span>&#125;, <span class="literal">true</span>, [local]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 注意：模块必须先加载！</span></span><br><span class="line"><span class="function"><span class="title">l</span><span class="params">(mymodule)</span>.  %% 或 <span class="title">code</span>:<span class="title">ensure_loaded</span><span class="params">(mymodule)</span></span></span><br></pre></td></tr></table></figure>

<h3 id="global-vs-local"><a href="#global-vs-local" class="headerlink" title="global vs local"></a>global vs local</h3><table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>global</code></td>
<td>默认值，只追踪外部调用（跨模块调用）</td>
</tr>
<tr>
<td><code>local</code></td>
<td>追踪所有调用，包括模块内部调用</td>
</tr>
</tbody></table>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪所有调用（包括内部调用）</span></span><br><span class="line">erlang:trace_pattern(&#123;mymodule, &#x27;_&#x27;, &#x27;_&#x27;&#125;, <span class="literal">true</span>, [local]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 只追踪外部调用</span></span><br><span class="line">erlang:trace_pattern(&#123;mymodule, &#x27;_&#x27;, &#x27;_&#x27;&#125;, <span class="literal">true</span>, [global]).</span><br></pre></td></tr></table></figure>

<h3 id="return-to-追踪"><a href="#return-to-追踪" class="headerlink" title="return_to 追踪"></a>return_to 追踪</h3><p>追踪函数返回到哪里（只对 <code>local</code> 有效）：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 启用 return_to</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [call, return_to]).</span><br><span class="line">erlang:trace_pattern(&#123;mymodule, &#x27;_&#x27;, &#x27;_&#x27;&#125;, <span class="literal">true</span>, [local]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 追踪消息格式</span></span><br><span class="line">&#123;trace, Pid, return_to, &#123;M, F, A&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>: <code>return_to</code> 无法获取函数返回值！</p>
<h3 id="return-trace-获取返回值"><a href="#return-trace-获取返回值" class="headerlink" title="return_trace 获取返回值"></a>return_trace 获取返回值</h3><p>要获取函数返回值，使用 MatchSpec 中的 <code>{return_trace}</code>：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 使用 return_trace 获取返回值</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [call]).</span><br><span class="line">erlang:trace_pattern(&#123;mymodule, myfunction, <span class="number">1</span>&#125;, [&#123;&#x27;_&#x27;, [], [&#123;return_trace&#125;]&#125;], [local]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 追踪消息格式</span></span><br><span class="line">&#123;trace, Pid, call, &#123;M, F, Args&#125;&#125;</span><br><span class="line">&#123;trace, Pid, return_from, &#123;M, F, Arity&#125;, ReturnValue&#125;</span><br></pre></td></tr></table></figure>

<h3 id="arity-选项"><a href="#arity-选项" class="headerlink" title="arity 选项"></a>arity 选项</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 使用 arity：只显示参数个数，不显示参数内容</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [call, arity]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 不使用 arity：显示完整参数</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [call]).</span><br></pre></td></tr></table></figure>

<p>使用 <code>arity</code> 可以减少追踪消息大小。</p>
<hr>
<h2 id="Match-Specifications"><a href="#Match-Specifications" class="headerlink" title="Match Specifications"></a>Match Specifications</h2><p>Match Specifications 是强大的过滤和操作机制。</p>
<h3 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MatchSpec = [&#123;MatchHead, MatchConditions, MatchBody&#125;]</span><br></pre></td></tr></table></figure>

<h3 id="使用-dbg-fun2ms-1-生成"><a href="#使用-dbg-fun2ms-1-生成" class="headerlink" title="使用 dbg:fun2ms&#x2F;1 生成"></a>使用 dbg:fun2ms&#x2F;1 生成</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 使用 fun2ms 生成 MatchSpec</span></span><br><span class="line"><span class="number">1</span>&gt; dbg:fun2ms(<span class="keyword">fun</span>([A, B]) <span class="keyword">when</span> A &gt; <span class="number">10</span> -&gt; return_trace() <span class="keyword">end</span>).</span><br><span class="line">[&#123;[&#x27;<span class="string">$1</span>&#x27;,&#x27;<span class="string">$2</span>&#x27;],[&#123;&#x27;&gt;&#x27;,&#x27;<span class="string">$1</span>&#x27;,<span class="number">10</span>&#125;],[&#123;return_trace&#125;]&#125;]</span><br></pre></td></tr></table></figure>

<h3 id="常用-MatchSpec-示例"><a href="#常用-MatchSpec-示例" class="headerlink" title="常用 MatchSpec 示例"></a>常用 MatchSpec 示例</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪所有调用并返回值</span></span><br><span class="line">erlang:trace_pattern(&#123;M, F, A&#125;, [&#123;&#x27;_&#x27;, [], [&#123;return_trace&#125;]&#125;], [local]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 追踪特定参数值</span></span><br><span class="line">erlang:trace_pattern(&#123;M, F, <span class="number">1</span>&#125;, [&#123;[&#x27;<span class="string">$1</span>&#x27;], [&#123;&#x27;==&#x27;, &#x27;<span class="string">$1</span>&#x27;, foo&#125;], []&#125;], [local]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 追踪并打印消息</span></span><br><span class="line">erlang:trace_pattern(&#123;M, F, A&#125;, [&#123;&#x27;_&#x27;, [], [&#123;message, &#123;process_dump&#125;&#125;]&#125;], [local]).</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="dbg-模块"><a href="#dbg-模块" class="headerlink" title="dbg 模块"></a>dbg 模块</h2><p><code>dbg</code> 是基于 <code>erlang:trace/3</code> 的高级封装，使用更简便。</p>
<h3 id="基本使用流程"><a href="#基本使用流程" class="headerlink" title="基本使用流程"></a>基本使用流程</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 1. 启动 tracer</span></span><br><span class="line">dbg:tracer().</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 2. 设置追踪的进程</span></span><br><span class="line">dbg:p(all, c).  <span class="comment">%% all 进程，c = call</span></span><br><span class="line"></span><br><span class="line"><span class="comment">%% 3. 设置追踪的函数</span></span><br><span class="line">dbg:tpl(mymodule, myfunction, x).  <span class="comment">%% x = 所有 arity</span></span><br><span class="line"></span><br><span class="line"><span class="comment">%% 4. 停止追踪</span></span><br><span class="line">dbg:stop_clear().</span><br></pre></td></tr></table></figure>

<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>dbg:tracer()</code></td>
<td>启动默认 tracer</td>
</tr>
<tr>
<td><code>dbg:p(PidSpec, Flags)</code></td>
<td>设置进程追踪</td>
</tr>
<tr>
<td><code>dbg:tp(M, F, A, MS)</code></td>
<td>追踪全局函数调用</td>
</tr>
<tr>
<td><code>dbg:tpl(M, F, A, MS)</code></td>
<td>追踪本地+全局函数调用</td>
</tr>
<tr>
<td><code>dbg:ctp(M, F, A)</code></td>
<td>清除追踪模式</td>
</tr>
<tr>
<td><code>dbg:stop()</code></td>
<td>停止 tracer</td>
</tr>
<tr>
<td><code>dbg:stop_clear()</code></td>
<td>停止并清除所有追踪</td>
</tr>
</tbody></table>
<h3 id="dbg-p-2-的-Flags"><a href="#dbg-p-2-的-Flags" class="headerlink" title="dbg:p&#x2F;2 的 Flags"></a>dbg:p&#x2F;2 的 Flags</h3><table>
<thead>
<tr>
<th>Flag</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>c</code></td>
<td>call - 函数调用</td>
</tr>
<tr>
<td><code>s</code></td>
<td>send - 发送消息</td>
</tr>
<tr>
<td><code>r</code></td>
<td>receive - 接收消息</td>
</tr>
<tr>
<td><code>m</code></td>
<td>messages - send + receive</td>
</tr>
<tr>
<td><code>p</code></td>
<td>procs - 进程事件</td>
</tr>
<tr>
<td><code>sos</code></td>
<td>set_on_spawn</td>
</tr>
<tr>
<td><code>sol</code></td>
<td>set_on_link</td>
</tr>
</tbody></table>
<h3 id="实际示例"><a href="#实际示例" class="headerlink" title="实际示例"></a>实际示例</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪 lists:seq/2 的调用</span></span><br><span class="line"><span class="number">1</span>&gt; dbg:tracer().</span><br><span class="line">&#123;ok,&lt;<span class="number">0.90</span>.<span class="number">0</span>&gt;&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>&gt; dbg:p(all, c).</span><br><span class="line">&#123;ok,[&#123;matched,nonode@nohost,<span class="number">26</span>&#125;]&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>&gt; dbg:tpl(lists, seq, x).</span><br><span class="line">&#123;ok,[&#123;matched,nonode@nohost,<span class="number">2</span>&#125;]&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>&gt; lists:seq(<span class="number">1</span>, <span class="number">5</span>).</span><br><span class="line">(&lt;<span class="number">0.84</span>.<span class="number">0</span>&gt;) call lists:seq(<span class="number">1</span>,<span class="number">5</span>)</span><br><span class="line">[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>&gt; dbg:stop_clear().</span><br><span class="line">ok</span><br></pre></td></tr></table></figure>

<h3 id="带返回值的追踪"><a href="#带返回值的追踪" class="headerlink" title="带返回值的追踪"></a>带返回值的追踪</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 使用 dbg:fun2ms 生成带 return_trace 的 MatchSpec</span></span><br><span class="line"><span class="number">1</span>&gt; dbg:tracer().</span><br><span class="line"><span class="number">2</span>&gt; dbg:p(all, c).</span><br><span class="line"><span class="number">3</span>&gt; dbg:tpl(lists, seq, dbg:fun2ms(<span class="keyword">fun</span>(_) -&gt; return_trace() <span class="keyword">end</span>)).</span><br><span class="line"><span class="number">4</span>&gt; lists:seq(<span class="number">1</span>, <span class="number">3</span>).</span><br><span class="line">(&lt;<span class="number">0.84</span>.<span class="number">0</span>&gt;) call lists:seq(<span class="number">1</span>,<span class="number">3</span>)</span><br><span class="line">(&lt;<span class="number">0.84</span>.<span class="number">0</span>&gt;) returned from lists:seq/<span class="number">2</span> -&gt; [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="recon-trace"><a href="#recon-trace" class="headerlink" title="recon_trace"></a>recon_trace</h2><p><code>recon_trace</code> 是生产环境安全的追踪工具，来自 <code>recon</code> 库。</p>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul>
<li>自动限制追踪消息数量，防止系统过载</li>
<li>只能追踪函数调用，不能追踪消息</li>
<li>生产环境推荐使用</li>
</ul>
<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪 10 次调用</span></span><br><span class="line">recon_trace:calls(&#123;lists, seq, <span class="number">2</span>&#125;, <span class="number">10</span>).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 带返回值</span></span><br><span class="line">recon_trace:calls(&#123;lists, seq, <span class="number">2</span>&#125;, <span class="number">10</span>, [&#123;scope, local&#125;]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 追踪特定进程</span></span><br><span class="line">recon_trace:calls(&#123;M, F, A&#125;, <span class="number">10</span>, [&#123;pid, Pid&#125;]).</span><br></pre></td></tr></table></figure>

<h3 id="重要提示"><a href="#重要提示" class="headerlink" title="重要提示"></a>重要提示</h3><p>使用 <code>recon_trace</code> 前，需要预加载所有要追踪的模块：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 加载所有 beam 文件对应的模块</span></span><br><span class="line">LP = <span class="keyword">fun</span>() -&gt; </span><br><span class="line">    [code:ensure_loaded(list_to_atom(filename:rootname(filename:basename(F)))) </span><br><span class="line">     || P &lt;- code:get_path(), F &lt;- filelib:wildcard(P ++ <span class="string">&quot;/*.beam&quot;</span>)] </span><br><span class="line"><span class="keyword">end</span>.</span><br><span class="line">LP().</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="实战技巧"><a href="#实战技巧" class="headerlink" title="实战技巧"></a>实战技巧</h2><h3 id="1-追踪-RabbitMQ-函数调用"><a href="#1-追踪-RabbitMQ-函数调用" class="headerlink" title="1. 追踪 RabbitMQ 函数调用"></a>1. 追踪 RabbitMQ 函数调用</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪 rabbit_channel 模块</span></span><br><span class="line"><span class="number">1</span>&gt; dbg:tracer().</span><br><span class="line"><span class="number">2</span>&gt; dbg:p(all, c).</span><br><span class="line"><span class="number">3</span>&gt; dbg:tpl(rabbit_channel, handle_cast, x).</span><br><span class="line"><span class="number">4</span>&gt; <span class="comment">%% 执行相关操作...</span></span><br><span class="line"><span class="number">5</span>&gt; dbg:stop_clear().</span><br></pre></td></tr></table></figure>

<h3 id="2-追踪消息传递"><a href="#2-追踪消息传递" class="headerlink" title="2. 追踪消息传递"></a>2. 追踪消息传递</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪特定进程的消息</span></span><br><span class="line"><span class="number">1</span>&gt; Pid = whereis(rabbit_reader).</span><br><span class="line"><span class="number">2</span>&gt; erlang:trace(Pid, <span class="literal">true</span>, [send, &#x27;<span class="keyword">receive</span>&#x27;]).</span><br><span class="line"><span class="number">3</span>&gt; flush().  <span class="comment">%% 查看追踪消息</span></span><br><span class="line"><span class="number">4</span>&gt; erlang:trace(Pid, <span class="literal">false</span>, [send, &#x27;<span class="keyword">receive</span>&#x27;]).  <span class="comment">%% 停止追踪</span></span><br></pre></td></tr></table></figure>

<h3 id="3-生产环境安全追踪"><a href="#3-生产环境安全追踪" class="headerlink" title="3. 生产环境安全追踪"></a>3. 生产环境安全追踪</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 使用 recon_trace，限制 100 次调用</span></span><br><span class="line">recon_trace:calls(&#123;rabbit_channel, handle_cast, &#x27;_&#x27;&#125;, <span class="number">100</span>).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 10 秒后自动停止</span></span><br><span class="line">recon_trace:calls(&#123;rabbit_channel, handle_cast, &#x27;_&#x27;&#125;, &#123;<span class="number">100</span>, <span class="number">10000</span>&#125;).</span><br></pre></td></tr></table></figure>

<h3 id="4-追踪特定参数的调用"><a href="#4-追踪特定参数的调用" class="headerlink" title="4. 追踪特定参数的调用"></a>4. 追踪特定参数的调用</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 只追踪第一个参数为 foo 的调用</span></span><br><span class="line">MS = dbg:fun2ms(<span class="keyword">fun</span>([foo, _]) -&gt; return_trace() <span class="keyword">end</span>).</span><br><span class="line">dbg:tpl(mymodule, myfunction, MS).</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="Q-为什么-trace-pattern-不生效？"><a href="#Q-为什么-trace-pattern-不生效？" class="headerlink" title="Q: 为什么 trace_pattern 不生效？"></a>Q: 为什么 trace_pattern 不生效？</h3><ol>
<li>模块未加载：先执行 <code>l(module)</code> 或 <code>code:ensure_loaded(module)</code></li>
<li>只使用了 trace 或 trace_pattern 其中一个：两者必须配合使用</li>
<li>使用了 <code>global</code> 但调用是模块内部调用：改用 <code>local</code></li>
</ol>
<h3 id="Q-如何获取函数返回值？"><a href="#Q-如何获取函数返回值？" class="headerlink" title="Q: 如何获取函数返回值？"></a>Q: 如何获取函数返回值？</h3><p>使用 <code>return_trace</code> MatchSpec，而不是 <code>return_to</code> flag：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">erlang:trace_pattern(&#123;M, F, A&#125;, [&#123;&#x27;_&#x27;, [], [&#123;return_trace&#125;]&#125;], [local]).</span><br></pre></td></tr></table></figure>

<h3 id="Q-为什么看不到追踪消息？"><a href="#Q-为什么看不到追踪消息？" class="headerlink" title="Q: 为什么看不到追踪消息？"></a>Q: 为什么看不到追踪消息？</h3><ol>
<li>终端作为 tracer 时需要 <code>flush()</code></li>
<li>tracer 进程不能追踪自己</li>
<li>检查 trace 和 trace_pattern 是否都设置了</li>
</ol>
<h3 id="Q-如何追踪新创建的进程？"><a href="#Q-如何追踪新创建的进程？" class="headerlink" title="Q: 如何追踪新创建的进程？"></a>Q: 如何追踪新创建的进程？</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 使用 set_on_spawn</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [set_on_spawn, procs, call]).</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><table>
<thead>
<tr>
<th>场景</th>
<th>推荐工具</th>
</tr>
</thead>
<tbody><tr>
<td>开发环境快速调试</td>
<td><code>dbg</code></td>
</tr>
<tr>
<td>生产环境安全追踪</td>
<td><code>recon_trace</code></td>
</tr>
<tr>
<td>精细控制</td>
<td><code>erlang:trace/3</code> + <code>erlang:trace_pattern/3</code></td>
</tr>
<tr>
<td>消息追踪</td>
<td><code>erlang:trace/3</code> 的 <code>send</code>&#x2F;<code>&#39;receive&#39;</code></td>
</tr>
<tr>
<td>进程追踪</td>
<td><code>erlang:trace/3</code> 的 <code>procs</code></td>
</tr>
</tbody></table>
<p>掌握 Erlang trace 技术是深入理解 RabbitMQ 等 Erlang 系统的关键。通过合理使用这些工具，可以有效地进行问题排查和性能分析。</p>
<hr>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/erlang.html#trace-3">Erlang trace&#x2F;3 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/erlang.html#trace_pattern-3">Erlang trace_pattern&#x2F;3 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/dbg.html">Erlang dbg 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="http://erlang.org/documentation/doc-7.0/erts-7.0/doc/html/match_spec.html">Match Specifications in Erlang</a></li>
<li><a target="_blank" rel="noopener" href="http://stratus3d.com/blog/2021/08/24/guide-to-tracing-in-erlang/">Guide to Tracing in Erlang</a></li>
<li><a target="_blank" rel="noopener" href="https://ferd.github.io/recon/">recon 库文档</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/16/rabbitmq-rabbitmq-complete-build-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/16/rabbitmq-rabbitmq-complete-build-guide/" class="post-title-link" itemprop="url">RabbitMQ 编译构建完全指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-16 22:30:00 / 修改时间：22:41:31" itemprop="dateCreated datePublished" datetime="2026-01-16T22:30:00+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RabbitMQ-编译构建完全指南"><a href="#RabbitMQ-编译构建完全指南" class="headerlink" title="RabbitMQ 编译构建完全指南"></a>RabbitMQ 编译构建完全指南</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>基于 RabbitMQ 4.0.5 源码深度分析和实际构建验证，本文档全面解析各种编译方式的技术原理、实现机制和最佳实践。</p>
<h2 id="快速对比表"><a href="#快速对比表" class="headerlink" title="快速对比表"></a>快速对比表</h2><h3 id="构建命令"><a href="#构建命令" class="headerlink" title="构建命令"></a>构建命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
<th>输出格式</th>
<th>部署方式</th>
<th>编译时间</th>
<th>磁盘占用</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>make</code></td>
<td>编译</td>
<td>源码目录 + beam 文件</td>
<td>开发调试</td>
<td>最快</td>
<td>中等</td>
<td>本地开发、调试</td>
</tr>
<tr>
<td><code>make dist</code></td>
<td>打包文件</td>
<td>插件目录结构</td>
<td>目录部署</td>
<td>快</td>
<td>大</td>
<td>生产环境、插件开发</td>
</tr>
<tr>
<td><code>make dist DIST_AS_EZS=true</code></td>
<td>打包成 ez 文件</td>
<td>.ez 压缩包</td>
<td>插件安装</td>
<td>中等</td>
<td>小</td>
<td>插件分发、热加载</td>
</tr>
<tr>
<td><code>make source-dist</code></td>
<td>创建源码包</td>
<td>tar.xz 源码归档</td>
<td>源码分发</td>
<td>快</td>
<td>小</td>
<td>离线构建、版本发布</td>
</tr>
<tr>
<td><code>make package-generic-unix</code></td>
<td>打包成 PACKAGE 文件</td>
<td>tar.xz 包</td>
<td>解压安装</td>
<td>慢</td>
<td>最小</td>
<td>容器、跨平台</td>
</tr>
<tr>
<td><code>make install</code></td>
<td>安装到系统</td>
<td>系统目录</td>
<td>系统安装</td>
<td>中等</td>
<td>中等</td>
<td>生产部署</td>
</tr>
<tr>
<td><code>make install PREFIX=/opt/rabbitmq</code></td>
<td>安装到指定目录</td>
<td>自定义目录</td>
<td>自定义安装</td>
<td>中等</td>
<td>中等</td>
<td>自定义部署路径</td>
</tr>
</tbody></table>
<h3 id="开发调试命令"><a href="#开发调试命令" class="headerlink" title="开发调试命令"></a>开发调试命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>make run-broker</code></td>
<td>启动 RabbitMQ 服务器（前台运行）</td>
<td>开发调试、日志查看</td>
</tr>
<tr>
<td><code>make run-broker PLUGINS=&quot;plugin_name&quot;</code></td>
<td>启动并加载指定插件</td>
<td>插件测试、功能验证</td>
</tr>
<tr>
<td><code>make shell</code></td>
<td>进入 Erlang Shell</td>
<td>代码调试、模块测试</td>
</tr>
<tr>
<td><code>make run-background-broker</code></td>
<td>后台启动 RabbitMQ</td>
<td>自动化测试</td>
</tr>
<tr>
<td><code>make run-node</code></td>
<td>启动裸 Erlang 节点（无 RabbitMQ）</td>
<td>Erlang 调试</td>
</tr>
</tbody></table>
<hr>
<h2 id="1-make-基础编译"><a href="#1-make-基础编译" class="headerlink" title="1. make - 基础编译"></a>1. <code>make</code> - 基础编译</h2><h3 id="技术原理"><a href="#技术原理" class="headerlink" title="技术原理"></a>技术原理</h3><p>基于 <strong>erlang.mk</strong> 构建系统，执行 Erlang&#x2F;OTP 标准编译流程。</p>
<h4 id="核心实现机制"><a href="#核心实现机制" class="headerlink" title="核心实现机制"></a>核心实现机制</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile (第 77 行)</span></span><br><span class="line"><span class="keyword">include</span> erlang.mk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 来源：erlang.mk 核心逻辑</span></span><br><span class="line"><span class="section">app:: deps <span class="variable">$(PROJECT)</span>.d</span></span><br><span class="line">  <span class="variable">$(verbose)</span> <span class="variable">$(MAKE)</span> --no-print-directory app-build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认目标继承自 erlang.mk</span></span><br><span class="line"><span class="comment"># 编译流程：</span></span><br><span class="line"><span class="comment"># 1. 编译依赖 (deps)</span></span><br><span class="line"><span class="comment"># 2. 编译核心应用 (app)  </span></span><br><span class="line"><span class="comment"># 3. 生成启动脚本</span></span><br></pre></td></tr></table></figure>

<h4 id="编译流程"><a href="#编译流程" class="headerlink" title="编译流程"></a>编译流程</h4><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">  ↓</span><br><span class="line">解析依赖</span><br><span class="line">  ↓</span><br><span class="line">编译 deps/</span><br><span class="line">  ↓</span><br><span class="line">编译 <span class="string">.erl</span> → <span class="string">.beam</span></span><br><span class="line">  ↓</span><br><span class="line">生成启动脚本</span><br><span class="line">  ↓</span><br><span class="line">创建 sbin/ 目录</span><br></pre></td></tr></table></figure>

<h3 id="实际生成的文件结构"><a href="#实际生成的文件结构" class="headerlink" title="实际生成的文件结构"></a>实际生成的文件结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-server/</span><br><span class="line">├── deps/                          <span class="comment"># 依赖模块</span></span><br><span class="line">│   ├── rabbit/ebin/*.beam        <span class="comment"># 核心模块字节码</span></span><br><span class="line">│   ├── rabbit_common/ebin/*.beam <span class="comment"># 公共模块字节码</span></span><br><span class="line">│   └── */ebin/*.beam             <span class="comment"># 其他插件字节码</span></span><br><span class="line">├── sbin/                         <span class="comment"># 启动脚本 (25 个文件)</span></span><br><span class="line">│   ├── rabbitmq-server          <span class="comment"># 主服务器脚本</span></span><br><span class="line">│   ├── rabbitmqctl              <span class="comment"># 管理工具</span></span><br><span class="line">│   ├── rabbitmq-plugins         <span class="comment"># 插件管理</span></span><br><span class="line">│   └── ...                      <span class="comment"># 其他管理脚本</span></span><br><span class="line">└── escript/                      <span class="comment"># Erlang 脚本</span></span><br></pre></td></tr></table></figure>

<h3 id="使用场景与最佳实践"><a href="#使用场景与最佳实践" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 快速开发迭代</span></span><br><span class="line">make clean &amp;&amp; make</span><br><span class="line">sbin/rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 增量编译（推荐）</span></span><br><span class="line">make  <span class="comment"># 只编译修改的文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 开发调试</span></span><br><span class="line">make shell  <span class="comment"># 进入 Erlang shell</span></span><br></pre></td></tr></table></figure>

<h4 id="性能特点"><a href="#性能特点" class="headerlink" title="性能特点"></a>性能特点</h4><ul>
<li><strong>编译时间</strong>: 最快（支持增量编译）</li>
<li><strong>磁盘占用</strong>: 中等（包含源码和字节码）</li>
<li><strong>内存使用</strong>: 低</li>
<li><strong>适用场景</strong>: 开发调试、源码修改、性能测试</li>
</ul>
<hr>
<h2 id="2-make-dist-插件目录分发"><a href="#2-make-dist-插件目录分发" class="headerlink" title="2. make dist - 插件目录分发"></a>2. <code>make dist</code> - 插件目录分发</h2><h3 id="技术原理-1"><a href="#技术原理-1" class="headerlink" title="技术原理"></a>技术原理</h3><p>基于 <strong>rabbitmq-dist.mk</strong> 实现插件打包机制，创建标准的 RabbitMQ 插件目录结构。</p>
<h4 id="核心实现源码"><a href="#核心实现源码" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-dist.mk (第 166 行)</span></span><br><span class="line"><span class="section">dist:: <span class="variable">$(ERLANG_MK_RECURSIVE_DEPS_LIST)</span> all</span></span><br><span class="line">  <span class="variable">$(verbose)</span> rm -rf <span class="variable">$(DIST_DIR)</span></span><br><span class="line">  <span class="variable">$(verbose)</span> mkdir -p <span class="variable">$(DIST_DIR)</span></span><br><span class="line">  <span class="variable">$(gen_verbose)</span> <span class="variable">$(MAKE)</span> --no-print-directory do-dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件目录创建逻辑 (第 48-54 行)</span></span><br><span class="line">dist_$(1)_ez_dir = $<span class="variable">$(<span class="built_in">if</span> $(2)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)-$(2), \</span><br><span class="line">  $<span class="variable">$(<span class="built_in">if</span> $<span class="variable">$(VERSION)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)</span>-$<span class="variable">$(VERSION)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)))</span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(DIST_AS_EZS)</span>,)</span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir)  <span class="comment"># 目录格式</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir).ez  <span class="comment"># EZ 格式</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<h4 id="打包流程详解"><a href="#打包流程详解" class="headerlink" title="打包流程详解"></a>打包流程详解</h4><ol>
<li><strong>编译所有模块</strong> - 确保所有 <code>.erl</code> 文件编译为 <code>.beam</code></li>
<li><strong>收集依赖</strong> - 将所有插件和依赖收集到 <code>plugins/</code> 目录</li>
<li><strong>生成插件结构</strong> - 每个插件包含 <code>ebin/</code>、<code>priv/</code> 等标准目录</li>
<li><strong>创建元数据</strong> - 生成 <code>.app</code> 文件描述插件信息</li>
</ol>
<h3 id="实际生成的目录结构"><a href="#实际生成的目录结构" class="headerlink" title="实际生成的目录结构"></a>实际生成的目录结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">plugins/</span><br><span class="line">├── rabbit-4.0.5/                 <span class="comment"># 核心模块目录</span></span><br><span class="line">│   ├── ebin/</span><br><span class="line">│   │   ├── rabbit.app            <span class="comment"># 应用描述文件</span></span><br><span class="line">│   │   ├── rabbit.beam           <span class="comment"># 编译后的字节码</span></span><br><span class="line">│   │   └── *.beam                <span class="comment"># 其他模块字节码</span></span><br><span class="line">│   ├── include/                  <span class="comment"># 头文件</span></span><br><span class="line">│   └── priv/                     <span class="comment"># 私有资源</span></span><br><span class="line">├── rabbitmq_management-4.0.5/    <span class="comment"># 管理插件目录</span></span><br><span class="line">├── rabbitmq_prometheus-4.0.5/    <span class="comment"># 监控插件目录</span></span><br><span class="line">└── ...                           <span class="comment"># 其他插件目录</span></span><br></pre></td></tr></table></figure>

<h3 id="使用场景与最佳实践-1"><a href="#使用场景与最佳实践-1" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="生产环境"><a href="#生产环境" class="headerlink" title="生产环境"></a>生产环境</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 创建发布版本</span></span><br><span class="line">make dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 验证插件结构</span></span><br><span class="line"><span class="built_in">ls</span> -la plugins/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 部署到生产环境</span></span><br><span class="line">rsync -av plugins/ /opt/rabbitmq/plugins/</span><br></pre></td></tr></table></figure>

<h4 id="插件开发"><a href="#插件开发" class="headerlink" title="插件开发"></a>插件开发</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 开发模式</span></span><br><span class="line">make dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 插件测试</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;plugin_name&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-make-dist-DIST-AS-EZS-true-EZ-压缩包分发"><a href="#3-make-dist-DIST-AS-EZS-true-EZ-压缩包分发" class="headerlink" title="3. make dist DIST_AS_EZS=true - EZ 压缩包分发"></a>3. <code>make dist DIST_AS_EZS=true</code> - EZ 压缩包分发</h2><h3 id="技术原理-2"><a href="#技术原理-2" class="headerlink" title="技术原理"></a>技术原理</h3><p>EZ 格式是 Erlang 的标准插件打包格式，本质上是重命名的 ZIP 文件。</p>
<h4 id="核心实现逻辑"><a href="#核心实现逻辑" class="headerlink" title="核心实现逻辑"></a>核心实现逻辑</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-dist.mk (第 8-14 行)</span></span><br><span class="line"><span class="comment"># Set $(DIST_AS_EZS) to a non-empty value to enable the packaging of</span></span><br><span class="line"><span class="comment"># plugins as .ez archives.</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(USE_RABBIT_BOOT_SCRIPT)</span>,)</span><br><span class="line">DIST_AS_EZS ?=                    <span class="comment"># 默认为空（目录格式）</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">DIST_AS_EZS =                     <span class="comment"># 强制目录格式</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<h4 id="EZ-文件生成流程"><a href="#EZ-文件生成流程" class="headerlink" title="EZ 文件生成流程"></a>EZ 文件生成流程</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">make dist DIST_AS_EZS<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">  ↓</span><br><span class="line">编译所有模块</span><br><span class="line">  ↓</span><br><span class="line">收集 ebin<span class="symbol">/</span> include<span class="symbol">/</span> priv<span class="symbol">/</span></span><br><span class="line">  ↓</span><br><span class="line">创建临时目录结构</span><br><span class="line">  ↓</span><br><span class="line">ZIP 压缩</span><br><span class="line">  ↓</span><br><span class="line">重命名为 .ez</span><br><span class="line">  ↓</span><br><span class="line">移动到 plugins<span class="operator">/</span></span><br></pre></td></tr></table></figure>

<h3 id="实际生成的-EZ-文件（已验证）"><a href="#实际生成的-EZ-文件（已验证）" class="headerlink" title="实际生成的 EZ 文件（已验证）"></a>实际生成的 EZ 文件（已验证）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">plugins/</span><br><span class="line">├── rabbit-4.0.5.ez              <span class="comment"># 3.38 MB - 核心模块</span></span><br><span class="line">├── rabbit_common-4.0.5.ez       <span class="comment"># 770.91 KB - 公共模块  </span></span><br><span class="line">├── rabbitmq_management-4.0.5.ez <span class="comment"># 管理界面插件</span></span><br><span class="line">├── rabbitmq_prometheus-4.0.5.ez <span class="comment"># 监控插件</span></span><br><span class="line">├── amqp_client-4.0.5.ez         <span class="comment"># 332.75 KB - AMQP 客户端</span></span><br><span class="line">├── cowboy-2.12.0.ez             <span class="comment"># 350.76 KB - HTTP 服务器</span></span><br><span class="line">├── gun-1.3.3.ez                 <span class="comment"># 109.35 KB - HTTP 客户端</span></span><br><span class="line">└── ...                          <span class="comment"># 其他插件 EZ 文件</span></span><br></pre></td></tr></table></figure>

<h3 id="EZ-格式深度分析"><a href="#EZ-格式深度分析" class="headerlink" title="EZ 格式深度分析"></a>EZ 格式深度分析</h3><h4 id="EZ-文件内部结构"><a href="#EZ-文件内部结构" class="headerlink" title="EZ 文件内部结构"></a>EZ 文件内部结构</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EZ 文件实际上是 ZIP 格式</span></span><br><span class="line">$ unzip -l rabbit-4.0.5.ez</span><br><span class="line">Archive:  rabbit-4.0.5.ez</span><br><span class="line">  Length      Date    Time    Name</span><br><span class="line">---------  ---------- -----   ----</span><br><span class="line">     1234  2025-01-16 22:05   rabbit-4.0.5/ebin/rabbit.app</span><br><span class="line">    45678  2025-01-16 22:05   rabbit-4.0.5/ebin/rabbit.beam</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<h4 id="目录-vs-EZ-格式对比"><a href="#目录-vs-EZ-格式对比" class="headerlink" title="目录 vs EZ 格式对比"></a>目录 vs EZ 格式对比</h4><table>
<thead>
<tr>
<th>特性</th>
<th>目录格式</th>
<th>EZ 格式</th>
</tr>
</thead>
<tbody><tr>
<td><strong>存储</strong></td>
<td>展开的文件夹</td>
<td>压缩的 ZIP 文件</td>
</tr>
<tr>
<td><strong>加载速度</strong></td>
<td>快速</td>
<td>略慢（需解压）</td>
</tr>
<tr>
<td><strong>调试</strong></td>
<td>容易（直接访问文件）</td>
<td>困难（需解压查看）</td>
</tr>
<tr>
<td><strong>分发</strong></td>
<td>占用空间大</td>
<td>占用空间小</td>
</tr>
<tr>
<td><strong>热加载</strong></td>
<td>支持</td>
<td>更好支持</td>
</tr>
<tr>
<td><strong>版本管理</strong></td>
<td>复杂</td>
<td>简单（文件名包含版本）</td>
</tr>
</tbody></table>
<h3 id="EZ-格式优势"><a href="#EZ-格式优势" class="headerlink" title="EZ 格式优势"></a>EZ 格式优势</h3><ol>
<li><strong>压缩存储</strong>: 减少磁盘占用和网络传输</li>
<li><strong>原子性</strong>: 单文件部署，避免部分文件丢失</li>
<li><strong>版本管理</strong>: 文件名包含版本信息</li>
<li><strong>热加载</strong>: Erlang VM 原生支持 EZ 文件热加载</li>
</ol>
<h3 id="使用场景与最佳实践-2"><a href="#使用场景与最佳实践-2" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="插件分发"><a href="#插件分发" class="headerlink" title="插件分发"></a>插件分发</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 插件开发者</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 生成 .ez 文件用于分发</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 插件用户</span></span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> plugin_name</span><br><span class="line"><span class="comment"># 从 .ez 文件安装插件</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-make-source-dist-源码分发包"><a href="#4-make-source-dist-源码分发包" class="headerlink" title="4. make source-dist - 源码分发包"></a>4. <code>make source-dist</code> - 源码分发包</h2><h3 id="技术原理-3"><a href="#技术原理-3" class="headerlink" title="技术原理"></a>技术原理</h3><p><code>make source-dist</code> 创建一个完整的、可复现的源码归档包（tar.xz），包含所有依赖和构建所需的文件。这是 <code>make package-generic-unix</code> 的前置步骤。</p>
<h4 id="核心实现源码-1"><a href="#核心实现源码-1" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile (第 142-152 行)</span></span><br><span class="line">SOURCE_DIST_BASE ?= rabbitmq-server</span><br><span class="line">SOURCE_DIST_SUFFIXES ?= tar.xz</span><br><span class="line">SOURCE_DIST ?= <span class="variable">$(PACKAGES_DIR)</span>/<span class="variable">$(SOURCE_DIST_BASE)</span>-<span class="variable">$(PROJECT_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 源码包文件</span></span><br><span class="line">SOURCE_DIST_FILES = <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(SOURCE_DIST)</span>.,<span class="variable">$(SOURCE_DIST_SUFFIXES)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">source-dist: <span class="variable">$(SOURCE_DIST_FILES)</span></span></span><br><span class="line">  @:</span><br><span class="line"></span><br><span class="line"><span class="comment"># 来源：Makefile (第 234-306 行)</span></span><br><span class="line"><span class="variable">$(SOURCE_DIST)</span>: <span class="variable">$(ERLANG_MK_RECURSIVE_DEPS_LIST)</span></span><br><span class="line">  <span class="variable">$(verbose)</span> mkdir -p <span class="variable">$(<span class="built_in">dir</span> <span class="variable">$@</span>)</span></span><br><span class="line">  <span class="variable">$(gen_verbose)</span> <span class="variable">$(RSYNC)</span> <span class="variable">$(RSYNC_FLAGS)</span> ./ <span class="variable">$@</span>/</span><br><span class="line">  <span class="comment"># 收集依赖、许可证、版本信息等</span></span><br></pre></td></tr></table></figure>

<h4 id="打包流程详解-1"><a href="#打包流程详解-1" class="headerlink" title="打包流程详解"></a>打包流程详解</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">make source-dist</span><br><span class="line">  ↓</span><br><span class="line">解析依赖列表 (ERLANG_MK_RECURSIVE_DEPS_LIST)</span><br><span class="line">  ↓</span><br><span class="line">rsync 复制主项目 (排除 <span class="selector-class">.git</span>, <span class="selector-class">.beam</span>, deps/ 等)</span><br><span class="line">  ↓</span><br><span class="line">收集所有依赖到 deps/</span><br><span class="line">  ↓</span><br><span class="line">处理许可证文件 (LICENSE)</span><br><span class="line">  ↓</span><br><span class="line">更新版本信息 (<span class="selector-class">.app</span><span class="selector-class">.src</span> 文件)</span><br><span class="line">  ↓</span><br><span class="line">生成 git-revisions<span class="selector-class">.txt</span> (版本追踪)</span><br><span class="line">  ↓</span><br><span class="line">处理 Mix/Hex 缓存 (用于离线构建)</span><br><span class="line">  ↓</span><br><span class="line">固定文件时间戳 (可复现性)</span><br><span class="line">  ↓</span><br><span class="line">生成 manifest 文件</span><br><span class="line">  ↓</span><br><span class="line">创建 tar<span class="selector-class">.xz</span> 归档</span><br></pre></td></tr></table></figure>

<h4 id="RSYNC-排除规则"><a href="#RSYNC-排除规则" class="headerlink" title="RSYNC 排除规则"></a>RSYNC 排除规则</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">RSYNC_FLAGS += -a <span class="variable">$(RSYNC_V)</span>              \</span><br><span class="line">  --exclude &#x27;.sw?&#x27; --exclude &#x27;.*.sw?&#x27;   \  <span class="comment"># vim 交换文件</span></span><br><span class="line">  --exclude &#x27;*.beam&#x27;                    \  <span class="comment"># 编译产物</span></span><br><span class="line">  --exclude &#x27;*.d&#x27;                       \  <span class="comment"># 依赖文件</span></span><br><span class="line">  --exclude &#x27;*.pyc&#x27;                     \  <span class="comment"># Python 缓存</span></span><br><span class="line">  --exclude &#x27;.git*&#x27;                     \  <span class="comment"># Git 文件</span></span><br><span class="line">  --exclude &#x27;.hg*&#x27;                      \  <span class="comment"># Mercurial 文件</span></span><br><span class="line">  --exclude &#x27;*.bzl&#x27;                     \  <span class="comment"># Bazel 文件</span></span><br><span class="line">  --exclude &#x27;*.bazel&#x27;                   \</span><br><span class="line">  --exclude &#x27;BUILD.*&#x27;                   \</span><br><span class="line">  --exclude &#x27;deps/&#x27;                     \  <span class="comment"># 依赖目录（单独处理）</span></span><br><span class="line">  --exclude &#x27;ebin/&#x27;                     \  <span class="comment"># 编译输出</span></span><br><span class="line">  --exclude &#x27;plugins/&#x27;                  \  <span class="comment"># 插件目录</span></span><br><span class="line">  --exclude &#x27;test/&#x27;                     \  <span class="comment"># 测试文件</span></span><br><span class="line">  --exclude &#x27;sbin/&#x27;                     \  <span class="comment"># 生成的脚本</span></span><br><span class="line">  <span class="comment"># ... 更多排除规则</span></span><br></pre></td></tr></table></figure>

<h3 id="实际生成的文件"><a href="#实际生成的文件" class="headerlink" title="实际生成的文件"></a>实际生成的文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PACKAGES/</span><br><span class="line">├── rabbitmq-server-4.0.5/              <span class="comment"># 解压后的源码目录</span></span><br><span class="line">│   ├── Makefile                        <span class="comment"># 主构建文件</span></span><br><span class="line">│   ├── erlang.mk                       <span class="comment"># Erlang.mk 构建系统</span></span><br><span class="line">│   ├── plugins.mk                      <span class="comment"># 插件定义</span></span><br><span class="line">│   ├── deps/                           <span class="comment"># 所有依赖源码</span></span><br><span class="line">│   │   ├── rabbit/                     <span class="comment"># 核心模块</span></span><br><span class="line">│   │   ├── rabbit_common/              <span class="comment"># 公共模块</span></span><br><span class="line">│   │   ├── rabbitmq_management/        <span class="comment"># 管理插件</span></span><br><span class="line">│   │   └── ...                         <span class="comment"># 其他依赖</span></span><br><span class="line">│   ├── LICENSE                         <span class="comment"># 合并的许可证文件</span></span><br><span class="line">│   ├── LICENSE-*                       <span class="comment"># 各组件许可证</span></span><br><span class="line">│   └── git-revisions.txt               <span class="comment"># Git 版本追踪</span></span><br><span class="line">├── rabbitmq-server-4.0.5.tar.xz        <span class="comment"># 源码归档包 (~5MB)</span></span><br><span class="line">└── rabbitmq-server-4.0.5.manifest      <span class="comment"># 文件清单</span></span><br></pre></td></tr></table></figure>

<h3 id="可复现性特性"><a href="#可复现性特性" class="headerlink" title="可复现性特性"></a>可复现性特性</h3><ol>
<li><strong>固定时间戳</strong> - 所有文件时间戳基于最新 Git 提交</li>
<li><strong>排序文件列表</strong> - manifest 使用 <code>LC_COLLATE=C sort</code> 确保一致性</li>
<li><strong>Hex 缓存处理</strong> - 将 ETS 缓存转为 Erlang term 文件避免二进制差异</li>
<li><strong>版本信息嵌入</strong> - 自动更新所有 <code>.app.src</code> 中的版本号</li>
</ol>
<h3 id="使用场景与最佳实践-3"><a href="#使用场景与最佳实践-3" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="离线构建"><a href="#离线构建" class="headerlink" title="离线构建"></a>离线构建</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 在联网环境创建源码包</span></span><br><span class="line">make source-dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 传输到离线环境</span></span><br><span class="line">scp PACKAGES/rabbitmq-server-4.0.5.tar.xz offline-server:/tmp/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 离线构建</span></span><br><span class="line">ssh offline-server</span><br><span class="line">tar -xf /tmp/rabbitmq-server-4.0.5.tar.xz</span><br><span class="line"><span class="built_in">cd</span> rabbitmq-server-4.0.5</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<h4 id="版本发布"><a href="#版本发布" class="headerlink" title="版本发布"></a>版本发布</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 官方发布流程</span></span><br><span class="line">make source-dist</span><br><span class="line"><span class="comment"># 生成的 tar.xz 可上传到 GitHub Releases</span></span><br></pre></td></tr></table></figure>

<h4 id="作为-package-generic-unix-的输入"><a href="#作为-package-generic-unix-的输入" class="headerlink" title="作为 package-generic-unix 的输入"></a>作为 package-generic-unix 的输入</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># make package-generic-unix 内部依赖 source-dist</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 实际执行：</span></span><br><span class="line"><span class="comment"># 1. make source-dist (生成源码包)</span></span><br><span class="line"><span class="comment"># 2. 解压源码包</span></span><br><span class="line"><span class="comment"># 3. 编译并打包为通用包</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-make-package-generic-unix-通用-Unix-包"><a href="#5-make-package-generic-unix-通用-Unix-包" class="headerlink" title="5. make package-generic-unix - 通用 Unix 包"></a>5. <code>make package-generic-unix</code> - 通用 Unix 包</h2><h3 id="技术原理-4"><a href="#技术原理-4" class="headerlink" title="技术原理"></a>技术原理</h3><p>创建跨平台的 tar.xz 安装包，包含完整的 RabbitMQ 运行环境。<strong>依赖 <code>make source-dist</code> 生成的源码包作为输入。</strong></p>
<h4 id="核心实现源码-2"><a href="#核心实现源码-2" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：packaging/generic-unix/Makefile (第 33-76 行)</span></span><br><span class="line">SOURCE_DIR = rabbitmq-server-<span class="variable">$(VERSION)</span></span><br><span class="line">TARGET_DIR = rabbitmq_server-<span class="variable">$(VERSION)</span></span><br><span class="line">TARGET_TARBALL = rabbitmq-server-<span class="variable">$(TARBALL_SUFFIX)</span>-<span class="variable">$(VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="section">dist:</span></span><br><span class="line">  <span class="comment"># 解压源码包</span></span><br><span class="line">  xzcat <span class="variable">$(SOURCE_DIST_FILE)</span> | tar -xf -</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 编译并安装到目标目录</span></span><br><span class="line">  <span class="variable">$(MAKE)</span> -C <span class="variable">$(SOURCE_DIR)</span> \</span><br><span class="line">    PREFIX= RMQ_ROOTDIR= \</span><br><span class="line">    RMQ_ERLAPP_DIR=`pwd`/<span class="variable">$(TARGET_DIR)</span> \</span><br><span class="line">    MANDIR=`pwd`/<span class="variable">$(TARGET_DIR)</span>/share/man \</span><br><span class="line">    manpages web-manpages install install-man</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 修改配置文件</span></span><br><span class="line">  sed -e &#x27;s:^SYS_PREFIX=$$:SYS_PREFIX=\$$&#123;RABBITMQ_HOME&#125;:&#x27; \</span><br><span class="line">        <span class="variable">$(TARGET_DIR)</span>/sbin/rabbitmq-defaults &gt;<span class="variable">$(TARGET_DIR)</span>/sbin/rabbitmq-defaults.tmp</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 创建 tar.xz 包</span></span><br><span class="line">  find <span class="variable">$(TARGET_DIR)</span> | LC_COLLATE=C sort &gt; <span class="variable">$(TARGET_TARBALL)</span>.manifest</span><br><span class="line">  tar --no-recursion -T <span class="variable">$(TARGET_TARBALL)</span>.manifest -cf - | \</span><br><span class="line">  xz &gt; <span class="variable">$(CURDIR)</span>/<span class="variable">$(TARGET_TARBALL)</span>.tar.xz</span><br></pre></td></tr></table></figure>

<h4 id="打包流程详解-2"><a href="#打包流程详解-2" class="headerlink" title="打包流程详解"></a>打包流程详解</h4><ol>
<li><strong>解压源码包</strong> - 从 tar.xz 源码包开始</li>
<li><strong>编译安装</strong> - 使用标准 Unix 安装路径</li>
<li><strong>生成文档</strong> - 创建 man 手册页</li>
<li><strong>配置脚本</strong> - 调整启动脚本的路径变量</li>
<li><strong>创建归档</strong> - 打包成 tar.xz 格式</li>
</ol>
<h3 id="实际生成的包结构（已验证）"><a href="#实际生成的包结构（已验证）" class="headerlink" title="实际生成的包结构（已验证）"></a>实际生成的包结构（已验证）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PACKAGES/</span><br><span class="line">├── rabbitmq-server-4.0.5.tar.xz           <span class="comment"># 4.95 MB - 源码包</span></span><br><span class="line">├── rabbitmq-server-generic-unix-4.0.5.tar.xz  <span class="comment"># 15.51 MB - 通用包</span></span><br><span class="line">├── rabbitmq-server-4.0.5.manifest         <span class="comment"># 230.22 KB - 文件清单</span></span><br><span class="line">└── rabbitmq-server-4.0.5/                 <span class="comment"># 解压后的源码目录</span></span><br><span class="line">    ├── sbin/                              <span class="comment"># 启动脚本 (25 个文件)</span></span><br><span class="line">    ├── deps/                              <span class="comment"># 依赖模块 (86 个目录)</span></span><br><span class="line">    ├── etc/                               <span class="comment"># 配置目录</span></span><br><span class="line">    └── ...                                <span class="comment"># 其他文件</span></span><br></pre></td></tr></table></figure>

<h4 id="通用包内容分析"><a href="#通用包内容分析" class="headerlink" title="通用包内容分析"></a>通用包内容分析</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压通用包后的目录结构</span></span><br><span class="line">rabbitmq_server-4.0.5/</span><br><span class="line">├── lib/                          <span class="comment"># Erlang 应用库</span></span><br><span class="line">│   └── rabbitmq_server-4.0.5/</span><br><span class="line">│       ├── ebin/                <span class="comment"># 字节码文件</span></span><br><span class="line">│       ├── include/             <span class="comment"># 头文件</span></span><br><span class="line">│       └── priv/                <span class="comment"># 私有资源</span></span><br><span class="line">├── sbin/                        <span class="comment"># 启动脚本</span></span><br><span class="line">│   ├── rabbitmq-server         <span class="comment"># 已配置 RABBITMQ_HOME</span></span><br><span class="line">│   ├── rabbitmqctl</span><br><span class="line">│   └── ...</span><br><span class="line">├── etc/                         <span class="comment"># 配置目录</span></span><br><span class="line">│   └── rabbitmq/</span><br><span class="line">├── share/                       <span class="comment"># 文档和手册</span></span><br><span class="line">│   └── man/</span><br><span class="line">└── plugins/                     <span class="comment"># 插件目录</span></span><br></pre></td></tr></table></figure>

<h3 id="通用包特点"><a href="#通用包特点" class="headerlink" title="通用包特点"></a>通用包特点</h3><ol>
<li><strong>自包含</strong>: 包含所有运行时依赖</li>
<li><strong>可移植</strong>: 适用于各种 Unix 系统</li>
<li><strong>标准化</strong>: 遵循 Unix 目录结构规范</li>
<li><strong>生产就绪</strong>: 包含完整的配置和文档</li>
</ol>
<h3 id="使用场景与最佳实践-4"><a href="#使用场景与最佳实践-4" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="容器化部署"><a href="#容器化部署" class="headerlink" title="容器化部署"></a>容器化部署</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 构建通用包</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Dockerfile 示例</span></span><br><span class="line">FROM ubuntu:20.04</span><br><span class="line">COPY PACKAGES/rabbitmq-server-generic-unix-*.tar.xz /tmp/</span><br><span class="line">RUN tar -xf /tmp/rabbitmq-server-generic-unix-*.tar.xz -C /opt/</span><br></pre></td></tr></table></figure>

<h4 id="跨平台分发"><a href="#跨平台分发" class="headerlink" title="跨平台分发"></a>跨平台分发</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 创建分发包</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 部署到不同系统</span></span><br><span class="line">scp PACKAGES/rabbitmq-server-generic-unix-*.tar.xz user@server:/tmp/</span><br><span class="line">ssh user@server <span class="string">&#x27;cd /opt &amp;&amp; tar -xf /tmp/rabbitmq-server-generic-unix-*.tar.xz&#x27;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-make-install-系统级安装"><a href="#6-make-install-系统级安装" class="headerlink" title="6. make install - 系统级安装"></a>6. <code>make install</code> - 系统级安装</h2><h3 id="技术原理-5"><a href="#技术原理-5" class="headerlink" title="技术原理"></a>技术原理</h3><p>将 RabbitMQ 安装到系统标准路径，遵循 FHS (Filesystem Hierarchy Standard)。</p>
<h4 id="核心实现逻辑-1"><a href="#核心实现逻辑-1" class="headerlink" title="核心实现逻辑"></a>核心实现逻辑</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile 第 489-523 行</span></span><br><span class="line">PREFIX ?= /usr/local</span><br><span class="line">RMQ_ROOTDIR ?= <span class="variable">$(PREFIX)</span>/lib/erlang</span><br><span class="line">RMQ_BINDIR ?= <span class="variable">$(RMQ_ROOTDIR)</span>/bin</span><br><span class="line">RMQ_LIBDIR ?= <span class="variable">$(RMQ_ROOTDIR)</span>/lib</span><br><span class="line">RMQ_ERLAPP_DIR ?= <span class="variable">$(RMQ_LIBDIR)</span>/rabbitmq_server-<span class="variable">$(PROJECT_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="section">install: install-erlapp install-scripts</span></span><br><span class="line"></span><br><span class="line"><span class="section">install-erlapp: dist</span></span><br><span class="line">  <span class="variable">$(verbose)</span> mkdir -p <span class="variable">$(DESTDIR)</span><span class="variable">$(RMQ_ERLAPP_DIR)</span></span><br><span class="line">  <span class="variable">$(inst_verbose)</span> cp -r \</span><br><span class="line">    LICENSE* \</span><br><span class="line">    <span class="variable">$(DEPS_DIR)</span>/rabbit/INSTALL \</span><br><span class="line">    <span class="variable">$(DIST_DIR)</span> \</span><br><span class="line">    <span class="variable">$(DESTDIR)</span><span class="variable">$(RMQ_ERLAPP_DIR)</span></span><br></pre></td></tr></table></figure>

<h4 id="安装组件详解"><a href="#安装组件详解" class="headerlink" title="安装组件详解"></a>安装组件详解</h4><ol>
<li><strong>核心应用</strong> (<code>install-erlapp</code>) - 安装 Erlang 应用和插件</li>
<li><strong>启动脚本</strong> (<code>install-scripts</code>) - 安装服务启动脚本</li>
<li><strong>命令行工具</strong> (<code>install-bin</code>) - 安装管理工具</li>
<li><strong>手册页</strong> (<code>install-man</code>) - 安装文档</li>
</ol>
<h3 id="系统安装目录结构"><a href="#系统安装目录结构" class="headerlink" title="系统安装目录结构"></a>系统安装目录结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/</span><br><span class="line">├── bin/                         <span class="comment"># 可执行文件</span></span><br><span class="line">│   ├── rabbitmq-server</span><br><span class="line">│   ├── rabbitmqctl</span><br><span class="line">│   └── ...</span><br><span class="line">├── lib/                         <span class="comment"># 库文件</span></span><br><span class="line">│   └── rabbitmq/</span><br><span class="line">│       ├── lib/                <span class="comment"># Erlang 应用</span></span><br><span class="line">│       └── plugins/            <span class="comment"># 插件目录</span></span><br><span class="line">├── etc/                        <span class="comment"># 配置文件</span></span><br><span class="line">│   └── rabbitmq/</span><br><span class="line">│       └── rabbitmq.conf</span><br><span class="line">├── var/                        <span class="comment"># 数据目录</span></span><br><span class="line">│   ├── <span class="built_in">log</span>/rabbitmq/          <span class="comment"># 日志</span></span><br><span class="line">│   └── lib/rabbitmq/          <span class="comment"># 数据库</span></span><br><span class="line">└── share/                      <span class="comment"># 文档</span></span><br><span class="line">    └── man/                    <span class="comment"># 手册页</span></span><br></pre></td></tr></table></figure>

<h3 id="系统安装优势"><a href="#系统安装优势" class="headerlink" title="系统安装优势"></a>系统安装优势</h3><ol>
<li><strong>标准化</strong>: 遵循 Unix 标准目录结构</li>
<li><strong>多用户</strong>: 支持系统级多用户访问</li>
<li><strong>服务集成</strong>: 便于集成到系统服务管理</li>
<li><strong>权限管理</strong>: 利用系统权限控制</li>
</ol>
<h3 id="使用场景与最佳实践-5"><a href="#使用场景与最佳实践-5" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="系统级部署"><a href="#系统级部署" class="headerlink" title="系统级部署"></a>系统级部署</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 系统安装</span></span><br><span class="line"><span class="built_in">sudo</span> make install PREFIX=/opt/rabbitmq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 服务配置</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> rabbitmq-server</span><br><span class="line"><span class="built_in">sudo</span> systemctl start rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 多用户环境</span></span><br><span class="line"><span class="built_in">sudo</span> adduser rabbitmq</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> -R rabbitmq:rabbitmq /opt/rabbitmq</span><br></pre></td></tr></table></figure>

<h4 id="包管理器集成"><a href="#包管理器集成" class="headerlink" title="包管理器集成"></a>包管理器集成</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 创建 deb/rpm 包</span></span><br><span class="line">make install DESTDIR=/tmp/rabbitmq-package PREFIX=/usr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 打包</span></span><br><span class="line">fpm -s <span class="built_in">dir</span> -t deb -C /tmp/rabbitmq-package \</span><br><span class="line">    --name rabbitmq-server \</span><br><span class="line">    --version 4.0.5 \</span><br><span class="line">    .</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-开发调试命令"><a href="#7-开发调试命令" class="headerlink" title="7. 开发调试命令"></a>7. 开发调试命令</h2><h3 id="make-run-broker-启动开发服务器"><a href="#make-run-broker-启动开发服务器" class="headerlink" title="make run-broker - 启动开发服务器"></a><code>make run-broker</code> - 启动开发服务器</h3><h4 id="技术原理-6"><a href="#技术原理-6" class="headerlink" title="技术原理"></a>技术原理</h4><p><code>make run-broker</code> 在前台启动 RabbitMQ 服务器，适合开发调试。日志直接输出到终端，便于实时查看。</p>
<h4 id="核心实现源码-3"><a href="#核心实现源码-3" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-run.mk (第 269-278 行)</span></span><br><span class="line">run-broker run-tls-broker: RABBITMQ_CONFIG_FILE := <span class="variable">$(<span class="built_in">basename</span> <span class="variable">$(TEST_CONFIG_FILE)</span>)</span></span><br><span class="line"><span class="section">run-broker:     config = <span class="variable">$(test_rabbitmq_config)</span></span></span><br><span class="line"><span class="section">run-tls-broker: config = <span class="variable">$(test_rabbitmq_config_with_tls)</span></span></span><br><span class="line"></span><br><span class="line">run-broker run-tls-broker: node-tmpdir <span class="variable">$(DIST_TARGET)</span> <span class="variable">$(TEST_CONFIG_FILE)</span></span><br><span class="line">  <span class="variable">$(BASIC_SCRIPT_ENV_SETTINGS)</span> \</span><br><span class="line">    RABBITMQ_ALLOW_INPUT=true \</span><br><span class="line">    RABBITMQ_CONFIG_FILE=<span class="variable">$(RABBITMQ_CONFIG_FILE)</span> \</span><br><span class="line">    <span class="variable">$(RABBITMQ_SERVER)</span></span><br></pre></td></tr></table></figure>

<h4 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">make run-broker</span><br><span class="line">  ↓</span><br><span class="line">创建临时目录 (<span class="keyword">node</span><span class="title">-tmpdir</span>)</span><br><span class="line">  ↓</span><br><span class="line">执行 make dist (如需要)</span><br><span class="line">  ↓</span><br><span class="line">生成测试配置文件</span><br><span class="line">  ↓</span><br><span class="line">设置环境变量</span><br><span class="line">  ↓</span><br><span class="line">启动 rabbitmq-server (前台)</span><br></pre></td></tr></table></figure>

<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 基础开发调试</span></span><br><span class="line">make run-broker</span><br><span class="line"><span class="comment"># 日志直接输出到终端，Ctrl+C 停止</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 后台启动</span></span><br><span class="line">make run-background-broker</span><br><span class="line"><span class="comment"># 服务在后台运行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. TLS 模式启动</span></span><br><span class="line">make run-tls-broker</span><br><span class="line"><span class="comment"># 使用 TLS 配置启动</span></span><br></pre></td></tr></table></figure>

<h3 id="make-run-broker-PLUGINS-插件测试"><a href="#make-run-broker-PLUGINS-插件测试" class="headerlink" title="make run-broker PLUGINS= - 插件测试"></a><code>make run-broker PLUGINS=</code> - 插件测试</h3><h4 id="技术原理-7"><a href="#技术原理-7" class="headerlink" title="技术原理"></a>技术原理</h4><p>通过 <code>PLUGINS</code> 环境变量指定要加载的插件，用于测试特定插件功能。</p>
<h4 id="使用场景-1"><a href="#使用场景-1" class="headerlink" title="使用场景"></a>使用场景</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 测试管理插件</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;rabbitmq_management&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 测试多个插件</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;rabbitmq_management rabbitmq_prometheus&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 测试自定义插件</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;my_custom_plugin&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><ul>
<li>插件名称使用空格分隔</li>
<li>插件需要先编译完成（<code>make dist</code>）</li>
<li>依赖插件会自动加载</li>
</ul>
<h3 id="make-shell-Erlang-Shell"><a href="#make-shell-Erlang-Shell" class="headerlink" title="make shell - Erlang Shell"></a><code>make shell</code> - Erlang Shell</h3><h4 id="技术原理-8"><a href="#技术原理-8" class="headerlink" title="技术原理"></a>技术原理</h4><p>启动一个加载了所有 RabbitMQ 模块的 Erlang Shell，用于代码调试和模块测试。</p>
<h4 id="核心实现源码-4"><a href="#核心实现源码-4" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：erlang.mk (第 7053-7054 行)</span></span><br><span class="line"><span class="section">shell:: build-shell-deps</span></span><br><span class="line">  <span class="variable">$(gen_verbose)</span> <span class="variable">$(SHELL_ERL)</span> -pa <span class="variable">$(SHELL_PATHS)</span> <span class="variable">$(SHELL_OPTS)</span></span><br></pre></td></tr></table></figure>

<h4 id="使用场景-2"><a href="#使用场景-2" class="headerlink" title="使用场景"></a>使用场景</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 进入 Erlang Shell</span></span><br><span class="line">make shell</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Shell 中：</span></span><br><span class="line"><span class="comment"># 测试模块函数</span></span><br><span class="line">1&gt; rabbit_misc:version().</span><br><span class="line"><span class="string">&quot;4.0.5&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查模块信息</span></span><br><span class="line">2&gt; m(rabbit).</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译并加载修改后的模块</span></span><br><span class="line">3&gt; c(my_module).</span><br></pre></td></tr></table></figure>

<h4 id="与-erl-的区别"><a href="#与-erl-的区别" class="headerlink" title="与 erl 的区别"></a>与 <code>erl</code> 的区别</h4><table>
<thead>
<tr>
<th>特性</th>
<th><code>make shell</code></th>
<th><code>erl</code></th>
</tr>
</thead>
<tbody><tr>
<td>代码路径</td>
<td>自动设置所有依赖</td>
<td>需手动指定</td>
</tr>
<tr>
<td>模块加载</td>
<td>RabbitMQ 模块可用</td>
<td>需手动加载</td>
</tr>
<tr>
<td>环境变量</td>
<td>继承项目配置</td>
<td>默认配置</td>
</tr>
<tr>
<td>用途</td>
<td>RabbitMQ 开发调试</td>
<td>通用 Erlang 开发</td>
</tr>
</tbody></table>
<h3 id="make-run-node-裸-Erlang-节点"><a href="#make-run-node-裸-Erlang-节点" class="headerlink" title="make run-node - 裸 Erlang 节点"></a><code>make run-node</code> - 裸 Erlang 节点</h3><h4 id="技术原理-9"><a href="#技术原理-9" class="headerlink" title="技术原理"></a>技术原理</h4><p>启动一个不运行 RabbitMQ 应用的 Erlang 节点，仅加载代码但不启动服务。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-run.mk (第 288-292 行)</span></span><br><span class="line"><span class="section">run-node: node-tmpdir <span class="variable">$(DIST_TARGET)</span></span></span><br><span class="line">  <span class="variable">$(BASIC_SCRIPT_ENV_SETTINGS)</span> \</span><br><span class="line">    RABBITMQ_NODE_ONLY=true \</span><br><span class="line">    RABBITMQ_ALLOW_INPUT=true \</span><br><span class="line">    <span class="variable">$(RABBITMQ_SERVER)</span></span><br></pre></td></tr></table></figure>

<h4 id="使用场景-3"><a href="#使用场景-3" class="headerlink" title="使用场景"></a>使用场景</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Erlang 级别调试</span></span><br><span class="line">make run-node</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 手动启动 RabbitMQ 应用</span></span><br><span class="line">1&gt; application:ensure_all_started(rabbit).</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 测试特定模块而不启动完整服务</span></span><br><span class="line">1&gt; rabbit_misc:version().</span><br></pre></td></tr></table></figure>

<h3 id="开发工作流最佳实践"><a href="#开发工作流最佳实践" class="headerlink" title="开发工作流最佳实践"></a>开发工作流最佳实践</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 完整开发工作流</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 编译项目</span></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 测试模块（不启动服务）</span></span><br><span class="line">make shell</span><br><span class="line">&gt; my_module:<span class="built_in">test</span>().</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 启动服务验证</span></span><br><span class="line">make run-broker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 测试特定插件</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;rabbitmq_management&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 查看管理界面</span></span><br><span class="line"><span class="comment"># 浏览器访问 http://localhost:15672</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 修改代码后重新编译</span></span><br><span class="line">make  <span class="comment"># 增量编译</span></span><br><span class="line">make run-broker  <span class="comment"># 重新启动</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="构建系统架构深度解析"><a href="#构建系统架构深度解析" class="headerlink" title="构建系统架构深度解析"></a>构建系统架构深度解析</h2><h3 id="核心组件关系"><a href="#核心组件关系" class="headerlink" title="核心组件关系"></a>核心组件关系</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Makefile</span><br><span class="line">  ├── erlang<span class="selector-class">.mk</span>          → 编译 Erlang 代码 → 生成 <span class="selector-class">.beam</span> 文件</span><br><span class="line">  ├── rabbitmq-components<span class="selector-class">.mk</span> → 管理组件依赖 → deps/ 目录</span><br><span class="line">  └── plugins<span class="selector-class">.mk</span>         → 插件列表管理 → PLUGINS 变量</span><br><span class="line">                                    ↓</span><br><span class="line">                          rabbitmq-dist<span class="selector-class">.mk</span></span><br><span class="line">                                    ↓</span><br><span class="line">                    ┌───────────────┴───────────────┐</span><br><span class="line">                    ↓                               ↓</span><br><span class="line">              dist 目标                         EZ 打包</span><br><span class="line">                    ↓                               ↓</span><br><span class="line">            plugins/ 目录                      <span class="selector-class">.ez</span> 文件</span><br></pre></td></tr></table></figure>

<h3 id="关键配置文件详解"><a href="#关键配置文件详解" class="headerlink" title="关键配置文件详解"></a>关键配置文件详解</h3><h4 id="1-Makefile-主控制文件"><a href="#1-Makefile-主控制文件" class="headerlink" title="1. Makefile - 主控制文件"></a>1. <code>Makefile</code> - 主控制文件</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PROJECT = rabbitmq_server_release</span><br><span class="line">PROJECT_DESCRIPTION = RabbitMQ Server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件列表</span></span><br><span class="line"><span class="keyword">include</span> plugins.mk</span><br><span class="line">DEPS = rabbit_common rabbit <span class="variable">$(PLUGINS)</span> <span class="variable">$(ADDITIONAL_PLUGINS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建系统</span></span><br><span class="line"><span class="keyword">include</span> rabbitmq-components.mk</span><br><span class="line"><span class="keyword">include</span> erlang.mk</span><br></pre></td></tr></table></figure>

<h4 id="2-plugins-mk-插件定义"><a href="#2-plugins-mk-插件定义" class="headerlink" title="2. plugins.mk - 插件定义"></a>2. <code>plugins.mk</code> - 插件定义</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PLUGINS = \</span><br><span class="line">  rabbitmq_amqp1_0 \</span><br><span class="line">  rabbitmq_auth_backend_cache \</span><br><span class="line">  rabbitmq_auth_backend_http \</span><br><span class="line">  rabbitmq_auth_backend_ldap \</span><br><span class="line">  rabbitmq_auth_backend_oauth2 \</span><br><span class="line">  rabbitmq_auth_mechanism_ssl \</span><br><span class="line">  rabbitmq_consistent_hash_exchange \</span><br><span class="line">  <span class="comment"># ... 更多插件</span></span><br></pre></td></tr></table></figure>

<h4 id="3-rabbitmq-dist-mk-分发逻辑"><a href="#3-rabbitmq-dist-mk-分发逻辑" class="headerlink" title="3. rabbitmq-dist.mk - 分发逻辑"></a>3. <code>rabbitmq-dist.mk</code> - 分发逻辑</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EZ 文件生成宏</span></span><br><span class="line"><span class="keyword">define</span> do_ez_target_erlangmk</span><br><span class="line"><span class="comment"># 定义目标目录和文件名</span></span><br><span class="line">dist_$(1)_ez_dir = <span class="variable">$(DIST_DIR)</span>/$(1)-$(2)</span><br><span class="line"><span class="comment"># 根据 DIST_AS_EZS 决定格式</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(DIST_AS_EZS)</span>,)</span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir)      <span class="comment"># 目录</span></span><br><span class="line"><span class="keyword">else</span>  </span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir).ez   <span class="comment"># EZ 文件</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endef</span></span><br></pre></td></tr></table></figure>

<h3 id="构建系统特点"><a href="#构建系统特点" class="headerlink" title="构建系统特点"></a>构建系统特点</h3><ol>
<li><strong>模块化设计</strong> - 每个 <code>.mk</code> 文件负责特定功能</li>
<li><strong>可扩展性</strong> - 支持自定义插件和构建规则</li>
<li><strong>标准化</strong> - 遵循 Erlang&#x2F;OTP 和 Unix 标准</li>
<li><strong>自动化</strong> - 完整的依赖管理和构建流程</li>
</ol>
<hr>
<h2 id="完整编译流程对比"><a href="#完整编译流程对比" class="headerlink" title="完整编译流程对比"></a>完整编译流程对比</h2><h3 id="性能和资源详细对比"><a href="#性能和资源详细对比" class="headerlink" title="性能和资源详细对比"></a>性能和资源详细对比</h3><h4 id="构建命令-1"><a href="#构建命令-1" class="headerlink" title="构建命令"></a>构建命令</h4><table>
<thead>
<tr>
<th>编译方式</th>
<th>编译时间</th>
<th>磁盘占用</th>
<th>内存使用</th>
<th>网络传输</th>
<th>部署复杂度</th>
<th>维护成本</th>
</tr>
</thead>
<tbody><tr>
<td><code>make</code></td>
<td>最快 (30s)</td>
<td>中等 (200MB)</td>
<td>低 (100MB)</td>
<td>不适用</td>
<td>简单</td>
<td>低</td>
</tr>
<tr>
<td><code>make dist</code></td>
<td>快 (45s)</td>
<td>大 (300MB)</td>
<td>中等 (150MB)</td>
<td>大 (300MB)</td>
<td>中等</td>
<td>中等</td>
</tr>
<tr>
<td><code>make dist DIST_AS_EZS=true</code></td>
<td>中等 (60s)</td>
<td>小 (15MB)</td>
<td>中等 (150MB)</td>
<td>小 (15MB)</td>
<td>简单</td>
<td>低</td>
</tr>
<tr>
<td><code>make source-dist</code></td>
<td>快 (40s)</td>
<td>小 (~5MB)</td>
<td>低 (100MB)</td>
<td>小 (~5MB)</td>
<td>简单</td>
<td>低</td>
</tr>
<tr>
<td><code>make package-generic-unix</code></td>
<td>慢 (120s)</td>
<td>最小 (15.51MB)</td>
<td>高 (200MB)</td>
<td>最小 (15.51MB)</td>
<td>简单</td>
<td>低</td>
</tr>
<tr>
<td><code>make install</code></td>
<td>中等 (75s)</td>
<td>中等 (250MB)</td>
<td>低 (100MB)</td>
<td>不适用</td>
<td>复杂</td>
<td>高</td>
</tr>
</tbody></table>
<h4 id="开发调试命令-1"><a href="#开发调试命令-1" class="headerlink" title="开发调试命令"></a>开发调试命令</h4><table>
<thead>
<tr>
<th>命令</th>
<th>启动时间</th>
<th>用途</th>
<th>交互性</th>
</tr>
</thead>
<tbody><tr>
<td><code>make run-broker</code></td>
<td>快 (5s)</td>
<td>开发调试</td>
<td>前台，可查看日志</td>
</tr>
<tr>
<td><code>make run-broker PLUGINS=...</code></td>
<td>快 (5s)</td>
<td>插件测试</td>
<td>前台，指定插件</td>
</tr>
<tr>
<td><code>make shell</code></td>
<td>最快 (2s)</td>
<td>模块调试</td>
<td>交互式 Erlang Shell</td>
</tr>
<tr>
<td><code>make run-background-broker</code></td>
<td>快 (5s)</td>
<td>自动化测试</td>
<td>后台运行</td>
</tr>
<tr>
<td><code>make run-node</code></td>
<td>最快 (2s)</td>
<td>Erlang 调试</td>
<td>裸节点，无 RabbitMQ</td>
</tr>
</tbody></table>
<hr>
<h2 id="最佳实践指南"><a href="#最佳实践指南" class="headerlink" title="最佳实践指南"></a>最佳实践指南</h2><h3 id="开发阶段最佳实践"><a href="#开发阶段最佳实践" class="headerlink" title="开发阶段最佳实践"></a>开发阶段最佳实践</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 初始设置</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/rabbitmq/rabbitmq-server.git</span><br><span class="line"><span class="built_in">cd</span> rabbitmq-server</span><br><span class="line">git checkout v4.0.5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 快速开发迭代</span></span><br><span class="line">make clean &amp;&amp; make</span><br><span class="line">sbin/rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 增量编译（推荐）</span></span><br><span class="line">make  <span class="comment"># 只编译修改的文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 开发调试</span></span><br><span class="line">make shell  <span class="comment"># 进入 Erlang shell</span></span><br><span class="line">make run-broker  <span class="comment"># 运行开发版本</span></span><br></pre></td></tr></table></figure>

<h3 id="测试阶段最佳实践"><a href="#测试阶段最佳实践" class="headerlink" title="测试阶段最佳实践"></a>测试阶段最佳实践</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 功能测试</span></span><br><span class="line">make dist</span><br><span class="line"><span class="comment"># 测试插件加载和目录结构</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 插件兼容性测试</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 验证 EZ 文件加载和热加载</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 集成测试</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 在不同环境测试安装包</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 性能测试</span></span><br><span class="line">make  <span class="comment"># 使用最快的编译方式</span></span><br></pre></td></tr></table></figure>

<h3 id="生产部署最佳实践"><a href="#生产部署最佳实践" class="headerlink" title="生产部署最佳实践"></a>生产部署最佳实践</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 容器化部署（推荐）</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 使用 tar.xz 包构建 Docker 镜像</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 传统服务器部署</span></span><br><span class="line">make install PREFIX=/opt/rabbitmq</span><br><span class="line"><span class="comment"># 系统级安装</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 云原生部署</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 使用 EZ 文件支持动态插件管理</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 高可用部署</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 标准化的部署包，便于集群管理</span></span><br></pre></td></tr></table></figure>

<h3 id="插件开发最佳实践"><a href="#插件开发最佳实践" class="headerlink" title="插件开发最佳实践"></a>插件开发最佳实践</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 插件开发</span></span><br><span class="line">make dist</span><br><span class="line"><span class="comment"># 开发阶段使用目录格式便于调试</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 插件测试</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;plugin_name&quot;</span></span><br><span class="line"><span class="comment"># 测试插件功能</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 插件分发</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 生成 .ez 文件用于分发</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 插件发布</span></span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> plugin_name</span><br><span class="line"><span class="comment"># 从 .ez 文件安装插件</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="高级配置与优化"><a href="#高级配置与优化" class="headerlink" title="高级配置与优化"></a>高级配置与优化</h2><h3 id="环境变量控制"><a href="#环境变量控制" class="headerlink" title="环境变量控制"></a>环境变量控制</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义插件目录</span></span><br><span class="line"><span class="built_in">export</span> DIST_DIR=/custom/plugins/path</span><br><span class="line">make dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义包输出目录</span></span><br><span class="line"><span class="built_in">export</span> PACKAGES_DIR=/custom/packages/path  </span><br><span class="line">make package-generic-unix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用社区插件</span></span><br><span class="line"><span class="built_in">export</span> COMMUNITY_PLUGINS=1</span><br><span class="line">make dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义版本号</span></span><br><span class="line"><span class="built_in">export</span> PROJECT_VERSION=4.0.5-custom</span><br><span class="line">make dist</span><br></pre></td></tr></table></figure>

<h3 id="编译优化技巧"><a href="#编译优化技巧" class="headerlink" title="编译优化技巧"></a>编译优化技巧</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 并行编译（推荐）</span></span><br><span class="line">make -j$(<span class="built_in">nproc</span>) dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 详细输出（调试用）</span></span><br><span class="line">make V=1 dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 跳过测试（加速编译）</span></span><br><span class="line">make SKIP_TESTS=1 dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增量编译（开发用）</span></span><br><span class="line">make  <span class="comment"># 不使用 clean</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存优化</span></span><br><span class="line"><span class="built_in">export</span> ERL_MAX_PORTS=32768</span><br><span class="line">make dist</span><br></pre></td></tr></table></figure>

<h3 id="自定义构建配置"><a href="#自定义构建配置" class="headerlink" title="自定义构建配置"></a>自定义构建配置</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 local.mk 文件进行自定义</span></span><br><span class="line"><span class="comment"># local.mk</span></span><br><span class="line">ADDITIONAL_PLUGINS = my_custom_plugin</span><br><span class="line">DIST_AS_EZS = 1</span><br><span class="line">PACKAGES_DIR = /opt/packages</span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含到主 Makefile</span></span><br><span class="line"><span class="keyword">include</span> local.mk</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="故障排除指南"><a href="#故障排除指南" class="headerlink" title="故障排除指南"></a>故障排除指南</h2><h3 id="常见编译问题"><a href="#常见编译问题" class="headerlink" title="常见编译问题"></a>常见编译问题</h3><h4 id="1-依赖问题"><a href="#1-依赖问题" class="headerlink" title="1. 依赖问题"></a>1. 依赖问题</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 问题：deps 编译失败</span></span><br><span class="line"><span class="comment"># 解决：清理并重新获取依赖</span></span><br><span class="line">make clean-deps</span><br><span class="line">make deps</span><br></pre></td></tr></table></figure>

<h4 id="2-版本冲突"><a href="#2-版本冲突" class="headerlink" title="2. 版本冲突"></a>2. 版本冲突</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 问题：Erlang 版本不兼容</span></span><br><span class="line"><span class="comment"># 解决：检查并切换 Erlang 版本</span></span><br><span class="line">erl -version</span><br><span class="line"><span class="comment"># 确保使用 Erlang 25.x 或 26.x</span></span><br></pre></td></tr></table></figure>

<h4 id="3-磁盘空间不足"><a href="#3-磁盘空间不足" class="headerlink" title="3. 磁盘空间不足"></a>3. 磁盘空间不足</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 问题：编译过程中磁盘空间不足</span></span><br><span class="line"><span class="comment"># 解决：清理临时文件</span></span><br><span class="line">make clean</span><br><span class="line">make distclean</span><br></pre></td></tr></table></figure>

<h4 id="4-权限问题"><a href="#4-权限问题" class="headerlink" title="4. 权限问题"></a>4. 权限问题</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 问题：install 时权限不足</span></span><br><span class="line"><span class="comment"># 解决：使用正确的权限</span></span><br><span class="line"><span class="built_in">sudo</span> make install PREFIX=/opt/rabbitmq</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> -R rabbitmq:rabbitmq /opt/rabbitmq</span><br></pre></td></tr></table></figure>

<h3 id="性能优化建议"><a href="#性能优化建议" class="headerlink" title="性能优化建议"></a>性能优化建议</h3><ol>
<li><strong>使用 SSD</strong> - 显著提升编译速度</li>
<li><strong>增加内存</strong> - 减少交换文件使用</li>
<li><strong>并行编译</strong> - 利用多核 CPU</li>
<li><strong>增量编译</strong> - 开发阶段避免 clean</li>
<li><strong>本地缓存</strong> - 使用本地 Maven&#x2F;Hex 缓存</li>
</ol>
<hr>
<h2 id="总结与建议"><a href="#总结与建议" class="headerlink" title="总结与建议"></a>总结与建议</h2><h3 id="命令选择矩阵"><a href="#命令选择矩阵" class="headerlink" title="命令选择矩阵"></a>命令选择矩阵</h3><h4 id="构建场景"><a href="#构建场景" class="headerlink" title="构建场景"></a>构建场景</h4><table>
<thead>
<tr>
<th>场景</th>
<th>推荐方式</th>
<th>理由</th>
</tr>
</thead>
<tbody><tr>
<td><strong>本地开发</strong></td>
<td><code>make</code></td>
<td>最快，支持增量编译</td>
</tr>
<tr>
<td><strong>功能测试</strong></td>
<td><code>make dist</code></td>
<td>完整插件结构，便于调试</td>
</tr>
<tr>
<td><strong>插件开发</strong></td>
<td><code>make dist</code> → <code>make dist DIST_AS_EZS=true</code></td>
<td>开发用目录，分发用 EZ</td>
</tr>
<tr>
<td><strong>离线构建</strong></td>
<td><code>make source-dist</code></td>
<td>包含所有依赖，可复现</td>
</tr>
<tr>
<td><strong>版本发布</strong></td>
<td><code>make source-dist</code></td>
<td>官方发布流程，可复现归档</td>
</tr>
<tr>
<td><strong>容器部署</strong></td>
<td><code>make package-generic-unix</code></td>
<td>自包含，标准化</td>
</tr>
<tr>
<td><strong>生产部署</strong></td>
<td><code>make package-generic-unix</code> 或 <code>make install</code></td>
<td>稳定，便于管理</td>
</tr>
<tr>
<td><strong>自定义安装</strong></td>
<td><code>make install PREFIX=/opt/rabbitmq</code></td>
<td>指定安装路径</td>
</tr>
<tr>
<td><strong>插件分发</strong></td>
<td><code>make dist DIST_AS_EZS=true</code></td>
<td>压缩，便于传输</td>
</tr>
<tr>
<td><strong>CI&#x2F;CD</strong></td>
<td><code>make package-generic-unix</code></td>
<td>可重现，标准化</td>
</tr>
</tbody></table>
<h4 id="开发调试场景"><a href="#开发调试场景" class="headerlink" title="开发调试场景"></a>开发调试场景</h4><table>
<thead>
<tr>
<th>场景</th>
<th>推荐方式</th>
<th>理由</th>
</tr>
</thead>
<tbody><tr>
<td><strong>日常开发调试</strong></td>
<td><code>make run-broker</code></td>
<td>前台运行，实时查看日志</td>
</tr>
<tr>
<td><strong>插件功能验证</strong></td>
<td><code>make run-broker PLUGINS=&quot;plugin_name&quot;</code></td>
<td>按需加载插件</td>
</tr>
<tr>
<td><strong>模块级调试</strong></td>
<td><code>make shell</code></td>
<td>交互式测试函数</td>
</tr>
<tr>
<td><strong>自动化测试</strong></td>
<td><code>make run-background-broker</code></td>
<td>后台运行，脚本控制</td>
</tr>
<tr>
<td><strong>Erlang 底层调试</strong></td>
<td><code>make run-node</code></td>
<td>不启动 RabbitMQ 应用</td>
</tr>
</tbody></table>
<h3 id="关键技术洞察"><a href="#关键技术洞察" class="headerlink" title="关键技术洞察"></a>关键技术洞察</h3><ol>
<li><strong>EZ 格式是王道</strong> - 对于插件分发和热加载</li>
<li><strong>通用包最实用</strong> - 对于生产部署和容器化</li>
<li><strong>源码包是基础</strong> - <code>source-dist</code> 是 <code>package-generic-unix</code> 的前置依赖</li>
<li><strong>开发调试用 run-broker</strong> - 比 <code>sbin/rabbitmq-server</code> 更方便</li>
<li><strong>增量编译是关键</strong> - 对于开发效率</li>
<li><strong>构建系统很灵活</strong> - 支持高度定制</li>
<li><strong>标准化很重要</strong> - 遵循 Unix 和 Erlang 标准</li>
</ol>
<p>RabbitMQ 的构建系统设计精良，通过不同的编译命令满足了从开发到生产的各种需求。理解这些编译方式的原理和最佳实践，将显著提升 RabbitMQ 的开发、部署和运维效率。</p>
<hr>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/docs">RabbitMQ 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://erlang.mk/">Erlang.mk 用户指南</a></li>
<li><a target="_blank" rel="noopener" href="https://www.erlang.org/doc/design_principles/users_guide.html">Erlang&#x2F;OTP 设计原则</a></li>
<li><a target="_blank" rel="noopener" href="https://refspecs.linuxfoundation.org/FHS_3.0/fhs/index.html">Unix 文件系统层次标准</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/16/rabbitmq-rabbitmq-build-deep-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/16/rabbitmq-rabbitmq-build-deep-analysis/" class="post-title-link" itemprop="url">RabbitMQ 编译方式深度解析与源码分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-16 22:00:00 / 修改时间：22:20:58" itemprop="dateCreated datePublished" datetime="2026-01-16T22:00:00+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RabbitMQ-编译方式深度解析与源码分析"><a href="#RabbitMQ-编译方式深度解析与源码分析" class="headerlink" title="RabbitMQ 编译方式深度解析与源码分析"></a>RabbitMQ 编译方式深度解析与源码分析</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>RabbitMQ 作为一个复杂的分布式消息中间件，提供了多种编译和打包方式来满足不同的部署需求。本文档基于 RabbitMQ 4.0.x 源码，深入分析各种编译命令的原理、实现机制和适用场景。</p>
<h2 id="编译命令对比表"><a href="#编译命令对比表" class="headerlink" title="编译命令对比表"></a>编译命令对比表</h2><table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
<th>输出格式</th>
<th>部署方式</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>make</code></td>
<td>基础编译</td>
<td>源码目录 + beam 文件</td>
<td>开发调试</td>
<td>本地开发、调试</td>
</tr>
<tr>
<td><code>make dist</code></td>
<td>打包文件</td>
<td>插件目录结构</td>
<td>目录部署</td>
<td>生产环境、插件开发</td>
</tr>
<tr>
<td><code>make dist DIST_AS_EZS=true</code></td>
<td>打包成 ez 文件</td>
<td>.ez 压缩包</td>
<td>插件安装</td>
<td>插件分发、热加载</td>
</tr>
<tr>
<td><code>make package-generic-unix</code></td>
<td>打包成 PACKAGE 文件</td>
<td>tar.xz 包</td>
<td>解压安装</td>
<td>容器、跨平台</td>
</tr>
<tr>
<td><code>make install</code></td>
<td>系统安装</td>
<td>系统目录</td>
<td>系统安装</td>
<td>生产部署</td>
</tr>
</tbody></table>
<hr>
<h2 id="1-make-基础编译"><a href="#1-make-基础编译" class="headerlink" title="1. make - 基础编译"></a>1. <code>make</code> - 基础编译</h2><h3 id="技术原理"><a href="#技术原理" class="headerlink" title="技术原理"></a>技术原理</h3><p>基于 <strong>erlang.mk</strong> 构建系统，执行 Erlang&#x2F;OTP 标准编译流程。</p>
<h4 id="核心实现机制"><a href="#核心实现机制" class="headerlink" title="核心实现机制"></a>核心实现机制</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile (第 77 行)</span></span><br><span class="line"><span class="keyword">include</span> erlang.mk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 来源：erlang.mk 核心逻辑</span></span><br><span class="line"><span class="section">app:: deps <span class="variable">$(PROJECT)</span>.d</span></span><br><span class="line">  <span class="variable">$(verbose)</span> <span class="variable">$(MAKE)</span> --no-print-directory app-build</span><br></pre></td></tr></table></figure>

<h4 id="编译流程"><a href="#编译流程" class="headerlink" title="编译流程"></a>编译流程</h4><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">  ↓</span><br><span class="line">解析依赖</span><br><span class="line">  ↓</span><br><span class="line">编译 deps/</span><br><span class="line">  ↓</span><br><span class="line">编译 <span class="string">.erl</span> → <span class="string">.beam</span></span><br><span class="line">  ↓</span><br><span class="line">生成启动脚本</span><br><span class="line">  ↓</span><br><span class="line">创建 sbin/ 目录</span><br></pre></td></tr></table></figure>

<h3 id="生成的文件结构"><a href="#生成的文件结构" class="headerlink" title="生成的文件结构"></a>生成的文件结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-server/</span><br><span class="line">├── deps/                          <span class="comment"># 依赖模块</span></span><br><span class="line">│   ├── rabbit/ebin/*.beam        <span class="comment"># 核心模块字节码</span></span><br><span class="line">│   ├── rabbit_common/ebin/*.beam <span class="comment"># 公共模块字节码</span></span><br><span class="line">│   └── */ebin/*.beam             <span class="comment"># 其他插件字节码</span></span><br><span class="line">├── sbin/                         <span class="comment"># 启动脚本</span></span><br><span class="line">│   ├── rabbitmq-server          <span class="comment"># 主服务器脚本</span></span><br><span class="line">│   ├── rabbitmqctl              <span class="comment"># 管理工具</span></span><br><span class="line">│   └── rabbitmq-plugins         <span class="comment"># 插件管理</span></span><br><span class="line">└── escript/                      <span class="comment"># Erlang 脚本</span></span><br></pre></td></tr></table></figure>

<h3 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h3><ul>
<li><strong>开发调试</strong>: 快速编译，支持增量构建</li>
<li><strong>源码修改</strong>: 直接修改源码后重新编译</li>
<li><strong>性能测试</strong>: 最小化的编译开销</li>
</ul>
<hr>
<h2 id="2-make-dist-插件目录分发"><a href="#2-make-dist-插件目录分发" class="headerlink" title="2. make dist - 插件目录分发"></a>2. <code>make dist</code> - 插件目录分发</h2><h3 id="技术原理-1"><a href="#技术原理-1" class="headerlink" title="技术原理"></a>技术原理</h3><p>基于 <strong>rabbitmq-dist.mk</strong> 实现插件打包机制，创建标准的 RabbitMQ 插件目录结构。</p>
<h4 id="核心实现源码"><a href="#核心实现源码" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-dist.mk (第 166 行)</span></span><br><span class="line"><span class="section">dist:: <span class="variable">$(ERLANG_MK_RECURSIVE_DEPS_LIST)</span> all</span></span><br><span class="line">  <span class="variable">$(verbose)</span> rm -rf <span class="variable">$(DIST_DIR)</span></span><br><span class="line">  <span class="variable">$(verbose)</span> mkdir -p <span class="variable">$(DIST_DIR)</span></span><br><span class="line">  <span class="variable">$(gen_verbose)</span> <span class="variable">$(MAKE)</span> --no-print-directory do-dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件目录创建逻辑 (第 48-54 行)</span></span><br><span class="line">dist_$(1)_ez_dir = $<span class="variable">$(<span class="built_in">if</span> $(2)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)-$(2), \</span><br><span class="line">  $<span class="variable">$(<span class="built_in">if</span> $<span class="variable">$(VERSION)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)</span>-$<span class="variable">$(VERSION)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)))</span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(DIST_AS_EZS)</span>,)</span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir)  <span class="comment"># 目录格式</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir).ez  <span class="comment"># EZ 格式</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<h4 id="打包流程"><a href="#打包流程" class="headerlink" title="打包流程"></a>打包流程</h4><ol>
<li><strong>编译所有模块</strong> - 确保所有 <code>.erl</code> 文件编译为 <code>.beam</code></li>
<li><strong>收集依赖</strong> - 将所有插件和依赖收集到 <code>plugins/</code> 目录</li>
<li><strong>生成插件结构</strong> - 每个插件包含 <code>ebin/</code>、<code>priv/</code> 等标准目录</li>
<li><strong>创建元数据</strong> - 生成 <code>.app</code> 文件描述插件信息</li>
</ol>
<h3 id="生成的目录结构"><a href="#生成的目录结构" class="headerlink" title="生成的目录结构"></a>生成的目录结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">plugins/</span><br><span class="line">├── rabbit-4.0.5/                 <span class="comment"># 核心模块目录</span></span><br><span class="line">│   ├── ebin/</span><br><span class="line">│   │   ├── rabbit.app            <span class="comment"># 应用描述文件</span></span><br><span class="line">│   │   ├── rabbit.beam           <span class="comment"># 编译后的字节码</span></span><br><span class="line">│   │   └── *.beam                <span class="comment"># 其他模块字节码</span></span><br><span class="line">│   ├── include/                  <span class="comment"># 头文件</span></span><br><span class="line">│   └── priv/                     <span class="comment"># 私有资源</span></span><br><span class="line">├── rabbitmq_management-4.0.5/    <span class="comment"># 管理插件目录</span></span><br><span class="line">├── rabbitmq_prometheus-4.0.5/    <span class="comment"># 监控插件目录</span></span><br><span class="line">└── ...                           <span class="comment"># 其他插件目录</span></span><br></pre></td></tr></table></figure>

<h3 id="目录-vs-EZ-格式对比"><a href="#目录-vs-EZ-格式对比" class="headerlink" title="目录 vs EZ 格式对比"></a>目录 vs EZ 格式对比</h3><table>
<thead>
<tr>
<th>特性</th>
<th>目录格式</th>
<th>EZ 格式</th>
</tr>
</thead>
<tbody><tr>
<td><strong>存储</strong></td>
<td>展开的文件夹</td>
<td>压缩的 ZIP 文件</td>
</tr>
<tr>
<td><strong>加载速度</strong></td>
<td>快速</td>
<td>略慢（需解压）</td>
</tr>
<tr>
<td><strong>调试</strong></td>
<td>容易（直接访问文件）</td>
<td>困难（需解压查看）</td>
</tr>
<tr>
<td><strong>分发</strong></td>
<td>占用空间大</td>
<td>占用空间小</td>
</tr>
<tr>
<td><strong>热加载</strong></td>
<td>支持</td>
<td>更好支持</td>
</tr>
</tbody></table>
<hr>
<h2 id="3-make-dist-DIST-AS-EZS-true-EZ-压缩包分发"><a href="#3-make-dist-DIST-AS-EZS-true-EZ-压缩包分发" class="headerlink" title="3. make dist DIST_AS_EZS=true - EZ 压缩包分发"></a>3. <code>make dist DIST_AS_EZS=true</code> - EZ 压缩包分发</h2><h3 id="技术原理-2"><a href="#技术原理-2" class="headerlink" title="技术原理"></a>技术原理</h3><p>EZ 格式是 Erlang 的标准插件打包格式，本质上是重命名的 ZIP 文件。</p>
<h4 id="核心实现逻辑"><a href="#核心实现逻辑" class="headerlink" title="核心实现逻辑"></a>核心实现逻辑</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-dist.mk (第 8-14 行)</span></span><br><span class="line"><span class="comment"># Set $(DIST_AS_EZS) to a non-empty value to enable the packaging of</span></span><br><span class="line"><span class="comment"># plugins as .ez archives.</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(USE_RABBIT_BOOT_SCRIPT)</span>,)</span><br><span class="line">DIST_AS_EZS ?=                    <span class="comment"># 默认为空（目录格式）</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">DIST_AS_EZS =                     <span class="comment"># 强制目录格式</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<h4 id="EZ-文件生成过程"><a href="#EZ-文件生成过程" class="headerlink" title="EZ 文件生成过程"></a>EZ 文件生成过程</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">make dist DIST_AS_EZS<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">  ↓</span><br><span class="line">编译所有模块</span><br><span class="line">  ↓</span><br><span class="line">收集 ebin<span class="symbol">/</span> include<span class="symbol">/</span> priv<span class="symbol">/</span></span><br><span class="line">  ↓</span><br><span class="line">创建临时目录结构</span><br><span class="line">  ↓</span><br><span class="line">ZIP 压缩</span><br><span class="line">  ↓</span><br><span class="line">重命名为 .ez</span><br><span class="line">  ↓</span><br><span class="line">移动到 plugins<span class="operator">/</span></span><br></pre></td></tr></table></figure>

<h3 id="实际生成的-EZ-文件"><a href="#实际生成的-EZ-文件" class="headerlink" title="实际生成的 EZ 文件"></a>实际生成的 EZ 文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">plugins/</span><br><span class="line">├── rabbit-4.0.5.ez              <span class="comment"># 3.38 MB - 核心模块</span></span><br><span class="line">├── rabbit_common-4.0.5.ez       <span class="comment"># 770.91 KB - 公共模块  </span></span><br><span class="line">├── rabbitmq_management-4.0.5.ez <span class="comment"># 管理界面插件</span></span><br><span class="line">├── rabbitmq_prometheus-4.0.5.ez <span class="comment"># 监控插件</span></span><br><span class="line">├── amqp_client-4.0.5.ez         <span class="comment"># AMQP 客户端</span></span><br><span class="line">└── ...                          <span class="comment"># 其他插件 EZ 文件</span></span><br></pre></td></tr></table></figure>

<h3 id="EZ-文件内部结构"><a href="#EZ-文件内部结构" class="headerlink" title="EZ 文件内部结构"></a>EZ 文件内部结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EZ 文件实际上是 ZIP 格式</span></span><br><span class="line">$ unzip -l rabbit-4.0.5.ez</span><br><span class="line">Archive:  rabbit-4.0.5.ez</span><br><span class="line">  Length      Date    Time    Name</span><br><span class="line">---------  ---------- -----   ----</span><br><span class="line">     1234  2025-01-16 22:05   rabbit-4.0.5/ebin/rabbit.app</span><br><span class="line">    45678  2025-01-16 22:05   rabbit-4.0.5/ebin/rabbit.beam</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<h3 id="EZ-格式优势"><a href="#EZ-格式优势" class="headerlink" title="EZ 格式优势"></a>EZ 格式优势</h3><ol>
<li><strong>压缩存储</strong>: 减少磁盘占用和网络传输</li>
<li><strong>原子性</strong>: 单文件部署，避免部分文件丢失</li>
<li><strong>版本管理</strong>: 文件名包含版本信息</li>
<li><strong>热加载</strong>: Erlang VM 原生支持 EZ 文件热加载</li>
</ol>
<hr>
<h2 id="4-make-package-generic-unix-通用-Unix-包"><a href="#4-make-package-generic-unix-通用-Unix-包" class="headerlink" title="4. make package-generic-unix - 通用 Unix 包"></a>4. <code>make package-generic-unix</code> - 通用 Unix 包</h2><h3 id="技术原理-3"><a href="#技术原理-3" class="headerlink" title="技术原理"></a>技术原理</h3><p>创建跨平台的 tar.xz 安装包，包含完整的 RabbitMQ 运行环境。</p>
<h4 id="核心实现源码-1"><a href="#核心实现源码-1" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：packaging/generic-unix/Makefile (第 33-76 行)</span></span><br><span class="line">SOURCE_DIR = rabbitmq-server-<span class="variable">$(VERSION)</span></span><br><span class="line">TARGET_DIR = rabbitmq_server-<span class="variable">$(VERSION)</span></span><br><span class="line">TARGET_TARBALL = rabbitmq-server-<span class="variable">$(TARBALL_SUFFIX)</span>-<span class="variable">$(VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="section">dist:</span></span><br><span class="line">  <span class="comment"># 解压源码包</span></span><br><span class="line">  xzcat <span class="variable">$(SOURCE_DIST_FILE)</span> | tar -xf -</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 编译并安装到目标目录</span></span><br><span class="line">  <span class="variable">$(MAKE)</span> -C <span class="variable">$(SOURCE_DIR)</span> \</span><br><span class="line">    PREFIX= RMQ_ROOTDIR= \</span><br><span class="line">    RMQ_ERLAPP_DIR=`pwd`/<span class="variable">$(TARGET_DIR)</span> \</span><br><span class="line">    MANDIR=`pwd`/<span class="variable">$(TARGET_DIR)</span>/share/man \</span><br><span class="line">    manpages web-manpages install install-man</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 修改配置文件</span></span><br><span class="line">  sed -e &#x27;s:^SYS_PREFIX=$$:SYS_PREFIX=\$$&#123;RABBITMQ_HOME&#125;:&#x27; \</span><br><span class="line">        <span class="variable">$(TARGET_DIR)</span>/sbin/rabbitmq-defaults &gt;<span class="variable">$(TARGET_DIR)</span>/sbin/rabbitmq-defaults.tmp</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 创建 tar.xz 包</span></span><br><span class="line">  find <span class="variable">$(TARGET_DIR)</span> | LC_COLLATE=C sort &gt; <span class="variable">$(TARGET_TARBALL)</span>.manifest</span><br><span class="line">  tar --no-recursion -T <span class="variable">$(TARGET_TARBALL)</span>.manifest -cf - | \</span><br><span class="line">  xz &gt; <span class="variable">$(CURDIR)</span>/<span class="variable">$(TARGET_TARBALL)</span>.tar.xz</span><br></pre></td></tr></table></figure>

<h4 id="打包流程-1"><a href="#打包流程-1" class="headerlink" title="打包流程"></a>打包流程</h4><ol>
<li><strong>解压源码包</strong> - 从 tar.xz 源码包开始</li>
<li><strong>编译安装</strong> - 使用标准 Unix 安装路径</li>
<li><strong>生成文档</strong> - 创建 man 手册页</li>
<li><strong>配置脚本</strong> - 调整启动脚本的路径变量</li>
<li><strong>创建归档</strong> - 打包成 tar.xz 格式</li>
</ol>
<h3 id="生成的包结构"><a href="#生成的包结构" class="headerlink" title="生成的包结构"></a>生成的包结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实际生成：PACKAGES/</span></span><br><span class="line">PACKAGES/</span><br><span class="line">├── rabbitmq-server-4.0.5.tar.xz           <span class="comment"># 4.95 MB - 源码包</span></span><br><span class="line">├── rabbitmq-server-generic-unix-4.0.5.tar.xz  <span class="comment"># 15.51 MB - 通用包</span></span><br><span class="line">├── rabbitmq-server-4.0.5.manifest         <span class="comment"># 230.22 KB - 文件清单</span></span><br><span class="line">└── rabbitmq-server-4.0.5/                 <span class="comment"># 解压后的源码目录</span></span><br></pre></td></tr></table></figure>

<h3 id="通用包内容分析"><a href="#通用包内容分析" class="headerlink" title="通用包内容分析"></a>通用包内容分析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压通用包后的目录结构</span></span><br><span class="line">rabbitmq_server-4.0.5/</span><br><span class="line">├── sbin/                        <span class="comment"># 启动脚本</span></span><br><span class="line">│   ├── rabbitmq-server         <span class="comment"># 已配置 RABBITMQ_HOME</span></span><br><span class="line">│   ├── rabbitmqctl</span><br><span class="line">│   └── ...</span><br><span class="line">├── plugins/                     <span class="comment"># 插件目录</span></span><br><span class="line">├── etc/rabbitmq/               <span class="comment"># 配置目录</span></span><br><span class="line">├── share/man/                  <span class="comment"># 手册页</span></span><br><span class="line">└── escript/                    <span class="comment"># CLI 工具</span></span><br></pre></td></tr></table></figure>

<h3 id="通用包特点"><a href="#通用包特点" class="headerlink" title="通用包特点"></a>通用包特点</h3><ol>
<li><strong>自包含</strong>: 包含所有运行时依赖</li>
<li><strong>可移植</strong>: 适用于各种 Unix 系统</li>
<li><strong>标准化</strong>: 遵循 Unix 目录结构规范</li>
<li><strong>生产就绪</strong>: 包含完整的配置和文档</li>
</ol>
<hr>
<h2 id="5-make-install-系统级安装"><a href="#5-make-install-系统级安装" class="headerlink" title="5. make install - 系统级安装"></a>5. <code>make install</code> - 系统级安装</h2><h3 id="技术原理-4"><a href="#技术原理-4" class="headerlink" title="技术原理"></a>技术原理</h3><p>将 RabbitMQ 安装到系统标准目录，遵循 FHS (Filesystem Hierarchy Standard)。</p>
<h4 id="核心实现逻辑-1"><a href="#核心实现逻辑-1" class="headerlink" title="核心实现逻辑"></a>核心实现逻辑</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile 第 489-523 行</span></span><br><span class="line">PREFIX ?= /usr/local</span><br><span class="line">RMQ_ROOTDIR ?= <span class="variable">$(PREFIX)</span>/lib/erlang</span><br><span class="line">RMQ_BINDIR ?= <span class="variable">$(RMQ_ROOTDIR)</span>/bin</span><br><span class="line">RMQ_LIBDIR ?= <span class="variable">$(RMQ_ROOTDIR)</span>/lib</span><br><span class="line">RMQ_ERLAPP_DIR ?= <span class="variable">$(RMQ_LIBDIR)</span>/rabbitmq_server-<span class="variable">$(PROJECT_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="section">install: install-erlapp install-scripts</span></span><br><span class="line"></span><br><span class="line"><span class="section">install-erlapp: dist</span></span><br><span class="line">  <span class="variable">$(verbose)</span> mkdir -p <span class="variable">$(DESTDIR)</span><span class="variable">$(RMQ_ERLAPP_DIR)</span></span><br><span class="line">  <span class="variable">$(inst_verbose)</span> cp -r \</span><br><span class="line">    LICENSE* \</span><br><span class="line">    <span class="variable">$(DEPS_DIR)</span>/rabbit/INSTALL \</span><br><span class="line">    <span class="variable">$(DIST_DIR)</span> \</span><br><span class="line">    <span class="variable">$(DESTDIR)</span><span class="variable">$(RMQ_ERLAPP_DIR)</span></span><br></pre></td></tr></table></figure>

<h3 id="系统安装目录结构"><a href="#系统安装目录结构" class="headerlink" title="系统安装目录结构"></a>系统安装目录结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 典型的系统安装路径</span></span><br><span class="line">/usr/local/</span><br><span class="line">├── bin/                         <span class="comment"># 可执行文件</span></span><br><span class="line">│   ├── rabbitmq-server</span><br><span class="line">│   ├── rabbitmqctl</span><br><span class="line">│   └── ...</span><br><span class="line">├── lib/                         <span class="comment"># 库文件</span></span><br><span class="line">│   └── erlang/lib/</span><br><span class="line">│       └── rabbitmq_server-4.0.5/</span><br><span class="line">│           ├── ebin/           <span class="comment"># 字节码文件</span></span><br><span class="line">│           ├── include/        <span class="comment"># 头文件</span></span><br><span class="line">│           └── plugins/        <span class="comment"># 插件目录</span></span><br><span class="line">├── etc/                        <span class="comment"># 配置文件</span></span><br><span class="line">│   └── rabbitmq/</span><br><span class="line">│       └── rabbitmq.conf</span><br><span class="line">├── var/                        <span class="comment"># 数据目录</span></span><br><span class="line">│   ├── <span class="built_in">log</span>/rabbitmq/          <span class="comment"># 日志</span></span><br><span class="line">│   └── lib/rabbitmq/          <span class="comment"># 数据库</span></span><br><span class="line">└── share/                      <span class="comment"># 文档</span></span><br><span class="line">    └── man/                    <span class="comment"># 手册页</span></span><br></pre></td></tr></table></figure>

<h3 id="安装组件"><a href="#安装组件" class="headerlink" title="安装组件"></a>安装组件</h3><ol>
<li><strong>核心应用</strong> (<code>install-erlapp</code>)</li>
<li><strong>启动脚本</strong> (<code>install-scripts</code>)</li>
<li><strong>命令行工具</strong> (<code>install-bin</code>)</li>
<li><strong>手册页</strong> (<code>install-man</code>)</li>
</ol>
<h3 id="系统安装优势"><a href="#系统安装优势" class="headerlink" title="系统安装优势"></a>系统安装优势</h3><ol>
<li><strong>标准化</strong>: 遵循 Unix 标准目录结构</li>
<li><strong>多用户</strong>: 支持系统级多用户访问</li>
<li><strong>服务集成</strong>: 便于集成到系统服务管理</li>
<li><strong>权限管理</strong>: 利用系统权限控制</li>
</ol>
<hr>
<h2 id="构建系统架构"><a href="#构建系统架构" class="headerlink" title="构建系统架构"></a>构建系统架构</h2><h3 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h3><h4 id="1-erlang-mk"><a href="#1-erlang-mk" class="headerlink" title="1. erlang.mk"></a>1. <strong>erlang.mk</strong></h4><ul>
<li><strong>作用</strong>: Erlang 项目的标准构建工具</li>
<li><strong>功能</strong>: 依赖管理、编译、测试、发布</li>
</ul>
<h4 id="2-rabbitmq-components-mk"><a href="#2-rabbitmq-components-mk" class="headerlink" title="2. rabbitmq-components.mk"></a>2. <strong>rabbitmq-components.mk</strong></h4><ul>
<li><strong>作用</strong>: RabbitMQ 特定的构建规则</li>
<li><strong>功能</strong>: 版本管理、插件系统、发布流程</li>
</ul>
<h4 id="3-rabbitmq-dist-mk"><a href="#3-rabbitmq-dist-mk" class="headerlink" title="3. rabbitmq-dist.mk"></a>3. <strong>rabbitmq-dist.mk</strong></h4><ul>
<li><strong>作用</strong>: 插件分发机制</li>
<li><strong>功能</strong>: EZ 打包、插件依赖、版本控制</li>
</ul>
<h3 id="关键配置文件"><a href="#关键配置文件" class="headerlink" title="关键配置文件"></a>关键配置文件</h3><h4 id="Makefile-主控制文件"><a href="#Makefile-主控制文件" class="headerlink" title="Makefile - 主控制文件"></a>Makefile - 主控制文件</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile (第 1-30 行)</span></span><br><span class="line">PROJECT = rabbitmq_server_release</span><br><span class="line">PROJECT_DESCRIPTION = RabbitMQ Server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件列表</span></span><br><span class="line"><span class="keyword">include</span> plugins.mk</span><br><span class="line">DEPS = rabbit_common rabbit <span class="variable">$(PLUGINS)</span> <span class="variable">$(ADDITIONAL_PLUGINS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建系统</span></span><br><span class="line"><span class="keyword">include</span> rabbitmq-components.mk</span><br><span class="line"><span class="keyword">include</span> erlang.mk</span><br></pre></td></tr></table></figure>

<h4 id="plugins-mk-插件定义"><a href="#plugins-mk-插件定义" class="headerlink" title="plugins.mk - 插件定义"></a>plugins.mk - 插件定义</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：plugins.mk</span></span><br><span class="line">PLUGINS = \</span><br><span class="line">  rabbitmq_amqp1_0 \</span><br><span class="line">  rabbitmq_auth_backend_cache \</span><br><span class="line">  rabbitmq_auth_backend_http \</span><br><span class="line">  rabbitmq_auth_backend_ldap \</span><br><span class="line">  rabbitmq_auth_backend_oauth2 \</span><br><span class="line">  rabbitmq_auth_mechanism_ssl \</span><br><span class="line">  rabbitmq_consistent_hash_exchange \</span><br><span class="line">  <span class="comment"># ... 更多插件</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="编译流程对比"><a href="#编译流程对比" class="headerlink" title="编译流程对比"></a>编译流程对比</h2><h3 id="性能和资源对比"><a href="#性能和资源对比" class="headerlink" title="性能和资源对比"></a>性能和资源对比</h3><table>
<thead>
<tr>
<th>编译方式</th>
<th>编译时间</th>
<th>磁盘占用</th>
<th>内存使用</th>
<th>网络传输</th>
</tr>
</thead>
<tbody><tr>
<td><code>make</code></td>
<td>最快</td>
<td>中等</td>
<td>低</td>
<td>不适用</td>
</tr>
<tr>
<td><code>make dist</code></td>
<td>快</td>
<td>大</td>
<td>中等</td>
<td>大</td>
</tr>
<tr>
<td><code>make dist DIST_AS_EZS=true</code></td>
<td>中等</td>
<td>小</td>
<td>中等</td>
<td>小</td>
</tr>
<tr>
<td><code>make package-generic-unix</code></td>
<td>慢</td>
<td>最小</td>
<td>高</td>
<td>最小</td>
</tr>
<tr>
<td><code>make install</code></td>
<td>中等</td>
<td>中等</td>
<td>低</td>
<td>不适用</td>
</tr>
</tbody></table>
<hr>
<h2 id="最佳实践指南"><a href="#最佳实践指南" class="headerlink" title="最佳实践指南"></a>最佳实践指南</h2><h3 id="开发阶段"><a href="#开发阶段" class="headerlink" title="开发阶段"></a>开发阶段</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 快速开发迭代</span></span><br><span class="line">make clean &amp;&amp; make</span><br><span class="line">sbin/rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件开发</span></span><br><span class="line">make dist</span><br><span class="line"><span class="comment"># 测试插件加载</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发调试</span></span><br><span class="line">make shell</span><br></pre></td></tr></table></figure>

<h3 id="测试阶段"><a href="#测试阶段" class="headerlink" title="测试阶段"></a>测试阶段</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 完整功能测试</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 验证 EZ 文件加载</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集成测试</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 在不同环境测试安装包</span></span><br></pre></td></tr></table></figure>

<h3 id="生产部署"><a href="#生产部署" class="headerlink" title="生产部署"></a>生产部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 容器化部署</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 使用 tar.xz 包构建 Docker 镜像</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 传统服务器部署  </span></span><br><span class="line">make install PREFIX=/opt/rabbitmq</span><br><span class="line"><span class="comment"># 系统级安装</span></span><br></pre></td></tr></table></figure>

<h3 id="插件分发"><a href="#插件分发" class="headerlink" title="插件分发"></a>插件分发</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 插件开发者</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 生成 .ez 文件用于分发</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件用户</span></span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> plugin_name</span><br><span class="line"><span class="comment"># 从 .ez 文件安装插件</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="高级配置选项"><a href="#高级配置选项" class="headerlink" title="高级配置选项"></a>高级配置选项</h2><h3 id="环境变量控制"><a href="#环境变量控制" class="headerlink" title="环境变量控制"></a>环境变量控制</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义插件目录</span></span><br><span class="line"><span class="built_in">export</span> DIST_DIR=/custom/plugins/path</span><br><span class="line">make dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义包输出目录</span></span><br><span class="line"><span class="built_in">export</span> PACKAGES_DIR=/custom/packages/path  </span><br><span class="line">make package-generic-unix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用社区插件</span></span><br><span class="line"><span class="built_in">export</span> COMMUNITY_PLUGINS=1</span><br><span class="line">make dist</span><br></pre></td></tr></table></figure>

<h3 id="编译优化"><a href="#编译优化" class="headerlink" title="编译优化"></a>编译优化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 并行编译</span></span><br><span class="line">make -j$(<span class="built_in">nproc</span>) dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 详细输出</span></span><br><span class="line">make V=1 dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 跳过测试</span></span><br><span class="line">make SKIP_TESTS=1 dist</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="源码关键文件索引"><a href="#源码关键文件索引" class="headerlink" title="源码关键文件索引"></a>源码关键文件索引</h2><table>
<thead>
<tr>
<th>文件</th>
<th>作用</th>
<th>关键内容</th>
</tr>
</thead>
<tbody><tr>
<td><code>Makefile</code></td>
<td>主构建文件</td>
<td>目标定义、变量设置</td>
</tr>
<tr>
<td><code>erlang.mk</code></td>
<td>Erlang 构建系统</td>
<td>编译规则、依赖管理</td>
</tr>
<tr>
<td><code>rabbitmq-components.mk</code></td>
<td>RabbitMQ 构建规则</td>
<td>版本控制、组件管理</td>
</tr>
<tr>
<td><code>deps/rabbit_common/mk/rabbitmq-dist.mk</code></td>
<td>分发系统</td>
<td>插件打包、EZ 格式</td>
</tr>
<tr>
<td><code>packaging/generic-unix/Makefile</code></td>
<td>Unix 打包</td>
<td>安装布局、脚本配置</td>
</tr>
<tr>
<td><code>plugins.mk</code></td>
<td>插件列表</td>
<td>所有官方插件定义</td>
</tr>
</tbody></table>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>RabbitMQ 的构建系统设计精良，通过不同的编译命令满足了从开发到生产的各种需求：</p>
<ol>
<li><strong><code>make</code></strong> - 开发基础，快速迭代</li>
<li><strong><code>make dist</code></strong> - 生产标准，目录部署  </li>
<li><strong><code>make dist DIST_AS_EZS=true</code></strong> - 插件分发，压缩高效</li>
<li><strong><code>make package-generic-unix</code></strong> - 跨平台部署，自包含</li>
<li><strong><code>make install</code></strong> - 系统集成，标准化安装</li>
</ol>
<p>理解这些编译方式的原理，有助于更好地进行 RabbitMQ 的开发、部署和运维工作。选择合适的编译方式，能够显著提升 RabbitMQ 的开发效率和部署质量。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/16/rabbitmq-rabbitmq-plugins-enable-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/16/rabbitmq-rabbitmq-plugins-enable-guide/" class="post-title-link" itemprop="url">RabbitMQ 插件启用问题排查指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-16 21:00:00 / 修改时间：21:59:04" itemprop="dateCreated datePublished" datetime="2026-01-16T21:00:00+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RabbitMQ-插件启用问题排查指南"><a href="#RabbitMQ-插件启用问题排查指南" class="headerlink" title="RabbitMQ 插件启用问题排查指南"></a>RabbitMQ 插件启用问题排查指南</h1><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>从源码编译运行 RabbitMQ 时，执行插件启用命令报错：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sbin/rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</span><br><span class="line">Error: :plugins_dir_does_not_exist</span><br><span class="line">Arguments given:</span><br><span class="line">        <span class="built_in">enable</span> rabbitmq_management</span><br><span class="line"></span><br><span class="line">Usage</span><br><span class="line"></span><br><span class="line">rabbitmq-plugins [--node &lt;node&gt;] [--longnames] [--quiet] <span class="built_in">enable</span> &lt;plugin1&gt; [ &lt;plugin2&gt;] | --all [--offline] [--online]</span><br></pre></td></tr></table></figure>

<p>即使设置了 <code>ERL_LIBS</code> 环境变量也无法解决：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="variable">$ERL_LIBS</span></span><br><span class="line">/Users/ericksun/workspace/rabbitmq-server/plugins</span><br></pre></td></tr></table></figure>

<h2 id="根因分析"><a href="#根因分析" class="headerlink" title="根因分析"></a>根因分析</h2><h3 id="ERL-LIBS-与-RABBITMQ-PLUGINS-DIR-的区别"><a href="#ERL-LIBS-与-RABBITMQ-PLUGINS-DIR-的区别" class="headerlink" title="ERL_LIBS 与 RABBITMQ_PLUGINS_DIR 的区别"></a>ERL_LIBS 与 RABBITMQ_PLUGINS_DIR 的区别</h3><table>
<thead>
<tr>
<th>环境变量</th>
<th>作用</th>
<th>使用者</th>
</tr>
</thead>
<tbody><tr>
<td><code>ERL_LIBS</code></td>
<td>告诉 Erlang VM 在哪里查找代码模块</td>
<td>Erlang 运行时</td>
</tr>
<tr>
<td><code>RABBITMQ_PLUGINS_DIR</code></td>
<td>告诉 rabbitmq-plugins 脚本插件目录位置</td>
<td>RabbitMQ 脚本</td>
</tr>
<tr>
<td><code>RABBITMQ_ENABLED_PLUGINS_FILE</code></td>
<td>指定启用插件配置文件的位置</td>
<td>RabbitMQ 脚本</td>
</tr>
</tbody></table>
<p><code>ERL_LIBS</code> 只是让 Erlang 能找到代码，但 <code>rabbitmq-plugins</code> 脚本需要 <code>RABBITMQ_PLUGINS_DIR</code> 来定位插件目录。</p>
<h3 id="默认路径问题"><a href="#默认路径问题" class="headerlink" title="默认路径问题"></a>默认路径问题</h3><p>从源码运行时，RabbitMQ 默认查找：</p>
<ul>
<li>插件目录：由 <code>RABBITMQ_HOME/plugins</code> 或 <code>RABBITMQ_PLUGINS_DIR</code> 指定</li>
<li>启用插件文件：<code>/etc/rabbitmq/enabled_plugins</code>（系统路径，源码环境下不存在）</li>
</ul>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="方案一：设置环境变量（推荐）"><a href="#方案一：设置环境变量（推荐）" class="headerlink" title="方案一：设置环境变量（推荐）"></a>方案一：设置环境变量（推荐）</h3><p>在 shell 配置文件（如 <code>~/.bashrc</code> 或 <code>~/.zshrc</code>）中添加：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RabbitMQ 源码开发环境配置</span></span><br><span class="line"><span class="built_in">export</span> RABBITMQ_HOME=/path/to/rabbitmq-server</span><br><span class="line"><span class="built_in">export</span> RABBITMQ_PLUGINS_DIR=<span class="variable">$RABBITMQ_HOME</span>/plugins</span><br><span class="line"><span class="built_in">export</span> RABBITMQ_ENABLED_PLUGINS_FILE=<span class="variable">$RABBITMQ_HOME</span>/etc/rabbitmq/enabled_plugins</span><br></pre></td></tr></table></figure>

<p>然后创建必要的目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$RABBITMQ_HOME</span>/etc/rabbitmq</span><br></pre></td></tr></table></figure>

<h3 id="方案二：命令行指定（临时使用）"><a href="#方案二：命令行指定（临时使用）" class="headerlink" title="方案二：命令行指定（临时使用）"></a>方案二：命令行指定（临时使用）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /path/to/rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建配置目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p etc/rabbitmq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用插件（使用 --offline 模式，不需要连接运行中的节点）</span></span><br><span class="line">RABBITMQ_PLUGINS_DIR=$(<span class="built_in">pwd</span>)/plugins \</span><br><span class="line">RABBITMQ_ENABLED_PLUGINS_FILE=$(<span class="built_in">pwd</span>)/etc/rabbitmq/enabled_plugins \</span><br><span class="line">sbin/rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management --offline</span><br></pre></td></tr></table></figure>

<h3 id="方案三：使用-make-命令"><a href="#方案三：使用-make-命令" class="headerlink" title="方案三：使用 make 命令"></a>方案三：使用 make 命令</h3><p>RabbitMQ 源码提供了便捷的 make 目标：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动带管理插件的开发节点</span></span><br><span class="line">make run-broker RABBITMQ_ENABLED_PLUGINS=<span class="string">&quot;rabbitmq_management&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="成功执行示例"><a href="#成功执行示例" class="headerlink" title="成功执行示例"></a>成功执行示例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ RABBITMQ_PLUGINS_DIR=$(<span class="built_in">pwd</span>)/plugins \</span><br><span class="line">  RABBITMQ_ENABLED_PLUGINS_FILE=$(<span class="built_in">pwd</span>)/etc/rabbitmq/enabled_plugins \</span><br><span class="line">  sbin/rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management --offline</span><br><span class="line"></span><br><span class="line">Enabling plugins on node rabbit@ERICKSUN-MC1:</span><br><span class="line">rabbitmq_management</span><br><span class="line"></span><br><span class="line">The following plugins have been configured:</span><br><span class="line">  rabbitmq_management</span><br><span class="line">  rabbitmq_management_agent</span><br><span class="line">  rabbitmq_web_dispatch</span><br><span class="line">Applying plugin configuration to rabbit@ERICKSUN-MC1...</span><br><span class="line">The following plugins have been enabled:</span><br><span class="line">  rabbitmq_management</span><br><span class="line">  rabbitmq_management_agent</span><br><span class="line">  rabbitmq_web_dispatch</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> 3 plugins.</span><br><span class="line">Offline change; changes will take effect at broker restart.</span><br></pre></td></tr></table></figure>

<h2 id="常用插件命令"><a href="#常用插件命令" class="headerlink" title="常用插件命令"></a>常用插件命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置环境变量（假设已在 rabbitmq-server 目录）</span></span><br><span class="line"><span class="built_in">export</span> RABBITMQ_PLUGINS_DIR=$(<span class="built_in">pwd</span>)/plugins</span><br><span class="line"><span class="built_in">export</span> RABBITMQ_ENABLED_PLUGINS_FILE=$(<span class="built_in">pwd</span>)/etc/rabbitmq/enabled_plugins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有可用插件</span></span><br><span class="line">sbin/rabbitmq-plugins list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出已启用的插件</span></span><br><span class="line">sbin/rabbitmq-plugins list --enabled</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用插件（离线模式）</span></span><br><span class="line">sbin/rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management --offline</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用插件</span></span><br><span class="line">sbin/rabbitmq-plugins <span class="built_in">disable</span> rabbitmq_management --offline</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用多个插件</span></span><br><span class="line">sbin/rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management rabbitmq_shovel --offline</span><br></pre></td></tr></table></figure>

<h2 id="常见插件说明"><a href="#常见插件说明" class="headerlink" title="常见插件说明"></a>常见插件说明</h2><table>
<thead>
<tr>
<th>插件名称</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>rabbitmq_management</code></td>
<td>Web 管理界面，默认端口 15672</td>
</tr>
<tr>
<td><code>rabbitmq_management_agent</code></td>
<td>管理插件的代理（自动依赖）</td>
</tr>
<tr>
<td><code>rabbitmq_web_dispatch</code></td>
<td>Web 请求分发（自动依赖）</td>
</tr>
<tr>
<td><code>rabbitmq_shovel</code></td>
<td>消息转发&#x2F;复制</td>
</tr>
<tr>
<td><code>rabbitmq_federation</code></td>
<td>跨集群消息联邦</td>
</tr>
<tr>
<td><code>rabbitmq_mqtt</code></td>
<td>MQTT 协议支持</td>
</tr>
<tr>
<td><code>rabbitmq_stomp</code></td>
<td>STOMP 协议支持</td>
</tr>
</tbody></table>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>从源码运行 RabbitMQ 时，需要正确设置以下环境变量：</p>
<ol>
<li><strong><code>RABBITMQ_PLUGINS_DIR</code></strong> - 指向 <code>plugins</code> 目录</li>
<li><strong><code>RABBITMQ_ENABLED_PLUGINS_FILE</code></strong> - 指向本地的 <code>enabled_plugins</code> 文件</li>
</ol>
<p><code>ERL_LIBS</code> 环境变量只影响 Erlang 代码加载路径，不能替代 RabbitMQ 自身的配置变量。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/16/rabbitmq-rabbitmq-final-solution-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/16/rabbitmq-rabbitmq-final-solution-summary/" class="post-title-link" itemprop="url">RabbitMQ 问题最终解决方案总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-16 16:00:00 / 修改时间：20:55:17" itemprop="dateCreated datePublished" datetime="2026-01-16T16:00:00+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RabbitMQ-问题最终解决方案总结"><a href="#RabbitMQ-问题最终解决方案总结" class="headerlink" title="RabbitMQ 问题最终解决方案总结"></a>RabbitMQ 问题最终解决方案总结</h1><h2 id="真正的根本原因：网络配置问题"><a href="#真正的根本原因：网络配置问题" class="headerlink" title="真正的根本原因：网络配置问题"></a>真正的根本原因：网络配置问题</h2><h3 id="问题真相"><a href="#问题真相" class="headerlink" title="问题真相"></a>问题真相</h3><p>经过深入调试，发现问题的<strong>真正根本原因</strong>是 <strong>hosts 文件配置错误</strong>：</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2026/01/16/rabbitmq-rabbitmq-final-solution-summary/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2024 – 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Zixiang Sun</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"hzsunzixiang/hzsunzixiang.github.io","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js" defer></script>

</body>
</html>
