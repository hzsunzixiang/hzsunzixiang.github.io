<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.svg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.svg">
  <link rel="mask-icon" href="/images/favicon.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Noto+Serif+SC:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Source+Code+Pro:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hzsunzixiang.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"default","show_result":true},"fold":{"enable":false,"height":500},"language":false,"highlight_theme":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":true,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
<meta property="og:type" content="website">
<meta property="og:title" content="Zixiang Sun&#39;s Blog">
<meta property="og:url" content="https://hzsunzixiang.github.io/">
<meta property="og:site_name" content="Zixiang Sun&#39;s Blog">
<meta property="og:description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Zixiang Sun">
<meta property="article:tag" content="CRAQ">
<meta property="article:tag" content="blog">
<meta property="article:tag" content="development">
<meta property="article:tag" content="distributed systems">
<meta property="article:tag" content="programming">
<meta property="article:tag" content="technology">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://hzsunzixiang.github.io/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Zixiang Sun's Blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Zixiang Sun's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Zixiang Sun's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Sharing thoughts on technology, programming, and life</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">17</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">9</span></a></li><li class="menu-item menu-item-erlang"><a href="/erlang/" rel="section"><i class="fa fa-code fa-fw"></i>Erlang</a></li><li class="menu-item menu-item-rabbitmq"><a href="/rabbitmq/" rel="section"><i class="fa fa-server fa-fw"></i>RabbitMQ</a></li><li class="menu-item menu-item-craq"><a href="/craq/" rel="section"><i class="fa fa-book fa-fw"></i>CRAQ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zixiang Sun"
      src="/images/avatar.svg">
  <p class="site-author-name" itemprop="name">Zixiang Sun</p>
  <div class="site-description" itemprop="description">Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hzsunzixiang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hzsunzixiang" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:17842379@qq.com" title="E-Mail → mailto:17842379@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/18/rabbitmq-rabbitmq-startup-systemd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/18/rabbitmq-rabbitmq-startup-systemd/" class="post-title-link" itemprop="url">RabbitMQ 启动方式与 Systemd 集成详解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-18 00:00:00 / 修改时间：12:42:21" itemprop="dateCreated datePublished" datetime="2026-01-18T00:00:00+08:00">2026-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RabbitMQ-启动方式与-Systemd-集成详解"><a href="#RabbitMQ-启动方式与-Systemd-集成详解" class="headerlink" title="RabbitMQ 启动方式与 Systemd 集成详解"></a>RabbitMQ 启动方式与 Systemd 集成详解</h1><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p><strong>以 RabbitMQ version: 3.9.21 版本为例</strong></p>
<ul>
<li><strong>systemd 的使用方式(shell、c、python、erlang)</strong></li>
<li><strong>RabbitMQ 的启动方式</strong></li>
<li><strong>systemd 库的源码分析</strong></li>
<li><strong>RabbitMQ 的启动脚本</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ERL_LIBS=/usr/lib/rabbitmq/lib/rabbitmq_server-3.9.21/plugins</span><br><span class="line"></span><br><span class="line">ERL_LIBS=/usr/lib/rabbitmq/lib/rabbitmq_server-3.9.21/plugins erl -noinput -s rabbit boot -boot start_sasl</span><br></pre></td></tr></table></figure>

<img src="/2026/01/18/rabbitmq-rabbitmq-startup-systemd/image2.svg" class="" title="RabbitMQ 启动架构图">

<img src="/2026/01/18/rabbitmq-rabbitmq-startup-systemd/image3.png" class="" title="启动流程">

<img src="/2026/01/18/rabbitmq-rabbitmq-startup-systemd/image4.png" class="" title="详细启动过程">

<img src="/2026/01/18/rabbitmq-rabbitmq-startup-systemd/image5.png" class="" title="启动状态">

<hr>
<h2 id="systemd-相关术语"><a href="#systemd-相关术语" class="headerlink" title="systemd 相关术语"></a>systemd 相关术语</h2><h3 id="术语解释"><a href="#术语解释" class="headerlink" title="术语解释"></a>术语解释</h3><table>
<thead>
<tr>
<th><strong>术语</strong></th>
<th><strong>英文对照</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>应用程序</strong></td>
<td>service script(App)</td>
<td></td>
</tr>
<tr>
<td><strong>服务名</strong></td>
<td>service</td>
<td></td>
</tr>
<tr>
<td><strong>服务管理器</strong></td>
<td>systemd</td>
<td>系统和服务管理器</td>
</tr>
<tr>
<td><strong>服务管理命令</strong></td>
<td>systemctl</td>
<td>与 systemd 进行交互的接口</td>
</tr>
</tbody></table>
<p>应用程序启动一般需要一定的启动时间才能初始化完毕，初始化完毕的时候可以通过某种方式通知服务管理器。</p>
<p><code>systemd-notify</code> 就是用来向服务管理器(systemd)<strong>通知启动完成</strong>及其他守护进程状态变化。</p>
<p><code>systemd-notify</code> 是 <code>sd_notify()</code> 函数的一个包装，使得 shell 脚本也能使用此功能。</p>
<img src="/2026/01/18/rabbitmq-rabbitmq-startup-systemd/image6.png" class="" title="systemd-notify 工作流程">

<h3 id="实例演示"><a href="#实例演示" class="headerlink" title="实例演示"></a>实例演示</h3><table>
<thead>
<tr>
<th><strong>术语</strong></th>
<th><strong>英文对照</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>应用程序</strong></td>
<td>service script(App)</td>
<td>helloworld.sh</td>
</tr>
<tr>
<td><strong>服务名</strong></td>
<td>service name</td>
<td>helloworld.service</td>
</tr>
<tr>
<td><strong>服务管理器</strong></td>
<td>systemd</td>
<td>系统和服务管理器</td>
</tr>
<tr>
<td><strong>服务管理命令</strong></td>
<td>systemctl</td>
<td>与 systemd 进行交互的接口</td>
</tr>
</tbody></table>
<img src="/2026/01/18/rabbitmq-rabbitmq-startup-systemd/image7.png" class="" title="实例演示架构">

<p><strong>示例代码：</strong> <a target="_blank" rel="noopener" href="https://github.com/hzsunzixiang/rabbitmq-server-debug/tree/main/book/systemd">https://github.com/hzsunzixiang/rabbitmq-server-debug/tree/main/book/systemd</a></p>
<h4 id="应用程序-helloworld-sh"><a href="#应用程序-helloworld-sh" class="headerlink" title="应用程序 (helloworld.sh)"></a>应用程序 (helloworld.sh)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">systemd-notify --ready --status=<span class="string">&quot;Waiting for data ...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> : ; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;...NOTIFY_SOCKET:[ <span class="variable">$NOTIFY_SOCKET</span> ]...&quot;</span> &gt; /tmp/notify.txt</span><br><span class="line">    systemd-notify --status=<span class="string">&quot;do something hello...&quot;</span></span><br><span class="line">    <span class="comment"># Do something with</span></span><br><span class="line">    <span class="built_in">sleep</span> 10</span><br><span class="line">    systemd-notify --status=<span class="string">&quot;do something world...&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h4 id="Service-配置-helloworld-service"><a href="#Service-配置-helloworld-service" class="headerlink" title="Service 配置 (helloworld.service)"></a>Service 配置 (helloworld.service)</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=HelloWorld Service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/helloworld.sh</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<h4 id="流程演示"><a href="#流程演示" class="headerlink" title="流程演示"></a>流程演示</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start helloworld</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;helloworld&quot;</span> &gt; /tmp/helloworld</span><br><span class="line">systemctl status helloworld</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="C-语言中的-systemd"><a href="#C-语言中的-systemd" class="headerlink" title="C 语言中的 systemd"></a>C 语言中的 systemd</h2><p>示例代码：<a target="_blank" rel="noopener" href="https://github.com/hzsunzixiang/rabbitmq-server-debug/tree/main/book/systemd/clang_systemd">https://github.com/hzsunzixiang/rabbitmq-server-debug/tree/main/book/systemd/clang_systemd</a></p>
<hr>
<h2 id="Python-中的-systemd"><a href="#Python-中的-systemd" class="headerlink" title="Python 中的 systemd"></a>Python 中的 systemd</h2><p>示例代码：<a target="_blank" rel="noopener" href="https://github.com/hzsunzixiang/rabbitmq-server-debug/tree/main/book/systemd/python_systemd">https://github.com/hzsunzixiang/rabbitmq-server-debug/tree/main/book/systemd/python_systemd</a></p>
<hr>
<h2 id="Erlang-中的-systemd"><a href="#Erlang-中的-systemd" class="headerlink" title="Erlang 中的 systemd"></a>Erlang 中的 systemd</h2><p><strong>注意：</strong> 需要设置 <code>NotifyAccess=all</code></p>
<h3 id="启动示例"><a href="#启动示例" class="headerlink" title="启动示例"></a>启动示例</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">application:ensure_all_started(systemd).</span><br><span class="line">&#123;ok,[enough,systemd]&#125;</span><br></pre></td></tr></table></figure>

<p>或者从 <code>rebar.config</code> 中配置依赖：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;deps, [enough]&#125;.</span><br></pre></td></tr></table></figure>

<h3 id="erlang-systemd-库特点"><a href="#erlang-systemd-库特点" class="headerlink" title="erlang-systemd 库特点"></a>erlang-systemd 库特点</h3><p>erlang-systemd 是一个 Erlang 库，用于在 Erlang 应用程序中集成 systemd。主要特点包括：</p>
<ol>
<li>支持 systemd 的所有通知类型，包括 READY、STATUS、WATCHDOG 等</li>
<li>支持 systemd 的所有进程管理功能，包括启动、停止、重启、暂停、恢复等</li>
<li>支持 systemd 的所有 unit 管理功能，包括注册、卸载、状态查询等</li>
<li>支持 systemd 的所有进程间通信功能，包括 socket 激活、文件描述符传递等</li>
<li>提供了一组方便的宏和函数，简化与 systemd 的交互过程</li>
</ol>
<h3 id="Socket-处理代码"><a href="#Socket-处理代码" class="headerlink" title="Socket 处理代码"></a>Socket 处理代码</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">os:putenv(<span class="string">&quot;NOTIFY_SOCKET&quot;</span>, <span class="string">&quot;/run/systemd/notify&quot;</span>).</span><br><span class="line">os:getenv(<span class="string">&quot;NOTIFY_SOCKET&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">notify_socket</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    State =</span><br><span class="line">        <span class="keyword">case</span> os:getenv(?NOTIFY_SOCKET) <span class="keyword">of</span></span><br><span class="line">            <span class="literal">false</span> -&gt;</span><br><span class="line">                [];</span><br><span class="line">            [<span class="string">$@</span> | AbstractPath] -&gt;</span><br><span class="line">                [<span class="number">0</span> | AbstractPath];</span><br><span class="line">            Path -&gt;</span><br><span class="line">                <span class="keyword">case</span> file:read_file_info(Path) <span class="keyword">of</span></span><br><span class="line">                    &#123;error, _Error&#125; -&gt;</span><br><span class="line">                        [];</span><br><span class="line">                    &#123;ok, #file_info&#123;access = Access&#125;&#125; <span class="keyword">when</span></span><br><span class="line">                        Access =:= write; Access =:= read_write</span><br><span class="line">                    -&gt;</span><br><span class="line">                        Path</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span>,</span><br><span class="line">    unset(notify),</span><br><span class="line">    State.</span><br></pre></td></tr></table></figure>

<img src="/2026/01/18/rabbitmq-rabbitmq-startup-systemd/image8.png" class="" title="Erlang systemd 集成">

<h3 id="关于-READY-通知的重要说明"><a href="#关于-READY-通知的重要说明" class="headerlink" title="关于 READY 通知的重要说明"></a>关于 READY 通知的重要说明</h3><p><strong>如果不发送 READY 通知会怎样？</strong></p>
<p>如果应用程序没有向 systemd 发送 READY 通知，systemd 会默认认为应用程序已经准备就绪，并开始接收请求。这种情况下，systemd 不会等待应用程序发送 READY 通知，而是直接将该进程标记为已就绪状态。</p>
<p><strong>使用 Type&#x3D;notify 的情况：</strong></p>
<p>如果应用程序没有 READY 通知机制，可以使用 systemd 的 <code>Type=notify</code> 选项，以便 systemd 等待应用程序发送 READY 通知。在这种情况下，systemd 会在启动应用程序时，将一条文件描述符（socket）传递给应用程序，应用程序可以使用该文件描述符向 systemd 发送 READY 通知。如果应用程序不发送 READY 通知，systemd 会超时并将该进程标记为启动失败。</p>
<hr>
<h2 id="systemd-在-RabbitMQ-启动中的具体作用"><a href="#systemd-在-RabbitMQ-启动中的具体作用" class="headerlink" title="systemd 在 RabbitMQ 启动中的具体作用"></a>systemd 在 RabbitMQ 启动中的具体作用</h2><img src="/2026/01/18/rabbitmq-rabbitmq-startup-systemd/image7.png" class="" title="RabbitMQ systemd 集成架构">

<h3 id="安装-RabbitMQ"><a href="#安装-RabbitMQ" class="headerlink" title="安装 RabbitMQ"></a>安装 RabbitMQ</h3><h4 id="配置-yum-源"><a href="#配置-yum-源" class="headerlink" title="配置 yum 源"></a>配置 yum 源</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/yum.repos.d/CentOS-Messaging-rabbitmq.repo</span><br></pre></td></tr></table></figure>

<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[centos-rabbitmq-38]</span></span><br><span class="line"><span class="attr">name</span>=CentOS-<span class="number">9</span> - RabbitMQ <span class="number">38</span></span><br><span class="line"><span class="attr">metalink</span>=https://mirrors.centos.org/metalink?repo=centos-messaging-sig-rabbitmq-<span class="number">38</span>-<span class="variable">$releasever</span>-stream&amp;arch=<span class="variable">$basearch</span>&amp;protocol=https,http</span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-Messaging</span><br></pre></td></tr></table></figure>

<h4 id="安装命令"><a href="#安装命令" class="headerlink" title="安装命令"></a>安装命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 yum 源</span></span><br><span class="line">yum install centos-release-rabbitmq-38.noarch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 rabbitmq</span></span><br><span class="line">yum install rabbitmq-server.aarch64</span><br></pre></td></tr></table></figure>

<h4 id="设置日志级别"><a href="#设置日志级别" class="headerlink" title="设置日志级别"></a>设置日志级别</h4><p>在 <code>/etc/rabbitmq/rabbitmq.conf</code> 中添加：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">log.file.level</span> = debug</span><br></pre></td></tr></table></figure>

<img src="/2026/01/18/rabbitmq-rabbitmq-startup-systemd/image9.png" class="" title="日志配置">

<img src="/2026/01/18/rabbitmq-rabbitmq-startup-systemd/image10.png" class="" title="启动日志">

<img src="/2026/01/18/rabbitmq-rabbitmq-startup-systemd/image11.png" class="" title="详细日志">

<h3 id="特别注意：域名配置"><a href="#特别注意：域名配置" class="headerlink" title="特别注意：域名配置"></a>特别注意：域名配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/hosts</span><br></pre></td></tr></table></figure>

<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::<span class="number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"><span class="number">127.0.0.1</span>   rabbitmq</span><br><span class="line"><span class="number">172.16.117.156</span>  rabbitmq</span><br></pre></td></tr></table></figure>

<p><strong>如果域名配置不正确，会出现以下错误：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</span><br><span class="line"><span class="comment"># &#123;:query, :rabbit@rabbitmq, &#123;:badrpc, :timeout&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">rabbitmqctl status</span><br><span class="line"><span class="comment"># Error: unable to perform an operation on node &#x27;rabbit@rabbitmq&#x27;.</span></span><br></pre></td></tr></table></figure>

<h3 id="RabbitMQ-Service-配置文件"><a href="#RabbitMQ-Service-配置文件" class="headerlink" title="RabbitMQ Service 配置文件"></a>RabbitMQ Service 配置文件</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemd unit example</span></span><br><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=RabbitMQ broker</span><br><span class="line"><span class="attr">After</span>=network.target epmd@<span class="number">0.0</span>.<span class="number">0.0</span>.socket</span><br><span class="line"><span class="attr">Wants</span>=network.target epmd@<span class="number">0.0</span>.<span class="number">0.0</span>.socket</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="comment"># 安全加固选项（可选）</span></span><br><span class="line"><span class="comment"># ProtectSystem=full</span></span><br><span class="line"><span class="comment"># ProtectHome=true</span></span><br><span class="line"><span class="comment"># PrivateDevices=true</span></span><br><span class="line"><span class="comment"># ProtectHostname=true</span></span><br><span class="line"><span class="comment"># ProtectClock=true</span></span><br><span class="line"><span class="comment"># ProtectKernelTunables=true</span></span><br><span class="line"><span class="comment"># ProtectKernelModules=true</span></span><br><span class="line"><span class="comment"># ProtectKernelLogs=true</span></span><br><span class="line"><span class="comment"># ProtectControlGroups=true</span></span><br><span class="line"><span class="comment"># RestrictRealtime=true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">User</span>=rabbitmq</span><br><span class="line"><span class="attr">Group</span>=rabbitmq</span><br><span class="line"><span class="attr">NotifyAccess</span>=all</span><br><span class="line"><span class="attr">TimeoutStartSec</span>=<span class="number">3600</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动重启配置（可选）</span></span><br><span class="line"><span class="comment"># Restart=on-failure</span></span><br><span class="line"><span class="comment"># RestartSec=10</span></span><br><span class="line"></span><br><span class="line"><span class="attr">WorkingDirectory</span>=/var/lib/rabbitmq</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/lib/rabbitmq/bin/rabbitmq-server</span><br><span class="line"><span class="attr">ExecStop</span>=/usr/lib/rabbitmq/bin/rabbitmqctl stop</span><br><span class="line"><span class="attr">ExecStop</span>=/bin/sh -c <span class="string">&quot;while ps -p $MAINPID &gt;/dev/null 2&gt;&amp;1; do sleep 1; done&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<h3 id="启动状态示例"><a href="#启动状态示例" class="headerlink" title="启动状态示例"></a>启动状态示例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status rabbitmq-server</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">● rabbitmq-server.service - RabbitMQ broker</span><br><span class="line"><span class="symbol">   Loaded:</span> loaded (<span class="keyword">/etc/</span>systemd<span class="keyword">/system/</span>rabbitmq-server.<span class="attr">service</span><span class="punctuation">;</span> <span class="attr">disabled</span><span class="punctuation">;</span> preset: disabled)</span><br><span class="line"><span class="symbol">   Active:</span> active (running) since Sat <span class="number">2025</span><span class="number">-01</span><span class="number">-04</span> <span class="number">01</span>:<span class="number">10</span>:<span class="number">28</span> EST<span class="punctuation">;</span> <span class="number">39</span>s ago</span><br><span class="line"> Main PID: <span class="number">164224</span> (beam.smp)</span><br><span class="line"><span class="symbol">    Tasks:</span> <span class="number">27</span> (limit: <span class="number">22563</span>)</span><br><span class="line"><span class="symbol">   Memory:</span> <span class="number">124.8</span>M</span><br><span class="line"><span class="symbol">      CPU:</span> <span class="number">5.890</span>s</span><br><span class="line"><span class="symbol">   CGroup:</span> /system.slice/rabbitmq-server.service</span><br><span class="line">           ├─<span class="number">164224</span> <span class="keyword">/usr/</span>local<span class="keyword">/lib/</span>erlang/erts<span class="number">-14.2</span><span class="number">.5</span><span class="number">.1</span><span class="keyword">/bin/</span>beam.smp ...</span><br><span class="line">           ├─<span class="number">164235</span> erl_child_setup <span class="number">1024</span></span><br><span class="line">           ├─<span class="number">164294</span> <span class="keyword">/usr/</span>local<span class="keyword">/lib/</span>erlang/erts<span class="number">-14.2</span><span class="number">.5</span><span class="number">.1</span><span class="keyword">/bin/</span>inet_gethost <span class="number">4</span></span><br><span class="line">           └─<span class="number">164295</span> <span class="keyword">/usr/</span>local<span class="keyword">/lib/</span>erlang/erts<span class="number">-14.2</span><span class="number">.5</span><span class="number">.1</span><span class="keyword">/bin/</span>inet_gethost <span class="number">4</span></span><br></pre></td></tr></table></figure>

<img src="/2026/01/18/rabbitmq-rabbitmq-startup-systemd/image12.png" class="" title="服务状态">

<img src="/2026/01/18/rabbitmq-rabbitmq-startup-systemd/image13.png" class="" title="详细状态">

<h3 id="环境变量说明"><a href="#环境变量说明" class="headerlink" title="环境变量说明"></a>环境变量说明</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">NOTIFY_SOCKET</span><span class="symbol">:/run/systemd/notify</span></span><br><span class="line"><span class="variable constant_">RABBITMQ_ALLOW_INPUT</span><span class="symbol">:</span>, <span class="variable constant_">RUNNING_UNDER_SYSTEMD</span><span class="symbol">:true</span> <span class="symbol">detached:</span></span><br></pre></td></tr></table></figure>

<img src="/2026/01/18/rabbitmq-rabbitmq-startup-systemd/image14.png" class="" title="环境变量">

<h3 id="启动状态日志"><a href="#启动状态日志" class="headerlink" title="启动状态日志"></a>启动状态日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;Change boot state to&quot;</span> /var/log/rabbitmq/*</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/<span class="keyword">log</span>/rabbitmq/rabbit@rabbitmq.<span class="keyword">log</span>:<span class="number">2025</span>-<span class="number">01</span>-<span class="number">04</span> <span class="number">07</span>:<span class="number">59</span>:<span class="number">46.747822</span>-<span class="number">05</span>:<span class="number">00</span> [<span class="keyword">debug</span>] <span class="variable">&lt;0.237.0&gt;</span> Change boot <span class="keyword">state</span> <span class="keyword">to</span> `core_started`</span><br><span class="line">/var/<span class="keyword">log</span>/rabbitmq/rabbit@rabbitmq.<span class="keyword">log</span>:<span class="number">2025</span>-<span class="number">01</span>-<span class="number">04</span> <span class="number">07</span>:<span class="number">59</span>:<span class="number">46.898118</span>-<span class="number">05</span>:<span class="number">00</span> [<span class="keyword">debug</span>] <span class="variable">&lt;0.477.0&gt;</span> Change boot <span class="keyword">state</span> <span class="keyword">to</span> `ready`</span><br></pre></td></tr></table></figure>

<h3 id="systemd-状态通知日志"><a href="#systemd-状态通知日志" class="headerlink" title="systemd 状态通知日志"></a>systemd 状态通知日志</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2025</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">14</span>:<span class="number">20</span>:<span class="number">19.415916</span>+<span class="number">08</span>:<span class="number">00</span> [<span class="keyword">debug</span>] <span class="variable">&lt;0.132.0&gt;</span> Boot <span class="keyword">state</span>/systemd: sending non-systemd <span class="keyword">state</span> (stopped) as status description: <span class="string">&quot;Standing by&quot;</span></span><br><span class="line"><span class="number">2025</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">14</span>:<span class="number">59</span>:<span class="number">40.525333</span>+<span class="number">08</span>:<span class="number">00</span> [<span class="keyword">debug</span>] <span class="variable">&lt;0.132.0&gt;</span> Boot <span class="keyword">state</span>/systemd: sending non-systemd <span class="keyword">state</span> (core_started) as status description: <span class="string">&quot;Startup in progress (core ready, starting plugins)&quot;</span></span><br><span class="line"><span class="number">2025</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">50.174236</span>+<span class="number">08</span>:<span class="number">00</span> [<span class="keyword">debug</span>] <span class="variable">&lt;0.132.0&gt;</span> Boot <span class="keyword">state</span>/systemd: sending non-systemd <span class="keyword">state</span> (stopping) as status description: <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="number">2025</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">55.186351</span>+<span class="number">08</span>:<span class="number">00</span> [<span class="keyword">debug</span>] <span class="variable">&lt;0.132.0&gt;</span> Boot <span class="keyword">state</span>/systemd: sending non-systemd <span class="keyword">state</span> (stopped) as status description: <span class="string">&quot;Standing by&quot;</span></span><br><span class="line"><span class="number">2025</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">59.650639</span>+<span class="number">08</span>:<span class="number">00</span> [<span class="keyword">debug</span>] <span class="variable">&lt;0.132.0&gt;</span> Boot <span class="keyword">state</span>/systemd: sending non-systemd <span class="keyword">state</span> (core_started) as status description: <span class="string">&quot;Startup in progress (core ready, starting plugins)&quot;</span></span><br><span class="line"><span class="number">2025</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">59.720193</span>+<span class="number">08</span>:<span class="number">00</span> [<span class="keyword">debug</span>] <span class="variable">&lt;0.132.0&gt;</span> Boot <span class="keyword">state</span>/systemd: notifying of <span class="keyword">state</span> `ready`</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> ready 之后，状态就不显示了。</p>
<img src="/2026/01/18/rabbitmq-rabbitmq-startup-systemd/image15.png" class="" title="启动状态图">

<hr>
<h2 id="Shell-的一些用法补充"><a href="#Shell-的一些用法补充" class="headerlink" title="Shell 的一些用法补充"></a>Shell 的一些用法补充</h2><h3 id="set-e"><a href="#set-e" class="headerlink" title="set -e"></a>set -e</h3><p>在 shell 脚本中，<code>set -e</code> 是一个非常有用的指令，它的作用是让脚本在遇到任何一个命令返回非零退出状态（即命令执行失败）时，立即停止执行。</p>
<p>具体来说，在没有设置 <code>set -e</code> 时，即使脚本中的某个命令执行失败（退出状态码不为 0），脚本也会继续执行后续的命令。而当设置了 <code>set -e</code> 后，一旦某个命令返回非零退出状态，脚本会立即终止，不再执行后续的命令。</p>
<h3 id="检测-systemd-环境"><a href="#检测-systemd-环境" class="headerlink" title="检测 systemd 环境"></a>检测 systemd 环境</h3><p>如果环境变量 <code>NOTIFY_SOCKET</code> 被设置了，那么就将 <code>RUNNING_UNDER_SYSTEMD</code> 变量赋值为 <code>true</code>，表示当前脚本正在 systemd 环境下运行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ <span class="string">&quot;<span class="variable">$NOTIFY_SOCKET</span>&quot;</span> ] &amp;&amp; RUNNING_UNDER_SYSTEMD=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="systemd-notify-命令帮助"><a href="#systemd-notify-命令帮助" class="headerlink" title="systemd-notify 命令帮助"></a>systemd-notify 命令帮助</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">systemd-notify [OPTIONS...] [VARIABLE=VALUE...]</span><br><span class="line"></span><br><span class="line">Notify the init system about service status updates.</span><br><span class="line"></span><br><span class="line">  -h --<span class="built_in">help</span>       Show this <span class="built_in">help</span></span><br><span class="line">     --version    Show package version</span><br><span class="line">     --ready      Inform the init system about service start-up completion</span><br><span class="line">     --pid[=PID]  Set main PID of daemon</span><br><span class="line">     --uid=USER   Set user to send from</span><br><span class="line">     --status=TEXT Set status text</span><br><span class="line">     --booted     Check <span class="keyword">if</span> the system was booted up with systemd</span><br><span class="line">     --readahead=ACTION Controls read-ahead operations</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文详细介绍了 RabbitMQ 与 systemd 的集成方式，包括：</p>
<ol>
<li><strong>systemd 基本概念</strong>：术语解释和工作原理</li>
<li><strong>多语言实现</strong>：Shell、C、Python、Erlang 中使用 systemd-notify</li>
<li><strong>RabbitMQ 启动流程</strong>：从 systemd 启动到 READY 通知的完整过程</li>
<li><strong>配置与调试</strong>：service 文件配置、日志级别设置、常见问题排查</li>
</ol>
<p>通过 systemd 管理 RabbitMQ 服务，可以获得更好的进程监控、自动重启、日志管理等功能，是生产环境部署的推荐方式。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/18/rabbitmq-rabbitmq-deps-systemd-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/18/rabbitmq-rabbitmq-deps-systemd-guide/" class="post-title-link" itemprop="url">RabbitMQ 依赖分析：Systemd 完整指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-18 00:00:00 / 修改时间：12:26:54" itemprop="dateCreated datePublished" datetime="2026-01-18T00:00:00+08:00">2026-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/RabbitMQ-Deps/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ Deps</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Systemd-完整指南：从原理到-RabbitMQ-实践"><a href="#Systemd-完整指南：从原理到-RabbitMQ-实践" class="headerlink" title="Systemd 完整指南：从原理到 RabbitMQ 实践"></a>Systemd 完整指南：从原理到 RabbitMQ 实践</h1><h2 id="1-Systemd-概述"><a href="#1-Systemd-概述" class="headerlink" title="1. Systemd 概述"></a>1. Systemd 概述</h2><h3 id="1-1-什么是-Systemd？"><a href="#1-1-什么是-Systemd？" class="headerlink" title="1.1 什么是 Systemd？"></a>1.1 什么是 Systemd？</h3><p>Systemd 是 Linux 系统的系统和服务管理器，负责：</p>
<ul>
<li>启动和管理系统服务</li>
<li>管理服务依赖关系</li>
<li>并行启动服务以加快启动速度</li>
<li>监控服务状态并自动重启</li>
</ul>
<h3 id="1-2-核心组件"><a href="#1-2-核心组件" class="headerlink" title="1.2 核心组件"></a>1.2 核心组件</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                         systemd                                  │</span><br><span class="line">│                    (服务管理器 PID <span class="number">1</span>)                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  systemctl      │  journalctl    │  systemd-notify              │</span><br><span class="line">│  (管理命令)      │  (日志查看)     │  (状态通知)                  │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Service Units (.service)                      │</span><br><span class="line">│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐ │</span><br><span class="line">│  │ nginx    │  │ sshd     │  │ mysql    │  │ rabbitmq-server  │ │</span><br><span class="line">│  └──────────┘  └──────────┘  └──────────┘  └──────────────────┘ │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-核心术语"><a href="#2-核心术语" class="headerlink" title="2. 核心术语"></a>2. 核心术语</h2><table>
<thead>
<tr>
<th>术语</th>
<th>英文</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>应用程序</strong></td>
<td>Service Script (App)</td>
<td>实际运行的程序，如 <code>helloworld.sh</code></td>
</tr>
<tr>
<td><strong>服务单元</strong></td>
<td>Service Unit</td>
<td>描述服务的配置文件，如 <code>helloworld.service</code></td>
</tr>
<tr>
<td><strong>服务管理器</strong></td>
<td>systemd</td>
<td>系统和服务管理守护进程 (PID 1)</td>
</tr>
<tr>
<td><strong>管理命令</strong></td>
<td>systemctl</td>
<td>与 systemd 交互的命令行工具</td>
</tr>
<tr>
<td><strong>通知机制</strong></td>
<td>sd_notify &#x2F; systemd-notify</td>
<td>服务向 systemd 报告状态的机制</td>
</tr>
</tbody></table>
<hr>
<h2 id="3-服务通知机制"><a href="#3-服务通知机制" class="headerlink" title="3. 服务通知机制"></a>3. 服务通知机制</h2><h3 id="3-1-为什么需要通知机制？"><a href="#3-1-为什么需要通知机制？" class="headerlink" title="3.1 为什么需要通知机制？"></a>3.1 为什么需要通知机制？</h3><p>应用程序启动需要一定时间才能完成初始化。systemd 需要知道服务何时真正就绪：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────┐    启动命令     ┌─────────────────┐</span><br><span class="line">│   systemd   │ ─────────────► │   应用程序       │</span><br><span class="line">│             │                │                  │</span><br><span class="line">│  等待通知<span class="string">...</span> │ ◄───READY=1─── │ 初始化完成后通知  │</span><br><span class="line">│             │                │                  │</span><br><span class="line">│  服务已就绪  │                │  继续运行<span class="string">...</span>     │</span><br><span class="line">└─────────────┘                └─────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="3-2-服务类型-Type"><a href="#3-2-服务类型-Type" class="headerlink" title="3.2 服务类型 (Type)"></a>3.2 服务类型 (Type)</h3><table>
<thead>
<tr>
<th>Type</th>
<th>描述</th>
<th>就绪判断</th>
</tr>
</thead>
<tbody><tr>
<td><code>simple</code></td>
<td>默认类型</td>
<td><code>ExecStart</code> 进程启动即就绪</td>
</tr>
<tr>
<td><code>forking</code></td>
<td>传统守护进程</td>
<td>主进程 fork 后退出即就绪</td>
</tr>
<tr>
<td><strong><code>notify</code></strong></td>
<td>通知类型</td>
<td>收到 <code>READY=1</code> 通知即就绪</td>
</tr>
<tr>
<td><code>oneshot</code></td>
<td>一次性任务</td>
<td>进程退出即完成</td>
</tr>
</tbody></table>
<h3 id="3-3-通知协议"><a href="#3-3-通知协议" class="headerlink" title="3.3 通知协议"></a>3.3 通知协议</h3><p>通过 Unix Socket (<code>NOTIFY_SOCKET</code>) 发送状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 环境变量</span></span><br><span class="line">NOTIFY_SOCKET=/run/systemd/notify</span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用通知消息</span></span><br><span class="line">READY=1                    <span class="comment"># 服务就绪</span></span><br><span class="line">STATUS=Processing data     <span class="comment"># 状态描述（显示在 systemctl status）</span></span><br><span class="line">MAINPID=12345             <span class="comment"># 主进程 PID</span></span><br><span class="line">STOPPING=1                <span class="comment"># 正在停止</span></span><br><span class="line">RELOADING=1               <span class="comment"># 正在重载配置</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-systemd-notify-命令"><a href="#3-4-systemd-notify-命令" class="headerlink" title="3.4 systemd-notify 命令"></a>3.4 systemd-notify 命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通知就绪</span></span><br><span class="line">systemd-notify --ready</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新状态</span></span><br><span class="line">systemd-notify --status=<span class="string">&quot;Processing request...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 组合使用</span></span><br><span class="line">systemd-notify --ready --status=<span class="string">&quot;Waiting for connections&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>手册摘要</strong>：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">    systemd-notify - 通知服务管理器启动完成及其他状态变化</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">    systemd-notify [OPTIONS.<span class="string">..</span>] [VARIABLE=VALUE.<span class="string">..</span>]</span><br><span class="line"></span><br><span class="line">OPTIONS</span><br><span class="line">    <span class="params">--ready</span>       通知服务启动完成 <span class="params">(等价于 <span class="attr">READY</span>=1)</span></span><br><span class="line">    <span class="params">--status=</span>     发送人类可读的状态字符串</span><br><span class="line">    <span class="params">--pid=</span>        通知主进程 PID</span><br><span class="line">    <span class="params">--stopping</span>    通知正在停止</span><br><span class="line">    <span class="params">--reloading</span>   通知正在重载</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-四种语言实现示例"><a href="#4-四种语言实现示例" class="headerlink" title="4. 四种语言实现示例"></a>4. 四种语言实现示例</h2><h3 id="4-1-Shell-实现"><a href="#4-1-Shell-实现" class="headerlink" title="4.1 Shell 实现"></a>4.1 Shell 实现</h3><p><strong>服务脚本</strong> <code>helloworld.sh</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通知 systemd 服务已就绪</span></span><br><span class="line">systemd-notify --ready --status=<span class="string">&quot;Waiting for data ….....&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> 10</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> : ; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;...NOTIFY_SOCKET:[ <span class="variable">$NOTIFY_SOCKET</span> ]...&quot;</span> &gt; /tmp/notify.txt</span><br><span class="line">    systemd-notify --status=<span class="string">&quot;do something hello.....&quot;</span>   </span><br><span class="line">    <span class="built_in">sleep</span> 5 </span><br><span class="line">    systemd-notify --status=<span class="string">&quot;do something world.....&quot;</span>   </span><br><span class="line">    <span class="built_in">sleep</span> 5 </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><strong>服务单元</strong> <code>helloworld.service</code>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=HelloWorld Service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/helloworld.sh</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<p><strong>运行效果</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl status helloworld.service</span><br><span class="line">● helloworld.service - HelloWorld Service</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/helloworld.service; disabled)</span><br><span class="line">   Active: active (running) since Wed 2023-10-04 06:22:52 EDT</span><br><span class="line"> Main PID: 7039 (helloworld.sh)</span><br><span class="line">   Status: <span class="string">&quot;do something hello.....&quot;</span></span><br><span class="line">    Tasks: 1</span><br><span class="line">   CGroup: /system.slice/helloworld.service</span><br><span class="line">           └─7039 /bin/bash /usr/local/bin/helloworld.sh</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="4-2-C-语言实现"><a href="#4-2-C-语言实现" class="headerlink" title="4.2 C 语言实现"></a>4.2 C 语言实现</h3><p><strong>服务程序</strong> <code>helloworld_c.c</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="comment">// yum install systemd-devel</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;systemd/sd-daemon.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Starting up ...&quot;</span>);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Startup complete before notify&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通知 systemd 服务就绪</span></span><br><span class="line">    sd_notify(<span class="number">0</span>, <span class="string">&quot;READY=1&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    sd_notify(<span class="number">0</span>, <span class="string">&quot;STATUS=status message&quot;</span>);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(;;) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Hello from the Demo Service&quot;</span>);</span><br><span class="line">        sd_notify(<span class="number">0</span>, <span class="string">&quot;STATUS=Processing  data&quot;</span>);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        sd_notify(<span class="number">0</span>, <span class="string">&quot;STATUS=Waiting for data&quot;</span>);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>编译</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装开发库</span></span><br><span class="line"><span class="built_in">sudo</span> yum install systemd-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">gcc -o helloworld_c helloworld_c.c -lsystemd</span><br></pre></td></tr></table></figure>

<p><strong>服务单元</strong> <code>helloworld_c.service</code>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=HelloWorld Service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/helloworld_c</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<p><strong>核心 API</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sd_notify 函数原型</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sd_notify</span><span class="params">(<span class="type">int</span> unset_environment, <span class="type">const</span> <span class="type">char</span> *state)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 常用调用</span></span><br><span class="line">sd_notify(<span class="number">0</span>, <span class="string">&quot;READY=1&quot;</span>);                  <span class="comment">// 就绪通知</span></span><br><span class="line">sd_notify(<span class="number">0</span>, <span class="string">&quot;STATUS=Processing...&quot;</span>);     <span class="comment">// 状态更新</span></span><br><span class="line">sd_notify(<span class="number">0</span>, <span class="string">&quot;MAINPID=%d&quot;</span>, getpid());     <span class="comment">// PID 通知</span></span><br><span class="line">sd_notify(<span class="number">0</span>, <span class="string">&quot;STOPPING=1&quot;</span>);               <span class="comment">// 停止通知</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="4-3-Python-实现"><a href="#4-3-Python-实现" class="headerlink" title="4.3 Python 实现"></a>4.3 Python 实现</h3><p><strong>服务程序</strong> <code>helloworld.py</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line">    <span class="keyword">import</span> systemd.daemon</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Starting up ...&#x27;</span>)</span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Startup complete before notify&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 通知 systemd 服务就绪</span></span><br><span class="line">    systemd.daemon.notify(<span class="string">&#x27;READY=1&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Startup complete after notify&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Hello from the Python Demo Service&#x27;</span>)</span><br><span class="line">        systemd.daemon.notify(<span class="string">&quot;STATUS=Processing  data&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">5</span>)</span><br><span class="line">        systemd.daemon.notify(<span class="string">&quot;STATUS=Waiting for data&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<p><strong>依赖安装</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install systemd-python</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">yum install python-systemd</span><br></pre></td></tr></table></figure>

<p><strong>服务单元</strong> <code>helloworld.service</code>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=HelloWorld Service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/python /usr/local/bin/helloworld.py</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="4-4-Erlang-实现"><a href="#4-4-Erlang-实现" class="headerlink" title="4.4 Erlang 实现"></a>4.4 Erlang 实现</h3><p>Erlang 使用 <a target="_blank" rel="noopener" href="https://github.com/hauleth/systemd">systemd</a> 库与 systemd 集成。</p>
<p><strong>应用入口</strong> <code>erlang_systemd_app.erl</code>:</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-module</span><span class="params">(erlang_systemd_app)</span>.</span><br><span class="line"></span><br><span class="line"><span class="keyword">-export</span><span class="params">([boot/<span class="number">0</span>])</span>.</span><br><span class="line"><span class="keyword">-export</span><span class="params">([start/<span class="number">2</span>])</span>.</span><br><span class="line"><span class="keyword">-export</span><span class="params">([stop/<span class="number">1</span>])</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start</span><span class="params">(_Type, _Args)</span> -&gt;</span></span><br><span class="line">    boot().</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">boot</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    erlang_systemd_sup:start_link().</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stop</span><span class="params">(_State)</span> -&gt;</span></span><br><span class="line">    ok.</span><br></pre></td></tr></table></figure>

<p><strong>监督树</strong> <code>erlang_systemd_sup.erl</code>:</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-module</span><span class="params">(erlang_systemd_sup)</span>.</span><br><span class="line"><span class="keyword">-behaviour</span><span class="params">(supervisor)</span>.</span><br><span class="line"></span><br><span class="line"><span class="keyword">-export</span><span class="params">([start_link/<span class="number">0</span>])</span>.</span><br><span class="line"><span class="keyword">-export</span><span class="params">([init/<span class="number">1</span>])</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start_link</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    supervisor:start_link(&#123;local, ?MODULE&#125;, ?MODULE, []).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">init</span><span class="params">([])</span> -&gt;</span></span><br><span class="line">    SupFlags = #&#123;strategy =&gt; one_for_one,</span><br><span class="line">                 intensity =&gt; <span class="number">5</span>,</span><br><span class="line">                 period =&gt; <span class="number">3600</span>&#125;,</span><br><span class="line">    ChildSpecs = [child_static(frequency)],</span><br><span class="line">    &#123;ok, &#123;SupFlags, ChildSpecs&#125;&#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">child_static</span><span class="params">(Module)</span> -&gt;</span></span><br><span class="line">    &#123;Module, &#123;Module, start_link, []&#125;,</span><br><span class="line">     permanent, <span class="number">5000</span>, worker, [Module]&#125;.</span><br></pre></td></tr></table></figure>

<p><strong>核心工作进程</strong> <code>frequency.erl</code>:</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-module</span><span class="params">(frequency)</span>.</span><br><span class="line"><span class="keyword">-behaviour</span><span class="params">(gen_server)</span>.</span><br><span class="line"><span class="keyword">-compile</span><span class="params">(export_all)</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start_link</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    io:format(&#x27;Starting up ...\n&#x27;),</span><br><span class="line">    io:format(&#x27;Startup complete before notify\n&#x27;),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 启动 systemd 应用</span></span><br><span class="line">    &#123;ok, _&#125; = application:ensure_all_started(systemd),</span><br><span class="line">    timer:sleep(<span class="number">5000</span>),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 通知就绪</span></span><br><span class="line">    systemd:notify([ready, &#123;status, <span class="string">&quot;booting&quot;</span>&#125;]),</span><br><span class="line">    io:format(&#x27;after ready: Startup complete after notify\n&#x27;),</span><br><span class="line">    </span><br><span class="line">    timer:sleep(<span class="number">5000</span>),</span><br><span class="line">    systemd:notify([&#123;status, <span class="string">&quot;Processing  data&quot;</span>&#125;]),</span><br><span class="line">    io:format(&#x27;after:Processing  data: Startup complete after notify\n&#x27;),</span><br><span class="line">    </span><br><span class="line">    timer:sleep(<span class="number">5000</span>),</span><br><span class="line">    systemd:notify([&#123;status, <span class="string">&quot;After Processing  data&quot;</span>&#125;]),</span><br><span class="line">    io:format(&#x27;after:After Processing  data : Startup complete after notify\n&#x27;),</span><br><span class="line">    </span><br><span class="line">    timer:sleep(<span class="number">5000</span>),</span><br><span class="line">    systemd:notify([ready, &#123;status, <span class="string">&quot;booted&quot;</span>&#125;]),</span><br><span class="line">    io:format(&#x27;after:ready booted \n&#x27;),</span><br><span class="line">    </span><br><span class="line">    gen_server:start_link(&#123;local, frequency&#125;, frequency, [], []).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% ... gen_server 回调函数 ...</span></span><br></pre></td></tr></table></figure>

<p><strong>服务单元</strong> <code>helloworld.service</code>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=HelloWorld Service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">NotifyAccess</span>=all</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/helloworld.sh</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<p><strong>关键配置</strong>: <code>NotifyAccess=all</code> - 允许服务的任何子进程发送通知（Erlang VM 的通知来自子进程）</p>
<p><strong>Erlang systemd API</strong>:</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 通知就绪</span></span><br><span class="line">systemd:notify([ready]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 带状态的就绪通知</span></span><br><span class="line">systemd:notify([ready, &#123;status, <span class="string">&quot;Initialized&quot;</span>&#125;]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 状态更新</span></span><br><span class="line">systemd:notify([&#123;status, <span class="string">&quot;Processing data...&quot;</span>&#125;]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 停止通知</span></span><br><span class="line">systemd:notify([stopping]).</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-RabbitMQ-与-Systemd-集成"><a href="#5-RabbitMQ-与-Systemd-集成" class="headerlink" title="5. RabbitMQ 与 Systemd 集成"></a>5. RabbitMQ 与 Systemd 集成</h2><h3 id="5-1-RabbitMQ-服务单元"><a href="#5-1-RabbitMQ-服务单元" class="headerlink" title="5.1 RabbitMQ 服务单元"></a>5.1 RabbitMQ 服务单元</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/lib/systemd/system/rabbitmq-server.service</span></span><br><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=RabbitMQ broker</span><br><span class="line"><span class="attr">After</span>=network.target epmd@<span class="number">0.0</span>.<span class="number">0.0</span>.socket</span><br><span class="line"><span class="attr">Wants</span>=network.target epmd@<span class="number">0.0</span>.<span class="number">0.0</span>.socket</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">NotifyAccess</span>=all</span><br><span class="line"><span class="attr">User</span>=rabbitmq</span><br><span class="line"><span class="attr">Group</span>=rabbitmq</span><br><span class="line"><span class="attr">UMask</span>=<span class="number">0027</span></span><br><span class="line"><span class="attr">NotifyAccess</span>=all</span><br><span class="line"><span class="attr">TimeoutStartSec</span>=<span class="number">3600</span></span><br><span class="line"><span class="attr">LimitNOFILE</span>=<span class="number">32768</span></span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"><span class="attr">RestartSec</span>=<span class="number">10</span></span><br><span class="line"><span class="attr">WorkingDirectory</span>=/var/lib/rabbitmq</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/lib/rabbitmq/bin/rabbitmq-server</span><br><span class="line"><span class="attr">ExecStop</span>=/usr/lib/rabbitmq/bin/rabbitmqctl shutdown</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<h3 id="5-2-启动环境变量"><a href="#5-2-启动环境变量" class="headerlink" title="5.2 启动环境变量"></a>5.2 启动环境变量</h3><p>RabbitMQ 在 systemd 环境下设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NOTIFY_SOCKET=/run/systemd/notify</span><br><span class="line">RUNNING_UNDER_SYSTEMD=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-启动流程"><a href="#5-3-启动流程" class="headerlink" title="5.3 启动流程"></a>5.3 启动流程</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ systemctl start rabbitmq-server                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ <span class="number">1</span>. systemd 执行 ExecStart=/usr/lib/rabbitmq/bin/rabbitmq-server │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ <span class="number">2</span>. 启动 Erlang VM (beam.smp)                                    │</span><br><span class="line">│    NOTIFY_SOCKET 环境变量传递给 VM                               │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ <span class="number">3</span>. rabbit:boot/<span class="number">0</span> - RabbitMQ 核心启动                            │</span><br><span class="line">│    - 启动 Mnesia/Khepri 数据库                                  │</span><br><span class="line">│    - 加载插件                                                   │</span><br><span class="line">│    - 启动监听器                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ <span class="number">4</span>. Change boot <span class="keyword">state</span> <span class="keyword">to</span> `core_started`                          │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ <span class="number">5</span>. Change boot <span class="keyword">state</span> <span class="keyword">to</span> `ready`                                 │</span><br><span class="line">│    systemd:notify([ready, &#123;status, <span class="string">&quot;Initialized&quot;</span>&#125;])             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ systemd 收到 READY=<span class="number">1</span>，标记服务为 active (running)               │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="5-4-查看启动日志"><a href="#5-4-查看启动日志" class="headerlink" title="5.4 查看启动日志"></a>5.4 查看启动日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看启动状态变化</span></span><br><span class="line">$ grep <span class="string">&quot;Change boot state to&quot;</span> /var/log/rabbitmq/rabbit@rabbitmq.log</span><br><span class="line">2025-01-04 07:59:46.747822 [debug] &lt;0.237.0&gt; Change boot state to `core_started`</span><br><span class="line">2025-01-04 07:59:46.898118 [debug] &lt;0.477.0&gt; Change boot state to `ready`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 systemd 状态</span></span><br><span class="line">$ systemctl status rabbitmq-server.service</span><br><span class="line">● rabbitmq-server.service - RabbitMQ broker</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/rabbitmq-server.service; disabled)</span><br><span class="line">   Active: active (running) since Sat 2025-01-04 01:41:22 EST; 12min ago</span><br><span class="line"> Main PID: 69505 (beam.smp)</span><br><span class="line">   Status: <span class="string">&quot;Initialized&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-5-手动启动（非-systemd）"><a href="#5-5-手动启动（非-systemd）" class="headerlink" title="5.5 手动启动（非 systemd）"></a>5.5 手动启动（非 systemd）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置插件路径</span></span><br><span class="line"><span class="built_in">export</span> ERL_LIBS=/usr/lib/rabbitmq/lib/rabbitmq_server-3.9.21/plugins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Erlang VM 运行 RabbitMQ</span></span><br><span class="line">ERL_LIBS=/usr/lib/rabbitmq/lib/rabbitmq_server-3.9.21/plugins erl \</span><br><span class="line">    -noinput -s rabbit boot -boot start_sasl</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-实践操作指南"><a href="#6-实践操作指南" class="headerlink" title="6. 实践操作指南"></a>6. 实践操作指南</h2><h3 id="6-1-安装服务"><a href="#6-1-安装服务" class="headerlink" title="6.1 安装服务"></a>6.1 安装服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 复制程序到系统目录</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> helloworld.sh /usr/local/bin/</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> +x /usr/local/bin/helloworld.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 复制服务单元文件</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> helloworld.service /etc/systemd/system/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 重新加载 systemd 配置</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br></pre></td></tr></table></figure>

<h3 id="6-2-管理服务"><a href="#6-2-管理服务" class="headerlink" title="6.2 管理服务"></a>6.2 管理服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl start helloworld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl status helloworld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止服务</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl stop helloworld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl restart helloworld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> helloworld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用开机自启</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">disable</span> helloworld</span><br></pre></td></tr></table></figure>

<h3 id="6-3-查看日志"><a href="#6-3-查看日志" class="headerlink" title="6.3 查看日志"></a>6.3 查看日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看服务日志</span></span><br><span class="line">journalctl -u helloworld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实时跟踪日志</span></span><br><span class="line">journalctl -u helloworld -f</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看最近 100 行</span></span><br><span class="line">journalctl -u helloworld -n 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看启动以来的日志</span></span><br><span class="line">journalctl -u helloworld -b</span><br></pre></td></tr></table></figure>

<h3 id="6-4-调试通知"><a href="#6-4-调试通知" class="headerlink" title="6.4 调试通知"></a>6.4 调试通知</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 手动测试通知（需要在服务环境中）</span></span><br><span class="line">NOTIFY_SOCKET=/run/systemd/notify systemd-notify --ready</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 NOTIFY_SOCKET 环境变量</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$NOTIFY_SOCKET</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-对比总结"><a href="#7-对比总结" class="headerlink" title="7. 对比总结"></a>7. 对比总结</h2><table>
<thead>
<tr>
<th>语言</th>
<th>通知函数</th>
<th>依赖</th>
<th>复杂度</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Shell</strong></td>
<td><code>systemd-notify</code></td>
<td>无</td>
<td>最简单</td>
</tr>
<tr>
<td><strong>C</strong></td>
<td><code>sd_notify()</code></td>
<td>systemd-devel</td>
<td>简单</td>
</tr>
<tr>
<td><strong>Python</strong></td>
<td><code>systemd.daemon.notify()</code></td>
<td>python-systemd</td>
<td>简单</td>
</tr>
<tr>
<td><strong>Erlang</strong></td>
<td><code>systemd:notify/1</code></td>
<td>systemd (Hex)</td>
<td>中等</td>
</tr>
</tbody></table>
<h3 id="服务单元配置要点"><a href="#服务单元配置要点" class="headerlink" title="服务单元配置要点"></a>服务单元配置要点</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify          <span class="comment"># 必须设置为 notify</span></span><br><span class="line"><span class="attr">NotifyAccess</span>=all     <span class="comment"># Erlang/多进程应用需要设置</span></span><br><span class="line"><span class="attr">TimeoutStartSec</span>=<span class="number">90</span>   <span class="comment"># 给足启动超时时间</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-参考资源"><a href="#8-参考资源" class="headerlink" title="8. 参考资源"></a>8. 参考资源</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.freedesktop.org/software/systemd/man/">systemd 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freedesktop.org/software/systemd/man/sd_notify.html">sd_notify(3) 手册</a></li>
<li><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/install-rpm.html">RabbitMQ 安装指南</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/hauleth/systemd">Erlang systemd 库</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/hzsunzixiang/rabbitmq-server-debug/tree/main/book/systemd">示例代码仓库</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/17/rabbitmq-rabbitmq-deps-base64url-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/17/rabbitmq-rabbitmq-deps-base64url-analysis/" class="post-title-link" itemprop="url">RabbitMQ 依赖分析：base64url 模块深度解析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-17 00:00:00 / 修改时间：23:18:14" itemprop="dateCreated datePublished" datetime="2026-01-17T00:00:00+08:00">2026-01-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/RabbitMQ-Deps/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ Deps</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Base64url-模块深度解析"><a href="#Base64url-模块深度解析" class="headerlink" title="Base64url 模块深度解析"></a>Base64url 模块深度解析</h1><h2 id="1-模块概述"><a href="#1-模块概述" class="headerlink" title="1. 模块概述"></a>1. 模块概述</h2><p><code>base64url</code> 是 RabbitMQ 依赖的一个 URL 安全的 Base64 编解码器，遵循 <a target="_blank" rel="noopener" href="http://tools.ietf.org/html/rfc4648">RFC 4648</a> 标准。</p>
<h3 id="1-1-为什么需要-URL-安全的-Base64？"><a href="#1-1-为什么需要-URL-安全的-Base64？" class="headerlink" title="1.1 为什么需要 URL 安全的 Base64？"></a>1.1 为什么需要 URL 安全的 Base64？</h3><p>标准 Base64 编码会产生以下在 URL 中有特殊含义的字符：</p>
<table>
<thead>
<tr>
<th>字符</th>
<th>标准 Base64 含义</th>
<th>URL 中的含义</th>
<th>URL 安全替代</th>
</tr>
</thead>
<tbody><tr>
<td><code>+</code></td>
<td>第62个字符</td>
<td>空格 (form encoding)</td>
<td><code>-</code></td>
</tr>
<tr>
<td><code>/</code></td>
<td>第63个字符</td>
<td>路径分隔符</td>
<td><code>_</code></td>
</tr>
<tr>
<td><code>=</code></td>
<td>填充字符</td>
<td>参数分隔符</td>
<td>省略</td>
</tr>
</tbody></table>
<h3 id="1-2-对比示例"><a href="#1-2-对比示例" class="headerlink" title="1.2 对比示例"></a>1.2 对比示例</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 标准 Base64 (URL 不安全)</span></span><br><span class="line">base64:encode(&lt;&lt;<span class="number">255</span>,<span class="number">127</span>,<span class="number">254</span>,<span class="number">252</span>&gt;&gt;).</span><br><span class="line"><span class="comment">%% 结果: &lt;&lt;&quot;/3/+/A==&quot;&gt;&gt;</span></span><br><span class="line"><span class="comment">%%       包含 / + = 三种 URL 危险字符</span></span><br><span class="line"></span><br><span class="line"><span class="comment">%% URL 安全 Base64</span></span><br><span class="line">base64url:encode(&lt;&lt;<span class="number">255</span>,<span class="number">127</span>,<span class="number">254</span>,<span class="number">252</span>&gt;&gt;).</span><br><span class="line"><span class="comment">%% 结果: &lt;&lt;&quot;_3_-_A&quot;&gt;&gt;</span></span><br><span class="line"><span class="comment">%%       / → _,  + → -,  = 被移除</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-源码逐行解析"><a href="#2-源码逐行解析" class="headerlink" title="2. 源码逐行解析"></a>2. 源码逐行解析</h2><h3 id="2-1-模块声明部分"><a href="#2-1-模块声明部分" class="headerlink" title="2.1 模块声明部分"></a>2.1 模块声明部分</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%%</span></span><br><span class="line"><span class="comment">%% @doc URL safe base64-compatible codec.</span></span><br><span class="line"><span class="comment">%%</span></span><br><span class="line"><span class="comment">%% Based heavily on the code extracted from:</span></span><br><span class="line"><span class="comment">%%   https://github.com/basho/riak_control/blob/master/src/base64url.erl and</span></span><br><span class="line"><span class="comment">%%   https://github.com/mochi/mochiweb/blob/master/src/mochiweb_base64url.erl.</span></span><br><span class="line"><span class="comment">%%</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">-module</span><span class="params">(base64url)</span>.</span><br><span class="line"><span class="keyword">-author</span><span class="params">(&#x27;Vladimir Dronnikov &lt;dronnikov@gmail.com&gt;&#x27;)</span>.</span><br><span class="line"></span><br><span class="line"><span class="keyword">-export</span><span class="params">([</span></span><br><span class="line"><span class="params">    decode/<span class="number">1</span>,</span></span><br><span class="line"><span class="params">    encode/<span class="number">1</span>,</span></span><br><span class="line"><span class="params">    encode_mime/<span class="number">1</span></span></span><br><span class="line"><span class="params">  ])</span>.</span><br></pre></td></tr></table></figure>

<p><strong>解析</strong>：</p>
<ul>
<li><code>@doc</code> - EDoc 文档注释</li>
<li><code>-module(base64url)</code> - 模块名定义</li>
<li><code>-author(...)</code> - 作者声明</li>
<li><code>-export([...])</code> - 导出 3 个公共函数</li>
</ul>
<hr>
<h3 id="2-2-encode-1-函数"><a href="#2-2-encode-1-函数" class="headerlink" title="2.2 encode&#x2F;1 函数"></a>2.2 encode&#x2F;1 函数</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-spec</span> encode<span class="params">(</span></span><br><span class="line"><span class="params">    binary() | iolist()</span></span><br><span class="line"><span class="params">  )</span> -&gt; binary<span class="params">()</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">encode</span><span class="params">(Bin)</span> <span class="title">when</span> <span class="title">is_binary</span><span class="params">(Bin)</span> -&gt;</span></span><br><span class="line">  &lt;&lt; &lt;&lt; (urlencode_digit(D)) &gt;&gt; || &lt;&lt;D&gt;&gt; &lt;= base64:encode(Bin), D =/= <span class="string">$=</span> &gt;&gt;;</span><br><span class="line"><span class="function"><span class="title">encode</span><span class="params">(L)</span> <span class="title">when</span> <span class="title">is_list</span><span class="params">(L)</span> -&gt;</span></span><br><span class="line">  encode(iolist_to_binary(L)).</span><br></pre></td></tr></table></figure>

<p><strong>逐行解析</strong>：</p>
<h4 id="类型规范"><a href="#类型规范" class="headerlink" title="类型规范"></a>类型规范</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-spec</span> encode<span class="params">(binary() | iolist())</span> -&gt; binary<span class="params">()</span>.</span><br></pre></td></tr></table></figure>
<ul>
<li>输入：二进制或 iolist（嵌套列表&#x2F;二进制）</li>
<li>输出：二进制</li>
</ul>
<h4 id="二进制处理分支"><a href="#二进制处理分支" class="headerlink" title="二进制处理分支"></a>二进制处理分支</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">encode</span><span class="params">(Bin)</span> <span class="title">when</span> <span class="title">is_binary</span><span class="params">(Bin)</span> -&gt;</span></span><br><span class="line">  &lt;&lt; &lt;&lt; (urlencode_digit(D)) &gt;&gt; || &lt;&lt;D&gt;&gt; &lt;= base64:encode(Bin), D =/= <span class="string">$=</span> &gt;&gt;;</span><br></pre></td></tr></table></figure>

<p>这是一个<strong>二进制推导式 (Binary Comprehension)</strong>，等价于：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">encode</span><span class="params">(Bin)</span> -&gt;</span></span><br><span class="line">    Encoded = base64:encode(Bin),        <span class="comment">%% 步骤1: 标准 Base64 编码</span></span><br><span class="line">    FilteredAndMapped = lists:filtermap(</span><br><span class="line">        <span class="keyword">fun</span>(D) -&gt;</span><br><span class="line">            <span class="keyword">if</span> D =/= <span class="string">$=</span> -&gt;               <span class="comment">%% 步骤2: 过滤掉填充字符 &#x27;=&#x27;</span></span><br><span class="line">                &#123;true, urlencode_digit(D)&#125;;  <span class="comment">%% 步骤3: 字符替换</span></span><br><span class="line">               <span class="literal">true</span> -&gt; <span class="literal">false</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span>,</span><br><span class="line">        binary_to_list(Encoded)</span><br><span class="line">    ),</span><br><span class="line">    list_to_binary(FilteredAndMapped).</span><br></pre></td></tr></table></figure>

<p><strong>语法拆解</strong>：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt; &lt;&lt; (urlencode_digit(D)) &gt;&gt; || <span class="symbol">&lt;&lt;D&gt;&gt;</span> &lt;= base64:encode(Bin), D =/= $= &gt;&gt;</span><br><span class="line">   ├─────────────────────┤    ├─────┤   ├────────────────┤  ├────────┤</span><br><span class="line">         输出表达式        生成器      生成源               过滤条件</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;&lt;D&gt;&gt; &lt;= base64:encode(Bin)</code> - 从 base64 编码结果逐字节取出</li>
<li><code>D =/= $=</code> - 过滤条件：不等于 <code>=</code> 字符</li>
<li><code>&lt;&lt; (urlencode_digit(D)) &gt;&gt;</code> - 对每个字节调用转换函数</li>
</ul>
<h4 id="列表处理分支"><a href="#列表处理分支" class="headerlink" title="列表处理分支"></a>列表处理分支</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">encode</span><span class="params">(L)</span> <span class="title">when</span> <span class="title">is_list</span><span class="params">(L)</span> -&gt;</span></span><br><span class="line">  encode(iolist_to_binary(L)).</span><br></pre></td></tr></table></figure>
<ul>
<li>将 iolist 转为二进制后递归调用</li>
</ul>
<hr>
<h3 id="2-3-encode-mime-1-函数"><a href="#2-3-encode-mime-1-函数" class="headerlink" title="2.3 encode_mime&#x2F;1 函数"></a>2.3 encode_mime&#x2F;1 函数</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-spec</span> encode_mime<span class="params">(</span></span><br><span class="line"><span class="params">    binary() | iolist()</span></span><br><span class="line"><span class="params">  )</span> -&gt; binary<span class="params">()</span>.</span><br><span class="line"><span class="function"><span class="title">encode_mime</span><span class="params">(Bin)</span> <span class="title">when</span> <span class="title">is_binary</span><span class="params">(Bin)</span> -&gt;</span></span><br><span class="line">    &lt;&lt; &lt;&lt; (urlencode_digit(D)) &gt;&gt; || &lt;&lt;D&gt;&gt; &lt;= base64:encode(Bin) &gt;&gt;;</span><br><span class="line"><span class="function"><span class="title">encode_mime</span><span class="params">(L)</span> <span class="title">when</span> <span class="title">is_list</span><span class="params">(L)</span> -&gt;</span></span><br><span class="line">    encode_mime(iolist_to_binary(L)).</span><br></pre></td></tr></table></figure>

<p><strong>与 encode&#x2F;1 的区别</strong>：</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>填充字符 <code>=</code></th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td><code>encode/1</code></td>
<td>移除</td>
<td>纯 URL 安全</td>
</tr>
<tr>
<td><code>encode_mime/1</code></td>
<td>保留</td>
<td>MIME 兼容</td>
</tr>
</tbody></table>
<p><strong>注意</strong>：没有 <code>D =/= $=</code> 过滤条件，所以保留了填充字符。</p>
<hr>
<h3 id="2-4-decode-1-函数"><a href="#2-4-decode-1-函数" class="headerlink" title="2.4 decode&#x2F;1 函数"></a>2.4 decode&#x2F;1 函数</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-spec</span> decode<span class="params">(</span></span><br><span class="line"><span class="params">    binary() | iolist()</span></span><br><span class="line"><span class="params">  )</span> -&gt; binary<span class="params">()</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">decode</span><span class="params">(Bin)</span> <span class="title">when</span> <span class="title">is_binary</span><span class="params">(Bin)</span> -&gt;</span></span><br><span class="line">  Bin2 = <span class="keyword">case</span> byte_size(Bin) <span class="keyword">rem</span> <span class="number">4</span> <span class="keyword">of</span></span><br><span class="line">    <span class="comment">% 1 -&gt; &lt;&lt; Bin/binary, &quot;===&quot; &gt;&gt;;</span></span><br><span class="line">    <span class="number">2</span> -&gt; &lt;&lt; Bin/binary, <span class="string">&quot;==&quot;</span> &gt;&gt;;</span><br><span class="line">    <span class="number">3</span> -&gt; &lt;&lt; Bin/binary, <span class="string">&quot;=&quot;</span> &gt;&gt;;</span><br><span class="line">    _ -&gt; Bin</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">  base64:decode(&lt;&lt; &lt;&lt; (urldecode_digit(D)) &gt;&gt; || &lt;&lt;D&gt;&gt; &lt;= Bin2 &gt;&gt;);</span><br><span class="line"><span class="function"><span class="title">decode</span><span class="params">(L)</span> <span class="title">when</span> <span class="title">is_list</span><span class="params">(L)</span> -&gt;</span></span><br><span class="line">  decode(iolist_to_binary(L)).</span><br></pre></td></tr></table></figure>

<p><strong>逐步解析</strong>：</p>
<h4 id="步骤1-恢复填充字符"><a href="#步骤1-恢复填充字符" class="headerlink" title="步骤1: 恢复填充字符"></a>步骤1: 恢复填充字符</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Bin2 = <span class="keyword">case</span> byte_size(Bin) <span class="keyword">rem</span> <span class="number">4</span> <span class="keyword">of</span></span><br><span class="line">    <span class="number">2</span> -&gt; &lt;&lt; Bin/binary, <span class="string">&quot;==&quot;</span> &gt;&gt;;  <span class="comment">%% 长度余2，补2个=</span></span><br><span class="line">    <span class="number">3</span> -&gt; &lt;&lt; Bin/binary, <span class="string">&quot;=&quot;</span> &gt;&gt;;   <span class="comment">%% 长度余3，补1个=</span></span><br><span class="line">    _ -&gt; Bin                       <span class="comment">%% 余0或已有填充</span></span><br><span class="line"><span class="keyword">end</span>,</span><br></pre></td></tr></table></figure>

<p><strong>Base64 填充规则</strong>：</p>
<ul>
<li>Base64 输出长度必须是 4 的倍数</li>
<li>余数为 1 是无效输入（被注释掉）</li>
<li>余数为 2 需要补 <code>==</code></li>
<li>余数为 3 需要补 <code>=</code></li>
</ul>
<h4 id="步骤2-字符反向替换-解码"><a href="#步骤2-字符反向替换-解码" class="headerlink" title="步骤2: 字符反向替换 + 解码"></a>步骤2: 字符反向替换 + 解码</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base64:decode(&lt;&lt; &lt;&lt; (urldecode_digit(D)) &gt;&gt; || &lt;&lt;D&gt;&gt; &lt;= Bin2 &gt;&gt;)</span><br></pre></td></tr></table></figure>
<ul>
<li>将 URL 安全字符转回标准 Base64 字符</li>
<li>调用标准库 <code>base64:decode/1</code> 解码</li>
</ul>
<hr>
<h3 id="2-5-字符转换函数"><a href="#2-5-字符转换函数" class="headerlink" title="2.5 字符转换函数"></a>2.5 字符转换函数</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">urlencode_digit</span><span class="params">(<span class="string">$/</span>)</span> -&gt;</span> <span class="string">$_</span>;</span><br><span class="line"><span class="function"><span class="title">urlencode_digit</span><span class="params">(<span class="string">$+</span>)</span> -&gt;</span> <span class="string">$-</span>;</span><br><span class="line"><span class="function"><span class="title">urlencode_digit</span><span class="params">(D)</span>  -&gt;</span> D.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">urldecode_digit</span><span class="params">(<span class="string">$_</span>)</span> -&gt;</span> <span class="string">$/</span>;</span><br><span class="line"><span class="function"><span class="title">urldecode_digit</span><span class="params">(<span class="string">$-</span>)</span> -&gt;</span> <span class="string">$+</span>;</span><br><span class="line"><span class="function"><span class="title">urldecode_digit</span><span class="params">(D)</span>  -&gt;</span> D.</span><br></pre></td></tr></table></figure>

<p><strong>字符映射表</strong>：</p>
<table>
<thead>
<tr>
<th>方向</th>
<th><code>/</code></th>
<th><code>+</code></th>
<th>其他</th>
</tr>
</thead>
<tbody><tr>
<td>编码</td>
<td><code>_</code></td>
<td><code>-</code></td>
<td>不变</td>
</tr>
<tr>
<td>解码</td>
<td><code>/</code></td>
<td><code>+</code></td>
<td>不变</td>
</tr>
</tbody></table>
<p><strong>Erlang 字符语法</strong>：</p>
<ul>
<li><code>$_</code> 表示字符 <code>_</code> 的 ASCII 值 (95)</li>
<li><code>$/</code> 表示字符 <code>/</code> 的 ASCII 值 (47)</li>
<li><code>$+</code> 表示字符 <code>+</code> 的 ASCII 值 (43)</li>
<li><code>$-</code> 表示字符 <code>-</code> 的 ASCII 值 (45)</li>
</ul>
<hr>
<h3 id="2-6-单元测试"><a href="#2-6-单元测试" class="headerlink" title="2.6 单元测试"></a>2.6 单元测试</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-ifdef</span><span class="params">(TEST)</span>.</span><br><span class="line"><span class="keyword">-include_lib</span><span class="params">(<span class="string">&quot;eunit/include/eunit.hrl&quot;</span>)</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">aim_test</span><span class="params">()</span> -&gt;</span></span><br><span class="line">  <span class="comment">%% 验证标准 base64 产生 URL 不安全字符</span></span><br><span class="line">  ?assertNotEqual(</span><br><span class="line">      binary:match(base64:encode([<span class="number">255</span>,<span class="number">127</span>,<span class="number">254</span>,<span class="number">252</span>]), [&lt;&lt;<span class="string">&quot;=&quot;</span>&gt;&gt;, &lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;, &lt;&lt;<span class="string">&quot;+&quot;</span>&gt;&gt;]),</span><br><span class="line">      nomatch),</span><br><span class="line">  <span class="comment">%% 验证 encode/1 产生 URL 安全输出</span></span><br><span class="line">  ?assertEqual(</span><br><span class="line">      binary:match(encode([<span class="number">255</span>,<span class="number">127</span>,<span class="number">254</span>,<span class="number">252</span>]), [&lt;&lt;<span class="string">&quot;=&quot;</span>&gt;&gt;, &lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;, &lt;&lt;<span class="string">&quot;+&quot;</span>&gt;&gt;]),</span><br><span class="line">      nomatch),</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p><strong>测试覆盖</strong>：</p>
<ol>
<li><code>aim_test/0</code> - 验证 URL 安全性</li>
<li><code>codec_test/0</code> - 验证编解码无损</li>
<li><code>iolist_test/0</code> - 验证 iolist 支持</li>
</ol>
<hr>
<h2 id="3-核心技术点"><a href="#3-核心技术点" class="headerlink" title="3. 核心技术点"></a>3. 核心技术点</h2><h3 id="3-1-二进制推导式语法"><a href="#3-1-二进制推导式语法" class="headerlink" title="3.1 二进制推导式语法"></a>3.1 二进制推导式语法</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt; &lt;&lt;Expr&gt;&gt; || &lt;&lt;Pattern&gt;&gt; &lt;= Generator, Filter &gt;&gt;</span><br></pre></td></tr></table></figure>

<p>等价的列表推导式：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Expr || Pattern &lt;- Generator, Filter]</span><br></pre></td></tr></table></figure>

<p><strong>关键区别</strong>：</p>
<ul>
<li><code>&lt;=</code> 用于二进制生成器（vs <code>&lt;-</code> 用于列表）</li>
<li>输出需要双层 <code>&lt;&lt; &lt;&lt;...&gt;&gt; &gt;&gt;</code></li>
</ul>
<h3 id="3-2-Guard-子句"><a href="#3-2-Guard-子句" class="headerlink" title="3.2 Guard 子句"></a>3.2 Guard 子句</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">encode</span><span class="params">(Bin)</span> <span class="title">when</span> <span class="title">is_binary</span><span class="params">(Bin)</span> -&gt;</span> ...;</span><br><span class="line"><span class="function"><span class="title">encode</span><span class="params">(L)</span> <span class="title">when</span> <span class="title">is_list</span><span class="params">(L)</span> -&gt;</span> ...</span><br></pre></td></tr></table></figure>

<ul>
<li><code>when is_binary(Bin)</code> - 模式匹配后的额外条件</li>
<li>实现函数重载&#x2F;多态</li>
</ul>
<h3 id="3-3-iolist-类型"><a href="#3-3-iolist-类型" class="headerlink" title="3.3 iolist 类型"></a>3.3 iolist 类型</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-type iolist<span class="params">()</span> :: maybe_improper_list<span class="params">(</span></span><br><span class="line"><span class="params">    byte() | binary() | iolist(),</span></span><br><span class="line"><span class="params">    binary() | []</span></span><br><span class="line"><span class="params">)</span>.</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&quot;Hello&quot;</span>, &lt;&lt;<span class="string">&quot; &quot;</span>&gt;&gt;, [<span class="string">&quot;World&quot;</span>, &lt;&lt;<span class="string">&quot;!&quot;</span>&gt;&gt;]]  <span class="comment">%% 有效 iolist</span></span><br><span class="line"><span class="function"><span class="title">iolist_to_binary</span><span class="params">([<span class="string">&quot;Hello&quot;</span>, &lt;&lt;<span class="string">&quot; &quot;</span>&gt;&gt;, <span class="string">&quot;World&quot;</span>])</span>.</span></span><br><span class="line"><span class="function">%% 结果: &lt;&lt;&quot;H<span class="title">ello</span> W<span class="title">orld</span>&quot;&gt;&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-使用场景"><a href="#4-使用场景" class="headerlink" title="4. 使用场景"></a>4. 使用场景</h2><h3 id="4-1-JWT-Token-编码"><a href="#4-1-JWT-Token-编码" class="headerlink" title="4.1 JWT Token 编码"></a>4.1 JWT Token 编码</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% JWT 的三个部分都使用 base64url 编码</span></span><br><span class="line">Header = base64url:encode(jsx:encode(#&#123;alg =&gt; &lt;&lt;<span class="string">&quot;HS256&quot;</span>&gt;&gt;, typ =&gt; &lt;&lt;<span class="string">&quot;JWT&quot;</span>&gt;&gt;&#125;)),</span><br><span class="line">Payload = base64url:encode(jsx:encode(#&#123;sub =&gt; &lt;&lt;<span class="string">&quot;1234567890&quot;</span>&gt;&gt;&#125;)),</span><br><span class="line">Signature = base64url:encode(crypto:mac(hmac, sha256, Secret, Data)).</span><br></pre></td></tr></table></figure>

<h3 id="4-2-URL-参数传递"><a href="#4-2-URL-参数传递" class="headerlink" title="4.2 URL 参数传递"></a>4.2 URL 参数传递</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 安全地在 URL 中传递二进制数据</span></span><br><span class="line">BinaryData = &lt;&lt;<span class="number">255</span>, <span class="number">0</span>, <span class="number">128</span>, <span class="number">64</span>&gt;&gt;,</span><br><span class="line">SafeParam = base64url:encode(BinaryData),</span><br><span class="line">URL = &lt;&lt;<span class="string">&quot;https://example.com/api?data=&quot;</span>, SafeParam/binary&gt;&gt;.</span><br></pre></td></tr></table></figure>

<h3 id="4-3-文件名安全编码"><a href="#4-3-文件名安全编码" class="headerlink" title="4.3 文件名安全编码"></a>4.3 文件名安全编码</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 将任意数据编码为安全的文件名</span></span><br><span class="line">FileName = base64url:encode(term_to_binary(&#123;user, <span class="number">123</span>, <span class="string">&quot;data&quot;</span>&#125;)).</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-实战示例"><a href="#5-实战示例" class="headerlink" title="5. 实战示例"></a>5. 实战示例</h2><h3 id="5-1-基本编解码"><a href="#5-1-基本编解码" class="headerlink" title="5.1 基本编解码"></a>5.1 基本编解码</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 简单字符串编码</span></span><br><span class="line">Original = &lt;&lt;<span class="string">&quot;Hello, World!&quot;</span>&gt;&gt;,</span><br><span class="line">Encoded = base64url:encode(Original),</span><br><span class="line">Decoded = base64url:decode(Encoded),</span><br><span class="line"><span class="comment">%% Original =:= Decoded -&gt; true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">%% 二进制数据编码</span></span><br><span class="line">BinData = &lt;&lt;<span class="number">255</span>, <span class="number">0</span>, <span class="number">128</span>, <span class="number">64</span>, <span class="number">32</span>, <span class="number">16</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>&gt;&gt;,</span><br><span class="line">base64url:encode(BinData).</span><br><span class="line"><span class="comment">%% 结果: &lt;&lt;&quot;_wCAQCAQBAIB&quot;&gt;&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-URL-安全性验证"><a href="#5-2-URL-安全性验证" class="headerlink" title="5.2 URL 安全性验证"></a>5.2 URL 安全性验证</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 这组数据会产生 URL 危险字符</span></span><br><span class="line">TestData = &lt;&lt;<span class="number">255</span>, <span class="number">127</span>, <span class="number">254</span>, <span class="number">252</span>&gt;&gt;,</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 标准 Base64</span></span><br><span class="line">base64:encode(TestData).</span><br><span class="line"><span class="comment">%% 结果: &lt;&lt;&quot;/3/+/A==&quot;&gt;&gt;  (包含 / + =)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">%% URL 安全 Base64</span></span><br><span class="line">base64url:encode(TestData).</span><br><span class="line"><span class="comment">%% 结果: &lt;&lt;&quot;_3_-_A&quot;&gt;&gt;  (安全)</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-MIME-模式-vs-标准模式"><a href="#5-3-MIME-模式-vs-标准模式" class="headerlink" title="5.3 MIME 模式 vs 标准模式"></a>5.3 MIME 模式 vs 标准模式</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 测试不同长度的数据</span></span><br><span class="line">Data = &lt;&lt;<span class="string">&quot;a&quot;</span>&gt;&gt;,  <span class="comment">%% 1字节 -&gt; 需要2个填充</span></span><br><span class="line"></span><br><span class="line">base64url:encode(Data).</span><br><span class="line"><span class="comment">%% 结果: &lt;&lt;&quot;YQ&quot;&gt;&gt;  (无填充)</span></span><br><span class="line"></span><br><span class="line">base64url:encode_mime(Data).</span><br><span class="line"><span class="comment">%% 结果: &lt;&lt;&quot;YQ==&quot;&gt;&gt;  (有填充)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">%% 两者都能正确解码</span></span><br><span class="line">base64url:decode(&lt;&lt;<span class="string">&quot;YQ&quot;</span>&gt;&gt;) =:= base64url:decode(&lt;&lt;<span class="string">&quot;YQ==&quot;</span>&gt;&gt;).</span><br><span class="line"><span class="comment">%% 结果: true</span></span><br></pre></td></tr></table></figure>

<h3 id="5-4-JWT-like-场景"><a href="#5-4-JWT-like-场景" class="headerlink" title="5.4 JWT-like 场景"></a>5.4 JWT-like 场景</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 模拟 JWT 的三个部分</span></span><br><span class="line">HeaderJson = &lt;&lt;<span class="string">&quot;&#123;\&quot;alg\&quot;:\&quot;HS256\&quot;,\&quot;typ\&quot;:\&quot;JWT\&quot;&#125;&quot;</span>&gt;&gt;,</span><br><span class="line">HeaderEnc = base64url:encode(HeaderJson),</span><br><span class="line"><span class="comment">%% 结果: &lt;&lt;&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9&quot;&gt;&gt;</span></span><br><span class="line"></span><br><span class="line">PayloadJson = &lt;&lt;<span class="string">&quot;&#123;\&quot;sub\&quot;:\&quot;1234567890\&quot;,\&quot;name\&quot;:\&quot;John\&quot;&#125;&quot;</span>&gt;&gt;,</span><br><span class="line">PayloadEnc = base64url:encode(PayloadJson),</span><br><span class="line"></span><br><span class="line">SignatureBytes = crypto:strong_rand_bytes(<span class="number">32</span>),</span><br><span class="line">SignatureEnc = base64url:encode(SignatureBytes),</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 组合成 JWT 格式</span></span><br><span class="line">Token = &lt;&lt;HeaderEnc/binary, <span class="string">&quot;.&quot;</span>, PayloadEnc/binary, <span class="string">&quot;.&quot;</span>, SignatureEnc/binary&gt;&gt;.</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-性能特点"><a href="#6-性能特点" class="headerlink" title="6. 性能特点"></a>6. 性能特点</h2><table>
<thead>
<tr>
<th>特性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>零拷贝</strong></td>
<td>二进制推导直接生成结果，无中间列表</td>
</tr>
<tr>
<td><strong>流式处理</strong></td>
<td>逐字节处理，内存占用低</td>
</tr>
<tr>
<td><strong>依赖标准库</strong></td>
<td>核心编解码使用 OTP <code>base64</code> 模块</td>
</tr>
</tbody></table>
<hr>
<h2 id="7-与其他实现对比"><a href="#7-与其他实现对比" class="headerlink" title="7. 与其他实现对比"></a>7. 与其他实现对比</h2><table>
<thead>
<tr>
<th>实现</th>
<th>语言</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td><code>base64url</code></td>
<td>Erlang</td>
<td>纯函数式，依赖 OTP</td>
</tr>
<tr>
<td><code>base64.urlsafe_b64encode</code></td>
<td>Python</td>
<td>标准库内置</td>
</tr>
<tr>
<td><code>Base64.getUrlEncoder()</code></td>
<td>Java</td>
<td>JDK 8+ 内置</td>
</tr>
<tr>
<td><code>btoa</code> + 替换</td>
<td>JavaScript</td>
<td>需手动处理</td>
</tr>
</tbody></table>
<hr>
<h2 id="8-在-RabbitMQ-中的应用"><a href="#8-在-RabbitMQ-中的应用" class="headerlink" title="8. 在 RabbitMQ 中的应用"></a>8. 在 RabbitMQ 中的应用</h2><p><code>base64url</code> 模块在 RabbitMQ 中主要用于：</p>
<ol>
<li><strong>OAuth 2.0 &#x2F; JWT 认证</strong>：编解码 JWT Token</li>
<li><strong>管理 API</strong>：URL 参数中传递二进制数据</li>
<li><strong>消息属性编码</strong>：某些需要 URL 安全的场景</li>
</ol>
<hr>
<h2 id="9-参考资料"><a href="#9-参考资料" class="headerlink" title="9. 参考资料"></a>9. 参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc4648">RFC 4648 - Base Encodings</a></li>
<li><a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/base64.html">Erlang base64 模块</a></li>
<li><a target="_blank" rel="noopener" href="https://www.erlang.org/doc/reference_manual/expressions.html#binary-comprehensions">Binary Comprehensions</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dvv/base64url">base64url GitHub</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/16/erlang-erlang-trace-debugging-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/16/erlang-erlang-trace-debugging-guide/" class="post-title-link" itemprop="url">Erlang Trace 调试技术详解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-16 23:00:00" itemprop="dateCreated datePublished" datetime="2026-01-16T23:00:00+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-17 18:59:55" itemprop="dateModified" datetime="2026-01-17T18:59:55+08:00">2026-01-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/" itemprop="url" rel="index"><span itemprop="name">technology</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/Erlang/" itemprop="url" rel="index"><span itemprop="name">Erlang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Erlang-Trace-调试技术详解"><a href="#Erlang-Trace-调试技术详解" class="headerlink" title="Erlang Trace 调试技术详解"></a>Erlang Trace 调试技术详解</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>与 C&#x2F;C++ 的 GDB 单步调试和 Java IDE（Eclipse&#x2F;IntelliJ IDEA）的断点调试不同，Erlang 采用基于进程的 trace 机制进行调试。本文深入介绍 Erlang 的 trace 调试技术，这是 RabbitMQ 源码分析的重要工具。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><h3 id="推荐书籍"><a href="#推荐书籍" class="headerlink" title="推荐书籍"></a>推荐书籍</h3><ul>
<li><strong><a target="_blank" rel="noopener" href="https://www.erlang-in-anger.com/">Erlang in Anger</a></strong> - 生产环境 Erlang 调试实战指南</li>
<li><strong><a target="_blank" rel="noopener" href="https://www.amazon.com/Erlang-Programming-Concurrent-Approach-Development/dp/0596518188">Erlang Programming</a></strong> - Francesco Cesarini, Simon Thompson</li>
</ul>
<h3 id="技术文档"><a href="#技术文档" class="headerlink" title="技术文档"></a>技术文档</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.erlang-factory.com/upload/presentations/316/dbg[1].pdf">dbg.pdf</a> - Erlang Factory 演讲</li>
<li><a target="_blank" rel="noopener" href="https://www.academia.edu/113957930/Declarative_debugging_of_concurrent_Erlang_programs">Declarative debugging of concurrent Erlang programs</a></li>
<li><a target="_blank" rel="noopener" href="https://www.researchgate.net/publication/220178306_Trace_Analysis_of_Erlang_Programs">Trace Analysis of Erlang Programs</a></li>
<li><a target="_blank" rel="noopener" href="https://esl-conf-static.s3.eu-central-1.amazonaws.com/media/files/000/000/725/original/Peter_Gomori_-_Profiling_and_Tracing_for_all_with_Xprof.pdf">Profiling and Tracing for all with Xprof</a></li>
</ul>
<hr>
<h2 id="Erlang-调试工具总览"><a href="#Erlang-调试工具总览" class="headerlink" title="Erlang 调试工具总览"></a>Erlang 调试工具总览</h2><p>Erlang 提供了多层次的调试工具：</p>
<table>
<thead>
<tr>
<th>工具</th>
<th>层级</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td><code>erlang:trace/3</code></td>
<td>底层 BIF</td>
<td>最基础，所有工具的基础</td>
</tr>
<tr>
<td><code>erlang:trace_pattern/3</code></td>
<td>底层 BIF</td>
<td>函数调用追踪</td>
</tr>
<tr>
<td><code>dbg</code></td>
<td>标准库</td>
<td>基于 trace 的封装，更易用</td>
</tr>
<tr>
<td><code>redbug</code></td>
<td>第三方</td>
<td>生产环境安全的追踪工具</td>
</tr>
<tr>
<td><code>recon_trace</code></td>
<td>第三方</td>
<td>专注函数调用追踪</td>
</tr>
</tbody></table>
<hr>
<h2 id="Trace-基础概念"><a href="#Trace-基础概念" class="headerlink" title="Trace 基础概念"></a>Trace 基础概念</h2><h3 id="可追踪的事件类型"><a href="#可追踪的事件类型" class="headerlink" title="可追踪的事件类型"></a>可追踪的事件类型</h3><p>Trace 可以追踪三大类事件：</p>
<table>
<thead>
<tr>
<th>事件类型</th>
<th>工具</th>
<th>Trace Flag</th>
</tr>
</thead>
<tbody><tr>
<td>进程相关活动和消息传递</td>
<td>trace, dbg, redbug</td>
<td><code>all</code>, <code>send</code>, <code>&#39;receive&#39;</code>, <code>procs</code>, <code>running</code></td>
</tr>
<tr>
<td>垃圾回收和内存使用</td>
<td>trace, dbg, redbug</td>
<td><code>garbage_collection</code>, <code>timestamp</code></td>
</tr>
<tr>
<td>全局和本地函数调用</td>
<td>trace + trace_pattern, dbg, recon_trace</td>
<td><code>call</code>, <code>arity</code>, <code>return_to</code></td>
</tr>
</tbody></table>
<h3 id="Trace-消息格式"><a href="#Trace-消息格式" class="headerlink" title="Trace 消息格式"></a>Trace 消息格式</h3><p>跟踪事件以消息形式发送：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;trace, Pid, Tag, Data1 [,Data2]&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>[,Data2]</code> 是可选字段，依赖于跟踪消息类型。</p>
<hr>
<h2 id="erlang-trace-3-API-详解"><a href="#erlang-trace-3-API-详解" class="headerlink" title="erlang:trace&#x2F;3 API 详解"></a>erlang:trace&#x2F;3 API 详解</h2><h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">erlang:trace(PidSpec, Bool, TraceFlags) -&gt; integer()</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>PidSpec</strong>: 要追踪的进程（<code>all</code>, <code>new</code>, <code>existing</code>, <code>Pid</code>）</li>
<li><strong>Bool</strong>: <code>true</code> 启用追踪，<code>false</code> 禁用</li>
<li><strong>TraceFlags</strong>: 追踪标志列表</li>
<li><strong>返回值</strong>: 被追踪的进程数量</li>
</ul>
<h3 id="重要注意事项"><a href="#重要注意事项" class="headerlink" title="重要注意事项"></a>重要注意事项</h3><ol>
<li><p><strong>Tracer 进程不能被追踪</strong></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 错误：tracer 不能追踪自己</span></span><br><span class="line">erlang:trace(self(), <span class="literal">true</span>, [send]).  <span class="comment">%% badarg error</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>指定其他进程接收追踪消息</strong></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 将追踪消息发送到指定进程</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [send, &#123;tracer, TracerPid&#125;]).</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>终端需要 flush() 查看消息</strong></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪消息在 mailbox 中，需要 flush 显示</span></span><br><span class="line"><span class="number">1</span>&gt; erlang:trace(Pid, <span class="literal">true</span>, [send]).</span><br><span class="line"><span class="number">2</span>&gt; flush().</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="进程和消息追踪"><a href="#进程和消息追踪" class="headerlink" title="进程和消息追踪"></a>进程和消息追踪</h2><h3 id="send-和-‘receive’-追踪"><a href="#send-和-‘receive’-追踪" class="headerlink" title="send 和 ‘receive’ 追踪"></a>send 和 ‘receive’ 追踪</h3><h4 id="send-追踪"><a href="#send-追踪" class="headerlink" title="send 追踪"></a>send 追踪</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 启用发送追踪</span></span><br><span class="line">erlang:trace(Pid, <span class="literal">true</span>, [send]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 追踪消息格式</span></span><br><span class="line">&#123;trace, PidPort, send, Msg, To&#125;</span><br><span class="line">&#123;trace, PidPort, send_to_non_existing_process, Msg, To&#125;</span><br></pre></td></tr></table></figure>

<h4 id="‘receive’-追踪"><a href="#‘receive’-追踪" class="headerlink" title="‘receive’ 追踪"></a>‘receive’ 追踪</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 启用接收追踪（注意：&#x27;receive&#x27; 需要引号，因为是保留字）</span></span><br><span class="line">erlang:trace(Pid, <span class="literal">true</span>, [&#x27;<span class="keyword">receive</span>&#x27;]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 追踪消息格式</span></span><br><span class="line">&#123;trace, PidPort, &#x27;<span class="keyword">receive</span>&#x27;, Msg&#125;</span><br></pre></td></tr></table></figure>

<h3 id="进程生命周期追踪-procs"><a href="#进程生命周期追踪-procs" class="headerlink" title="进程生命周期追踪 (procs)"></a>进程生命周期追踪 (procs)</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪进程创建、退出等事件</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [procs]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 配合 set_on_spawn 追踪新创建的进程</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [set_on_spawn, procs]).</span><br></pre></td></tr></table></figure>

<h3 id="running-追踪"><a href="#running-追踪" class="headerlink" title="running 追踪"></a>running 追踪</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪进程调度（运行/挂起）</span></span><br><span class="line">erlang:trace(Pid, <span class="literal">true</span>, [running, procs]).</span><br></pre></td></tr></table></figure>

<h3 id="垃圾回收追踪"><a href="#垃圾回收追踪" class="headerlink" title="垃圾回收追踪"></a>垃圾回收追踪</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪 GC 事件，带时间戳</span></span><br><span class="line">erlang:trace(Pid, <span class="literal">true</span>, [garbage_collection, timestamp]).</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>: 占用内存太小可能触发不到垃圾回收。</p>
<hr>
<h2 id="函数调用追踪"><a href="#函数调用追踪" class="headerlink" title="函数调用追踪"></a>函数调用追踪</h2><p>函数追踪需要 <code>erlang:trace/3</code> 和 <code>erlang:trace_pattern/3</code> 配合使用。</p>
<h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3><table>
<thead>
<tr>
<th>函数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>erlang:trace/3</code></td>
<td>定义追踪哪些<strong>进程</strong></td>
</tr>
<tr>
<td><code>erlang:trace_pattern/3</code></td>
<td>定义追踪哪些<strong>函数</strong></td>
</tr>
</tbody></table>
<p>只有当<strong>被追踪的进程</strong>调用<strong>被追踪的函数</strong>时，才会产生追踪事件。</p>
<h3 id="trace-pattern-基本语法"><a href="#trace-pattern-基本语法" class="headerlink" title="trace_pattern 基本语法"></a>trace_pattern 基本语法</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">erlang:trace_pattern(MFA, MatchSpec, FlagList) -&gt; integer()</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>MFA</strong>: <code>{Module, Function, Arity}</code> 或 <code>{Module, &#39;_&#39;, &#39;_&#39;}</code></li>
<li><strong>MatchSpec</strong>: 匹配规则（<code>true</code>, <code>[]</code>, 或详细规则）</li>
<li><strong>FlagList</strong>: <code>[global]</code>, <code>[local]</code>, <code>[meta]</code> 等</li>
</ul>
<h3 id="基本示例"><a href="#基本示例" class="headerlink" title="基本示例"></a>基本示例</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 1. 启用进程的函数调用追踪</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [call]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 2. 指定追踪的函数（必须先 load module）</span></span><br><span class="line">erlang:trace_pattern(&#123;mymodule, myfunction, <span class="number">2</span>&#125;, <span class="literal">true</span>, [local]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 注意：模块必须先加载！</span></span><br><span class="line"><span class="function"><span class="title">l</span><span class="params">(mymodule)</span>.  %% 或 <span class="title">code</span>:<span class="title">ensure_loaded</span><span class="params">(mymodule)</span></span></span><br></pre></td></tr></table></figure>

<h3 id="global-vs-local"><a href="#global-vs-local" class="headerlink" title="global vs local"></a>global vs local</h3><table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>global</code></td>
<td>默认值，只追踪外部调用（跨模块调用）</td>
</tr>
<tr>
<td><code>local</code></td>
<td>追踪所有调用，包括模块内部调用</td>
</tr>
</tbody></table>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪所有调用（包括内部调用）</span></span><br><span class="line">erlang:trace_pattern(&#123;mymodule, &#x27;_&#x27;, &#x27;_&#x27;&#125;, <span class="literal">true</span>, [local]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 只追踪外部调用</span></span><br><span class="line">erlang:trace_pattern(&#123;mymodule, &#x27;_&#x27;, &#x27;_&#x27;&#125;, <span class="literal">true</span>, [global]).</span><br></pre></td></tr></table></figure>

<h3 id="return-to-追踪"><a href="#return-to-追踪" class="headerlink" title="return_to 追踪"></a>return_to 追踪</h3><p>追踪函数返回到哪里（只对 <code>local</code> 有效）：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 启用 return_to</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [call, return_to]).</span><br><span class="line">erlang:trace_pattern(&#123;mymodule, &#x27;_&#x27;, &#x27;_&#x27;&#125;, <span class="literal">true</span>, [local]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 追踪消息格式</span></span><br><span class="line">&#123;trace, Pid, return_to, &#123;M, F, A&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>: <code>return_to</code> 无法获取函数返回值！</p>
<h3 id="return-trace-获取返回值"><a href="#return-trace-获取返回值" class="headerlink" title="return_trace 获取返回值"></a>return_trace 获取返回值</h3><p>要获取函数返回值，使用 MatchSpec 中的 <code>{return_trace}</code>：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 使用 return_trace 获取返回值</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [call]).</span><br><span class="line">erlang:trace_pattern(&#123;mymodule, myfunction, <span class="number">1</span>&#125;, [&#123;&#x27;_&#x27;, [], [&#123;return_trace&#125;]&#125;], [local]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 追踪消息格式</span></span><br><span class="line">&#123;trace, Pid, call, &#123;M, F, Args&#125;&#125;</span><br><span class="line">&#123;trace, Pid, return_from, &#123;M, F, Arity&#125;, ReturnValue&#125;</span><br></pre></td></tr></table></figure>

<h3 id="arity-选项"><a href="#arity-选项" class="headerlink" title="arity 选项"></a>arity 选项</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 使用 arity：只显示参数个数，不显示参数内容</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [call, arity]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 不使用 arity：显示完整参数</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [call]).</span><br></pre></td></tr></table></figure>

<p>使用 <code>arity</code> 可以减少追踪消息大小。</p>
<hr>
<h2 id="Match-Specifications"><a href="#Match-Specifications" class="headerlink" title="Match Specifications"></a>Match Specifications</h2><p>Match Specifications 是强大的过滤和操作机制。</p>
<h3 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MatchSpec = [&#123;MatchHead, MatchConditions, MatchBody&#125;]</span><br></pre></td></tr></table></figure>

<h3 id="使用-dbg-fun2ms-1-生成"><a href="#使用-dbg-fun2ms-1-生成" class="headerlink" title="使用 dbg:fun2ms&#x2F;1 生成"></a>使用 dbg:fun2ms&#x2F;1 生成</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 使用 fun2ms 生成 MatchSpec</span></span><br><span class="line"><span class="number">1</span>&gt; dbg:fun2ms(<span class="keyword">fun</span>([A, B]) <span class="keyword">when</span> A &gt; <span class="number">10</span> -&gt; return_trace() <span class="keyword">end</span>).</span><br><span class="line">[&#123;[&#x27;<span class="string">$1</span>&#x27;,&#x27;<span class="string">$2</span>&#x27;],[&#123;&#x27;&gt;&#x27;,&#x27;<span class="string">$1</span>&#x27;,<span class="number">10</span>&#125;],[&#123;return_trace&#125;]&#125;]</span><br></pre></td></tr></table></figure>

<h3 id="常用-MatchSpec-示例"><a href="#常用-MatchSpec-示例" class="headerlink" title="常用 MatchSpec 示例"></a>常用 MatchSpec 示例</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪所有调用并返回值</span></span><br><span class="line">erlang:trace_pattern(&#123;M, F, A&#125;, [&#123;&#x27;_&#x27;, [], [&#123;return_trace&#125;]&#125;], [local]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 追踪特定参数值</span></span><br><span class="line">erlang:trace_pattern(&#123;M, F, <span class="number">1</span>&#125;, [&#123;[&#x27;<span class="string">$1</span>&#x27;], [&#123;&#x27;==&#x27;, &#x27;<span class="string">$1</span>&#x27;, foo&#125;], []&#125;], [local]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 追踪并打印消息</span></span><br><span class="line">erlang:trace_pattern(&#123;M, F, A&#125;, [&#123;&#x27;_&#x27;, [], [&#123;message, &#123;process_dump&#125;&#125;]&#125;], [local]).</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="dbg-模块"><a href="#dbg-模块" class="headerlink" title="dbg 模块"></a>dbg 模块</h2><p><code>dbg</code> 是基于 <code>erlang:trace/3</code> 的高级封装，使用更简便。</p>
<h3 id="基本使用流程"><a href="#基本使用流程" class="headerlink" title="基本使用流程"></a>基本使用流程</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 1. 启动 tracer</span></span><br><span class="line">dbg:tracer().</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 2. 设置追踪的进程</span></span><br><span class="line">dbg:p(all, c).  <span class="comment">%% all 进程，c = call</span></span><br><span class="line"></span><br><span class="line"><span class="comment">%% 3. 设置追踪的函数</span></span><br><span class="line">dbg:tpl(mymodule, myfunction, x).  <span class="comment">%% x = 所有 arity</span></span><br><span class="line"></span><br><span class="line"><span class="comment">%% 4. 停止追踪</span></span><br><span class="line">dbg:stop_clear().</span><br></pre></td></tr></table></figure>

<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>dbg:tracer()</code></td>
<td>启动默认 tracer</td>
</tr>
<tr>
<td><code>dbg:p(PidSpec, Flags)</code></td>
<td>设置进程追踪</td>
</tr>
<tr>
<td><code>dbg:tp(M, F, A, MS)</code></td>
<td>追踪全局函数调用</td>
</tr>
<tr>
<td><code>dbg:tpl(M, F, A, MS)</code></td>
<td>追踪本地+全局函数调用</td>
</tr>
<tr>
<td><code>dbg:ctp(M, F, A)</code></td>
<td>清除追踪模式</td>
</tr>
<tr>
<td><code>dbg:stop()</code></td>
<td>停止 tracer</td>
</tr>
<tr>
<td><code>dbg:stop_clear()</code></td>
<td>停止并清除所有追踪</td>
</tr>
</tbody></table>
<h3 id="dbg-p-2-的-Flags"><a href="#dbg-p-2-的-Flags" class="headerlink" title="dbg:p&#x2F;2 的 Flags"></a>dbg:p&#x2F;2 的 Flags</h3><table>
<thead>
<tr>
<th>Flag</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>c</code></td>
<td>call - 函数调用</td>
</tr>
<tr>
<td><code>s</code></td>
<td>send - 发送消息</td>
</tr>
<tr>
<td><code>r</code></td>
<td>receive - 接收消息</td>
</tr>
<tr>
<td><code>m</code></td>
<td>messages - send + receive</td>
</tr>
<tr>
<td><code>p</code></td>
<td>procs - 进程事件</td>
</tr>
<tr>
<td><code>sos</code></td>
<td>set_on_spawn</td>
</tr>
<tr>
<td><code>sol</code></td>
<td>set_on_link</td>
</tr>
</tbody></table>
<h3 id="实际示例"><a href="#实际示例" class="headerlink" title="实际示例"></a>实际示例</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪 lists:seq/2 的调用</span></span><br><span class="line"><span class="number">1</span>&gt; dbg:tracer().</span><br><span class="line">&#123;ok,&lt;<span class="number">0.90</span>.<span class="number">0</span>&gt;&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>&gt; dbg:p(all, c).</span><br><span class="line">&#123;ok,[&#123;matched,nonode@nohost,<span class="number">26</span>&#125;]&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>&gt; dbg:tpl(lists, seq, x).</span><br><span class="line">&#123;ok,[&#123;matched,nonode@nohost,<span class="number">2</span>&#125;]&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>&gt; lists:seq(<span class="number">1</span>, <span class="number">5</span>).</span><br><span class="line">(&lt;<span class="number">0.84</span>.<span class="number">0</span>&gt;) call lists:seq(<span class="number">1</span>,<span class="number">5</span>)</span><br><span class="line">[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>&gt; dbg:stop_clear().</span><br><span class="line">ok</span><br></pre></td></tr></table></figure>

<h3 id="带返回值的追踪"><a href="#带返回值的追踪" class="headerlink" title="带返回值的追踪"></a>带返回值的追踪</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 使用 dbg:fun2ms 生成带 return_trace 的 MatchSpec</span></span><br><span class="line"><span class="number">1</span>&gt; dbg:tracer().</span><br><span class="line"><span class="number">2</span>&gt; dbg:p(all, c).</span><br><span class="line"><span class="number">3</span>&gt; dbg:tpl(lists, seq, dbg:fun2ms(<span class="keyword">fun</span>(_) -&gt; return_trace() <span class="keyword">end</span>)).</span><br><span class="line"><span class="number">4</span>&gt; lists:seq(<span class="number">1</span>, <span class="number">3</span>).</span><br><span class="line">(&lt;<span class="number">0.84</span>.<span class="number">0</span>&gt;) call lists:seq(<span class="number">1</span>,<span class="number">3</span>)</span><br><span class="line">(&lt;<span class="number">0.84</span>.<span class="number">0</span>&gt;) returned from lists:seq/<span class="number">2</span> -&gt; [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="recon-trace"><a href="#recon-trace" class="headerlink" title="recon_trace"></a>recon_trace</h2><p><code>recon_trace</code> 是生产环境安全的追踪工具，来自 <code>recon</code> 库。</p>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul>
<li>自动限制追踪消息数量，防止系统过载</li>
<li>只能追踪函数调用，不能追踪消息</li>
<li>生产环境推荐使用</li>
</ul>
<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪 10 次调用</span></span><br><span class="line">recon_trace:calls(&#123;lists, seq, <span class="number">2</span>&#125;, <span class="number">10</span>).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 带返回值</span></span><br><span class="line">recon_trace:calls(&#123;lists, seq, <span class="number">2</span>&#125;, <span class="number">10</span>, [&#123;scope, local&#125;]).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 追踪特定进程</span></span><br><span class="line">recon_trace:calls(&#123;M, F, A&#125;, <span class="number">10</span>, [&#123;pid, Pid&#125;]).</span><br></pre></td></tr></table></figure>

<h3 id="重要提示"><a href="#重要提示" class="headerlink" title="重要提示"></a>重要提示</h3><p>使用 <code>recon_trace</code> 前，需要预加载所有要追踪的模块：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 加载所有 beam 文件对应的模块</span></span><br><span class="line">LP = <span class="keyword">fun</span>() -&gt; </span><br><span class="line">    [code:ensure_loaded(list_to_atom(filename:rootname(filename:basename(F)))) </span><br><span class="line">     || P &lt;- code:get_path(), F &lt;- filelib:wildcard(P ++ <span class="string">&quot;/*.beam&quot;</span>)] </span><br><span class="line"><span class="keyword">end</span>.</span><br><span class="line">LP().</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="实战技巧"><a href="#实战技巧" class="headerlink" title="实战技巧"></a>实战技巧</h2><h3 id="1-追踪-RabbitMQ-函数调用"><a href="#1-追踪-RabbitMQ-函数调用" class="headerlink" title="1. 追踪 RabbitMQ 函数调用"></a>1. 追踪 RabbitMQ 函数调用</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪 rabbit_channel 模块</span></span><br><span class="line"><span class="number">1</span>&gt; dbg:tracer().</span><br><span class="line"><span class="number">2</span>&gt; dbg:p(all, c).</span><br><span class="line"><span class="number">3</span>&gt; dbg:tpl(rabbit_channel, handle_cast, x).</span><br><span class="line"><span class="number">4</span>&gt; <span class="comment">%% 执行相关操作...</span></span><br><span class="line"><span class="number">5</span>&gt; dbg:stop_clear().</span><br></pre></td></tr></table></figure>

<h3 id="2-追踪消息传递"><a href="#2-追踪消息传递" class="headerlink" title="2. 追踪消息传递"></a>2. 追踪消息传递</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 追踪特定进程的消息</span></span><br><span class="line"><span class="number">1</span>&gt; Pid = whereis(rabbit_reader).</span><br><span class="line"><span class="number">2</span>&gt; erlang:trace(Pid, <span class="literal">true</span>, [send, &#x27;<span class="keyword">receive</span>&#x27;]).</span><br><span class="line"><span class="number">3</span>&gt; flush().  <span class="comment">%% 查看追踪消息</span></span><br><span class="line"><span class="number">4</span>&gt; erlang:trace(Pid, <span class="literal">false</span>, [send, &#x27;<span class="keyword">receive</span>&#x27;]).  <span class="comment">%% 停止追踪</span></span><br></pre></td></tr></table></figure>

<h3 id="3-生产环境安全追踪"><a href="#3-生产环境安全追踪" class="headerlink" title="3. 生产环境安全追踪"></a>3. 生产环境安全追踪</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 使用 recon_trace，限制 100 次调用</span></span><br><span class="line">recon_trace:calls(&#123;rabbit_channel, handle_cast, &#x27;_&#x27;&#125;, <span class="number">100</span>).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 10 秒后自动停止</span></span><br><span class="line">recon_trace:calls(&#123;rabbit_channel, handle_cast, &#x27;_&#x27;&#125;, &#123;<span class="number">100</span>, <span class="number">10000</span>&#125;).</span><br></pre></td></tr></table></figure>

<h3 id="4-追踪特定参数的调用"><a href="#4-追踪特定参数的调用" class="headerlink" title="4. 追踪特定参数的调用"></a>4. 追踪特定参数的调用</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 只追踪第一个参数为 foo 的调用</span></span><br><span class="line">MS = dbg:fun2ms(<span class="keyword">fun</span>([foo, _]) -&gt; return_trace() <span class="keyword">end</span>).</span><br><span class="line">dbg:tpl(mymodule, myfunction, MS).</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="Q-为什么-trace-pattern-不生效？"><a href="#Q-为什么-trace-pattern-不生效？" class="headerlink" title="Q: 为什么 trace_pattern 不生效？"></a>Q: 为什么 trace_pattern 不生效？</h3><ol>
<li>模块未加载：先执行 <code>l(module)</code> 或 <code>code:ensure_loaded(module)</code></li>
<li>只使用了 trace 或 trace_pattern 其中一个：两者必须配合使用</li>
<li>使用了 <code>global</code> 但调用是模块内部调用：改用 <code>local</code></li>
</ol>
<h3 id="Q-如何获取函数返回值？"><a href="#Q-如何获取函数返回值？" class="headerlink" title="Q: 如何获取函数返回值？"></a>Q: 如何获取函数返回值？</h3><p>使用 <code>return_trace</code> MatchSpec，而不是 <code>return_to</code> flag：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">erlang:trace_pattern(&#123;M, F, A&#125;, [&#123;&#x27;_&#x27;, [], [&#123;return_trace&#125;]&#125;], [local]).</span><br></pre></td></tr></table></figure>

<h3 id="Q-为什么看不到追踪消息？"><a href="#Q-为什么看不到追踪消息？" class="headerlink" title="Q: 为什么看不到追踪消息？"></a>Q: 为什么看不到追踪消息？</h3><ol>
<li>终端作为 tracer 时需要 <code>flush()</code></li>
<li>tracer 进程不能追踪自己</li>
<li>检查 trace 和 trace_pattern 是否都设置了</li>
</ol>
<h3 id="Q-如何追踪新创建的进程？"><a href="#Q-如何追踪新创建的进程？" class="headerlink" title="Q: 如何追踪新创建的进程？"></a>Q: 如何追踪新创建的进程？</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 使用 set_on_spawn</span></span><br><span class="line">erlang:trace(all, <span class="literal">true</span>, [set_on_spawn, procs, call]).</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><table>
<thead>
<tr>
<th>场景</th>
<th>推荐工具</th>
</tr>
</thead>
<tbody><tr>
<td>开发环境快速调试</td>
<td><code>dbg</code></td>
</tr>
<tr>
<td>生产环境安全追踪</td>
<td><code>recon_trace</code></td>
</tr>
<tr>
<td>精细控制</td>
<td><code>erlang:trace/3</code> + <code>erlang:trace_pattern/3</code></td>
</tr>
<tr>
<td>消息追踪</td>
<td><code>erlang:trace/3</code> 的 <code>send</code>&#x2F;<code>&#39;receive&#39;</code></td>
</tr>
<tr>
<td>进程追踪</td>
<td><code>erlang:trace/3</code> 的 <code>procs</code></td>
</tr>
</tbody></table>
<p>掌握 Erlang trace 技术是深入理解 RabbitMQ 等 Erlang 系统的关键。通过合理使用这些工具，可以有效地进行问题排查和性能分析。</p>
<hr>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/erlang.html#trace-3">Erlang trace&#x2F;3 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/erlang.html#trace_pattern-3">Erlang trace_pattern&#x2F;3 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://www.erlang.org/doc/man/dbg.html">Erlang dbg 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="http://erlang.org/documentation/doc-7.0/erts-7.0/doc/html/match_spec.html">Match Specifications in Erlang</a></li>
<li><a target="_blank" rel="noopener" href="http://stratus3d.com/blog/2021/08/24/guide-to-tracing-in-erlang/">Guide to Tracing in Erlang</a></li>
<li><a target="_blank" rel="noopener" href="https://ferd.github.io/recon/">recon 库文档</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/16/rabbitmq-rabbitmq-complete-build-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/16/rabbitmq-rabbitmq-complete-build-guide/" class="post-title-link" itemprop="url">RabbitMQ 编译构建完全指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-16 22:30:00 / 修改时间：22:41:31" itemprop="dateCreated datePublished" datetime="2026-01-16T22:30:00+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RabbitMQ-编译构建完全指南"><a href="#RabbitMQ-编译构建完全指南" class="headerlink" title="RabbitMQ 编译构建完全指南"></a>RabbitMQ 编译构建完全指南</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>基于 RabbitMQ 4.0.5 源码深度分析和实际构建验证，本文档全面解析各种编译方式的技术原理、实现机制和最佳实践。</p>
<h2 id="快速对比表"><a href="#快速对比表" class="headerlink" title="快速对比表"></a>快速对比表</h2><h3 id="构建命令"><a href="#构建命令" class="headerlink" title="构建命令"></a>构建命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
<th>输出格式</th>
<th>部署方式</th>
<th>编译时间</th>
<th>磁盘占用</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>make</code></td>
<td>编译</td>
<td>源码目录 + beam 文件</td>
<td>开发调试</td>
<td>最快</td>
<td>中等</td>
<td>本地开发、调试</td>
</tr>
<tr>
<td><code>make dist</code></td>
<td>打包文件</td>
<td>插件目录结构</td>
<td>目录部署</td>
<td>快</td>
<td>大</td>
<td>生产环境、插件开发</td>
</tr>
<tr>
<td><code>make dist DIST_AS_EZS=true</code></td>
<td>打包成 ez 文件</td>
<td>.ez 压缩包</td>
<td>插件安装</td>
<td>中等</td>
<td>小</td>
<td>插件分发、热加载</td>
</tr>
<tr>
<td><code>make source-dist</code></td>
<td>创建源码包</td>
<td>tar.xz 源码归档</td>
<td>源码分发</td>
<td>快</td>
<td>小</td>
<td>离线构建、版本发布</td>
</tr>
<tr>
<td><code>make package-generic-unix</code></td>
<td>打包成 PACKAGE 文件</td>
<td>tar.xz 包</td>
<td>解压安装</td>
<td>慢</td>
<td>最小</td>
<td>容器、跨平台</td>
</tr>
<tr>
<td><code>make install</code></td>
<td>安装到系统</td>
<td>系统目录</td>
<td>系统安装</td>
<td>中等</td>
<td>中等</td>
<td>生产部署</td>
</tr>
<tr>
<td><code>make install PREFIX=/opt/rabbitmq</code></td>
<td>安装到指定目录</td>
<td>自定义目录</td>
<td>自定义安装</td>
<td>中等</td>
<td>中等</td>
<td>自定义部署路径</td>
</tr>
</tbody></table>
<h3 id="开发调试命令"><a href="#开发调试命令" class="headerlink" title="开发调试命令"></a>开发调试命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>make run-broker</code></td>
<td>启动 RabbitMQ 服务器（前台运行）</td>
<td>开发调试、日志查看</td>
</tr>
<tr>
<td><code>make run-broker PLUGINS=&quot;plugin_name&quot;</code></td>
<td>启动并加载指定插件</td>
<td>插件测试、功能验证</td>
</tr>
<tr>
<td><code>make shell</code></td>
<td>进入 Erlang Shell</td>
<td>代码调试、模块测试</td>
</tr>
<tr>
<td><code>make run-background-broker</code></td>
<td>后台启动 RabbitMQ</td>
<td>自动化测试</td>
</tr>
<tr>
<td><code>make run-node</code></td>
<td>启动裸 Erlang 节点（无 RabbitMQ）</td>
<td>Erlang 调试</td>
</tr>
</tbody></table>
<hr>
<h2 id="1-make-基础编译"><a href="#1-make-基础编译" class="headerlink" title="1. make - 基础编译"></a>1. <code>make</code> - 基础编译</h2><h3 id="技术原理"><a href="#技术原理" class="headerlink" title="技术原理"></a>技术原理</h3><p>基于 <strong>erlang.mk</strong> 构建系统，执行 Erlang&#x2F;OTP 标准编译流程。</p>
<h4 id="核心实现机制"><a href="#核心实现机制" class="headerlink" title="核心实现机制"></a>核心实现机制</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile (第 77 行)</span></span><br><span class="line"><span class="keyword">include</span> erlang.mk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 来源：erlang.mk 核心逻辑</span></span><br><span class="line"><span class="section">app:: deps <span class="variable">$(PROJECT)</span>.d</span></span><br><span class="line">  <span class="variable">$(verbose)</span> <span class="variable">$(MAKE)</span> --no-print-directory app-build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认目标继承自 erlang.mk</span></span><br><span class="line"><span class="comment"># 编译流程：</span></span><br><span class="line"><span class="comment"># 1. 编译依赖 (deps)</span></span><br><span class="line"><span class="comment"># 2. 编译核心应用 (app)  </span></span><br><span class="line"><span class="comment"># 3. 生成启动脚本</span></span><br></pre></td></tr></table></figure>

<h4 id="编译流程"><a href="#编译流程" class="headerlink" title="编译流程"></a>编译流程</h4><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">  ↓</span><br><span class="line">解析依赖</span><br><span class="line">  ↓</span><br><span class="line">编译 deps/</span><br><span class="line">  ↓</span><br><span class="line">编译 <span class="string">.erl</span> → <span class="string">.beam</span></span><br><span class="line">  ↓</span><br><span class="line">生成启动脚本</span><br><span class="line">  ↓</span><br><span class="line">创建 sbin/ 目录</span><br></pre></td></tr></table></figure>

<h3 id="实际生成的文件结构"><a href="#实际生成的文件结构" class="headerlink" title="实际生成的文件结构"></a>实际生成的文件结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-server/</span><br><span class="line">├── deps/                          <span class="comment"># 依赖模块</span></span><br><span class="line">│   ├── rabbit/ebin/*.beam        <span class="comment"># 核心模块字节码</span></span><br><span class="line">│   ├── rabbit_common/ebin/*.beam <span class="comment"># 公共模块字节码</span></span><br><span class="line">│   └── */ebin/*.beam             <span class="comment"># 其他插件字节码</span></span><br><span class="line">├── sbin/                         <span class="comment"># 启动脚本 (25 个文件)</span></span><br><span class="line">│   ├── rabbitmq-server          <span class="comment"># 主服务器脚本</span></span><br><span class="line">│   ├── rabbitmqctl              <span class="comment"># 管理工具</span></span><br><span class="line">│   ├── rabbitmq-plugins         <span class="comment"># 插件管理</span></span><br><span class="line">│   └── ...                      <span class="comment"># 其他管理脚本</span></span><br><span class="line">└── escript/                      <span class="comment"># Erlang 脚本</span></span><br></pre></td></tr></table></figure>

<h3 id="使用场景与最佳实践"><a href="#使用场景与最佳实践" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 快速开发迭代</span></span><br><span class="line">make clean &amp;&amp; make</span><br><span class="line">sbin/rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 增量编译（推荐）</span></span><br><span class="line">make  <span class="comment"># 只编译修改的文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 开发调试</span></span><br><span class="line">make shell  <span class="comment"># 进入 Erlang shell</span></span><br></pre></td></tr></table></figure>

<h4 id="性能特点"><a href="#性能特点" class="headerlink" title="性能特点"></a>性能特点</h4><ul>
<li><strong>编译时间</strong>: 最快（支持增量编译）</li>
<li><strong>磁盘占用</strong>: 中等（包含源码和字节码）</li>
<li><strong>内存使用</strong>: 低</li>
<li><strong>适用场景</strong>: 开发调试、源码修改、性能测试</li>
</ul>
<hr>
<h2 id="2-make-dist-插件目录分发"><a href="#2-make-dist-插件目录分发" class="headerlink" title="2. make dist - 插件目录分发"></a>2. <code>make dist</code> - 插件目录分发</h2><h3 id="技术原理-1"><a href="#技术原理-1" class="headerlink" title="技术原理"></a>技术原理</h3><p>基于 <strong>rabbitmq-dist.mk</strong> 实现插件打包机制，创建标准的 RabbitMQ 插件目录结构。</p>
<h4 id="核心实现源码"><a href="#核心实现源码" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-dist.mk (第 166 行)</span></span><br><span class="line"><span class="section">dist:: <span class="variable">$(ERLANG_MK_RECURSIVE_DEPS_LIST)</span> all</span></span><br><span class="line">  <span class="variable">$(verbose)</span> rm -rf <span class="variable">$(DIST_DIR)</span></span><br><span class="line">  <span class="variable">$(verbose)</span> mkdir -p <span class="variable">$(DIST_DIR)</span></span><br><span class="line">  <span class="variable">$(gen_verbose)</span> <span class="variable">$(MAKE)</span> --no-print-directory do-dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件目录创建逻辑 (第 48-54 行)</span></span><br><span class="line">dist_$(1)_ez_dir = $<span class="variable">$(<span class="built_in">if</span> $(2)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)-$(2), \</span><br><span class="line">  $<span class="variable">$(<span class="built_in">if</span> $<span class="variable">$(VERSION)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)</span>-$<span class="variable">$(VERSION)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)))</span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(DIST_AS_EZS)</span>,)</span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir)  <span class="comment"># 目录格式</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir).ez  <span class="comment"># EZ 格式</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<h4 id="打包流程详解"><a href="#打包流程详解" class="headerlink" title="打包流程详解"></a>打包流程详解</h4><ol>
<li><strong>编译所有模块</strong> - 确保所有 <code>.erl</code> 文件编译为 <code>.beam</code></li>
<li><strong>收集依赖</strong> - 将所有插件和依赖收集到 <code>plugins/</code> 目录</li>
<li><strong>生成插件结构</strong> - 每个插件包含 <code>ebin/</code>、<code>priv/</code> 等标准目录</li>
<li><strong>创建元数据</strong> - 生成 <code>.app</code> 文件描述插件信息</li>
</ol>
<h3 id="实际生成的目录结构"><a href="#实际生成的目录结构" class="headerlink" title="实际生成的目录结构"></a>实际生成的目录结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">plugins/</span><br><span class="line">├── rabbit-4.0.5/                 <span class="comment"># 核心模块目录</span></span><br><span class="line">│   ├── ebin/</span><br><span class="line">│   │   ├── rabbit.app            <span class="comment"># 应用描述文件</span></span><br><span class="line">│   │   ├── rabbit.beam           <span class="comment"># 编译后的字节码</span></span><br><span class="line">│   │   └── *.beam                <span class="comment"># 其他模块字节码</span></span><br><span class="line">│   ├── include/                  <span class="comment"># 头文件</span></span><br><span class="line">│   └── priv/                     <span class="comment"># 私有资源</span></span><br><span class="line">├── rabbitmq_management-4.0.5/    <span class="comment"># 管理插件目录</span></span><br><span class="line">├── rabbitmq_prometheus-4.0.5/    <span class="comment"># 监控插件目录</span></span><br><span class="line">└── ...                           <span class="comment"># 其他插件目录</span></span><br></pre></td></tr></table></figure>

<h3 id="使用场景与最佳实践-1"><a href="#使用场景与最佳实践-1" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="生产环境"><a href="#生产环境" class="headerlink" title="生产环境"></a>生产环境</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 创建发布版本</span></span><br><span class="line">make dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 验证插件结构</span></span><br><span class="line"><span class="built_in">ls</span> -la plugins/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 部署到生产环境</span></span><br><span class="line">rsync -av plugins/ /opt/rabbitmq/plugins/</span><br></pre></td></tr></table></figure>

<h4 id="插件开发"><a href="#插件开发" class="headerlink" title="插件开发"></a>插件开发</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 开发模式</span></span><br><span class="line">make dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 插件测试</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;plugin_name&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-make-dist-DIST-AS-EZS-true-EZ-压缩包分发"><a href="#3-make-dist-DIST-AS-EZS-true-EZ-压缩包分发" class="headerlink" title="3. make dist DIST_AS_EZS=true - EZ 压缩包分发"></a>3. <code>make dist DIST_AS_EZS=true</code> - EZ 压缩包分发</h2><h3 id="技术原理-2"><a href="#技术原理-2" class="headerlink" title="技术原理"></a>技术原理</h3><p>EZ 格式是 Erlang 的标准插件打包格式，本质上是重命名的 ZIP 文件。</p>
<h4 id="核心实现逻辑"><a href="#核心实现逻辑" class="headerlink" title="核心实现逻辑"></a>核心实现逻辑</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-dist.mk (第 8-14 行)</span></span><br><span class="line"><span class="comment"># Set $(DIST_AS_EZS) to a non-empty value to enable the packaging of</span></span><br><span class="line"><span class="comment"># plugins as .ez archives.</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(USE_RABBIT_BOOT_SCRIPT)</span>,)</span><br><span class="line">DIST_AS_EZS ?=                    <span class="comment"># 默认为空（目录格式）</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">DIST_AS_EZS =                     <span class="comment"># 强制目录格式</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<h4 id="EZ-文件生成流程"><a href="#EZ-文件生成流程" class="headerlink" title="EZ 文件生成流程"></a>EZ 文件生成流程</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">make dist DIST_AS_EZS<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">  ↓</span><br><span class="line">编译所有模块</span><br><span class="line">  ↓</span><br><span class="line">收集 ebin<span class="symbol">/</span> include<span class="symbol">/</span> priv<span class="symbol">/</span></span><br><span class="line">  ↓</span><br><span class="line">创建临时目录结构</span><br><span class="line">  ↓</span><br><span class="line">ZIP 压缩</span><br><span class="line">  ↓</span><br><span class="line">重命名为 .ez</span><br><span class="line">  ↓</span><br><span class="line">移动到 plugins<span class="operator">/</span></span><br></pre></td></tr></table></figure>

<h3 id="实际生成的-EZ-文件（已验证）"><a href="#实际生成的-EZ-文件（已验证）" class="headerlink" title="实际生成的 EZ 文件（已验证）"></a>实际生成的 EZ 文件（已验证）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">plugins/</span><br><span class="line">├── rabbit-4.0.5.ez              <span class="comment"># 3.38 MB - 核心模块</span></span><br><span class="line">├── rabbit_common-4.0.5.ez       <span class="comment"># 770.91 KB - 公共模块  </span></span><br><span class="line">├── rabbitmq_management-4.0.5.ez <span class="comment"># 管理界面插件</span></span><br><span class="line">├── rabbitmq_prometheus-4.0.5.ez <span class="comment"># 监控插件</span></span><br><span class="line">├── amqp_client-4.0.5.ez         <span class="comment"># 332.75 KB - AMQP 客户端</span></span><br><span class="line">├── cowboy-2.12.0.ez             <span class="comment"># 350.76 KB - HTTP 服务器</span></span><br><span class="line">├── gun-1.3.3.ez                 <span class="comment"># 109.35 KB - HTTP 客户端</span></span><br><span class="line">└── ...                          <span class="comment"># 其他插件 EZ 文件</span></span><br></pre></td></tr></table></figure>

<h3 id="EZ-格式深度分析"><a href="#EZ-格式深度分析" class="headerlink" title="EZ 格式深度分析"></a>EZ 格式深度分析</h3><h4 id="EZ-文件内部结构"><a href="#EZ-文件内部结构" class="headerlink" title="EZ 文件内部结构"></a>EZ 文件内部结构</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EZ 文件实际上是 ZIP 格式</span></span><br><span class="line">$ unzip -l rabbit-4.0.5.ez</span><br><span class="line">Archive:  rabbit-4.0.5.ez</span><br><span class="line">  Length      Date    Time    Name</span><br><span class="line">---------  ---------- -----   ----</span><br><span class="line">     1234  2025-01-16 22:05   rabbit-4.0.5/ebin/rabbit.app</span><br><span class="line">    45678  2025-01-16 22:05   rabbit-4.0.5/ebin/rabbit.beam</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<h4 id="目录-vs-EZ-格式对比"><a href="#目录-vs-EZ-格式对比" class="headerlink" title="目录 vs EZ 格式对比"></a>目录 vs EZ 格式对比</h4><table>
<thead>
<tr>
<th>特性</th>
<th>目录格式</th>
<th>EZ 格式</th>
</tr>
</thead>
<tbody><tr>
<td><strong>存储</strong></td>
<td>展开的文件夹</td>
<td>压缩的 ZIP 文件</td>
</tr>
<tr>
<td><strong>加载速度</strong></td>
<td>快速</td>
<td>略慢（需解压）</td>
</tr>
<tr>
<td><strong>调试</strong></td>
<td>容易（直接访问文件）</td>
<td>困难（需解压查看）</td>
</tr>
<tr>
<td><strong>分发</strong></td>
<td>占用空间大</td>
<td>占用空间小</td>
</tr>
<tr>
<td><strong>热加载</strong></td>
<td>支持</td>
<td>更好支持</td>
</tr>
<tr>
<td><strong>版本管理</strong></td>
<td>复杂</td>
<td>简单（文件名包含版本）</td>
</tr>
</tbody></table>
<h3 id="EZ-格式优势"><a href="#EZ-格式优势" class="headerlink" title="EZ 格式优势"></a>EZ 格式优势</h3><ol>
<li><strong>压缩存储</strong>: 减少磁盘占用和网络传输</li>
<li><strong>原子性</strong>: 单文件部署，避免部分文件丢失</li>
<li><strong>版本管理</strong>: 文件名包含版本信息</li>
<li><strong>热加载</strong>: Erlang VM 原生支持 EZ 文件热加载</li>
</ol>
<h3 id="使用场景与最佳实践-2"><a href="#使用场景与最佳实践-2" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="插件分发"><a href="#插件分发" class="headerlink" title="插件分发"></a>插件分发</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 插件开发者</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 生成 .ez 文件用于分发</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 插件用户</span></span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> plugin_name</span><br><span class="line"><span class="comment"># 从 .ez 文件安装插件</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-make-source-dist-源码分发包"><a href="#4-make-source-dist-源码分发包" class="headerlink" title="4. make source-dist - 源码分发包"></a>4. <code>make source-dist</code> - 源码分发包</h2><h3 id="技术原理-3"><a href="#技术原理-3" class="headerlink" title="技术原理"></a>技术原理</h3><p><code>make source-dist</code> 创建一个完整的、可复现的源码归档包（tar.xz），包含所有依赖和构建所需的文件。这是 <code>make package-generic-unix</code> 的前置步骤。</p>
<h4 id="核心实现源码-1"><a href="#核心实现源码-1" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile (第 142-152 行)</span></span><br><span class="line">SOURCE_DIST_BASE ?= rabbitmq-server</span><br><span class="line">SOURCE_DIST_SUFFIXES ?= tar.xz</span><br><span class="line">SOURCE_DIST ?= <span class="variable">$(PACKAGES_DIR)</span>/<span class="variable">$(SOURCE_DIST_BASE)</span>-<span class="variable">$(PROJECT_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 源码包文件</span></span><br><span class="line">SOURCE_DIST_FILES = <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(SOURCE_DIST)</span>.,<span class="variable">$(SOURCE_DIST_SUFFIXES)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">source-dist: <span class="variable">$(SOURCE_DIST_FILES)</span></span></span><br><span class="line">  @:</span><br><span class="line"></span><br><span class="line"><span class="comment"># 来源：Makefile (第 234-306 行)</span></span><br><span class="line"><span class="variable">$(SOURCE_DIST)</span>: <span class="variable">$(ERLANG_MK_RECURSIVE_DEPS_LIST)</span></span><br><span class="line">  <span class="variable">$(verbose)</span> mkdir -p <span class="variable">$(<span class="built_in">dir</span> <span class="variable">$@</span>)</span></span><br><span class="line">  <span class="variable">$(gen_verbose)</span> <span class="variable">$(RSYNC)</span> <span class="variable">$(RSYNC_FLAGS)</span> ./ <span class="variable">$@</span>/</span><br><span class="line">  <span class="comment"># 收集依赖、许可证、版本信息等</span></span><br></pre></td></tr></table></figure>

<h4 id="打包流程详解-1"><a href="#打包流程详解-1" class="headerlink" title="打包流程详解"></a>打包流程详解</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">make source-dist</span><br><span class="line">  ↓</span><br><span class="line">解析依赖列表 (ERLANG_MK_RECURSIVE_DEPS_LIST)</span><br><span class="line">  ↓</span><br><span class="line">rsync 复制主项目 (排除 <span class="selector-class">.git</span>, <span class="selector-class">.beam</span>, deps/ 等)</span><br><span class="line">  ↓</span><br><span class="line">收集所有依赖到 deps/</span><br><span class="line">  ↓</span><br><span class="line">处理许可证文件 (LICENSE)</span><br><span class="line">  ↓</span><br><span class="line">更新版本信息 (<span class="selector-class">.app</span><span class="selector-class">.src</span> 文件)</span><br><span class="line">  ↓</span><br><span class="line">生成 git-revisions<span class="selector-class">.txt</span> (版本追踪)</span><br><span class="line">  ↓</span><br><span class="line">处理 Mix/Hex 缓存 (用于离线构建)</span><br><span class="line">  ↓</span><br><span class="line">固定文件时间戳 (可复现性)</span><br><span class="line">  ↓</span><br><span class="line">生成 manifest 文件</span><br><span class="line">  ↓</span><br><span class="line">创建 tar<span class="selector-class">.xz</span> 归档</span><br></pre></td></tr></table></figure>

<h4 id="RSYNC-排除规则"><a href="#RSYNC-排除规则" class="headerlink" title="RSYNC 排除规则"></a>RSYNC 排除规则</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">RSYNC_FLAGS += -a <span class="variable">$(RSYNC_V)</span>              \</span><br><span class="line">  --exclude &#x27;.sw?&#x27; --exclude &#x27;.*.sw?&#x27;   \  <span class="comment"># vim 交换文件</span></span><br><span class="line">  --exclude &#x27;*.beam&#x27;                    \  <span class="comment"># 编译产物</span></span><br><span class="line">  --exclude &#x27;*.d&#x27;                       \  <span class="comment"># 依赖文件</span></span><br><span class="line">  --exclude &#x27;*.pyc&#x27;                     \  <span class="comment"># Python 缓存</span></span><br><span class="line">  --exclude &#x27;.git*&#x27;                     \  <span class="comment"># Git 文件</span></span><br><span class="line">  --exclude &#x27;.hg*&#x27;                      \  <span class="comment"># Mercurial 文件</span></span><br><span class="line">  --exclude &#x27;*.bzl&#x27;                     \  <span class="comment"># Bazel 文件</span></span><br><span class="line">  --exclude &#x27;*.bazel&#x27;                   \</span><br><span class="line">  --exclude &#x27;BUILD.*&#x27;                   \</span><br><span class="line">  --exclude &#x27;deps/&#x27;                     \  <span class="comment"># 依赖目录（单独处理）</span></span><br><span class="line">  --exclude &#x27;ebin/&#x27;                     \  <span class="comment"># 编译输出</span></span><br><span class="line">  --exclude &#x27;plugins/&#x27;                  \  <span class="comment"># 插件目录</span></span><br><span class="line">  --exclude &#x27;test/&#x27;                     \  <span class="comment"># 测试文件</span></span><br><span class="line">  --exclude &#x27;sbin/&#x27;                     \  <span class="comment"># 生成的脚本</span></span><br><span class="line">  <span class="comment"># ... 更多排除规则</span></span><br></pre></td></tr></table></figure>

<h3 id="实际生成的文件"><a href="#实际生成的文件" class="headerlink" title="实际生成的文件"></a>实际生成的文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PACKAGES/</span><br><span class="line">├── rabbitmq-server-4.0.5/              <span class="comment"># 解压后的源码目录</span></span><br><span class="line">│   ├── Makefile                        <span class="comment"># 主构建文件</span></span><br><span class="line">│   ├── erlang.mk                       <span class="comment"># Erlang.mk 构建系统</span></span><br><span class="line">│   ├── plugins.mk                      <span class="comment"># 插件定义</span></span><br><span class="line">│   ├── deps/                           <span class="comment"># 所有依赖源码</span></span><br><span class="line">│   │   ├── rabbit/                     <span class="comment"># 核心模块</span></span><br><span class="line">│   │   ├── rabbit_common/              <span class="comment"># 公共模块</span></span><br><span class="line">│   │   ├── rabbitmq_management/        <span class="comment"># 管理插件</span></span><br><span class="line">│   │   └── ...                         <span class="comment"># 其他依赖</span></span><br><span class="line">│   ├── LICENSE                         <span class="comment"># 合并的许可证文件</span></span><br><span class="line">│   ├── LICENSE-*                       <span class="comment"># 各组件许可证</span></span><br><span class="line">│   └── git-revisions.txt               <span class="comment"># Git 版本追踪</span></span><br><span class="line">├── rabbitmq-server-4.0.5.tar.xz        <span class="comment"># 源码归档包 (~5MB)</span></span><br><span class="line">└── rabbitmq-server-4.0.5.manifest      <span class="comment"># 文件清单</span></span><br></pre></td></tr></table></figure>

<h3 id="可复现性特性"><a href="#可复现性特性" class="headerlink" title="可复现性特性"></a>可复现性特性</h3><ol>
<li><strong>固定时间戳</strong> - 所有文件时间戳基于最新 Git 提交</li>
<li><strong>排序文件列表</strong> - manifest 使用 <code>LC_COLLATE=C sort</code> 确保一致性</li>
<li><strong>Hex 缓存处理</strong> - 将 ETS 缓存转为 Erlang term 文件避免二进制差异</li>
<li><strong>版本信息嵌入</strong> - 自动更新所有 <code>.app.src</code> 中的版本号</li>
</ol>
<h3 id="使用场景与最佳实践-3"><a href="#使用场景与最佳实践-3" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="离线构建"><a href="#离线构建" class="headerlink" title="离线构建"></a>离线构建</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 在联网环境创建源码包</span></span><br><span class="line">make source-dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 传输到离线环境</span></span><br><span class="line">scp PACKAGES/rabbitmq-server-4.0.5.tar.xz offline-server:/tmp/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 离线构建</span></span><br><span class="line">ssh offline-server</span><br><span class="line">tar -xf /tmp/rabbitmq-server-4.0.5.tar.xz</span><br><span class="line"><span class="built_in">cd</span> rabbitmq-server-4.0.5</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<h4 id="版本发布"><a href="#版本发布" class="headerlink" title="版本发布"></a>版本发布</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 官方发布流程</span></span><br><span class="line">make source-dist</span><br><span class="line"><span class="comment"># 生成的 tar.xz 可上传到 GitHub Releases</span></span><br></pre></td></tr></table></figure>

<h4 id="作为-package-generic-unix-的输入"><a href="#作为-package-generic-unix-的输入" class="headerlink" title="作为 package-generic-unix 的输入"></a>作为 package-generic-unix 的输入</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># make package-generic-unix 内部依赖 source-dist</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 实际执行：</span></span><br><span class="line"><span class="comment"># 1. make source-dist (生成源码包)</span></span><br><span class="line"><span class="comment"># 2. 解压源码包</span></span><br><span class="line"><span class="comment"># 3. 编译并打包为通用包</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-make-package-generic-unix-通用-Unix-包"><a href="#5-make-package-generic-unix-通用-Unix-包" class="headerlink" title="5. make package-generic-unix - 通用 Unix 包"></a>5. <code>make package-generic-unix</code> - 通用 Unix 包</h2><h3 id="技术原理-4"><a href="#技术原理-4" class="headerlink" title="技术原理"></a>技术原理</h3><p>创建跨平台的 tar.xz 安装包，包含完整的 RabbitMQ 运行环境。<strong>依赖 <code>make source-dist</code> 生成的源码包作为输入。</strong></p>
<h4 id="核心实现源码-2"><a href="#核心实现源码-2" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：packaging/generic-unix/Makefile (第 33-76 行)</span></span><br><span class="line">SOURCE_DIR = rabbitmq-server-<span class="variable">$(VERSION)</span></span><br><span class="line">TARGET_DIR = rabbitmq_server-<span class="variable">$(VERSION)</span></span><br><span class="line">TARGET_TARBALL = rabbitmq-server-<span class="variable">$(TARBALL_SUFFIX)</span>-<span class="variable">$(VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="section">dist:</span></span><br><span class="line">  <span class="comment"># 解压源码包</span></span><br><span class="line">  xzcat <span class="variable">$(SOURCE_DIST_FILE)</span> | tar -xf -</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 编译并安装到目标目录</span></span><br><span class="line">  <span class="variable">$(MAKE)</span> -C <span class="variable">$(SOURCE_DIR)</span> \</span><br><span class="line">    PREFIX= RMQ_ROOTDIR= \</span><br><span class="line">    RMQ_ERLAPP_DIR=`pwd`/<span class="variable">$(TARGET_DIR)</span> \</span><br><span class="line">    MANDIR=`pwd`/<span class="variable">$(TARGET_DIR)</span>/share/man \</span><br><span class="line">    manpages web-manpages install install-man</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 修改配置文件</span></span><br><span class="line">  sed -e &#x27;s:^SYS_PREFIX=$$:SYS_PREFIX=\$$&#123;RABBITMQ_HOME&#125;:&#x27; \</span><br><span class="line">        <span class="variable">$(TARGET_DIR)</span>/sbin/rabbitmq-defaults &gt;<span class="variable">$(TARGET_DIR)</span>/sbin/rabbitmq-defaults.tmp</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 创建 tar.xz 包</span></span><br><span class="line">  find <span class="variable">$(TARGET_DIR)</span> | LC_COLLATE=C sort &gt; <span class="variable">$(TARGET_TARBALL)</span>.manifest</span><br><span class="line">  tar --no-recursion -T <span class="variable">$(TARGET_TARBALL)</span>.manifest -cf - | \</span><br><span class="line">  xz &gt; <span class="variable">$(CURDIR)</span>/<span class="variable">$(TARGET_TARBALL)</span>.tar.xz</span><br></pre></td></tr></table></figure>

<h4 id="打包流程详解-2"><a href="#打包流程详解-2" class="headerlink" title="打包流程详解"></a>打包流程详解</h4><ol>
<li><strong>解压源码包</strong> - 从 tar.xz 源码包开始</li>
<li><strong>编译安装</strong> - 使用标准 Unix 安装路径</li>
<li><strong>生成文档</strong> - 创建 man 手册页</li>
<li><strong>配置脚本</strong> - 调整启动脚本的路径变量</li>
<li><strong>创建归档</strong> - 打包成 tar.xz 格式</li>
</ol>
<h3 id="实际生成的包结构（已验证）"><a href="#实际生成的包结构（已验证）" class="headerlink" title="实际生成的包结构（已验证）"></a>实际生成的包结构（已验证）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PACKAGES/</span><br><span class="line">├── rabbitmq-server-4.0.5.tar.xz           <span class="comment"># 4.95 MB - 源码包</span></span><br><span class="line">├── rabbitmq-server-generic-unix-4.0.5.tar.xz  <span class="comment"># 15.51 MB - 通用包</span></span><br><span class="line">├── rabbitmq-server-4.0.5.manifest         <span class="comment"># 230.22 KB - 文件清单</span></span><br><span class="line">└── rabbitmq-server-4.0.5/                 <span class="comment"># 解压后的源码目录</span></span><br><span class="line">    ├── sbin/                              <span class="comment"># 启动脚本 (25 个文件)</span></span><br><span class="line">    ├── deps/                              <span class="comment"># 依赖模块 (86 个目录)</span></span><br><span class="line">    ├── etc/                               <span class="comment"># 配置目录</span></span><br><span class="line">    └── ...                                <span class="comment"># 其他文件</span></span><br></pre></td></tr></table></figure>

<h4 id="通用包内容分析"><a href="#通用包内容分析" class="headerlink" title="通用包内容分析"></a>通用包内容分析</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压通用包后的目录结构</span></span><br><span class="line">rabbitmq_server-4.0.5/</span><br><span class="line">├── lib/                          <span class="comment"># Erlang 应用库</span></span><br><span class="line">│   └── rabbitmq_server-4.0.5/</span><br><span class="line">│       ├── ebin/                <span class="comment"># 字节码文件</span></span><br><span class="line">│       ├── include/             <span class="comment"># 头文件</span></span><br><span class="line">│       └── priv/                <span class="comment"># 私有资源</span></span><br><span class="line">├── sbin/                        <span class="comment"># 启动脚本</span></span><br><span class="line">│   ├── rabbitmq-server         <span class="comment"># 已配置 RABBITMQ_HOME</span></span><br><span class="line">│   ├── rabbitmqctl</span><br><span class="line">│   └── ...</span><br><span class="line">├── etc/                         <span class="comment"># 配置目录</span></span><br><span class="line">│   └── rabbitmq/</span><br><span class="line">├── share/                       <span class="comment"># 文档和手册</span></span><br><span class="line">│   └── man/</span><br><span class="line">└── plugins/                     <span class="comment"># 插件目录</span></span><br></pre></td></tr></table></figure>

<h3 id="通用包特点"><a href="#通用包特点" class="headerlink" title="通用包特点"></a>通用包特点</h3><ol>
<li><strong>自包含</strong>: 包含所有运行时依赖</li>
<li><strong>可移植</strong>: 适用于各种 Unix 系统</li>
<li><strong>标准化</strong>: 遵循 Unix 目录结构规范</li>
<li><strong>生产就绪</strong>: 包含完整的配置和文档</li>
</ol>
<h3 id="使用场景与最佳实践-4"><a href="#使用场景与最佳实践-4" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="容器化部署"><a href="#容器化部署" class="headerlink" title="容器化部署"></a>容器化部署</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 构建通用包</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Dockerfile 示例</span></span><br><span class="line">FROM ubuntu:20.04</span><br><span class="line">COPY PACKAGES/rabbitmq-server-generic-unix-*.tar.xz /tmp/</span><br><span class="line">RUN tar -xf /tmp/rabbitmq-server-generic-unix-*.tar.xz -C /opt/</span><br></pre></td></tr></table></figure>

<h4 id="跨平台分发"><a href="#跨平台分发" class="headerlink" title="跨平台分发"></a>跨平台分发</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 创建分发包</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 部署到不同系统</span></span><br><span class="line">scp PACKAGES/rabbitmq-server-generic-unix-*.tar.xz user@server:/tmp/</span><br><span class="line">ssh user@server <span class="string">&#x27;cd /opt &amp;&amp; tar -xf /tmp/rabbitmq-server-generic-unix-*.tar.xz&#x27;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-make-install-系统级安装"><a href="#6-make-install-系统级安装" class="headerlink" title="6. make install - 系统级安装"></a>6. <code>make install</code> - 系统级安装</h2><h3 id="技术原理-5"><a href="#技术原理-5" class="headerlink" title="技术原理"></a>技术原理</h3><p>将 RabbitMQ 安装到系统标准路径，遵循 FHS (Filesystem Hierarchy Standard)。</p>
<h4 id="核心实现逻辑-1"><a href="#核心实现逻辑-1" class="headerlink" title="核心实现逻辑"></a>核心实现逻辑</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile 第 489-523 行</span></span><br><span class="line">PREFIX ?= /usr/local</span><br><span class="line">RMQ_ROOTDIR ?= <span class="variable">$(PREFIX)</span>/lib/erlang</span><br><span class="line">RMQ_BINDIR ?= <span class="variable">$(RMQ_ROOTDIR)</span>/bin</span><br><span class="line">RMQ_LIBDIR ?= <span class="variable">$(RMQ_ROOTDIR)</span>/lib</span><br><span class="line">RMQ_ERLAPP_DIR ?= <span class="variable">$(RMQ_LIBDIR)</span>/rabbitmq_server-<span class="variable">$(PROJECT_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="section">install: install-erlapp install-scripts</span></span><br><span class="line"></span><br><span class="line"><span class="section">install-erlapp: dist</span></span><br><span class="line">  <span class="variable">$(verbose)</span> mkdir -p <span class="variable">$(DESTDIR)</span><span class="variable">$(RMQ_ERLAPP_DIR)</span></span><br><span class="line">  <span class="variable">$(inst_verbose)</span> cp -r \</span><br><span class="line">    LICENSE* \</span><br><span class="line">    <span class="variable">$(DEPS_DIR)</span>/rabbit/INSTALL \</span><br><span class="line">    <span class="variable">$(DIST_DIR)</span> \</span><br><span class="line">    <span class="variable">$(DESTDIR)</span><span class="variable">$(RMQ_ERLAPP_DIR)</span></span><br></pre></td></tr></table></figure>

<h4 id="安装组件详解"><a href="#安装组件详解" class="headerlink" title="安装组件详解"></a>安装组件详解</h4><ol>
<li><strong>核心应用</strong> (<code>install-erlapp</code>) - 安装 Erlang 应用和插件</li>
<li><strong>启动脚本</strong> (<code>install-scripts</code>) - 安装服务启动脚本</li>
<li><strong>命令行工具</strong> (<code>install-bin</code>) - 安装管理工具</li>
<li><strong>手册页</strong> (<code>install-man</code>) - 安装文档</li>
</ol>
<h3 id="系统安装目录结构"><a href="#系统安装目录结构" class="headerlink" title="系统安装目录结构"></a>系统安装目录结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/</span><br><span class="line">├── bin/                         <span class="comment"># 可执行文件</span></span><br><span class="line">│   ├── rabbitmq-server</span><br><span class="line">│   ├── rabbitmqctl</span><br><span class="line">│   └── ...</span><br><span class="line">├── lib/                         <span class="comment"># 库文件</span></span><br><span class="line">│   └── rabbitmq/</span><br><span class="line">│       ├── lib/                <span class="comment"># Erlang 应用</span></span><br><span class="line">│       └── plugins/            <span class="comment"># 插件目录</span></span><br><span class="line">├── etc/                        <span class="comment"># 配置文件</span></span><br><span class="line">│   └── rabbitmq/</span><br><span class="line">│       └── rabbitmq.conf</span><br><span class="line">├── var/                        <span class="comment"># 数据目录</span></span><br><span class="line">│   ├── <span class="built_in">log</span>/rabbitmq/          <span class="comment"># 日志</span></span><br><span class="line">│   └── lib/rabbitmq/          <span class="comment"># 数据库</span></span><br><span class="line">└── share/                      <span class="comment"># 文档</span></span><br><span class="line">    └── man/                    <span class="comment"># 手册页</span></span><br></pre></td></tr></table></figure>

<h3 id="系统安装优势"><a href="#系统安装优势" class="headerlink" title="系统安装优势"></a>系统安装优势</h3><ol>
<li><strong>标准化</strong>: 遵循 Unix 标准目录结构</li>
<li><strong>多用户</strong>: 支持系统级多用户访问</li>
<li><strong>服务集成</strong>: 便于集成到系统服务管理</li>
<li><strong>权限管理</strong>: 利用系统权限控制</li>
</ol>
<h3 id="使用场景与最佳实践-5"><a href="#使用场景与最佳实践-5" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="系统级部署"><a href="#系统级部署" class="headerlink" title="系统级部署"></a>系统级部署</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 系统安装</span></span><br><span class="line"><span class="built_in">sudo</span> make install PREFIX=/opt/rabbitmq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 服务配置</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> rabbitmq-server</span><br><span class="line"><span class="built_in">sudo</span> systemctl start rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 多用户环境</span></span><br><span class="line"><span class="built_in">sudo</span> adduser rabbitmq</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> -R rabbitmq:rabbitmq /opt/rabbitmq</span><br></pre></td></tr></table></figure>

<h4 id="包管理器集成"><a href="#包管理器集成" class="headerlink" title="包管理器集成"></a>包管理器集成</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 创建 deb/rpm 包</span></span><br><span class="line">make install DESTDIR=/tmp/rabbitmq-package PREFIX=/usr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 打包</span></span><br><span class="line">fpm -s <span class="built_in">dir</span> -t deb -C /tmp/rabbitmq-package \</span><br><span class="line">    --name rabbitmq-server \</span><br><span class="line">    --version 4.0.5 \</span><br><span class="line">    .</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-开发调试命令"><a href="#7-开发调试命令" class="headerlink" title="7. 开发调试命令"></a>7. 开发调试命令</h2><h3 id="make-run-broker-启动开发服务器"><a href="#make-run-broker-启动开发服务器" class="headerlink" title="make run-broker - 启动开发服务器"></a><code>make run-broker</code> - 启动开发服务器</h3><h4 id="技术原理-6"><a href="#技术原理-6" class="headerlink" title="技术原理"></a>技术原理</h4><p><code>make run-broker</code> 在前台启动 RabbitMQ 服务器，适合开发调试。日志直接输出到终端，便于实时查看。</p>
<h4 id="核心实现源码-3"><a href="#核心实现源码-3" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-run.mk (第 269-278 行)</span></span><br><span class="line">run-broker run-tls-broker: RABBITMQ_CONFIG_FILE := <span class="variable">$(<span class="built_in">basename</span> <span class="variable">$(TEST_CONFIG_FILE)</span>)</span></span><br><span class="line"><span class="section">run-broker:     config = <span class="variable">$(test_rabbitmq_config)</span></span></span><br><span class="line"><span class="section">run-tls-broker: config = <span class="variable">$(test_rabbitmq_config_with_tls)</span></span></span><br><span class="line"></span><br><span class="line">run-broker run-tls-broker: node-tmpdir <span class="variable">$(DIST_TARGET)</span> <span class="variable">$(TEST_CONFIG_FILE)</span></span><br><span class="line">  <span class="variable">$(BASIC_SCRIPT_ENV_SETTINGS)</span> \</span><br><span class="line">    RABBITMQ_ALLOW_INPUT=true \</span><br><span class="line">    RABBITMQ_CONFIG_FILE=<span class="variable">$(RABBITMQ_CONFIG_FILE)</span> \</span><br><span class="line">    <span class="variable">$(RABBITMQ_SERVER)</span></span><br></pre></td></tr></table></figure>

<h4 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">make run-broker</span><br><span class="line">  ↓</span><br><span class="line">创建临时目录 (<span class="keyword">node</span><span class="title">-tmpdir</span>)</span><br><span class="line">  ↓</span><br><span class="line">执行 make dist (如需要)</span><br><span class="line">  ↓</span><br><span class="line">生成测试配置文件</span><br><span class="line">  ↓</span><br><span class="line">设置环境变量</span><br><span class="line">  ↓</span><br><span class="line">启动 rabbitmq-server (前台)</span><br></pre></td></tr></table></figure>

<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 基础开发调试</span></span><br><span class="line">make run-broker</span><br><span class="line"><span class="comment"># 日志直接输出到终端，Ctrl+C 停止</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 后台启动</span></span><br><span class="line">make run-background-broker</span><br><span class="line"><span class="comment"># 服务在后台运行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. TLS 模式启动</span></span><br><span class="line">make run-tls-broker</span><br><span class="line"><span class="comment"># 使用 TLS 配置启动</span></span><br></pre></td></tr></table></figure>

<h3 id="make-run-broker-PLUGINS-插件测试"><a href="#make-run-broker-PLUGINS-插件测试" class="headerlink" title="make run-broker PLUGINS= - 插件测试"></a><code>make run-broker PLUGINS=</code> - 插件测试</h3><h4 id="技术原理-7"><a href="#技术原理-7" class="headerlink" title="技术原理"></a>技术原理</h4><p>通过 <code>PLUGINS</code> 环境变量指定要加载的插件，用于测试特定插件功能。</p>
<h4 id="使用场景-1"><a href="#使用场景-1" class="headerlink" title="使用场景"></a>使用场景</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 测试管理插件</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;rabbitmq_management&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 测试多个插件</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;rabbitmq_management rabbitmq_prometheus&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 测试自定义插件</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;my_custom_plugin&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><ul>
<li>插件名称使用空格分隔</li>
<li>插件需要先编译完成（<code>make dist</code>）</li>
<li>依赖插件会自动加载</li>
</ul>
<h3 id="make-shell-Erlang-Shell"><a href="#make-shell-Erlang-Shell" class="headerlink" title="make shell - Erlang Shell"></a><code>make shell</code> - Erlang Shell</h3><h4 id="技术原理-8"><a href="#技术原理-8" class="headerlink" title="技术原理"></a>技术原理</h4><p>启动一个加载了所有 RabbitMQ 模块的 Erlang Shell，用于代码调试和模块测试。</p>
<h4 id="核心实现源码-4"><a href="#核心实现源码-4" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：erlang.mk (第 7053-7054 行)</span></span><br><span class="line"><span class="section">shell:: build-shell-deps</span></span><br><span class="line">  <span class="variable">$(gen_verbose)</span> <span class="variable">$(SHELL_ERL)</span> -pa <span class="variable">$(SHELL_PATHS)</span> <span class="variable">$(SHELL_OPTS)</span></span><br></pre></td></tr></table></figure>

<h4 id="使用场景-2"><a href="#使用场景-2" class="headerlink" title="使用场景"></a>使用场景</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 进入 Erlang Shell</span></span><br><span class="line">make shell</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Shell 中：</span></span><br><span class="line"><span class="comment"># 测试模块函数</span></span><br><span class="line">1&gt; rabbit_misc:version().</span><br><span class="line"><span class="string">&quot;4.0.5&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查模块信息</span></span><br><span class="line">2&gt; m(rabbit).</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译并加载修改后的模块</span></span><br><span class="line">3&gt; c(my_module).</span><br></pre></td></tr></table></figure>

<h4 id="与-erl-的区别"><a href="#与-erl-的区别" class="headerlink" title="与 erl 的区别"></a>与 <code>erl</code> 的区别</h4><table>
<thead>
<tr>
<th>特性</th>
<th><code>make shell</code></th>
<th><code>erl</code></th>
</tr>
</thead>
<tbody><tr>
<td>代码路径</td>
<td>自动设置所有依赖</td>
<td>需手动指定</td>
</tr>
<tr>
<td>模块加载</td>
<td>RabbitMQ 模块可用</td>
<td>需手动加载</td>
</tr>
<tr>
<td>环境变量</td>
<td>继承项目配置</td>
<td>默认配置</td>
</tr>
<tr>
<td>用途</td>
<td>RabbitMQ 开发调试</td>
<td>通用 Erlang 开发</td>
</tr>
</tbody></table>
<h3 id="make-run-node-裸-Erlang-节点"><a href="#make-run-node-裸-Erlang-节点" class="headerlink" title="make run-node - 裸 Erlang 节点"></a><code>make run-node</code> - 裸 Erlang 节点</h3><h4 id="技术原理-9"><a href="#技术原理-9" class="headerlink" title="技术原理"></a>技术原理</h4><p>启动一个不运行 RabbitMQ 应用的 Erlang 节点，仅加载代码但不启动服务。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-run.mk (第 288-292 行)</span></span><br><span class="line"><span class="section">run-node: node-tmpdir <span class="variable">$(DIST_TARGET)</span></span></span><br><span class="line">  <span class="variable">$(BASIC_SCRIPT_ENV_SETTINGS)</span> \</span><br><span class="line">    RABBITMQ_NODE_ONLY=true \</span><br><span class="line">    RABBITMQ_ALLOW_INPUT=true \</span><br><span class="line">    <span class="variable">$(RABBITMQ_SERVER)</span></span><br></pre></td></tr></table></figure>

<h4 id="使用场景-3"><a href="#使用场景-3" class="headerlink" title="使用场景"></a>使用场景</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Erlang 级别调试</span></span><br><span class="line">make run-node</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 手动启动 RabbitMQ 应用</span></span><br><span class="line">1&gt; application:ensure_all_started(rabbit).</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 测试特定模块而不启动完整服务</span></span><br><span class="line">1&gt; rabbit_misc:version().</span><br></pre></td></tr></table></figure>

<h3 id="开发工作流最佳实践"><a href="#开发工作流最佳实践" class="headerlink" title="开发工作流最佳实践"></a>开发工作流最佳实践</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 完整开发工作流</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 编译项目</span></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 测试模块（不启动服务）</span></span><br><span class="line">make shell</span><br><span class="line">&gt; my_module:<span class="built_in">test</span>().</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 启动服务验证</span></span><br><span class="line">make run-broker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 测试特定插件</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;rabbitmq_management&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 查看管理界面</span></span><br><span class="line"><span class="comment"># 浏览器访问 http://localhost:15672</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 修改代码后重新编译</span></span><br><span class="line">make  <span class="comment"># 增量编译</span></span><br><span class="line">make run-broker  <span class="comment"># 重新启动</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="构建系统架构深度解析"><a href="#构建系统架构深度解析" class="headerlink" title="构建系统架构深度解析"></a>构建系统架构深度解析</h2><h3 id="核心组件关系"><a href="#核心组件关系" class="headerlink" title="核心组件关系"></a>核心组件关系</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Makefile</span><br><span class="line">  ├── erlang<span class="selector-class">.mk</span>          → 编译 Erlang 代码 → 生成 <span class="selector-class">.beam</span> 文件</span><br><span class="line">  ├── rabbitmq-components<span class="selector-class">.mk</span> → 管理组件依赖 → deps/ 目录</span><br><span class="line">  └── plugins<span class="selector-class">.mk</span>         → 插件列表管理 → PLUGINS 变量</span><br><span class="line">                                    ↓</span><br><span class="line">                          rabbitmq-dist<span class="selector-class">.mk</span></span><br><span class="line">                                    ↓</span><br><span class="line">                    ┌───────────────┴───────────────┐</span><br><span class="line">                    ↓                               ↓</span><br><span class="line">              dist 目标                         EZ 打包</span><br><span class="line">                    ↓                               ↓</span><br><span class="line">            plugins/ 目录                      <span class="selector-class">.ez</span> 文件</span><br></pre></td></tr></table></figure>

<h3 id="关键配置文件详解"><a href="#关键配置文件详解" class="headerlink" title="关键配置文件详解"></a>关键配置文件详解</h3><h4 id="1-Makefile-主控制文件"><a href="#1-Makefile-主控制文件" class="headerlink" title="1. Makefile - 主控制文件"></a>1. <code>Makefile</code> - 主控制文件</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PROJECT = rabbitmq_server_release</span><br><span class="line">PROJECT_DESCRIPTION = RabbitMQ Server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件列表</span></span><br><span class="line"><span class="keyword">include</span> plugins.mk</span><br><span class="line">DEPS = rabbit_common rabbit <span class="variable">$(PLUGINS)</span> <span class="variable">$(ADDITIONAL_PLUGINS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建系统</span></span><br><span class="line"><span class="keyword">include</span> rabbitmq-components.mk</span><br><span class="line"><span class="keyword">include</span> erlang.mk</span><br></pre></td></tr></table></figure>

<h4 id="2-plugins-mk-插件定义"><a href="#2-plugins-mk-插件定义" class="headerlink" title="2. plugins.mk - 插件定义"></a>2. <code>plugins.mk</code> - 插件定义</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PLUGINS = \</span><br><span class="line">  rabbitmq_amqp1_0 \</span><br><span class="line">  rabbitmq_auth_backend_cache \</span><br><span class="line">  rabbitmq_auth_backend_http \</span><br><span class="line">  rabbitmq_auth_backend_ldap \</span><br><span class="line">  rabbitmq_auth_backend_oauth2 \</span><br><span class="line">  rabbitmq_auth_mechanism_ssl \</span><br><span class="line">  rabbitmq_consistent_hash_exchange \</span><br><span class="line">  <span class="comment"># ... 更多插件</span></span><br></pre></td></tr></table></figure>

<h4 id="3-rabbitmq-dist-mk-分发逻辑"><a href="#3-rabbitmq-dist-mk-分发逻辑" class="headerlink" title="3. rabbitmq-dist.mk - 分发逻辑"></a>3. <code>rabbitmq-dist.mk</code> - 分发逻辑</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EZ 文件生成宏</span></span><br><span class="line"><span class="keyword">define</span> do_ez_target_erlangmk</span><br><span class="line"><span class="comment"># 定义目标目录和文件名</span></span><br><span class="line">dist_$(1)_ez_dir = <span class="variable">$(DIST_DIR)</span>/$(1)-$(2)</span><br><span class="line"><span class="comment"># 根据 DIST_AS_EZS 决定格式</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(DIST_AS_EZS)</span>,)</span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir)      <span class="comment"># 目录</span></span><br><span class="line"><span class="keyword">else</span>  </span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir).ez   <span class="comment"># EZ 文件</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endef</span></span><br></pre></td></tr></table></figure>

<h3 id="构建系统特点"><a href="#构建系统特点" class="headerlink" title="构建系统特点"></a>构建系统特点</h3><ol>
<li><strong>模块化设计</strong> - 每个 <code>.mk</code> 文件负责特定功能</li>
<li><strong>可扩展性</strong> - 支持自定义插件和构建规则</li>
<li><strong>标准化</strong> - 遵循 Erlang&#x2F;OTP 和 Unix 标准</li>
<li><strong>自动化</strong> - 完整的依赖管理和构建流程</li>
</ol>
<hr>
<h2 id="完整编译流程对比"><a href="#完整编译流程对比" class="headerlink" title="完整编译流程对比"></a>完整编译流程对比</h2><h3 id="性能和资源详细对比"><a href="#性能和资源详细对比" class="headerlink" title="性能和资源详细对比"></a>性能和资源详细对比</h3><h4 id="构建命令-1"><a href="#构建命令-1" class="headerlink" title="构建命令"></a>构建命令</h4><table>
<thead>
<tr>
<th>编译方式</th>
<th>编译时间</th>
<th>磁盘占用</th>
<th>内存使用</th>
<th>网络传输</th>
<th>部署复杂度</th>
<th>维护成本</th>
</tr>
</thead>
<tbody><tr>
<td><code>make</code></td>
<td>最快 (30s)</td>
<td>中等 (200MB)</td>
<td>低 (100MB)</td>
<td>不适用</td>
<td>简单</td>
<td>低</td>
</tr>
<tr>
<td><code>make dist</code></td>
<td>快 (45s)</td>
<td>大 (300MB)</td>
<td>中等 (150MB)</td>
<td>大 (300MB)</td>
<td>中等</td>
<td>中等</td>
</tr>
<tr>
<td><code>make dist DIST_AS_EZS=true</code></td>
<td>中等 (60s)</td>
<td>小 (15MB)</td>
<td>中等 (150MB)</td>
<td>小 (15MB)</td>
<td>简单</td>
<td>低</td>
</tr>
<tr>
<td><code>make source-dist</code></td>
<td>快 (40s)</td>
<td>小 (~5MB)</td>
<td>低 (100MB)</td>
<td>小 (~5MB)</td>
<td>简单</td>
<td>低</td>
</tr>
<tr>
<td><code>make package-generic-unix</code></td>
<td>慢 (120s)</td>
<td>最小 (15.51MB)</td>
<td>高 (200MB)</td>
<td>最小 (15.51MB)</td>
<td>简单</td>
<td>低</td>
</tr>
<tr>
<td><code>make install</code></td>
<td>中等 (75s)</td>
<td>中等 (250MB)</td>
<td>低 (100MB)</td>
<td>不适用</td>
<td>复杂</td>
<td>高</td>
</tr>
</tbody></table>
<h4 id="开发调试命令-1"><a href="#开发调试命令-1" class="headerlink" title="开发调试命令"></a>开发调试命令</h4><table>
<thead>
<tr>
<th>命令</th>
<th>启动时间</th>
<th>用途</th>
<th>交互性</th>
</tr>
</thead>
<tbody><tr>
<td><code>make run-broker</code></td>
<td>快 (5s)</td>
<td>开发调试</td>
<td>前台，可查看日志</td>
</tr>
<tr>
<td><code>make run-broker PLUGINS=...</code></td>
<td>快 (5s)</td>
<td>插件测试</td>
<td>前台，指定插件</td>
</tr>
<tr>
<td><code>make shell</code></td>
<td>最快 (2s)</td>
<td>模块调试</td>
<td>交互式 Erlang Shell</td>
</tr>
<tr>
<td><code>make run-background-broker</code></td>
<td>快 (5s)</td>
<td>自动化测试</td>
<td>后台运行</td>
</tr>
<tr>
<td><code>make run-node</code></td>
<td>最快 (2s)</td>
<td>Erlang 调试</td>
<td>裸节点，无 RabbitMQ</td>
</tr>
</tbody></table>
<hr>
<h2 id="最佳实践指南"><a href="#最佳实践指南" class="headerlink" title="最佳实践指南"></a>最佳实践指南</h2><h3 id="开发阶段最佳实践"><a href="#开发阶段最佳实践" class="headerlink" title="开发阶段最佳实践"></a>开发阶段最佳实践</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 初始设置</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/rabbitmq/rabbitmq-server.git</span><br><span class="line"><span class="built_in">cd</span> rabbitmq-server</span><br><span class="line">git checkout v4.0.5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 快速开发迭代</span></span><br><span class="line">make clean &amp;&amp; make</span><br><span class="line">sbin/rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 增量编译（推荐）</span></span><br><span class="line">make  <span class="comment"># 只编译修改的文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 开发调试</span></span><br><span class="line">make shell  <span class="comment"># 进入 Erlang shell</span></span><br><span class="line">make run-broker  <span class="comment"># 运行开发版本</span></span><br></pre></td></tr></table></figure>

<h3 id="测试阶段最佳实践"><a href="#测试阶段最佳实践" class="headerlink" title="测试阶段最佳实践"></a>测试阶段最佳实践</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 功能测试</span></span><br><span class="line">make dist</span><br><span class="line"><span class="comment"># 测试插件加载和目录结构</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 插件兼容性测试</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 验证 EZ 文件加载和热加载</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 集成测试</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 在不同环境测试安装包</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 性能测试</span></span><br><span class="line">make  <span class="comment"># 使用最快的编译方式</span></span><br></pre></td></tr></table></figure>

<h3 id="生产部署最佳实践"><a href="#生产部署最佳实践" class="headerlink" title="生产部署最佳实践"></a>生产部署最佳实践</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 容器化部署（推荐）</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 使用 tar.xz 包构建 Docker 镜像</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 传统服务器部署</span></span><br><span class="line">make install PREFIX=/opt/rabbitmq</span><br><span class="line"><span class="comment"># 系统级安装</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 云原生部署</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 使用 EZ 文件支持动态插件管理</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 高可用部署</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 标准化的部署包，便于集群管理</span></span><br></pre></td></tr></table></figure>

<h3 id="插件开发最佳实践"><a href="#插件开发最佳实践" class="headerlink" title="插件开发最佳实践"></a>插件开发最佳实践</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 插件开发</span></span><br><span class="line">make dist</span><br><span class="line"><span class="comment"># 开发阶段使用目录格式便于调试</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 插件测试</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;plugin_name&quot;</span></span><br><span class="line"><span class="comment"># 测试插件功能</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 插件分发</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 生成 .ez 文件用于分发</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 插件发布</span></span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> plugin_name</span><br><span class="line"><span class="comment"># 从 .ez 文件安装插件</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="高级配置与优化"><a href="#高级配置与优化" class="headerlink" title="高级配置与优化"></a>高级配置与优化</h2><h3 id="环境变量控制"><a href="#环境变量控制" class="headerlink" title="环境变量控制"></a>环境变量控制</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义插件目录</span></span><br><span class="line"><span class="built_in">export</span> DIST_DIR=/custom/plugins/path</span><br><span class="line">make dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义包输出目录</span></span><br><span class="line"><span class="built_in">export</span> PACKAGES_DIR=/custom/packages/path  </span><br><span class="line">make package-generic-unix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用社区插件</span></span><br><span class="line"><span class="built_in">export</span> COMMUNITY_PLUGINS=1</span><br><span class="line">make dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义版本号</span></span><br><span class="line"><span class="built_in">export</span> PROJECT_VERSION=4.0.5-custom</span><br><span class="line">make dist</span><br></pre></td></tr></table></figure>

<h3 id="编译优化技巧"><a href="#编译优化技巧" class="headerlink" title="编译优化技巧"></a>编译优化技巧</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 并行编译（推荐）</span></span><br><span class="line">make -j$(<span class="built_in">nproc</span>) dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 详细输出（调试用）</span></span><br><span class="line">make V=1 dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 跳过测试（加速编译）</span></span><br><span class="line">make SKIP_TESTS=1 dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增量编译（开发用）</span></span><br><span class="line">make  <span class="comment"># 不使用 clean</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存优化</span></span><br><span class="line"><span class="built_in">export</span> ERL_MAX_PORTS=32768</span><br><span class="line">make dist</span><br></pre></td></tr></table></figure>

<h3 id="自定义构建配置"><a href="#自定义构建配置" class="headerlink" title="自定义构建配置"></a>自定义构建配置</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 local.mk 文件进行自定义</span></span><br><span class="line"><span class="comment"># local.mk</span></span><br><span class="line">ADDITIONAL_PLUGINS = my_custom_plugin</span><br><span class="line">DIST_AS_EZS = 1</span><br><span class="line">PACKAGES_DIR = /opt/packages</span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含到主 Makefile</span></span><br><span class="line"><span class="keyword">include</span> local.mk</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="故障排除指南"><a href="#故障排除指南" class="headerlink" title="故障排除指南"></a>故障排除指南</h2><h3 id="常见编译问题"><a href="#常见编译问题" class="headerlink" title="常见编译问题"></a>常见编译问题</h3><h4 id="1-依赖问题"><a href="#1-依赖问题" class="headerlink" title="1. 依赖问题"></a>1. 依赖问题</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 问题：deps 编译失败</span></span><br><span class="line"><span class="comment"># 解决：清理并重新获取依赖</span></span><br><span class="line">make clean-deps</span><br><span class="line">make deps</span><br></pre></td></tr></table></figure>

<h4 id="2-版本冲突"><a href="#2-版本冲突" class="headerlink" title="2. 版本冲突"></a>2. 版本冲突</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 问题：Erlang 版本不兼容</span></span><br><span class="line"><span class="comment"># 解决：检查并切换 Erlang 版本</span></span><br><span class="line">erl -version</span><br><span class="line"><span class="comment"># 确保使用 Erlang 25.x 或 26.x</span></span><br></pre></td></tr></table></figure>

<h4 id="3-磁盘空间不足"><a href="#3-磁盘空间不足" class="headerlink" title="3. 磁盘空间不足"></a>3. 磁盘空间不足</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 问题：编译过程中磁盘空间不足</span></span><br><span class="line"><span class="comment"># 解决：清理临时文件</span></span><br><span class="line">make clean</span><br><span class="line">make distclean</span><br></pre></td></tr></table></figure>

<h4 id="4-权限问题"><a href="#4-权限问题" class="headerlink" title="4. 权限问题"></a>4. 权限问题</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 问题：install 时权限不足</span></span><br><span class="line"><span class="comment"># 解决：使用正确的权限</span></span><br><span class="line"><span class="built_in">sudo</span> make install PREFIX=/opt/rabbitmq</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> -R rabbitmq:rabbitmq /opt/rabbitmq</span><br></pre></td></tr></table></figure>

<h3 id="性能优化建议"><a href="#性能优化建议" class="headerlink" title="性能优化建议"></a>性能优化建议</h3><ol>
<li><strong>使用 SSD</strong> - 显著提升编译速度</li>
<li><strong>增加内存</strong> - 减少交换文件使用</li>
<li><strong>并行编译</strong> - 利用多核 CPU</li>
<li><strong>增量编译</strong> - 开发阶段避免 clean</li>
<li><strong>本地缓存</strong> - 使用本地 Maven&#x2F;Hex 缓存</li>
</ol>
<hr>
<h2 id="总结与建议"><a href="#总结与建议" class="headerlink" title="总结与建议"></a>总结与建议</h2><h3 id="命令选择矩阵"><a href="#命令选择矩阵" class="headerlink" title="命令选择矩阵"></a>命令选择矩阵</h3><h4 id="构建场景"><a href="#构建场景" class="headerlink" title="构建场景"></a>构建场景</h4><table>
<thead>
<tr>
<th>场景</th>
<th>推荐方式</th>
<th>理由</th>
</tr>
</thead>
<tbody><tr>
<td><strong>本地开发</strong></td>
<td><code>make</code></td>
<td>最快，支持增量编译</td>
</tr>
<tr>
<td><strong>功能测试</strong></td>
<td><code>make dist</code></td>
<td>完整插件结构，便于调试</td>
</tr>
<tr>
<td><strong>插件开发</strong></td>
<td><code>make dist</code> → <code>make dist DIST_AS_EZS=true</code></td>
<td>开发用目录，分发用 EZ</td>
</tr>
<tr>
<td><strong>离线构建</strong></td>
<td><code>make source-dist</code></td>
<td>包含所有依赖，可复现</td>
</tr>
<tr>
<td><strong>版本发布</strong></td>
<td><code>make source-dist</code></td>
<td>官方发布流程，可复现归档</td>
</tr>
<tr>
<td><strong>容器部署</strong></td>
<td><code>make package-generic-unix</code></td>
<td>自包含，标准化</td>
</tr>
<tr>
<td><strong>生产部署</strong></td>
<td><code>make package-generic-unix</code> 或 <code>make install</code></td>
<td>稳定，便于管理</td>
</tr>
<tr>
<td><strong>自定义安装</strong></td>
<td><code>make install PREFIX=/opt/rabbitmq</code></td>
<td>指定安装路径</td>
</tr>
<tr>
<td><strong>插件分发</strong></td>
<td><code>make dist DIST_AS_EZS=true</code></td>
<td>压缩，便于传输</td>
</tr>
<tr>
<td><strong>CI&#x2F;CD</strong></td>
<td><code>make package-generic-unix</code></td>
<td>可重现，标准化</td>
</tr>
</tbody></table>
<h4 id="开发调试场景"><a href="#开发调试场景" class="headerlink" title="开发调试场景"></a>开发调试场景</h4><table>
<thead>
<tr>
<th>场景</th>
<th>推荐方式</th>
<th>理由</th>
</tr>
</thead>
<tbody><tr>
<td><strong>日常开发调试</strong></td>
<td><code>make run-broker</code></td>
<td>前台运行，实时查看日志</td>
</tr>
<tr>
<td><strong>插件功能验证</strong></td>
<td><code>make run-broker PLUGINS=&quot;plugin_name&quot;</code></td>
<td>按需加载插件</td>
</tr>
<tr>
<td><strong>模块级调试</strong></td>
<td><code>make shell</code></td>
<td>交互式测试函数</td>
</tr>
<tr>
<td><strong>自动化测试</strong></td>
<td><code>make run-background-broker</code></td>
<td>后台运行，脚本控制</td>
</tr>
<tr>
<td><strong>Erlang 底层调试</strong></td>
<td><code>make run-node</code></td>
<td>不启动 RabbitMQ 应用</td>
</tr>
</tbody></table>
<h3 id="关键技术洞察"><a href="#关键技术洞察" class="headerlink" title="关键技术洞察"></a>关键技术洞察</h3><ol>
<li><strong>EZ 格式是王道</strong> - 对于插件分发和热加载</li>
<li><strong>通用包最实用</strong> - 对于生产部署和容器化</li>
<li><strong>源码包是基础</strong> - <code>source-dist</code> 是 <code>package-generic-unix</code> 的前置依赖</li>
<li><strong>开发调试用 run-broker</strong> - 比 <code>sbin/rabbitmq-server</code> 更方便</li>
<li><strong>增量编译是关键</strong> - 对于开发效率</li>
<li><strong>构建系统很灵活</strong> - 支持高度定制</li>
<li><strong>标准化很重要</strong> - 遵循 Unix 和 Erlang 标准</li>
</ol>
<p>RabbitMQ 的构建系统设计精良，通过不同的编译命令满足了从开发到生产的各种需求。理解这些编译方式的原理和最佳实践，将显著提升 RabbitMQ 的开发、部署和运维效率。</p>
<hr>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/docs">RabbitMQ 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://erlang.mk/">Erlang.mk 用户指南</a></li>
<li><a target="_blank" rel="noopener" href="https://www.erlang.org/doc/design_principles/users_guide.html">Erlang&#x2F;OTP 设计原则</a></li>
<li><a target="_blank" rel="noopener" href="https://refspecs.linuxfoundation.org/FHS_3.0/fhs/index.html">Unix 文件系统层次标准</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/16/rabbitmq-rabbitmq-build-deep-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/16/rabbitmq-rabbitmq-build-deep-analysis/" class="post-title-link" itemprop="url">RabbitMQ 编译方式深度解析与源码分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-16 22:00:00 / 修改时间：22:20:58" itemprop="dateCreated datePublished" datetime="2026-01-16T22:00:00+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RabbitMQ-编译方式深度解析与源码分析"><a href="#RabbitMQ-编译方式深度解析与源码分析" class="headerlink" title="RabbitMQ 编译方式深度解析与源码分析"></a>RabbitMQ 编译方式深度解析与源码分析</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>RabbitMQ 作为一个复杂的分布式消息中间件，提供了多种编译和打包方式来满足不同的部署需求。本文档基于 RabbitMQ 4.0.x 源码，深入分析各种编译命令的原理、实现机制和适用场景。</p>
<h2 id="编译命令对比表"><a href="#编译命令对比表" class="headerlink" title="编译命令对比表"></a>编译命令对比表</h2><table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
<th>输出格式</th>
<th>部署方式</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>make</code></td>
<td>基础编译</td>
<td>源码目录 + beam 文件</td>
<td>开发调试</td>
<td>本地开发、调试</td>
</tr>
<tr>
<td><code>make dist</code></td>
<td>打包文件</td>
<td>插件目录结构</td>
<td>目录部署</td>
<td>生产环境、插件开发</td>
</tr>
<tr>
<td><code>make dist DIST_AS_EZS=true</code></td>
<td>打包成 ez 文件</td>
<td>.ez 压缩包</td>
<td>插件安装</td>
<td>插件分发、热加载</td>
</tr>
<tr>
<td><code>make package-generic-unix</code></td>
<td>打包成 PACKAGE 文件</td>
<td>tar.xz 包</td>
<td>解压安装</td>
<td>容器、跨平台</td>
</tr>
<tr>
<td><code>make install</code></td>
<td>系统安装</td>
<td>系统目录</td>
<td>系统安装</td>
<td>生产部署</td>
</tr>
</tbody></table>
<hr>
<h2 id="1-make-基础编译"><a href="#1-make-基础编译" class="headerlink" title="1. make - 基础编译"></a>1. <code>make</code> - 基础编译</h2><h3 id="技术原理"><a href="#技术原理" class="headerlink" title="技术原理"></a>技术原理</h3><p>基于 <strong>erlang.mk</strong> 构建系统，执行 Erlang&#x2F;OTP 标准编译流程。</p>
<h4 id="核心实现机制"><a href="#核心实现机制" class="headerlink" title="核心实现机制"></a>核心实现机制</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile (第 77 行)</span></span><br><span class="line"><span class="keyword">include</span> erlang.mk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 来源：erlang.mk 核心逻辑</span></span><br><span class="line"><span class="section">app:: deps <span class="variable">$(PROJECT)</span>.d</span></span><br><span class="line">  <span class="variable">$(verbose)</span> <span class="variable">$(MAKE)</span> --no-print-directory app-build</span><br></pre></td></tr></table></figure>

<h4 id="编译流程"><a href="#编译流程" class="headerlink" title="编译流程"></a>编译流程</h4><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">  ↓</span><br><span class="line">解析依赖</span><br><span class="line">  ↓</span><br><span class="line">编译 deps/</span><br><span class="line">  ↓</span><br><span class="line">编译 <span class="string">.erl</span> → <span class="string">.beam</span></span><br><span class="line">  ↓</span><br><span class="line">生成启动脚本</span><br><span class="line">  ↓</span><br><span class="line">创建 sbin/ 目录</span><br></pre></td></tr></table></figure>

<h3 id="生成的文件结构"><a href="#生成的文件结构" class="headerlink" title="生成的文件结构"></a>生成的文件结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-server/</span><br><span class="line">├── deps/                          <span class="comment"># 依赖模块</span></span><br><span class="line">│   ├── rabbit/ebin/*.beam        <span class="comment"># 核心模块字节码</span></span><br><span class="line">│   ├── rabbit_common/ebin/*.beam <span class="comment"># 公共模块字节码</span></span><br><span class="line">│   └── */ebin/*.beam             <span class="comment"># 其他插件字节码</span></span><br><span class="line">├── sbin/                         <span class="comment"># 启动脚本</span></span><br><span class="line">│   ├── rabbitmq-server          <span class="comment"># 主服务器脚本</span></span><br><span class="line">│   ├── rabbitmqctl              <span class="comment"># 管理工具</span></span><br><span class="line">│   └── rabbitmq-plugins         <span class="comment"># 插件管理</span></span><br><span class="line">└── escript/                      <span class="comment"># Erlang 脚本</span></span><br></pre></td></tr></table></figure>

<h3 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h3><ul>
<li><strong>开发调试</strong>: 快速编译，支持增量构建</li>
<li><strong>源码修改</strong>: 直接修改源码后重新编译</li>
<li><strong>性能测试</strong>: 最小化的编译开销</li>
</ul>
<hr>
<h2 id="2-make-dist-插件目录分发"><a href="#2-make-dist-插件目录分发" class="headerlink" title="2. make dist - 插件目录分发"></a>2. <code>make dist</code> - 插件目录分发</h2><h3 id="技术原理-1"><a href="#技术原理-1" class="headerlink" title="技术原理"></a>技术原理</h3><p>基于 <strong>rabbitmq-dist.mk</strong> 实现插件打包机制，创建标准的 RabbitMQ 插件目录结构。</p>
<h4 id="核心实现源码"><a href="#核心实现源码" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-dist.mk (第 166 行)</span></span><br><span class="line"><span class="section">dist:: <span class="variable">$(ERLANG_MK_RECURSIVE_DEPS_LIST)</span> all</span></span><br><span class="line">  <span class="variable">$(verbose)</span> rm -rf <span class="variable">$(DIST_DIR)</span></span><br><span class="line">  <span class="variable">$(verbose)</span> mkdir -p <span class="variable">$(DIST_DIR)</span></span><br><span class="line">  <span class="variable">$(gen_verbose)</span> <span class="variable">$(MAKE)</span> --no-print-directory do-dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件目录创建逻辑 (第 48-54 行)</span></span><br><span class="line">dist_$(1)_ez_dir = $<span class="variable">$(<span class="built_in">if</span> $(2)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)-$(2), \</span><br><span class="line">  $<span class="variable">$(<span class="built_in">if</span> $<span class="variable">$(VERSION)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)</span>-$<span class="variable">$(VERSION)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)))</span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(DIST_AS_EZS)</span>,)</span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir)  <span class="comment"># 目录格式</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir).ez  <span class="comment"># EZ 格式</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<h4 id="打包流程"><a href="#打包流程" class="headerlink" title="打包流程"></a>打包流程</h4><ol>
<li><strong>编译所有模块</strong> - 确保所有 <code>.erl</code> 文件编译为 <code>.beam</code></li>
<li><strong>收集依赖</strong> - 将所有插件和依赖收集到 <code>plugins/</code> 目录</li>
<li><strong>生成插件结构</strong> - 每个插件包含 <code>ebin/</code>、<code>priv/</code> 等标准目录</li>
<li><strong>创建元数据</strong> - 生成 <code>.app</code> 文件描述插件信息</li>
</ol>
<h3 id="生成的目录结构"><a href="#生成的目录结构" class="headerlink" title="生成的目录结构"></a>生成的目录结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">plugins/</span><br><span class="line">├── rabbit-4.0.5/                 <span class="comment"># 核心模块目录</span></span><br><span class="line">│   ├── ebin/</span><br><span class="line">│   │   ├── rabbit.app            <span class="comment"># 应用描述文件</span></span><br><span class="line">│   │   ├── rabbit.beam           <span class="comment"># 编译后的字节码</span></span><br><span class="line">│   │   └── *.beam                <span class="comment"># 其他模块字节码</span></span><br><span class="line">│   ├── include/                  <span class="comment"># 头文件</span></span><br><span class="line">│   └── priv/                     <span class="comment"># 私有资源</span></span><br><span class="line">├── rabbitmq_management-4.0.5/    <span class="comment"># 管理插件目录</span></span><br><span class="line">├── rabbitmq_prometheus-4.0.5/    <span class="comment"># 监控插件目录</span></span><br><span class="line">└── ...                           <span class="comment"># 其他插件目录</span></span><br></pre></td></tr></table></figure>

<h3 id="目录-vs-EZ-格式对比"><a href="#目录-vs-EZ-格式对比" class="headerlink" title="目录 vs EZ 格式对比"></a>目录 vs EZ 格式对比</h3><table>
<thead>
<tr>
<th>特性</th>
<th>目录格式</th>
<th>EZ 格式</th>
</tr>
</thead>
<tbody><tr>
<td><strong>存储</strong></td>
<td>展开的文件夹</td>
<td>压缩的 ZIP 文件</td>
</tr>
<tr>
<td><strong>加载速度</strong></td>
<td>快速</td>
<td>略慢（需解压）</td>
</tr>
<tr>
<td><strong>调试</strong></td>
<td>容易（直接访问文件）</td>
<td>困难（需解压查看）</td>
</tr>
<tr>
<td><strong>分发</strong></td>
<td>占用空间大</td>
<td>占用空间小</td>
</tr>
<tr>
<td><strong>热加载</strong></td>
<td>支持</td>
<td>更好支持</td>
</tr>
</tbody></table>
<hr>
<h2 id="3-make-dist-DIST-AS-EZS-true-EZ-压缩包分发"><a href="#3-make-dist-DIST-AS-EZS-true-EZ-压缩包分发" class="headerlink" title="3. make dist DIST_AS_EZS=true - EZ 压缩包分发"></a>3. <code>make dist DIST_AS_EZS=true</code> - EZ 压缩包分发</h2><h3 id="技术原理-2"><a href="#技术原理-2" class="headerlink" title="技术原理"></a>技术原理</h3><p>EZ 格式是 Erlang 的标准插件打包格式，本质上是重命名的 ZIP 文件。</p>
<h4 id="核心实现逻辑"><a href="#核心实现逻辑" class="headerlink" title="核心实现逻辑"></a>核心实现逻辑</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-dist.mk (第 8-14 行)</span></span><br><span class="line"><span class="comment"># Set $(DIST_AS_EZS) to a non-empty value to enable the packaging of</span></span><br><span class="line"><span class="comment"># plugins as .ez archives.</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(USE_RABBIT_BOOT_SCRIPT)</span>,)</span><br><span class="line">DIST_AS_EZS ?=                    <span class="comment"># 默认为空（目录格式）</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">DIST_AS_EZS =                     <span class="comment"># 强制目录格式</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<h4 id="EZ-文件生成过程"><a href="#EZ-文件生成过程" class="headerlink" title="EZ 文件生成过程"></a>EZ 文件生成过程</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">make dist DIST_AS_EZS<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">  ↓</span><br><span class="line">编译所有模块</span><br><span class="line">  ↓</span><br><span class="line">收集 ebin<span class="symbol">/</span> include<span class="symbol">/</span> priv<span class="symbol">/</span></span><br><span class="line">  ↓</span><br><span class="line">创建临时目录结构</span><br><span class="line">  ↓</span><br><span class="line">ZIP 压缩</span><br><span class="line">  ↓</span><br><span class="line">重命名为 .ez</span><br><span class="line">  ↓</span><br><span class="line">移动到 plugins<span class="operator">/</span></span><br></pre></td></tr></table></figure>

<h3 id="实际生成的-EZ-文件"><a href="#实际生成的-EZ-文件" class="headerlink" title="实际生成的 EZ 文件"></a>实际生成的 EZ 文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">plugins/</span><br><span class="line">├── rabbit-4.0.5.ez              <span class="comment"># 3.38 MB - 核心模块</span></span><br><span class="line">├── rabbit_common-4.0.5.ez       <span class="comment"># 770.91 KB - 公共模块  </span></span><br><span class="line">├── rabbitmq_management-4.0.5.ez <span class="comment"># 管理界面插件</span></span><br><span class="line">├── rabbitmq_prometheus-4.0.5.ez <span class="comment"># 监控插件</span></span><br><span class="line">├── amqp_client-4.0.5.ez         <span class="comment"># AMQP 客户端</span></span><br><span class="line">└── ...                          <span class="comment"># 其他插件 EZ 文件</span></span><br></pre></td></tr></table></figure>

<h3 id="EZ-文件内部结构"><a href="#EZ-文件内部结构" class="headerlink" title="EZ 文件内部结构"></a>EZ 文件内部结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EZ 文件实际上是 ZIP 格式</span></span><br><span class="line">$ unzip -l rabbit-4.0.5.ez</span><br><span class="line">Archive:  rabbit-4.0.5.ez</span><br><span class="line">  Length      Date    Time    Name</span><br><span class="line">---------  ---------- -----   ----</span><br><span class="line">     1234  2025-01-16 22:05   rabbit-4.0.5/ebin/rabbit.app</span><br><span class="line">    45678  2025-01-16 22:05   rabbit-4.0.5/ebin/rabbit.beam</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<h3 id="EZ-格式优势"><a href="#EZ-格式优势" class="headerlink" title="EZ 格式优势"></a>EZ 格式优势</h3><ol>
<li><strong>压缩存储</strong>: 减少磁盘占用和网络传输</li>
<li><strong>原子性</strong>: 单文件部署，避免部分文件丢失</li>
<li><strong>版本管理</strong>: 文件名包含版本信息</li>
<li><strong>热加载</strong>: Erlang VM 原生支持 EZ 文件热加载</li>
</ol>
<hr>
<h2 id="4-make-package-generic-unix-通用-Unix-包"><a href="#4-make-package-generic-unix-通用-Unix-包" class="headerlink" title="4. make package-generic-unix - 通用 Unix 包"></a>4. <code>make package-generic-unix</code> - 通用 Unix 包</h2><h3 id="技术原理-3"><a href="#技术原理-3" class="headerlink" title="技术原理"></a>技术原理</h3><p>创建跨平台的 tar.xz 安装包，包含完整的 RabbitMQ 运行环境。</p>
<h4 id="核心实现源码-1"><a href="#核心实现源码-1" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：packaging/generic-unix/Makefile (第 33-76 行)</span></span><br><span class="line">SOURCE_DIR = rabbitmq-server-<span class="variable">$(VERSION)</span></span><br><span class="line">TARGET_DIR = rabbitmq_server-<span class="variable">$(VERSION)</span></span><br><span class="line">TARGET_TARBALL = rabbitmq-server-<span class="variable">$(TARBALL_SUFFIX)</span>-<span class="variable">$(VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="section">dist:</span></span><br><span class="line">  <span class="comment"># 解压源码包</span></span><br><span class="line">  xzcat <span class="variable">$(SOURCE_DIST_FILE)</span> | tar -xf -</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 编译并安装到目标目录</span></span><br><span class="line">  <span class="variable">$(MAKE)</span> -C <span class="variable">$(SOURCE_DIR)</span> \</span><br><span class="line">    PREFIX= RMQ_ROOTDIR= \</span><br><span class="line">    RMQ_ERLAPP_DIR=`pwd`/<span class="variable">$(TARGET_DIR)</span> \</span><br><span class="line">    MANDIR=`pwd`/<span class="variable">$(TARGET_DIR)</span>/share/man \</span><br><span class="line">    manpages web-manpages install install-man</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 修改配置文件</span></span><br><span class="line">  sed -e &#x27;s:^SYS_PREFIX=$$:SYS_PREFIX=\$$&#123;RABBITMQ_HOME&#125;:&#x27; \</span><br><span class="line">        <span class="variable">$(TARGET_DIR)</span>/sbin/rabbitmq-defaults &gt;<span class="variable">$(TARGET_DIR)</span>/sbin/rabbitmq-defaults.tmp</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 创建 tar.xz 包</span></span><br><span class="line">  find <span class="variable">$(TARGET_DIR)</span> | LC_COLLATE=C sort &gt; <span class="variable">$(TARGET_TARBALL)</span>.manifest</span><br><span class="line">  tar --no-recursion -T <span class="variable">$(TARGET_TARBALL)</span>.manifest -cf - | \</span><br><span class="line">  xz &gt; <span class="variable">$(CURDIR)</span>/<span class="variable">$(TARGET_TARBALL)</span>.tar.xz</span><br></pre></td></tr></table></figure>

<h4 id="打包流程-1"><a href="#打包流程-1" class="headerlink" title="打包流程"></a>打包流程</h4><ol>
<li><strong>解压源码包</strong> - 从 tar.xz 源码包开始</li>
<li><strong>编译安装</strong> - 使用标准 Unix 安装路径</li>
<li><strong>生成文档</strong> - 创建 man 手册页</li>
<li><strong>配置脚本</strong> - 调整启动脚本的路径变量</li>
<li><strong>创建归档</strong> - 打包成 tar.xz 格式</li>
</ol>
<h3 id="生成的包结构"><a href="#生成的包结构" class="headerlink" title="生成的包结构"></a>生成的包结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实际生成：PACKAGES/</span></span><br><span class="line">PACKAGES/</span><br><span class="line">├── rabbitmq-server-4.0.5.tar.xz           <span class="comment"># 4.95 MB - 源码包</span></span><br><span class="line">├── rabbitmq-server-generic-unix-4.0.5.tar.xz  <span class="comment"># 15.51 MB - 通用包</span></span><br><span class="line">├── rabbitmq-server-4.0.5.manifest         <span class="comment"># 230.22 KB - 文件清单</span></span><br><span class="line">└── rabbitmq-server-4.0.5/                 <span class="comment"># 解压后的源码目录</span></span><br></pre></td></tr></table></figure>

<h3 id="通用包内容分析"><a href="#通用包内容分析" class="headerlink" title="通用包内容分析"></a>通用包内容分析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压通用包后的目录结构</span></span><br><span class="line">rabbitmq_server-4.0.5/</span><br><span class="line">├── sbin/                        <span class="comment"># 启动脚本</span></span><br><span class="line">│   ├── rabbitmq-server         <span class="comment"># 已配置 RABBITMQ_HOME</span></span><br><span class="line">│   ├── rabbitmqctl</span><br><span class="line">│   └── ...</span><br><span class="line">├── plugins/                     <span class="comment"># 插件目录</span></span><br><span class="line">├── etc/rabbitmq/               <span class="comment"># 配置目录</span></span><br><span class="line">├── share/man/                  <span class="comment"># 手册页</span></span><br><span class="line">└── escript/                    <span class="comment"># CLI 工具</span></span><br></pre></td></tr></table></figure>

<h3 id="通用包特点"><a href="#通用包特点" class="headerlink" title="通用包特点"></a>通用包特点</h3><ol>
<li><strong>自包含</strong>: 包含所有运行时依赖</li>
<li><strong>可移植</strong>: 适用于各种 Unix 系统</li>
<li><strong>标准化</strong>: 遵循 Unix 目录结构规范</li>
<li><strong>生产就绪</strong>: 包含完整的配置和文档</li>
</ol>
<hr>
<h2 id="5-make-install-系统级安装"><a href="#5-make-install-系统级安装" class="headerlink" title="5. make install - 系统级安装"></a>5. <code>make install</code> - 系统级安装</h2><h3 id="技术原理-4"><a href="#技术原理-4" class="headerlink" title="技术原理"></a>技术原理</h3><p>将 RabbitMQ 安装到系统标准目录，遵循 FHS (Filesystem Hierarchy Standard)。</p>
<h4 id="核心实现逻辑-1"><a href="#核心实现逻辑-1" class="headerlink" title="核心实现逻辑"></a>核心实现逻辑</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile 第 489-523 行</span></span><br><span class="line">PREFIX ?= /usr/local</span><br><span class="line">RMQ_ROOTDIR ?= <span class="variable">$(PREFIX)</span>/lib/erlang</span><br><span class="line">RMQ_BINDIR ?= <span class="variable">$(RMQ_ROOTDIR)</span>/bin</span><br><span class="line">RMQ_LIBDIR ?= <span class="variable">$(RMQ_ROOTDIR)</span>/lib</span><br><span class="line">RMQ_ERLAPP_DIR ?= <span class="variable">$(RMQ_LIBDIR)</span>/rabbitmq_server-<span class="variable">$(PROJECT_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="section">install: install-erlapp install-scripts</span></span><br><span class="line"></span><br><span class="line"><span class="section">install-erlapp: dist</span></span><br><span class="line">  <span class="variable">$(verbose)</span> mkdir -p <span class="variable">$(DESTDIR)</span><span class="variable">$(RMQ_ERLAPP_DIR)</span></span><br><span class="line">  <span class="variable">$(inst_verbose)</span> cp -r \</span><br><span class="line">    LICENSE* \</span><br><span class="line">    <span class="variable">$(DEPS_DIR)</span>/rabbit/INSTALL \</span><br><span class="line">    <span class="variable">$(DIST_DIR)</span> \</span><br><span class="line">    <span class="variable">$(DESTDIR)</span><span class="variable">$(RMQ_ERLAPP_DIR)</span></span><br></pre></td></tr></table></figure>

<h3 id="系统安装目录结构"><a href="#系统安装目录结构" class="headerlink" title="系统安装目录结构"></a>系统安装目录结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 典型的系统安装路径</span></span><br><span class="line">/usr/local/</span><br><span class="line">├── bin/                         <span class="comment"># 可执行文件</span></span><br><span class="line">│   ├── rabbitmq-server</span><br><span class="line">│   ├── rabbitmqctl</span><br><span class="line">│   └── ...</span><br><span class="line">├── lib/                         <span class="comment"># 库文件</span></span><br><span class="line">│   └── erlang/lib/</span><br><span class="line">│       └── rabbitmq_server-4.0.5/</span><br><span class="line">│           ├── ebin/           <span class="comment"># 字节码文件</span></span><br><span class="line">│           ├── include/        <span class="comment"># 头文件</span></span><br><span class="line">│           └── plugins/        <span class="comment"># 插件目录</span></span><br><span class="line">├── etc/                        <span class="comment"># 配置文件</span></span><br><span class="line">│   └── rabbitmq/</span><br><span class="line">│       └── rabbitmq.conf</span><br><span class="line">├── var/                        <span class="comment"># 数据目录</span></span><br><span class="line">│   ├── <span class="built_in">log</span>/rabbitmq/          <span class="comment"># 日志</span></span><br><span class="line">│   └── lib/rabbitmq/          <span class="comment"># 数据库</span></span><br><span class="line">└── share/                      <span class="comment"># 文档</span></span><br><span class="line">    └── man/                    <span class="comment"># 手册页</span></span><br></pre></td></tr></table></figure>

<h3 id="安装组件"><a href="#安装组件" class="headerlink" title="安装组件"></a>安装组件</h3><ol>
<li><strong>核心应用</strong> (<code>install-erlapp</code>)</li>
<li><strong>启动脚本</strong> (<code>install-scripts</code>)</li>
<li><strong>命令行工具</strong> (<code>install-bin</code>)</li>
<li><strong>手册页</strong> (<code>install-man</code>)</li>
</ol>
<h3 id="系统安装优势"><a href="#系统安装优势" class="headerlink" title="系统安装优势"></a>系统安装优势</h3><ol>
<li><strong>标准化</strong>: 遵循 Unix 标准目录结构</li>
<li><strong>多用户</strong>: 支持系统级多用户访问</li>
<li><strong>服务集成</strong>: 便于集成到系统服务管理</li>
<li><strong>权限管理</strong>: 利用系统权限控制</li>
</ol>
<hr>
<h2 id="构建系统架构"><a href="#构建系统架构" class="headerlink" title="构建系统架构"></a>构建系统架构</h2><h3 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h3><h4 id="1-erlang-mk"><a href="#1-erlang-mk" class="headerlink" title="1. erlang.mk"></a>1. <strong>erlang.mk</strong></h4><ul>
<li><strong>作用</strong>: Erlang 项目的标准构建工具</li>
<li><strong>功能</strong>: 依赖管理、编译、测试、发布</li>
</ul>
<h4 id="2-rabbitmq-components-mk"><a href="#2-rabbitmq-components-mk" class="headerlink" title="2. rabbitmq-components.mk"></a>2. <strong>rabbitmq-components.mk</strong></h4><ul>
<li><strong>作用</strong>: RabbitMQ 特定的构建规则</li>
<li><strong>功能</strong>: 版本管理、插件系统、发布流程</li>
</ul>
<h4 id="3-rabbitmq-dist-mk"><a href="#3-rabbitmq-dist-mk" class="headerlink" title="3. rabbitmq-dist.mk"></a>3. <strong>rabbitmq-dist.mk</strong></h4><ul>
<li><strong>作用</strong>: 插件分发机制</li>
<li><strong>功能</strong>: EZ 打包、插件依赖、版本控制</li>
</ul>
<h3 id="关键配置文件"><a href="#关键配置文件" class="headerlink" title="关键配置文件"></a>关键配置文件</h3><h4 id="Makefile-主控制文件"><a href="#Makefile-主控制文件" class="headerlink" title="Makefile - 主控制文件"></a>Makefile - 主控制文件</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile (第 1-30 行)</span></span><br><span class="line">PROJECT = rabbitmq_server_release</span><br><span class="line">PROJECT_DESCRIPTION = RabbitMQ Server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件列表</span></span><br><span class="line"><span class="keyword">include</span> plugins.mk</span><br><span class="line">DEPS = rabbit_common rabbit <span class="variable">$(PLUGINS)</span> <span class="variable">$(ADDITIONAL_PLUGINS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建系统</span></span><br><span class="line"><span class="keyword">include</span> rabbitmq-components.mk</span><br><span class="line"><span class="keyword">include</span> erlang.mk</span><br></pre></td></tr></table></figure>

<h4 id="plugins-mk-插件定义"><a href="#plugins-mk-插件定义" class="headerlink" title="plugins.mk - 插件定义"></a>plugins.mk - 插件定义</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 来源：plugins.mk</span></span><br><span class="line">PLUGINS = \</span><br><span class="line">  rabbitmq_amqp1_0 \</span><br><span class="line">  rabbitmq_auth_backend_cache \</span><br><span class="line">  rabbitmq_auth_backend_http \</span><br><span class="line">  rabbitmq_auth_backend_ldap \</span><br><span class="line">  rabbitmq_auth_backend_oauth2 \</span><br><span class="line">  rabbitmq_auth_mechanism_ssl \</span><br><span class="line">  rabbitmq_consistent_hash_exchange \</span><br><span class="line">  <span class="comment"># ... 更多插件</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="编译流程对比"><a href="#编译流程对比" class="headerlink" title="编译流程对比"></a>编译流程对比</h2><h3 id="性能和资源对比"><a href="#性能和资源对比" class="headerlink" title="性能和资源对比"></a>性能和资源对比</h3><table>
<thead>
<tr>
<th>编译方式</th>
<th>编译时间</th>
<th>磁盘占用</th>
<th>内存使用</th>
<th>网络传输</th>
</tr>
</thead>
<tbody><tr>
<td><code>make</code></td>
<td>最快</td>
<td>中等</td>
<td>低</td>
<td>不适用</td>
</tr>
<tr>
<td><code>make dist</code></td>
<td>快</td>
<td>大</td>
<td>中等</td>
<td>大</td>
</tr>
<tr>
<td><code>make dist DIST_AS_EZS=true</code></td>
<td>中等</td>
<td>小</td>
<td>中等</td>
<td>小</td>
</tr>
<tr>
<td><code>make package-generic-unix</code></td>
<td>慢</td>
<td>最小</td>
<td>高</td>
<td>最小</td>
</tr>
<tr>
<td><code>make install</code></td>
<td>中等</td>
<td>中等</td>
<td>低</td>
<td>不适用</td>
</tr>
</tbody></table>
<hr>
<h2 id="最佳实践指南"><a href="#最佳实践指南" class="headerlink" title="最佳实践指南"></a>最佳实践指南</h2><h3 id="开发阶段"><a href="#开发阶段" class="headerlink" title="开发阶段"></a>开发阶段</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 快速开发迭代</span></span><br><span class="line">make clean &amp;&amp; make</span><br><span class="line">sbin/rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件开发</span></span><br><span class="line">make dist</span><br><span class="line"><span class="comment"># 测试插件加载</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发调试</span></span><br><span class="line">make shell</span><br></pre></td></tr></table></figure>

<h3 id="测试阶段"><a href="#测试阶段" class="headerlink" title="测试阶段"></a>测试阶段</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 完整功能测试</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 验证 EZ 文件加载</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集成测试</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 在不同环境测试安装包</span></span><br></pre></td></tr></table></figure>

<h3 id="生产部署"><a href="#生产部署" class="headerlink" title="生产部署"></a>生产部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 容器化部署</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 使用 tar.xz 包构建 Docker 镜像</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 传统服务器部署  </span></span><br><span class="line">make install PREFIX=/opt/rabbitmq</span><br><span class="line"><span class="comment"># 系统级安装</span></span><br></pre></td></tr></table></figure>

<h3 id="插件分发"><a href="#插件分发" class="headerlink" title="插件分发"></a>插件分发</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 插件开发者</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 生成 .ez 文件用于分发</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件用户</span></span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> plugin_name</span><br><span class="line"><span class="comment"># 从 .ez 文件安装插件</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="高级配置选项"><a href="#高级配置选项" class="headerlink" title="高级配置选项"></a>高级配置选项</h2><h3 id="环境变量控制"><a href="#环境变量控制" class="headerlink" title="环境变量控制"></a>环境变量控制</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义插件目录</span></span><br><span class="line"><span class="built_in">export</span> DIST_DIR=/custom/plugins/path</span><br><span class="line">make dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义包输出目录</span></span><br><span class="line"><span class="built_in">export</span> PACKAGES_DIR=/custom/packages/path  </span><br><span class="line">make package-generic-unix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用社区插件</span></span><br><span class="line"><span class="built_in">export</span> COMMUNITY_PLUGINS=1</span><br><span class="line">make dist</span><br></pre></td></tr></table></figure>

<h3 id="编译优化"><a href="#编译优化" class="headerlink" title="编译优化"></a>编译优化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 并行编译</span></span><br><span class="line">make -j$(<span class="built_in">nproc</span>) dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 详细输出</span></span><br><span class="line">make V=1 dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 跳过测试</span></span><br><span class="line">make SKIP_TESTS=1 dist</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="源码关键文件索引"><a href="#源码关键文件索引" class="headerlink" title="源码关键文件索引"></a>源码关键文件索引</h2><table>
<thead>
<tr>
<th>文件</th>
<th>作用</th>
<th>关键内容</th>
</tr>
</thead>
<tbody><tr>
<td><code>Makefile</code></td>
<td>主构建文件</td>
<td>目标定义、变量设置</td>
</tr>
<tr>
<td><code>erlang.mk</code></td>
<td>Erlang 构建系统</td>
<td>编译规则、依赖管理</td>
</tr>
<tr>
<td><code>rabbitmq-components.mk</code></td>
<td>RabbitMQ 构建规则</td>
<td>版本控制、组件管理</td>
</tr>
<tr>
<td><code>deps/rabbit_common/mk/rabbitmq-dist.mk</code></td>
<td>分发系统</td>
<td>插件打包、EZ 格式</td>
</tr>
<tr>
<td><code>packaging/generic-unix/Makefile</code></td>
<td>Unix 打包</td>
<td>安装布局、脚本配置</td>
</tr>
<tr>
<td><code>plugins.mk</code></td>
<td>插件列表</td>
<td>所有官方插件定义</td>
</tr>
</tbody></table>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>RabbitMQ 的构建系统设计精良，通过不同的编译命令满足了从开发到生产的各种需求：</p>
<ol>
<li><strong><code>make</code></strong> - 开发基础，快速迭代</li>
<li><strong><code>make dist</code></strong> - 生产标准，目录部署  </li>
<li><strong><code>make dist DIST_AS_EZS=true</code></strong> - 插件分发，压缩高效</li>
<li><strong><code>make package-generic-unix</code></strong> - 跨平台部署，自包含</li>
<li><strong><code>make install</code></strong> - 系统集成，标准化安装</li>
</ol>
<p>理解这些编译方式的原理，有助于更好地进行 RabbitMQ 的开发、部署和运维工作。选择合适的编译方式，能够显著提升 RabbitMQ 的开发效率和部署质量。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/16/rabbitmq-rabbitmq-plugins-enable-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/16/rabbitmq-rabbitmq-plugins-enable-guide/" class="post-title-link" itemprop="url">RabbitMQ 插件启用问题排查指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-16 21:00:00 / 修改时间：21:59:04" itemprop="dateCreated datePublished" datetime="2026-01-16T21:00:00+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RabbitMQ-插件启用问题排查指南"><a href="#RabbitMQ-插件启用问题排查指南" class="headerlink" title="RabbitMQ 插件启用问题排查指南"></a>RabbitMQ 插件启用问题排查指南</h1><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>从源码编译运行 RabbitMQ 时，执行插件启用命令报错：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sbin/rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</span><br><span class="line">Error: :plugins_dir_does_not_exist</span><br><span class="line">Arguments given:</span><br><span class="line">        <span class="built_in">enable</span> rabbitmq_management</span><br><span class="line"></span><br><span class="line">Usage</span><br><span class="line"></span><br><span class="line">rabbitmq-plugins [--node &lt;node&gt;] [--longnames] [--quiet] <span class="built_in">enable</span> &lt;plugin1&gt; [ &lt;plugin2&gt;] | --all [--offline] [--online]</span><br></pre></td></tr></table></figure>

<p>即使设置了 <code>ERL_LIBS</code> 环境变量也无法解决：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="variable">$ERL_LIBS</span></span><br><span class="line">/Users/ericksun/workspace/rabbitmq-server/plugins</span><br></pre></td></tr></table></figure>

<h2 id="根因分析"><a href="#根因分析" class="headerlink" title="根因分析"></a>根因分析</h2><h3 id="ERL-LIBS-与-RABBITMQ-PLUGINS-DIR-的区别"><a href="#ERL-LIBS-与-RABBITMQ-PLUGINS-DIR-的区别" class="headerlink" title="ERL_LIBS 与 RABBITMQ_PLUGINS_DIR 的区别"></a>ERL_LIBS 与 RABBITMQ_PLUGINS_DIR 的区别</h3><table>
<thead>
<tr>
<th>环境变量</th>
<th>作用</th>
<th>使用者</th>
</tr>
</thead>
<tbody><tr>
<td><code>ERL_LIBS</code></td>
<td>告诉 Erlang VM 在哪里查找代码模块</td>
<td>Erlang 运行时</td>
</tr>
<tr>
<td><code>RABBITMQ_PLUGINS_DIR</code></td>
<td>告诉 rabbitmq-plugins 脚本插件目录位置</td>
<td>RabbitMQ 脚本</td>
</tr>
<tr>
<td><code>RABBITMQ_ENABLED_PLUGINS_FILE</code></td>
<td>指定启用插件配置文件的位置</td>
<td>RabbitMQ 脚本</td>
</tr>
</tbody></table>
<p><code>ERL_LIBS</code> 只是让 Erlang 能找到代码，但 <code>rabbitmq-plugins</code> 脚本需要 <code>RABBITMQ_PLUGINS_DIR</code> 来定位插件目录。</p>
<h3 id="默认路径问题"><a href="#默认路径问题" class="headerlink" title="默认路径问题"></a>默认路径问题</h3><p>从源码运行时，RabbitMQ 默认查找：</p>
<ul>
<li>插件目录：由 <code>RABBITMQ_HOME/plugins</code> 或 <code>RABBITMQ_PLUGINS_DIR</code> 指定</li>
<li>启用插件文件：<code>/etc/rabbitmq/enabled_plugins</code>（系统路径，源码环境下不存在）</li>
</ul>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="方案一：设置环境变量（推荐）"><a href="#方案一：设置环境变量（推荐）" class="headerlink" title="方案一：设置环境变量（推荐）"></a>方案一：设置环境变量（推荐）</h3><p>在 shell 配置文件（如 <code>~/.bashrc</code> 或 <code>~/.zshrc</code>）中添加：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RabbitMQ 源码开发环境配置</span></span><br><span class="line"><span class="built_in">export</span> RABBITMQ_HOME=/path/to/rabbitmq-server</span><br><span class="line"><span class="built_in">export</span> RABBITMQ_PLUGINS_DIR=<span class="variable">$RABBITMQ_HOME</span>/plugins</span><br><span class="line"><span class="built_in">export</span> RABBITMQ_ENABLED_PLUGINS_FILE=<span class="variable">$RABBITMQ_HOME</span>/etc/rabbitmq/enabled_plugins</span><br></pre></td></tr></table></figure>

<p>然后创建必要的目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$RABBITMQ_HOME</span>/etc/rabbitmq</span><br></pre></td></tr></table></figure>

<h3 id="方案二：命令行指定（临时使用）"><a href="#方案二：命令行指定（临时使用）" class="headerlink" title="方案二：命令行指定（临时使用）"></a>方案二：命令行指定（临时使用）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /path/to/rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建配置目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p etc/rabbitmq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用插件（使用 --offline 模式，不需要连接运行中的节点）</span></span><br><span class="line">RABBITMQ_PLUGINS_DIR=$(<span class="built_in">pwd</span>)/plugins \</span><br><span class="line">RABBITMQ_ENABLED_PLUGINS_FILE=$(<span class="built_in">pwd</span>)/etc/rabbitmq/enabled_plugins \</span><br><span class="line">sbin/rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management --offline</span><br></pre></td></tr></table></figure>

<h3 id="方案三：使用-make-命令"><a href="#方案三：使用-make-命令" class="headerlink" title="方案三：使用 make 命令"></a>方案三：使用 make 命令</h3><p>RabbitMQ 源码提供了便捷的 make 目标：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动带管理插件的开发节点</span></span><br><span class="line">make run-broker RABBITMQ_ENABLED_PLUGINS=<span class="string">&quot;rabbitmq_management&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="成功执行示例"><a href="#成功执行示例" class="headerlink" title="成功执行示例"></a>成功执行示例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ RABBITMQ_PLUGINS_DIR=$(<span class="built_in">pwd</span>)/plugins \</span><br><span class="line">  RABBITMQ_ENABLED_PLUGINS_FILE=$(<span class="built_in">pwd</span>)/etc/rabbitmq/enabled_plugins \</span><br><span class="line">  sbin/rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management --offline</span><br><span class="line"></span><br><span class="line">Enabling plugins on node rabbit@ERICKSUN-MC1:</span><br><span class="line">rabbitmq_management</span><br><span class="line"></span><br><span class="line">The following plugins have been configured:</span><br><span class="line">  rabbitmq_management</span><br><span class="line">  rabbitmq_management_agent</span><br><span class="line">  rabbitmq_web_dispatch</span><br><span class="line">Applying plugin configuration to rabbit@ERICKSUN-MC1...</span><br><span class="line">The following plugins have been enabled:</span><br><span class="line">  rabbitmq_management</span><br><span class="line">  rabbitmq_management_agent</span><br><span class="line">  rabbitmq_web_dispatch</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> 3 plugins.</span><br><span class="line">Offline change; changes will take effect at broker restart.</span><br></pre></td></tr></table></figure>

<h2 id="常用插件命令"><a href="#常用插件命令" class="headerlink" title="常用插件命令"></a>常用插件命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置环境变量（假设已在 rabbitmq-server 目录）</span></span><br><span class="line"><span class="built_in">export</span> RABBITMQ_PLUGINS_DIR=$(<span class="built_in">pwd</span>)/plugins</span><br><span class="line"><span class="built_in">export</span> RABBITMQ_ENABLED_PLUGINS_FILE=$(<span class="built_in">pwd</span>)/etc/rabbitmq/enabled_plugins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有可用插件</span></span><br><span class="line">sbin/rabbitmq-plugins list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出已启用的插件</span></span><br><span class="line">sbin/rabbitmq-plugins list --enabled</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用插件（离线模式）</span></span><br><span class="line">sbin/rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management --offline</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用插件</span></span><br><span class="line">sbin/rabbitmq-plugins <span class="built_in">disable</span> rabbitmq_management --offline</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用多个插件</span></span><br><span class="line">sbin/rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management rabbitmq_shovel --offline</span><br></pre></td></tr></table></figure>

<h2 id="常见插件说明"><a href="#常见插件说明" class="headerlink" title="常见插件说明"></a>常见插件说明</h2><table>
<thead>
<tr>
<th>插件名称</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>rabbitmq_management</code></td>
<td>Web 管理界面，默认端口 15672</td>
</tr>
<tr>
<td><code>rabbitmq_management_agent</code></td>
<td>管理插件的代理（自动依赖）</td>
</tr>
<tr>
<td><code>rabbitmq_web_dispatch</code></td>
<td>Web 请求分发（自动依赖）</td>
</tr>
<tr>
<td><code>rabbitmq_shovel</code></td>
<td>消息转发&#x2F;复制</td>
</tr>
<tr>
<td><code>rabbitmq_federation</code></td>
<td>跨集群消息联邦</td>
</tr>
<tr>
<td><code>rabbitmq_mqtt</code></td>
<td>MQTT 协议支持</td>
</tr>
<tr>
<td><code>rabbitmq_stomp</code></td>
<td>STOMP 协议支持</td>
</tr>
</tbody></table>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>从源码运行 RabbitMQ 时，需要正确设置以下环境变量：</p>
<ol>
<li><strong><code>RABBITMQ_PLUGINS_DIR</code></strong> - 指向 <code>plugins</code> 目录</li>
<li><strong><code>RABBITMQ_ENABLED_PLUGINS_FILE</code></strong> - 指向本地的 <code>enabled_plugins</code> 文件</li>
</ol>
<p><code>ERL_LIBS</code> 环境变量只影响 Erlang 代码加载路径，不能替代 RabbitMQ 自身的配置变量。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/16/rabbitmq-rabbitmq-final-solution-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/16/rabbitmq-rabbitmq-final-solution-summary/" class="post-title-link" itemprop="url">RabbitMQ 问题最终解决方案总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-16 16:00:00 / 修改时间：20:55:17" itemprop="dateCreated datePublished" datetime="2026-01-16T16:00:00+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RabbitMQ-问题最终解决方案总结"><a href="#RabbitMQ-问题最终解决方案总结" class="headerlink" title="RabbitMQ 问题最终解决方案总结"></a>RabbitMQ 问题最终解决方案总结</h1><h2 id="真正的根本原因：网络配置问题"><a href="#真正的根本原因：网络配置问题" class="headerlink" title="真正的根本原因：网络配置问题"></a>真正的根本原因：网络配置问题</h2><h3 id="问题真相"><a href="#问题真相" class="headerlink" title="问题真相"></a>问题真相</h3><p>经过深入调试，发现问题的<strong>真正根本原因</strong>是 <strong>hosts 文件配置错误</strong>：</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2026/01/16/rabbitmq-rabbitmq-final-solution-summary/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/16/rabbitmq-rabbitmq-build-issue-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/16/rabbitmq-rabbitmq-build-issue-analysis/" class="post-title-link" itemprop="url">RabbitMQ 构建问题分析与社区补丁提案</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-16 14:30:00 / 修改时间：15:23:13" itemprop="dateCreated datePublished" datetime="2026-01-16T14:30:00+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RabbitMQ-Build-Issue-Analysis-Community-Patch-Proposal"><a href="#RabbitMQ-Build-Issue-Analysis-Community-Patch-Proposal" class="headerlink" title="RabbitMQ Build Issue Analysis &amp; Community Patch Proposal"></a>RabbitMQ Build Issue Analysis &amp; Community Patch Proposal</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在构建 RabbitMQ 4.1.0+beta.3 的 Generic Unix 包时，遇到了一个关键的构建错误。本文档详细分析了问题原因、解决方案，并提出了向社区贡献补丁的建议。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2026/01/16/rabbitmq-rabbitmq-build-issue-analysis/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/16/rabbitmq-rabbitmq-compilation-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/16/rabbitmq-rabbitmq-compilation-guide/" class="post-title-link" itemprop="url">RabbitMQ 服务器编译指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-16 14:00:00 / 修改时间：15:17:51" itemprop="dateCreated datePublished" datetime="2026-01-16T14:00:00+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RabbitMQ-服务器编译指南"><a href="#RabbitMQ-服务器编译指南" class="headerlink" title="RabbitMQ 服务器编译指南"></a>RabbitMQ 服务器编译指南</h1><p>本文档记录了在 macOS (Apple Silicon) 环境下编译 RabbitMQ 服务器的完整过程，包括遇到的问题和解决方案。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2026/01/16/rabbitmq-rabbitmq-compilation-guide/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2024 – 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Zixiang Sun</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"hzsunzixiang/hzsunzixiang.github.io","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js" defer></script>

</body>
</html>
