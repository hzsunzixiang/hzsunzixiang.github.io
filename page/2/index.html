<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.svg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.svg">
  <link rel="mask-icon" href="/images/favicon.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Noto+Serif+SC:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Source+Code+Pro:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hzsunzixiang.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"default","show_result":true},"fold":{"enable":false,"height":500},"language":false,"highlight_theme":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":true,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
<meta property="og:type" content="website">
<meta property="og:title" content="Zixiang Sun&#39;s Blog">
<meta property="og:url" content="https://hzsunzixiang.github.io/page/2/">
<meta property="og:site_name" content="Zixiang Sun&#39;s Blog">
<meta property="og:description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Zixiang Sun">
<meta property="article:tag" content="CRAQ">
<meta property="article:tag" content="blog">
<meta property="article:tag" content="development">
<meta property="article:tag" content="distributed systems">
<meta property="article:tag" content="programming">
<meta property="article:tag" content="technology">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://hzsunzixiang.github.io/page/2/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Zixiang Sun's Blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Zixiang Sun's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Zixiang Sun's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Sharing thoughts on technology, programming, and life</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">17</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">9</span></a></li><li class="menu-item menu-item-erlang"><a href="/erlang/" rel="section"><i class="fa fa-code fa-fw"></i>Erlang</a></li><li class="menu-item menu-item-rabbitmq"><a href="/rabbitmq/" rel="section"><i class="fa fa-server fa-fw"></i>RabbitMQ</a></li><li class="menu-item menu-item-craq"><a href="/craq/" rel="section"><i class="fa fa-book fa-fw"></i>CRAQ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zixiang Sun"
      src="/images/avatar.svg">
  <p class="site-author-name" itemprop="name">Zixiang Sun</p>
  <div class="site-description" itemprop="description">Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hzsunzixiang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hzsunzixiang" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:17842379@qq.com" title="E-Mail → mailto:17842379@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/16/erlang-erlang-links-and-monitors-cn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/16/erlang-erlang-links-and-monitors-cn/" class="post-title-link" itemprop="url">Erlang 进程链接与监视器（中文版）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-16 10:30:00 / 修改时间：12:38:09" itemprop="dateCreated datePublished" datetime="2026-01-16T10:30:00+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/Erlang/" itemprop="url" rel="index"><span itemprop="name">Erlang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="用于监督的链接和监视器"><a href="#用于监督的链接和监视器" class="headerlink" title="用于监督的链接和监视器"></a>用于监督的链接和监视器</h1><p>当进程相互依赖时，我们基本上有两种选择：让它们同生共死，或者让一个进程在另一个进程崩溃时得到通知。第三章讨论的 Erlang “任其崩溃”哲学，使我们倾向于后一种选择。</p>
<p>链接的进程形成一个组，默认情况下会一起崩溃。如果其中一个链接的进程异常退出，其组中的所有其他进程都会收到 <code>EXIT</code> 信号并一起崩溃。监视器允许一个进程监视另一个进程，而不会自动被耦合到同一个组中。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2026/01/16/erlang-erlang-links-and-monitors-cn/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/16/erlang-erlang-links-and-monitors/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/16/erlang-erlang-links-and-monitors/" class="post-title-link" itemprop="url">Erlang 进程链接与监视器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2026-01-16 10:00:00 / 修改时间：12:38:09" itemprop="dateCreated datePublished" datetime="2026-01-16T10:00:00+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/Erlang/" itemprop="url" rel="index"><span itemprop="name">Erlang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Links-and-Monitors-for-Supervision"><a href="#Links-and-Monitors-for-Supervision" class="headerlink" title="Links and Monitors for Supervision"></a>Links and Monitors for Supervision</h1><p>When processes depend on each other, we have essentially two choices: to have them live and die together, or to let one process be informed when another one crashes. The “let it fail” philosophy of Erlang, discussed in Chapter 3, leads us to a preference for the latter alternative.</p>
<p>Linked processes form a group that, by default, all crash together. If one of the linked processes exits abnormally, all the other processes in its group get an <code>EXIT</code> signal and crash as well. Monitors allow a process to monitor another process without automatically getting coupled into the same group.</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2026/01/16/erlang-erlang-links-and-monitors/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/16/rabbitmq-rabbitmq-dependencies-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/16/rabbitmq-rabbitmq-dependencies-analysis/" class="post-title-link" itemprop="url">RabbitMQ 依赖模块全面分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-16 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-16T00:00:00+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-18 12:46:24" itemprop="dateModified" datetime="2026-01-18T12:46:24+08:00">2026-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RabbitMQ-依赖模块全面分析"><a href="#RabbitMQ-依赖模块全面分析" class="headerlink" title="RabbitMQ 依赖模块全面分析"></a>RabbitMQ 依赖模块全面分析</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本文档对 RabbitMQ 4.0.5 版本 <code>deps/</code> 目录下的 86 个依赖模块进行全面分析，涵盖每个模块的功能、与 RabbitMQ 核心的交互方式以及在整体架构中的作用。</p>
<h2 id="架构层次概览"><a href="#架构层次概览" class="headerlink" title="架构层次概览"></a>架构层次概览</h2><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                         应用层                               │</span><br><span class="line">│   ┌───────────┐  ┌───────────────┐  ┌─────────┐            │</span><br><span class="line">│   │ 命令行工具 │  │  Web管理界面   │  │ HTTP API│            │</span><br><span class="line">│   └───────────┘  └───────────────┘  └─────────┘            │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                         协议层                               │</span><br><span class="line">│   ┌──────────┐  ┌──────┐  ┌───────┐  ┌────────────────┐   │</span><br><span class="line">│   │AMQP 0<span class="string">-9</span><span class="string">-1</span>│  │ MQTT │  │ STOMP │  │ Stream Protocol│   │</span><br><span class="line">│   │  /1.0    │  │      │  │       │  │                │   │</span><br><span class="line">│   └──────────┘  └──────┘  └───────┘  └────────────────┘   │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                         核心层                               │</span><br><span class="line">│   ┌────────────────┐  ┌───────────────┐  ┌────────────┐   │</span><br><span class="line">│   │ rabbit-核心服务器│  │rabbit_common  │  │amqp_client │   │</span><br><span class="line">│   │                │  │   共享库      │  │   客户端   │   │</span><br><span class="line">│   └────────────────┘  └───────────────┘  └────────────┘   │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                         存储层                               │</span><br><span class="line">│   ┌────────────────┐  ┌───────────────┐  ┌────────────┐   │</span><br><span class="line">│   │ ra-Raft一致性  │  │osiris-日志存储 │  │khepri-树形 │   │</span><br><span class="line">│   │                │  │               │  │  数据库    │   │</span><br><span class="line">│   └────────────────┘  └───────────────┘  └────────────┘   │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                         网络层                               │</span><br><span class="line">│   ┌────────────────┐  ┌───────────────┐  ┌────────────┐   │</span><br><span class="line">│   │cowboy-HTTP服务器│  │ ranch-连接池  │  │gun-HTTP客户端│  │</span><br><span class="line">│   └────────────────┘  └───────────────┘  └────────────┘   │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                       基础设施层                             │</span><br><span class="line">│   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │</span><br><span class="line">│   │ 认证授权 │  │ 监控指标 │  │ 集群发现 │  │  工具库  │ │</span><br><span class="line">│   └──────────┘  └──────────┘  └──────────┘  └──────────┘ │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="核心架构模块"><a href="#核心架构模块" class="headerlink" title="核心架构模块"></a>核心架构模块</h2><h3 id="1-rabbit-RabbitMQ-核心服务器"><a href="#1-rabbit-RabbitMQ-核心服务器" class="headerlink" title="1. rabbit - RabbitMQ 核心服务器"></a>1. rabbit - RabbitMQ 核心服务器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbit/</code></li>
<li><strong>主要功能</strong>: <ul>
<li>AMQP 0-9-1, AMQP 1.0, MQTT, STOMP 协议支持</li>
<li>队列管理、交换器路由、权限控制</li>
<li>集群管理、持久化存储、系统监控</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit.erl                    <span class="comment">% 主应用模块</span></span><br><span class="line">src/rabbit_amqqueue.erl          <span class="comment">% 队列管理 (82KB)</span></span><br><span class="line">src/rabbit_exchange.erl          <span class="comment">% 交换器管理</span></span><br><span class="line">src/rabbit_channel.erl           <span class="comment">% 通道管理 (119KB)</span></span><br><span class="line">src/rabbit_reader.erl            <span class="comment">% 协议读取器</span></span><br><span class="line">src/rabbit_networking.erl        <span class="comment">% 网络管理</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 作为整个系统的核心，协调所有其他模块</li>
<li><strong>依赖关系</strong>: 依赖 <code>rabbit_common</code>、<code>ra</code>、<code>osiris</code>、<code>khepri</code> 等核心库</li>
</ul>
<h3 id="2-rabbit-common-共享通用库"><a href="#2-rabbit-common-共享通用库" class="headerlink" title="2. rabbit_common - 共享通用库"></a>2. rabbit_common - 共享通用库</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbit_common/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>AMQP 协议解析和生成</li>
<li>通用数据结构和工具函数</li>
<li>认证和授权基础设施</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit_framing.erl           <span class="comment">% AMQP 帧处理</span></span><br><span class="line">src/rabbit_binary_parser.erl    <span class="comment">% 二进制协议解析</span></span><br><span class="line">src/rabbit_misc.erl              <span class="comment">% 通用工具函数</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 被 <code>rabbit</code> 和 <code>amqp_client</code> 共同使用</li>
<li><strong>依赖关系</strong>: 基础库，被多个模块依赖</li>
</ul>
<h3 id="3-amqp-client-AMQP-客户端库"><a href="#3-amqp-client-AMQP-客户端库" class="headerlink" title="3. amqp_client - AMQP 客户端库"></a>3. amqp_client - AMQP 客户端库</h3><ul>
<li><strong>模块路径</strong>: <code>deps/amqp_client/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>提供连接和通道管理</li>
<li>支持直连和网络连接</li>
<li>RPC 客户端和服务器实现</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">src/amqp_connection.erl          <span class="comment">% 连接管理</span></span><br><span class="line">src/amqp_channel.erl             <span class="comment">% 通道管理</span></span><br><span class="line">src/amqp_direct_connection.erl   <span class="comment">% 直连实现</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 用于内部组件间通信和外部客户端连接</li>
<li><strong>依赖关系</strong>: 依赖 <code>rabbit_common</code></li>
</ul>
<hr>
<h2 id="分布式存储和一致性模块"><a href="#分布式存储和一致性模块" class="headerlink" title="分布式存储和一致性模块"></a>分布式存储和一致性模块</h2><h3 id="4-ra-Raft-一致性算法实现"><a href="#4-ra-Raft-一致性算法实现" class="headerlink" title="4. ra - Raft 一致性算法实现"></a>4. ra - Raft 一致性算法实现</h3><ul>
<li><strong>模块路径</strong>: <code>deps/ra/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>领导者选举、日志复制</li>
<li>集群成员变更、日志压缩</li>
<li>快照安装和恢复</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">src/ra.erl                       <span class="comment">% 主 API 模块</span></span><br><span class="line">src/ra_server.erl                <span class="comment">% Raft 服务器 (3,348 行)</span></span><br><span class="line">src/ra_machine.erl               <span class="comment">% 状态机行为定义</span></span><br><span class="line">src/ra_log.erl                   <span class="comment">% 日志管理</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 为仲裁队列和流提供一致性保证</li>
<li><strong>依赖关系</strong>: 依赖 <code>aten</code>、<code>gen_batch_server</code>、<code>seshat</code></li>
<li><strong>性能特点</strong>: 高吞吐量、低延迟的一致性保证</li>
</ul>
<h3 id="5-osiris-日志流存储基础"><a href="#5-osiris-日志流存储基础" class="headerlink" title="5. osiris - 日志流存储基础"></a>5. osiris - 日志流存储基础</h3><ul>
<li><strong>模块路径</strong>: <code>deps/osiris/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>高性能日志存储</li>
<li>支持流式数据处理</li>
<li>为 RabbitMQ 流功能提供底层支持</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">src/osiris_log.erl               <span class="comment">% 日志管理 (3,243 行)</span></span><br><span class="line">src/osiris_writer.erl            <span class="comment">% 日志写入器</span></span><br><span class="line">src/osiris_reader.erl            <span class="comment">% 日志读取器</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 被 <code>rabbitmq_stream</code> 使用</li>
<li><strong>依赖关系</strong>: 依赖 <code>gen_batch_server</code>、<code>seshat</code></li>
</ul>
<h3 id="6-khepri-树形复制数据库"><a href="#6-khepri-树形复制数据库" class="headerlink" title="6. khepri - 树形复制数据库"></a>6. khepri - 树形复制数据库</h3><ul>
<li><strong>模块路径</strong>: <code>deps/khepri/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>树形数据结构存储</li>
<li>基于 Ra 的一致性保证</li>
<li>事务支持和触发器</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">src/khepri.erl                   <span class="comment">% 主 API (3,839 行)</span></span><br><span class="line">src/khepri_machine.erl           <span class="comment">% Ra 状态机实现</span></span><br><span class="line">src/khepri_tx.erl                <span class="comment">% 事务处理</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 作为 RabbitMQ 元数据存储的现代化替代方案</li>
<li><strong>依赖关系</strong>: 依赖 <code>ra</code>、<code>horus</code></li>
</ul>
<h3 id="7-khepri-mnesia-migration-数据库迁移工具"><a href="#7-khepri-mnesia-migration-数据库迁移工具" class="headerlink" title="7. khepri_mnesia_migration - 数据库迁移工具"></a>7. khepri_mnesia_migration - 数据库迁移工具</h3><ul>
<li><strong>模块路径</strong>: <code>deps/khepri_mnesia_migration/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>集群成员同步</li>
<li>Mnesia 表到 Khepri 的数据迁移</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 帮助 RabbitMQ 从传统存储迁移到现代存储</li>
</ul>
<hr>
<h2 id="协议支持模块"><a href="#协议支持模块" class="headerlink" title="协议支持模块"></a>协议支持模块</h2><h3 id="8-rabbitmq-mqtt-MQTT-协议支持"><a href="#8-rabbitmq-mqtt-MQTT-协议支持" class="headerlink" title="8. rabbitmq_mqtt - MQTT 协议支持"></a>8. rabbitmq_mqtt - MQTT 协议支持</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_mqtt/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>MQTT 3.1.1 协议支持</li>
<li>消息发布&#x2F;订阅、会话管理</li>
<li>保留消息、QoS 级别支持</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit_mqtt_reader.erl       <span class="comment">% MQTT 协议读取器</span></span><br><span class="line">src/rabbit_mqtt_processor.erl    <span class="comment">% 消息处理器</span></span><br><span class="line">src/rabbit_mqtt_retained_msg_store.erl <span class="comment">% 保留消息存储</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 作为协议适配器，将 MQTT 消息转换为 AMQP</li>
<li><strong>默认端口</strong>: 1883 (TCP), 8883 (TLS)</li>
</ul>
<h3 id="9-rabbitmq-stomp-STOMP-协议支持"><a href="#9-rabbitmq-stomp-STOMP-协议支持" class="headerlink" title="9. rabbitmq_stomp - STOMP 协议支持"></a>9. rabbitmq_stomp - STOMP 协议支持</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_stomp/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>STOMP 1.0-1.2 协议支持</li>
<li>简单文本消息协议</li>
<li>支持多种客户端语言</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit_stomp_reader.erl      <span class="comment">% STOMP 协议读取器</span></span><br><span class="line">src/rabbit_stomp_processor.erl   <span class="comment">% 消息处理器</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 协议适配器，转换 STOMP 到 AMQP</li>
<li><strong>默认端口</strong>: 61613 (TCP), 61614 (TLS)</li>
</ul>
<h3 id="10-rabbitmq-stream-流协议支持"><a href="#10-rabbitmq-stream-流协议支持" class="headerlink" title="10. rabbitmq_stream - 流协议支持"></a>10. rabbitmq_stream - 流协议支持</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_stream/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>RabbitMQ 流的自定义二进制协议</li>
<li>高性能流式数据处理</li>
<li>追加式 FIFO 结构</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit_stream_reader.erl     <span class="comment">% 流协议读取器 (3,992 行)</span></span><br><span class="line">src/rabbit_stream_coordinator.erl <span class="comment">% 流协调器</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 基于 <code>osiris</code> 提供流功能</li>
<li><strong>依赖关系</strong>: 依赖 <code>rabbitmq_stream_common</code>、<code>osiris</code></li>
<li><strong>默认端口</strong>: 5552</li>
</ul>
<h3 id="11-amqp10-client-和-amqp10-common-AMQP-1-0-支持"><a href="#11-amqp10-client-和-amqp10-common-AMQP-1-0-支持" class="headerlink" title="11. amqp10_client 和 amqp10_common - AMQP 1.0 支持"></a>11. amqp10_client 和 amqp10_common - AMQP 1.0 支持</h3><ul>
<li><strong>模块路径</strong>: <code>deps/amqp10_client/</code>, <code>deps/amqp10_common/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>AMQP 1.0 协议实现</li>
<li>与 AMQP 0-9-1 的互操作性</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展 RabbitMQ 的协议支持范围</li>
</ul>
<hr>
<h2 id="管理和监控模块"><a href="#管理和监控模块" class="headerlink" title="管理和监控模块"></a>管理和监控模块</h2><h3 id="12-rabbitmq-management-管理控制台"><a href="#12-rabbitmq-management-管理控制台" class="headerlink" title="12. rabbitmq_management - 管理控制台"></a>12. rabbitmq_management - 管理控制台</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_management/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Web UI 管理界面</li>
<li>REST API 接口</li>
<li>统计信息展示、用户管理</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit_mgmt_wm_*.erl         <span class="comment">% Web 管理端点</span></span><br><span class="line">priv/www/                        <span class="comment">% Web 静态文件</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 通过 <code>rabbitmq_management_agent</code> 获取数据</li>
<li><strong>依赖关系</strong>: 依赖 <code>cowboy</code>、<code>rabbitmq_web_dispatch</code></li>
<li><strong>默认端口</strong>: 15672</li>
</ul>
<h3 id="13-rabbitmq-management-agent-管理代理"><a href="#13-rabbitmq-management-agent-管理代理" class="headerlink" title="13. rabbitmq_management_agent - 管理代理"></a>13. rabbitmq_management_agent - 管理代理</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_management_agent/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>统计数据收集</li>
<li>性能指标聚合</li>
<li>为管理界面提供数据源</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 从 <code>rabbit</code> 核心收集数据，提供给管理界面</li>
</ul>
<h3 id="14-rabbitmq-prometheus-Prometheus-监控"><a href="#14-rabbitmq-prometheus-Prometheus-监控" class="headerlink" title="14. rabbitmq_prometheus - Prometheus 监控"></a>14. rabbitmq_prometheus - Prometheus 监控</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_prometheus/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>导出 RabbitMQ 指标到 Prometheus</li>
<li>支持聚合和详细指标</li>
<li>可配置的指标端点</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/prometheus_rabbitmq_core_metrics_collector.erl <span class="comment">% 核心指标收集器</span></span><br></pre></td></tr></table></figure></li>
<li><strong>默认端口</strong>: 15692</li>
<li><strong>端点</strong>: <code>/metrics</code>, <code>/metrics/per-object</code>, <code>/metrics/detailed</code></li>
</ul>
<h3 id="15-rabbitmq-cli-命令行工具"><a href="#15-rabbitmq-cli-命令行工具" class="headerlink" title="15. rabbitmq_cli - 命令行工具"></a>15. rabbitmq_cli - 命令行工具</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_cli/</code></li>
<li><strong>主要功能</strong>:<ul>
<li><code>rabbitmqctl</code> - 主要管理工具</li>
<li><code>rabbitmq-plugins</code> - 插件管理</li>
<li><code>rabbitmq-diagnostics</code> - 诊断工具</li>
<li><code>rabbitmq-queues</code> - 队列管理</li>
<li><code>rabbitmq-streams</code> - 流管理</li>
</ul>
</li>
<li><strong>实现语言</strong>: Elixir</li>
<li><strong>与核心交互</strong>: 通过管理 API 与 RabbitMQ 通信</li>
</ul>
<h3 id="16-rabbitmq-top-进程监控"><a href="#16-rabbitmq-top-进程监控" class="headerlink" title="16. rabbitmq_top - 进程监控"></a>16. rabbitmq_top - 进程监控</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_top/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>类似 Unix top 的进程监控工具</li>
<li>实时进程监控、资源使用统计</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 监控 RabbitMQ 内部进程</li>
</ul>
<hr>
<h2 id="认证和授权模块"><a href="#认证和授权模块" class="headerlink" title="认证和授权模块"></a>认证和授权模块</h2><h3 id="17-rabbitmq-auth-backend-oauth2-OAuth2-认证"><a href="#17-rabbitmq-auth-backend-oauth2-OAuth2-认证" class="headerlink" title="17. rabbitmq_auth_backend_oauth2 - OAuth2 认证"></a>17. rabbitmq_auth_backend_oauth2 - OAuth2 认证</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_auth_backend_oauth2/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>基于 JWT 令牌的 OAuth2 认证后端</li>
<li>支持多种身份提供商 (UAA、Keycloak、Azure AD、Auth0)</li>
<li>细粒度权限控制</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit_auth_backend_oauth2.erl <span class="comment">% 主认证后端</span></span><br><span class="line">src/uaa_jwt.erl                   <span class="comment">% JWT 处理</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 作为认证后端插件</li>
<li><strong>依赖关系</strong>: 依赖 <code>jose</code>、<code>oauth2_client</code></li>
</ul>
<h3 id="18-rabbitmq-auth-backend-http-HTTP-认证"><a href="#18-rabbitmq-auth-backend-http-HTTP-认证" class="headerlink" title="18. rabbitmq_auth_backend_http - HTTP 认证"></a>18. rabbitmq_auth_backend_http - HTTP 认证</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_auth_backend_http/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>通过 HTTP API 进行认证和授权</li>
<li>外部 HTTP 服务认证、动态权限查询</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 认证后端插件</li>
</ul>
<h3 id="19-rabbitmq-auth-backend-ldap-LDAP-认证"><a href="#19-rabbitmq-auth-backend-ldap-LDAP-认证" class="headerlink" title="19. rabbitmq_auth_backend_ldap - LDAP 认证"></a>19. rabbitmq_auth_backend_ldap - LDAP 认证</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_auth_backend_ldap/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>LDAP 目录服务认证</li>
<li>LDAP 用户认证、组权限映射</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 认证后端插件</li>
</ul>
<h3 id="20-rabbitmq-auth-backend-cache-认证缓存"><a href="#20-rabbitmq-auth-backend-cache-认证缓存" class="headerlink" title="20. rabbitmq_auth_backend_cache - 认证缓存"></a>20. rabbitmq_auth_backend_cache - 认证缓存</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_auth_backend_cache/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>缓存认证结果以提高性能</li>
<li>可配置的缓存策略</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 包装其他认证后端</li>
</ul>
<h3 id="21-rabbitmq-auth-mechanism-ssl-SSL-证书认证"><a href="#21-rabbitmq-auth-mechanism-ssl-SSL-证书认证" class="headerlink" title="21. rabbitmq_auth_mechanism_ssl - SSL 证书认证"></a>21. rabbitmq_auth_mechanism_ssl - SSL 证书认证</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_auth_mechanism_ssl/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>基于 SSL 客户端证书的认证</li>
<li>X.509 证书认证、证书字段映射</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 认证机制插件</li>
</ul>
<hr>
<h2 id="集群发现模块"><a href="#集群发现模块" class="headerlink" title="集群发现模块"></a>集群发现模块</h2><h3 id="22-rabbitmq-peer-discovery-aws-AWS-集群发现"><a href="#22-rabbitmq-peer-discovery-aws-AWS-集群发现" class="headerlink" title="22. rabbitmq_peer_discovery_aws - AWS 集群发现"></a>22. rabbitmq_peer_discovery_aws - AWS 集群发现</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_peer_discovery_aws/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>在 AWS 环境中自动发现集群节点</li>
<li>EC2 实例发现、基于标签的节点识别</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 集群发现插件</li>
<li><strong>依赖关系</strong>: 依赖 <code>rabbitmq_aws</code>、<code>rabbitmq_peer_discovery_common</code></li>
</ul>
<h3 id="23-rabbitmq-peer-discovery-k8s-Kubernetes-集群发现"><a href="#23-rabbitmq-peer-discovery-k8s-Kubernetes-集群发现" class="headerlink" title="23. rabbitmq_peer_discovery_k8s - Kubernetes 集群发现"></a>23. rabbitmq_peer_discovery_k8s - Kubernetes 集群发现</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_peer_discovery_k8s/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>在 Kubernetes 环境中发现集群节点</li>
<li>K8s API 集成、服务发现</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 集群发现插件</li>
</ul>
<h3 id="24-rabbitmq-peer-discovery-consul-Consul-集群发现"><a href="#24-rabbitmq-peer-discovery-consul-Consul-集群发现" class="headerlink" title="24. rabbitmq_peer_discovery_consul - Consul 集群发现"></a>24. rabbitmq_peer_discovery_consul - Consul 集群发现</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_peer_discovery_consul/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>使用 Consul 进行服务发现</li>
<li>Consul API 集成、健康检查</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 集群发现插件</li>
</ul>
<h3 id="25-rabbitmq-peer-discovery-etcd-etcd-集群发现"><a href="#25-rabbitmq-peer-discovery-etcd-etcd-集群发现" class="headerlink" title="25. rabbitmq_peer_discovery_etcd - etcd 集群发现"></a>25. rabbitmq_peer_discovery_etcd - etcd 集群发现</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_peer_discovery_etcd/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>使用 etcd 进行集群发现</li>
<li>etcd 键值存储集成、分布式配置</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 集群发现插件</li>
<li><strong>依赖关系</strong>: 依赖 <code>eetcd</code></li>
</ul>
<h3 id="26-rabbitmq-peer-discovery-common-集群发现通用库"><a href="#26-rabbitmq-peer-discovery-common-集群发现通用库" class="headerlink" title="26. rabbitmq_peer_discovery_common - 集群发现通用库"></a>26. rabbitmq_peer_discovery_common - 集群发现通用库</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_peer_discovery_common/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>为各种集群发现机制提供通用功能</li>
<li>通用发现逻辑、配置管理</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 被其他发现插件使用</li>
</ul>
<hr>
<h2 id="交换器插件"><a href="#交换器插件" class="headerlink" title="交换器插件"></a>交换器插件</h2><h3 id="27-rabbitmq-consistent-hash-exchange-一致性哈希交换器"><a href="#27-rabbitmq-consistent-hash-exchange-一致性哈希交换器" class="headerlink" title="27. rabbitmq_consistent_hash_exchange - 一致性哈希交换器"></a>27. rabbitmq_consistent_hash_exchange - 一致性哈希交换器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_consistent_hash_exchange/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>基于一致性哈希的消息路由</li>
<li>一致性哈希算法、负载均衡、节点故障容错</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 自定义交换器类型</li>
</ul>
<h3 id="28-rabbitmq-random-exchange-随机交换器"><a href="#28-rabbitmq-random-exchange-随机交换器" class="headerlink" title="28. rabbitmq_random_exchange - 随机交换器"></a>28. rabbitmq_random_exchange - 随机交换器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_random_exchange/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>随机选择队列进行消息路由</li>
<li>随机负载均衡、简单路由策略</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 自定义交换器类型</li>
</ul>
<h3 id="29-rabbitmq-recent-history-exchange-历史消息交换器"><a href="#29-rabbitmq-recent-history-exchange-历史消息交换器" class="headerlink" title="29. rabbitmq_recent_history_exchange - 历史消息交换器"></a>29. rabbitmq_recent_history_exchange - 历史消息交换器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_recent_history_exchange/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>保留最近消息历史的交换器</li>
<li>消息历史缓存、新订阅者可获取历史消息</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 自定义交换器类型</li>
</ul>
<h3 id="30-rabbitmq-event-exchange-事件交换器"><a href="#30-rabbitmq-event-exchange-事件交换器" class="headerlink" title="30. rabbitmq_event_exchange - 事件交换器"></a>30. rabbitmq_event_exchange - 事件交换器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_event_exchange/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>发布 RabbitMQ 内部事件</li>
<li>系统事件发布、监控和审计支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 发布内部事件到 AMQP</li>
</ul>
<h3 id="31-rabbitmq-jms-topic-exchange-JMS-主题交换器"><a href="#31-rabbitmq-jms-topic-exchange-JMS-主题交换器" class="headerlink" title="31. rabbitmq_jms_topic_exchange - JMS 主题交换器"></a>31. rabbitmq_jms_topic_exchange - JMS 主题交换器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_jms_topic_exchange/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>支持 JMS 风格的主题路由</li>
<li>JMS 主题语义、层次化主题结构</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 自定义交换器类型</li>
</ul>
<hr>
<h2 id="联邦和复制模块"><a href="#联邦和复制模块" class="headerlink" title="联邦和复制模块"></a>联邦和复制模块</h2><h3 id="32-rabbitmq-federation-联邦"><a href="#32-rabbitmq-federation-联邦" class="headerlink" title="32. rabbitmq_federation - 联邦"></a>32. rabbitmq_federation - 联邦</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_federation/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>跨 WAN 的松耦合分布式 RabbitMQ 设置</li>
<li>交换器和队列联邦、跨集群消息复制</li>
<li>WAN 友好的设计</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit_federation_link.erl   <span class="comment">% 联邦链接</span></span><br><span class="line">src/rabbit_federation_exchange.erl <span class="comment">% 联邦交换器</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 创建联邦链接和复制策略</li>
<li><strong>依赖关系</strong>: 依赖 <code>amqp_client</code></li>
</ul>
<h3 id="33-rabbitmq-federation-management-联邦管理"><a href="#33-rabbitmq-federation-management-联邦管理" class="headerlink" title="33. rabbitmq_federation_management - 联邦管理"></a>33. rabbitmq_federation_management - 联邦管理</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_federation_management/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>联邦功能的管理界面扩展</li>
<li>联邦状态监控、联邦配置管理</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展管理界面</li>
</ul>
<h3 id="34-rabbitmq-federation-prometheus-联邦监控"><a href="#34-rabbitmq-federation-prometheus-联邦监控" class="headerlink" title="34. rabbitmq_federation_prometheus - 联邦监控"></a>34. rabbitmq_federation_prometheus - 联邦监控</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_federation_prometheus/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>联邦相关的 Prometheus 指标</li>
<li>联邦链接状态指标、复制性能指标</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展 Prometheus 导出器</li>
</ul>
<h3 id="35-rabbitmq-shovel-铲子"><a href="#35-rabbitmq-shovel-铲子" class="headerlink" title="35. rabbitmq_shovel - 铲子"></a>35. rabbitmq_shovel - 铲子</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_shovel/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>WAN 友好的消息移动工具</li>
<li>队列到交换器的消息传输</li>
<li>支持不同 RabbitMQ 节点间传输</li>
<li>动态和静态铲子配置</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src/rabbit_shovel_worker.erl     <span class="comment">% 铲子工作进程</span></span><br><span class="line">src/rabbit_shovel_dyn_worker_sup.erl <span class="comment">% 动态工作进程监督器</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 作为消息传输工具</li>
<li><strong>依赖关系</strong>: 依赖 <code>amqp_client</code></li>
</ul>
<h3 id="36-rabbitmq-shovel-management-铲子管理"><a href="#36-rabbitmq-shovel-management-铲子管理" class="headerlink" title="36. rabbitmq_shovel_management - 铲子管理"></a>36. rabbitmq_shovel_management - 铲子管理</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_shovel_management/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>铲子功能的管理界面</li>
<li>铲子状态监控、动态铲子管理</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展管理界面</li>
</ul>
<h3 id="37-rabbitmq-shovel-prometheus-铲子监控"><a href="#37-rabbitmq-shovel-prometheus-铲子监控" class="headerlink" title="37. rabbitmq_shovel_prometheus - 铲子监控"></a>37. rabbitmq_shovel_prometheus - 铲子监控</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_shovel_prometheus/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>铲子相关的 Prometheus 指标</li>
<li>铲子传输指标、性能监控</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展 Prometheus 导出器</li>
</ul>
<hr>
<h2 id="Web-和网络模块"><a href="#Web-和网络模块" class="headerlink" title="Web 和网络模块"></a>Web 和网络模块</h2><h3 id="38-rabbitmq-web-dispatch-Web-分发器"><a href="#38-rabbitmq-web-dispatch-Web-分发器" class="headerlink" title="38. rabbitmq_web_dispatch - Web 分发器"></a>38. rabbitmq_web_dispatch - Web 分发器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_web_dispatch/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>HTTP 请求路由和分发</li>
<li>插件 Web 接口注册</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 为管理界面和其他 Web 插件提供基础</li>
<li><strong>依赖关系</strong>: 依赖 <code>cowboy</code>、<code>ranch</code></li>
</ul>
<h3 id="39-rabbitmq-web-mqtt-Web-MQTT"><a href="#39-rabbitmq-web-mqtt-Web-MQTT" class="headerlink" title="39. rabbitmq_web_mqtt - Web MQTT"></a>39. rabbitmq_web_mqtt - Web MQTT</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_web_mqtt/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>通过 WebSocket 提供 MQTT 支持</li>
<li>WebSocket 到 MQTT 桥接、浏览器 MQTT 客户端支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展 MQTT 协议到 Web</li>
<li><strong>依赖关系</strong>: 依赖 <code>rabbitmq_mqtt</code></li>
<li><strong>默认端口</strong>: 15675</li>
</ul>
<h3 id="40-rabbitmq-web-mqtt-examples-Web-MQTT-示例"><a href="#40-rabbitmq-web-mqtt-examples-Web-MQTT-示例" class="headerlink" title="40. rabbitmq_web_mqtt_examples - Web MQTT 示例"></a>40. rabbitmq_web_mqtt_examples - Web MQTT 示例</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_web_mqtt_examples/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Web MQTT 功能的示例代码</li>
<li>示例 HTML 页面、JavaScript 客户端示例</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供使用示例</li>
</ul>
<h3 id="41-rabbitmq-web-stomp-Web-STOMP"><a href="#41-rabbitmq-web-stomp-Web-STOMP" class="headerlink" title="41. rabbitmq_web_stomp - Web STOMP"></a>41. rabbitmq_web_stomp - Web STOMP</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_web_stomp/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>通过 WebSocket 提供 STOMP 支持</li>
<li>WebSocket 到 STOMP 桥接、浏览器 STOMP 客户端支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展 STOMP 协议到 Web</li>
<li><strong>依赖关系</strong>: 依赖 <code>rabbitmq_stomp</code></li>
<li><strong>默认端口</strong>: 15674</li>
</ul>
<h3 id="42-rabbitmq-web-stomp-examples-Web-STOMP-示例"><a href="#42-rabbitmq-web-stomp-examples-Web-STOMP-示例" class="headerlink" title="42. rabbitmq_web_stomp_examples - Web STOMP 示例"></a>42. rabbitmq_web_stomp_examples - Web STOMP 示例</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_web_stomp_examples/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Web STOMP 功能的示例代码</li>
<li>示例 HTML 页面、JavaScript 客户端示例</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供使用示例</li>
</ul>
<hr>
<h2 id="HTTP-和网络基础库"><a href="#HTTP-和网络基础库" class="headerlink" title="HTTP 和网络基础库"></a>HTTP 和网络基础库</h2><h3 id="43-cowboy-HTTP-服务器"><a href="#43-cowboy-HTTP-服务器" class="headerlink" title="43. cowboy - HTTP 服务器"></a>43. cowboy - HTTP 服务器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/cowboy/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>小型、快速、现代的 HTTP 服务器</li>
<li>HTTP&#x2F;1.1 和 HTTP&#x2F;2 支持</li>
<li>WebSocket 支持、路由和处理器</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src/cowboy_http.erl              <span class="comment">% HTTP 协议处理</span></span><br><span class="line">src/cowboy_websocket.erl         <span class="comment">% WebSocket 处理</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 为管理界面和 Web 插件提供 HTTP 服务</li>
<li><strong>依赖关系</strong>: 依赖 <code>cowlib</code>、<code>ranch</code></li>
</ul>
<h3 id="44-cowlib-Cowboy-支持库"><a href="#44-cowlib-Cowboy-支持库" class="headerlink" title="44. cowlib - Cowboy 支持库"></a>44. cowlib - Cowboy 支持库</h3><ul>
<li><strong>模块路径</strong>: <code>deps/cowlib/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Cowboy HTTP 服务器的支持库</li>
<li>HTTP 协议解析、通用 HTTP 工具</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/cow_http_hd.erl              <span class="comment">% HTTP 头处理 (3,642 行)</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 被 <code>cowboy</code> 使用</li>
</ul>
<h3 id="45-ranch-Socket-接受器池"><a href="#45-ranch-Socket-接受器池" class="headerlink" title="45. ranch - Socket 接受器池"></a>45. ranch - Socket 接受器池</h3><ul>
<li><strong>模块路径</strong>: <code>deps/ranch/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>TCP 协议的 socket 接受器池</li>
<li>连接池管理、并发连接限制、传输层抽象</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 为所有网络连接提供基础设施</li>
<li><strong>依赖关系</strong>: 被 <code>cowboy</code>、<code>rabbit</code> 等使用</li>
</ul>
<h3 id="46-gun-HTTP-客户端"><a href="#46-gun-HTTP-客户端" class="headerlink" title="46. gun - HTTP 客户端"></a>46. gun - HTTP 客户端</h3><ul>
<li><strong>模块路径</strong>: <code>deps/gun/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>HTTP&#x2F;1.1、HTTP&#x2F;2 和 WebSocket 客户端</li>
<li>持久连接、多协议支持、自动重连</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 用于外部 HTTP 通信</li>
</ul>
<hr>
<h2 id="安全和加密模块"><a href="#安全和加密模块" class="headerlink" title="安全和加密模块"></a>安全和加密模块</h2><h3 id="47-rabbitmq-trust-store-信任存储"><a href="#47-rabbitmq-trust-store-信任存储" class="headerlink" title="47. rabbitmq_trust_store - 信任存储"></a>47. rabbitmq_trust_store - 信任存储</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_trust_store/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>动态 SSL 证书信任存储管理</li>
<li>证书验证、动态证书更新、证书撤销列表支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 增强 SSL 安全性</li>
</ul>
<h3 id="48-credentials-obfuscation-凭据混淆"><a href="#48-credentials-obfuscation-凭据混淆" class="headerlink" title="48. credentials_obfuscation - 凭据混淆"></a>48. credentials_obfuscation - 凭据混淆</h3><ul>
<li><strong>模块路径</strong>: <code>deps/credentials_obfuscation/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>敏感信息加密和混淆</li>
<li>密码加密存储、配置文件敏感信息保护</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 保护配置中的敏感信息</li>
</ul>
<h3 id="49-jose-JSON-Web-签名-加密"><a href="#49-jose-JSON-Web-签名-加密" class="headerlink" title="49. jose - JSON Web 签名&#x2F;加密"></a>49. jose - JSON Web 签名&#x2F;加密</h3><ul>
<li><strong>模块路径</strong>: <code>deps/jose/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>JWT、JWS、JWE、JWK、JWA 实现</li>
<li>JWT 令牌处理、数字签名验证、加密解密</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">src/jose_jwt.erl                 <span class="comment">% JWT 处理</span></span><br><span class="line">src/jose_jws.erl                 <span class="comment">% JWS 签名</span></span><br><span class="line">src/jose_jwe.erl                 <span class="comment">% JWE 加密</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 被 OAuth2 认证后端使用</li>
<li><strong>依赖关系</strong>: 被 <code>rabbitmq_auth_backend_oauth2</code> 使用</li>
</ul>
<h3 id="50-base64url-Base64URL-编码"><a href="#50-base64url-Base64URL-编码" class="headerlink" title="50. base64url - Base64URL 编码"></a>50. base64url - Base64URL 编码</h3><ul>
<li><strong>模块路径</strong>: <code>deps/base64url/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Base64URL 编码&#x2F;解码</li>
<li>URL 安全的 Base64 编码、JWT 令牌编码支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 支持 JWT 处理</li>
</ul>
<hr>
<h2 id="工具和实用程序模块"><a href="#工具和实用程序模块" class="headerlink" title="工具和实用程序模块"></a>工具和实用程序模块</h2><h3 id="51-cuttlefish-配置管理"><a href="#51-cuttlefish-配置管理" class="headerlink" title="51. cuttlefish - 配置管理"></a>51. cuttlefish - 配置管理</h3><ul>
<li><strong>模块路径</strong>: <code>deps/cuttlefish/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>配置文件格式转换和管理</li>
<li><code>.conf</code> 到 <code>app.config</code> 转换</li>
<li>配置验证和模式定义、用户友好的配置语法</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src/cuttlefish.erl               <span class="comment">% 主配置处理</span></span><br><span class="line">src/cuttlefish_schema.erl        <span class="comment">% 配置模式</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 处理 RabbitMQ 配置文件</li>
</ul>
<h3 id="52-rabbitmq-codegen-代码生成器"><a href="#52-rabbitmq-codegen-代码生成器" class="headerlink" title="52. rabbitmq_codegen - 代码生成器"></a>52. rabbitmq_codegen - 代码生成器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_codegen/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>从 AMQP 规范生成协议处理代码</li>
<li>AMQP 协议代码生成、支持协议扩展</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 构建时生成协议处理代码</li>
</ul>
<h3 id="53-recon-生产诊断工具"><a href="#53-recon-生产诊断工具" class="headerlink" title="53. recon - 生产诊断工具"></a>53. recon - 生产诊断工具</h3><ul>
<li><strong>模块路径</strong>: <code>deps/recon/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>生产环境安全的 Erlang 诊断工具</li>
<li>进程监控、内存分析、性能诊断</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供运行时诊断能力</li>
</ul>
<h3 id="54-redbug-调试工具"><a href="#54-redbug-调试工具" class="headerlink" title="54. redbug - 调试工具"></a>54. redbug - 调试工具</h3><ul>
<li><strong>模块路径</strong>: <code>deps/redbug/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>生产环境安全的调试和跟踪工具</li>
<li>函数调用跟踪、性能分析、调试信息收集</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/redbug_parser.erl            <span class="comment">% 跟踪解析器 (3,184 行)</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 提供调试能力</li>
</ul>
<h3 id="55-observer-cli-命令行观察器"><a href="#55-observer-cli-命令行观察器" class="headerlink" title="55. observer_cli - 命令行观察器"></a>55. observer_cli - 命令行观察器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/observer_cli/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>命令行版本的 Observer 工具</li>
<li>实时系统监控、进程和内存统计、网络和磁盘监控</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 监控 RabbitMQ 运行状态</li>
</ul>
<hr>
<h2 id="流处理相关模块"><a href="#流处理相关模块" class="headerlink" title="流处理相关模块"></a>流处理相关模块</h2><h3 id="56-rabbitmq-stream-common-流通用库"><a href="#56-rabbitmq-stream-common-流通用库" class="headerlink" title="56. rabbitmq_stream_common - 流通用库"></a>56. rabbitmq_stream_common - 流通用库</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_stream_common/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>流功能的通用组件</li>
<li>流协议通用定义、共享数据结构</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 被流相关模块使用</li>
</ul>
<h3 id="57-rabbitmq-stream-management-流管理"><a href="#57-rabbitmq-stream-management-流管理" class="headerlink" title="57. rabbitmq_stream_management - 流管理"></a>57. rabbitmq_stream_management - 流管理</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_stream_management/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>流功能的管理界面扩展</li>
<li>流状态监控、流配置管理</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展管理界面</li>
</ul>
<h3 id="58-seshat-日志管理"><a href="#58-seshat-日志管理" class="headerlink" title="58. seshat - 日志管理"></a>58. seshat - 日志管理</h3><ul>
<li><strong>模块路径</strong>: <code>deps/seshat/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>高性能日志管理库</li>
<li>日志索引和查询、高效日志存储</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 被 <code>ra</code> 和 <code>osiris</code> 使用</li>
</ul>
<hr>
<h2 id="系统集成模块"><a href="#系统集成模块" class="headerlink" title="系统集成模块"></a>系统集成模块</h2><h3 id="59-rabbitmq-prelaunch-预启动处理"><a href="#59-rabbitmq-prelaunch-预启动处理" class="headerlink" title="59. rabbitmq_prelaunch - 预启动处理"></a>59. rabbitmq_prelaunch - 预启动处理</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_prelaunch/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>RabbitMQ 启动前的准备工作</li>
<li>环境检查、配置预处理、依赖验证</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 启动流程的一部分</li>
</ul>
<h3 id="60-systemd-Systemd-集成"><a href="#60-systemd-Systemd-集成" class="headerlink" title="60. systemd - Systemd 集成"></a>60. systemd - Systemd 集成</h3><ul>
<li><strong>模块路径</strong>: <code>deps/systemd/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>与 systemd 系统服务管理器集成</li>
<li>服务状态通知、系统集成支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供系统服务集成</li>
</ul>
<h3 id="61-syslog-系统日志"><a href="#61-syslog-系统日志" class="headerlink" title="61. syslog - 系统日志"></a>61. syslog - 系统日志</h3><ul>
<li><strong>模块路径</strong>: <code>deps/syslog/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>系统日志集成</li>
<li>syslog 协议支持、日志转发</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供日志输出选项</li>
</ul>
<h3 id="62-sysmon-handler-系统监控处理器"><a href="#62-sysmon-handler-系统监控处理器" class="headerlink" title="62. sysmon_handler - 系统监控处理器"></a>62. sysmon_handler - 系统监控处理器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/sysmon_handler/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>系统监控事件处理</li>
<li>系统事件监控、性能警报</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 监控系统健康状态</li>
</ul>
<hr>
<h2 id="数据处理和序列化模块"><a href="#数据处理和序列化模块" class="headerlink" title="数据处理和序列化模块"></a>数据处理和序列化模块</h2><h3 id="63-thoas-JSON-处理"><a href="#63-thoas-JSON-处理" class="headerlink" title="63. thoas - JSON 处理"></a>63. thoas - JSON 处理</h3><ul>
<li><strong>模块路径</strong>: <code>deps/thoas/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>高性能 JSON 编码&#x2F;解码</li>
<li>快速 JSON 处理、内存高效</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 处理 JSON 格式数据</li>
</ul>
<h3 id="64-json-JSON-库-Elixir"><a href="#64-json-JSON-库-Elixir" class="headerlink" title="64. json - JSON 库 (Elixir)"></a>64. json - JSON 库 (Elixir)</h3><ul>
<li><strong>模块路径</strong>: <code>deps/json/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Elixir JSON 处理库</li>
<li>JSON 编码解码、Elixir 数据结构支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 被 <code>rabbitmq_cli</code> 使用</li>
</ul>
<h3 id="65-csv-CSV-处理-Elixir"><a href="#65-csv-CSV-处理-Elixir" class="headerlink" title="65. csv - CSV 处理 (Elixir)"></a>65. csv - CSV 处理 (Elixir)</h3><ul>
<li><strong>模块路径</strong>: <code>deps/csv/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>CSV 文件处理</li>
<li>CSV 解析和生成、流式处理</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 数据导入导出支持</li>
</ul>
<hr>
<h2 id="监控和指标模块"><a href="#监控和指标模块" class="headerlink" title="监控和指标模块"></a>监控和指标模块</h2><h3 id="66-prometheus-Prometheus-客户端库"><a href="#66-prometheus-Prometheus-客户端库" class="headerlink" title="66. prometheus - Prometheus 客户端库"></a>66. prometheus - Prometheus 客户端库</h3><ul>
<li><strong>模块路径</strong>: <code>deps/prometheus/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Prometheus 指标收集库</li>
<li>指标定义和收集、多种指标类型支持</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/prometheus_model.erl         <span class="comment">% Prometheus 模型 (2,983 行)</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 被 <code>rabbitmq_prometheus</code> 使用</li>
</ul>
<h3 id="67-quantile-estimator-分位数估算"><a href="#67-quantile-estimator-分位数估算" class="headerlink" title="67. quantile_estimator - 分位数估算"></a>67. quantile_estimator - 分位数估算</h3><ul>
<li><strong>模块路径</strong>: <code>deps/quantile_estimator/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>高效的分位数计算</li>
<li>流式分位数估算、内存高效算法</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供性能指标计算</li>
</ul>
<h3 id="68-rabbitmq-tracing-消息跟踪"><a href="#68-rabbitmq-tracing-消息跟踪" class="headerlink" title="68. rabbitmq_tracing - 消息跟踪"></a>68. rabbitmq_tracing - 消息跟踪</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_tracing/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>消息流跟踪和调试</li>
<li>消息路径跟踪、调试信息收集</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供消息流可视化</li>
</ul>
<hr>
<h2 id="分片和负载均衡模块"><a href="#分片和负载均衡模块" class="headerlink" title="分片和负载均衡模块"></a>分片和负载均衡模块</h2><h3 id="69-rabbitmq-sharding-分片"><a href="#69-rabbitmq-sharding-分片" class="headerlink" title="69. rabbitmq_sharding - 分片"></a>69. rabbitmq_sharding - 分片</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_sharding/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>队列分片和负载分布</li>
<li>自动队列分片、负载均衡、水平扩展支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供队列分片策略</li>
</ul>
<hr>
<h2 id="辅助和支持模块"><a href="#辅助和支持模块" class="headerlink" title="辅助和支持模块"></a>辅助和支持模块</h2><h3 id="70-rabbitmq-aws-AWS-集成"><a href="#70-rabbitmq-aws-AWS-集成" class="headerlink" title="70. rabbitmq_aws - AWS 集成"></a>70. rabbitmq_aws - AWS 集成</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_aws/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>AWS 服务集成支持</li>
<li>AWS API 客户端、云服务集成</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 支持 AWS 环境部署</li>
</ul>
<h3 id="71-oauth2-client-OAuth2-客户端"><a href="#71-oauth2-client-OAuth2-客户端" class="headerlink" title="71. oauth2_client - OAuth2 客户端"></a>71. oauth2_client - OAuth2 客户端</h3><ul>
<li><strong>模块路径</strong>: <code>deps/oauth2_client/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>OAuth2 客户端实现</li>
<li>OAuth2 流程处理、令牌管理</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 支持 OAuth2 认证</li>
</ul>
<h3 id="72-accept-内容协商"><a href="#72-accept-内容协商" class="headerlink" title="72. accept - 内容协商"></a>72. accept - 内容协商</h3><ul>
<li><strong>模块路径</strong>: <code>deps/accept/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>HTTP 内容协商处理</li>
<li>Accept 头解析、内容类型协商</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 支持 HTTP API 内容协商</li>
</ul>
<h3 id="73-aten-故障检测"><a href="#73-aten-故障检测" class="headerlink" title="73. aten - 故障检测"></a>73. aten - 故障检测</h3><ul>
<li><strong>模块路径</strong>: <code>deps/aten/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>分布式故障检测</li>
<li>节点故障检测、网络分区检测</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 被 <code>ra</code> 使用进行故障检测</li>
</ul>
<h3 id="74-gen-batch-server-批处理服务器"><a href="#74-gen-batch-server-批处理服务器" class="headerlink" title="74. gen_batch_server - 批处理服务器"></a>74. gen_batch_server - 批处理服务器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/gen_batch_server/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>批量操作的通用服务器行为</li>
<li>批量请求处理、性能优化</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 被 <code>ra</code>、<code>osiris</code> 等使用</li>
</ul>
<h3 id="75-enough-资源限制"><a href="#75-enough-资源限制" class="headerlink" title="75. enough - 资源限制"></a>75. enough - 资源限制</h3><ul>
<li><strong>模块路径</strong>: <code>deps/enough/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>资源使用限制和监控</li>
<li>内存使用监控、资源限制执行</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供资源保护</li>
</ul>
<h3 id="76-getopt-命令行选项解析"><a href="#76-getopt-命令行选项解析" class="headerlink" title="76. getopt - 命令行选项解析"></a>76. getopt - 命令行选项解析</h3><ul>
<li><strong>模块路径</strong>: <code>deps/getopt/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>命令行参数解析</li>
<li>选项解析、帮助信息生成</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 被命令行工具使用</li>
</ul>
<h3 id="77-horus-函数序列化"><a href="#77-horus-函数序列化" class="headerlink" title="77. horus - 函数序列化"></a>77. horus - 函数序列化</h3><ul>
<li><strong>模块路径</strong>: <code>deps/horus/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Erlang 函数序列化和反序列化</li>
<li>函数持久化、跨节点函数传输</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/horus.erl                    <span class="comment">% 主模块 (3,043 行)</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 被 <code>khepri</code> 使用存储函数</li>
</ul>
<h3 id="78-stdout-formatter-标准输出格式化"><a href="#78-stdout-formatter-标准输出格式化" class="headerlink" title="78. stdout_formatter - 标准输出格式化"></a>78. stdout_formatter - 标准输出格式化</h3><ul>
<li><strong>模块路径</strong>: <code>deps/stdout_formatter/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>日志输出格式化</li>
<li>彩色输出、格式化日志</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供日志格式化</li>
</ul>
<hr>
<h2 id="测试和开发支持模块"><a href="#测试和开发支持模块" class="headerlink" title="测试和开发支持模块"></a>测试和开发支持模块</h2><h3 id="79-rabbitmq-ct-helpers-测试辅助工具"><a href="#79-rabbitmq-ct-helpers-测试辅助工具" class="headerlink" title="79. rabbitmq_ct_helpers - 测试辅助工具"></a>79. rabbitmq_ct_helpers - 测试辅助工具</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_ct_helpers/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Common Test 测试框架辅助</li>
<li>测试环境设置、测试工具函数</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 支持测试开发</li>
</ul>
<h3 id="80-rabbitmq-ct-client-helpers-客户端测试辅助"><a href="#80-rabbitmq-ct-client-helpers-客户端测试辅助" class="headerlink" title="80. rabbitmq_ct_client_helpers - 客户端测试辅助"></a>80. rabbitmq_ct_client_helpers - 客户端测试辅助</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_ct_client_helpers/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>客户端测试辅助工具</li>
<li>客户端测试支持、连接管理</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 支持客户端测试</li>
</ul>
<h3 id="81-elvis-mk-代码风格检查"><a href="#81-elvis-mk-代码风格检查" class="headerlink" title="81. elvis_mk - 代码风格检查"></a>81. elvis_mk - 代码风格检查</h3><ul>
<li><strong>模块路径</strong>: <code>deps/elvis_mk/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>Erlang 代码风格检查工具</li>
<li>代码风格验证、质量检查</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 开发时代码质量保证</li>
</ul>
<hr>
<h2 id="特殊用途模块"><a href="#特殊用途模块" class="headerlink" title="特殊用途模块"></a>特殊用途模块</h2><h3 id="82-rabbitmq-amqp1-0-AMQP-1-0-桥接"><a href="#82-rabbitmq-amqp1-0-AMQP-1-0-桥接" class="headerlink" title="82. rabbitmq_amqp1_0 - AMQP 1.0 桥接"></a>82. rabbitmq_amqp1_0 - AMQP 1.0 桥接</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_amqp1_0/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>AMQP 1.0 协议桥接</li>
<li>协议转换、兼容性支持</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供 AMQP 1.0 支持</li>
</ul>
<h3 id="83-rabbitmq-amqp-client-AMQP-客户端适配器"><a href="#83-rabbitmq-amqp-client-AMQP-客户端适配器" class="headerlink" title="83. rabbitmq_amqp_client - AMQP 客户端适配器"></a>83. rabbitmq_amqp_client - AMQP 客户端适配器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_amqp_client/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>AMQP 客户端功能适配</li>
<li>客户端接口适配、协议转换</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 提供客户端支持</li>
</ul>
<h3 id="84-trust-store-http-HTTP-信任存储"><a href="#84-trust-store-http-HTTP-信任存储" class="headerlink" title="84. trust_store_http - HTTP 信任存储"></a>84. trust_store_http - HTTP 信任存储</h3><ul>
<li><strong>模块路径</strong>: <code>deps/trust_store_http/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>通过 HTTP 管理信任存储</li>
<li>HTTP API 信任存储、远程证书管理</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 扩展信任存储功能</li>
</ul>
<h3 id="85-eetcd-etcd-客户端"><a href="#85-eetcd-etcd-客户端" class="headerlink" title="85. eetcd - etcd 客户端"></a>85. eetcd - etcd 客户端</h3><ul>
<li><strong>模块路径</strong>: <code>deps/eetcd/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>etcd 键值存储客户端</li>
<li>etcd API 客户端、分布式配置</li>
</ul>
</li>
<li><strong>核心文件</strong>:<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">src/protos/router_pb.erl         <span class="comment">% 路由协议 (64,412 行)</span></span><br><span class="line">src/protos/auth_pb.erl           <span class="comment">% 认证协议 (29,983 行)</span></span><br><span class="line">src/protos/kv_pb.erl             <span class="comment">% 键值协议 (29,658 行)</span></span><br></pre></td></tr></table></figure></li>
<li><strong>与核心交互</strong>: 支持 etcd 集群发现</li>
</ul>
<h3 id="86-rabbitmq-consistent-hash-exchange-一致性哈希交换器"><a href="#86-rabbitmq-consistent-hash-exchange-一致性哈希交换器" class="headerlink" title="86. rabbitmq_consistent_hash_exchange - 一致性哈希交换器"></a>86. rabbitmq_consistent_hash_exchange - 一致性哈希交换器</h3><ul>
<li><strong>模块路径</strong>: <code>deps/rabbitmq_consistent_hash_exchange/</code></li>
<li><strong>主要功能</strong>:<ul>
<li>一致性哈希路由交换器</li>
<li>一致性哈希算法、负载均衡路由</li>
</ul>
</li>
<li><strong>与核心交互</strong>: 自定义交换器类型</li>
</ul>
<hr>
<h2 id="依赖关系图"><a href="#依赖关系图" class="headerlink" title="依赖关系图"></a>依赖关系图</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">                    ┌─────────────────────────────────┐</span><br><span class="line">                    │            rabbit               │</span><br><span class="line">                    │        (核心服务器)              │</span><br><span class="line">                    └──────────────┬──────────────────┘</span><br><span class="line">                                   │</span><br><span class="line">         ┌─────────────────────────┼─────────────────────────┐</span><br><span class="line">         │                         │                         │</span><br><span class="line">         ▼                         ▼                         ▼</span><br><span class="line">┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐</span><br><span class="line">│  rabbit_common  │    │       ra        │    │     osiris      │</span><br><span class="line">│    (共享库)      │    │   (Raft一致性)   │    │   (日志存储)     │</span><br><span class="line">└────────┬────────┘    └────────┬────────┘    └────────┬────────┘</span><br><span class="line">         │                      │                      │</span><br><span class="line">         │              ┌───────┼───────┐              │</span><br><span class="line">         │              │       │       │              │</span><br><span class="line">         │              ▼       │       ▼              │</span><br><span class="line">         │     ┌────────────┐   │   ┌────────┐        │</span><br><span class="line">         │     │   aten     │   │   │ seshat │◄───────┘</span><br><span class="line">         │     │ (故障检测)  │   │   │(日志管理)│</span><br><span class="line">         │     └────────────┘   │   └────────┘</span><br><span class="line">         │                      │</span><br><span class="line">         │                      ▼</span><br><span class="line">         │             ┌─────────────────┐</span><br><span class="line">         │             │gen_batch_server │◄────────────┘</span><br><span class="line">         │             │   (批处理服务器)  │</span><br><span class="line">         │             └─────────────────┘</span><br><span class="line">         │</span><br><span class="line">         ▼</span><br><span class="line">┌─────────────────┐            ┌─────────────────┐</span><br><span class="line">│   amqp_client   │            │     khepri      │</span><br><span class="line">│   (AMQP客户端)   │            │  (树形数据库)    │</span><br><span class="line">└─────────────────┘            └────────┬────────┘</span><br><span class="line">                                        │</span><br><span class="line">                                        ▼</span><br><span class="line">                               ┌─────────────────┐</span><br><span class="line">                               │     horus       │</span><br><span class="line">                               │   (函数序列化)   │</span><br><span class="line">                               └─────────────────┘</span><br><span class="line"></span><br><span class="line">         ┌─────────────────────────────────────────────────┐</span><br><span class="line">         │                    网络层                        │</span><br><span class="line">         │  ┌──────────┐  ┌──────────┐  ┌──────────┐      │</span><br><span class="line">         │  │  cowboy  │─▶│  cowlib  │  │   ranch  │◄─────│</span><br><span class="line">         │  │(HTTP服务)│  │(HTTP库)  │  │ (连接池) │      │</span><br><span class="line">         │  └──────────┘  └──────────┘  └──────────┘      │</span><br><span class="line">         └─────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">         ┌─────────────────────────────────────────────────┐</span><br><span class="line">         │                    协议层                        │</span><br><span class="line">         │  ┌──────────────┐  ┌────────────────────────┐  │</span><br><span class="line">         │  │rabbitmq_mqtt │  │   rabbitmq_stream      │  │</span><br><span class="line">         │  │  (MQTT协议)  │  │     (流协议)           │  │</span><br><span class="line">         │  └──────────────┘  └────────────────────────┘  │</span><br><span class="line">         │  ┌──────────────┐                              │</span><br><span class="line">         │  │rabbitmq_stomp│                              │</span><br><span class="line">         │  │ (STOMP协议)  │                              │</span><br><span class="line">         │  └──────────────┘                              │</span><br><span class="line">         └─────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">         ┌─────────────────────────────────────────────────┐</span><br><span class="line">         │                    管理层                        │</span><br><span class="line">         │  ┌──────────────────┐  ┌────────────────────┐  │</span><br><span class="line">         │  │rabbitmq_management│  │rabbitmq_prometheus │  │</span><br><span class="line">         │  │    (Web管理)      │  │  (Prometheus监控)  │  │</span><br><span class="line">         │  └────────┬─────────┘  └────────────────────┘  │</span><br><span class="line">         │           │                                     │</span><br><span class="line">         │           ▼                                     │</span><br><span class="line">         │  ┌──────────────────────┐                      │</span><br><span class="line">         │  │rabbitmq_web_dispatch │                      │</span><br><span class="line">         │  │    (Web分发器)       │                      │</span><br><span class="line">         │  └──────────────────────┘                      │</span><br><span class="line">         └─────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="总体架构特点"><a href="#总体架构特点" class="headerlink" title="总体架构特点"></a>总体架构特点</h2><h3 id="1-模块化设计"><a href="#1-模块化设计" class="headerlink" title="1. 模块化设计"></a>1. 模块化设计</h3><ul>
<li><strong>清晰分层</strong>: 核心、存储、协议、管理、工具等层次分明</li>
<li><strong>职责单一</strong>: 每个模块都有明确的功能边界</li>
<li><strong>接口标准</strong>: 统一的插件接口和扩展机制</li>
</ul>
<h3 id="2-可扩展性"><a href="#2-可扩展性" class="headerlink" title="2. 可扩展性"></a>2. 可扩展性</h3><ul>
<li><strong>插件架构</strong>: 支持第三方插件和自定义扩展</li>
<li><strong>协议扩展</strong>: 支持多种消息协议</li>
<li><strong>认证扩展</strong>: 支持多种认证后端</li>
</ul>
<h3 id="3-企业级特性"><a href="#3-企业级特性" class="headerlink" title="3. 企业级特性"></a>3. 企业级特性</h3><ul>
<li><strong>高可用</strong>: 集群、联邦、分片支持</li>
<li><strong>安全性</strong>: 多种认证、授权、加密机制</li>
<li><strong>监控</strong>: 全面的监控和诊断工具</li>
<li><strong>管理</strong>: 完善的管理界面和 CLI 工具</li>
</ul>
<h3 id="4-现代化技术栈"><a href="#4-现代化技术栈" class="headerlink" title="4. 现代化技术栈"></a>4. 现代化技术栈</h3><ul>
<li><strong>一致性</strong>: 基于 Raft 算法的强一致性</li>
<li><strong>性能</strong>: 高性能日志存储和批处理</li>
<li><strong>云原生</strong>: 支持容器化和云环境部署</li>
<li><strong>标准化</strong>: 遵循行业标准和最佳实践</li>
</ul>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>RabbitMQ 4.0.5 的 86 个依赖模块共同构成了一个功能完整、性能优异、高度可扩展的企业级消息代理系统。这些模块按功能可分为：</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>模块数量</th>
<th>代表模块</th>
</tr>
</thead>
<tbody><tr>
<td>核心架构</td>
<td>3</td>
<td>rabbit, rabbit_common, amqp_client</td>
</tr>
<tr>
<td>分布式存储</td>
<td>4</td>
<td>ra, osiris, khepri, khepri_mnesia_migration</td>
</tr>
<tr>
<td>协议支持</td>
<td>5</td>
<td>rabbitmq_mqtt, rabbitmq_stomp, rabbitmq_stream</td>
</tr>
<tr>
<td>管理监控</td>
<td>5</td>
<td>rabbitmq_management, rabbitmq_prometheus, rabbitmq_cli</td>
</tr>
<tr>
<td>认证授权</td>
<td>5</td>
<td>rabbitmq_auth_backend_oauth2, rabbitmq_auth_backend_ldap</td>
</tr>
<tr>
<td>集群发现</td>
<td>5</td>
<td>rabbitmq_peer_discovery_k8s, rabbitmq_peer_discovery_consul</td>
</tr>
<tr>
<td>交换器插件</td>
<td>5</td>
<td>rabbitmq_consistent_hash_exchange, rabbitmq_random_exchange</td>
</tr>
<tr>
<td>联邦复制</td>
<td>6</td>
<td>rabbitmq_federation, rabbitmq_shovel</td>
</tr>
<tr>
<td>Web网络</td>
<td>10</td>
<td>cowboy, ranch, rabbitmq_web_dispatch</td>
</tr>
<tr>
<td>安全加密</td>
<td>4</td>
<td>jose, credentials_obfuscation</td>
</tr>
<tr>
<td>工具实用</td>
<td>10</td>
<td>cuttlefish, recon, observer_cli</td>
</tr>
<tr>
<td>其他辅助</td>
<td>24</td>
<td>aten, gen_batch_server, horus</td>
</tr>
</tbody></table>
<p>这种精心设计的模块化架构体现了 RabbitMQ 在消息中间件领域的技术领先地位，为企业级应用提供了可靠、高效的消息传递解决方案。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2026/01/16/rabbitmq-rabbitmq-queue-declare-flow-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/16/rabbitmq-rabbitmq-queue-declare-flow-analysis/" class="post-title-link" itemprop="url">RabbitMQ 队列声明流程深度分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-16 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-16T00:00:00+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-18 12:46:33" itemprop="dateModified" datetime="2026-01-18T12:46:33+08:00">2026-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RabbitMQ-队列声明流程深度分析"><a href="#RabbitMQ-队列声明流程深度分析" class="headerlink" title="RabbitMQ 队列声明流程深度分析"></a>RabbitMQ 队列声明流程深度分析</h1><h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><p>本文档深入分析 RabbitMQ 队列声明（<code>rabbit_amqqueue:declare/6</code>）的完整执行流程，基于以下示例命令：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(rabbit@debian-<span class="number">1</span>)<span class="number">1</span>&gt; rabbit_amqqueue:declare(</span><br><span class="line">    rabbit_misc:r(&lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;, queue, &lt;&lt;<span class="string">&quot;testqueue2&quot;</span>&gt;&gt;),</span><br><span class="line">    <span class="literal">false</span>,      <span class="comment">% Durable</span></span><br><span class="line">    <span class="literal">false</span>,      <span class="comment">% AutoDelete</span></span><br><span class="line">    [],         <span class="comment">% Args</span></span><br><span class="line">    none,       <span class="comment">% Owner</span></span><br><span class="line">    &lt;&lt;<span class="string">&quot;acting-user&quot;</span>&gt;&gt;  <span class="comment">% ActingUser</span></span><br><span class="line">).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 返回结果</span></span><br><span class="line">&#123;new, &#123;amqqueue, &#123;resource,&lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;,queue,&lt;&lt;<span class="string">&quot;testqueue2&quot;</span>&gt;&gt;&#125;,</span><br><span class="line">                 false, false, none, [], &lt;<span class="number">0.862</span>.<span class="number">0</span>&gt;, [], [], [],</span><br><span class="line">                 undefined, undefined, [], [], live, <span class="number">0</span>, [], &lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;,</span><br><span class="line">                 #&#123;user =&gt; &lt;&lt;<span class="string">&quot;acting-user&quot;</span>&gt;&gt;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-流程架构图"><a href="#2-流程架构图" class="headerlink" title="2. 流程架构图"></a>2. 流程架构图</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        <span class="title class_">Queue</span> <span class="title class_">Declaration</span> <span class="title class_">Flow</span>                                │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                              │</span><br><span class="line">│  ┌──────────────┐    ┌─────────────────┐    ┌──────────────────────┐       │</span><br><span class="line">│  │ rabbit_misc  │───▶│ rabbit_amqqueue │───▶│ rabbit_queue_type    │       │</span><br><span class="line">│  │    <span class="symbol">:r/</span><span class="number">3</span>      │    │   <span class="symbol">:declare/</span><span class="number">6</span>    │    │     <span class="symbol">:declare/</span><span class="number">2</span>       │       │</span><br><span class="line">│  └──────────────┘    └─────────────────┘    └──────────────────────┘       │</span><br><span class="line">│         │                    │                        │                     │</span><br><span class="line">│         ▼                    ▼                        ▼                     │</span><br><span class="line">│  ┌──────────────┐    ┌─────────────────┐    ┌──────────────────────┐       │</span><br><span class="line">│  │   <span class="comment">#resource  │    │    amqqueue     │    │ rabbit_classic_queue │       │</span></span><br><span class="line">│  │    record    │    │     <span class="symbol">:new/</span><span class="number">9</span>      │    │     <span class="symbol">:declare/</span><span class="number">2</span>       │       │</span><br><span class="line">│  └──────────────┘    └─────────────────┘    └──────────────────────┘       │</span><br><span class="line">│                              │                        │                     │</span><br><span class="line">│                              ▼                        ▼                     │</span><br><span class="line">│                      ┌─────────────────┐    ┌──────────────────────┐       │</span><br><span class="line">│                      │ rabbit_policy   │    │rabbit_amqqueue_sup_sup│      │</span><br><span class="line">│                      │     <span class="symbol">:set/</span><span class="number">1</span>      │    │<span class="symbol">:start_queue_process/</span><span class="number">2</span>│       │</span><br><span class="line">│                      └─────────────────┘    └──────────────────────┘       │</span><br><span class="line">│                              │                        │                     │</span><br><span class="line">│                              ▼                        ▼                     │</span><br><span class="line">│                      ┌─────────────────┐    ┌──────────────────────┐       │</span><br><span class="line">│                      │rabbit_queue_    │    │ rabbit_amqqueue_sup  │       │</span><br><span class="line">│                      │  <span class="symbol">decorator:</span>set  │    │    <span class="symbol">:start_link/</span><span class="number">2</span>     │       │</span><br><span class="line">│                      └─────────────────┘    └──────────────────────┘       │</span><br><span class="line">│                                                       │                     │</span><br><span class="line">│                                                       ▼                     │</span><br><span class="line">│                                             ┌──────────────────────┐       │</span><br><span class="line">│                                             │rabbit_amqqueue_process│      │</span><br><span class="line">│                                             │    <span class="symbol">:start_link/</span><span class="number">2</span>      │       │</span><br><span class="line">│                                             └──────────────────────┘       │</span><br><span class="line">│                                                       │                     │</span><br><span class="line">│                                                       ▼                     │</span><br><span class="line">│                                             ┌──────────────────────┐       │</span><br><span class="line">│                                             │    <span class="symbol">gen_server2:</span>call  │       │</span><br><span class="line">│                                             │    &#123;init, new&#125;       │       │</span><br><span class="line">│                                             └──────────────────────┘       │</span><br><span class="line">│                                                       │                     │</span><br><span class="line">│                                                       ▼                     │</span><br><span class="line">│                                             ┌──────────────────────┐       │</span><br><span class="line">│                                             │ rabbit_db_queue      │       │</span><br><span class="line">│                                             │   <span class="symbol">:create_or_get/</span><span class="number">1</span>   │       │</span><br><span class="line">│                                             └──────────────────────┘       │</span><br><span class="line">│                                                       │                     │</span><br><span class="line">│                                                       ▼                     │</span><br><span class="line">│                                             ┌──────────────────────┐       │</span><br><span class="line">│                                             │   <span class="title class_">Mnesia</span> / <span class="title class_">Khepri</span>    │       │</span><br><span class="line">│                                             │     持久化存储        │       │</span><br><span class="line">│                                             └──────────────────────┘       │</span><br><span class="line">│                                                                              │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-详细流程分析"><a href="#3-详细流程分析" class="headerlink" title="3. 详细流程分析"></a>3. 详细流程分析</h2><h3 id="3-1-阶段一：资源名称构建-rabbit-misc-r-3"><a href="#3-1-阶段一：资源名称构建-rabbit-misc-r-3" class="headerlink" title="3.1 阶段一：资源名称构建 (rabbit_misc:r/3)"></a>3.1 阶段一：资源名称构建 (<code>rabbit_misc:r/3</code>)</h3><h4 id="源码位置"><a href="#源码位置" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit_common/src/rabbit_misc.erl:413-419</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">r</span><span class="params">(#resource&#123;virtual_host = VHostPath&#125;, Kind, Name)</span> -&gt;</span></span><br><span class="line">    #resource&#123;virtual_host = VHostPath, kind = Kind, name = Name&#125;;</span><br><span class="line"><span class="function"><span class="title">r</span><span class="params">(VHostPath, Kind, Name)</span> -&gt;</span></span><br><span class="line">    #resource&#123;virtual_host = VHostPath, kind = Kind, name = Name&#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">r</span><span class="params">(VHostPath, Kind)</span> -&gt;</span></span><br><span class="line">    #resource&#123;virtual_host = VHostPath, kind = Kind, name = &#x27;_&#x27;&#125;.</span><br></pre></td></tr></table></figure>

<h4 id="功能说明"><a href="#功能说明" class="headerlink" title="功能说明"></a>功能说明</h4><ul>
<li><strong>输入</strong>: <code>&lt;&lt;&quot;/&quot;&gt;&gt;</code>, <code>queue</code>, <code>&lt;&lt;&quot;testqueue2&quot;&gt;&gt;</code></li>
<li><strong>输出</strong>: <code>#resource{virtual_host = &lt;&lt;&quot;/&quot;&gt;&gt;, kind = queue, name = &lt;&lt;&quot;testqueue2&quot;&gt;&gt;}</code></li>
</ul>
<h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-record</span><span class="params">(resource, &#123;</span></span><br><span class="line"><span class="params">    virtual_host :: binary(),  <span class="comment">% VHost 名称</span></span></span><br><span class="line"><span class="params">    kind :: queue | exchange,  <span class="comment">% 资源类型</span></span></span><br><span class="line"><span class="params">    name :: binary()           <span class="comment">% 资源名称</span></span></span><br><span class="line"><span class="params">&#125;)</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-2-阶段二：队列声明入口-rabbit-amqqueue-declare-6"><a href="#3-2-阶段二：队列声明入口-rabbit-amqqueue-declare-6" class="headerlink" title="3.2 阶段二：队列声明入口 (rabbit_amqqueue:declare/6)"></a>3.2 阶段二：队列声明入口 (<code>rabbit_amqqueue:declare/6</code>)</h3><h4 id="源码位置-1"><a href="#源码位置-1" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/rabbit_amqqueue.erl:201-250</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">declare</span><span class="params">(QueueName, Durable, AutoDelete, Args, Owner, ActingUser)</span> -&gt;</span></span><br><span class="line">    declare(QueueName, Durable, AutoDelete, Args, Owner, ActingUser, node()).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">declare</span><span class="params">(QueueName = #resource&#123;virtual_host = VHost&#125;, Durable, AutoDelete, Args,</span></span></span><br><span class="line"><span class="params"><span class="function">        Owner, ActingUser, Node)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 1. 获取默认队列类型</span></span><br><span class="line">    DQT = rabbit_vhost:default_queue_type(VHost, rabbit_queue_type:fallback()),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 2. 验证声明参数</span></span><br><span class="line">    ok = check_declare_arguments(QueueName, Args, DQT),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 3. 确定队列类型</span></span><br><span class="line">    Type = get_queue_type(Args, DQT),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 4. 检查队列类型是否启用</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_queue_type:is_enabled(Type) <span class="keyword">of</span></span><br><span class="line">        <span class="literal">true</span> -&gt;</span><br><span class="line">            <span class="comment">%% 5. 创建 amqqueue 记录</span></span><br><span class="line">            Q = amqqueue:new(QueueName,</span><br><span class="line">                             none,           <span class="comment">% pid (初始为 none)</span></span><br><span class="line">                             Durable,</span><br><span class="line">                             AutoDelete,</span><br><span class="line">                             Owner,</span><br><span class="line">                             Args,</span><br><span class="line">                             VHost,</span><br><span class="line">                             #&#123;user =&gt; ActingUser&#125;,</span><br><span class="line">                             Type),</span><br><span class="line">            <span class="comment">%% 6. 检查参数组合是否允许</span></span><br><span class="line">            <span class="keyword">case</span> is_queue_args_combination_permitted(Q) <span class="keyword">of</span></span><br><span class="line">                <span class="literal">true</span> -&gt;</span><br><span class="line">                    <span class="comment">%% 7. 委托给队列类型模块处理</span></span><br><span class="line">                    rabbit_queue_type:declare(Q, Node);</span><br><span class="line">                <span class="literal">false</span> -&gt;</span><br><span class="line">                    &#123;protocol_error, internal_error, <span class="string">&quot;~ts&quot;</span>, [Warning]&#125;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        <span class="literal">false</span> -&gt;</span><br><span class="line">            &#123;protocol_error, internal_error, <span class="string">&quot;...&quot;</span>, [...]&#125;</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<h4 id="关键步骤详解"><a href="#关键步骤详解" class="headerlink" title="关键步骤详解"></a>关键步骤详解</h4><h5 id="3-2-1-获取默认队列类型"><a href="#3-2-1-获取默认队列类型" class="headerlink" title="3.2.1 获取默认队列类型"></a>3.2.1 获取默认队列类型</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_vhost.erl</span></span><br><span class="line"><span class="function"><span class="title">default_queue_type</span><span class="params">(VHost, DefaultQT)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> lookup(VHost) <span class="keyword">of</span></span><br><span class="line">        &#123;ok, VHostRec&#125; -&gt;</span><br><span class="line">            <span class="keyword">case</span> vhost:get_default_queue_type(VHostRec) <span class="keyword">of</span></span><br><span class="line">                undefined -&gt; DefaultQT;</span><br><span class="line">                DQT -&gt; rabbit_queue_type:discover(DQT)</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        &#123;error, _&#125; -&gt;</span><br><span class="line">            DefaultQT</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">%% rabbit_queue_type.erl</span></span><br><span class="line"><span class="function"><span class="title">fallback</span><span class="params">()</span> -&gt;</span> rabbit_classic_queue.</span><br></pre></td></tr></table></figure>

<h5 id="3-2-2-验证声明参数"><a href="#3-2-2-验证声明参数" class="headerlink" title="3.2.2 验证声明参数"></a>3.2.2 验证声明参数</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_amqqueue.erl:849-859</span></span><br><span class="line"><span class="function"><span class="title">check_declare_arguments</span><span class="params">(QueueName, Args0, DefaultQueueType)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 注入默认队列类型</span></span><br><span class="line">    Args = maybe_inject_default_queue_type_shortcut_into_args(Args0, DefaultQueueType),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 检查 x-queue-type 参数</span></span><br><span class="line">    check_arguments_type_and_value(QueueName, Args, </span><br><span class="line">        [&#123;&lt;&lt;<span class="string">&quot;x-queue-type&quot;</span>&gt;&gt;, fun check_queue_type/2&#125;]),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 获取队列类型</span></span><br><span class="line">    Type = get_queue_type(Args),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 获取该类型支持的参数</span></span><br><span class="line">    QueueTypeArgs = rabbit_queue_type:arguments(queue_arguments, Type),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 验证参数类型和值</span></span><br><span class="line">    Validators = lists:filter(</span><br><span class="line">        <span class="keyword">fun</span>(&#123;Arg, _&#125;) -&gt; lists:member(Arg, QueueTypeArgs) <span class="keyword">end</span>, </span><br><span class="line">        declare_args()),</span><br><span class="line">    check_arguments_type_and_value(QueueName, Args, Validators),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 检查无效参数</span></span><br><span class="line">    InvalidArgs = rabbit_queue_type:arguments(queue_arguments) -- QueueTypeArgs,</span><br><span class="line">    check_arguments_key(QueueName, Type, Args, InvalidArgs).</span><br></pre></td></tr></table></figure>

<h5 id="3-2-3-确定队列类型"><a href="#3-2-3-确定队列类型" class="headerlink" title="3.2.3 确定队列类型"></a>3.2.3 确定队列类型</h5><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_amqqueue.erl:261-273</span></span><br><span class="line"><span class="function"><span class="title">get_queue_type</span><span class="params">([], DefaultQueueType)</span> -&gt;</span></span><br><span class="line">    rabbit_queue_type:discover(DefaultQueueType);</span><br><span class="line"><span class="function"><span class="title">get_queue_type</span><span class="params">(Args, DefaultQueueType)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_misc:table_lookup(Args, &lt;&lt;<span class="string">&quot;x-queue-type&quot;</span>&gt;&gt;) <span class="keyword">of</span></span><br><span class="line">        undefined -&gt;</span><br><span class="line">            rabbit_queue_type:discover(DefaultQueueType);</span><br><span class="line">        &#123;longstr, undefined&#125; -&gt;</span><br><span class="line">            rabbit_queue_type:discover(DefaultQueueType);</span><br><span class="line">        &#123;longstr, &lt;&lt;<span class="string">&quot;undefined&quot;</span>&gt;&gt;&#125; -&gt;</span><br><span class="line">            rabbit_queue_type:discover(DefaultQueueType);</span><br><span class="line">        &#123;_, V&#125; -&gt;</span><br><span class="line">            rabbit_queue_type:discover(V)</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<p><strong>队列类型映射关系</strong>：</p>
<table>
<thead>
<tr>
<th>参数值</th>
<th>模块</th>
</tr>
</thead>
<tbody><tr>
<td><code>classic</code></td>
<td><code>rabbit_classic_queue</code></td>
</tr>
<tr>
<td><code>quorum</code></td>
<td><code>rabbit_quorum_queue</code></td>
</tr>
<tr>
<td><code>stream</code></td>
<td><code>rabbit_stream_queue</code></td>
</tr>
</tbody></table>
<hr>
<h3 id="3-3-阶段三：创建-amqqueue-记录-amqqueue-new-9"><a href="#3-3-阶段三：创建-amqqueue-记录-amqqueue-new-9" class="headerlink" title="3.3 阶段三：创建 amqqueue 记录 (amqqueue:new/9)"></a>3.3 阶段三：创建 amqqueue 记录 (<code>amqqueue:new/9</code>)</h3><h4 id="源码位置-2"><a href="#源码位置-2" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/amqqueue.erl:215-319</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">new</span><span class="params">(#resource&#123;kind = queue&#125; = Name,</span></span></span><br><span class="line"><span class="params"><span class="function">    Pid,</span></span></span><br><span class="line"><span class="params"><span class="function">    Durable,</span></span></span><br><span class="line"><span class="params"><span class="function">    AutoDelete,</span></span></span><br><span class="line"><span class="params"><span class="function">    Owner,</span></span></span><br><span class="line"><span class="params"><span class="function">    Args,</span></span></span><br><span class="line"><span class="params"><span class="function">    VHost,</span></span></span><br><span class="line"><span class="params"><span class="function">    Options,</span></span></span><br><span class="line"><span class="params"><span class="function">    Type)</span></span></span><br><span class="line"><span class="function">  <span class="title">when</span> <span class="params">(is_pid(Pid) orelse is_tuple(Pid) orelse Pid =:= none)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="title">is_boolean</span><span class="params">(Durable)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="title">is_boolean</span><span class="params">(AutoDelete)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="params">(is_pid(Owner) orelse Owner =:= none)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="title">is_list</span><span class="params">(Args)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="params">(is_binary(VHost) orelse VHost =:= undefined)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="title">is_map</span><span class="params">(Options)</span> <span class="title">andalso</span></span></span><br><span class="line"><span class="function">       <span class="title">is_atom</span><span class="params">(Type)</span> -&gt;</span></span><br><span class="line">    new_with_version(</span><br><span class="line">      ?record_version,  <span class="comment">% amqqueue_v2</span></span><br><span class="line">      Name,</span><br><span class="line">      Pid,</span><br><span class="line">      Durable,</span><br><span class="line">      AutoDelete,</span><br><span class="line">      Owner,</span><br><span class="line">      Args,</span><br><span class="line">      VHost,</span><br><span class="line">      Options,</span><br><span class="line">      Type).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">new_with_version</span><span class="params">(?record_version, Name, Pid, Durable, AutoDelete,</span></span></span><br><span class="line"><span class="params"><span class="function">                 Owner, Args, VHost, Options, Type)</span> -&gt;</span></span><br><span class="line">    #amqqueue&#123;name            = Name,</span><br><span class="line">              durable         = Durable,</span><br><span class="line">              auto_delete     = AutoDelete,</span><br><span class="line">              arguments       = Args,</span><br><span class="line">              exclusive_owner = Owner,</span><br><span class="line">              pid             = Pid,</span><br><span class="line">              vhost           = VHost,</span><br><span class="line">              options         = Options,</span><br><span class="line">              type            = Type&#125;.</span><br></pre></td></tr></table></figure>

<h4 id="amqqueue-记录结构"><a href="#amqqueue-记录结构" class="headerlink" title="amqqueue 记录结构"></a>amqqueue 记录结构</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-record</span><span class="params">(amqqueue, &#123;</span></span><br><span class="line"><span class="params">    <span class="comment">%% 不可变字段</span></span></span><br><span class="line"><span class="params">    name :: rabbit_amqqueue:name() | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    durable :: boolean() | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    auto_delete :: boolean() | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    exclusive_owner = none :: pid() | none | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    arguments = [] :: rabbit_framing:amqp_table() | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    </span></span><br><span class="line"><span class="params">    <span class="comment">%% 可变字段</span></span></span><br><span class="line"><span class="params">    pid :: pid() | ra_server_id() | none | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    slave_pids = [],           <span class="comment">% 保留字段</span></span></span><br><span class="line"><span class="params">    sync_slave_pids = [],      <span class="comment">% 保留字段</span></span></span><br><span class="line"><span class="params">    recoverable_slaves = [],   <span class="comment">% 保留字段</span></span></span><br><span class="line"><span class="params">    </span></span><br><span class="line"><span class="params">    <span class="comment">%% 策略相关</span></span></span><br><span class="line"><span class="params">    policy :: proplists:proplist() | none | undefined | ets:match_pattern(),</span></span><br><span class="line"><span class="params">    operator_policy :: proplists:proplist() | none | undefined,</span></span><br><span class="line"><span class="params">    </span></span><br><span class="line"><span class="params">    <span class="comment">%% 运行时状态</span></span></span><br><span class="line"><span class="params">    gm_pids = [] :: [&#123;pid(), pid()&#125;] | none,</span></span><br><span class="line"><span class="params">    decorators :: [atom()] | none | undefined,</span></span><br><span class="line"><span class="params">    state = live :: atom(),</span></span><br><span class="line"><span class="params">    policy_version = <span class="number">0</span> :: non_neg_integer(),</span></span><br><span class="line"><span class="params">    type_state = #&#123;&#125; :: map(),</span></span><br><span class="line"><span class="params">    vhost :: binary() | undefined,</span></span><br><span class="line"><span class="params">    options = #&#123;&#125; :: map(),</span></span><br><span class="line"><span class="params">    type = rabbit_classic_queue :: module()</span></span><br><span class="line"><span class="params">&#125;)</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-4-阶段四：队列类型分发-rabbit-queue-type-declare-2"><a href="#3-4-阶段四：队列类型分发-rabbit-queue-type-declare-2" class="headerlink" title="3.4 阶段四：队列类型分发 (rabbit_queue_type:declare/2)"></a>3.4 阶段四：队列类型分发 (<code>rabbit_queue_type:declare/2</code>)</h3><h4 id="源码位置-3"><a href="#源码位置-3" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/rabbit_queue_type.erl:389-397</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-spec</span> declare<span class="params">(amqqueue:amqqueue(), node() | &#123;&#x27;ignore_location&#x27;, node()&#125;)</span> -&gt;</span><br><span class="line">    &#123;&#x27;new&#x27; | &#x27;existing&#x27; | &#x27;owner_died&#x27;, amqqueue:amqqueue<span class="params">()</span>&#125; |</span><br><span class="line">    &#123;&#x27;absent&#x27;, amqqueue:amqqueue<span class="params">()</span>, rabbit_amqqueue:absent_reason<span class="params">()</span>&#125; |</span><br><span class="line">    &#123;protocol_error, Type :: atom<span class="params">()</span>, Reason :: string<span class="params">()</span>, Args :: term<span class="params">()</span>&#125; |</span><br><span class="line">    &#123;&#x27;error&#x27;, Type :: atom<span class="params">()</span>, Reason :: string<span class="params">()</span>, Args :: term<span class="params">()</span>&#125; |</span><br><span class="line">    &#123;&#x27;error&#x27;, Err :: term<span class="params">()</span> &#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">declare</span><span class="params">(Q0, Node)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 1. 设置策略和装饰器</span></span><br><span class="line">    Q = rabbit_queue_decorator:set(rabbit_policy:set(Q0)),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 2. 获取队列类型模块</span></span><br><span class="line">    Mod = amqqueue:get_type(Q),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 3. 检查队列限制</span></span><br><span class="line">    <span class="keyword">case</span> check_queue_limits(Q) <span class="keyword">of</span></span><br><span class="line">        ok -&gt;</span><br><span class="line">            <span class="comment">%% 4. 调用具体类型的 declare</span></span><br><span class="line">            Mod:declare(Q, Node);</span><br><span class="line">        Error -&gt;</span><br><span class="line">            Error</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<h4 id="策略设置-rabbit-policy-set-1"><a href="#策略设置-rabbit-policy-set-1" class="headerlink" title="策略设置 (rabbit_policy:set/1)"></a>策略设置 (<code>rabbit_policy:set/1</code>)</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_policy.erl:94-105</span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(Q0)</span> <span class="title">when</span> ?<span class="title">is_amqqueue</span><span class="params">(Q0)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 匹配当前 VHost 的策略</span></span><br><span class="line">    Policy = match(Q0),</span><br><span class="line">    OpPolicy = match_op(Q0),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 设置策略到队列记录</span></span><br><span class="line">    Q1 = amqqueue:set_policy(Q0, Policy),</span><br><span class="line">    Q2 = amqqueue:set_operator_policy(Q1, OpPolicy),</span><br><span class="line">    Q2.</span><br></pre></td></tr></table></figure>

<h4 id="装饰器设置-rabbit-queue-decorator-set-1"><a href="#装饰器设置-rabbit-queue-decorator-set-1" class="headerlink" title="装饰器设置 (rabbit_queue_decorator:set/1)"></a>装饰器设置 (<code>rabbit_queue_decorator:set/1</code>)</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_queue_decorator.erl:42-44</span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(Q)</span> <span class="title">when</span> ?<span class="title">is_amqqueue</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 获取所有活跃的装饰器</span></span><br><span class="line">    Decorators = [D || D &lt;- list(), D:active_for(Q)],</span><br><span class="line">    amqqueue:set_decorators(Q, Decorators).</span><br></pre></td></tr></table></figure>

<h4 id="队列限制检查"><a href="#队列限制检查" class="headerlink" title="队列限制检查"></a>队列限制检查</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_queue_type.erl:876-895</span></span><br><span class="line"><span class="function"><span class="title">check_queue_limits</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">maybe</span></span><br><span class="line">        ok ?= check_vhost_queue_limit(Q),</span><br><span class="line">        ok ?= check_cluster_queue_limit(Q)</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_vhost_queue_limit</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    #resource&#123;name = QueueName&#125; = amqqueue:get_name(Q),</span><br><span class="line">    VHost = amqqueue:get_vhost(Q),</span><br><span class="line">    <span class="keyword">case</span> rabbit_vhost_limit:is_over_queue_limit(VHost) <span class="keyword">of</span></span><br><span class="line">        <span class="literal">false</span> -&gt; ok;</span><br><span class="line">        &#123;true, Limit&#125; -&gt;</span><br><span class="line">            queue_limit_error(<span class="string">&quot;cannot declare queue &#x27;~ts&#x27;: &quot;</span></span><br><span class="line">                <span class="string">&quot;queue limit in vhost &#x27;~ts&#x27; (~tp) is reached&quot;</span>,</span><br><span class="line">                [QueueName, VHost, Limit])</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-5-阶段五：Classic-队列声明-rabbit-classic-queue-declare-2"><a href="#3-5-阶段五：Classic-队列声明-rabbit-classic-queue-declare-2" class="headerlink" title="3.5 阶段五：Classic 队列声明 (rabbit_classic_queue:declare/2)"></a>3.5 阶段五：Classic 队列声明 (<code>rabbit_classic_queue:declare/2</code>)</h3><h4 id="源码位置-4"><a href="#源码位置-4" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/rabbit_classic_queue.erl:120-146</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">declare</span><span class="params">(Q, Node)</span> <span class="title">when</span> ?<span class="title">amqqueue_is_classic</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> validate_arguments(amqqueue:get_arguments(Q)) <span class="keyword">of</span></span><br><span class="line">        ok -&gt; do_declare(Q, Node);</span><br><span class="line">        Error -&gt; Error</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">do_declare</span><span class="params">(Q, Node)</span> <span class="title">when</span> ?<span class="title">amqqueue_is_classic</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    QName = amqqueue:get_name(Q),</span><br><span class="line">    VHost = amqqueue:get_vhost(Q),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 1. 确定队列所在节点</span></span><br><span class="line">    Node1 = <span class="keyword">case</span> &#123;Node, rabbit_amqqueue:is_exclusive(Q)&#125; <span class="keyword">of</span></span><br><span class="line">        &#123;&#123;ignore_location, Node0&#125;, _&#125; -&gt;</span><br><span class="line">            Node0;</span><br><span class="line">        &#123;_, true&#125; -&gt;</span><br><span class="line">            Node;  <span class="comment">% 独占队列在当前节点</span></span><br><span class="line">        _ -&gt;</span><br><span class="line">            <span class="comment">%% 使用位置选择策略</span></span><br><span class="line">            &#123;Node0, _&#125; = rabbit_queue_location:select_leader_and_followers(Q, <span class="number">1</span>),</span><br><span class="line">            Node0</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 2. 检查 VHost 是否存在</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_vhost_sup_sup:get_vhost_sup(VHost, Node1) <span class="keyword">of</span></span><br><span class="line">        &#123;ok, _&#125; -&gt;</span><br><span class="line">            <span class="comment">%% 3. 启动队列进程并等待初始化</span></span><br><span class="line">            gen_server2:call(</span><br><span class="line">                rabbit_amqqueue_sup_sup:start_queue_process(Node1, Q),</span><br><span class="line">                &#123;init, new&#125;, </span><br><span class="line">                infinity);</span><br><span class="line">        &#123;error, Error&#125; -&gt;</span><br><span class="line">            &#123;protocol_error, internal_error, </span><br><span class="line">             <span class="string">&quot;Cannot declare a queue &#x27;~ts&#x27; on node &#x27;~ts&#x27;: ~255p&quot;</span>,</span><br><span class="line">             [rabbit_misc:rs(QName), Node1, Error]&#125;</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-6-阶段六：启动队列进程"><a href="#3-6-阶段六：启动队列进程" class="headerlink" title="3.6 阶段六：启动队列进程"></a>3.6 阶段六：启动队列进程</h3><h4 id="3-6-1-启动队列进程-rabbit-amqqueue-sup-sup-start-queue-process-2"><a href="#3-6-1-启动队列进程-rabbit-amqqueue-sup-sup-start-queue-process-2" class="headerlink" title="3.6.1 启动队列进程 (rabbit_amqqueue_sup_sup:start_queue_process/2)"></a>3.6.1 启动队列进程 (<code>rabbit_amqqueue_sup_sup:start_queue_process/2</code>)</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_amqqueue_sup_sup.erl:32-36</span></span><br><span class="line"><span class="function"><span class="title">start_queue_process</span><span class="params">(Node, Q)</span> -&gt;</span></span><br><span class="line">    #resource&#123;virtual_host = VHost&#125; = amqqueue:get_name(Q),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 找到 VHost 的队列监督者</span></span><br><span class="line">    &#123;ok, Sup&#125; = find_for_vhost(VHost, Node),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 启动新的队列子进程</span></span><br><span class="line">    &#123;ok, _SupPid, QPid&#125; = supervisor:start_child(Sup, [Q, declare]),</span><br><span class="line">    QPid.</span><br></pre></td></tr></table></figure>

<h4 id="3-6-2-队列监督者初始化-rabbit-amqqueue-sup-start-link-2"><a href="#3-6-2-队列监督者初始化-rabbit-amqqueue-sup-start-link-2" class="headerlink" title="3.6.2 队列监督者初始化 (rabbit_amqqueue_sup:start_link/2)"></a>3.6.2 队列监督者初始化 (<code>rabbit_amqqueue_sup:start_link/2</code>)</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_amqqueue_sup.erl:23-37</span></span><br><span class="line"><span class="function"><span class="title">start_link</span><span class="params">(Q, _StartMode)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 创建 Marker 进程用于区分启动和重启</span></span><br><span class="line">    Marker = spawn_link(<span class="keyword">fun</span>() -&gt; <span class="keyword">receive</span> stop -&gt; ok <span class="keyword">end</span> <span class="keyword">end</span>),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 定义队列进程的启动规范</span></span><br><span class="line">    StartMFA = &#123;rabbit_amqqueue_process, start_link, [Q, Marker]&#125;,</span><br><span class="line">    ChildSpec = #&#123;id =&gt; rabbit_amqqueue,</span><br><span class="line">                  start =&gt; StartMFA,</span><br><span class="line">                  restart =&gt; transient,</span><br><span class="line">                  significant =&gt; true,</span><br><span class="line">                  shutdown =&gt; ?CLASSIC_QUEUE_WORKER_WAIT,</span><br><span class="line">                  type =&gt; worker,</span><br><span class="line">                  modules =&gt; [rabbit_amqqueue_process]&#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 启动监督者</span></span><br><span class="line">    &#123;ok, SupPid&#125; = supervisor:start_link(?MODULE, []),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 启动队列进程</span></span><br><span class="line">    &#123;ok, QPid&#125; = supervisor:start_child(SupPid, ChildSpec),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 清理 Marker</span></span><br><span class="line">    unlink(Marker),</span><br><span class="line">    Marker ! stop,</span><br><span class="line">    &#123;ok, SupPid, QPid&#125;.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-7-阶段七：队列进程初始化-rabbit-amqqueue-process"><a href="#3-7-阶段七：队列进程初始化-rabbit-amqqueue-process" class="headerlink" title="3.7 阶段七：队列进程初始化 (rabbit_amqqueue_process)"></a>3.7 阶段七：队列进程初始化 (<code>rabbit_amqqueue_process</code>)</h3><h4 id="源码位置-5"><a href="#源码位置-5" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/rabbit_amqqueue_process.erl:144-239</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% 启动入口</span></span><br><span class="line"><span class="function"><span class="title">start_link</span><span class="params">(Q, Marker)</span> -&gt;</span></span><br><span class="line">    gen_server2:start_link(?MODULE, &#123;Q, Marker&#125;, []).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 初始化</span></span><br><span class="line"><span class="function"><span class="title">init</span><span class="params">(&#123;Q, Marker&#125;)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> is_process_alive(Marker) <span class="keyword">of</span></span><br><span class="line">        <span class="literal">true</span>  -&gt;</span><br><span class="line">            <span class="comment">%% 正常启动</span></span><br><span class="line">            init(Q);</span><br><span class="line">        <span class="literal">false</span> -&gt;</span><br><span class="line">            <span class="comment">%% 重启场景</span></span><br><span class="line">            QueueName = amqqueue:get_name(Q),</span><br><span class="line">            &#123;ok, Q1&#125; = rabbit_amqqueue:lookup(QueueName),</span><br><span class="line">            gen_server2:cast(self(), init),</span><br><span class="line">            init(Q1)</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">init</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    process_flag(trap_exit, true),</span><br><span class="line">    ?store_proc_name(amqqueue:get_name(Q)),</span><br><span class="line">    &#123;ok, init_state(amqqueue:set_pid(Q, self())), hibernate,</span><br><span class="line">     &#123;backoff, ?HIBERNATE_AFTER_MIN, ?HIBERNATE_AFTER_MIN, ?DESIRED_HIBERNATE&#125;,</span><br><span class="line">    ?MODULE&#125;.</span><br></pre></td></tr></table></figure>

<h4 id="3-7-1-初始化状态"><a href="#3-7-1-初始化状态" class="headerlink" title="3.7.1 初始化状态"></a>3.7.1 初始化状态</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_amqqueue_process.erl:165-180</span></span><br><span class="line"><span class="function"><span class="title">init_state</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    SingleActiveConsumerOn = <span class="keyword">case</span> rabbit_misc:table_lookup(</span><br><span class="line">            amqqueue:get_arguments(Q), &lt;&lt;<span class="string">&quot;x-single-active-consumer&quot;</span>&gt;&gt;) <span class="keyword">of</span></span><br><span class="line">        &#123;bool, true&#125; -&gt; <span class="literal">true</span>;</span><br><span class="line">        _            -&gt; <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    State = #q&#123;q                         = Q,</span><br><span class="line">               active_consumer           = none,</span><br><span class="line">               has_had_consumers         = false,</span><br><span class="line">               consumers                 = rabbit_queue_consumers:new(),</span><br><span class="line">               senders                   = pmon:new(delegate),</span><br><span class="line">               msg_id_to_channel         = #&#123;&#125;,</span><br><span class="line">               status                    = running,</span><br><span class="line">               args_policy_version       = <span class="number">0</span>,</span><br><span class="line">               overflow                  = &#x27;drop-head&#x27;,</span><br><span class="line">               single_active_consumer_on = SingleActiveConsumerOn&#125;,</span><br><span class="line">    rabbit_event:init_stats_timer(State, #q.stats_timer).</span><br></pre></td></tr></table></figure>

<h4 id="3-7-2-处理-init-new-调用"><a href="#3-7-2-处理-init-new-调用" class="headerlink" title="3.7.2 处理 {init, new} 调用"></a>3.7.2 处理 <code>{init, new}</code> 调用</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% handle_call 会路由到 init_it/3</span></span><br><span class="line"><span class="function"><span class="title">init_it</span><span class="params">(Recover, From, State = #q&#123;q = Q&#125;)</span></span></span><br><span class="line"><span class="function">  <span class="title">when</span> ?<span class="title">amqqueue_exclusive_owner_is</span><span class="params">(Q, none)</span> -&gt;</span></span><br><span class="line">    init_it2(Recover, From, State);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">init_it2</span><span class="params">(Recover, From, State = #q&#123;q = Q,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   backing_queue = undefined,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   backing_queue_state = undefined&#125;)</span> -&gt;</span></span><br><span class="line">    &#123;Barrier, TermsOrNew&#125; = recovery_status(Recover),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 关键：内部声明，写入数据库</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_amqqueue:internal_declare(Q, Recover /= new) <span class="keyword">of</span></span><br><span class="line">        &#123;Res, Q1&#125; <span class="keyword">when</span> ?is_amqqueue(Q1) <span class="keyword">andalso</span></span><br><span class="line">                       (Res == created <span class="keyword">orelse</span> Res == existing) -&gt;</span><br><span class="line">            <span class="keyword">case</span> matches(Recover, Q, Q1) <span class="keyword">of</span></span><br><span class="line">                <span class="literal">true</span> -&gt;</span><br><span class="line">                    <span class="comment">%% 初始化 backing queue</span></span><br><span class="line">                    BQ = backing_queue_module(),</span><br><span class="line">                    BQS = bq_init(BQ, Q, TermsOrNew),</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">%% 回复调用者</span></span><br><span class="line">                    send_reply(From, &#123;new, Q&#125;),</span><br><span class="line">                    </span><br><span class="line">                    recovery_barrier(Barrier),</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">%% 处理策略和参数</span></span><br><span class="line">                    State1 = process_args_policy(</span><br><span class="line">                        State#q&#123;backing_queue = BQ,</span><br><span class="line">                                backing_queue_state = BQS&#125;),</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">%% 通知装饰器</span></span><br><span class="line">                    notify_decorators(startup, State),</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">%% 发送事件通知</span></span><br><span class="line">                    rabbit_event:notify(queue_created,</span><br><span class="line">                        queue_created_infos(State1)),</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">%% 发送统计信息</span></span><br><span class="line">                    rabbit_event:if_enabled(State1, #q.stats_timer,</span><br><span class="line">                        <span class="keyword">fun</span>() -&gt; emit_stats(State1) <span class="keyword">end</span>),</span><br><span class="line">                    </span><br><span class="line">                    noreply(State1);</span><br><span class="line">                <span class="literal">false</span> -&gt;</span><br><span class="line">                    &#123;stop, normal, &#123;existing, Q1&#125;, State&#125;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        &#123;error, timeout&#125; -&gt;</span><br><span class="line">            <span class="comment">%% 超时处理</span></span><br><span class="line">            ...;</span><br><span class="line">        Err -&gt;</span><br><span class="line">            &#123;stop, normal, Err, State&#125;</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-8-阶段八：数据库持久化-rabbit-amqqueue-internal-declare-2"><a href="#3-8-阶段八：数据库持久化-rabbit-amqqueue-internal-declare-2" class="headerlink" title="3.8 阶段八：数据库持久化 (rabbit_amqqueue:internal_declare/2)"></a>3.8 阶段八：数据库持久化 (<code>rabbit_amqqueue:internal_declare/2</code>)</h3><h4 id="源码位置-6"><a href="#源码位置-6" class="headerlink" title="源码位置"></a>源码位置</h4><p><code>deps/rabbit/src/rabbit_amqqueue.erl:275-302</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-spec</span> internal_declare<span class="params">(Queue, Recover)</span> -&gt; Ret when</span><br><span class="line">      Queue :: amqqueue:amqqueue<span class="params">()</span>,</span><br><span class="line">      Recover :: boolean<span class="params">()</span>,</span><br><span class="line">      Ret :: &#123;created | existing, amqqueue:amqqueue<span class="params">()</span>&#125; |</span><br><span class="line">             queue_absent<span class="params">()</span> |</span><br><span class="line">             rabbit_khepri:timeout_error<span class="params">()</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">internal_declare</span><span class="params">(Q, Recover)</span> -&gt;</span></span><br><span class="line">    do_internal_declare(Q, Recover).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 恢复模式</span></span><br><span class="line"><span class="function"><span class="title">do_internal_declare</span><span class="params">(Q0, true)</span> -&gt;</span></span><br><span class="line">    Q = amqqueue:set_state(Q0, live),</span><br><span class="line">    <span class="keyword">case</span> store_queue(Q) <span class="keyword">of</span></span><br><span class="line">        ok -&gt; &#123;created, Q0&#125;;</span><br><span class="line">        &#123;error, timeout&#125; = Err -&gt; Err</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 新建模式 (我们的示例走这条路径)</span></span><br><span class="line"><span class="function"><span class="title">do_internal_declare</span><span class="params">(Q0, false)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 1. 设置状态为 live</span></span><br><span class="line">    <span class="comment">%% 2. 应用策略</span></span><br><span class="line">    Q = rabbit_policy:set(amqqueue:set_state(Q0, live)),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 3. 设置装饰器</span></span><br><span class="line">    Queue = rabbit_queue_decorator:set(Q),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 4. 写入数据库</span></span><br><span class="line">    rabbit_db_queue:create_or_get(Queue).</span><br></pre></td></tr></table></figure>

<h4 id="数据库操作-rabbit-db-queue-create-or-get-1"><a href="#数据库操作-rabbit-db-queue-create-or-get-1" class="headerlink" title="数据库操作 (rabbit_db_queue:create_or_get/1)"></a>数据库操作 (<code>rabbit_db_queue:create_or_get/1</code>)</h4><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% rabbit_db_queue.erl:895-930</span></span><br><span class="line"><span class="function"><span class="title">create_or_get</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    rabbit_khepri:handle_fallback(</span><br><span class="line">      #&#123;mnesia =&gt; <span class="keyword">fun</span>() -&gt; create_or_get_in_mnesia(Q) <span class="keyword">end</span>,</span><br><span class="line">        khepri =&gt; <span class="keyword">fun</span>() -&gt; create_or_get_in_khepri(Q) <span class="keyword">end</span></span><br><span class="line">       &#125;).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% Mnesia 实现</span></span><br><span class="line"><span class="function"><span class="title">create_or_get_in_mnesia</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    DurableQ = amqqueue:reset_decorators(Q),</span><br><span class="line">    QueueName = amqqueue:get_name(Q),</span><br><span class="line">    rabbit_mnesia:execute_mnesia_transaction(</span><br><span class="line">      <span class="keyword">fun</span> () -&gt;</span><br><span class="line">              <span class="keyword">case</span> mnesia:wread(&#123;?MNESIA_TABLE, QueueName&#125;) <span class="keyword">of</span></span><br><span class="line">                  [] -&gt;</span><br><span class="line">                      <span class="comment">%% 队列不存在</span></span><br><span class="line">                      <span class="keyword">case</span> get_durable_in_mnesia_tx(QueueName) <span class="keyword">of</span></span><br><span class="line">                          &#123;error, not_found&#125; -&gt;</span><br><span class="line">                              <span class="comment">%% 创建新队列</span></span><br><span class="line">                              set_in_mnesia_tx(DurableQ, Q),</span><br><span class="line">                              &#123;created, Q&#125;;</span><br><span class="line">                          &#123;ok, QRecord&#125; -&gt;</span><br><span class="line">                              <span class="comment">%% 存在持久化记录但运行时不存在</span></span><br><span class="line">                              &#123;absent, QRecord, nodedown&#125;</span><br><span class="line">                      <span class="keyword">end</span>;</span><br><span class="line">                  [ExistingQ] -&gt;</span><br><span class="line">                      <span class="comment">%% 队列已存在</span></span><br><span class="line">                      &#123;existing, ExistingQ&#125;</span><br><span class="line">              <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span>).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% Khepri 实现</span></span><br><span class="line"><span class="function"><span class="title">create_or_get_in_khepri</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    QueueName = amqqueue:get_name(Q),</span><br><span class="line">    Path = khepri_queue_path(QueueName),</span><br><span class="line">    <span class="keyword">case</span> rabbit_khepri:adv_create(Path, Q) <span class="keyword">of</span></span><br><span class="line">        &#123;error, &#123;khepri, mismatching_node, #&#123;node_props := #&#123;data := ExistingQ&#125;&#125;&#125;&#125; -&gt;</span><br><span class="line">            &#123;existing, ExistingQ&#125;;</span><br><span class="line">        &#123;ok, _&#125; -&gt;</span><br><span class="line">            &#123;created, Q&#125;;</span><br><span class="line">        Error -&gt;</span><br><span class="line">            Error</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-进程监督树结构"><a href="#4-进程监督树结构" class="headerlink" title="4. 进程监督树结构"></a>4. 进程监督树结构</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rabbit_sup</span><br><span class="line">├── rabbit_vhost_sup_sup</span><br><span class="line">│   └── rabbit_vhost_sup (per VHost)</span><br><span class="line">│       └── rabbit_amqqueue_sup_sup</span><br><span class="line">│           └── rabbit_amqqueue_sup (per Queue)</span><br><span class="line">│               └── rabbit_amqqueue_process (队列工作进程)</span><br></pre></td></tr></table></figure>

<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">                    rabbit_sup</span><br><span class="line">                        │</span><br><span class="line">                        ▼</span><br><span class="line">              rabbit_vhost_sup_sup</span><br><span class="line">                        │</span><br><span class="line">                        ▼</span><br><span class="line">         ┌──────────────┼──────────────┐</span><br><span class="line">         ▼              ▼              ▼</span><br><span class="line">  rabbit_vhost_sup  rabbit_vhost_sup  ...</span><br><span class="line">   (vhost: /)       (vhost: test)</span><br><span class="line">         │</span><br><span class="line">         ▼</span><br><span class="line">rabbit_amqqueue_sup_sup</span><br><span class="line">         │</span><br><span class="line">         ├──────────────┬──────────────┐</span><br><span class="line">         ▼              ▼              ▼</span><br><span class="line">rabbit_amqqueue_sup  rabbit_amqqueue_sup  ...</span><br><span class="line">  (testqueue1)        (testqueue2)</span><br><span class="line">         │              │</span><br><span class="line">         ▼              ▼</span><br><span class="line">rabbit_amqqueue_     rabbit_amqqueue_</span><br><span class="line">    process              process</span><br><span class="line">   &lt;<span class="number">0.861</span><span class="selector-class">.0</span>&gt;           &lt;<span class="number">0.862</span><span class="selector-class">.0</span>&gt;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-返回结果解析"><a href="#5-返回结果解析" class="headerlink" title="5. 返回结果解析"></a>5. 返回结果解析</h2><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;new, &#123;amqqueue, &#123;resource,&lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;,queue,&lt;&lt;<span class="string">&quot;testqueue2&quot;</span>&gt;&gt;&#125;,</span><br><span class="line">                 false,        <span class="comment">% durable</span></span><br><span class="line">                 false,        <span class="comment">% auto_delete</span></span><br><span class="line">                 none,         <span class="comment">% exclusive_owner</span></span><br><span class="line">                 [],           <span class="comment">% arguments</span></span><br><span class="line">                 &lt;<span class="number">0.862</span>.<span class="number">0</span>&gt;,    <span class="comment">% pid (队列进程)</span></span><br><span class="line">                 [],           <span class="comment">% slave_pids (保留)</span></span><br><span class="line">                 [],           <span class="comment">% sync_slave_pids (保留)</span></span><br><span class="line">                 [],           <span class="comment">% recoverable_slaves (保留)</span></span><br><span class="line">                 undefined,    <span class="comment">% policy</span></span><br><span class="line">                 undefined,    <span class="comment">% operator_policy</span></span><br><span class="line">                 [],           <span class="comment">% gm_pids (保留)</span></span><br><span class="line">                 [],           <span class="comment">% decorators</span></span><br><span class="line">                 live,         <span class="comment">% state</span></span><br><span class="line">                 <span class="number">0</span>,            <span class="comment">% policy_version</span></span><br><span class="line">                 [],           <span class="comment">% type_state</span></span><br><span class="line">                 &lt;&lt;<span class="string">&quot;/&quot;</span>&gt;&gt;,      <span class="comment">% vhost</span></span><br><span class="line">                 #&#123;user =&gt; &lt;&lt;<span class="string">&quot;acting-user&quot;</span>&gt;&gt;&#125;&#125;&#125;  <span class="comment">% options</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>字段</th>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>结果类型</td>
<td><code>new</code></td>
<td>新创建的队列</td>
</tr>
<tr>
<td>name</td>
<td><code>{resource,&lt;&lt;&quot;/&quot;&gt;&gt;,queue,&lt;&lt;&quot;testqueue2&quot;&gt;&gt;}</code></td>
<td>队列资源标识</td>
</tr>
<tr>
<td>durable</td>
<td><code>false</code></td>
<td>非持久化队列</td>
</tr>
<tr>
<td>auto_delete</td>
<td><code>false</code></td>
<td>不自动删除</td>
</tr>
<tr>
<td>exclusive_owner</td>
<td><code>none</code></td>
<td>非独占队列</td>
</tr>
<tr>
<td>arguments</td>
<td><code>[]</code></td>
<td>无额外参数</td>
</tr>
<tr>
<td>pid</td>
<td><code>&lt;0.862.0&gt;</code></td>
<td>队列进程 PID</td>
</tr>
<tr>
<td>state</td>
<td><code>live</code></td>
<td>运行状态</td>
</tr>
<tr>
<td>vhost</td>
<td><code>&lt;&lt;&quot;/&quot;&gt;&gt;</code></td>
<td>所属 VHost</td>
</tr>
<tr>
<td>options</td>
<td><code>#{user =&gt; &lt;&lt;&quot;acting-user&quot;&gt;&gt;}</code></td>
<td>操作用户</td>
</tr>
</tbody></table>
<hr>
<h2 id="6-关键数据流图"><a href="#6-关键数据流图" class="headerlink" title="6. 关键数据流图"></a>6. 关键数据流图</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">输入参数</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_misc:r(<span class="operator">&lt;</span><span class="operator">&lt;</span><span class="string">&quot;/&quot;</span><span class="operator">&gt;</span><span class="operator">&gt;</span>, queue, <span class="operator">&lt;</span><span class="operator">&lt;</span><span class="string">&quot;testqueue2&quot;</span><span class="operator">&gt;</span><span class="operator">&gt;</span>)             │</span><br><span class="line">│     <span class="operator">=</span><span class="operator">&gt;</span> <span class="comment">#resource&#123;virtual_host = &lt;&lt;&quot;/&quot;&gt;&gt;,                    │</span></span><br><span class="line">│                  kind <span class="operator">=</span> queue,                              │</span><br><span class="line">│                  name <span class="operator">=</span> <span class="operator">&lt;</span><span class="operator">&lt;</span><span class="string">&quot;testqueue2&quot;</span><span class="operator">&gt;</span><span class="operator">&gt;</span>&#125;                   │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_amqqueue:declare<span class="symbol">/6</span>                                   │</span><br><span class="line">│   <span class="number">1</span>. check_declare_arguments<span class="symbol">/3</span>  ✓                           │</span><br><span class="line">│   <span class="number">2</span>. get_queue_type<span class="symbol">/2</span> <span class="operator">=</span><span class="operator">&gt;</span> rabbit_classic_queue               │</span><br><span class="line">│   <span class="number">3</span>. amqqueue:new<span class="symbol">/9</span> <span class="operator">=</span><span class="operator">&gt;</span> <span class="comment">#amqqueue&#123;...&#125;                       │</span></span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_queue_type:declare<span class="symbol">/2</span>                                 │</span><br><span class="line">│   <span class="number">1</span>. rabbit_policy:set<span class="symbol">/1</span> <span class="operator">=</span><span class="operator">&gt;</span> 应用策略                         │</span><br><span class="line">│   <span class="number">2</span>. rabbit_queue_decorator:set<span class="symbol">/1</span> <span class="operator">=</span><span class="operator">&gt;</span> 设置装饰器              │</span><br><span class="line">│   <span class="number">3</span>. check_queue_limits<span class="symbol">/1</span> ✓                                 │</span><br><span class="line">│   <span class="number">4</span>. Mod:declare<span class="symbol">/2</span> <span class="operator">=</span><span class="operator">&gt;</span> rabbit_classic_queue:declare<span class="symbol">/2</span>        │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_classic_queue:declare<span class="symbol">/2</span>                              │</span><br><span class="line">│   <span class="number">1</span>. validate_arguments<span class="symbol">/1</span> ✓                                 │</span><br><span class="line">│   <span class="number">2</span>. select_leader_and_followers<span class="symbol">/2</span> <span class="operator">=</span><span class="operator">&gt;</span> 选择节点               │</span><br><span class="line">│   <span class="number">3</span>. rabbit_amqqueue_sup_sup:start_queue_process<span class="symbol">/2</span>          │</span><br><span class="line">│   <span class="number">4</span>. gen_server2:call(&#123;init, new&#125;, infinity)                │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_amqqueue_process                                     │</span><br><span class="line">│   <span class="number">1</span>. init<span class="symbol">/1</span> <span class="operator">=</span><span class="operator">&gt;</span> 初始化进程状态                                │</span><br><span class="line">│   <span class="number">2</span>. handle_call(&#123;init, new&#125;, ...) <span class="operator">=</span><span class="operator">&gt;</span> init_it2<span class="symbol">/3</span>            │</span><br><span class="line">│   <span class="number">3</span>. rabbit_amqqueue:internal_declare<span class="symbol">/2</span>                     │</span><br><span class="line">│   <span class="number">4</span>. rabbit_db_queue:create_or_get<span class="symbol">/1</span>                        │</span><br><span class="line">│   <span class="number">5</span>. 初始化 backing_queue                                   │</span><br><span class="line">│   <span class="number">6</span>. 发送 queue_created 事件                                 │</span><br><span class="line">│   <span class="number">7</span>. 返回 &#123;new, Q&#125;                                          │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ rabbit_db_queue:create_or_get<span class="symbol">/1</span>                             │</span><br><span class="line">│   <span class="params">Mnesia:</span> mnesia:wread <span class="operator">+</span> mnesia:write                       │</span><br><span class="line">│   <span class="params">Khepri:</span> rabbit_khepri:adv_create                          │</span><br><span class="line">│   <span class="operator">=</span><span class="operator">&gt;</span> &#123;created, Q&#125; | &#123;existing, Q&#125;                           │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line">返回结果: &#123;new, <span class="comment">#amqqueue&#123;...&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-时序图"><a href="#7-时序图" class="headerlink" title="7. 时序图"></a>7. 时序图</h2><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Client          rabbit_amqqueue    rabbit_queue_type   rabbit_classic_queue</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line">   │  <span class="keyword">declare</span>/<span class="number">6</span>        │                   │                    │</span><br><span class="line">   │──────────────────▶│                   │                    │</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line">   │                   │ check_arguments   │                    │</span><br><span class="line">   │                   │◀─────────────────▶│                    │</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line">   │                   │ amqqueue:<span class="keyword">new</span>/<span class="number">9</span>    │                    │</span><br><span class="line">   │                   │──────────────────▶│                    │</span><br><span class="line">   │                   │◀──────────────────│                    │</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line">   │                   │ <span class="keyword">declare</span>/<span class="number">2</span>         │                    │</span><br><span class="line">   │                   │──────────────────▶│                    │</span><br><span class="line">   │                   │                   │ <span class="keyword">declare</span>/<span class="number">2</span>          │</span><br><span class="line">   │                   │                   │───────────────────▶│</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line">   │                   │                   │                    │</span><br><span class="line"></span><br><span class="line">rabbit_classic_queue   rabbit_amqqueue_sup_sup   rabbit_amqqueue_process   rabbit_db_queue</span><br><span class="line">         │                      │                        │                      │</span><br><span class="line">         │ start_queue_process  │                        │                      │</span><br><span class="line">         │─────────────────────▶│                        │                      │</span><br><span class="line">         │                      │ supervisor:start_child │                      │</span><br><span class="line">         │                      │───────────────────────▶│                      │</span><br><span class="line">         │                      │◀───────────────────────│                      │</span><br><span class="line">         │◀─────────────────────│                        │                      │</span><br><span class="line">         │                      │                        │                      │</span><br><span class="line">         │ gen_server2:<span class="keyword">call</span>     │                        │                      │</span><br><span class="line">         │  &#123;init, <span class="keyword">new</span>&#125;         │                        │                      │</span><br><span class="line">         │───────────────────────────────────────────────▶│                      │</span><br><span class="line">         │                      │                        │ internal_declare     │</span><br><span class="line">         │                      │                        │─────────────────────▶│</span><br><span class="line">         │                      │                        │ create_or_get        │</span><br><span class="line">         │                      │                        │─────────────────────▶│</span><br><span class="line">         │                      │                        │◀─────────────────────│</span><br><span class="line">         │                      │                        │ &#123;created, Q&#125;         │</span><br><span class="line">         │◀───────────────────────────────────────────────│                      │</span><br><span class="line">         │ &#123;<span class="keyword">new</span>, Q&#125;             │                        │                      │</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-队列类型对比"><a href="#8-队列类型对比" class="headerlink" title="8. 队列类型对比"></a>8. 队列类型对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>Classic Queue</th>
<th>Quorum Queue</th>
<th>Stream Queue</th>
</tr>
</thead>
<tbody><tr>
<td>模块</td>
<td><code>rabbit_classic_queue</code></td>
<td><code>rabbit_quorum_queue</code></td>
<td><code>rabbit_stream_queue</code></td>
</tr>
<tr>
<td>存储</td>
<td><code>rabbit_variable_queue</code></td>
<td>Ra (Raft)</td>
<td>Osiris</td>
</tr>
<tr>
<td>持久化</td>
<td>可选</td>
<td>强制</td>
<td>强制</td>
</tr>
<tr>
<td>复制</td>
<td>不支持</td>
<td>支持 (Raft)</td>
<td>支持</td>
</tr>
<tr>
<td>声明流程</td>
<td><code>gen_server2:call</code></td>
<td><code>ra:start_cluster</code></td>
<td><code>rabbit_stream_coordinator</code></td>
</tr>
</tbody></table>
<hr>
<h2 id="9-错误处理"><a href="#9-错误处理" class="headerlink" title="9. 错误处理"></a>9. 错误处理</h2><h3 id="9-1-常见错误类型"><a href="#9-1-常见错误类型" class="headerlink" title="9.1 常见错误类型"></a>9.1 常见错误类型</h3><table>
<thead>
<tr>
<th>错误</th>
<th>原因</th>
<th>处理</th>
</tr>
</thead>
<tbody><tr>
<td><code>{existing, Q}</code></td>
<td>队列已存在</td>
<td>返回现有队列</td>
</tr>
<tr>
<td><code>{absent, Q, nodedown}</code></td>
<td>节点宕机</td>
<td>返回缺席状态</td>
</tr>
<tr>
<td><code>{error, timeout}</code></td>
<td>数据库超时</td>
<td>返回超时错误</td>
</tr>
<tr>
<td><code>{protocol_error, ...}</code></td>
<td>参数验证失败</td>
<td>返回协议错误</td>
</tr>
</tbody></table>
<h3 id="9-2-队列限制检查"><a href="#9-2-队列限制检查" class="headerlink" title="9.2 队列限制检查"></a>9.2 队列限制检查</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%% VHost 队列数量限制</span></span><br><span class="line"><span class="function"><span class="title">check_vhost_queue_limit</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_vhost_limit:is_over_queue_limit(VHost) <span class="keyword">of</span></span><br><span class="line">        <span class="literal">false</span> -&gt; ok;</span><br><span class="line">        &#123;true, Limit&#125; -&gt; queue_limit_error(...)</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 集群队列数量限制</span></span><br><span class="line"><span class="function"><span class="title">check_cluster_queue_limit</span><span class="params">(Q)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> rabbit_misc:get_env(rabbit, cluster_queue_limit, infinity) <span class="keyword">of</span></span><br><span class="line">        infinity -&gt; ok;</span><br><span class="line">        Limit <span class="keyword">when</span> Count &gt;= Limit -&gt; queue_limit_error(...);</span><br><span class="line">        _ -&gt; ok</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="10-总结"><a href="#10-总结" class="headerlink" title="10. 总结"></a>10. 总结</h2><h3 id="10-1-完整调用链"><a href="#10-1-完整调用链" class="headerlink" title="10.1 完整调用链"></a>10.1 完整调用链</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">rabbit_misc:r<span class="symbol">/3</span></span><br><span class="line">    ↓</span><br><span class="line">rabbit_amqqueue:declare<span class="symbol">/6</span></span><br><span class="line">    ↓</span><br><span class="line">rabbit_amqqueue:declare<span class="symbol">/7</span></span><br><span class="line">    ↓</span><br><span class="line">    ├── check_declare_arguments<span class="symbol">/3</span></span><br><span class="line">    ├── get_queue_type<span class="symbol">/2</span></span><br><span class="line">    ├── amqqueue:new<span class="symbol">/9</span></span><br><span class="line">    └── rabbit_queue_type:declare<span class="symbol">/2</span></span><br><span class="line">            ↓</span><br><span class="line">            ├── rabbit_policy:set<span class="symbol">/1</span></span><br><span class="line">            ├── rabbit_queue_decorator:set<span class="symbol">/1</span></span><br><span class="line">            ├── check_queue_limits<span class="symbol">/1</span></span><br><span class="line">            └── rabbit_classic_queue:declare<span class="symbol">/2</span></span><br><span class="line">                    ↓</span><br><span class="line">                    ├── validate_arguments<span class="symbol">/1</span></span><br><span class="line">                    ├── rabbit_queue_location:select_leader_and_followers<span class="symbol">/2</span></span><br><span class="line">                    ├── rabbit_amqqueue_sup_sup:start_queue_process<span class="symbol">/2</span></span><br><span class="line">                    │       ↓</span><br><span class="line">                    │       └── supervisor:start_child<span class="symbol">/2</span></span><br><span class="line">                    │               ↓</span><br><span class="line">                    │               └── rabbit_amqqueue_sup:start_link<span class="symbol">/2</span></span><br><span class="line">                    │                       ↓</span><br><span class="line">                    │                       └── rabbit_amqqueue_process:start_link<span class="symbol">/2</span></span><br><span class="line">                    └── gen_server2:call(&#123;init, new&#125;, infinity)</span><br><span class="line">                            ↓</span><br><span class="line">                            └── rabbit_amqqueue_process:init_it2<span class="symbol">/3</span></span><br><span class="line">                                    ↓</span><br><span class="line">                                    ├── rabbit_amqqueue:internal_declare<span class="symbol">/2</span></span><br><span class="line">                                    │       ↓</span><br><span class="line">                                    │       └── rabbit_db_queue:create_or_get<span class="symbol">/1</span></span><br><span class="line">                                    │               ↓</span><br><span class="line">                                    │               └── Mnesia<span class="symbol">/Khepri</span> 写入</span><br><span class="line">                                    ├── bq_init<span class="symbol">/3</span> (backing queue)</span><br><span class="line">                                    ├── notify_decorators<span class="symbol">/2</span></span><br><span class="line">                                    └── rabbit_event:notify(queue_created, ...)</span><br></pre></td></tr></table></figure>

<h3 id="10-2-关键模块职责"><a href="#10-2-关键模块职责" class="headerlink" title="10.2 关键模块职责"></a>10.2 关键模块职责</h3><table>
<thead>
<tr>
<th>模块</th>
<th>职责</th>
</tr>
</thead>
<tbody><tr>
<td><code>rabbit_misc</code></td>
<td>通用工具函数，资源名称构建</td>
</tr>
<tr>
<td><code>rabbit_amqqueue</code></td>
<td>队列管理 API 入口</td>
</tr>
<tr>
<td><code>rabbit_queue_type</code></td>
<td>队列类型抽象层，分发到具体实现</td>
</tr>
<tr>
<td><code>rabbit_classic_queue</code></td>
<td>Classic 队列类型实现</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_sup_sup</code></td>
<td>队列监督者的监督者</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_sup</code></td>
<td>单个队列的监督者</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_process</code></td>
<td>队列工作进程 (gen_server2)</td>
</tr>
<tr>
<td><code>rabbit_db_queue</code></td>
<td>队列数据库操作 (Mnesia&#x2F;Khepri)</td>
</tr>
<tr>
<td><code>rabbit_policy</code></td>
<td>策略匹配和应用</td>
</tr>
<tr>
<td><code>rabbit_queue_decorator</code></td>
<td>队列装饰器管理</td>
</tr>
<tr>
<td><code>amqqueue</code></td>
<td>队列记录定义和操作</td>
</tr>
</tbody></table>
<hr>
<h2 id="11-参考源文件"><a href="#11-参考源文件" class="headerlink" title="11. 参考源文件"></a>11. 参考源文件</h2><table>
<thead>
<tr>
<th>文件</th>
<th>代码行数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>rabbit_amqqueue.erl</code></td>
<td>2142</td>
<td>队列管理主模块</td>
</tr>
<tr>
<td><code>rabbit_queue_type.erl</code></td>
<td>~900</td>
<td>队列类型抽象层</td>
</tr>
<tr>
<td><code>rabbit_classic_queue.erl</code></td>
<td>~600</td>
<td>Classic 队列实现</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_process.erl</code></td>
<td>~1500</td>
<td>队列工作进程</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_sup_sup.erl</code></td>
<td>94</td>
<td>队列监督者管理</td>
</tr>
<tr>
<td><code>rabbit_amqqueue_sup.erl</code></td>
<td>49</td>
<td>单队列监督者</td>
</tr>
<tr>
<td><code>rabbit_db_queue.erl</code></td>
<td>~1000</td>
<td>数据库操作</td>
</tr>
<tr>
<td><code>amqqueue.erl</code></td>
<td>~500</td>
<td>队列记录定义</td>
</tr>
<tr>
<td><code>rabbit_policy.erl</code></td>
<td>~500</td>
<td>策略管理</td>
</tr>
<tr>
<td><code>rabbit_misc.erl</code></td>
<td>~1500</td>
<td>通用工具</td>
</tr>
</tbody></table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2024/01/18/erlang-erlang-otp-gen-server/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/18/erlang-erlang-otp-gen-server/" class="post-title-link" itemprop="url">第四章：通用型服务器 gen_server</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-01-18 00:00:00" itemprop="dateCreated datePublished" datetime="2024-01-18T00:00:00+08:00">2024-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-15 00:00:00" itemprop="dateModified" datetime="2026-01-15T00:00:00+08:00">2026-01-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/Erlang-OTP/" itemprop="url" rel="index"><span itemprop="name">Erlang/OTP</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文介绍 Erlang&#x2F;OTP 中的通用型服务器行为模式 gen_server，这是 OTP 框架中最常用的 behavior 之一。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2024/01/18/erlang-erlang-otp-gen-server/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2024/01/17/test-giscus-comments/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/17/test-giscus-comments/" class="post-title-link" itemprop="url">测试 Giscus 评论功能</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-01-17 00:00:00" itemprop="dateCreated datePublished" datetime="2024-01-17T00:00:00+08:00">2024-01-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-16 12:38:09" itemprop="dateModified" datetime="2026-01-16T12:38:09+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%B5%8B%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">测试</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="测试评论功能"><a href="#测试评论功能" class="headerlink" title="测试评论功能"></a>测试评论功能</h1><p>这是一篇测试文章，用于验证 Giscus 评论系统是否正常工作。</p>
<h2 id="功能测试"><a href="#功能测试" class="headerlink" title="功能测试"></a>功能测试</h2><ul>
<li>✅ 评论功能</li>
<li>✅ 点赞&#x2F;表情反应</li>
<li>✅ GitHub 账号登录</li>
</ul>
<h2 id="请在下方评论区测试"><a href="#请在下方评论区测试" class="headerlink" title="请在下方评论区测试"></a>请在下方评论区测试</h2><p>滚动到页面底部，您应该能看到评论区。</p>
<p>如果看到 “使用 GitHub 登录” 的提示，说明 Giscus 已正确加载。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hzsunzixiang.github.io/2024/01/16/erlang-erlang-basic-knowledge/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Zixiang Sun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zixiang Sun's Blog">
      <meta itemprop="description" content="Welcome to my personal blog where I share thoughts on technology, programming, and life experiences.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zixiang Sun's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/16/erlang-erlang-basic-knowledge/" class="post-title-link" itemprop="url">Erlang 知识点汇总</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-01-16 00:00:00" itemprop="dateCreated datePublished" datetime="2024-01-16T00:00:00+08:00">2024-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-16 12:38:09" itemprop="dateModified" datetime="2026-01-16T12:38:09+08:00">2026-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/technology/Erlang/" itemprop="url" rel="index"><span itemprop="name">Erlang</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Erlang-知识点汇总"><a href="#Erlang-知识点汇总" class="headerlink" title="Erlang 知识点汇总"></a>Erlang 知识点汇总</h1><p>本文汇总了 Erlang 开发中的常用知识点，包括基础语法、分布式节点通信、调试技巧等。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2024/01/16/erlang-erlang-basic-knowledge/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2024 – 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Zixiang Sun</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"hzsunzixiang/hzsunzixiang.github.io","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js" defer></script>

</body>
</html>
