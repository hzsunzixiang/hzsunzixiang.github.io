<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>测试 Giscus 评论功能</title>
    <url>/2024/01/17/test-giscus-comments/</url>
    <content><![CDATA[<h1 id="测试评论功能"><a href="#测试评论功能" class="headerlink" title="测试评论功能"></a>测试评论功能</h1><p>这是一篇测试文章，用于验证 Giscus 评论系统是否正常工作。</p>
<h2 id="功能测试"><a href="#功能测试" class="headerlink" title="功能测试"></a>功能测试</h2><ul>
<li>✅ 评论功能</li>
<li>✅ 点赞&#x2F;表情反应</li>
<li>✅ GitHub 账号登录</li>
</ul>
<h2 id="请在下方评论区测试"><a href="#请在下方评论区测试" class="headerlink" title="请在下方评论区测试"></a>请在下方评论区测试</h2><p>滚动到页面底部，您应该能看到评论区。</p>
<p>如果看到 “使用 GitHub 登录” 的提示，说明 Giscus 已正确加载。</p>
]]></content>
      <categories>
        <category>测试</category>
      </categories>
      <tags>
        <tag>Test</tag>
      </tags>
  </entry>
  <entry>
    <title>Erlang 进程链接与监视器（中文版）</title>
    <url>/2026/01/16/erlang-erlang-links-and-monitors-cn/</url>
    <content><![CDATA[<h1 id="用于监督的链接和监视器"><a href="#用于监督的链接和监视器" class="headerlink" title="用于监督的链接和监视器"></a>用于监督的链接和监视器</h1><p>当进程相互依赖时，我们基本上有两种选择：让它们同生共死，或者让一个进程在另一个进程崩溃时得到通知。第三章讨论的 Erlang “任其崩溃”哲学，使我们倾向于后一种选择。</p>
<p>链接的进程形成一个组，默认情况下会一起崩溃。如果其中一个链接的进程异常退出，其组中的所有其他进程都会收到 <code>EXIT</code> 信号并一起崩溃。监视器允许一个进程监视另一个进程，而不会自动被耦合到同一个组中。</p>
<span id="more"></span>

<h2 id="链接（Links）"><a href="#链接（Links）" class="headerlink" title="链接（Links）"></a>链接（Links）</h2><p>链接是双向的。如果两个进程被链接，它们被称为属于同一个链接集。如果其中一个异常终止，退出信号会传播到属于其链接集的所有进程。</p>
<p>设置两个进程之间的链接，可以使用以下 BIF：</p>
<ul>
<li><p><code>link(Pid)</code> 在调用进程和进程标识符为 <code>Pid</code> 的进程之间建立双向链接。</p>
</li>
<li><p><code>spawn_link(Module, Function, Args)</code> 原子地生成并链接到一个进程。这相当于生成一个进程并链接到它，但是以原子方式完成，因此不存在生成的进程在链接建立之前死亡的风险。</p>
</li>
<li><p><code>unlink(Pid)</code> 移除调用进程和进程标识符为 <code>Pid</code> 的进程之间的任何链接。</p>
</li>
</ul>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>&gt; Pid = spawn(<span class="keyword">fun</span>() -&gt; <span class="keyword">receive</span> X -&gt; X <span class="keyword">end</span> <span class="keyword">end</span>).</span><br><span class="line">&lt;<span class="number">0.25</span>.<span class="number">0</span>&gt;</span><br><span class="line"><span class="number">2</span>&gt; link(Pid).</span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="number">3</span>&gt; exit(Pid, kill).</span><br><span class="line"><span class="literal">true</span></span><br><span class="line">** exception exit: killed</span><br></pre></td></tr></table></figure>

<p>在这个例子中，链接到生成的进程然后发送 kill 信号会导致生成的进程和 shell 都崩溃。</p>
<h2 id="捕获退出（Trapping-Exits）"><a href="#捕获退出（Trapping-Exits）" class="headerlink" title="捕获退出（Trapping Exits）"></a>捕获退出（Trapping Exits）</h2><p>进程可以通过设置以下标志来捕获退出信号：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">process_flag</span><span class="params">(trap_exit, true)</span></span></span><br></pre></td></tr></table></figure>

<p>当一个进程正在捕获退出时，退出信号会被转换成 <code>{&#39;EXIT&#39;, Pid, Reason}</code> 形式的消息，可以在普通的 receive 语句中处理。</p>
<h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>&gt; process_flag(trap_exit, <span class="literal">true</span>).</span><br><span class="line"><span class="literal">false</span></span><br><span class="line"><span class="number">2</span>&gt; Pid = spawn_link(<span class="keyword">fun</span>() -&gt; <span class="keyword">receive</span> X -&gt; X <span class="keyword">end</span> <span class="keyword">end</span>).</span><br><span class="line">&lt;<span class="number">0.35</span>.<span class="number">0</span>&gt;</span><br><span class="line"><span class="number">3</span>&gt; exit(Pid, reason).</span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="number">4</span>&gt; <span class="keyword">receive</span> X -&gt; X <span class="keyword">end</span>.</span><br><span class="line">&#123;&#x27;EXIT&#x27;,&lt;<span class="number">0.35</span>.<span class="number">0</span>&gt;,reason&#125;</span><br></pre></td></tr></table></figure>

<h2 id="表-2-1-传播语义"><a href="#表-2-1-传播语义" class="headerlink" title="表 2-1. 传播语义"></a>表 2-1. 传播语义</h2><table>
<thead>
<tr>
<th>原因</th>
<th>捕获退出 (<code>trap_exit=true</code>)</th>
<th>不捕获退出</th>
</tr>
</thead>
<tbody><tr>
<td><code>normal</code></td>
<td>接收 <code>{&#39;EXIT&#39;, Pid, normal}</code></td>
<td>无事发生</td>
</tr>
<tr>
<td><code>kill</code></td>
<td>以原因 <code>killed</code> 终止</td>
<td>以原因 <code>killed</code> 终止</td>
</tr>
<tr>
<td>其他</td>
<td>接收 <code>{&#39;EXIT&#39;, Pid, Other}</code></td>
<td>以原因 <code>Other</code> 终止</td>
</tr>
</tbody></table>
<h2 id="监视器（Monitors）"><a href="#监视器（Monitors）" class="headerlink" title="监视器（Monitors）"></a>监视器（Monitors）</h2><p>与链接不同，监视器是单向的。当被监视的进程终止时，监视进程会在其邮箱中收到一条 <code>{&#39;DOWN&#39;, Reference, process, Pid, Reason}</code> 消息，但不会向相反方向发送信号。</p>
<p>使用 BIF 设置监视器：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">Reference = monitor(process, Pid)</span><br></pre></td></tr></table></figure>

<p>如果设置了多个监视器，<code>Reference</code> 可用于标识特定的监视器。</p>
<p>要移除监视器，使用：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">demonitor</span><span class="params">(Reference)</span></span></span><br></pre></td></tr></table></figure>

<h3 id="监视器与链接对比"><a href="#监视器与链接对比" class="headerlink" title="监视器与链接对比"></a>监视器与链接对比</h3><table>
<thead>
<tr>
<th>特性</th>
<th>链接</th>
<th>监视器</th>
</tr>
</thead>
<tbody><tr>
<td>方向性</td>
<td>双向</td>
<td>单向</td>
</tr>
<tr>
<td>默认行为</td>
<td>一起崩溃</td>
<td>退出时发送消息</td>
</tr>
<tr>
<td>信号传播</td>
<td>双向</td>
<td>单向</td>
</tr>
<tr>
<td>设置函数</td>
<td><code>link/1</code></td>
<td><code>monitor/2</code></td>
</tr>
<tr>
<td>移除函数</td>
<td><code>unlink/1</code></td>
<td><code>demonitor/1</code></td>
</tr>
</tbody></table>
<h3 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>&gt; Pid = spawn(<span class="keyword">fun</span>() -&gt; <span class="keyword">receive</span> X -&gt; X <span class="keyword">end</span> <span class="keyword">end</span>).</span><br><span class="line">&lt;<span class="number">0.25</span>.<span class="number">0</span>&gt;</span><br><span class="line"><span class="number">2</span>&gt; Ref = monitor(process, Pid).</span><br><span class="line">#Ref&lt;<span class="number">0.0</span>.<span class="number">0.26</span>&gt;</span><br><span class="line"><span class="number">3</span>&gt; exit(Pid, reason).</span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="number">4</span>&gt; <span class="keyword">receive</span> X -&gt; X <span class="keyword">end</span>.</span><br><span class="line">&#123;&#x27;DOWN&#x27;,#Ref&lt;<span class="number">0.0</span>.<span class="number">0.26</span>&gt;,process,&lt;<span class="number">0.25</span>.<span class="number">0</span>&gt;,reason&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li><strong>链接</strong> 在进程之间创建双向连接。当一个进程死亡时，所有链接的进程都会收到退出信号。</li>
<li><strong>监视器</strong> 创建单向观察。当被监视的进程终止时，监视进程会收到 <code>&#39;DOWN&#39;</code> 消息。</li>
<li>使用 <code>process_flag(trap_exit, true)</code> 将退出信号转换为消息。</li>
<li><code>kill</code> 原因无法被捕获，总是会终止进程。</li>
</ul>
]]></content>
      <categories>
        <category>技术</category>
        <category>Erlang</category>
      </categories>
      <tags>
        <tag>Erlang</tag>
        <tag>OTP</tag>
        <tag>并发编程</tag>
        <tag>进程链接</tag>
        <tag>监视器</tag>
      </tags>
  </entry>
  <entry>
    <title>Erlang 知识点汇总</title>
    <url>/2024/01/16/erlang-erlang-basic-knowledge/</url>
    <content><![CDATA[<h1 id="Erlang-知识点汇总"><a href="#Erlang-知识点汇总" class="headerlink" title="Erlang 知识点汇总"></a>Erlang 知识点汇总</h1><p>本文汇总了 Erlang 开发中的常用知识点，包括基础语法、分布式节点通信、调试技巧等。</p>
<span id="more"></span>

<h2 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h2><h3 id="常用函数"><a href="#常用函数" class="headerlink" title="常用函数"></a>常用函数</h3><ul>
<li><code>list_to_integer</code> - 列表转整数</li>
<li><code>byte_size</code> - 获取字节大小</li>
<li><code>{packet, http_bin}</code> - HTTP 二进制包选项</li>
</ul>
<h3 id="定义和加载-Record"><a href="#定义和加载-Record" class="headerlink" title="定义和加载 Record"></a>定义和加载 Record</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="comment">% 定义 record</span></span><br><span class="line"><span class="function"><span class="title">rd</span><span class="params">(factorial, &#123;nodeName, comment, createdOn&#125;)</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">% 加载 <span class="title">record</span></span></span><br><span class="line"><span class="function"><span class="title">rr</span><span class="params">(amqp_connection)</span>.</span></span><br></pre></td></tr></table></figure>

<p>参考: <a href="https://www.erlang.org/doc/man/shell">Erlang – shell</a></p>
<h3 id="创建-Mnesia-表"><a href="#创建-Mnesia-表" class="headerlink" title="创建 Mnesia 表"></a>创建 Mnesia 表</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">rd</span><span class="params">(factorial, &#123;nodeName, comment, createdOn&#125;)</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">% 内存表</span></span><br><span class="line"><span class="function">R<span class="title">esult</span> = <span class="title">mnesia</span>:<span class="title">create_table</span><span class="params">(factorial, [</span></span></span><br><span class="line"><span class="params"><span class="function">    &#123;attributes, record_info(fields, factorial)&#125;, </span></span></span><br><span class="line"><span class="params"><span class="function">    &#123;type, bag&#125;, </span></span></span><br><span class="line"><span class="params"><span class="function">    &#123;ram_copies, [node()]&#125;</span></span></span><br><span class="line"><span class="params"><span class="function">])</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">% 磁盘表</span></span><br><span class="line"><span class="function">R<span class="title">esult2</span> = <span class="title">mnesia</span>:<span class="title">create_table</span><span class="params">(factorial1, [</span></span></span><br><span class="line"><span class="params"><span class="function">    &#123;attributes, record_info(fields, factorial)&#125;, </span></span></span><br><span class="line"><span class="params"><span class="function">    &#123;type, bag&#125;, </span></span></span><br><span class="line"><span class="params"><span class="function">    &#123;disc_copies, [node()]&#125;</span></span></span><br><span class="line"><span class="params"><span class="function">])</span>.</span></span><br></pre></td></tr></table></figure>

<h3 id="查看-Mnesia-表信息"><a href="#查看-Mnesia-表信息" class="headerlink" title="查看 Mnesia 表信息"></a>查看 Mnesia 表信息</h3><p><img src="/images/erlang_basic/image2.png" alt="Mnesia表信息"></p>
<hr>
<h2 id="循环与列表操作"><a href="#循环与列表操作" class="headerlink" title="循环与列表操作"></a>循环与列表操作</h2><h3 id="生成数组"><a href="#生成数组" class="headerlink" title="生成数组"></a>生成数组</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">[X || X &lt;- lists:seq(<span class="number">1</span>,<span class="number">100</span>), X <span class="keyword">rem</span> <span class="number">2</span> == <span class="number">0</span>].</span><br></pre></td></tr></table></figure>

<h3 id="遍历数组"><a href="#遍历数组" class="headerlink" title="遍历数组"></a>遍历数组</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">lists:foldl(<span class="keyword">fun</span>(X, Sum) -&gt; X + Sum <span class="keyword">end</span>, <span class="number">0</span>, [X || X &lt;- lists:seq(<span class="number">1</span>,<span class="number">100</span>)]).</span><br></pre></td></tr></table></figure>

<h3 id="调用100次某函数"><a href="#调用100次某函数" class="headerlink" title="调用100次某函数"></a>调用100次某函数</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">lists:foldl(<span class="keyword">fun</span>(X, Sum) -&gt; database_logic:storeDB(node(), X) <span class="keyword">end</span>, <span class="number">0</span>, [X || X &lt;- lists:seq(<span class="number">1</span>,<span class="number">100</span>)]).</span><br></pre></td></tr></table></figure>

<h3 id="lists-takewhile"><a href="#lists-takewhile" class="headerlink" title="lists:takewhile"></a>lists:takewhile</h3><p><img src="/images/erlang_basic/image46.png" alt="lists:takewhile"></p>
<hr>
<h2 id="Module-Attributes"><a href="#Module-Attributes" class="headerlink" title="Module Attributes"></a>Module Attributes</h2><p>参考: <a href="https://www.erlang.org/doc/reference_manual/modules">Erlang – Modules</a></p>
<p><img src="/images/erlang_basic/image3.png" alt="Module Attributes"></p>
<p><img src="/images/erlang_basic/image4.png" alt="Module Attributes 示例"></p>
<h3 id="Module-Attributes-with-Tuple"><a href="#Module-Attributes-with-Tuple" class="headerlink" title="Module Attributes with Tuple"></a>Module Attributes with Tuple</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">-module</span><span class="params">(rabbit)</span>.</span><br><span class="line"><span class="keyword">-author</span><span class="params">(<span class="string">&quot;TutorialPoint&quot;</span>)</span>.</span><br><span class="line">-version<span class="params">(<span class="string">&quot;1.0&quot;</span>)</span>.</span><br><span class="line">-module_description<span class="params">(<span class="string">&quot;This is an example module.&quot;</span>)</span>.</span><br><span class="line"></span><br><span class="line">-rabbit_boot_step<span class="params">(&#123;pre_boot, [&#123;description, <span class="string">&quot;rabbit boot start&quot;</span>&#125;]&#125;)</span>.</span><br><span class="line"></span><br><span class="line">-rabbit_boot_step<span class="params">(&#123;codec_correctness_check,</span></span><br><span class="line"><span class="params">    [&#123;description, <span class="string">&quot;codec correctness check&quot;</span>&#125;,</span></span><br><span class="line"><span class="params">     &#123;mfa, &#123;rabbit_binary_generator, check_empty_frame_size, []&#125;&#125;,</span></span><br><span class="line"><span class="params">     &#123;requires, pre_boot&#125;,</span></span><br><span class="line"><span class="params">     &#123;enables, external_infrastructure&#125;]&#125;)</span>.</span><br><span class="line"></span><br><span class="line"><span class="keyword">-export</span><span class="params">([start/<span class="number">0</span>])</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    io:fwrite(<span class="string">&quot;Hello World\n&quot;</span>),</span><br><span class="line">    ModuleInfo = rabbit:module_info(),</span><br><span class="line">    Attributes = rabbit:module_info(attributes),</span><br><span class="line">    io:format(<span class="string">&quot;~p~n&quot;</span>, [Attributes]),</span><br><span class="line">    finish.</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="分布式节点"><a href="#分布式节点" class="headerlink" title="分布式节点"></a>分布式节点</h2><h3 id="Hidden-Node"><a href="#Hidden-Node" class="headerlink" title="Hidden Node"></a>Hidden Node</h3><p><img src="/images/erlang_basic/image1.png" alt="Hidden Node"></p>
<p>参考: <a href="https://www.erlang.org/doc/reference_manual/distributed.html">Erlang – Distributed Erlang</a></p>
<h3 id="远程连接-MQ-节点"><a href="#远程连接-MQ-节点" class="headerlink" title="远程连接 MQ 节点"></a>远程连接 MQ 节点</h3><h4 id="使用-net-kernel-connect-node"><a href="#使用-net-kernel-connect-node" class="headerlink" title="使用 net_kernel:connect_node"></a>使用 net_kernel:connect_node</h4><p>参考: <a href="https://blog.differentpla.net/blog/2013/11/07/net-kernel-connect-node-1-returns-ignored/">net_kernel:connect_node&#x2F;1</a></p>
<p>需要给节点起个名字：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">erl -sname apple</span><br></pre></td></tr></table></figure>

<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">(apple@kvm_10_21_1_163)<span class="number">1</span>&gt; net_kernel:connect_node(&#x27;rabbit@kvm_10_20_1_60&#x27;).</span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h4 id="使用-net-adm-ping"><a href="#使用-net-adm-ping" class="headerlink" title="使用 net_adm:ping"></a>使用 net_adm:ping</h4><p>注意是 <code>-sname</code> 在生效，不用 <code>-name</code>，能够在远程节点生效。</p>
<p><img src="/images/erlang_basic/image5.png" alt="net_adm:ping"></p>
<h4 id="使用-rpc-call"><a href="#使用-rpc-call" class="headerlink" title="使用 rpc:call"></a>使用 rpc:call</h4><p><img src="/images/erlang_basic/image6.png" alt="rpc:call"></p>
<h4 id="使用消息发送"><a href="#使用消息发送" class="headerlink" title="使用消息发送 !"></a>使用消息发送 !</h4><p><img src="/images/erlang_basic/image7.png" alt="消息发送"></p>
<p><img src="/images/erlang_basic/image8.png" alt="消息发送示例"></p>
<h4 id="使用-monitor"><a href="#使用-monitor" class="headerlink" title="使用 monitor"></a>使用 monitor</h4><p><img src="/images/erlang_basic/image9.png" alt="monitor 示例1"></p>
<p><img src="/images/erlang_basic/image10.png" alt="monitor 示例2"></p>
<p><img src="/images/erlang_basic/image11.png" alt="monitor 示例3"></p>
<p><img src="/images/erlang_basic/image12.png" alt="monitor 示例4"></p>
<p><strong>case1</strong>: 节点不存在<br><strong>case2</strong>: 节点存在，服务不存在，建立连接<br><strong>case3</strong>: 远程节点和进程都存在</p>
<p><img src="/images/erlang_basic/image13.png" alt="monitor case"></p>
<hr>
<h2 id="Observer-远程观察"><a href="#Observer-远程观察" class="headerlink" title="Observer 远程观察"></a>Observer 远程观察</h2><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li><strong>新起一个节点</strong></li>
</ol>
<p><img src="/images/erlang_basic/image14.png" alt="新起节点"></p>
<ol start="2">
<li><strong>启动 observer</strong></li>
</ol>
<p><img src="/images/erlang_basic/image15.png" alt="启动observer"></p>
<ol start="3">
<li><strong>连接其他 node</strong></li>
</ol>
<p>在本机上即使不连接，能看到其他节点的时候也可以直接切换。<br>在远程，必须先连接上，然后再切换。</p>
<p><img src="/images/erlang_basic/image16.png" alt="连接节点"></p>
<p>或者用命令行：</p>
<p><img src="/images/erlang_basic/image17.png" alt="命令行连接"></p>
<ol start="4">
<li><strong>切换到其他节点</strong></li>
</ol>
<p><img src="/images/erlang_basic/image18.png" alt="切换节点"></p>
<ol start="5">
<li><strong>查看节点信息</strong></li>
</ol>
<p><img src="/images/erlang_basic/image19.png" alt="节点信息"></p>
<hr>
<h2 id="调试-RabbitMQ-节点"><a href="#调试-RabbitMQ-节点" class="headerlink" title="调试 RabbitMQ 节点"></a>调试 RabbitMQ 节点</h2><h3 id="节点无法连接的调试"><a href="#节点无法连接的调试" class="headerlink" title="节点无法连接的调试"></a>节点无法连接的调试</h3><ul>
<li>查看防火墙，如果有，需要关闭</li>
</ul>
<p><img src="/images/erlang_basic/image20.png" alt="防火墙检查1"></p>
<p><img src="/images/erlang_basic/image21.png" alt="防火墙检查2"></p>
<p><img src="/images/erlang_basic/image22.png" alt="防火墙检查3"></p>
<h3 id="初步启动"><a href="#初步启动" class="headerlink" title="初步启动"></a>初步启动</h3><p><img src="/images/erlang_basic/image23.png" alt="初步启动"></p>
<h3 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">(rabbit@centos7-mq1)<span class="number">2</span>&gt; rabbit:stop().</span><br><span class="line">ok</span><br></pre></td></tr></table></figure>

<p><img src="/images/erlang_basic/image24.png" alt="停止"></p>
<h3 id="再次开启"><a href="#再次开启" class="headerlink" title="再次开启"></a>再次开启</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">(rabbit@centos7-mq1)<span class="number">4</span>&gt; rabbit:start().</span><br><span class="line">ok</span><br></pre></td></tr></table></figure>

<h3 id="Node-位置无关性"><a href="#Node-位置无关性" class="headerlink" title="Node 位置无关性"></a>Node 位置无关性</h3><p><img src="/images/erlang_basic/image25.png" alt="位置无关性1"></p>
<p><img src="/images/erlang_basic/image26.png" alt="位置无关性2"></p>
<hr>
<h2 id="代码加载与模块管理"><a href="#代码加载与模块管理" class="headerlink" title="代码加载与模块管理"></a>代码加载与模块管理</h2><h3 id="列出已加载的库（符号表）"><a href="#列出已加载的库（符号表）" class="headerlink" title="列出已加载的库（符号表）"></a>列出已加载的库（符号表）</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">code:all_loaded().</span><br><span class="line"><span class="function"><span class="title">rp</span><span class="params">(code:all_loaded())</span>.</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/erlang_basic/image27.png" alt="已加载模块"></p>
<h3 id="加载模块"><a href="#加载模块" class="headerlink" title="加载模块"></a>加载模块</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">(apple@rabbitmq-<span class="number">1</span>)<span class="number">11</span>&gt; l(ping).</span><br></pre></td></tr></table></figure>

<h3 id="查看包依赖"><a href="#查看包依赖" class="headerlink" title="查看包依赖"></a>查看包依赖</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="comment">% 直接启动试试</span></span><br><span class="line">application:ensure_all_started(systemd).</span><br><span class="line">&#123;ok,[enough,systemd]&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从 <code>rebar.config</code> 中查看: <code>{deps, [enough]}.</code></li>
<li><code>rebar3 deps</code></li>
<li><code>rebar3 tree</code></li>
</ul>
<p><img src="/images/erlang_basic/image28.png" alt="依赖树"></p>
<ul>
<li><code>make list-deps</code></li>
</ul>
<hr>
<h2 id="把节点变成分布式节点"><a href="#把节点变成分布式节点" class="headerlink" title="把节点变成分布式节点"></a>把节点变成分布式节点</h2><p>参考: <a href="https://www.erlang.org/doc/man/net_kernel.html#start-1">Erlang – net_kernel</a></p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">net_kernel:start([foo, shortnames]).</span><br></pre></td></tr></table></figure>

<h3 id="启动之前"><a href="#启动之前" class="headerlink" title="启动之前"></a>启动之前</h3><p><img src="/images/erlang_basic/image30.png" alt="启动前"></p>
<h3 id="启动之后"><a href="#启动之后" class="headerlink" title="启动之后"></a>启动之后</h3><p><img src="/images/erlang_basic/image31.png" alt="启动后1"></p>
<p><img src="/images/erlang_basic/image32.png" alt="启动后2"></p>
<p>多出来的部分：</p>
<p><img src="/images/erlang_basic/image33.png" alt="多出部分"></p>
<p><img src="/images/erlang_basic/image34.png" alt="分布式详情"></p>
<p>源码位置: <code>/home/ericksun/program/otp-25.0.4/lib/erlang/lib/kernel-8.4.2/src/erl_distribution.erl</code></p>
<p><img src="/images/erlang_basic/image35.png" alt="源码1"></p>
<p><img src="/images/erlang_basic/image36.png" alt="源码2"></p>
<hr>
<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><p><img src="/images/erlang_basic/image37.png" alt="异常类型"></p>
<h3 id="catch-之后不会结束当前进程"><a href="#catch-之后不会结束当前进程" class="headerlink" title="catch 之后不会结束当前进程"></a>catch 之后不会结束当前进程</h3><p><img src="/images/erlang_basic/image38.png" alt="catch示例1"></p>
<p><img src="/images/erlang_basic/image39.png" alt="catch示例2"></p>
<p><img src="/images/erlang_basic/image40.png" alt="catch示例3"></p>
<hr>
<h2 id="begin-end"><a href="#begin-end" class="headerlink" title="begin..end"></a>begin..end</h2><p>参考: <a href="https://stackoverflow.com/questions/20125277/what-is-begin-end-in-erlang-used-for">What is begin…end in Erlang used for?</a></p>
<p><img src="/images/erlang_basic/image41.png" alt="begin..end 1"></p>
<p><img src="/images/erlang_basic/image42.png" alt="begin..end 2"></p>
<p><img src="/images/erlang_basic/image43.png" alt="begin..end 3"></p>
<p><img src="/images/erlang_basic/image44.png" alt="begin..end 4"></p>
<hr>
<h2 id="进程通信"><a href="#进程通信" class="headerlink" title="进程通信"></a>进程通信</h2><h3 id="dollar-sign"><a href="#dollar-sign" class="headerlink" title="$ dollar sign"></a>$ dollar sign</h3><p><img src="/images/erlang_basic/image45.png" alt="dollar sign"></p>
<h3 id="发送信息到远程节点"><a href="#发送信息到远程节点" class="headerlink" title="发送信息到远程节点"></a>发送信息到远程节点</h3><p>参考: <a href="https://www.erlang.org/doc/getting_started/conc_prog.html#message-passing">Erlang – Concurrent Programming</a></p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">&#123;pong, Pong_Node&#125; ! &#123;ping, self()&#125;,</span><br></pre></td></tr></table></figure>

<p>使用 tuple <code>{registered_name, node_name}</code> 代替单独的 <code>registered_name</code>。</p>
<p><img src="/images/erlang_basic/image47.png" alt="远程发送"></p>
<h3 id="进程的注册和获取"><a href="#进程的注册和获取" class="headerlink" title="进程的注册和获取"></a>进程的注册和获取</h3><p><img src="/images/erlang_basic/image48.png" alt="进程注册"></p>
<h3 id="获取远程进程-PID"><a href="#获取远程进程-PID" class="headerlink" title="获取远程进程 PID"></a>获取远程进程 PID</h3><p>通过 register 方式：</p>
<p><img src="/images/erlang_basic/image49.png" alt="获取远程PID 1"></p>
<p><img src="/images/erlang_basic/image50.png" alt="获取远程PID 2"></p>
<p><img src="/images/erlang_basic/image51.png" alt="获取远程PID 3"></p>
<h3 id="直接用远程-PID-发送消息"><a href="#直接用远程-PID-发送消息" class="headerlink" title="直接用远程 PID 发送消息"></a>直接用远程 PID 发送消息</h3><p>io_request 发送到远程，无法直接执行打印的时候，放到消息队列：</p>
<p><img src="/images/erlang_basic/image52.png" alt="io_request"></p>
<p>发给 group_leader 直接执行，不会放到进程的消息队列中：</p>
<p><img src="/images/erlang_basic/image53.png" alt="group_leader"></p>
<h3 id="Observer-观察消息队列"><a href="#Observer-观察消息队列" class="headerlink" title="Observer 观察消息队列"></a>Observer 观察消息队列</h3><p><img src="/images/erlang_basic/image54.png" alt="消息队列1"></p>
<p><img src="/images/erlang_basic/image55.png" alt="消息队列2"></p>
<hr>
<h2 id="模式匹配"><a href="#模式匹配" class="headerlink" title="模式匹配"></a>模式匹配</h2><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">calls</span><span class="params">(TSpecs = [_|_], &#123;Max, Time&#125;, Opts)</span></span></span><br></pre></td></tr></table></figure>

<p>Pattern matching 的重要用途：</p>
<ul>
<li>选择控制流分支</li>
<li>执行变量赋值（绑定）</li>
<li>解构数据结构（选择和提取部分）</li>
</ul>
<p><img src="/images/erlang_basic/image56.png" alt="模式匹配"></p>
<h3 id="函数参数中的模式匹配"><a href="#函数参数中的模式匹配" class="headerlink" title="函数参数中的模式匹配"></a>函数参数中的模式匹配</h3><p><img src="/images/erlang_basic/image57.png" alt="函数参数模式匹配"></p>
<p><code>#state{...}=State</code> 是别名模式：同时匹配和赋值。</p>
<hr>
<h2 id="短路求值"><a href="#短路求值" class="headerlink" title="短路求值"></a>短路求值</h2><p>参考: <a href="https://www.erlang.org/doc/reference_manual/expressions.html">Erlang – Expressions</a></p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">Expr1 <span class="keyword">orelse</span> Expr2</span><br><span class="line">Expr1 <span class="keyword">andalso</span> Expr2</span><br></pre></td></tr></table></figure>

<p><img src="/images/erlang_basic/image58.png" alt="短路求值1"></p>
<p>修改后只允许一个实例存在：</p>
<p><img src="/images/erlang_basic/image59.png" alt="短路求值2"></p>
<hr>
<h2 id="常用工具函数"><a href="#常用工具函数" class="headerlink" title="常用工具函数"></a>常用工具函数</h2><h3 id="net-adm-localhost-0"><a href="#net-adm-localhost-0" class="headerlink" title="net_adm:localhost&#x2F;0"></a>net_adm:localhost&#x2F;0</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>&gt; net_adm:localhost().</span><br><span class="line"><span class="string">&quot;centos7-mq1&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="列表打印完全"><a href="#列表打印完全" class="headerlink" title="列表打印完全"></a>列表打印完全</h3><p><code>rp(Term)</code> - 使用 shell 已知的 record 定义打印 term，不限制深度。</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">rp</span><span class="params">(code:all_loaded())</span>.</span></span><br></pre></td></tr></table></figure>

<p>参考: <a href="https://www.erlang.org/doc/man/shell.html">Erlang – shell</a></p>
<h3 id="查看-Event-中所有的-Handler"><a href="#查看-Event-中所有的-Handler" class="headerlink" title="查看 Event 中所有的 Handler"></a>查看 Event 中所有的 Handler</h3><p><strong>针对旧版 error_logger：</strong></p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">gen_event:which_handlers(error_logger).</span><br></pre></td></tr></table></figure>

<p><strong>针对新的 logger 模块（OTP 21.0+）：</strong></p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">logger:get_handler_config().</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h2><ul>
<li><a href="https://www.erlang.org/doc/man/erlang.html">Erlang – erlang</a></li>
<li><a href="https://www.erlang.org/doc/man/logger.html">Erlang – logger</a></li>
<li><a href="https://www.erlang.org/doc/man/code.html">Erlang – code</a></li>
<li><a href="https://learnyousomeerlang.com/">Learn You Some Erlang</a></li>
<li><a href="https://www.erlang.org/blog/core-erlang-by-example/">Core Erlang by Example</a></li>
</ul>
]]></content>
      <categories>
        <category>技术</category>
        <category>Erlang</category>
      </categories>
      <tags>
        <tag>Erlang</tag>
        <tag>分布式系统</tag>
        <tag>RabbitMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>Erlang 进程链接与监视器</title>
    <url>/2026/01/16/erlang-erlang-links-and-monitors/</url>
    <content><![CDATA[<h1 id="Links-and-Monitors-for-Supervision"><a href="#Links-and-Monitors-for-Supervision" class="headerlink" title="Links and Monitors for Supervision"></a>Links and Monitors for Supervision</h1><p>When processes depend on each other, we have essentially two choices: to have them live and die together, or to let one process be informed when another one crashes. The “let it fail” philosophy of Erlang, discussed in Chapter 3, leads us to a preference for the latter alternative.</p>
<p>Linked processes form a group that, by default, all crash together. If one of the linked processes exits abnormally, all the other processes in its group get an <code>EXIT</code> signal and crash as well. Monitors allow a process to monitor another process without automatically getting coupled into the same group.</p>
<span id="more"></span>

<h2 id="Links"><a href="#Links" class="headerlink" title="Links"></a>Links</h2><p>Links are bidirectional. If two processes are linked, they are said to belong to the same link set. If one of them terminates abnormally, an exit signal is propagated to all processes that belong to its link set.</p>
<p>For setting up a link between two processes, the following BIFs can be used:</p>
<ul>
<li><p><code>link(Pid)</code> sets up a bidirectional link between the calling process and the process with process identifier <code>Pid</code>.</p>
</li>
<li><p><code>spawn_link(Module, Function, Args)</code> atomically spawns and links to a process. This is equivalent to spawning a process and linking to it, but is done atomically so there is no risk of the spawned process dying before the link is set up.</p>
</li>
<li><p><code>unlink(Pid)</code> removes any link between the calling process and the process with process identifier <code>Pid</code>.</p>
</li>
</ul>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>&gt; Pid = spawn(<span class="keyword">fun</span>() -&gt; <span class="keyword">receive</span> X -&gt; X <span class="keyword">end</span> <span class="keyword">end</span>).</span><br><span class="line">&lt;<span class="number">0.25</span>.<span class="number">0</span>&gt;</span><br><span class="line"><span class="number">2</span>&gt; link(Pid).</span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="number">3</span>&gt; exit(Pid, kill).</span><br><span class="line"><span class="literal">true</span></span><br><span class="line">** exception exit: killed</span><br></pre></td></tr></table></figure>

<p>In this example, linking to the spawned process and then sending a kill signal causes both the spawned process and the shell to crash.</p>
<h2 id="Trapping-Exits"><a href="#Trapping-Exits" class="headerlink" title="Trapping Exits"></a>Trapping Exits</h2><p>A process can trap exit signals by setting:</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">process_flag</span><span class="params">(trap_exit, true)</span></span></span><br></pre></td></tr></table></figure>

<p>When a process is trapping exits, the exit signals are converted into messages of the form <code>{&#39;EXIT&#39;, Pid, Reason}</code> that can be handled in a normal receive statement.</p>
<h3 id="Example-1"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>&gt; process_flag(trap_exit, <span class="literal">true</span>).</span><br><span class="line"><span class="literal">false</span></span><br><span class="line"><span class="number">2</span>&gt; Pid = spawn_link(<span class="keyword">fun</span>() -&gt; <span class="keyword">receive</span> X -&gt; X <span class="keyword">end</span> <span class="keyword">end</span>).</span><br><span class="line">&lt;<span class="number">0.35</span>.<span class="number">0</span>&gt;</span><br><span class="line"><span class="number">3</span>&gt; exit(Pid, reason).</span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="number">4</span>&gt; <span class="keyword">receive</span> X -&gt; X <span class="keyword">end</span>.</span><br><span class="line">&#123;&#x27;EXIT&#x27;,&lt;<span class="number">0.35</span>.<span class="number">0</span>&gt;,reason&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Table-2-1-Propagation-semantics"><a href="#Table-2-1-Propagation-semantics" class="headerlink" title="Table 2-1. Propagation semantics"></a>Table 2-1. Propagation semantics</h2><table>
<thead>
<tr>
<th>Reason</th>
<th>Trapping exits (<code>trap_exit=true</code>)</th>
<th>Not trapping exits</th>
</tr>
</thead>
<tbody><tr>
<td><code>normal</code></td>
<td>Receives <code>{&#39;EXIT&#39;, Pid, normal}</code></td>
<td>Nothing happens</td>
</tr>
<tr>
<td><code>kill</code></td>
<td>Terminates with reason <code>killed</code></td>
<td>Terminates with reason <code>killed</code></td>
</tr>
<tr>
<td>Other</td>
<td>Receives <code>{&#39;EXIT&#39;, Pid, Other}</code></td>
<td>Terminates with reason <code>Other</code></td>
</tr>
</tbody></table>
<h2 id="Monitors"><a href="#Monitors" class="headerlink" title="Monitors"></a>Monitors</h2><p>Unlike links, monitors are unidirectional. The monitoring process receives a message <code>{&#39;DOWN&#39;, Reference, process, Pid, Reason}</code> in its mailbox when the monitored process terminates, but no signal is sent in the opposite direction.</p>
<p>Setting up monitors with the BIF:</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">Reference = monitor(process, Pid)</span><br></pre></td></tr></table></figure>

<p>The <code>Reference</code> can be used to identify the particular monitor if more than one is set up.</p>
<p>To remove a monitor, use:</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">demonitor</span><span class="params">(Reference)</span></span></span><br></pre></td></tr></table></figure>

<h3 id="Monitors-vs-Links"><a href="#Monitors-vs-Links" class="headerlink" title="Monitors vs Links"></a>Monitors vs Links</h3><table>
<thead>
<tr>
<th>Feature</th>
<th>Links</th>
<th>Monitors</th>
</tr>
</thead>
<tbody><tr>
<td>Directionality</td>
<td>Bidirectional</td>
<td>Unidirectional</td>
</tr>
<tr>
<td>Default behavior</td>
<td>Crash together</td>
<td>Message on exit</td>
</tr>
<tr>
<td>Signal propagation</td>
<td>Both directions</td>
<td>One direction</td>
</tr>
<tr>
<td>Setup function</td>
<td><code>link/1</code></td>
<td><code>monitor/2</code></td>
</tr>
<tr>
<td>Remove function</td>
<td><code>unlink/1</code></td>
<td><code>demonitor/1</code></td>
</tr>
</tbody></table>
<h3 id="Example-2"><a href="#Example-2" class="headerlink" title="Example"></a>Example</h3><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>&gt; Pid = spawn(<span class="keyword">fun</span>() -&gt; <span class="keyword">receive</span> X -&gt; X <span class="keyword">end</span> <span class="keyword">end</span>).</span><br><span class="line">&lt;<span class="number">0.25</span>.<span class="number">0</span>&gt;</span><br><span class="line"><span class="number">2</span>&gt; Ref = monitor(process, Pid).</span><br><span class="line">#Ref&lt;<span class="number">0.0</span>.<span class="number">0.26</span>&gt;</span><br><span class="line"><span class="number">3</span>&gt; exit(Pid, reason).</span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="number">4</span>&gt; <span class="keyword">receive</span> X -&gt; X <span class="keyword">end</span>.</span><br><span class="line">&#123;&#x27;DOWN&#x27;,#Ref&lt;<span class="number">0.0</span>.<span class="number">0.26</span>&gt;,process,&lt;<span class="number">0.25</span>.<span class="number">0</span>&gt;,reason&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><ul>
<li><strong>Links</strong> create a bidirectional connection between processes. When one dies, all linked processes receive an exit signal.</li>
<li><strong>Monitors</strong> create a unidirectional observation. The monitoring process receives a <code>&#39;DOWN&#39;</code> message when the monitored process terminates.</li>
<li>Use <code>process_flag(trap_exit, true)</code> to convert exit signals into messages.</li>
<li>The <code>kill</code> reason cannot be trapped and always terminates the process.</li>
</ul>
]]></content>
      <categories>
        <category>技术</category>
        <category>Erlang</category>
      </categories>
      <tags>
        <tag>Erlang</tag>
        <tag>OTP</tag>
        <tag>并发编程</tag>
        <tag>进程链接</tag>
        <tag>监视器</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQ 编译方式深度解析与源码分析</title>
    <url>/2026/01/16/rabbitmq-rabbitmq-build-deep-analysis/</url>
    <content><![CDATA[<h1 id="RabbitMQ-编译方式深度解析与源码分析"><a href="#RabbitMQ-编译方式深度解析与源码分析" class="headerlink" title="RabbitMQ 编译方式深度解析与源码分析"></a>RabbitMQ 编译方式深度解析与源码分析</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>RabbitMQ 作为一个复杂的分布式消息中间件，提供了多种编译和打包方式来满足不同的部署需求。本文档基于 RabbitMQ 4.0.x 源码，深入分析各种编译命令的原理、实现机制和适用场景。</p>
<h2 id="编译命令对比表"><a href="#编译命令对比表" class="headerlink" title="编译命令对比表"></a>编译命令对比表</h2><table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
<th>输出格式</th>
<th>部署方式</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>make</code></td>
<td>基础编译</td>
<td>源码目录 + beam 文件</td>
<td>开发调试</td>
<td>本地开发、调试</td>
</tr>
<tr>
<td><code>make dist</code></td>
<td>打包文件</td>
<td>插件目录结构</td>
<td>目录部署</td>
<td>生产环境、插件开发</td>
</tr>
<tr>
<td><code>make dist DIST_AS_EZS=true</code></td>
<td>打包成 ez 文件</td>
<td>.ez 压缩包</td>
<td>插件安装</td>
<td>插件分发、热加载</td>
</tr>
<tr>
<td><code>make package-generic-unix</code></td>
<td>打包成 PACKAGE 文件</td>
<td>tar.xz 包</td>
<td>解压安装</td>
<td>容器、跨平台</td>
</tr>
<tr>
<td><code>make install</code></td>
<td>系统安装</td>
<td>系统目录</td>
<td>系统安装</td>
<td>生产部署</td>
</tr>
</tbody></table>
<hr>
<h2 id="1-make-基础编译"><a href="#1-make-基础编译" class="headerlink" title="1. make - 基础编译"></a>1. <code>make</code> - 基础编译</h2><h3 id="技术原理"><a href="#技术原理" class="headerlink" title="技术原理"></a>技术原理</h3><p>基于 <strong>erlang.mk</strong> 构建系统，执行 Erlang&#x2F;OTP 标准编译流程。</p>
<h4 id="核心实现机制"><a href="#核心实现机制" class="headerlink" title="核心实现机制"></a>核心实现机制</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile (第 77 行)</span></span><br><span class="line"><span class="keyword">include</span> erlang.mk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 来源：erlang.mk 核心逻辑</span></span><br><span class="line"><span class="section">app:: deps <span class="variable">$(PROJECT)</span>.d</span></span><br><span class="line">  <span class="variable">$(verbose)</span> <span class="variable">$(MAKE)</span> --no-print-directory app-build</span><br></pre></td></tr></table></figure>

<h4 id="编译流程"><a href="#编译流程" class="headerlink" title="编译流程"></a>编译流程</h4><figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">make</span><br><span class="line">  ↓</span><br><span class="line">解析依赖</span><br><span class="line">  ↓</span><br><span class="line">编译 deps/</span><br><span class="line">  ↓</span><br><span class="line">编译 <span class="string">.erl</span> → <span class="string">.beam</span></span><br><span class="line">  ↓</span><br><span class="line">生成启动脚本</span><br><span class="line">  ↓</span><br><span class="line">创建 sbin/ 目录</span><br></pre></td></tr></table></figure>

<h3 id="生成的文件结构"><a href="#生成的文件结构" class="headerlink" title="生成的文件结构"></a>生成的文件结构</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rabbitmq-server/</span><br><span class="line">├── deps/                          <span class="comment"># 依赖模块</span></span><br><span class="line">│   ├── rabbit/ebin/*.beam        <span class="comment"># 核心模块字节码</span></span><br><span class="line">│   ├── rabbit_common/ebin/*.beam <span class="comment"># 公共模块字节码</span></span><br><span class="line">│   └── */ebin/*.beam             <span class="comment"># 其他插件字节码</span></span><br><span class="line">├── sbin/                         <span class="comment"># 启动脚本</span></span><br><span class="line">│   ├── rabbitmq-server          <span class="comment"># 主服务器脚本</span></span><br><span class="line">│   ├── rabbitmqctl              <span class="comment"># 管理工具</span></span><br><span class="line">│   └── rabbitmq-plugins         <span class="comment"># 插件管理</span></span><br><span class="line">└── escript/                      <span class="comment"># Erlang 脚本</span></span><br></pre></td></tr></table></figure>

<h3 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h3><ul>
<li><strong>开发调试</strong>: 快速编译，支持增量构建</li>
<li><strong>源码修改</strong>: 直接修改源码后重新编译</li>
<li><strong>性能测试</strong>: 最小化的编译开销</li>
</ul>
<hr>
<h2 id="2-make-dist-插件目录分发"><a href="#2-make-dist-插件目录分发" class="headerlink" title="2. make dist - 插件目录分发"></a>2. <code>make dist</code> - 插件目录分发</h2><h3 id="技术原理-1"><a href="#技术原理-1" class="headerlink" title="技术原理"></a>技术原理</h3><p>基于 <strong>rabbitmq-dist.mk</strong> 实现插件打包机制，创建标准的 RabbitMQ 插件目录结构。</p>
<h4 id="核心实现源码"><a href="#核心实现源码" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-dist.mk (第 166 行)</span></span><br><span class="line"><span class="section">dist:: <span class="variable">$(ERLANG_MK_RECURSIVE_DEPS_LIST)</span> all</span></span><br><span class="line">  <span class="variable">$(verbose)</span> rm -rf <span class="variable">$(DIST_DIR)</span></span><br><span class="line">  <span class="variable">$(verbose)</span> mkdir -p <span class="variable">$(DIST_DIR)</span></span><br><span class="line">  <span class="variable">$(gen_verbose)</span> <span class="variable">$(MAKE)</span> --no-print-directory do-dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件目录创建逻辑 (第 48-54 行)</span></span><br><span class="line">dist_$(1)_ez_dir = $<span class="variable">$(<span class="built_in">if</span> $(2)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)-$(2), \</span><br><span class="line">  $<span class="variable">$(<span class="built_in">if</span> $<span class="variable">$(VERSION)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)</span>-$<span class="variable">$(VERSION)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)))</span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(DIST_AS_EZS)</span>,)</span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir)  <span class="comment"># 目录格式</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir).ez  <span class="comment"># EZ 格式</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<h4 id="打包流程"><a href="#打包流程" class="headerlink" title="打包流程"></a>打包流程</h4><ol>
<li><strong>编译所有模块</strong> - 确保所有 <code>.erl</code> 文件编译为 <code>.beam</code></li>
<li><strong>收集依赖</strong> - 将所有插件和依赖收集到 <code>plugins/</code> 目录</li>
<li><strong>生成插件结构</strong> - 每个插件包含 <code>ebin/</code>、<code>priv/</code> 等标准目录</li>
<li><strong>创建元数据</strong> - 生成 <code>.app</code> 文件描述插件信息</li>
</ol>
<h3 id="生成的目录结构"><a href="#生成的目录结构" class="headerlink" title="生成的目录结构"></a>生成的目录结构</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">plugins/</span><br><span class="line">├── rabbit-4.0.5/                 <span class="comment"># 核心模块目录</span></span><br><span class="line">│   ├── ebin/</span><br><span class="line">│   │   ├── rabbit.app            <span class="comment"># 应用描述文件</span></span><br><span class="line">│   │   ├── rabbit.beam           <span class="comment"># 编译后的字节码</span></span><br><span class="line">│   │   └── *.beam                <span class="comment"># 其他模块字节码</span></span><br><span class="line">│   ├── include/                  <span class="comment"># 头文件</span></span><br><span class="line">│   └── priv/                     <span class="comment"># 私有资源</span></span><br><span class="line">├── rabbitmq_management-4.0.5/    <span class="comment"># 管理插件目录</span></span><br><span class="line">├── rabbitmq_prometheus-4.0.5/    <span class="comment"># 监控插件目录</span></span><br><span class="line">└── ...                           <span class="comment"># 其他插件目录</span></span><br></pre></td></tr></table></figure>

<h3 id="目录-vs-EZ-格式对比"><a href="#目录-vs-EZ-格式对比" class="headerlink" title="目录 vs EZ 格式对比"></a>目录 vs EZ 格式对比</h3><table>
<thead>
<tr>
<th>特性</th>
<th>目录格式</th>
<th>EZ 格式</th>
</tr>
</thead>
<tbody><tr>
<td><strong>存储</strong></td>
<td>展开的文件夹</td>
<td>压缩的 ZIP 文件</td>
</tr>
<tr>
<td><strong>加载速度</strong></td>
<td>快速</td>
<td>略慢（需解压）</td>
</tr>
<tr>
<td><strong>调试</strong></td>
<td>容易（直接访问文件）</td>
<td>困难（需解压查看）</td>
</tr>
<tr>
<td><strong>分发</strong></td>
<td>占用空间大</td>
<td>占用空间小</td>
</tr>
<tr>
<td><strong>热加载</strong></td>
<td>支持</td>
<td>更好支持</td>
</tr>
</tbody></table>
<hr>
<h2 id="3-make-dist-DIST-AS-EZS-true-EZ-压缩包分发"><a href="#3-make-dist-DIST-AS-EZS-true-EZ-压缩包分发" class="headerlink" title="3. make dist DIST_AS_EZS=true - EZ 压缩包分发"></a>3. <code>make dist DIST_AS_EZS=true</code> - EZ 压缩包分发</h2><h3 id="技术原理-2"><a href="#技术原理-2" class="headerlink" title="技术原理"></a>技术原理</h3><p>EZ 格式是 Erlang 的标准插件打包格式，本质上是重命名的 ZIP 文件。</p>
<h4 id="核心实现逻辑"><a href="#核心实现逻辑" class="headerlink" title="核心实现逻辑"></a>核心实现逻辑</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-dist.mk (第 8-14 行)</span></span><br><span class="line"><span class="comment"># Set $(DIST_AS_EZS) to a non-empty value to enable the packaging of</span></span><br><span class="line"><span class="comment"># plugins as .ez archives.</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(USE_RABBIT_BOOT_SCRIPT)</span>,)</span><br><span class="line">DIST_AS_EZS ?=                    <span class="comment"># 默认为空（目录格式）</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">DIST_AS_EZS =                     <span class="comment"># 强制目录格式</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<h4 id="EZ-文件生成过程"><a href="#EZ-文件生成过程" class="headerlink" title="EZ 文件生成过程"></a>EZ 文件生成过程</h4><figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">make dist DIST_AS_EZS<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">  ↓</span><br><span class="line">编译所有模块</span><br><span class="line">  ↓</span><br><span class="line">收集 ebin<span class="symbol">/</span> include<span class="symbol">/</span> priv<span class="symbol">/</span></span><br><span class="line">  ↓</span><br><span class="line">创建临时目录结构</span><br><span class="line">  ↓</span><br><span class="line">ZIP 压缩</span><br><span class="line">  ↓</span><br><span class="line">重命名为 .ez</span><br><span class="line">  ↓</span><br><span class="line">移动到 plugins<span class="operator">/</span></span><br></pre></td></tr></table></figure>

<h3 id="实际生成的-EZ-文件"><a href="#实际生成的-EZ-文件" class="headerlink" title="实际生成的 EZ 文件"></a>实际生成的 EZ 文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">plugins/</span><br><span class="line">├── rabbit-4.0.5.ez              <span class="comment"># 3.38 MB - 核心模块</span></span><br><span class="line">├── rabbit_common-4.0.5.ez       <span class="comment"># 770.91 KB - 公共模块  </span></span><br><span class="line">├── rabbitmq_management-4.0.5.ez <span class="comment"># 管理界面插件</span></span><br><span class="line">├── rabbitmq_prometheus-4.0.5.ez <span class="comment"># 监控插件</span></span><br><span class="line">├── amqp_client-4.0.5.ez         <span class="comment"># AMQP 客户端</span></span><br><span class="line">└── ...                          <span class="comment"># 其他插件 EZ 文件</span></span><br></pre></td></tr></table></figure>

<h3 id="EZ-文件内部结构"><a href="#EZ-文件内部结构" class="headerlink" title="EZ 文件内部结构"></a>EZ 文件内部结构</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># EZ 文件实际上是 ZIP 格式</span></span><br><span class="line">$ unzip -l rabbit-4.0.5.ez</span><br><span class="line">Archive:  rabbit-4.0.5.ez</span><br><span class="line">  Length      Date    Time    Name</span><br><span class="line">---------  ---------- -----   ----</span><br><span class="line">     1234  2025-01-16 22:05   rabbit-4.0.5/ebin/rabbit.app</span><br><span class="line">    45678  2025-01-16 22:05   rabbit-4.0.5/ebin/rabbit.beam</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<h3 id="EZ-格式优势"><a href="#EZ-格式优势" class="headerlink" title="EZ 格式优势"></a>EZ 格式优势</h3><ol>
<li><strong>压缩存储</strong>: 减少磁盘占用和网络传输</li>
<li><strong>原子性</strong>: 单文件部署，避免部分文件丢失</li>
<li><strong>版本管理</strong>: 文件名包含版本信息</li>
<li><strong>热加载</strong>: Erlang VM 原生支持 EZ 文件热加载</li>
</ol>
<hr>
<h2 id="4-make-package-generic-unix-通用-Unix-包"><a href="#4-make-package-generic-unix-通用-Unix-包" class="headerlink" title="4. make package-generic-unix - 通用 Unix 包"></a>4. <code>make package-generic-unix</code> - 通用 Unix 包</h2><h3 id="技术原理-3"><a href="#技术原理-3" class="headerlink" title="技术原理"></a>技术原理</h3><p>创建跨平台的 tar.xz 安装包，包含完整的 RabbitMQ 运行环境。</p>
<h4 id="核心实现源码-1"><a href="#核心实现源码-1" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 来源：packaging/generic-unix/Makefile (第 33-76 行)</span></span><br><span class="line">SOURCE_DIR = rabbitmq-server-<span class="variable">$(VERSION)</span></span><br><span class="line">TARGET_DIR = rabbitmq_server-<span class="variable">$(VERSION)</span></span><br><span class="line">TARGET_TARBALL = rabbitmq-server-<span class="variable">$(TARBALL_SUFFIX)</span>-<span class="variable">$(VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="section">dist:</span></span><br><span class="line">  <span class="comment"># 解压源码包</span></span><br><span class="line">  xzcat <span class="variable">$(SOURCE_DIST_FILE)</span> | tar -xf -</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 编译并安装到目标目录</span></span><br><span class="line">  <span class="variable">$(MAKE)</span> -C <span class="variable">$(SOURCE_DIR)</span> \</span><br><span class="line">    PREFIX= RMQ_ROOTDIR= \</span><br><span class="line">    RMQ_ERLAPP_DIR=`pwd`/<span class="variable">$(TARGET_DIR)</span> \</span><br><span class="line">    MANDIR=`pwd`/<span class="variable">$(TARGET_DIR)</span>/share/man \</span><br><span class="line">    manpages web-manpages install install-man</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 修改配置文件</span></span><br><span class="line">  sed -e &#x27;s:^SYS_PREFIX=$$:SYS_PREFIX=\$$&#123;RABBITMQ_HOME&#125;:&#x27; \</span><br><span class="line">        <span class="variable">$(TARGET_DIR)</span>/sbin/rabbitmq-defaults &gt;<span class="variable">$(TARGET_DIR)</span>/sbin/rabbitmq-defaults.tmp</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 创建 tar.xz 包</span></span><br><span class="line">  find <span class="variable">$(TARGET_DIR)</span> | LC_COLLATE=C sort &gt; <span class="variable">$(TARGET_TARBALL)</span>.manifest</span><br><span class="line">  tar --no-recursion -T <span class="variable">$(TARGET_TARBALL)</span>.manifest -cf - | \</span><br><span class="line">  xz &gt; <span class="variable">$(CURDIR)</span>/<span class="variable">$(TARGET_TARBALL)</span>.tar.xz</span><br></pre></td></tr></table></figure>

<h4 id="打包流程-1"><a href="#打包流程-1" class="headerlink" title="打包流程"></a>打包流程</h4><ol>
<li><strong>解压源码包</strong> - 从 tar.xz 源码包开始</li>
<li><strong>编译安装</strong> - 使用标准 Unix 安装路径</li>
<li><strong>生成文档</strong> - 创建 man 手册页</li>
<li><strong>配置脚本</strong> - 调整启动脚本的路径变量</li>
<li><strong>创建归档</strong> - 打包成 tar.xz 格式</li>
</ol>
<h3 id="生成的包结构"><a href="#生成的包结构" class="headerlink" title="生成的包结构"></a>生成的包结构</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 实际生成：PACKAGES/</span></span><br><span class="line">PACKAGES/</span><br><span class="line">├── rabbitmq-server-4.0.5.tar.xz           <span class="comment"># 4.95 MB - 源码包</span></span><br><span class="line">├── rabbitmq-server-generic-unix-4.0.5.tar.xz  <span class="comment"># 15.51 MB - 通用包</span></span><br><span class="line">├── rabbitmq-server-4.0.5.manifest         <span class="comment"># 230.22 KB - 文件清单</span></span><br><span class="line">└── rabbitmq-server-4.0.5/                 <span class="comment"># 解压后的源码目录</span></span><br></pre></td></tr></table></figure>

<h3 id="通用包内容分析"><a href="#通用包内容分析" class="headerlink" title="通用包内容分析"></a>通用包内容分析</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 解压通用包后的目录结构</span></span><br><span class="line">rabbitmq_server-4.0.5/</span><br><span class="line">├── sbin/                        <span class="comment"># 启动脚本</span></span><br><span class="line">│   ├── rabbitmq-server         <span class="comment"># 已配置 RABBITMQ_HOME</span></span><br><span class="line">│   ├── rabbitmqctl</span><br><span class="line">│   └── ...</span><br><span class="line">├── plugins/                     <span class="comment"># 插件目录</span></span><br><span class="line">├── etc/rabbitmq/               <span class="comment"># 配置目录</span></span><br><span class="line">├── share/man/                  <span class="comment"># 手册页</span></span><br><span class="line">└── escript/                    <span class="comment"># CLI 工具</span></span><br></pre></td></tr></table></figure>

<h3 id="通用包特点"><a href="#通用包特点" class="headerlink" title="通用包特点"></a>通用包特点</h3><ol>
<li><strong>自包含</strong>: 包含所有运行时依赖</li>
<li><strong>可移植</strong>: 适用于各种 Unix 系统</li>
<li><strong>标准化</strong>: 遵循 Unix 目录结构规范</li>
<li><strong>生产就绪</strong>: 包含完整的配置和文档</li>
</ol>
<hr>
<h2 id="5-make-install-系统级安装"><a href="#5-make-install-系统级安装" class="headerlink" title="5. make install - 系统级安装"></a>5. <code>make install</code> - 系统级安装</h2><h3 id="技术原理-4"><a href="#技术原理-4" class="headerlink" title="技术原理"></a>技术原理</h3><p>将 RabbitMQ 安装到系统标准目录，遵循 FHS (Filesystem Hierarchy Standard)。</p>
<h4 id="核心实现逻辑-1"><a href="#核心实现逻辑-1" class="headerlink" title="核心实现逻辑"></a>核心实现逻辑</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile 第 489-523 行</span></span><br><span class="line">PREFIX ?= /usr/local</span><br><span class="line">RMQ_ROOTDIR ?= <span class="variable">$(PREFIX)</span>/lib/erlang</span><br><span class="line">RMQ_BINDIR ?= <span class="variable">$(RMQ_ROOTDIR)</span>/bin</span><br><span class="line">RMQ_LIBDIR ?= <span class="variable">$(RMQ_ROOTDIR)</span>/lib</span><br><span class="line">RMQ_ERLAPP_DIR ?= <span class="variable">$(RMQ_LIBDIR)</span>/rabbitmq_server-<span class="variable">$(PROJECT_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="section">install: install-erlapp install-scripts</span></span><br><span class="line"></span><br><span class="line"><span class="section">install-erlapp: dist</span></span><br><span class="line">  <span class="variable">$(verbose)</span> mkdir -p <span class="variable">$(DESTDIR)</span><span class="variable">$(RMQ_ERLAPP_DIR)</span></span><br><span class="line">  <span class="variable">$(inst_verbose)</span> cp -r \</span><br><span class="line">    LICENSE* \</span><br><span class="line">    <span class="variable">$(DEPS_DIR)</span>/rabbit/INSTALL \</span><br><span class="line">    <span class="variable">$(DIST_DIR)</span> \</span><br><span class="line">    <span class="variable">$(DESTDIR)</span><span class="variable">$(RMQ_ERLAPP_DIR)</span></span><br></pre></td></tr></table></figure>

<h3 id="系统安装目录结构"><a href="#系统安装目录结构" class="headerlink" title="系统安装目录结构"></a>系统安装目录结构</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 典型的系统安装路径</span></span><br><span class="line">/usr/local/</span><br><span class="line">├── bin/                         <span class="comment"># 可执行文件</span></span><br><span class="line">│   ├── rabbitmq-server</span><br><span class="line">│   ├── rabbitmqctl</span><br><span class="line">│   └── ...</span><br><span class="line">├── lib/                         <span class="comment"># 库文件</span></span><br><span class="line">│   └── erlang/lib/</span><br><span class="line">│       └── rabbitmq_server-4.0.5/</span><br><span class="line">│           ├── ebin/           <span class="comment"># 字节码文件</span></span><br><span class="line">│           ├── include/        <span class="comment"># 头文件</span></span><br><span class="line">│           └── plugins/        <span class="comment"># 插件目录</span></span><br><span class="line">├── etc/                        <span class="comment"># 配置文件</span></span><br><span class="line">│   └── rabbitmq/</span><br><span class="line">│       └── rabbitmq.conf</span><br><span class="line">├── var/                        <span class="comment"># 数据目录</span></span><br><span class="line">│   ├── <span class="built_in">log</span>/rabbitmq/          <span class="comment"># 日志</span></span><br><span class="line">│   └── lib/rabbitmq/          <span class="comment"># 数据库</span></span><br><span class="line">└── share/                      <span class="comment"># 文档</span></span><br><span class="line">    └── man/                    <span class="comment"># 手册页</span></span><br></pre></td></tr></table></figure>

<h3 id="安装组件"><a href="#安装组件" class="headerlink" title="安装组件"></a>安装组件</h3><ol>
<li><strong>核心应用</strong> (<code>install-erlapp</code>)</li>
<li><strong>启动脚本</strong> (<code>install-scripts</code>)</li>
<li><strong>命令行工具</strong> (<code>install-bin</code>)</li>
<li><strong>手册页</strong> (<code>install-man</code>)</li>
</ol>
<h3 id="系统安装优势"><a href="#系统安装优势" class="headerlink" title="系统安装优势"></a>系统安装优势</h3><ol>
<li><strong>标准化</strong>: 遵循 Unix 标准目录结构</li>
<li><strong>多用户</strong>: 支持系统级多用户访问</li>
<li><strong>服务集成</strong>: 便于集成到系统服务管理</li>
<li><strong>权限管理</strong>: 利用系统权限控制</li>
</ol>
<hr>
<h2 id="构建系统架构"><a href="#构建系统架构" class="headerlink" title="构建系统架构"></a>构建系统架构</h2><h3 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h3><h4 id="1-erlang-mk"><a href="#1-erlang-mk" class="headerlink" title="1. erlang.mk"></a>1. <strong>erlang.mk</strong></h4><ul>
<li><strong>作用</strong>: Erlang 项目的标准构建工具</li>
<li><strong>功能</strong>: 依赖管理、编译、测试、发布</li>
</ul>
<h4 id="2-rabbitmq-components-mk"><a href="#2-rabbitmq-components-mk" class="headerlink" title="2. rabbitmq-components.mk"></a>2. <strong>rabbitmq-components.mk</strong></h4><ul>
<li><strong>作用</strong>: RabbitMQ 特定的构建规则</li>
<li><strong>功能</strong>: 版本管理、插件系统、发布流程</li>
</ul>
<h4 id="3-rabbitmq-dist-mk"><a href="#3-rabbitmq-dist-mk" class="headerlink" title="3. rabbitmq-dist.mk"></a>3. <strong>rabbitmq-dist.mk</strong></h4><ul>
<li><strong>作用</strong>: 插件分发机制</li>
<li><strong>功能</strong>: EZ 打包、插件依赖、版本控制</li>
</ul>
<h3 id="关键配置文件"><a href="#关键配置文件" class="headerlink" title="关键配置文件"></a>关键配置文件</h3><h4 id="Makefile-主控制文件"><a href="#Makefile-主控制文件" class="headerlink" title="Makefile - 主控制文件"></a>Makefile - 主控制文件</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile (第 1-30 行)</span></span><br><span class="line">PROJECT = rabbitmq_server_release</span><br><span class="line">PROJECT_DESCRIPTION = RabbitMQ Server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件列表</span></span><br><span class="line"><span class="keyword">include</span> plugins.mk</span><br><span class="line">DEPS = rabbit_common rabbit <span class="variable">$(PLUGINS)</span> <span class="variable">$(ADDITIONAL_PLUGINS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建系统</span></span><br><span class="line"><span class="keyword">include</span> rabbitmq-components.mk</span><br><span class="line"><span class="keyword">include</span> erlang.mk</span><br></pre></td></tr></table></figure>

<h4 id="plugins-mk-插件定义"><a href="#plugins-mk-插件定义" class="headerlink" title="plugins.mk - 插件定义"></a>plugins.mk - 插件定义</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 来源：plugins.mk</span></span><br><span class="line">PLUGINS = \</span><br><span class="line">  rabbitmq_amqp1_0 \</span><br><span class="line">  rabbitmq_auth_backend_cache \</span><br><span class="line">  rabbitmq_auth_backend_http \</span><br><span class="line">  rabbitmq_auth_backend_ldap \</span><br><span class="line">  rabbitmq_auth_backend_oauth2 \</span><br><span class="line">  rabbitmq_auth_mechanism_ssl \</span><br><span class="line">  rabbitmq_consistent_hash_exchange \</span><br><span class="line">  <span class="comment"># ... 更多插件</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="编译流程对比"><a href="#编译流程对比" class="headerlink" title="编译流程对比"></a>编译流程对比</h2><h3 id="性能和资源对比"><a href="#性能和资源对比" class="headerlink" title="性能和资源对比"></a>性能和资源对比</h3><table>
<thead>
<tr>
<th>编译方式</th>
<th>编译时间</th>
<th>磁盘占用</th>
<th>内存使用</th>
<th>网络传输</th>
</tr>
</thead>
<tbody><tr>
<td><code>make</code></td>
<td>最快</td>
<td>中等</td>
<td>低</td>
<td>不适用</td>
</tr>
<tr>
<td><code>make dist</code></td>
<td>快</td>
<td>大</td>
<td>中等</td>
<td>大</td>
</tr>
<tr>
<td><code>make dist DIST_AS_EZS=true</code></td>
<td>中等</td>
<td>小</td>
<td>中等</td>
<td>小</td>
</tr>
<tr>
<td><code>make package-generic-unix</code></td>
<td>慢</td>
<td>最小</td>
<td>高</td>
<td>最小</td>
</tr>
<tr>
<td><code>make install</code></td>
<td>中等</td>
<td>中等</td>
<td>低</td>
<td>不适用</td>
</tr>
</tbody></table>
<hr>
<h2 id="最佳实践指南"><a href="#最佳实践指南" class="headerlink" title="最佳实践指南"></a>最佳实践指南</h2><h3 id="开发阶段"><a href="#开发阶段" class="headerlink" title="开发阶段"></a>开发阶段</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 快速开发迭代</span></span><br><span class="line">make clean &amp;&amp; make</span><br><span class="line">sbin/rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件开发</span></span><br><span class="line">make dist</span><br><span class="line"><span class="comment"># 测试插件加载</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发调试</span></span><br><span class="line">make shell</span><br></pre></td></tr></table></figure>

<h3 id="测试阶段"><a href="#测试阶段" class="headerlink" title="测试阶段"></a>测试阶段</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 完整功能测试</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 验证 EZ 文件加载</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集成测试</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 在不同环境测试安装包</span></span><br></pre></td></tr></table></figure>

<h3 id="生产部署"><a href="#生产部署" class="headerlink" title="生产部署"></a>生产部署</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 容器化部署</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 使用 tar.xz 包构建 Docker 镜像</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 传统服务器部署  </span></span><br><span class="line">make install PREFIX=/opt/rabbitmq</span><br><span class="line"><span class="comment"># 系统级安装</span></span><br></pre></td></tr></table></figure>

<h3 id="插件分发"><a href="#插件分发" class="headerlink" title="插件分发"></a>插件分发</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 插件开发者</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 生成 .ez 文件用于分发</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件用户</span></span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> plugin_name</span><br><span class="line"><span class="comment"># 从 .ez 文件安装插件</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="高级配置选项"><a href="#高级配置选项" class="headerlink" title="高级配置选项"></a>高级配置选项</h2><h3 id="环境变量控制"><a href="#环境变量控制" class="headerlink" title="环境变量控制"></a>环境变量控制</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 自定义插件目录</span></span><br><span class="line"><span class="built_in">export</span> DIST_DIR=/custom/plugins/path</span><br><span class="line">make dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义包输出目录</span></span><br><span class="line"><span class="built_in">export</span> PACKAGES_DIR=/custom/packages/path  </span><br><span class="line">make package-generic-unix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用社区插件</span></span><br><span class="line"><span class="built_in">export</span> COMMUNITY_PLUGINS=1</span><br><span class="line">make dist</span><br></pre></td></tr></table></figure>

<h3 id="编译优化"><a href="#编译优化" class="headerlink" title="编译优化"></a>编译优化</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 并行编译</span></span><br><span class="line">make -j$(<span class="built_in">nproc</span>) dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 详细输出</span></span><br><span class="line">make V=1 dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 跳过测试</span></span><br><span class="line">make SKIP_TESTS=1 dist</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="源码关键文件索引"><a href="#源码关键文件索引" class="headerlink" title="源码关键文件索引"></a>源码关键文件索引</h2><table>
<thead>
<tr>
<th>文件</th>
<th>作用</th>
<th>关键内容</th>
</tr>
</thead>
<tbody><tr>
<td><code>Makefile</code></td>
<td>主构建文件</td>
<td>目标定义、变量设置</td>
</tr>
<tr>
<td><code>erlang.mk</code></td>
<td>Erlang 构建系统</td>
<td>编译规则、依赖管理</td>
</tr>
<tr>
<td><code>rabbitmq-components.mk</code></td>
<td>RabbitMQ 构建规则</td>
<td>版本控制、组件管理</td>
</tr>
<tr>
<td><code>deps/rabbit_common/mk/rabbitmq-dist.mk</code></td>
<td>分发系统</td>
<td>插件打包、EZ 格式</td>
</tr>
<tr>
<td><code>packaging/generic-unix/Makefile</code></td>
<td>Unix 打包</td>
<td>安装布局、脚本配置</td>
</tr>
<tr>
<td><code>plugins.mk</code></td>
<td>插件列表</td>
<td>所有官方插件定义</td>
</tr>
</tbody></table>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>RabbitMQ 的构建系统设计精良，通过不同的编译命令满足了从开发到生产的各种需求：</p>
<ol>
<li><strong><code>make</code></strong> - 开发基础，快速迭代</li>
<li><strong><code>make dist</code></strong> - 生产标准，目录部署  </li>
<li><strong><code>make dist DIST_AS_EZS=true</code></strong> - 插件分发，压缩高效</li>
<li><strong><code>make package-generic-unix</code></strong> - 跨平台部署，自包含</li>
<li><strong><code>make install</code></strong> - 系统集成，标准化安装</li>
</ol>
<p>理解这些编译方式的原理，有助于更好地进行 RabbitMQ 的开发、部署和运维工作。选择合适的编译方式，能够显著提升 RabbitMQ 的开发效率和部署质量。</p>
]]></content>
      <categories>
        <category>RabbitMQ</category>
      </categories>
      <tags>
        <tag>Erlang</tag>
        <tag>RabbitMQ</tag>
        <tag>编译</tag>
        <tag>构建系统</tag>
        <tag>源码分析</tag>
      </tags>
  </entry>
  <entry>
    <title>第四章：通用型服务器 gen_server</title>
    <url>/2024/01/18/erlang-erlang-otp-gen-server/</url>
    <content><![CDATA[<p>本文介绍 Erlang&#x2F;OTP 中的通用型服务器行为模式 gen_server，这是 OTP 框架中最常用的 behavior 之一。</p>
<span id="more"></span>

<h2 id="gen-server-概述"><a href="#gen-server-概述" class="headerlink" title="gen_server 概述"></a>gen_server 概述</h2><p>gen_server 是 OTP 提供的通用服务器行为模式，它封装了客户端-服务器模型中的常见模式，让开发者可以专注于业务逻辑而不是底层的进程通信细节。</p>
<p>使用 gen_server 的优势：</p>
<ul>
<li>标准化的服务器实现模式</li>
<li>内置的错误处理机制</li>
<li>支持同步和异步消息传递</li>
<li>与 OTP 监督树无缝集成</li>
</ul>
<h2 id="behavior-指令"><a href="#behavior-指令" class="headerlink" title="behavior 指令"></a>behavior 指令</h2><p>要实现一个 gen_server，需要在模块中声明 behavior：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">-module</span><span class="params">(my_server)</span>.</span><br><span class="line"><span class="keyword">-behaviour</span><span class="params">(gen_server)</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">%% API</span></span><br><span class="line"><span class="keyword">-export</span><span class="params">([start_link/<span class="number">0</span>, stop/<span class="number">0</span>])</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">%% gen_server 回调函数</span></span><br><span class="line"><span class="keyword">-export</span><span class="params">([init/<span class="number">1</span>, handle_call/<span class="number">3</span>, handle_cast/<span class="number">2</span>, handle_info/<span class="number">2</span>,</span></span><br><span class="line"><span class="params">         terminate/<span class="number">2</span>, code_change/<span class="number">3</span>])</span>.</span><br></pre></td></tr></table></figure>

<h2 id="启动一个-server"><a href="#启动一个-server" class="headerlink" title="启动一个 server"></a>启动一个 server</h2><p>gen_server 提供了多种启动函数：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="comment">%% 启动一个匿名服务器</span></span><br><span class="line">gen_server:start_link(Module, Args, Options)</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 启动一个命名服务器（本地注册）</span></span><br><span class="line">gen_server:start_link(&#123;local, Name&#125;, Module, Args, Options)</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 启动一个命名服务器（全局注册）</span></span><br><span class="line">gen_server:start_link(&#123;global, Name&#125;, Module, Args, Options)</span><br></pre></td></tr></table></figure>

<p>启动时会调用 <code>init/1</code> 回调函数：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">init</span><span class="params">(Args)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 初始化服务器状态</span></span><br><span class="line">    State = #state&#123;&#125;,</span><br><span class="line">    &#123;ok, State&#125;.</span><br></pre></td></tr></table></figure>

<p><code>init/1</code> 可以返回：</p>
<ul>
<li><code>{ok, State}</code> - 正常启动</li>
<li><code>{ok, State, Timeout}</code> - 启动并设置超时</li>
<li><code>{ok, State, hibernate}</code> - 启动并进入休眠</li>
<li><code>{stop, Reason}</code> - 启动失败</li>
<li><code>ignore</code> - 忽略启动</li>
</ul>
<h2 id="消息传递"><a href="#消息传递" class="headerlink" title="消息传递"></a>消息传递</h2><p>gen_server 支持多种消息传递方式：</p>
<p><img src="/images/erlang_otp/gen_server_flow.svg" alt="gen_server 消息传递流程"></p>
<h3 id="同步式消息传递"><a href="#同步式消息传递" class="headerlink" title="同步式消息传递"></a>同步式消息传递</h3><p>使用 <code>gen_server:call/2,3</code> 发送同步请求，客户端会阻塞等待响应：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="comment">%% 客户端调用</span></span><br><span class="line">Result = gen_server:call(ServerRef, Request),</span><br><span class="line">Result = gen_server:call(ServerRef, Request, Timeout).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 服务器端处理</span></span><br><span class="line"><span class="function"><span class="title">handle_call</span><span class="params">(Request, From, State)</span> -&gt;</span></span><br><span class="line">    Reply = do_something(Request),</span><br><span class="line">    &#123;reply, Reply, State&#125;.</span><br></pre></td></tr></table></figure>

<p><code>handle_call/3</code> 的参数：</p>
<ul>
<li><code>Request</code> - 客户端发送的请求</li>
<li><code>From</code> - 调用者信息 <code>{Pid, Tag}</code></li>
<li><code>State</code> - 当前服务器状态</li>
</ul>
<h3 id="异步式消息传递"><a href="#异步式消息传递" class="headerlink" title="异步式消息传递"></a>异步式消息传递</h3><p>使用 <code>gen_server:cast/2</code> 发送异步请求，客户端不等待响应：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="comment">%% 客户端调用</span></span><br><span class="line">ok = gen_server:cast(ServerRef, Msg).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 服务器端处理</span></span><br><span class="line"><span class="function"><span class="title">handle_cast</span><span class="params">(Msg, State)</span> -&gt;</span></span><br><span class="line">    NewState = process_msg(Msg, State),</span><br><span class="line">    &#123;noreply, NewState&#125;.</span><br></pre></td></tr></table></figure>

<h3 id="其他消息"><a href="#其他消息" class="headerlink" title="其他消息"></a>其他消息</h3><p>服务器可能收到不是通过 <code>call</code> 或 <code>cast</code> 发送的消息，这些消息由 <code>handle_info/2</code> 处理：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">handle_info</span><span class="params">(Info, State)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Info <span class="keyword">of</span></span><br><span class="line">        timeout -&gt;</span><br><span class="line">            <span class="comment">%% 处理超时</span></span><br><span class="line">            &#123;noreply, State&#125;;</span><br><span class="line">        &#123;nodedown, Node&#125; -&gt;</span><br><span class="line">            <span class="comment">%% 处理节点断开</span></span><br><span class="line">            &#123;noreply, State&#125;;</span><br><span class="line">        _Other -&gt;</span><br><span class="line">            <span class="comment">%% 忽略未知消息</span></span><br><span class="line">            &#123;noreply, State&#125;</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<h3 id="未处理的消息"><a href="#未处理的消息" class="headerlink" title="未处理的消息"></a>未处理的消息</h3><p>良好的实践是在 <code>handle_info/2</code> 中记录未预期的消息：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">handle_info</span><span class="params">(Msg, State)</span> -&gt;</span></span><br><span class="line">    error_logger:warning_msg(<span class="string">&quot;Unexpected message: ~p~n&quot;</span>, [Msg]),</span><br><span class="line">    &#123;noreply, State&#125;.</span><br></pre></td></tr></table></figure>

<h2 id="同步客户端"><a href="#同步客户端" class="headerlink" title="同步客户端"></a>同步客户端</h2><p>实现一个完整的同步客户端 API：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">-module</span><span class="params">(kv_store)</span>.</span><br><span class="line"><span class="keyword">-behaviour</span><span class="params">(gen_server)</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">%% API</span></span><br><span class="line"><span class="keyword">-export</span><span class="params">([start_link/<span class="number">0</span>, get/<span class="number">1</span>, put/<span class="number">2</span>, delete/<span class="number">1</span>])</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">%% gen_server callbacks</span></span><br><span class="line"><span class="keyword">-export</span><span class="params">([init/<span class="number">1</span>, handle_call/<span class="number">3</span>, handle_cast/<span class="number">2</span>, handle_info/<span class="number">2</span>,</span></span><br><span class="line"><span class="params">         terminate/<span class="number">2</span>, code_change/<span class="number">3</span>])</span>.</span><br><span class="line"></span><br><span class="line"><span class="keyword">-record</span><span class="params">(state, &#123;store = #&#123;&#125;&#125;)</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">%%% API 函数</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start_link</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    gen_server:start_link(&#123;local, ?MODULE&#125;, ?MODULE, [], []).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get</span><span class="params">(Key)</span> -&gt;</span></span><br><span class="line">    gen_server:call(?MODULE, &#123;get, Key&#125;).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">put</span><span class="params">(Key, Value)</span> -&gt;</span></span><br><span class="line">    gen_server:call(?MODULE, &#123;put, Key, Value&#125;).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">delete</span><span class="params">(Key)</span> -&gt;</span></span><br><span class="line">    gen_server:call(?MODULE, &#123;delete, Key&#125;).</span><br><span class="line"></span><br><span class="line"><span class="comment">%%% 回调函数</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">init</span><span class="params">([])</span> -&gt;</span></span><br><span class="line">    &#123;ok, #state&#123;&#125;&#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">handle_call</span><span class="params">(&#123;get, Key&#125;, _From, State = #state&#123;store = Store&#125;)</span> -&gt;</span></span><br><span class="line">    Reply = maps:get(Key, Store, undefined),</span><br><span class="line">    &#123;reply, Reply, State&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">handle_call</span><span class="params">(&#123;put, Key, Value&#125;, _From, State = #state&#123;store = Store&#125;)</span> -&gt;</span></span><br><span class="line">    NewStore = maps:put(Key, Value, Store),</span><br><span class="line">    &#123;reply, ok, State#state&#123;store = NewStore&#125;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">handle_call</span><span class="params">(&#123;delete, Key&#125;, _From, State = #state&#123;store = Store&#125;)</span> -&gt;</span></span><br><span class="line">    NewStore = maps:remove(Key, Store),</span><br><span class="line">    &#123;reply, ok, State#state&#123;store = NewStore&#125;&#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">handle_cast</span><span class="params">(_Msg, State)</span> -&gt;</span></span><br><span class="line">    &#123;noreply, State&#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">handle_info</span><span class="params">(_Info, State)</span> -&gt;</span></span><br><span class="line">    &#123;noreply, State&#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">terminate</span><span class="params">(_Reason, _State)</span> -&gt;</span></span><br><span class="line">    ok.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">code_change</span><span class="params">(_OldVsn, State, _Extra)</span> -&gt;</span></span><br><span class="line">    &#123;ok, State&#125;.</span><br></pre></td></tr></table></figure>

<h2 id="终止"><a href="#终止" class="headerlink" title="终止"></a>终止</h2><p>服务器终止时会调用 <code>terminate/2</code>：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">terminate</span><span class="params">(Reason, State)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 清理资源</span></span><br><span class="line">    cleanup(State),</span><br><span class="line">    ok.</span><br></pre></td></tr></table></figure>

<p>终止原因可能是：</p>
<ul>
<li><code>normal</code> - 正常终止</li>
<li><code>shutdown</code> - 监督者要求关闭</li>
<li><code>{shutdown, Term}</code> - 带额外信息的关闭</li>
<li>其他值 - 异常终止</li>
</ul>
<h2 id="调用超时"><a href="#调用超时" class="headerlink" title="调用超时"></a>调用超时</h2><p><code>gen_server:call/3</code> 支持设置超时时间：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="comment">%% 默认超时 5000ms</span></span><br><span class="line">gen_server:call(Server, Request).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 自定义超时</span></span><br><span class="line">gen_server:call(Server, Request, <span class="number">10000</span>).  <span class="comment">%% 10秒</span></span><br><span class="line"></span><br><span class="line"><span class="comment">%% 无限等待</span></span><br><span class="line">gen_server:call(Server, Request, infinity).</span><br></pre></td></tr></table></figure>

<p>超时后客户端会收到 <code>exit</code> 信号：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span></span><br><span class="line">    gen_server:call(Server, Request, <span class="number">5000</span>)</span><br><span class="line"><span class="keyword">catch</span></span><br><span class="line">    exit:&#123;timeout, _&#125; -&gt;</span><br><span class="line">        &#123;error, timeout&#125;</span><br><span class="line"><span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<h2 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h2><p>避免 gen_server 死锁的几个原则：</p>
<ol>
<li><strong>不要在回调函数中调用自己</strong>：</li>
</ol>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="comment">%% 错误示例 - 会导致死锁</span></span><br><span class="line"><span class="function"><span class="title">handle_call</span><span class="params">(get_twice, _From, State)</span> -&gt;</span></span><br><span class="line">    Result1 = gen_server:call(self(), get),  <span class="comment">%% 死锁！</span></span><br><span class="line">    &#123;reply, Result1, State&#125;.</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>避免循环调用</strong>：</li>
</ol>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="comment">%% Server A 调用 Server B，Server B 又调用 Server A</span></span><br><span class="line"><span class="comment">%% 这会导致死锁</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>使用 cast 代替 call 打破循环</strong></li>
</ol>
<h2 id="通用型-server-的超时问题"><a href="#通用型-server-的超时问题" class="headerlink" title="通用型 server 的超时问题"></a>通用型 server 的超时问题</h2><p>可以在回调函数中返回超时值：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">init</span><span class="params">([])</span> -&gt;</span></span><br><span class="line">    &#123;ok, #state&#123;&#125;, <span class="number">5000</span>&#125;.  <span class="comment">%% 5秒后触发 timeout</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">handle_call</span><span class="params">(Request, _From, State)</span> -&gt;</span></span><br><span class="line">    &#123;reply, ok, State, <span class="number">5000</span>&#125;.  <span class="comment">%% 重置超时</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">handle_info</span><span class="params">(timeout, State)</span> -&gt;</span></span><br><span class="line">    <span class="comment">%% 处理超时，例如执行定期任务</span></span><br><span class="line">    do_periodic_work(),</span><br><span class="line">    &#123;noreply, State, <span class="number">5000</span>&#125;.  <span class="comment">%% 继续等待下一个超时</span></span><br></pre></td></tr></table></figure>

<h2 id="使-behavior-休眠"><a href="#使-behavior-休眠" class="headerlink" title="使 behavior 休眠"></a>使 behavior 休眠</h2><p>当服务器空闲时，可以让它进入休眠状态以释放内存：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">handle_call</span><span class="params">(Request, _From, State)</span> -&gt;</span></span><br><span class="line">    &#123;reply, ok, State, hibernate&#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">handle_cast</span><span class="params">(Msg, State)</span> -&gt;</span></span><br><span class="line">    &#123;noreply, State, hibernate&#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">handle_info</span><span class="params">(Info, State)</span> -&gt;</span></span><br><span class="line">    &#123;noreply, State, hibernate&#125;.</span><br></pre></td></tr></table></figure>

<p>休眠时，进程会进行垃圾回收并最小化内存占用。收到新消息时自动唤醒。</p>
<h2 id="全局化"><a href="#全局化" class="headerlink" title="全局化"></a>全局化</h2><p>使用全局名称注册 gen_server：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="comment">%% 全局注册启动</span></span><br><span class="line">gen_server:start_link(&#123;global, my_global_server&#125;, ?MODULE, [], []).</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 全局调用</span></span><br><span class="line">gen_server:call(&#123;global, my_global_server&#125;, Request).</span><br><span class="line">gen_server:cast(&#123;global, my_global_server&#125;, Msg).</span><br></pre></td></tr></table></figure>

<p>也可以使用 <code>via</code> 元组与自定义注册表：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="comment">%% 使用 gproc 作为注册表</span></span><br><span class="line">gen_server:start_link(&#123;via, gproc, &#123;n, l, my_server&#125;&#125;, ?MODULE, [], []).</span><br></pre></td></tr></table></figure>

<h2 id="链接-behavior"><a href="#链接-behavior" class="headerlink" title="链接 behavior"></a>链接 behavior</h2><p>gen_server 通常与监督者链接使用：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line"><span class="comment">%% 在监督者中定义子规范</span></span><br><span class="line"><span class="function"><span class="title">init</span><span class="params">([])</span> -&gt;</span></span><br><span class="line">    Children = [</span><br><span class="line">        #&#123;id =&gt; my_server,</span><br><span class="line">          start =&gt; &#123;my_server, start_link, []&#125;,</span><br><span class="line">          restart =&gt; permanent,</span><br><span class="line">          shutdown =&gt; <span class="number">5000</span>,</span><br><span class="line">          type =&gt; worker,</span><br><span class="line">          modules =&gt; [my_server]&#125;</span><br><span class="line">    ],</span><br><span class="line">    &#123;ok, &#123;#&#123;strategy =&gt; one_for_one&#125;, Children&#125;&#125;.</span><br></pre></td></tr></table></figure>

<h2 id="gen-server-生命周期"><a href="#gen-server-生命周期" class="headerlink" title="gen_server 生命周期"></a>gen_server 生命周期</h2><p><img src="/images/erlang_otp/gen_server_lifecycle.svg" alt="gen_server 生命周期"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>gen_server 是 Erlang&#x2F;OTP 中最重要的 behavior 之一：</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>同步调用</td>
<td><code>call/2,3</code> + <code>handle_call/3</code></td>
</tr>
<tr>
<td>异步调用</td>
<td><code>cast/2</code> + <code>handle_cast/2</code></td>
</tr>
<tr>
<td>其他消息</td>
<td><code>handle_info/2</code></td>
</tr>
<tr>
<td>生命周期</td>
<td><code>init/1</code> → 运行 → <code>terminate/2</code></td>
</tr>
<tr>
<td>超时处理</td>
<td>回调返回值中指定</td>
</tr>
<tr>
<td>休眠</td>
<td><code>hibernate</code> 选项</td>
</tr>
</tbody></table>
<p>掌握 gen_server 是学习 OTP 的基础，它为构建健壮的并发应用提供了标准化的模式。</p>
<h2 id="接下来是什么"><a href="#接下来是什么" class="headerlink" title="接下来是什么"></a>接下来是什么</h2><p>下一章我们将学习 <strong>gen_statem</strong>（有限状态机）行为模式，它适用于需要状态转换的场景。</p>
<hr>
<h2 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h2><ul>
<li><a href="https://www.erlang.org/doc/man/gen_server.html">Erlang gen_server 官方文档</a></li>
<li><a href="https://www.erlang.org/doc/design_principles/gen_server_concepts.html">OTP Design Principles</a></li>
</ul>
]]></content>
      <categories>
        <category>技术</category>
        <category>Erlang/OTP</category>
      </categories>
      <tags>
        <tag>Erlang</tag>
        <tag>OTP</tag>
        <tag>并发编程</tag>
        <tag>gen_server</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQ 服务器编译指南</title>
    <url>/2026/01/16/rabbitmq-rabbitmq-compilation-guide/</url>
    <content><![CDATA[<h1 id="RabbitMQ-服务器编译指南"><a href="#RabbitMQ-服务器编译指南" class="headerlink" title="RabbitMQ 服务器编译指南"></a>RabbitMQ 服务器编译指南</h1><p>本文档记录了在 macOS (Apple Silicon) 环境下编译 RabbitMQ 服务器的完整过程，包括遇到的问题和解决方案。</p>
<span id="more"></span>

<h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><ul>
<li><strong>操作系统</strong>: macOS (Darwin)</li>
<li><strong>架构</strong>: Apple Silicon (ARM64)</li>
<li><strong>Shell</strong>: bash</li>
<li><strong>包管理器</strong>: Homebrew</li>
</ul>
<h2 id="系统要求"><a href="#系统要求" class="headerlink" title="系统要求"></a>系统要求</h2><h3 id="必需工具"><a href="#必需工具" class="headerlink" title="必需工具"></a>必需工具</h3><ol>
<li><p><strong>GNU Make 4+</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install make</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Erlang 27.x</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install erlang@27</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>p7zip (7z 命令)</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install p7zip</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Git</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install git</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="可选工具"><a href="#可选工具" class="headerlink" title="可选工具"></a>可选工具</h3><ul>
<li><strong>Elixir</strong> (用于 CLI 工具)</li>
<li><strong>rebar3</strong> (Erlang 构建工具)</li>
</ul>
<h2 id="编译过程"><a href="#编译过程" class="headerlink" title="编译过程"></a>编译过程</h2><h3 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1. 环境准备"></a>1. 环境准备</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 克隆 RabbitMQ 服务器源码</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/rabbitmq/rabbitmq-server.git</span><br><span class="line"><span class="built_in">cd</span> rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/opt/homebrew/opt/erlang@27/bin:/opt/homebrew/bin:<span class="variable">$PATH</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-清理和编译"><a href="#2-清理和编译" class="headerlink" title="2. 清理和编译"></a>2. 清理和编译</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 清理所有构建产物</span></span><br><span class="line">git clean -xfffd</span><br><span class="line">gmake clean</span><br><span class="line">gmake distclean</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始编译（推荐使用单线程避免并发问题）</span></span><br><span class="line">gmake -j1</span><br></pre></td></tr></table></figure>

<h2 id="遇到的问题和解决方案"><a href="#遇到的问题和解决方案" class="headerlink" title="遇到的问题和解决方案"></a>遇到的问题和解决方案</h2><h3 id="问题-1-Erlang-版本不兼容"><a href="#问题-1-Erlang-版本不兼容" class="headerlink" title="问题 1: Erlang 版本不兼容"></a>问题 1: Erlang 版本不兼容</h3><p><strong>错误信息</strong>:</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">rabbit_data_coercion.erl:76:23: syntax <span class="built_in">error</span> before: <span class="string">&#x27;||&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>原因</strong>: RabbitMQ 4.x 使用了 Erlang 26+ 才支持的 map comprehension 语法，而系统安装的是 Erlang 25。</p>
<p><strong>解决方案</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 卸载旧版本 Erlang</span></span><br><span class="line">brew uninstall erlang@25</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Erlang 27</span></span><br><span class="line">brew install erlang@27</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新 PATH</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/opt/homebrew/opt/erlang@27/bin:<span class="variable">$PATH</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>验证</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">erl -version</span><br><span class="line"><span class="comment"># 应该显示: Erlang (SMP,ASYNC_THREADS) (BEAM) emulator version 15.2.7.4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试 map comprehension 语法</span></span><br><span class="line">erl -<span class="built_in">eval</span> <span class="string">&#x27;M = #&#123;a =&gt; 1, b =&gt; 2&#125;, R = #&#123;K =&gt; V || K := V &lt;- M&#125;, io:format(&quot;~p~n&quot;, [R]), halt().&#x27;</span> -noshell</span><br><span class="line"><span class="comment"># 应该输出: #&#123;a =&gt; 1,b =&gt; 2&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="问题-2-wxWidgets-兼容性问题"><a href="#问题-2-wxWidgets-兼容性问题" class="headerlink" title="问题 2: wxWidgets 兼容性问题"></a>问题 2: wxWidgets 兼容性问题</h3><p><strong>错误信息</strong>:</p>
<figure class="highlight excel"><table><tr><td class="code"><pre><span class="line">observ<span class="symbol">er:st</span>art().</span><br><span class="line">=CRASH REPORT==== Symbol <span class="built_in">not</span> fou<span class="symbol">nd:</span> __ZNK8wxCursor10GetHotSpotEv</span><br></pre></td></tr></table></figure>

<p><strong>原因</strong>: Erlang 27 与现有的 wxWidgets 版本不兼容。</p>
<p><strong>解决方案</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 卸载 Erlang 27 和 wxWidgets</span></span><br><span class="line">brew uninstall erlang@27</span><br><span class="line">brew uninstall --ignore-dependencies wxwidgets</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新安装（这会自动安装兼容的 wxWidgets 版本）</span></span><br><span class="line">brew install erlang@27</span><br></pre></td></tr></table></figure>

<p><strong>验证</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 测试 observer 是否正常工作</span></span><br><span class="line">erl -<span class="built_in">eval</span> <span class="string">&#x27;observer:start(), timer:sleep(2000), observer:stop(), halt().&#x27;</span></span><br><span class="line"><span class="comment"># 应该正常启动和关闭，无错误信息</span></span><br></pre></td></tr></table></figure>

<h3 id="问题-3-缺少-7z-命令"><a href="#问题-3-缺少-7z-命令" class="headerlink" title="问题 3: 缺少 7z 命令"></a>问题 3: 缺少 7z 命令</h3><p><strong>错误信息</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/bin/sh: 7z: <span class="built_in">command</span> not found</span><br><span class="line">gmake[2]: *** [../../erlang.mk:3510: escript-zip] Error 127</span><br></pre></td></tr></table></figure>

<p><strong>原因</strong>: RabbitMQ CLI 工具构建需要 7z 命令来创建 escript 归档。</p>
<p><strong>解决方案</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 p7zip</span></span><br><span class="line">brew install p7zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line"><span class="built_in">which</span> 7z</span><br><span class="line"><span class="comment"># 应该输出: /opt/homebrew/bin/7z</span></span><br></pre></td></tr></table></figure>

<h3 id="问题-4-hex-core-依赖构建失败"><a href="#问题-4-hex-core-依赖构建失败" class="headerlink" title="问题 4: hex_core 依赖构建失败"></a>问题 4: hex_core 依赖构建失败</h3><p><strong>错误信息</strong>:</p>
<figure class="highlight gams"><table><tr><td class="code"><pre><span class="line">gmake[<span class="number">2</span>]: *** <span class="keyword">No</span> targets specified <span class="keyword">and</span> <span class="keyword">no</span> makefile found.  Stop.</span><br><span class="line">touch: cannot touch <span class="string">&#x27;/Users/.../deps/hex_core/ebin/dep_built&#x27;</span>: <span class="keyword">No</span> such <span class="keyword">file</span> <span class="keyword">or</span> directory</span><br></pre></td></tr></table></figure>

<p><strong>原因</strong>: hex_core 使用 rebar3 构建系统，但 erlang.mk 尝试用 make 构建它。</p>
<p><strong>解决方案</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 手动编译 hex_core</span></span><br><span class="line"><span class="built_in">cd</span> deps/hex_core</span><br><span class="line"><span class="built_in">mkdir</span> -p ebin</span><br><span class="line">erlc -o ebin src/*.erl</span><br><span class="line"><span class="built_in">cp</span> src/hex_core.app.src ebin/hex_core.app</span><br><span class="line"><span class="built_in">touch</span> ebin/dep_built</span><br><span class="line"><span class="built_in">cd</span> ../..</span><br></pre></td></tr></table></figure>

<h3 id="问题-5-ra-模块并发编译问题"><a href="#问题-5-ra-模块并发编译问题" class="headerlink" title="问题 5: ra 模块并发编译问题"></a>问题 5: ra 模块并发编译问题</h3><p><strong>错误信息</strong>:</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">failed <span class="keyword">to</span> <span class="built_in">rename</span> .../ra_snapshot.bea# <span class="keyword">to</span> .../ra_snapshot.beam: <span class="keyword">no</span> such <span class="keyword">file</span> <span class="built_in">or</span> directory</span><br></pre></td></tr></table></figure>

<p><strong>原因</strong>: 并发编译时文件操作冲突。</p>
<p><strong>解决方案</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用单线程编译</span></span><br><span class="line">gmake -j1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者清理 ra 目录后重新编译</span></span><br><span class="line"><span class="built_in">rm</span> -rf deps/ra/ebin</span><br><span class="line"><span class="built_in">mkdir</span> deps/ra/ebin</span><br><span class="line">gmake -j1 deps</span><br></pre></td></tr></table></figure>

<h3 id="问题-6-Generic-Unix-包构建中的重复文件名错误"><a href="#问题-6-Generic-Unix-包构建中的重复文件名错误" class="headerlink" title="问题 6: Generic Unix 包构建中的重复文件名错误"></a>问题 6: Generic Unix 包构建中的重复文件名错误</h3><p><strong>错误信息</strong>:</p>
<figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ERROR:</span></span><br><span class="line"><span class="keyword"></span>Duplicate filename on disk:</span><br><span class="line">dep_built</span><br><span class="line">dep_built</span><br><span class="line">make[6]: *** [../../erlang.mk:3511: escript-zip] Error 2</span><br></pre></td></tr></table></figure>

<p><strong>原因</strong>: 在创建 escript zip 文件时，多个依赖项中都包含 <code>dep_built</code> 文件，导致 7z 归档时文件名冲突。</p>
<p><strong>解决方案</strong>:</p>
<p>方法1 - 临时删除 dep_built 文件：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除所有 dep_built 文件</span></span><br><span class="line">find deps -name <span class="string">&quot;dep_built&quot;</span> -delete</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后构建包</span></span><br><span class="line">gmake package-generic-unix</span><br></pre></td></tr></table></figure>

<p>方法2 - 修改 erlang.mk（永久解决）：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在 erlang.mk 第3510-3515行，添加 filter-out 来排除 dep_built 文件</span></span><br><span class="line"><span class="comment"># 将：</span></span><br><span class="line"><span class="comment">#   $(subst $(DEPS_DIR)/,,$(addsuffix /*,$(wildcard \</span></span><br><span class="line"><span class="comment"># 改为：</span></span><br><span class="line"><span class="comment">#   $(filter-out %/dep_built,$(subst $(DEPS_DIR)/,,$(addsuffix /*,$(wildcard \</span></span><br></pre></td></tr></table></figure>

<p>方法3 - 使用构建脚本：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用提供的自动化脚本</span></span><br><span class="line">./build_package.sh</span><br></pre></td></tr></table></figure>

<p><strong>验证</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查生成的包文件</span></span><br><span class="line"><span class="built_in">ls</span> -la PACKAGES/rabbitmq-server-*.tar.xz</span><br></pre></td></tr></table></figure>

<h2 id="包构建脚本"><a href="#包构建脚本" class="headerlink" title="包构建脚本"></a>包构建脚本</h2><p>创建 <code>build_package.sh</code> 脚本来自动化包构建过程：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># RabbitMQ Generic Unix Package Build Script</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;开始构建 RabbitMQ Generic Unix 包...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/opt/homebrew/opt/erlang@27/bin:/opt/homebrew/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证环境</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;验证构建环境...&quot;</span></span><br><span class="line"><span class="built_in">which</span> gmake || &#123; <span class="built_in">echo</span> <span class="string">&quot;错误: 未找到 gmake&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"><span class="built_in">which</span> erl || &#123; <span class="built_in">echo</span> <span class="string">&quot;错误: 未找到 erlang&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"><span class="built_in">which</span> 7z || &#123; <span class="built_in">echo</span> <span class="string">&quot;错误: 未找到 7z&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 Erlang 版本</span></span><br><span class="line">ERL_VERSION=$(erl -<span class="built_in">eval</span> <span class="string">&#x27;io:format(&quot;~s&quot;, [erlang:system_info(otp_release)]), halt().&#x27;</span> -noshell)</span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ERL_VERSION</span>&quot;</span> &lt; <span class="string">&quot;27&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;错误: 需要 Erlang 27+，当前版本: <span class="variable">$ERL_VERSION</span>&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Erlang 版本: <span class="variable">$ERL_VERSION</span> ✓&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理可能导致问题的 dep_built 文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;清理 dep_built 文件...&quot;</span></span><br><span class="line">find deps -name <span class="string">&quot;dep_built&quot;</span> -delete 2&gt;/dev/null || <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保主项目已经构建</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;确保主项目已构建...&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;sbin/rabbitmq-server&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;主项目未构建，开始构建...&quot;</span></span><br><span class="line">    gmake -j1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建 generic-unix 包</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;构建 Generic Unix 包...&quot;</span></span><br><span class="line">gmake package-generic-unix</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;构建完成！&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查输出</span></span><br><span class="line">PACKAGE_DIR=<span class="string">&quot;PACKAGES&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="string">&quot;<span class="variable">$PACKAGE_DIR</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;生成的包文件:&quot;</span></span><br><span class="line">    <span class="built_in">ls</span> -la <span class="string">&quot;<span class="variable">$PACKAGE_DIR</span>&quot;</span>/rabbitmq-server-*.tar.xz 2&gt;/dev/null || <span class="built_in">echo</span> <span class="string">&quot;未找到 .tar.xz 文件&quot;</span></span><br><span class="line">    <span class="built_in">ls</span> -la <span class="string">&quot;<span class="variable">$PACKAGE_DIR</span>&quot;</span>/rabbitmq-server-*.tar.gz 2&gt;/dev/null || <span class="built_in">echo</span> <span class="string">&quot;未找到 .tar.gz 文件&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;警告: 未找到 PACKAGES 目录&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h2 id="完整编译脚本"><a href="#完整编译脚本" class="headerlink" title="完整编译脚本"></a>完整编译脚本</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># RabbitMQ 服务器编译脚本</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;开始编译 RabbitMQ 服务器...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/opt/homebrew/opt/erlang@27/bin:/opt/homebrew/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证必需工具</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;验证构建工具...&quot;</span></span><br><span class="line"><span class="built_in">which</span> gmake || &#123; <span class="built_in">echo</span> <span class="string">&quot;错误: 未找到 gmake&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"><span class="built_in">which</span> erl || &#123; <span class="built_in">echo</span> <span class="string">&quot;错误: 未找到 erlang&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"><span class="built_in">which</span> 7z || &#123; <span class="built_in">echo</span> <span class="string">&quot;错误: 未找到 7z&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 Erlang 版本</span></span><br><span class="line">ERL_VERSION=$(erl -<span class="built_in">eval</span> <span class="string">&#x27;io:format(&quot;~s&quot;, [erlang:system_info(otp_release)]), halt().&#x27;</span> -noshell)</span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ERL_VERSION</span>&quot;</span> &lt; <span class="string">&quot;27&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;错误: 需要 Erlang 27+，当前版本: <span class="variable">$ERL_VERSION</span>&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Erlang 版本: <span class="variable">$ERL_VERSION</span> ✓&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理构建产物</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;清理构建产物...&quot;</span></span><br><span class="line">git clean -xfffd</span><br><span class="line">gmake clean</span><br><span class="line">gmake distclean</span><br><span class="line"></span><br><span class="line"><span class="comment"># 手动构建 hex_core（如果需要）</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;deps/hex_core/ebin/dep_built&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;手动构建 hex_core...&quot;</span></span><br><span class="line">    <span class="built_in">cd</span> deps/hex_core</span><br><span class="line">    <span class="built_in">mkdir</span> -p ebin</span><br><span class="line">    erlc -o ebin src/*.erl 2&gt;/dev/null || <span class="literal">true</span></span><br><span class="line">    <span class="built_in">cp</span> src/hex_core.app.src ebin/hex_core.app 2&gt;/dev/null || <span class="literal">true</span></span><br><span class="line">    <span class="built_in">touch</span> ebin/dep_built</span><br><span class="line">    <span class="built_in">cd</span> ../..</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始编译</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;开始编译 RabbitMQ...&quot;</span></span><br><span class="line">gmake -j1</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;编译完成！&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证编译结果</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;验证编译结果...&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">&quot;sbin/rabbitmq-server&quot;</span> ] &amp;&amp; [ -f <span class="string">&quot;escript/rabbitmqctl&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 编译成功！&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  - 服务器脚本: sbin/rabbitmq-server&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  - 控制工具: escript/rabbitmqctl&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✗ 编译可能不完整，请检查错误信息&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h2 id="验证编译结果"><a href="#验证编译结果" class="headerlink" title="验证编译结果"></a>验证编译结果</h2><h3 id="检查生成的文件"><a href="#检查生成的文件" class="headerlink" title="检查生成的文件"></a>检查生成的文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查主要可执行文件</span></span><br><span class="line"><span class="built_in">ls</span> -la sbin/rabbitmq-server</span><br><span class="line"><span class="built_in">ls</span> -la escript/rabbitmqctl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查插件目录</span></span><br><span class="line"><span class="built_in">ls</span> -la plugins/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 Erlang beam 文件</span></span><br><span class="line">find deps/rabbit/ebin -name <span class="string">&quot;*.beam&quot;</span> | <span class="built_in">head</span> -5</span><br></pre></td></tr></table></figure>

<h3 id="运行测试"><a href="#运行测试" class="headerlink" title="运行测试"></a>运行测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动开发模式服务器</span></span><br><span class="line">gmake run-broker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在另一个终端中测试连接</span></span><br><span class="line">./escript/rabbitmqctl status</span><br></pre></td></tr></table></figure>

<h2 id="常见问题排查"><a href="#常见问题排查" class="headerlink" title="常见问题排查"></a>常见问题排查</h2><h3 id="编译时间过长"><a href="#编译时间过长" class="headerlink" title="编译时间过长"></a>编译时间过长</h3><ul>
<li><strong>原因</strong>: RabbitMQ 是大型项目，包含众多模块</li>
<li><strong>解决</strong>: 正常现象，完整编译需要 15-25 分钟</li>
</ul>
<h3 id="内存不足"><a href="#内存不足" class="headerlink" title="内存不足"></a>内存不足</h3><ul>
<li><strong>症状</strong>: 编译过程中系统卡顿或进程被杀死</li>
<li><strong>解决</strong>: 使用 <code>gmake -j1</code> 减少并发，或增加虚拟内存</li>
</ul>
<h3 id="权限问题"><a href="#权限问题" class="headerlink" title="权限问题"></a>权限问题</h3><ul>
<li><strong>症状</strong>: 无法创建文件或目录</li>
<li><strong>解决</strong>: 确保对项目目录有写权限，避免使用 sudo</li>
</ul>
<h3 id="网络问题"><a href="#网络问题" class="headerlink" title="网络问题"></a>网络问题</h3><ul>
<li><strong>症状</strong>: 依赖下载失败</li>
<li><strong>解决</strong>: 检查网络连接，考虑使用代理或镜像源</li>
</ul>
<h2 id="性能优化建议"><a href="#性能优化建议" class="headerlink" title="性能优化建议"></a>性能优化建议</h2><ol>
<li><strong>使用 SSD</strong>: 确保项目在 SSD 上编译</li>
<li><strong>充足内存</strong>: 推荐 8GB+ 内存</li>
<li><strong>单线程编译</strong>: 使用 <code>-j1</code> 避免并发问题</li>
<li><strong>清理缓存</strong>: 定期运行 <code>gmake distclean</code></li>
</ol>
<h2 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h2><ul>
<li><a href="https://www.rabbitmq.com/docs/">RabbitMQ 官方文档</a></li>
<li><a href="https://github.com/rabbitmq/rabbitmq-server">RabbitMQ GitHub 仓库</a></li>
<li><a href="https://www.erlang.org/docs">Erlang&#x2F;OTP 文档</a></li>
</ul>
<h2 id="版本信息"><a href="#版本信息" class="headerlink" title="版本信息"></a>版本信息</h2><ul>
<li><strong>文档版本</strong>: 1.0</li>
<li><strong>RabbitMQ 版本</strong>: 4.x (main 分支)</li>
<li><strong>Erlang 版本</strong>: 27.3.4.6</li>
<li><strong>创建日期</strong>: 2026-01-16</li>
<li><strong>最后更新</strong>: 2026-01-16</li>
</ul>
<hr>
<p><strong>注意</strong>: 本文档基于 macOS Apple Silicon 环境编写，其他平台可能需要调整部分步骤。</p>
]]></content>
      <categories>
        <category>技术</category>
        <category>RabbitMQ</category>
      </categories>
      <tags>
        <tag>Erlang</tag>
        <tag>RabbitMQ</tag>
        <tag>编译</tag>
        <tag>macOS</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQ 编译构建完全指南</title>
    <url>/2026/01/16/rabbitmq-rabbitmq-complete-build-guide/</url>
    <content><![CDATA[<h1 id="RabbitMQ-编译构建完全指南"><a href="#RabbitMQ-编译构建完全指南" class="headerlink" title="RabbitMQ 编译构建完全指南"></a>RabbitMQ 编译构建完全指南</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>基于 RabbitMQ 4.0.5 源码深度分析和实际构建验证，本文档全面解析各种编译方式的技术原理、实现机制和最佳实践。</p>
<h2 id="快速对比表"><a href="#快速对比表" class="headerlink" title="快速对比表"></a>快速对比表</h2><h3 id="构建命令"><a href="#构建命令" class="headerlink" title="构建命令"></a>构建命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
<th>输出格式</th>
<th>部署方式</th>
<th>编译时间</th>
<th>磁盘占用</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>make</code></td>
<td>编译</td>
<td>源码目录 + beam 文件</td>
<td>开发调试</td>
<td>最快</td>
<td>中等</td>
<td>本地开发、调试</td>
</tr>
<tr>
<td><code>make dist</code></td>
<td>打包文件</td>
<td>插件目录结构</td>
<td>目录部署</td>
<td>快</td>
<td>大</td>
<td>生产环境、插件开发</td>
</tr>
<tr>
<td><code>make dist DIST_AS_EZS=true</code></td>
<td>打包成 ez 文件</td>
<td>.ez 压缩包</td>
<td>插件安装</td>
<td>中等</td>
<td>小</td>
<td>插件分发、热加载</td>
</tr>
<tr>
<td><code>make source-dist</code></td>
<td>创建源码包</td>
<td>tar.xz 源码归档</td>
<td>源码分发</td>
<td>快</td>
<td>小</td>
<td>离线构建、版本发布</td>
</tr>
<tr>
<td><code>make package-generic-unix</code></td>
<td>打包成 PACKAGE 文件</td>
<td>tar.xz 包</td>
<td>解压安装</td>
<td>慢</td>
<td>最小</td>
<td>容器、跨平台</td>
</tr>
<tr>
<td><code>make install</code></td>
<td>安装到系统</td>
<td>系统目录</td>
<td>系统安装</td>
<td>中等</td>
<td>中等</td>
<td>生产部署</td>
</tr>
<tr>
<td><code>make install PREFIX=/opt/rabbitmq</code></td>
<td>安装到指定目录</td>
<td>自定义目录</td>
<td>自定义安装</td>
<td>中等</td>
<td>中等</td>
<td>自定义部署路径</td>
</tr>
</tbody></table>
<h3 id="开发调试命令"><a href="#开发调试命令" class="headerlink" title="开发调试命令"></a>开发调试命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>make run-broker</code></td>
<td>启动 RabbitMQ 服务器（前台运行）</td>
<td>开发调试、日志查看</td>
</tr>
<tr>
<td><code>make run-broker PLUGINS=&quot;plugin_name&quot;</code></td>
<td>启动并加载指定插件</td>
<td>插件测试、功能验证</td>
</tr>
<tr>
<td><code>make shell</code></td>
<td>进入 Erlang Shell</td>
<td>代码调试、模块测试</td>
</tr>
<tr>
<td><code>make run-background-broker</code></td>
<td>后台启动 RabbitMQ</td>
<td>自动化测试</td>
</tr>
<tr>
<td><code>make run-node</code></td>
<td>启动裸 Erlang 节点（无 RabbitMQ）</td>
<td>Erlang 调试</td>
</tr>
</tbody></table>
<hr>
<h2 id="1-make-基础编译"><a href="#1-make-基础编译" class="headerlink" title="1. make - 基础编译"></a>1. <code>make</code> - 基础编译</h2><h3 id="技术原理"><a href="#技术原理" class="headerlink" title="技术原理"></a>技术原理</h3><p>基于 <strong>erlang.mk</strong> 构建系统，执行 Erlang&#x2F;OTP 标准编译流程。</p>
<h4 id="核心实现机制"><a href="#核心实现机制" class="headerlink" title="核心实现机制"></a>核心实现机制</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile (第 77 行)</span></span><br><span class="line"><span class="keyword">include</span> erlang.mk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 来源：erlang.mk 核心逻辑</span></span><br><span class="line"><span class="section">app:: deps <span class="variable">$(PROJECT)</span>.d</span></span><br><span class="line">  <span class="variable">$(verbose)</span> <span class="variable">$(MAKE)</span> --no-print-directory app-build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认目标继承自 erlang.mk</span></span><br><span class="line"><span class="comment"># 编译流程：</span></span><br><span class="line"><span class="comment"># 1. 编译依赖 (deps)</span></span><br><span class="line"><span class="comment"># 2. 编译核心应用 (app)  </span></span><br><span class="line"><span class="comment"># 3. 生成启动脚本</span></span><br></pre></td></tr></table></figure>

<h4 id="编译流程"><a href="#编译流程" class="headerlink" title="编译流程"></a>编译流程</h4><figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">make</span><br><span class="line">  ↓</span><br><span class="line">解析依赖</span><br><span class="line">  ↓</span><br><span class="line">编译 deps/</span><br><span class="line">  ↓</span><br><span class="line">编译 <span class="string">.erl</span> → <span class="string">.beam</span></span><br><span class="line">  ↓</span><br><span class="line">生成启动脚本</span><br><span class="line">  ↓</span><br><span class="line">创建 sbin/ 目录</span><br></pre></td></tr></table></figure>

<h3 id="实际生成的文件结构"><a href="#实际生成的文件结构" class="headerlink" title="实际生成的文件结构"></a>实际生成的文件结构</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rabbitmq-server/</span><br><span class="line">├── deps/                          <span class="comment"># 依赖模块</span></span><br><span class="line">│   ├── rabbit/ebin/*.beam        <span class="comment"># 核心模块字节码</span></span><br><span class="line">│   ├── rabbit_common/ebin/*.beam <span class="comment"># 公共模块字节码</span></span><br><span class="line">│   └── */ebin/*.beam             <span class="comment"># 其他插件字节码</span></span><br><span class="line">├── sbin/                         <span class="comment"># 启动脚本 (25 个文件)</span></span><br><span class="line">│   ├── rabbitmq-server          <span class="comment"># 主服务器脚本</span></span><br><span class="line">│   ├── rabbitmqctl              <span class="comment"># 管理工具</span></span><br><span class="line">│   ├── rabbitmq-plugins         <span class="comment"># 插件管理</span></span><br><span class="line">│   └── ...                      <span class="comment"># 其他管理脚本</span></span><br><span class="line">└── escript/                      <span class="comment"># Erlang 脚本</span></span><br></pre></td></tr></table></figure>

<h3 id="使用场景与最佳实践"><a href="#使用场景与最佳实践" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 快速开发迭代</span></span><br><span class="line">make clean &amp;&amp; make</span><br><span class="line">sbin/rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 增量编译（推荐）</span></span><br><span class="line">make  <span class="comment"># 只编译修改的文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 开发调试</span></span><br><span class="line">make shell  <span class="comment"># 进入 Erlang shell</span></span><br></pre></td></tr></table></figure>

<h4 id="性能特点"><a href="#性能特点" class="headerlink" title="性能特点"></a>性能特点</h4><ul>
<li><strong>编译时间</strong>: 最快（支持增量编译）</li>
<li><strong>磁盘占用</strong>: 中等（包含源码和字节码）</li>
<li><strong>内存使用</strong>: 低</li>
<li><strong>适用场景</strong>: 开发调试、源码修改、性能测试</li>
</ul>
<hr>
<h2 id="2-make-dist-插件目录分发"><a href="#2-make-dist-插件目录分发" class="headerlink" title="2. make dist - 插件目录分发"></a>2. <code>make dist</code> - 插件目录分发</h2><h3 id="技术原理-1"><a href="#技术原理-1" class="headerlink" title="技术原理"></a>技术原理</h3><p>基于 <strong>rabbitmq-dist.mk</strong> 实现插件打包机制，创建标准的 RabbitMQ 插件目录结构。</p>
<h4 id="核心实现源码"><a href="#核心实现源码" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-dist.mk (第 166 行)</span></span><br><span class="line"><span class="section">dist:: <span class="variable">$(ERLANG_MK_RECURSIVE_DEPS_LIST)</span> all</span></span><br><span class="line">  <span class="variable">$(verbose)</span> rm -rf <span class="variable">$(DIST_DIR)</span></span><br><span class="line">  <span class="variable">$(verbose)</span> mkdir -p <span class="variable">$(DIST_DIR)</span></span><br><span class="line">  <span class="variable">$(gen_verbose)</span> <span class="variable">$(MAKE)</span> --no-print-directory do-dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件目录创建逻辑 (第 48-54 行)</span></span><br><span class="line">dist_$(1)_ez_dir = $<span class="variable">$(<span class="built_in">if</span> $(2)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)-$(2), \</span><br><span class="line">  $<span class="variable">$(<span class="built_in">if</span> $<span class="variable">$(VERSION)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)</span>-$<span class="variable">$(VERSION)</span>,<span class="variable">$(DIST_DIR)</span>/$(1)))</span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(DIST_AS_EZS)</span>,)</span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir)  <span class="comment"># 目录格式</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir).ez  <span class="comment"># EZ 格式</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<h4 id="打包流程详解"><a href="#打包流程详解" class="headerlink" title="打包流程详解"></a>打包流程详解</h4><ol>
<li><strong>编译所有模块</strong> - 确保所有 <code>.erl</code> 文件编译为 <code>.beam</code></li>
<li><strong>收集依赖</strong> - 将所有插件和依赖收集到 <code>plugins/</code> 目录</li>
<li><strong>生成插件结构</strong> - 每个插件包含 <code>ebin/</code>、<code>priv/</code> 等标准目录</li>
<li><strong>创建元数据</strong> - 生成 <code>.app</code> 文件描述插件信息</li>
</ol>
<h3 id="实际生成的目录结构"><a href="#实际生成的目录结构" class="headerlink" title="实际生成的目录结构"></a>实际生成的目录结构</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">plugins/</span><br><span class="line">├── rabbit-4.0.5/                 <span class="comment"># 核心模块目录</span></span><br><span class="line">│   ├── ebin/</span><br><span class="line">│   │   ├── rabbit.app            <span class="comment"># 应用描述文件</span></span><br><span class="line">│   │   ├── rabbit.beam           <span class="comment"># 编译后的字节码</span></span><br><span class="line">│   │   └── *.beam                <span class="comment"># 其他模块字节码</span></span><br><span class="line">│   ├── include/                  <span class="comment"># 头文件</span></span><br><span class="line">│   └── priv/                     <span class="comment"># 私有资源</span></span><br><span class="line">├── rabbitmq_management-4.0.5/    <span class="comment"># 管理插件目录</span></span><br><span class="line">├── rabbitmq_prometheus-4.0.5/    <span class="comment"># 监控插件目录</span></span><br><span class="line">└── ...                           <span class="comment"># 其他插件目录</span></span><br></pre></td></tr></table></figure>

<h3 id="使用场景与最佳实践-1"><a href="#使用场景与最佳实践-1" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="生产环境"><a href="#生产环境" class="headerlink" title="生产环境"></a>生产环境</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建发布版本</span></span><br><span class="line">make dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 验证插件结构</span></span><br><span class="line"><span class="built_in">ls</span> -la plugins/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 部署到生产环境</span></span><br><span class="line">rsync -av plugins/ /opt/rabbitmq/plugins/</span><br></pre></td></tr></table></figure>

<h4 id="插件开发"><a href="#插件开发" class="headerlink" title="插件开发"></a>插件开发</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 开发模式</span></span><br><span class="line">make dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 插件测试</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;plugin_name&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-make-dist-DIST-AS-EZS-true-EZ-压缩包分发"><a href="#3-make-dist-DIST-AS-EZS-true-EZ-压缩包分发" class="headerlink" title="3. make dist DIST_AS_EZS=true - EZ 压缩包分发"></a>3. <code>make dist DIST_AS_EZS=true</code> - EZ 压缩包分发</h2><h3 id="技术原理-2"><a href="#技术原理-2" class="headerlink" title="技术原理"></a>技术原理</h3><p>EZ 格式是 Erlang 的标准插件打包格式，本质上是重命名的 ZIP 文件。</p>
<h4 id="核心实现逻辑"><a href="#核心实现逻辑" class="headerlink" title="核心实现逻辑"></a>核心实现逻辑</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-dist.mk (第 8-14 行)</span></span><br><span class="line"><span class="comment"># Set $(DIST_AS_EZS) to a non-empty value to enable the packaging of</span></span><br><span class="line"><span class="comment"># plugins as .ez archives.</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(USE_RABBIT_BOOT_SCRIPT)</span>,)</span><br><span class="line">DIST_AS_EZS ?=                    <span class="comment"># 默认为空（目录格式）</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">DIST_AS_EZS =                     <span class="comment"># 强制目录格式</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<h4 id="EZ-文件生成流程"><a href="#EZ-文件生成流程" class="headerlink" title="EZ 文件生成流程"></a>EZ 文件生成流程</h4><figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">make dist DIST_AS_EZS<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">  ↓</span><br><span class="line">编译所有模块</span><br><span class="line">  ↓</span><br><span class="line">收集 ebin<span class="symbol">/</span> include<span class="symbol">/</span> priv<span class="symbol">/</span></span><br><span class="line">  ↓</span><br><span class="line">创建临时目录结构</span><br><span class="line">  ↓</span><br><span class="line">ZIP 压缩</span><br><span class="line">  ↓</span><br><span class="line">重命名为 .ez</span><br><span class="line">  ↓</span><br><span class="line">移动到 plugins<span class="operator">/</span></span><br></pre></td></tr></table></figure>

<h3 id="实际生成的-EZ-文件（已验证）"><a href="#实际生成的-EZ-文件（已验证）" class="headerlink" title="实际生成的 EZ 文件（已验证）"></a>实际生成的 EZ 文件（已验证）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">plugins/</span><br><span class="line">├── rabbit-4.0.5.ez              <span class="comment"># 3.38 MB - 核心模块</span></span><br><span class="line">├── rabbit_common-4.0.5.ez       <span class="comment"># 770.91 KB - 公共模块  </span></span><br><span class="line">├── rabbitmq_management-4.0.5.ez <span class="comment"># 管理界面插件</span></span><br><span class="line">├── rabbitmq_prometheus-4.0.5.ez <span class="comment"># 监控插件</span></span><br><span class="line">├── amqp_client-4.0.5.ez         <span class="comment"># 332.75 KB - AMQP 客户端</span></span><br><span class="line">├── cowboy-2.12.0.ez             <span class="comment"># 350.76 KB - HTTP 服务器</span></span><br><span class="line">├── gun-1.3.3.ez                 <span class="comment"># 109.35 KB - HTTP 客户端</span></span><br><span class="line">└── ...                          <span class="comment"># 其他插件 EZ 文件</span></span><br></pre></td></tr></table></figure>

<h3 id="EZ-格式深度分析"><a href="#EZ-格式深度分析" class="headerlink" title="EZ 格式深度分析"></a>EZ 格式深度分析</h3><h4 id="EZ-文件内部结构"><a href="#EZ-文件内部结构" class="headerlink" title="EZ 文件内部结构"></a>EZ 文件内部结构</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># EZ 文件实际上是 ZIP 格式</span></span><br><span class="line">$ unzip -l rabbit-4.0.5.ez</span><br><span class="line">Archive:  rabbit-4.0.5.ez</span><br><span class="line">  Length      Date    Time    Name</span><br><span class="line">---------  ---------- -----   ----</span><br><span class="line">     1234  2025-01-16 22:05   rabbit-4.0.5/ebin/rabbit.app</span><br><span class="line">    45678  2025-01-16 22:05   rabbit-4.0.5/ebin/rabbit.beam</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<h4 id="目录-vs-EZ-格式对比"><a href="#目录-vs-EZ-格式对比" class="headerlink" title="目录 vs EZ 格式对比"></a>目录 vs EZ 格式对比</h4><table>
<thead>
<tr>
<th>特性</th>
<th>目录格式</th>
<th>EZ 格式</th>
</tr>
</thead>
<tbody><tr>
<td><strong>存储</strong></td>
<td>展开的文件夹</td>
<td>压缩的 ZIP 文件</td>
</tr>
<tr>
<td><strong>加载速度</strong></td>
<td>快速</td>
<td>略慢（需解压）</td>
</tr>
<tr>
<td><strong>调试</strong></td>
<td>容易（直接访问文件）</td>
<td>困难（需解压查看）</td>
</tr>
<tr>
<td><strong>分发</strong></td>
<td>占用空间大</td>
<td>占用空间小</td>
</tr>
<tr>
<td><strong>热加载</strong></td>
<td>支持</td>
<td>更好支持</td>
</tr>
<tr>
<td><strong>版本管理</strong></td>
<td>复杂</td>
<td>简单（文件名包含版本）</td>
</tr>
</tbody></table>
<h3 id="EZ-格式优势"><a href="#EZ-格式优势" class="headerlink" title="EZ 格式优势"></a>EZ 格式优势</h3><ol>
<li><strong>压缩存储</strong>: 减少磁盘占用和网络传输</li>
<li><strong>原子性</strong>: 单文件部署，避免部分文件丢失</li>
<li><strong>版本管理</strong>: 文件名包含版本信息</li>
<li><strong>热加载</strong>: Erlang VM 原生支持 EZ 文件热加载</li>
</ol>
<h3 id="使用场景与最佳实践-2"><a href="#使用场景与最佳实践-2" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="插件分发"><a href="#插件分发" class="headerlink" title="插件分发"></a>插件分发</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 插件开发者</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 生成 .ez 文件用于分发</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 插件用户</span></span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> plugin_name</span><br><span class="line"><span class="comment"># 从 .ez 文件安装插件</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-make-source-dist-源码分发包"><a href="#4-make-source-dist-源码分发包" class="headerlink" title="4. make source-dist - 源码分发包"></a>4. <code>make source-dist</code> - 源码分发包</h2><h3 id="技术原理-3"><a href="#技术原理-3" class="headerlink" title="技术原理"></a>技术原理</h3><p><code>make source-dist</code> 创建一个完整的、可复现的源码归档包（tar.xz），包含所有依赖和构建所需的文件。这是 <code>make package-generic-unix</code> 的前置步骤。</p>
<h4 id="核心实现源码-1"><a href="#核心实现源码-1" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile (第 142-152 行)</span></span><br><span class="line">SOURCE_DIST_BASE ?= rabbitmq-server</span><br><span class="line">SOURCE_DIST_SUFFIXES ?= tar.xz</span><br><span class="line">SOURCE_DIST ?= <span class="variable">$(PACKAGES_DIR)</span>/<span class="variable">$(SOURCE_DIST_BASE)</span>-<span class="variable">$(PROJECT_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 源码包文件</span></span><br><span class="line">SOURCE_DIST_FILES = <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(SOURCE_DIST)</span>.,<span class="variable">$(SOURCE_DIST_SUFFIXES)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">source-dist: <span class="variable">$(SOURCE_DIST_FILES)</span></span></span><br><span class="line">  @:</span><br><span class="line"></span><br><span class="line"><span class="comment"># 来源：Makefile (第 234-306 行)</span></span><br><span class="line"><span class="variable">$(SOURCE_DIST)</span>: <span class="variable">$(ERLANG_MK_RECURSIVE_DEPS_LIST)</span></span><br><span class="line">  <span class="variable">$(verbose)</span> mkdir -p <span class="variable">$(<span class="built_in">dir</span> <span class="variable">$@</span>)</span></span><br><span class="line">  <span class="variable">$(gen_verbose)</span> <span class="variable">$(RSYNC)</span> <span class="variable">$(RSYNC_FLAGS)</span> ./ <span class="variable">$@</span>/</span><br><span class="line">  <span class="comment"># 收集依赖、许可证、版本信息等</span></span><br></pre></td></tr></table></figure>

<h4 id="打包流程详解-1"><a href="#打包流程详解-1" class="headerlink" title="打包流程详解"></a>打包流程详解</h4><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">make source-dist</span><br><span class="line">  ↓</span><br><span class="line">解析依赖列表 (ERLANG_MK_RECURSIVE_DEPS_LIST)</span><br><span class="line">  ↓</span><br><span class="line">rsync 复制主项目 (排除 <span class="selector-class">.git</span>, <span class="selector-class">.beam</span>, deps/ 等)</span><br><span class="line">  ↓</span><br><span class="line">收集所有依赖到 deps/</span><br><span class="line">  ↓</span><br><span class="line">处理许可证文件 (LICENSE)</span><br><span class="line">  ↓</span><br><span class="line">更新版本信息 (<span class="selector-class">.app</span><span class="selector-class">.src</span> 文件)</span><br><span class="line">  ↓</span><br><span class="line">生成 git-revisions<span class="selector-class">.txt</span> (版本追踪)</span><br><span class="line">  ↓</span><br><span class="line">处理 Mix/Hex 缓存 (用于离线构建)</span><br><span class="line">  ↓</span><br><span class="line">固定文件时间戳 (可复现性)</span><br><span class="line">  ↓</span><br><span class="line">生成 manifest 文件</span><br><span class="line">  ↓</span><br><span class="line">创建 tar<span class="selector-class">.xz</span> 归档</span><br></pre></td></tr></table></figure>

<h4 id="RSYNC-排除规则"><a href="#RSYNC-排除规则" class="headerlink" title="RSYNC 排除规则"></a>RSYNC 排除规则</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">RSYNC_FLAGS += -a <span class="variable">$(RSYNC_V)</span>              \</span><br><span class="line">  --exclude &#x27;.sw?&#x27; --exclude &#x27;.*.sw?&#x27;   \  <span class="comment"># vim 交换文件</span></span><br><span class="line">  --exclude &#x27;*.beam&#x27;                    \  <span class="comment"># 编译产物</span></span><br><span class="line">  --exclude &#x27;*.d&#x27;                       \  <span class="comment"># 依赖文件</span></span><br><span class="line">  --exclude &#x27;*.pyc&#x27;                     \  <span class="comment"># Python 缓存</span></span><br><span class="line">  --exclude &#x27;.git*&#x27;                     \  <span class="comment"># Git 文件</span></span><br><span class="line">  --exclude &#x27;.hg*&#x27;                      \  <span class="comment"># Mercurial 文件</span></span><br><span class="line">  --exclude &#x27;*.bzl&#x27;                     \  <span class="comment"># Bazel 文件</span></span><br><span class="line">  --exclude &#x27;*.bazel&#x27;                   \</span><br><span class="line">  --exclude &#x27;BUILD.*&#x27;                   \</span><br><span class="line">  --exclude &#x27;deps/&#x27;                     \  <span class="comment"># 依赖目录（单独处理）</span></span><br><span class="line">  --exclude &#x27;ebin/&#x27;                     \  <span class="comment"># 编译输出</span></span><br><span class="line">  --exclude &#x27;plugins/&#x27;                  \  <span class="comment"># 插件目录</span></span><br><span class="line">  --exclude &#x27;test/&#x27;                     \  <span class="comment"># 测试文件</span></span><br><span class="line">  --exclude &#x27;sbin/&#x27;                     \  <span class="comment"># 生成的脚本</span></span><br><span class="line">  <span class="comment"># ... 更多排除规则</span></span><br></pre></td></tr></table></figure>

<h3 id="实际生成的文件"><a href="#实际生成的文件" class="headerlink" title="实际生成的文件"></a>实际生成的文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PACKAGES/</span><br><span class="line">├── rabbitmq-server-4.0.5/              <span class="comment"># 解压后的源码目录</span></span><br><span class="line">│   ├── Makefile                        <span class="comment"># 主构建文件</span></span><br><span class="line">│   ├── erlang.mk                       <span class="comment"># Erlang.mk 构建系统</span></span><br><span class="line">│   ├── plugins.mk                      <span class="comment"># 插件定义</span></span><br><span class="line">│   ├── deps/                           <span class="comment"># 所有依赖源码</span></span><br><span class="line">│   │   ├── rabbit/                     <span class="comment"># 核心模块</span></span><br><span class="line">│   │   ├── rabbit_common/              <span class="comment"># 公共模块</span></span><br><span class="line">│   │   ├── rabbitmq_management/        <span class="comment"># 管理插件</span></span><br><span class="line">│   │   └── ...                         <span class="comment"># 其他依赖</span></span><br><span class="line">│   ├── LICENSE                         <span class="comment"># 合并的许可证文件</span></span><br><span class="line">│   ├── LICENSE-*                       <span class="comment"># 各组件许可证</span></span><br><span class="line">│   └── git-revisions.txt               <span class="comment"># Git 版本追踪</span></span><br><span class="line">├── rabbitmq-server-4.0.5.tar.xz        <span class="comment"># 源码归档包 (~5MB)</span></span><br><span class="line">└── rabbitmq-server-4.0.5.manifest      <span class="comment"># 文件清单</span></span><br></pre></td></tr></table></figure>

<h3 id="可复现性特性"><a href="#可复现性特性" class="headerlink" title="可复现性特性"></a>可复现性特性</h3><ol>
<li><strong>固定时间戳</strong> - 所有文件时间戳基于最新 Git 提交</li>
<li><strong>排序文件列表</strong> - manifest 使用 <code>LC_COLLATE=C sort</code> 确保一致性</li>
<li><strong>Hex 缓存处理</strong> - 将 ETS 缓存转为 Erlang term 文件避免二进制差异</li>
<li><strong>版本信息嵌入</strong> - 自动更新所有 <code>.app.src</code> 中的版本号</li>
</ol>
<h3 id="使用场景与最佳实践-3"><a href="#使用场景与最佳实践-3" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="离线构建"><a href="#离线构建" class="headerlink" title="离线构建"></a>离线构建</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 在联网环境创建源码包</span></span><br><span class="line">make source-dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 传输到离线环境</span></span><br><span class="line">scp PACKAGES/rabbitmq-server-4.0.5.tar.xz offline-server:/tmp/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 离线构建</span></span><br><span class="line">ssh offline-server</span><br><span class="line">tar -xf /tmp/rabbitmq-server-4.0.5.tar.xz</span><br><span class="line"><span class="built_in">cd</span> rabbitmq-server-4.0.5</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<h4 id="版本发布"><a href="#版本发布" class="headerlink" title="版本发布"></a>版本发布</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 官方发布流程</span></span><br><span class="line">make source-dist</span><br><span class="line"><span class="comment"># 生成的 tar.xz 可上传到 GitHub Releases</span></span><br></pre></td></tr></table></figure>

<h4 id="作为-package-generic-unix-的输入"><a href="#作为-package-generic-unix-的输入" class="headerlink" title="作为 package-generic-unix 的输入"></a>作为 package-generic-unix 的输入</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># make package-generic-unix 内部依赖 source-dist</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 实际执行：</span></span><br><span class="line"><span class="comment"># 1. make source-dist (生成源码包)</span></span><br><span class="line"><span class="comment"># 2. 解压源码包</span></span><br><span class="line"><span class="comment"># 3. 编译并打包为通用包</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-make-package-generic-unix-通用-Unix-包"><a href="#5-make-package-generic-unix-通用-Unix-包" class="headerlink" title="5. make package-generic-unix - 通用 Unix 包"></a>5. <code>make package-generic-unix</code> - 通用 Unix 包</h2><h3 id="技术原理-4"><a href="#技术原理-4" class="headerlink" title="技术原理"></a>技术原理</h3><p>创建跨平台的 tar.xz 安装包，包含完整的 RabbitMQ 运行环境。<strong>依赖 <code>make source-dist</code> 生成的源码包作为输入。</strong></p>
<h4 id="核心实现源码-2"><a href="#核心实现源码-2" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 来源：packaging/generic-unix/Makefile (第 33-76 行)</span></span><br><span class="line">SOURCE_DIR = rabbitmq-server-<span class="variable">$(VERSION)</span></span><br><span class="line">TARGET_DIR = rabbitmq_server-<span class="variable">$(VERSION)</span></span><br><span class="line">TARGET_TARBALL = rabbitmq-server-<span class="variable">$(TARBALL_SUFFIX)</span>-<span class="variable">$(VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="section">dist:</span></span><br><span class="line">  <span class="comment"># 解压源码包</span></span><br><span class="line">  xzcat <span class="variable">$(SOURCE_DIST_FILE)</span> | tar -xf -</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 编译并安装到目标目录</span></span><br><span class="line">  <span class="variable">$(MAKE)</span> -C <span class="variable">$(SOURCE_DIR)</span> \</span><br><span class="line">    PREFIX= RMQ_ROOTDIR= \</span><br><span class="line">    RMQ_ERLAPP_DIR=`pwd`/<span class="variable">$(TARGET_DIR)</span> \</span><br><span class="line">    MANDIR=`pwd`/<span class="variable">$(TARGET_DIR)</span>/share/man \</span><br><span class="line">    manpages web-manpages install install-man</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 修改配置文件</span></span><br><span class="line">  sed -e &#x27;s:^SYS_PREFIX=$$:SYS_PREFIX=\$$&#123;RABBITMQ_HOME&#125;:&#x27; \</span><br><span class="line">        <span class="variable">$(TARGET_DIR)</span>/sbin/rabbitmq-defaults &gt;<span class="variable">$(TARGET_DIR)</span>/sbin/rabbitmq-defaults.tmp</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 创建 tar.xz 包</span></span><br><span class="line">  find <span class="variable">$(TARGET_DIR)</span> | LC_COLLATE=C sort &gt; <span class="variable">$(TARGET_TARBALL)</span>.manifest</span><br><span class="line">  tar --no-recursion -T <span class="variable">$(TARGET_TARBALL)</span>.manifest -cf - | \</span><br><span class="line">  xz &gt; <span class="variable">$(CURDIR)</span>/<span class="variable">$(TARGET_TARBALL)</span>.tar.xz</span><br></pre></td></tr></table></figure>

<h4 id="打包流程详解-2"><a href="#打包流程详解-2" class="headerlink" title="打包流程详解"></a>打包流程详解</h4><ol>
<li><strong>解压源码包</strong> - 从 tar.xz 源码包开始</li>
<li><strong>编译安装</strong> - 使用标准 Unix 安装路径</li>
<li><strong>生成文档</strong> - 创建 man 手册页</li>
<li><strong>配置脚本</strong> - 调整启动脚本的路径变量</li>
<li><strong>创建归档</strong> - 打包成 tar.xz 格式</li>
</ol>
<h3 id="实际生成的包结构（已验证）"><a href="#实际生成的包结构（已验证）" class="headerlink" title="实际生成的包结构（已验证）"></a>实际生成的包结构（已验证）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PACKAGES/</span><br><span class="line">├── rabbitmq-server-4.0.5.tar.xz           <span class="comment"># 4.95 MB - 源码包</span></span><br><span class="line">├── rabbitmq-server-generic-unix-4.0.5.tar.xz  <span class="comment"># 15.51 MB - 通用包</span></span><br><span class="line">├── rabbitmq-server-4.0.5.manifest         <span class="comment"># 230.22 KB - 文件清单</span></span><br><span class="line">└── rabbitmq-server-4.0.5/                 <span class="comment"># 解压后的源码目录</span></span><br><span class="line">    ├── sbin/                              <span class="comment"># 启动脚本 (25 个文件)</span></span><br><span class="line">    ├── deps/                              <span class="comment"># 依赖模块 (86 个目录)</span></span><br><span class="line">    ├── etc/                               <span class="comment"># 配置目录</span></span><br><span class="line">    └── ...                                <span class="comment"># 其他文件</span></span><br></pre></td></tr></table></figure>

<h4 id="通用包内容分析"><a href="#通用包内容分析" class="headerlink" title="通用包内容分析"></a>通用包内容分析</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 解压通用包后的目录结构</span></span><br><span class="line">rabbitmq_server-4.0.5/</span><br><span class="line">├── lib/                          <span class="comment"># Erlang 应用库</span></span><br><span class="line">│   └── rabbitmq_server-4.0.5/</span><br><span class="line">│       ├── ebin/                <span class="comment"># 字节码文件</span></span><br><span class="line">│       ├── include/             <span class="comment"># 头文件</span></span><br><span class="line">│       └── priv/                <span class="comment"># 私有资源</span></span><br><span class="line">├── sbin/                        <span class="comment"># 启动脚本</span></span><br><span class="line">│   ├── rabbitmq-server         <span class="comment"># 已配置 RABBITMQ_HOME</span></span><br><span class="line">│   ├── rabbitmqctl</span><br><span class="line">│   └── ...</span><br><span class="line">├── etc/                         <span class="comment"># 配置目录</span></span><br><span class="line">│   └── rabbitmq/</span><br><span class="line">├── share/                       <span class="comment"># 文档和手册</span></span><br><span class="line">│   └── man/</span><br><span class="line">└── plugins/                     <span class="comment"># 插件目录</span></span><br></pre></td></tr></table></figure>

<h3 id="通用包特点"><a href="#通用包特点" class="headerlink" title="通用包特点"></a>通用包特点</h3><ol>
<li><strong>自包含</strong>: 包含所有运行时依赖</li>
<li><strong>可移植</strong>: 适用于各种 Unix 系统</li>
<li><strong>标准化</strong>: 遵循 Unix 目录结构规范</li>
<li><strong>生产就绪</strong>: 包含完整的配置和文档</li>
</ol>
<h3 id="使用场景与最佳实践-4"><a href="#使用场景与最佳实践-4" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="容器化部署"><a href="#容器化部署" class="headerlink" title="容器化部署"></a>容器化部署</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 构建通用包</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Dockerfile 示例</span></span><br><span class="line">FROM ubuntu:20.04</span><br><span class="line">COPY PACKAGES/rabbitmq-server-generic-unix-*.tar.xz /tmp/</span><br><span class="line">RUN tar -xf /tmp/rabbitmq-server-generic-unix-*.tar.xz -C /opt/</span><br></pre></td></tr></table></figure>

<h4 id="跨平台分发"><a href="#跨平台分发" class="headerlink" title="跨平台分发"></a>跨平台分发</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建分发包</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 部署到不同系统</span></span><br><span class="line">scp PACKAGES/rabbitmq-server-generic-unix-*.tar.xz user@server:/tmp/</span><br><span class="line">ssh user@server <span class="string">&#x27;cd /opt &amp;&amp; tar -xf /tmp/rabbitmq-server-generic-unix-*.tar.xz&#x27;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-make-install-系统级安装"><a href="#6-make-install-系统级安装" class="headerlink" title="6. make install - 系统级安装"></a>6. <code>make install</code> - 系统级安装</h2><h3 id="技术原理-5"><a href="#技术原理-5" class="headerlink" title="技术原理"></a>技术原理</h3><p>将 RabbitMQ 安装到系统标准路径，遵循 FHS (Filesystem Hierarchy Standard)。</p>
<h4 id="核心实现逻辑-1"><a href="#核心实现逻辑-1" class="headerlink" title="核心实现逻辑"></a>核心实现逻辑</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 来源：Makefile 第 489-523 行</span></span><br><span class="line">PREFIX ?= /usr/local</span><br><span class="line">RMQ_ROOTDIR ?= <span class="variable">$(PREFIX)</span>/lib/erlang</span><br><span class="line">RMQ_BINDIR ?= <span class="variable">$(RMQ_ROOTDIR)</span>/bin</span><br><span class="line">RMQ_LIBDIR ?= <span class="variable">$(RMQ_ROOTDIR)</span>/lib</span><br><span class="line">RMQ_ERLAPP_DIR ?= <span class="variable">$(RMQ_LIBDIR)</span>/rabbitmq_server-<span class="variable">$(PROJECT_VERSION)</span></span><br><span class="line"></span><br><span class="line"><span class="section">install: install-erlapp install-scripts</span></span><br><span class="line"></span><br><span class="line"><span class="section">install-erlapp: dist</span></span><br><span class="line">  <span class="variable">$(verbose)</span> mkdir -p <span class="variable">$(DESTDIR)</span><span class="variable">$(RMQ_ERLAPP_DIR)</span></span><br><span class="line">  <span class="variable">$(inst_verbose)</span> cp -r \</span><br><span class="line">    LICENSE* \</span><br><span class="line">    <span class="variable">$(DEPS_DIR)</span>/rabbit/INSTALL \</span><br><span class="line">    <span class="variable">$(DIST_DIR)</span> \</span><br><span class="line">    <span class="variable">$(DESTDIR)</span><span class="variable">$(RMQ_ERLAPP_DIR)</span></span><br></pre></td></tr></table></figure>

<h4 id="安装组件详解"><a href="#安装组件详解" class="headerlink" title="安装组件详解"></a>安装组件详解</h4><ol>
<li><strong>核心应用</strong> (<code>install-erlapp</code>) - 安装 Erlang 应用和插件</li>
<li><strong>启动脚本</strong> (<code>install-scripts</code>) - 安装服务启动脚本</li>
<li><strong>命令行工具</strong> (<code>install-bin</code>) - 安装管理工具</li>
<li><strong>手册页</strong> (<code>install-man</code>) - 安装文档</li>
</ol>
<h3 id="系统安装目录结构"><a href="#系统安装目录结构" class="headerlink" title="系统安装目录结构"></a>系统安装目录结构</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/local/</span><br><span class="line">├── bin/                         <span class="comment"># 可执行文件</span></span><br><span class="line">│   ├── rabbitmq-server</span><br><span class="line">│   ├── rabbitmqctl</span><br><span class="line">│   └── ...</span><br><span class="line">├── lib/                         <span class="comment"># 库文件</span></span><br><span class="line">│   └── rabbitmq/</span><br><span class="line">│       ├── lib/                <span class="comment"># Erlang 应用</span></span><br><span class="line">│       └── plugins/            <span class="comment"># 插件目录</span></span><br><span class="line">├── etc/                        <span class="comment"># 配置文件</span></span><br><span class="line">│   └── rabbitmq/</span><br><span class="line">│       └── rabbitmq.conf</span><br><span class="line">├── var/                        <span class="comment"># 数据目录</span></span><br><span class="line">│   ├── <span class="built_in">log</span>/rabbitmq/          <span class="comment"># 日志</span></span><br><span class="line">│   └── lib/rabbitmq/          <span class="comment"># 数据库</span></span><br><span class="line">└── share/                      <span class="comment"># 文档</span></span><br><span class="line">    └── man/                    <span class="comment"># 手册页</span></span><br></pre></td></tr></table></figure>

<h3 id="系统安装优势"><a href="#系统安装优势" class="headerlink" title="系统安装优势"></a>系统安装优势</h3><ol>
<li><strong>标准化</strong>: 遵循 Unix 标准目录结构</li>
<li><strong>多用户</strong>: 支持系统级多用户访问</li>
<li><strong>服务集成</strong>: 便于集成到系统服务管理</li>
<li><strong>权限管理</strong>: 利用系统权限控制</li>
</ol>
<h3 id="使用场景与最佳实践-5"><a href="#使用场景与最佳实践-5" class="headerlink" title="使用场景与最佳实践"></a>使用场景与最佳实践</h3><h4 id="系统级部署"><a href="#系统级部署" class="headerlink" title="系统级部署"></a>系统级部署</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 系统安装</span></span><br><span class="line"><span class="built_in">sudo</span> make install PREFIX=/opt/rabbitmq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 服务配置</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> rabbitmq-server</span><br><span class="line"><span class="built_in">sudo</span> systemctl start rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 多用户环境</span></span><br><span class="line"><span class="built_in">sudo</span> adduser rabbitmq</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> -R rabbitmq:rabbitmq /opt/rabbitmq</span><br></pre></td></tr></table></figure>

<h4 id="包管理器集成"><a href="#包管理器集成" class="headerlink" title="包管理器集成"></a>包管理器集成</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建 deb/rpm 包</span></span><br><span class="line">make install DESTDIR=/tmp/rabbitmq-package PREFIX=/usr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 打包</span></span><br><span class="line">fpm -s <span class="built_in">dir</span> -t deb -C /tmp/rabbitmq-package \</span><br><span class="line">    --name rabbitmq-server \</span><br><span class="line">    --version 4.0.5 \</span><br><span class="line">    .</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-开发调试命令"><a href="#7-开发调试命令" class="headerlink" title="7. 开发调试命令"></a>7. 开发调试命令</h2><h3 id="make-run-broker-启动开发服务器"><a href="#make-run-broker-启动开发服务器" class="headerlink" title="make run-broker - 启动开发服务器"></a><code>make run-broker</code> - 启动开发服务器</h3><h4 id="技术原理-6"><a href="#技术原理-6" class="headerlink" title="技术原理"></a>技术原理</h4><p><code>make run-broker</code> 在前台启动 RabbitMQ 服务器，适合开发调试。日志直接输出到终端，便于实时查看。</p>
<h4 id="核心实现源码-3"><a href="#核心实现源码-3" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-run.mk (第 269-278 行)</span></span><br><span class="line">run-broker run-tls-broker: RABBITMQ_CONFIG_FILE := <span class="variable">$(<span class="built_in">basename</span> <span class="variable">$(TEST_CONFIG_FILE)</span>)</span></span><br><span class="line"><span class="section">run-broker:     config = <span class="variable">$(test_rabbitmq_config)</span></span></span><br><span class="line"><span class="section">run-tls-broker: config = <span class="variable">$(test_rabbitmq_config_with_tls)</span></span></span><br><span class="line"></span><br><span class="line">run-broker run-tls-broker: node-tmpdir <span class="variable">$(DIST_TARGET)</span> <span class="variable">$(TEST_CONFIG_FILE)</span></span><br><span class="line">  <span class="variable">$(BASIC_SCRIPT_ENV_SETTINGS)</span> \</span><br><span class="line">    RABBITMQ_ALLOW_INPUT=true \</span><br><span class="line">    RABBITMQ_CONFIG_FILE=<span class="variable">$(RABBITMQ_CONFIG_FILE)</span> \</span><br><span class="line">    <span class="variable">$(RABBITMQ_SERVER)</span></span><br></pre></td></tr></table></figure>

<h4 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h4><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">make run-broker</span><br><span class="line">  ↓</span><br><span class="line">创建临时目录 (<span class="keyword">node</span><span class="title">-tmpdir</span>)</span><br><span class="line">  ↓</span><br><span class="line">执行 make dist (如需要)</span><br><span class="line">  ↓</span><br><span class="line">生成测试配置文件</span><br><span class="line">  ↓</span><br><span class="line">设置环境变量</span><br><span class="line">  ↓</span><br><span class="line">启动 rabbitmq-server (前台)</span><br></pre></td></tr></table></figure>

<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 基础开发调试</span></span><br><span class="line">make run-broker</span><br><span class="line"><span class="comment"># 日志直接输出到终端，Ctrl+C 停止</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 后台启动</span></span><br><span class="line">make run-background-broker</span><br><span class="line"><span class="comment"># 服务在后台运行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. TLS 模式启动</span></span><br><span class="line">make run-tls-broker</span><br><span class="line"><span class="comment"># 使用 TLS 配置启动</span></span><br></pre></td></tr></table></figure>

<h3 id="make-run-broker-PLUGINS-插件测试"><a href="#make-run-broker-PLUGINS-插件测试" class="headerlink" title="make run-broker PLUGINS= - 插件测试"></a><code>make run-broker PLUGINS=</code> - 插件测试</h3><h4 id="技术原理-7"><a href="#技术原理-7" class="headerlink" title="技术原理"></a>技术原理</h4><p>通过 <code>PLUGINS</code> 环境变量指定要加载的插件，用于测试特定插件功能。</p>
<h4 id="使用场景-1"><a href="#使用场景-1" class="headerlink" title="使用场景"></a>使用场景</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 测试管理插件</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;rabbitmq_management&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 测试多个插件</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;rabbitmq_management rabbitmq_prometheus&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 测试自定义插件</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;my_custom_plugin&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><ul>
<li>插件名称使用空格分隔</li>
<li>插件需要先编译完成（<code>make dist</code>）</li>
<li>依赖插件会自动加载</li>
</ul>
<h3 id="make-shell-Erlang-Shell"><a href="#make-shell-Erlang-Shell" class="headerlink" title="make shell - Erlang Shell"></a><code>make shell</code> - Erlang Shell</h3><h4 id="技术原理-8"><a href="#技术原理-8" class="headerlink" title="技术原理"></a>技术原理</h4><p>启动一个加载了所有 RabbitMQ 模块的 Erlang Shell，用于代码调试和模块测试。</p>
<h4 id="核心实现源码-4"><a href="#核心实现源码-4" class="headerlink" title="核心实现源码"></a>核心实现源码</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 来源：erlang.mk (第 7053-7054 行)</span></span><br><span class="line"><span class="section">shell:: build-shell-deps</span></span><br><span class="line">  <span class="variable">$(gen_verbose)</span> <span class="variable">$(SHELL_ERL)</span> -pa <span class="variable">$(SHELL_PATHS)</span> <span class="variable">$(SHELL_OPTS)</span></span><br></pre></td></tr></table></figure>

<h4 id="使用场景-2"><a href="#使用场景-2" class="headerlink" title="使用场景"></a>使用场景</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 进入 Erlang Shell</span></span><br><span class="line">make shell</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Shell 中：</span></span><br><span class="line"><span class="comment"># 测试模块函数</span></span><br><span class="line">1&gt; rabbit_misc:version().</span><br><span class="line"><span class="string">&quot;4.0.5&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查模块信息</span></span><br><span class="line">2&gt; m(rabbit).</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译并加载修改后的模块</span></span><br><span class="line">3&gt; c(my_module).</span><br></pre></td></tr></table></figure>

<h4 id="与-erl-的区别"><a href="#与-erl-的区别" class="headerlink" title="与 erl 的区别"></a>与 <code>erl</code> 的区别</h4><table>
<thead>
<tr>
<th>特性</th>
<th><code>make shell</code></th>
<th><code>erl</code></th>
</tr>
</thead>
<tbody><tr>
<td>代码路径</td>
<td>自动设置所有依赖</td>
<td>需手动指定</td>
</tr>
<tr>
<td>模块加载</td>
<td>RabbitMQ 模块可用</td>
<td>需手动加载</td>
</tr>
<tr>
<td>环境变量</td>
<td>继承项目配置</td>
<td>默认配置</td>
</tr>
<tr>
<td>用途</td>
<td>RabbitMQ 开发调试</td>
<td>通用 Erlang 开发</td>
</tr>
</tbody></table>
<h3 id="make-run-node-裸-Erlang-节点"><a href="#make-run-node-裸-Erlang-节点" class="headerlink" title="make run-node - 裸 Erlang 节点"></a><code>make run-node</code> - 裸 Erlang 节点</h3><h4 id="技术原理-9"><a href="#技术原理-9" class="headerlink" title="技术原理"></a>技术原理</h4><p>启动一个不运行 RabbitMQ 应用的 Erlang 节点，仅加载代码但不启动服务。</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 来源：deps/rabbit_common/mk/rabbitmq-run.mk (第 288-292 行)</span></span><br><span class="line"><span class="section">run-node: node-tmpdir <span class="variable">$(DIST_TARGET)</span></span></span><br><span class="line">  <span class="variable">$(BASIC_SCRIPT_ENV_SETTINGS)</span> \</span><br><span class="line">    RABBITMQ_NODE_ONLY=true \</span><br><span class="line">    RABBITMQ_ALLOW_INPUT=true \</span><br><span class="line">    <span class="variable">$(RABBITMQ_SERVER)</span></span><br></pre></td></tr></table></figure>

<h4 id="使用场景-3"><a href="#使用场景-3" class="headerlink" title="使用场景"></a>使用场景</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. Erlang 级别调试</span></span><br><span class="line">make run-node</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 手动启动 RabbitMQ 应用</span></span><br><span class="line">1&gt; application:ensure_all_started(rabbit).</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 测试特定模块而不启动完整服务</span></span><br><span class="line">1&gt; rabbit_misc:version().</span><br></pre></td></tr></table></figure>

<h3 id="开发工作流最佳实践"><a href="#开发工作流最佳实践" class="headerlink" title="开发工作流最佳实践"></a>开发工作流最佳实践</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 完整开发工作流</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 编译项目</span></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 测试模块（不启动服务）</span></span><br><span class="line">make shell</span><br><span class="line">&gt; my_module:<span class="built_in">test</span>().</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 启动服务验证</span></span><br><span class="line">make run-broker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 测试特定插件</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;rabbitmq_management&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 查看管理界面</span></span><br><span class="line"><span class="comment"># 浏览器访问 http://localhost:15672</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 修改代码后重新编译</span></span><br><span class="line">make  <span class="comment"># 增量编译</span></span><br><span class="line">make run-broker  <span class="comment"># 重新启动</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="构建系统架构深度解析"><a href="#构建系统架构深度解析" class="headerlink" title="构建系统架构深度解析"></a>构建系统架构深度解析</h2><h3 id="核心组件关系"><a href="#核心组件关系" class="headerlink" title="核心组件关系"></a>核心组件关系</h3><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">Makefile</span><br><span class="line">  ├── erlang<span class="selector-class">.mk</span>          → 编译 Erlang 代码 → 生成 <span class="selector-class">.beam</span> 文件</span><br><span class="line">  ├── rabbitmq-components<span class="selector-class">.mk</span> → 管理组件依赖 → deps/ 目录</span><br><span class="line">  └── plugins<span class="selector-class">.mk</span>         → 插件列表管理 → PLUGINS 变量</span><br><span class="line">                                    ↓</span><br><span class="line">                          rabbitmq-dist<span class="selector-class">.mk</span></span><br><span class="line">                                    ↓</span><br><span class="line">                    ┌───────────────┴───────────────┐</span><br><span class="line">                    ↓                               ↓</span><br><span class="line">              dist 目标                         EZ 打包</span><br><span class="line">                    ↓                               ↓</span><br><span class="line">            plugins/ 目录                      <span class="selector-class">.ez</span> 文件</span><br></pre></td></tr></table></figure>

<h3 id="关键配置文件详解"><a href="#关键配置文件详解" class="headerlink" title="关键配置文件详解"></a>关键配置文件详解</h3><h4 id="1-Makefile-主控制文件"><a href="#1-Makefile-主控制文件" class="headerlink" title="1. Makefile - 主控制文件"></a>1. <code>Makefile</code> - 主控制文件</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">PROJECT = rabbitmq_server_release</span><br><span class="line">PROJECT_DESCRIPTION = RabbitMQ Server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件列表</span></span><br><span class="line"><span class="keyword">include</span> plugins.mk</span><br><span class="line">DEPS = rabbit_common rabbit <span class="variable">$(PLUGINS)</span> <span class="variable">$(ADDITIONAL_PLUGINS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建系统</span></span><br><span class="line"><span class="keyword">include</span> rabbitmq-components.mk</span><br><span class="line"><span class="keyword">include</span> erlang.mk</span><br></pre></td></tr></table></figure>

<h4 id="2-plugins-mk-插件定义"><a href="#2-plugins-mk-插件定义" class="headerlink" title="2. plugins.mk - 插件定义"></a>2. <code>plugins.mk</code> - 插件定义</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">PLUGINS = \</span><br><span class="line">  rabbitmq_amqp1_0 \</span><br><span class="line">  rabbitmq_auth_backend_cache \</span><br><span class="line">  rabbitmq_auth_backend_http \</span><br><span class="line">  rabbitmq_auth_backend_ldap \</span><br><span class="line">  rabbitmq_auth_backend_oauth2 \</span><br><span class="line">  rabbitmq_auth_mechanism_ssl \</span><br><span class="line">  rabbitmq_consistent_hash_exchange \</span><br><span class="line">  <span class="comment"># ... 更多插件</span></span><br></pre></td></tr></table></figure>

<h4 id="3-rabbitmq-dist-mk-分发逻辑"><a href="#3-rabbitmq-dist-mk-分发逻辑" class="headerlink" title="3. rabbitmq-dist.mk - 分发逻辑"></a>3. <code>rabbitmq-dist.mk</code> - 分发逻辑</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># EZ 文件生成宏</span></span><br><span class="line"><span class="keyword">define</span> do_ez_target_erlangmk</span><br><span class="line"><span class="comment"># 定义目标目录和文件名</span></span><br><span class="line">dist_$(1)_ez_dir = <span class="variable">$(DIST_DIR)</span>/$(1)-$(2)</span><br><span class="line"><span class="comment"># 根据 DIST_AS_EZS 决定格式</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(DIST_AS_EZS)</span>,)</span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir)      <span class="comment"># 目录</span></span><br><span class="line"><span class="keyword">else</span>  </span><br><span class="line">dist_$(1)_ez = $$(dist_$(1)_ez_dir).ez   <span class="comment"># EZ 文件</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endef</span></span><br></pre></td></tr></table></figure>

<h3 id="构建系统特点"><a href="#构建系统特点" class="headerlink" title="构建系统特点"></a>构建系统特点</h3><ol>
<li><strong>模块化设计</strong> - 每个 <code>.mk</code> 文件负责特定功能</li>
<li><strong>可扩展性</strong> - 支持自定义插件和构建规则</li>
<li><strong>标准化</strong> - 遵循 Erlang&#x2F;OTP 和 Unix 标准</li>
<li><strong>自动化</strong> - 完整的依赖管理和构建流程</li>
</ol>
<hr>
<h2 id="完整编译流程对比"><a href="#完整编译流程对比" class="headerlink" title="完整编译流程对比"></a>完整编译流程对比</h2><h3 id="性能和资源详细对比"><a href="#性能和资源详细对比" class="headerlink" title="性能和资源详细对比"></a>性能和资源详细对比</h3><h4 id="构建命令-1"><a href="#构建命令-1" class="headerlink" title="构建命令"></a>构建命令</h4><table>
<thead>
<tr>
<th>编译方式</th>
<th>编译时间</th>
<th>磁盘占用</th>
<th>内存使用</th>
<th>网络传输</th>
<th>部署复杂度</th>
<th>维护成本</th>
</tr>
</thead>
<tbody><tr>
<td><code>make</code></td>
<td>最快 (30s)</td>
<td>中等 (200MB)</td>
<td>低 (100MB)</td>
<td>不适用</td>
<td>简单</td>
<td>低</td>
</tr>
<tr>
<td><code>make dist</code></td>
<td>快 (45s)</td>
<td>大 (300MB)</td>
<td>中等 (150MB)</td>
<td>大 (300MB)</td>
<td>中等</td>
<td>中等</td>
</tr>
<tr>
<td><code>make dist DIST_AS_EZS=true</code></td>
<td>中等 (60s)</td>
<td>小 (15MB)</td>
<td>中等 (150MB)</td>
<td>小 (15MB)</td>
<td>简单</td>
<td>低</td>
</tr>
<tr>
<td><code>make source-dist</code></td>
<td>快 (40s)</td>
<td>小 (~5MB)</td>
<td>低 (100MB)</td>
<td>小 (~5MB)</td>
<td>简单</td>
<td>低</td>
</tr>
<tr>
<td><code>make package-generic-unix</code></td>
<td>慢 (120s)</td>
<td>最小 (15.51MB)</td>
<td>高 (200MB)</td>
<td>最小 (15.51MB)</td>
<td>简单</td>
<td>低</td>
</tr>
<tr>
<td><code>make install</code></td>
<td>中等 (75s)</td>
<td>中等 (250MB)</td>
<td>低 (100MB)</td>
<td>不适用</td>
<td>复杂</td>
<td>高</td>
</tr>
</tbody></table>
<h4 id="开发调试命令-1"><a href="#开发调试命令-1" class="headerlink" title="开发调试命令"></a>开发调试命令</h4><table>
<thead>
<tr>
<th>命令</th>
<th>启动时间</th>
<th>用途</th>
<th>交互性</th>
</tr>
</thead>
<tbody><tr>
<td><code>make run-broker</code></td>
<td>快 (5s)</td>
<td>开发调试</td>
<td>前台，可查看日志</td>
</tr>
<tr>
<td><code>make run-broker PLUGINS=...</code></td>
<td>快 (5s)</td>
<td>插件测试</td>
<td>前台，指定插件</td>
</tr>
<tr>
<td><code>make shell</code></td>
<td>最快 (2s)</td>
<td>模块调试</td>
<td>交互式 Erlang Shell</td>
</tr>
<tr>
<td><code>make run-background-broker</code></td>
<td>快 (5s)</td>
<td>自动化测试</td>
<td>后台运行</td>
</tr>
<tr>
<td><code>make run-node</code></td>
<td>最快 (2s)</td>
<td>Erlang 调试</td>
<td>裸节点，无 RabbitMQ</td>
</tr>
</tbody></table>
<hr>
<h2 id="最佳实践指南"><a href="#最佳实践指南" class="headerlink" title="最佳实践指南"></a>最佳实践指南</h2><h3 id="开发阶段最佳实践"><a href="#开发阶段最佳实践" class="headerlink" title="开发阶段最佳实践"></a>开发阶段最佳实践</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 初始设置</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/rabbitmq/rabbitmq-server.git</span><br><span class="line"><span class="built_in">cd</span> rabbitmq-server</span><br><span class="line">git checkout v4.0.5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 快速开发迭代</span></span><br><span class="line">make clean &amp;&amp; make</span><br><span class="line">sbin/rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 增量编译（推荐）</span></span><br><span class="line">make  <span class="comment"># 只编译修改的文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 开发调试</span></span><br><span class="line">make shell  <span class="comment"># 进入 Erlang shell</span></span><br><span class="line">make run-broker  <span class="comment"># 运行开发版本</span></span><br></pre></td></tr></table></figure>

<h3 id="测试阶段最佳实践"><a href="#测试阶段最佳实践" class="headerlink" title="测试阶段最佳实践"></a>测试阶段最佳实践</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 功能测试</span></span><br><span class="line">make dist</span><br><span class="line"><span class="comment"># 测试插件加载和目录结构</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 插件兼容性测试</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 验证 EZ 文件加载和热加载</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 集成测试</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 在不同环境测试安装包</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 性能测试</span></span><br><span class="line">make  <span class="comment"># 使用最快的编译方式</span></span><br></pre></td></tr></table></figure>

<h3 id="生产部署最佳实践"><a href="#生产部署最佳实践" class="headerlink" title="生产部署最佳实践"></a>生产部署最佳实践</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 容器化部署（推荐）</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 使用 tar.xz 包构建 Docker 镜像</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 传统服务器部署</span></span><br><span class="line">make install PREFIX=/opt/rabbitmq</span><br><span class="line"><span class="comment"># 系统级安装</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 云原生部署</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 使用 EZ 文件支持动态插件管理</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 高可用部署</span></span><br><span class="line">make package-generic-unix</span><br><span class="line"><span class="comment"># 标准化的部署包，便于集群管理</span></span><br></pre></td></tr></table></figure>

<h3 id="插件开发最佳实践"><a href="#插件开发最佳实践" class="headerlink" title="插件开发最佳实践"></a>插件开发最佳实践</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 插件开发</span></span><br><span class="line">make dist</span><br><span class="line"><span class="comment"># 开发阶段使用目录格式便于调试</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 插件测试</span></span><br><span class="line">make run-broker PLUGINS=<span class="string">&quot;plugin_name&quot;</span></span><br><span class="line"><span class="comment"># 测试插件功能</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 插件分发</span></span><br><span class="line">make dist DIST_AS_EZS=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 生成 .ez 文件用于分发</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 插件发布</span></span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> plugin_name</span><br><span class="line"><span class="comment"># 从 .ez 文件安装插件</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="高级配置与优化"><a href="#高级配置与优化" class="headerlink" title="高级配置与优化"></a>高级配置与优化</h2><h3 id="环境变量控制"><a href="#环境变量控制" class="headerlink" title="环境变量控制"></a>环境变量控制</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 自定义插件目录</span></span><br><span class="line"><span class="built_in">export</span> DIST_DIR=/custom/plugins/path</span><br><span class="line">make dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义包输出目录</span></span><br><span class="line"><span class="built_in">export</span> PACKAGES_DIR=/custom/packages/path  </span><br><span class="line">make package-generic-unix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用社区插件</span></span><br><span class="line"><span class="built_in">export</span> COMMUNITY_PLUGINS=1</span><br><span class="line">make dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义版本号</span></span><br><span class="line"><span class="built_in">export</span> PROJECT_VERSION=4.0.5-custom</span><br><span class="line">make dist</span><br></pre></td></tr></table></figure>

<h3 id="编译优化技巧"><a href="#编译优化技巧" class="headerlink" title="编译优化技巧"></a>编译优化技巧</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 并行编译（推荐）</span></span><br><span class="line">make -j$(<span class="built_in">nproc</span>) dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 详细输出（调试用）</span></span><br><span class="line">make V=1 dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 跳过测试（加速编译）</span></span><br><span class="line">make SKIP_TESTS=1 dist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增量编译（开发用）</span></span><br><span class="line">make  <span class="comment"># 不使用 clean</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存优化</span></span><br><span class="line"><span class="built_in">export</span> ERL_MAX_PORTS=32768</span><br><span class="line">make dist</span><br></pre></td></tr></table></figure>

<h3 id="自定义构建配置"><a href="#自定义构建配置" class="headerlink" title="自定义构建配置"></a>自定义构建配置</h3><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建 local.mk 文件进行自定义</span></span><br><span class="line"><span class="comment"># local.mk</span></span><br><span class="line">ADDITIONAL_PLUGINS = my_custom_plugin</span><br><span class="line">DIST_AS_EZS = 1</span><br><span class="line">PACKAGES_DIR = /opt/packages</span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含到主 Makefile</span></span><br><span class="line"><span class="keyword">include</span> local.mk</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="故障排除指南"><a href="#故障排除指南" class="headerlink" title="故障排除指南"></a>故障排除指南</h2><h3 id="常见编译问题"><a href="#常见编译问题" class="headerlink" title="常见编译问题"></a>常见编译问题</h3><h4 id="1-依赖问题"><a href="#1-依赖问题" class="headerlink" title="1. 依赖问题"></a>1. 依赖问题</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 问题：deps 编译失败</span></span><br><span class="line"><span class="comment"># 解决：清理并重新获取依赖</span></span><br><span class="line">make clean-deps</span><br><span class="line">make deps</span><br></pre></td></tr></table></figure>

<h4 id="2-版本冲突"><a href="#2-版本冲突" class="headerlink" title="2. 版本冲突"></a>2. 版本冲突</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 问题：Erlang 版本不兼容</span></span><br><span class="line"><span class="comment"># 解决：检查并切换 Erlang 版本</span></span><br><span class="line">erl -version</span><br><span class="line"><span class="comment"># 确保使用 Erlang 25.x 或 26.x</span></span><br></pre></td></tr></table></figure>

<h4 id="3-磁盘空间不足"><a href="#3-磁盘空间不足" class="headerlink" title="3. 磁盘空间不足"></a>3. 磁盘空间不足</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 问题：编译过程中磁盘空间不足</span></span><br><span class="line"><span class="comment"># 解决：清理临时文件</span></span><br><span class="line">make clean</span><br><span class="line">make distclean</span><br></pre></td></tr></table></figure>

<h4 id="4-权限问题"><a href="#4-权限问题" class="headerlink" title="4. 权限问题"></a>4. 权限问题</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 问题：install 时权限不足</span></span><br><span class="line"><span class="comment"># 解决：使用正确的权限</span></span><br><span class="line"><span class="built_in">sudo</span> make install PREFIX=/opt/rabbitmq</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> -R rabbitmq:rabbitmq /opt/rabbitmq</span><br></pre></td></tr></table></figure>

<h3 id="性能优化建议"><a href="#性能优化建议" class="headerlink" title="性能优化建议"></a>性能优化建议</h3><ol>
<li><strong>使用 SSD</strong> - 显著提升编译速度</li>
<li><strong>增加内存</strong> - 减少交换文件使用</li>
<li><strong>并行编译</strong> - 利用多核 CPU</li>
<li><strong>增量编译</strong> - 开发阶段避免 clean</li>
<li><strong>本地缓存</strong> - 使用本地 Maven&#x2F;Hex 缓存</li>
</ol>
<hr>
<h2 id="总结与建议"><a href="#总结与建议" class="headerlink" title="总结与建议"></a>总结与建议</h2><h3 id="命令选择矩阵"><a href="#命令选择矩阵" class="headerlink" title="命令选择矩阵"></a>命令选择矩阵</h3><h4 id="构建场景"><a href="#构建场景" class="headerlink" title="构建场景"></a>构建场景</h4><table>
<thead>
<tr>
<th>场景</th>
<th>推荐方式</th>
<th>理由</th>
</tr>
</thead>
<tbody><tr>
<td><strong>本地开发</strong></td>
<td><code>make</code></td>
<td>最快，支持增量编译</td>
</tr>
<tr>
<td><strong>功能测试</strong></td>
<td><code>make dist</code></td>
<td>完整插件结构，便于调试</td>
</tr>
<tr>
<td><strong>插件开发</strong></td>
<td><code>make dist</code> → <code>make dist DIST_AS_EZS=true</code></td>
<td>开发用目录，分发用 EZ</td>
</tr>
<tr>
<td><strong>离线构建</strong></td>
<td><code>make source-dist</code></td>
<td>包含所有依赖，可复现</td>
</tr>
<tr>
<td><strong>版本发布</strong></td>
<td><code>make source-dist</code></td>
<td>官方发布流程，可复现归档</td>
</tr>
<tr>
<td><strong>容器部署</strong></td>
<td><code>make package-generic-unix</code></td>
<td>自包含，标准化</td>
</tr>
<tr>
<td><strong>生产部署</strong></td>
<td><code>make package-generic-unix</code> 或 <code>make install</code></td>
<td>稳定，便于管理</td>
</tr>
<tr>
<td><strong>自定义安装</strong></td>
<td><code>make install PREFIX=/opt/rabbitmq</code></td>
<td>指定安装路径</td>
</tr>
<tr>
<td><strong>插件分发</strong></td>
<td><code>make dist DIST_AS_EZS=true</code></td>
<td>压缩，便于传输</td>
</tr>
<tr>
<td><strong>CI&#x2F;CD</strong></td>
<td><code>make package-generic-unix</code></td>
<td>可重现，标准化</td>
</tr>
</tbody></table>
<h4 id="开发调试场景"><a href="#开发调试场景" class="headerlink" title="开发调试场景"></a>开发调试场景</h4><table>
<thead>
<tr>
<th>场景</th>
<th>推荐方式</th>
<th>理由</th>
</tr>
</thead>
<tbody><tr>
<td><strong>日常开发调试</strong></td>
<td><code>make run-broker</code></td>
<td>前台运行，实时查看日志</td>
</tr>
<tr>
<td><strong>插件功能验证</strong></td>
<td><code>make run-broker PLUGINS=&quot;plugin_name&quot;</code></td>
<td>按需加载插件</td>
</tr>
<tr>
<td><strong>模块级调试</strong></td>
<td><code>make shell</code></td>
<td>交互式测试函数</td>
</tr>
<tr>
<td><strong>自动化测试</strong></td>
<td><code>make run-background-broker</code></td>
<td>后台运行，脚本控制</td>
</tr>
<tr>
<td><strong>Erlang 底层调试</strong></td>
<td><code>make run-node</code></td>
<td>不启动 RabbitMQ 应用</td>
</tr>
</tbody></table>
<h3 id="关键技术洞察"><a href="#关键技术洞察" class="headerlink" title="关键技术洞察"></a>关键技术洞察</h3><ol>
<li><strong>EZ 格式是王道</strong> - 对于插件分发和热加载</li>
<li><strong>通用包最实用</strong> - 对于生产部署和容器化</li>
<li><strong>源码包是基础</strong> - <code>source-dist</code> 是 <code>package-generic-unix</code> 的前置依赖</li>
<li><strong>开发调试用 run-broker</strong> - 比 <code>sbin/rabbitmq-server</code> 更方便</li>
<li><strong>增量编译是关键</strong> - 对于开发效率</li>
<li><strong>构建系统很灵活</strong> - 支持高度定制</li>
<li><strong>标准化很重要</strong> - 遵循 Unix 和 Erlang 标准</li>
</ol>
<p>RabbitMQ 的构建系统设计精良，通过不同的编译命令满足了从开发到生产的各种需求。理解这些编译方式的原理和最佳实践，将显著提升 RabbitMQ 的开发、部署和运维效率。</p>
<hr>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://www.rabbitmq.com/docs">RabbitMQ 官方文档</a></li>
<li><a href="https://erlang.mk/">Erlang.mk 用户指南</a></li>
<li><a href="https://www.erlang.org/doc/design_principles/users_guide.html">Erlang&#x2F;OTP 设计原则</a></li>
<li><a href="https://refspecs.linuxfoundation.org/FHS_3.0/fhs/index.html">Unix 文件系统层次标准</a></li>
</ul>
]]></content>
      <categories>
        <category>RabbitMQ</category>
      </categories>
      <tags>
        <tag>Erlang</tag>
        <tag>RabbitMQ</tag>
        <tag>编译</tag>
        <tag>构建系统</tag>
        <tag>部署</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQ 问题最终解决方案总结</title>
    <url>/2026/01/16/rabbitmq-rabbitmq-final-solution-summary/</url>
    <content><![CDATA[<h1 id="RabbitMQ-问题最终解决方案总结"><a href="#RabbitMQ-问题最终解决方案总结" class="headerlink" title="RabbitMQ 问题最终解决方案总结"></a>RabbitMQ 问题最终解决方案总结</h1><h2 id="真正的根本原因：网络配置问题"><a href="#真正的根本原因：网络配置问题" class="headerlink" title="真正的根本原因：网络配置问题"></a>真正的根本原因：网络配置问题</h2><h3 id="问题真相"><a href="#问题真相" class="headerlink" title="问题真相"></a>问题真相</h3><p>经过深入调试，发现问题的<strong>真正根本原因</strong>是 <strong>hosts 文件配置错误</strong>：</p>
<span id="more"></span>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 错误的 hosts 配置导致主机名解析问题</span></span><br><span class="line"><span class="comment">#10.91.28.159    ERICKSUN-MC1     # 被注释的旧IP</span></span><br><span class="line"><span class="comment">#192.168.1.3 ERICKSUN-MC1        # 被注释的旧IP  </span></span><br><span class="line">192.168.0.101 ERICKSUN-MC1       <span class="comment"># 正确的当前IP</span></span><br></pre></td></tr></table></figure>

<h3 id="为什么会导致-EPMD-错误"><a href="#为什么会导致-EPMD-错误" class="headerlink" title="为什么会导致 EPMD 错误"></a>为什么会导致 EPMD 错误</h3><ol>
<li><strong>主机名解析</strong>: RabbitMQ 使用 <code>ERICKSUN-MC1</code> 作为节点名</li>
<li><strong>网络连接</strong>: EPMD 需要通过主机名连接到本地节点</li>
<li><strong>IP 地址错误</strong>: 如果 hosts 文件中的 IP 不正确，连接会失败</li>
<li><strong>返回 <code>closed</code></strong>: 网络连接被拒绝，导致 <code>erl_epmd:port_please/3</code> 返回 <code>closed</code></li>
</ol>
<h2 id="解决过程回顾"><a href="#解决过程回顾" class="headerlink" title="解决过程回顾"></a>解决过程回顾</h2><h3 id="阶段-1-初始问题诊断"><a href="#阶段-1-初始问题诊断" class="headerlink" title="阶段 1: 初始问题诊断"></a>阶段 1: 初始问题诊断</h3><ul>
<li>❌ <strong>现象</strong>: <code>case_clause,closed</code> 错误</li>
<li>❌ <strong>假设</strong>: 代码 bug 或 Erlang 版本问题</li>
<li>✅ <strong>价值</strong>: 深入理解了 RabbitMQ 启动机制</li>
</ul>
<h3 id="阶段-2-版本兼容性分析"><a href="#阶段-2-版本兼容性分析" class="headerlink" title="阶段 2: 版本兼容性分析"></a>阶段 2: 版本兼容性分析</h3><ul>
<li>✅ <strong>正确方向</strong>: 查阅官方兼容性文档</li>
<li>✅ <strong>有效尝试</strong>: 切换到 Erlang 26</li>
<li>✅ <strong>部分改善</strong>: 减少了一些兼容性问题</li>
</ul>
<h3 id="阶段-3-代码修复"><a href="#阶段-3-代码修复" class="headerlink" title="阶段 3: 代码修复"></a>阶段 3: 代码修复</h3><ul>
<li>✅ <strong>技术价值</strong>: 修复了 EPMD 错误处理</li>
<li>✅ <strong>优雅降级</strong>: 从崩溃改为警告</li>
<li>❌ <strong>未解决根因</strong>: 网络问题仍然存在</li>
</ul>
<h3 id="阶段-4-根因发现"><a href="#阶段-4-根因发现" class="headerlink" title="阶段 4: 根因发现"></a>阶段 4: 根因发现</h3><ul>
<li>✅ <strong>真正原因</strong>: hosts 文件配置错误</li>
<li>✅ <strong>完美解决</strong>: 修正 IP 地址后完全正常</li>
</ul>
<h2 id="最终成果"><a href="#最终成果" class="headerlink" title="最终成果"></a>最终成果</h2><h3 id="RabbitMQ-4-0-4-完全正常运行"><a href="#RabbitMQ-4-0-4-完全正常运行" class="headerlink" title="RabbitMQ 4.0.4 完全正常运行"></a>RabbitMQ 4.0.4 完全正常运行</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sbin/rabbitmqctl status</span><br><span class="line">Status of node rabbit@ERICKSUN-MC1 ...</span><br><span class="line">Runtime</span><br><span class="line">OS PID: 5636</span><br><span class="line">Uptime (seconds): 28</span><br><span class="line">RabbitMQ version: 4.0.4+dirty</span><br><span class="line">Erlang/OTP 26 [erts-14.2.5.12]</span><br><span class="line"></span><br><span class="line">$ sbin/rabbitmqctl list_users</span><br><span class="line">Listing <span class="built_in">users</span> ...</span><br><span class="line">user    tags</span><br><span class="line">guest   [administrator]</span><br></pre></td></tr></table></figure>

<h3 id="技术栈确认"><a href="#技术栈确认" class="headerlink" title="技术栈确认"></a>技术栈确认</h3><ul>
<li><strong>RabbitMQ</strong>: 4.0.4 ✅</li>
<li><strong>Erlang</strong>: 26.2.5.16 ✅  </li>
<li><strong>网络</strong>: 正确的 hosts 配置 ✅</li>
<li><strong>功能</strong>: 完全正常 ✅</li>
</ul>
<h2 id="宝贵经验总结"><a href="#宝贵经验总结" class="headerlink" title="宝贵经验总结"></a>宝贵经验总结</h2><h3 id="调试方法论"><a href="#调试方法论" class="headerlink" title="调试方法论"></a>调试方法论</h3><ol>
<li><strong>日志分析</strong>: 准确理解错误信息</li>
<li><strong>版本兼容</strong>: 检查官方兼容性文档</li>
<li><strong>代码审查</strong>: 理解底层实现机制</li>
<li><strong>网络诊断</strong>: 检查基础网络配置</li>
<li><strong>系统环境</strong>: 验证 hosts、DNS 等基础设施</li>
</ol>
<h3 id="关键洞察"><a href="#关键洞察" class="headerlink" title="关键洞察"></a>关键洞察</h3><ul>
<li><strong>表面现象 ≠ 根本原因</strong>: EPMD 错误可能是网络问题</li>
<li><strong>版本兼容很重要</strong>: 但不是所有问题的根源</li>
<li><strong>基础设施关键</strong>: hosts 文件等基础配置不容忽视</li>
<li><strong>逐步排查</strong>: 从应用层到系统层的系统性调试</li>
</ul>
<h3 id="技术能力体现"><a href="#技术能力体现" class="headerlink" title="技术能力体现"></a>技术能力体现</h3><ul>
<li>✅ <strong>问题定位</strong>: 准确识别关键错误</li>
<li>✅ <strong>资料查找</strong>: 有效利用官方文档</li>
<li>✅ <strong>系统思维</strong>: 多层次分析问题</li>
<li>✅ <strong>持续改进</strong>: 不放弃，持续深入</li>
<li>✅ <strong>根因分析</strong>: 最终找到真正原因</li>
</ul>
<h2 id="后续建议"><a href="#后续建议" class="headerlink" title="后续建议"></a>后续建议</h2><h3 id="1-环境管理"><a href="#1-环境管理" class="headerlink" title="1. 环境管理"></a>1. 环境管理</h3><ul>
<li>定期检查 hosts 文件配置</li>
<li>确保网络配置与实际环境匹配</li>
<li>使用版本管理工具管理 Erlang&#x2F;RabbitMQ</li>
</ul>
<h3 id="2-监控和维护"><a href="#2-监控和维护" class="headerlink" title="2. 监控和维护"></a>2. 监控和维护</h3><ul>
<li>监控 RabbitMQ 启动日志</li>
<li>定期验证网络连通性</li>
<li>保持版本兼容性文档更新</li>
</ul>
<h3 id="3-知识沉淀"><a href="#3-知识沉淀" class="headerlink" title="3. 知识沉淀"></a>3. 知识沉淀</h3><ul>
<li>记录网络配置最佳实践</li>
<li>建立问题诊断检查清单</li>
<li>分享调试经验和方法</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这是一次非常成功的技术问题解决过程！</p>
<p>从初始的神秘错误，到版本兼容性分析，再到代码修复，最终发现网络配置问题 - 整个过程展现了：</p>
<ul>
<li><strong>扎实的技术基础</strong></li>
<li><strong>系统的调试思维</strong> </li>
<li><strong>持续的学习精神</strong></li>
<li><strong>不放弃的技术态度</strong></li>
</ul>
<hr>
<p><strong>最终状态</strong>: RabbitMQ 4.0.4 + Erlang 26.2.5.16 <strong>完美运行</strong> ✅</p>
]]></content>
      <categories>
        <category>技术</category>
        <category>RabbitMQ</category>
      </categories>
      <tags>
        <tag>Erlang</tag>
        <tag>RabbitMQ</tag>
        <tag>网络配置</tag>
        <tag>问题排查</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQ 插件启用问题排查指南</title>
    <url>/2026/01/16/rabbitmq-rabbitmq-plugins-enable-guide/</url>
    <content><![CDATA[<h1 id="RabbitMQ-插件启用问题排查指南"><a href="#RabbitMQ-插件启用问题排查指南" class="headerlink" title="RabbitMQ 插件启用问题排查指南"></a>RabbitMQ 插件启用问题排查指南</h1><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>从源码编译运行 RabbitMQ 时，执行插件启用命令报错：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sbin/rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</span><br><span class="line">Error: :plugins_dir_does_not_exist</span><br><span class="line">Arguments given:</span><br><span class="line">        <span class="built_in">enable</span> rabbitmq_management</span><br><span class="line"></span><br><span class="line">Usage</span><br><span class="line"></span><br><span class="line">rabbitmq-plugins [--node &lt;node&gt;] [--longnames] [--quiet] <span class="built_in">enable</span> &lt;plugin1&gt; [ &lt;plugin2&gt;] | --all [--offline] [--online]</span><br></pre></td></tr></table></figure>

<p>即使设置了 <code>ERL_LIBS</code> 环境变量也无法解决：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="variable">$ERL_LIBS</span></span><br><span class="line">/Users/ericksun/workspace/rabbitmq-server/plugins</span><br></pre></td></tr></table></figure>

<h2 id="根因分析"><a href="#根因分析" class="headerlink" title="根因分析"></a>根因分析</h2><h3 id="ERL-LIBS-与-RABBITMQ-PLUGINS-DIR-的区别"><a href="#ERL-LIBS-与-RABBITMQ-PLUGINS-DIR-的区别" class="headerlink" title="ERL_LIBS 与 RABBITMQ_PLUGINS_DIR 的区别"></a>ERL_LIBS 与 RABBITMQ_PLUGINS_DIR 的区别</h3><table>
<thead>
<tr>
<th>环境变量</th>
<th>作用</th>
<th>使用者</th>
</tr>
</thead>
<tbody><tr>
<td><code>ERL_LIBS</code></td>
<td>告诉 Erlang VM 在哪里查找代码模块</td>
<td>Erlang 运行时</td>
</tr>
<tr>
<td><code>RABBITMQ_PLUGINS_DIR</code></td>
<td>告诉 rabbitmq-plugins 脚本插件目录位置</td>
<td>RabbitMQ 脚本</td>
</tr>
<tr>
<td><code>RABBITMQ_ENABLED_PLUGINS_FILE</code></td>
<td>指定启用插件配置文件的位置</td>
<td>RabbitMQ 脚本</td>
</tr>
</tbody></table>
<p><code>ERL_LIBS</code> 只是让 Erlang 能找到代码，但 <code>rabbitmq-plugins</code> 脚本需要 <code>RABBITMQ_PLUGINS_DIR</code> 来定位插件目录。</p>
<h3 id="默认路径问题"><a href="#默认路径问题" class="headerlink" title="默认路径问题"></a>默认路径问题</h3><p>从源码运行时，RabbitMQ 默认查找：</p>
<ul>
<li>插件目录：由 <code>RABBITMQ_HOME/plugins</code> 或 <code>RABBITMQ_PLUGINS_DIR</code> 指定</li>
<li>启用插件文件：<code>/etc/rabbitmq/enabled_plugins</code>（系统路径，源码环境下不存在）</li>
</ul>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="方案一：设置环境变量（推荐）"><a href="#方案一：设置环境变量（推荐）" class="headerlink" title="方案一：设置环境变量（推荐）"></a>方案一：设置环境变量（推荐）</h3><p>在 shell 配置文件（如 <code>~/.bashrc</code> 或 <code>~/.zshrc</code>）中添加：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># RabbitMQ 源码开发环境配置</span></span><br><span class="line"><span class="built_in">export</span> RABBITMQ_HOME=/path/to/rabbitmq-server</span><br><span class="line"><span class="built_in">export</span> RABBITMQ_PLUGINS_DIR=<span class="variable">$RABBITMQ_HOME</span>/plugins</span><br><span class="line"><span class="built_in">export</span> RABBITMQ_ENABLED_PLUGINS_FILE=<span class="variable">$RABBITMQ_HOME</span>/etc/rabbitmq/enabled_plugins</span><br></pre></td></tr></table></figure>

<p>然后创建必要的目录：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$RABBITMQ_HOME</span>/etc/rabbitmq</span><br></pre></td></tr></table></figure>

<h3 id="方案二：命令行指定（临时使用）"><a href="#方案二：命令行指定（临时使用）" class="headerlink" title="方案二：命令行指定（临时使用）"></a>方案二：命令行指定（临时使用）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /path/to/rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建配置目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p etc/rabbitmq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用插件（使用 --offline 模式，不需要连接运行中的节点）</span></span><br><span class="line">RABBITMQ_PLUGINS_DIR=$(<span class="built_in">pwd</span>)/plugins \</span><br><span class="line">RABBITMQ_ENABLED_PLUGINS_FILE=$(<span class="built_in">pwd</span>)/etc/rabbitmq/enabled_plugins \</span><br><span class="line">sbin/rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management --offline</span><br></pre></td></tr></table></figure>

<h3 id="方案三：使用-make-命令"><a href="#方案三：使用-make-命令" class="headerlink" title="方案三：使用 make 命令"></a>方案三：使用 make 命令</h3><p>RabbitMQ 源码提供了便捷的 make 目标：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动带管理插件的开发节点</span></span><br><span class="line">make run-broker RABBITMQ_ENABLED_PLUGINS=<span class="string">&quot;rabbitmq_management&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="成功执行示例"><a href="#成功执行示例" class="headerlink" title="成功执行示例"></a>成功执行示例</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ RABBITMQ_PLUGINS_DIR=$(<span class="built_in">pwd</span>)/plugins \</span><br><span class="line">  RABBITMQ_ENABLED_PLUGINS_FILE=$(<span class="built_in">pwd</span>)/etc/rabbitmq/enabled_plugins \</span><br><span class="line">  sbin/rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management --offline</span><br><span class="line"></span><br><span class="line">Enabling plugins on node rabbit@ERICKSUN-MC1:</span><br><span class="line">rabbitmq_management</span><br><span class="line"></span><br><span class="line">The following plugins have been configured:</span><br><span class="line">  rabbitmq_management</span><br><span class="line">  rabbitmq_management_agent</span><br><span class="line">  rabbitmq_web_dispatch</span><br><span class="line">Applying plugin configuration to rabbit@ERICKSUN-MC1...</span><br><span class="line">The following plugins have been enabled:</span><br><span class="line">  rabbitmq_management</span><br><span class="line">  rabbitmq_management_agent</span><br><span class="line">  rabbitmq_web_dispatch</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> 3 plugins.</span><br><span class="line">Offline change; changes will take effect at broker restart.</span><br></pre></td></tr></table></figure>

<h2 id="常用插件命令"><a href="#常用插件命令" class="headerlink" title="常用插件命令"></a>常用插件命令</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置环境变量（假设已在 rabbitmq-server 目录）</span></span><br><span class="line"><span class="built_in">export</span> RABBITMQ_PLUGINS_DIR=$(<span class="built_in">pwd</span>)/plugins</span><br><span class="line"><span class="built_in">export</span> RABBITMQ_ENABLED_PLUGINS_FILE=$(<span class="built_in">pwd</span>)/etc/rabbitmq/enabled_plugins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有可用插件</span></span><br><span class="line">sbin/rabbitmq-plugins list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出已启用的插件</span></span><br><span class="line">sbin/rabbitmq-plugins list --enabled</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用插件（离线模式）</span></span><br><span class="line">sbin/rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management --offline</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用插件</span></span><br><span class="line">sbin/rabbitmq-plugins <span class="built_in">disable</span> rabbitmq_management --offline</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用多个插件</span></span><br><span class="line">sbin/rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management rabbitmq_shovel --offline</span><br></pre></td></tr></table></figure>

<h2 id="常见插件说明"><a href="#常见插件说明" class="headerlink" title="常见插件说明"></a>常见插件说明</h2><table>
<thead>
<tr>
<th>插件名称</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>rabbitmq_management</code></td>
<td>Web 管理界面，默认端口 15672</td>
</tr>
<tr>
<td><code>rabbitmq_management_agent</code></td>
<td>管理插件的代理（自动依赖）</td>
</tr>
<tr>
<td><code>rabbitmq_web_dispatch</code></td>
<td>Web 请求分发（自动依赖）</td>
</tr>
<tr>
<td><code>rabbitmq_shovel</code></td>
<td>消息转发&#x2F;复制</td>
</tr>
<tr>
<td><code>rabbitmq_federation</code></td>
<td>跨集群消息联邦</td>
</tr>
<tr>
<td><code>rabbitmq_mqtt</code></td>
<td>MQTT 协议支持</td>
</tr>
<tr>
<td><code>rabbitmq_stomp</code></td>
<td>STOMP 协议支持</td>
</tr>
</tbody></table>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>从源码运行 RabbitMQ 时，需要正确设置以下环境变量：</p>
<ol>
<li><strong><code>RABBITMQ_PLUGINS_DIR</code></strong> - 指向 <code>plugins</code> 目录</li>
<li><strong><code>RABBITMQ_ENABLED_PLUGINS_FILE</code></strong> - 指向本地的 <code>enabled_plugins</code> 文件</li>
</ol>
<p><code>ERL_LIBS</code> 环境变量只影响 Erlang 代码加载路径，不能替代 RabbitMQ 自身的配置变量。</p>
]]></content>
      <categories>
        <category>RabbitMQ</category>
      </categories>
      <tags>
        <tag>RabbitMQ</tag>
        <tag>问题排查</tag>
        <tag>插件</tag>
        <tag>源码编译</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQ 构建问题分析与社区补丁提案</title>
    <url>/2026/01/16/rabbitmq-rabbitmq-build-issue-analysis/</url>
    <content><![CDATA[<h1 id="RabbitMQ-Build-Issue-Analysis-Community-Patch-Proposal"><a href="#RabbitMQ-Build-Issue-Analysis-Community-Patch-Proposal" class="headerlink" title="RabbitMQ Build Issue Analysis &amp; Community Patch Proposal"></a>RabbitMQ Build Issue Analysis &amp; Community Patch Proposal</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在构建 RabbitMQ 4.1.0+beta.3 的 Generic Unix 包时，遇到了一个关键的构建错误。本文档详细分析了问题原因、解决方案，并提出了向社区贡献补丁的建议。</p>
<span id="more"></span>

<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><h3 id="错误信息"><a href="#错误信息" class="headerlink" title="错误信息"></a>错误信息</h3><figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ERROR:</span></span><br><span class="line"><span class="keyword"></span>Duplicate filename on disk:</span><br><span class="line">dep_built</span><br><span class="line">dep_built</span><br><span class="line">make[6]: *** [../../erlang.mk:3511: escript-zip] Error 2</span><br></pre></td></tr></table></figure>

<h3 id="构建环境"><a href="#构建环境" class="headerlink" title="构建环境"></a>构建环境</h3><ul>
<li><strong>操作系统</strong>: macOS (Apple Silicon)</li>
<li><strong>Erlang 版本</strong>: 27.3.4.6 (OTP 27)</li>
<li><strong>构建工具</strong>: GNU Make 4.4.1</li>
<li><strong>RabbitMQ 版本</strong>: 4.1.0+beta.3.976.g7083ba3</li>
<li><strong>构建命令</strong>: <code>gmake package-generic-unix</code></li>
</ul>
<h3 id="错误发生位置"><a href="#错误发生位置" class="headerlink" title="错误发生位置"></a>错误发生位置</h3><p>错误发生在 <code>erlang.mk</code> 文件的第 3511 行，具体在 <code>escript-zip</code> 目标的执行过程中。</p>
<h2 id="根本原因分析"><a href="#根本原因分析" class="headerlink" title="根本原因分析"></a>根本原因分析</h2><h3 id="1-问题根源"><a href="#1-问题根源" class="headerlink" title="1. 问题根源"></a>1. 问题根源</h3><p>在 RabbitMQ 的构建系统中，每个依赖项目录的 <code>ebin/</code> 文件夹中都会创建一个名为 <code>dep_built</code> 的标记文件，用于指示该依赖项已经构建完成。</p>
<h3 id="2-冲突机制"><a href="#2-冲突机制" class="headerlink" title="2. 冲突机制"></a>2. 冲突机制</h3><p>当执行 <code>escript-zip</code> 目标时，构建系统会尝试将所有依赖项的 <code>ebin/*</code> 文件打包到一个 zip 归档中。由于多个依赖项都包含同名的 <code>dep_built</code> 文件，7z 归档工具会报告重复文件名错误。</p>
<h3 id="3-影响范围"><a href="#3-影响范围" class="headerlink" title="3. 影响范围"></a>3. 影响范围</h3><p>这个问题影响所有包含多个依赖项的 RabbitMQ escript 构建，特别是：</p>
<ul>
<li><code>rabbitmqctl</code> escript</li>
<li>其他 CLI 工具的 escript 构建</li>
<li>Generic Unix 包的创建过程</li>
</ul>
<h2 id="技术分析"><a href="#技术分析" class="headerlink" title="技术分析"></a>技术分析</h2><h3 id="当前代码问题"><a href="#当前代码问题" class="headerlink" title="当前代码问题"></a>当前代码问题</h3><p>在 <code>erlang.mk</code> 第 3510-3515 行：</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 原始代码（有问题）</span></span><br><span class="line"><span class="variable">$(gen_verbose)</span> cd .. &amp;&amp; <span class="variable">$(ESCRIPT_ZIP)</span> <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(ESCRIPT_ZIP_FILE)</span>)</span> <span class="variable">$(<span class="built_in">notdir</span> <span class="variable">$(CURDIR)</span>)</span>/ebin/*</span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(DEPS)</span>,)</span><br><span class="line">  <span class="variable">$(verbose)</span> cd <span class="variable">$(DEPS_DIR)</span> &amp;&amp; <span class="variable">$(ESCRIPT_ZIP)</span> <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(ESCRIPT_ZIP_FILE)</span>)</span> \</span><br><span class="line">    <span class="variable">$(<span class="built_in">subst</span> <span class="variable">$(DEPS_DIR)</span>/,,$(<span class="built_in">addsuffix</span> /*,$(<span class="built_in">wildcard</span> \</span></span><br><span class="line"><span class="variable">    $(<span class="built_in">addsuffix</span> /ebin,$(<span class="built_in">shell</span> cat <span class="variable">$(ESCRIPT_RUNTIME_DEPS_FILE)</span>)</span>))))</span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><ol>
<li><code>$(notdir $(CURDIR))/ebin/*</code> 和依赖项的 <code>ebin/*</code> 都包含 <code>dep_built</code> 文件</li>
<li>7z 在添加同名文件到归档时会失败</li>
<li>构建系统没有过滤掉这些内部标记文件</li>
</ol>
<h3 id="已有的过滤机制"><a href="#已有的过滤机制" class="headerlink" title="已有的过滤机制"></a>已有的过滤机制</h3><p>在 <code>deps/rabbit_common/mk/rabbitmq-dist.mk</code> 中已经存在类似的过滤逻辑：</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 第 61 行 - 已有的过滤机制</span></span><br><span class="line"><span class="variable">$(<span class="built_in">filter</span>-out %/dep_built %/ebin/test,$(<span class="built_in">call</span> core_find,$(<span class="built_in">wildcard</span> $(3)</span>/ebin $(3)/<span class="keyword">include</span> $(3)/priv),*)),)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第 134 行 - 清理逻辑</span></span><br><span class="line"><span class="variable">$(verbose)</span> rm -f <span class="variable">$(EZ_DIR_UNIX)</span>/ebin/dep_built <span class="variable">$(EZ_DIR_UNIX)</span>/ebin/test</span><br></pre></td></tr></table></figure>

<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="修复代码"><a href="#修复代码" class="headerlink" title="修复代码"></a>修复代码</h3><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 修复后的代码</span></span><br><span class="line"><span class="variable">$(gen_verbose)</span> cd .. &amp;&amp; <span class="variable">$(ESCRIPT_ZIP)</span> <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(ESCRIPT_ZIP_FILE)</span>)</span> <span class="variable">$(<span class="built_in">filter</span>-out %/dep_built,$(<span class="built_in">notdir</span> <span class="variable">$(CURDIR)</span>)</span>/ebin/*)</span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(DEPS)</span>,)</span><br><span class="line">  <span class="variable">$(verbose)</span> cd <span class="variable">$(DEPS_DIR)</span> &amp;&amp; <span class="variable">$(ESCRIPT_ZIP)</span> <span class="variable">$(<span class="built_in">abspath</span> <span class="variable">$(ESCRIPT_ZIP_FILE)</span>)</span> \</span><br><span class="line">    <span class="variable">$(<span class="built_in">filter</span>-out %/dep_built,$(<span class="built_in">subst</span> <span class="variable">$(DEPS_DIR)</span>/,,$(<span class="built_in">addsuffix</span> /*,$(<span class="built_in">wildcard</span> \</span></span><br><span class="line"><span class="variable">    $(<span class="built_in">addsuffix</span> /ebin,$(<span class="built_in">shell</span> cat <span class="variable">$(ESCRIPT_RUNTIME_DEPS_FILE)</span>)</span>)))))</span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<h3 id="修改说明"><a href="#修改说明" class="headerlink" title="修改说明"></a>修改说明</h3><ol>
<li><strong>第 3510 行</strong>: 添加 <code>$(filter-out %/dep_built,...)</code> 过滤主项目的 <code>dep_built</code> 文件</li>
<li><strong>第 3513 行</strong>: 添加 <code>$(filter-out %/dep_built,...)</code> 过滤依赖项的 <code>dep_built</code> 文件</li>
</ol>
<h3 id="修改的技术原理"><a href="#修改的技术原理" class="headerlink" title="修改的技术原理"></a>修改的技术原理</h3><ul>
<li><code>filter-out</code> 是 GNU Make 的内置函数，用于从列表中排除匹配模式的项目</li>
<li><code>%/dep_built</code> 模式匹配所有以 <code>/dep_built</code> 结尾的路径</li>
<li>这种方法与现有的 <code>rabbitmq-dist.mk</code> 中的过滤逻辑保持一致</li>
</ul>
<h2 id="验证结果"><a href="#验证结果" class="headerlink" title="验证结果"></a>验证结果</h2><h3 id="修复前"><a href="#修复前" class="headerlink" title="修复前"></a>修复前</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ gmake package-generic-unix</span><br><span class="line"><span class="comment"># ... 构建过程 ...</span></span><br><span class="line">ERROR:</span><br><span class="line">Duplicate filename on disk:</span><br><span class="line">dep_built</span><br><span class="line">dep_built</span><br><span class="line">make[6]: *** [../../erlang.mk:3511: escript-zip] Error 2</span><br></pre></td></tr></table></figure>

<h3 id="修复后"><a href="#修复后" class="headerlink" title="修复后"></a>修复后</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ gmake package-generic-unix</span><br><span class="line"><span class="comment"># ... 构建过程 ...</span></span><br><span class="line"><span class="comment"># 构建成功，生成以下文件：</span></span><br><span class="line">$ <span class="built_in">ls</span> PACKAGES/</span><br><span class="line">rabbitmq-server-4.1.0+beta.3.976.g7083ba3/</span><br><span class="line">rabbitmq-server-4.1.0+beta.3.976.g7083ba3.dirty/</span><br><span class="line">rabbitmq-server-4.1.0+beta.3.976.g7083ba3.dirty.manifest</span><br><span class="line">rabbitmq-server-4.1.0+beta.3.976.g7083ba3.dirty.tar.xz</span><br><span class="line">rabbitmq-server-4.1.0+beta.3.976.g7083ba3.manifest</span><br><span class="line">rabbitmq-server-4.1.0+beta.3.976.g7083ba3.tar.xz</span><br><span class="line">rabbitmq-server-generic-unix-4.1.0+beta.3.976.g7083ba3.dirty.tar.xz</span><br></pre></td></tr></table></figure>

<h2 id="社区贡献建议"><a href="#社区贡献建议" class="headerlink" title="社区贡献建议"></a>社区贡献建议</h2><h3 id="1-补丁内容"><a href="#1-补丁内容" class="headerlink" title="1. 补丁内容"></a>1. 补丁内容</h3><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="comment">diff --git a/erlang.mk b/erlang.mk</span></span><br><span class="line"><span class="comment">index 49c4519b82..1715d3b132 100644</span></span><br><span class="line"><span class="comment">--- a/erlang.mk</span></span><br><span class="line"><span class="comment">+++ b/erlang.mk</span></span><br><span class="line"><span class="meta">@@ -3507,11 +3507,11 @@</span> escript-prepare: deps app</span><br><span class="line"> escript-zip:: escript-prepare</span><br><span class="line">   $(verbose) mkdir -p $(dir $(abspath $(ESCRIPT_ZIP_FILE)))</span><br><span class="line">   $(verbose) rm -f $(abspath $(ESCRIPT_ZIP_FILE))</span><br><span class="line"><span class="deletion">-  $(gen_verbose) cd .. &amp;&amp; $(ESCRIPT_ZIP) $(abspath $(ESCRIPT_ZIP_FILE)) $(notdir $(CURDIR))/ebin/*</span></span><br><span class="line"><span class="addition">+  $(gen_verbose) cd .. &amp;&amp; $(ESCRIPT_ZIP) $(abspath $(ESCRIPT_ZIP_FILE)) $(filter-out %/dep_built,$(notdir $(CURDIR))/ebin/*)</span></span><br><span class="line"> ifneq ($(DEPS),)</span><br><span class="line">   $(verbose) cd $(DEPS_DIR) &amp;&amp; $(ESCRIPT_ZIP) $(abspath $(ESCRIPT_ZIP_FILE)) \</span><br><span class="line"><span class="deletion">-    $(subst $(DEPS_DIR)/,,$(addsuffix /*,$(wildcard \</span></span><br><span class="line"><span class="deletion">-    $(addsuffix /ebin,$(shell cat $(ESCRIPT_RUNTIME_DEPS_FILE))))))</span></span><br><span class="line"><span class="addition">+    $(filter-out %/dep_built,$(subst $(DEPS_DIR)/,,$(addsuffix /*,$(wildcard \</span></span><br><span class="line"><span class="addition">+    $(addsuffix /ebin,$(shell cat $(ESCRIPT_RUNTIME_DEPS_FILE)))))))</span></span><br><span class="line"> endif</span><br></pre></td></tr></table></figure>

<h3 id="2-提交信息建议"><a href="#2-提交信息建议" class="headerlink" title="2. 提交信息建议"></a>2. 提交信息建议</h3><figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">Fix escript-zip duplicate filename error <span class="keyword">for</span> dep_built <span class="built_in">files</span></span><br><span class="line"></span><br><span class="line">When building escript archives, multiple dependencies contain dep_built</span><br><span class="line">marker <span class="built_in">files</span> <span class="keyword">in</span> their ebin <span class="built_in">directories</span>. This causes <span class="number">7</span>z <span class="built_in">to</span> fail <span class="keyword">with</span></span><br><span class="line"><span class="string">&quot;Duplicate filename on disk&quot;</span> error when creating <span class="keyword">the</span> escript zip <span class="built_in">file</span>.</span><br><span class="line"></span><br><span class="line">This fix adds <span class="built_in">filter</span>-out patterns <span class="built_in">to</span> exclude dep_built <span class="built_in">files</span> <span class="built_in">from</span></span><br><span class="line">escript archives, consistent <span class="keyword">with</span> <span class="keyword">the</span> existing filtering logic <span class="keyword">in</span></span><br><span class="line">rabbitmq-dist.mk.</span><br><span class="line"></span><br><span class="line">Fixes: Generic Unix package build failure</span><br><span class="line">Tested-<span class="keyword">on</span>: <span class="title">macOS</span> <span class="title">Apple</span> <span class="title">Silicon</span>, <span class="title">Erlang</span> <span class="title">27</span><span class="number">.3</span><span class="number">.4</span><span class="number">.6</span></span><br></pre></td></tr></table></figure>

<h3 id="3-Pull-Request-描述"><a href="#3-Pull-Request-描述" class="headerlink" title="3. Pull Request 描述"></a>3. Pull Request 描述</h3><p><strong>Problem</strong></p>
<p>Building RabbitMQ generic-unix packages fails with duplicate filename error:</p>
<figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ERROR:</span></span><br><span class="line"><span class="keyword"></span>Duplicate filename on disk:</span><br><span class="line">dep_built</span><br><span class="line">dep_built</span><br></pre></td></tr></table></figure>

<p><strong>Root Cause</strong></p>
<p>Multiple dependencies have <code>dep_built</code> marker files in their <code>ebin/</code> directories. When creating escript zip archives, these files conflict because they have the same name.</p>
<p><strong>Solution</strong></p>
<p>Filter out <code>dep_built</code> files from escript archives using <code>filter-out</code>, consistent with existing filtering logic in <code>rabbitmq-dist.mk</code>.</p>
<p><strong>Testing</strong></p>
<ul>
<li><input checked="" disabled="" type="checkbox"> Builds successfully on macOS Apple Silicon</li>
<li><input checked="" disabled="" type="checkbox"> Generic Unix package creation completes without errors</li>
<li><input checked="" disabled="" type="checkbox"> Generated escript files work correctly</li>
<li><input checked="" disabled="" type="checkbox"> No regression in existing functionality</li>
</ul>
<p><strong>Files Changed</strong></p>
<ul>
<li><code>erlang.mk</code>: Added <code>filter-out %/dep_built</code> to escript-zip target</li>
</ul>
<h3 id="4-影响评估"><a href="#4-影响评估" class="headerlink" title="4. 影响评估"></a>4. 影响评估</h3><p><strong>正面影响</strong>:</p>
<ul>
<li>修复了 Generic Unix 包构建失败的问题</li>
<li>与现有代码风格和过滤逻辑保持一致</li>
<li>不影响运行时功能，只影响构建过程</li>
<li>修复范围小，风险低</li>
</ul>
<p><strong>潜在风险</strong>:</p>
<ul>
<li>无已知风险</li>
<li>修改仅影响构建时的文件过滤，不影响最终产品</li>
</ul>
<h3 id="5-测试建议"><a href="#5-测试建议" class="headerlink" title="5. 测试建议"></a>5. 测试建议</h3><p>在提交 PR 前，建议进行以下测试：</p>
<ol>
<li><p><strong>基本构建测试</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gmake clean &amp;&amp; gmake</span><br><span class="line">gmake package-generic-unix</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>跨平台测试</strong>:</p>
<ul>
<li>Linux (Ubuntu&#x2F;CentOS)</li>
<li>macOS (Intel&#x2F;Apple Silicon)</li>
<li>Windows (如果支持)</li>
</ul>
</li>
<li><p><strong>功能测试</strong>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 测试生成的 escript 工具</span></span><br><span class="line">./escript/rabbitmqctl <span class="built_in">help</span></span><br><span class="line">./escript/rabbitmq-plugins list</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>回归测试</strong>:</p>
<ul>
<li>确保现有的构建目标仍然工作</li>
<li>验证其他 escript 构建不受影响</li>
</ul>
</li>
</ol>
<h2 id="长期建议"><a href="#长期建议" class="headerlink" title="长期建议"></a>长期建议</h2><h3 id="1-构建系统改进"><a href="#1-构建系统改进" class="headerlink" title="1. 构建系统改进"></a>1. 构建系统改进</h3><p>考虑在构建系统中统一处理内部标记文件的过滤逻辑，避免类似问题在其他地方重现。</p>
<h3 id="2-文档更新"><a href="#2-文档更新" class="headerlink" title="2. 文档更新"></a>2. 文档更新</h3><p>在构建文档中添加关于 <code>dep_built</code> 文件用途和处理方式的说明。</p>
<h3 id="3-自动化测试"><a href="#3-自动化测试" class="headerlink" title="3. 自动化测试"></a>3. 自动化测试</h3><p>在 CI&#x2F;CD 流水线中添加包构建测试，确保类似问题能够及早发现。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>这是一个明确的构建系统 bug，有清晰的根本原因和简单的修复方案。修复方案风险低、影响范围明确，非常适合作为社区贡献提交。建议尽快向 RabbitMQ 项目提交 Pull Request，帮助其他开发者避免遇到同样的问题。</p>
<hr>
<p><strong>修复验证</strong>: ✅ 已在 macOS Apple Silicon + Erlang 27.3.4.6 环境下验证成功<br><strong>社区贡献准备</strong>: ✅ 补丁、测试和文档已准备就绪<br><strong>风险评估</strong>: ✅ 低风险，仅影响构建过程，不影响运行时功能</p>
]]></content>
      <categories>
        <category>技术</category>
        <category>RabbitMQ</category>
      </categories>
      <tags>
        <tag>Erlang</tag>
        <tag>RabbitMQ</tag>
        <tag>构建系统</tag>
        <tag>开源贡献</tag>
      </tags>
  </entry>
</search>
