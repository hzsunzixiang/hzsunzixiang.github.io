<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAQæ›´æ–°æ“ä½œæµç¨‹æ·±åº¦åˆ†æ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            color: #34495e;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-top: 40px;
        }
        h3 {
            color: #2980b9;
            margin-top: 30px;
        }
        h4 {
            color: #8e44ad;
            margin-top: 25px;
        }
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 15px 0;
            border-left: 5px solid #3498db;
        }
        .highlight {
            background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #e74c3c;
        }
        .summary {
            background: linear-gradient(120deg, #d299c2 0%, #fef9d7 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #f39c12;
        }
        .flow-diagram {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid #dee2e6;
            text-align: center;
        }
        .data-structure {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
            border: 2px solid #00ff00;
        }
        .performance-metric {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
            font-weight: bold;
        }
        .node-info {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 5px solid #9b59b6;
        }
        .update-step {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 5px solid #ffc107;
        }
        .error-box {
            background: #f8d7da;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 5px solid #dc3545;
        }
        .success-box {
            background: #d4edda;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 5px solid #28a745;
        }
        ul {
            padding-left: 20px;
        }
        li {
            margin: 8px 0;
        }
        .timestamp {
            color: #e74c3c;
            font-weight: bold;
        }
        .process-id {
            color: #27ae60;
            font-weight: bold;
        }
        .data-key {
            color: #8e44ad;
            font-weight: bold;
        }
    </style>
</head>
<body>
<!-- CRAQ æ–‡æ¡£å¯¼èˆªæ  -->
<div id="craq-nav" style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(15, 15, 35, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 12px 20px;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
">
    <a href="/craq/" style="
        color: #00d4ff;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    " onmouseover="this.style.color='#7c3aed'" onmouseout="this.style.color='#00d4ff'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
        è¿”å› CRAQ æ–‡æ¡£é¦–é¡µ
    </a>
    
    <div style="flex: 1;"></div>
    
    <a href="/" style="
        color: #888;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.3s ease;
    " onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#888'">
        åšå®¢é¦–é¡µ
    </a>
</div>

<!-- ä¸ºå¯¼èˆªæ æ·»åŠ é¡¶éƒ¨é—´è· -->
<div style="height: 60px;"></div>

    <div class="container">
        <h1>ğŸ”„ CRAQæ›´æ–°æ“ä½œæµç¨‹æ·±åº¦åˆ†æ</h1>
        
        <div class="summary">
            <h3>ğŸ“Š æ ¸å¿ƒå‘ç°</h3>
            <p><strong>ç­”æ¡ˆï¼šCRAQç³»ç»Ÿæ›´æ–°è®°å½•æ—¶ï¼Œ<span style="color: #e74c3c;">ä¸éœ€è¦å…ˆè¯»å–å®Œæ•´è®°å½•</span>ï¼Œè€Œæ˜¯é‡‡ç”¨å¢é‡æ›´æ–°æœºåˆ¶ã€‚</strong></p>
            <p>ç³»ç»Ÿç»´æŠ¤å†…å­˜ä¸­çš„æ•°æ®çŠ¶æ€ï¼Œç›´æ¥åŸºäºç°æœ‰çŠ¶æ€è¿›è¡Œå¢é‡æ›´æ–°ï¼Œé¿å…äº†æ˜‚è´µçš„ç£ç›˜è¯»å–æ“ä½œã€‚</p>
        </div>

        <h2>ğŸ” æ›´æ–°æ“ä½œæ ¸å¿ƒæµç¨‹åˆ†æ</h2>
        
        <div class="flow-diagram">
            <h4>CRAQå¢é‡æ›´æ–°æµç¨‹</h4>
            <div class="code-block">
å®¢æˆ·ç«¯æ›´æ–°è¯·æ±‚ â†’ eh_system_server:handle_cast({eh_update, ...})
    â†“
eh_repl_data_manager_api:update(eh_ready, Timestamp, UpdateList)
    â†“
eh_data_server:handle_call({eh_update, {eh_ready, Timestamp, UpdateList}})
    â†“
eh_data_util:make_data(UpdateList, Timestamp, StateData, TransientData, Data)
    â†“
write_data(Timestamp, DataIndexList, NewData, Queue, State)
            </div>
        </div>

        <h3>âš¡ å…³é”®è¯æ®ï¼šå†…å­˜çŠ¶æ€ç»´æŠ¤</h3>
        
        <div class="highlight">
            <h4>ğŸ§  æ•°æ®æœåŠ¡å™¨çŠ¶æ€ç»“æ„</h4>
            <p>æ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®æœåŠ¡å™¨ç»´æŠ¤å®Œæ•´çš„å†…å­˜çŠ¶æ€ï¼ŒåŒ…å«æ‰€æœ‰å†å²ç‰ˆæœ¬æ•°æ®ï¼š</p>
            
            <div class="data-structure">
#eh_data_state{
    timestamp = å½“å‰æ—¶é—´æˆ³,
    data_index_list = æ•°æ®ç´¢å¼•åˆ—è¡¨,
    data = å®Œæ•´æ•°æ®æ˜ å°„è¡¨,
    transient_data = ä¸´æ—¶æ•°æ®é˜Ÿåˆ—,
    file = æ–‡ä»¶æè¿°ç¬¦,
    ...
}
            </div>
        </div>

        <h2>ğŸ“ˆ å››æ¬¡æ›´æ–°æ“ä½œè¯¦ç»†åˆ†æ</h2>

        <div class="update-step">
            <h4>ğŸ”„ ç¬¬1æ¬¡æ›´æ–° (timestamp=1) - åˆå§‹æ’å…¥</h4>
            <div class="code-block">
æ›´æ–°å†…å®¹: [{person,10,[{name,1,john},{age,1,30},{gender,1,male}]}]
åˆå§‹çŠ¶æ€: {eh_data_state,0,0,[],#{}, ...}  // ç©ºçŠ¶æ€
ç»“æœçŠ¶æ€: #{{eh_storage_key,person,10} => 
    {[{eh_storage_value,1,3,1,gender,male},
      {eh_storage_value,1,2,1,age,30}],
     [{eh_storage_value,1,1,1,name,john}]}}
            </div>
            <p><strong>å…³é”®ï¼š</strong>ä»ç©ºçŠ¶æ€ç›´æ¥åˆ›å»ºæ–°è®°å½•ï¼Œæ— éœ€è¯»å–æ“ä½œã€‚</p>
        </div>

        <div class="update-step">
            <h4>ğŸ”„ ç¬¬2æ¬¡æ›´æ–° (timestamp=2) - éƒ¨åˆ†å­—æ®µæ›´æ–°</h4>
            <div class="code-block">
æ›´æ–°å†…å®¹: [{person,10,[{age,1,40}]}]  // ä»…æ›´æ–°ageå­—æ®µ
å½“å‰çŠ¶æ€: åŒ…å«å®Œæ•´çš„person,10è®°å½•
    {[{eh_storage_value,1,3,1,gender,male},
      {eh_storage_value,1,2,1,age,30}],
     [{eh_storage_value,1,1,1,name,john}]}
æ›´æ–°å: 
    {[{eh_storage_value,2,1,1,age,40},      // æ–°ç‰ˆæœ¬age
      {eh_storage_value,1,3,1,gender,male}, // ä¿ç•™åŸgender
      {eh_storage_value,1,2,1,age,30}],     // å†å²ageç‰ˆæœ¬
     [{eh_storage_value,1,1,1,name,john}]}  // ä¿ç•™åŸname
            </div>
            <p><strong>å…³é”®ï¼š</strong>åŸºäºå†…å­˜ä¸­ç°æœ‰çŠ¶æ€è¿›è¡Œå¢é‡æ›´æ–°ï¼Œæ·»åŠ æ–°ç‰ˆæœ¬å­—æ®µã€‚</p>
        </div>

        <div class="update-step">
            <h4>ğŸ”„ ç¬¬3æ¬¡æ›´æ–° (timestamp=3) - å­—æ®µæ›¿æ¢å’Œåˆ é™¤</h4>
            <div class="code-block">
æ›´æ–°å†…å®¹: [{person,10,[{name,1,john_smith},{age,0}]}]  // age=0è¡¨ç¤ºåˆ é™¤
æ›´æ–°æœºåˆ¶: 
- nameå­—æ®µ: æ·»åŠ æ–°ç‰ˆæœ¬ {eh_storage_value,3,1,1,name,john_smith}
- ageå­—æ®µ: æ·»åŠ åˆ é™¤æ ‡è®° {eh_storage_value,3,2,0,age,undefined}
ç»“æœçŠ¶æ€:
    {[{eh_storage_value,3,2,0,age,undefined},    // åˆ é™¤æ ‡è®°
      {eh_storage_value,3,1,1,name,john_smith},  // æ–°nameç‰ˆæœ¬
      {eh_storage_value,2,1,1,age,40},           // å†å²ageç‰ˆæœ¬
      {eh_storage_value,1,3,1,gender,male}, ...], ...}
            </div>
            <p><strong>å…³é”®ï¼š</strong>åˆ é™¤æ“ä½œé€šè¿‡æ·»åŠ STATUS_INACTIVEæ ‡è®°å®ç°ï¼Œä¿ç•™å†å²æ•°æ®ã€‚</p>
        </div>

        <div class="update-step">
            <h4>ğŸ”„ ç¬¬4æ¬¡æ›´æ–° (timestamp=4) - æ‰¹é‡å¯¹è±¡æ›´æ–°</h4>
            <div class="code-block">
æ›´æ–°å†…å®¹: 
[{person,10,[{name,1,john_smith},{age,1,40}]},
 {candidate,10,[{name,1,donald_trump},{party,1,republican}]}]

å¤„ç†æœºåˆ¶:
1. å¯¹person,10: åŸºäºç°æœ‰çŠ¶æ€æ·»åŠ æ–°ç‰ˆæœ¬å­—æ®µ
2. å¯¹candidate,10: åˆ›å»ºå…¨æ–°å¯¹è±¡è®°å½•
            </div>
            <p><strong>å…³é”®ï¼š</strong>åŒæ—¶å¤„ç†ç°æœ‰å¯¹è±¡æ›´æ–°å’Œæ–°å¯¹è±¡åˆ›å»ºï¼Œå‡åŸºäºå†…å­˜çŠ¶æ€ã€‚</p>
        </div>

        <h2>ğŸ§© å¢é‡æ›´æ–°æœºåˆ¶æ ¸å¿ƒå‡½æ•°</h2>

        <div class="highlight">
            <h4>ğŸ”§ eh_data_util:make_data/5 å‡½æ•°åˆ†æ</h4>
            <div class="code-block">
make_data(UpdateList, Timestamp, {StateTimestamp, StateDataIndexList}, TransientQueue, DataMap) ->
    % åŸºäºç°æœ‰DataMapçŠ¶æ€è¿›è¡Œå¢é‡æ›´æ–°
    % ä¸éœ€è¦ä»ç£ç›˜è¯»å–ï¼Œç›´æ¥æ“ä½œå†…å­˜æ•°æ®ç»“æ„
    {_, {NewTimestamp, NewDataIndexList}, NewQueue, NewDataMap}.

å…³é”®ç‰¹ç‚¹:
1. è¾“å…¥å‚æ•°åŒ…å«å®Œæ•´çš„å†…å­˜æ•°æ®çŠ¶æ€ (DataMap)
2. åŸºäºç°æœ‰çŠ¶æ€è®¡ç®—å¢é‡å˜æ›´
3. è¿”å›æ›´æ–°åçš„æ–°çŠ¶æ€
4. æ•´ä¸ªè¿‡ç¨‹æ— ç£ç›˜è¯»å–æ“ä½œ
            </div>
        </div>

        <h3>ğŸ“Š æ•°æ®ç‰ˆæœ¬ç®¡ç†æœºåˆ¶</h3>

        <div class="node-info">
            <h4>ğŸ—‚ï¸ ç‰ˆæœ¬åŒ–å­˜å‚¨ç»“æ„</h4>
            <div class="data-structure">
eh_storage_value {
    timestamp = ç‰ˆæœ¬æ—¶é—´æˆ³,
    data_index = åŒç‰ˆæœ¬å†…åºå·,
    status = 1(æ´»è·ƒ) | 0(åˆ é™¤),
    column = å­—æ®µå,
    value = å­—æ®µå€¼
}

ç¤ºä¾‹æ•°æ®æ¼”è¿›:
timestamp=1: {1,1,1,name,john}
timestamp=2: {2,1,1,age,40}        // æ–°å¢ageå­—æ®µ
timestamp=3: {3,1,1,name,john_smith} // æ›´æ–°nameå­—æ®µ
timestamp=3: {3,2,0,age,undefined}   // åˆ é™¤ageå­—æ®µ
            </div>
        </div>

        <h2>ğŸ¯ æ€§èƒ½ä¼˜åŠ¿åˆ†æ</h2>

        <div class="success-box">
            <h4>âš¡ å¢é‡æ›´æ–°çš„æ€§èƒ½ä¼˜åŠ¿</h4>
            <ul>
                <li><strong>é›¶ç£ç›˜è¯»å–ï¼š</strong>æ›´æ–°æ“ä½œå®Œå…¨åŸºäºå†…å­˜çŠ¶æ€ï¼Œé¿å…æ˜‚è´µçš„ç£ç›˜I/O</li>
                <li><strong>ç‰ˆæœ¬åŒ–ç®¡ç†ï¼š</strong>ä¿ç•™æ‰€æœ‰å†å²ç‰ˆæœ¬ï¼Œæ”¯æŒæ—¶é—´ç‚¹æŸ¥è¯¢å’Œå›æ»š</li>
                <li><strong>å­—æ®µçº§æ›´æ–°ï¼š</strong>åªæ›´æ–°å˜æ›´çš„å­—æ®µï¼Œå‡å°‘æ•°æ®ä¼ è¾“å’Œå­˜å‚¨å¼€é”€</li>
                <li><strong>å¹¶å‘å‹å¥½ï¼š</strong>åŸºäºæ—¶é—´æˆ³çš„ç‰ˆæœ¬æ§åˆ¶å¤©ç„¶æ”¯æŒå¹¶å‘æ›´æ–°</li>
                <li><strong>ä¸€è‡´æ€§ä¿è¯ï¼š</strong>é€šè¿‡CRAQé“¾ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€åŒæ­¥</li>
            </ul>
        </div>

        <h3>ğŸ”„ ä¸ä¼ ç»Ÿæ•°æ®åº“çš„å¯¹æ¯”</h3>

        <div class="flow-diagram">
            <h4>ä¼ ç»Ÿæ•°æ®åº“ vs CRAQæ›´æ–°æœºåˆ¶</h4>
            <div class="code-block">
<strong>ä¼ ç»Ÿæ•°æ®åº“æ›´æ–°æµç¨‹:</strong>
1. SELECT * FROM table WHERE id = ?     // ç£ç›˜è¯»å–
2. åº”ç”¨å±‚ä¿®æ”¹æ•°æ®
3. UPDATE table SET ... WHERE id = ?   // ç£ç›˜å†™å…¥

<strong>CRAQæ›´æ–°æµç¨‹:</strong>
1. åŸºäºå†…å­˜çŠ¶æ€ç›´æ¥è®¡ç®—å¢é‡å˜æ›´    // æ— ç£ç›˜è¯»å–
2. æ·»åŠ æ–°ç‰ˆæœ¬è®°å½•åˆ°å†…å­˜å’Œç£ç›˜     // ä»…ç£ç›˜å†™å…¥
3. ä¿ç•™å†å²ç‰ˆæœ¬æ”¯æŒæ—¶é—´ç‚¹æŸ¥è¯¢     // ç‰ˆæœ¬åŒ–ä¼˜åŠ¿
            </div>
        </div>

        <h2>ğŸ“ˆ æ€»ç»“</h2>

        <div class="summary">
            <h3>ğŸ¯ æ ¸å¿ƒç»“è®º</h3>
            <p><strong>CRAQç³»ç»Ÿé‡‡ç”¨äº†åˆ›æ–°çš„å¢é‡æ›´æ–°æœºåˆ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</strong></p>
            
            <ul>
                <li><strong>æ— è¯»å–æ›´æ–°ï¼š</strong>æ›´æ–°æ“ä½œä¸éœ€è¦å…ˆè¯»å–å®Œæ•´è®°å½•ï¼ŒåŸºäºå†…å­˜çŠ¶æ€ç›´æ¥è®¡ç®—å¢é‡</li>
                <li><strong>ç‰ˆæœ¬åŒ–å­˜å‚¨ï¼š</strong>æ¯æ¬¡æ›´æ–°æ·»åŠ æ–°ç‰ˆæœ¬è®°å½•ï¼Œä¿ç•™å®Œæ•´å†å²è½¨è¿¹</li>
                <li><strong>å­—æ®µçº§ç²’åº¦ï¼š</strong>æ”¯æŒå­—æ®µçº§åˆ«çš„å¢é‡æ›´æ–°ï¼Œæœ€å°åŒ–æ•°æ®å˜æ›´</li>
                <li><strong>å†…å­˜ä¼˜åŒ–ï¼š</strong>æ•°æ®æœåŠ¡å™¨ç»´æŠ¤å®Œæ•´å†…å­˜çŠ¶æ€ï¼Œé¿å…é¢‘ç¹ç£ç›˜è®¿é—®</li>
                <li><strong>åˆ†å¸ƒå¼ä¸€è‡´æ€§ï¼š</strong>é€šè¿‡é“¾å¼å¤åˆ¶ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€åŒæ­¥</li>
            </ul>
            
            <p>è¿™ç§è®¾è®¡åœ¨ä¿è¯<strong>å¼ºä¸€è‡´æ€§</strong>çš„åŒæ—¶ï¼Œå®ç°äº†<strong>é«˜æ€§èƒ½</strong>çš„æ›´æ–°æ“ä½œï¼Œä¸ºåˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿæä¾›äº†é‡è¦çš„æ¶æ„å‚è€ƒã€‚ç›¸æ¯”ä¼ ç»Ÿçš„"è¯»-ä¿®æ”¹-å†™"æ¨¡å¼ï¼ŒCRAQçš„å¢é‡æ›´æ–°æœºåˆ¶æ˜¾è‘—é™ä½äº†å»¶è¿Ÿå¹¶æé«˜äº†å¹¶å‘æ€§èƒ½ã€‚</p>
        </div>
    </div>

<!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="back-to-top" style="
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #00d4ff, #7c3aed);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
    transition: all 0.3s ease;
    z-index: 999;
    opacity: 0;
    transform: translateY(20px);
" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" 
   onmouseover="this.style.transform='translateY(-5px) scale(1.1)'" 
   onmouseout="this.style.transform='translateY(0) scale(1)'">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
        <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
    </svg>
</div>

<script>
// å›åˆ°é¡¶éƒ¨æŒ‰é’®æ˜¾ç¤º/éšè—é€»è¾‘
window.addEventListener('scroll', function() {
    const backToTop = document.getElementById('back-to-top');
    if (window.scrollY > 300) {
        backToTop.style.opacity = '1';
        backToTop.style.transform = 'translateY(0)';
    } else {
        backToTop.style.opacity = '0';
        backToTop.style.transform = 'translateY(20px)';
    }
});
</script>

</body>
</html>